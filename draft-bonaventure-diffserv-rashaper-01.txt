Internet Engineering Task Force                      Olivier Bonaventure
INTERNET DRAFT                                                     FUNDP
<draft-bonaventure-diffserv-rashaper-01.txt>          Stefaan De Cnodder
                                                                 Alcatel

                                                           October, 1999
                                                     Expires April, 2000

           A rate adaptive shaper for differentiated services


Status of this Memo

   This document is an Internet-Draft and is in full conformance with
   all provisions of Section 10 of RFC2026.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF), its areas, and its working groups.  Note that
   other groups may also distribute working documents as Internet-
   Drafts.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   The list of current Internet-Drafts can be accessed at
   http://www.ietf.org/ietf/1id-abstracts.txt

   The list of Internet-Draft Shadow Directories can be accessed at
   http://www.ietf.org/shadow.html.


Abstract

   This memo describes two rate adaptive shapers (RAS) that can be used
   in combination with the Three Color Markers (srTCM and trTCM)
   proposed in [Heinanen1]. These RAS improve the performance of TCP
   when a TCM is used at the ingress of a diffserv network by reducing
   the burstiness of the traffic and thus increasing the proportion of
   packets marked as green by the TCM.  In addition, two colored rate
   adaptive shapers (CRAS), which take into account the color of the
   packet at the head of the shaper and the status of the meters, are
   described.  Simulation results showing the improved performance are
   briefly discussed in the appendix.

1. Introduction




Bonaventure & De Cnodder A rate adaptive shaper                 [Page 1]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   In DiffServ networks, the incoming data traffic, with the AF PHB in
   particular, could be subject to marking where the purpose of this
   marking is to provide a low drop probability to a minimum part of the
   traffic whereas the excess will have a larger drop probability.  Such
   markers are mainly token bucket based such as the single rate three
   color marker (srTCM) described in [Heinanen1] and the two rates three
   color marker (trTCM) in [Heinanen2].

   Similar markers were proposed for ATM networks and simulations have
   shown that their performance with TCP traffic was not always perfect
   and several researchers have shown that these performance problems
   could be solved in two ways :

   1. increasing the burst size, i.e. increasing CBS and PBS, or

   2. shaping the incoming traffic such that a part of the burstiness is
   removed.

   The first solution has as major disadvantage that the traffic sent to
   the network can be very bursty and thus providing a low packet loss
   ratio can become difficult.  To efficiently support bursty traffic,
   additional resources such as buffer space are needed.  The major
   disadvantage of shaping is that the traffic encounters some delay in
   the shaper's buffers.

   In this document, we propose two shapers that can reduce the
   burstiness of the traffic upstream of a srTCM or trTCM. By reducing
   the burstiness of the traffic, the shapers increase the percentage of
   packets marked as greens by the TCMs and thus the overall goodput of
   the users using such a shaper.

   In addition, we also propose two colored shapers, which reduces the
   delay in the shaper by taking into account the color of the packets
   and the status of the meter.

   A few simulation results showing the usefulness of the proposed
   shapers may be found in the appendix.

   The structure of this document follows the structure proposed in
   [Nichols].


2. Description of the rate adaptive shapers.

 2.1. Rate adaptive shaper

   The rate adaptive shaper is based on a similar shaper proposed in
   [Bonaventure] to improve the performance of TCP with the Guaranteed



Bonaventure & De Cnodder A rate adaptive shaper                 [Page 2]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   Frame Rate [Guerin] [TM41] service category in ATM networks. Another
   type of rate adaptive shaper suitable for differentiated services was
   briefly discussed in [Azeem].  A RAS will typically be used as shown
   in figure 1 where the meter and the marker are the TCMs proposed in
   [Heinanen1] and [Heinanen2].




                                     Result
                                  +----------+
                                  |          |
                                  |          V
                 +--------+   +-------+   +--------+
      Incoming   |        |   |       |   |        |   Outgoing
      Packet  ==>|  RAS   |==>| Meter |==>| Marker |==>Packet
      Stream     |        |   |       |   |        |   Stream
                 +--------+   +-------+   +--------+
      Figure 1. Rate adaptive shaper


   The rate adaptive shapers are thus different from the shapers
   described in [RFC2475] since they shape the traffic before the
   traffic is metered.  The main objective of the shaper is to produce
   at its output a traffic that is less bursty than the input traffic,
   but the shaper should avoid to discard packets in contrast with
   classical leaky-bucket based shapers. The shaper itself consists of a
   tail-drop FIFO queue which is emptied at a variable rate.  The
   shaping rate, i.e. the rate at which the queue is emptied, is a
   function of the occupancy of the FIFO queue. If the queue occupancy
   increases, the shaping rate will also increase in order to prevent
   loss and too large delays at the shaper.  The shaping rate is also a
   function of the average rate of the incoming traffic.  The shaper was
   designed to be used in conjunction with meters such as the TCMs
   proposed in [Heinanen1] and [Heinanen2].

   There are two types of rate adaptive shapers. The single rate rate
   adaptive shaper (srRAS) will typically be used upstream of a srTCM
   while the two rates rate adaptive shaper (trRAS) will usually be used
   upstream of a trTCM.


 2.2. Configuration of the srRAS

   The srRAS is configured by specifying four parameters : the Committed
   Information Rate (CIR), the Maximum Information Rate (MIR) and two
   buffer thresholds : CIR_th (Committed Information Rate threshold) and
   MIR_th (Maximum Information Rate threshold). The CIR shall be



Bonaventure & De Cnodder A rate adaptive shaper                 [Page 3]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   specified in bytes per second and MUST be configurable. The MIR shall
   be specified in the same unit as the CIR and SHOULD be configurable.
   To achieve a good performance, the CIR of a srRAS will usually be set
   at the same value as the CIR of the downstream srTCM.  A typical
   value for the MIR would be the line rate of the output link of the
   shaper. When the CIR and optionally the MIR are configured, the srRAS
   MUST ensure that the following relation is verified :

           CIR <= MIR <= line rate

   The two buffer thresholds, CIR_th and MIR_th shall be specified in
   bytes or packets and SHOULD be configurable. If these thresholds are
   configured, then the srRAS MUST ensure that the following relation
   holds :

               CIR_th <= MIR_th <= buffer size of the shaper

   The CIR_th and MIR_th may depend on the values chosen for the CBS and
   the PBS in the downstream srTCM. However, this dependency does not
   need to be standardized.


 2.3. Behavior of the srRAS

   The output rate of the shaper is based on two factors. The first one
   is the (long term) average rate of the incoming traffic. This average
   rate can be computed by several means. For example, the function
   proposed in [Stoica] can be used (i.e. EARnew = [(1-exp(-
   T/K))*L/T]+exp(-T/K)*EARold where EARold is the previous value of the
   Estimated Average Rate, EARnew is the updated value, K a constant, L
   the size of the arriving packet and T the amount of time since the
   arrival of the previous packet). Other averaging functions can be
   used.

   The second factor is the instantaneous occupancy of the FIFO buffer
   of the shaper. When the buffer occupancy is below CIR_th, the output
   rate of the shaper is set to the maximum of the estimated average
   rate (EAR(t)) and the CIR. This ensures that the shaper will always
   send traffic at least at the CIR. When the buffer occupancy increases
   above CIR_th, the output rate of the shaper is computed as the
   maximum of the EAR(t) and a linear function F of the buffer occupancy
   for which F(CIR_th)=CIR and F(MIR_th)=MIR. When the buffer occupancy
   reaches the MIR_th threshold, the output rate of the shaper is set to
   the maximum information rate.  The computation of the shaping rate is
   illustrated in figure 2.






Bonaventure & De Cnodder A rate adaptive shaper                 [Page 4]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


                   ^
     Shaping rate  |
                   |
                   |
              MIR  |                      =========
                   |                    //
                   |                  //
           EAR(t)  |----------------//
                   |              //
                   |            //
             CIR   |============
                   |
                   |
                   |
                   |------------+---------+-------------------------------->
                           CIR_th        MIR_th            Buffer occupancy
                   Figure 2. Computation of shaping rate for srRAS


 2.4. Configuration of the trRAS

   The trRAS is configured by specifying six parameters : the Committed
   Information Rate (CIR), the Peak Information Rate (PIR), the Maximum
   Information Rate (MIR) and three buffer thresholds : CIR_th, PIR_th
   and MIR_th. The CIR shall be specified in bytes per second and MUST
   be configurable. To achieve a good performance, the CIR of a trRAS
   will usually be set at the same value as the CIR of the downstream
   trTCM.  The PIR shall be specified in the same unit as the CIR and
   MUST be configurable. To achieve a good performance, the PIR of a
   trRAS will usually be set at the same value as the PIR of the
   downstream trRAS.  The MIR SHOULD be configurable and shall be
   specified in the same unit as the CIR. A typical value for the MIR
   will be the line rate of the output link of the shaper. When the
   values for CIR, PIR and optionally MIR are configured, the trRAS MUST
   ensure that the following relation is verified :

               CIR <= PIR <= MIR <= line rate

   The three buffer thresholds, CIR_th, PIR_th and MIR_th shall be
   specified in bytes or packets and SHOULD be configurable. If these
   thresholds are configured, then the trRAS MUST ensure that the
   following relation is verified:

               CIR_th <= PIR_th <= MIR_th <= buffer size of the shaper

   The CIR_th, PIR_th and MIR_th may depend on the values chosen for the
   CBS and the PBS in the downstream trTCM. However, this dependency
   does not need to be standardized.



Bonaventure & De Cnodder A rate adaptive shaper                 [Page 5]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


 2.5. Behavior of the trRAS

   The output rate of the trRAS is also based on two factors. The first
   one is the (long term) average rate of the incoming traffic. This
   average rate can be computed as for the srRAS.

   The second factor is the instantaneous occupancy of the FIFO buffer
   of the shaper. When the buffer occupancy is below CIR_th, the output
   rate of the shaper is set to the maximum of the estimated average
   rate (EAR(t)) and the CIR. This ensures that the shaper will always
   send traffic at least at the CIR. When the buffer occupancy increases
   above CIR_th, the output rate of the shaper is computed as the
   maximum of the EAR(t) and a piecewise linear function F of the buffer
   occupancy. This piecewise function can be defined as follows.  The
   first piece is between zero and CIR_th where F is equal to CIR.  This
   means that when the buffer occupancy is below a certain threshold
   CIR_th, the shaping rate is at least CIR.  The second piece is
   between CIR_th and PIR_th where F increases linearly from CIR to PIR.
   The third part is from PIR_th to MIR_th where F is increased from PIR
   to the MIR and finally when the buffer occupancy is above MIR_th, the
   shaping rate remains constant at the MIR.

   The computation of the shaping rate is illustrated in figure 3.




                   ^
     Shaping rate  |
                   |
                   |
             MIR   |                               ======
                   |                            ///
                   |                         ///
             PIR   |                      ///
                   |                    //
                   |                  //
           EAR(t)  |----------------//
                   |              //
                   |            //
             CIR   |============
                   |
                   |
                   |
                   |------------+---------+--------+------------------------>
                           CIR_th      PIR_th    MIR_th        Buffer occupancy
                           Figure 3. Computation of shaping rate for trRAS




Bonaventure & De Cnodder A rate adaptive shaper                 [Page 6]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


3. Description of the colored RAS.

 3.1. The colored rate adaptive shapers

   The srRAS and the trRAS described in the previous section do not look
   to the status of the meter nor to the color of the first packet at
   the head of the shaper.  This means that a RAS could delay a packet
   even if this packet is in-profile.  This could be a problem in some
   environments.  To solve this problem, we propose a colored RAS which
   behaves as shown in figure 4.

                         Status       Result
                      +----------+ +----------+
                      |          | |          |
                      V          | |          V
                 +--------+   +-------+   +--------+
      Incoming   |colored |   |       |   |        |   Outgoing
      Packet  ==>|  RAS   |==>| Meter |==>| Marker |==>Packet
      Stream     |        |   |       |   |        |   Stream
                 +--------+   +-------+   +--------+
      Figure 4. colored RAS


   The two rate adaptive shapers (srRAS and trRAS), calculate a shaping
   rate, which is defined as the maximum of the estimated average
   incoming data rate and some function of the buffer occupancy.  Using
   this shaping rate, the RAS calculates the time schedule at which the
   next packet of the shaper must be released.  The main idea of the
   colored RAS is quite simple : if the packet at the head of the queue
   of the colored RAS would be conforming at an earlier instant than the
   time schedule computed by the RAS, then this packet can be
   transmitted as soon as it becomes conforming.  This means that when
   the colored RAS has to schedule the release time of the next packet,
   the colored RAS asks the meter for its status.

   If the packet at the head of the queue of the colored RAS does not
   become conforming at an earlier instant than the time schedule
   computed by the RAS, then we have three possibilities:

   1) transmit the packet at the time schedule computed by the RAS (we
   call this the SHAPED mode further on),

   2) transmit the packet immediately to prevent large delays (we call
   this the FAST mode further on), or

   3) we can transmit the packet at the time schedule when it becomes
   conforming to the best color before the time schedule computed by the
   RAS (we call this the PROMOTED mode further on).



Bonaventure & De Cnodder A rate adaptive shaper                 [Page 7]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   We make the assumption that these shapers are used for AF where green
   packets will receive a better treatment than yellow and red packets,
   and yellow packets will receive a better treatment than red packets
   [Heinanen3].


 3.2. Configuration of the C-srRAS

   The C-srRAS must be configured in the same way as the srRAS (see
   section 2.2) and in addition the mode of operation must be specified.
   This mode can be FAST, PROMOTED, or SHAPED.

 3.3. Behavior of the C-srRAS

   First of all, an output shaping rate is calculated in the same way as
   the srRAS did.  With the srRAS, this shaping rate determines a time
   schedule at when the next packet has to be released from the shaper.
   For the C-srRAS, this shaping rate is used to deterime a latest
   possible release time, called TRAS.  TRAS is calculated as the
   previous TRAS + L/SR(t), where L is the packet length of the
   previously transmitted packet and SR(t) the shaping rate as
   determined by the srRAS.

   Then all time instants at when the packet at the head of the shaper
   will become conforming to the current color or a better color are
   calculated.  From these time instants, the time instant belonging to
   the best color which falls before the latest possible release time,
   TRAS, will be selected as the release time of the next packet.  The
   value for TRAS is then set equal to the maximum of this release time
   and the previous TRAS, and this new value for TRAS will act as the
   previous TRAS value for the next packet (see first paragraph).

   If no such time instants exist we have to demote the packet (i.e. we
   have to give the packet a worse color than its current color) and the
   behavior of the C-srRAS will be determined by the selected mode.  In
   the SHAPED mode, the packet will be release at the latest possible
   release time as calculated with the C-srRAS.  In the FAST mode, the
   packet is sent immediately without any additional delay.  The
   PROMOTED mode will try to give the packet a color as close as
   possible to the current color.  This means that now all time instants
   at when the packet at the head of the shaper will become conforming
   to a worse color than the current color are calculated.  From these
   time instants, the time instant belonging to the best color which
   falls before the latest possible release time TRAS will be selected
   as the release time of the packet.

   Let us define Tcon(x) as the time instant at when the packet at the
   head of the shaper becomes conforming with respect to color x.  Then



Bonaventure & De Cnodder A rate adaptive shaper                 [Page 8]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   the behavior when the next packet has to be scheduled can be
   described more formally as follows:

   1) TRASprime <- TRAS

   2) calculate TRAS <- TRASprime + L/SR(t)

   3) if it is possible to keep the color of the packet or to promote
   the packet earlier than TRAS, i.e.

   if Tcon(color of packet at the head of the shaper) <= TRAS,

   then promote the packet as much as possible, i.e.

   if Tcon(green) <= TRAS, then send the packet at Tcon(green), else

   if the packet is yellow or red and Tcon(yellow) <= TRAS then send the
   packet at Tcon(yellow), else

   the packet must be sent immediately (here, the packet is red and
   Tcon(yellow) > TRAS.

   Finally, set TRAS <- max(release time packet, TRASprime).

   4) else sent the packet according to the selected mode

 3.4 Configuration of the C-trRAS

   The C-trRAS must be configured in the same way as the trRAS (see
   section 2.4) and in addition the mode of operation must be specified.
   This mode can be FAST, PROMOTED, or SHAPED.

 3.5. Behavior of the C-trRAS

   The behavior of the C-trRAS is the same as with the C-srRAS except
   that now the shaping rate, SR(t), is determined by the trRAS.

 3.6. Examples of the different modes SHAPED, FAST, and PROMOTED.

   Table 3.1, Table 3.2, and Table 3.3 show the time instants (marked
   with a X) at when the next packet will be released.  Note that in
   these examples, we put the marker in the color-blind mode such that
   it is possible to promote packets.  Tcon(x) in the tables represent
   the time instant at which the packet at the head of the shaper
   becomes conforming with respect to color x.  In case the marker are
   put in the color-aware mode, it is impossible to promote packets due
   to the definition of the color-aware mode (see [Heinanen1] and
   [Heinanen2]) and Tcon(green) for example will not exist in case there



Bonaventure & De Cnodder A rate adaptive shaper                 [Page 9]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   is a yellow or a red packet at the head of the shaper.

   As you can see, the only difference between FAST and PROMOTED is when
   there is a green packet at the head of the shaper and only
   Tcon(green) is beyond TRAS.  The mode has no impact when the packet
   is red as can be seen from Table 3.3.

   When we put the marker in the color-aware mode, and the packet at the
   head of the shaper is red, then this packet will always sent
   immediately when the shaper is put into the color-aware mode.  In
   this case, green packets can never be delayed behind red packets.


   Table 3.1: green packet at the head of shaper.
   selection   Tcon(red)    Tcon(yellow)     Tcon(green)      TRAS       time
   rules          |-------------+-----------------+------------+--------->
   RAS                                                         X
   SHAPED                                         X
   FAST                                           X
   PROMOTED                                       X
               Tcon(red)    Tcon(yellow)         TRAS     Tcon(green)    time
                  |-------------+-----------------+------------+--------->
   RAS                                            X
   SHAPED                                         X
   FAST           X
   PROMOTED                     X
               Tcon(red)      TRAS         Tcon(yellow)   Tcon(green)    time
                  |-------------+-----------------+------------+--------->
   RAS                          X
   SHAPED                       X
   FAST           X
   PROMOTED       X



















Bonaventure & De Cnodder A rate adaptive shaper                [Page 10]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   Table 3.2: yellow packet at the head of shaper.
   selection   Tcon(red)    Tcon(yellow)     Tcon(green)      TRAS       time
   rules          |-------------+-----------------+------------+--------->
   RAS                                                         X
   SHAPED                       X
   FAST                         X
   PROMOTED                     X
               Tcon(red)    Tcon(yellow)         TRAS     Tcon(green)    time
                  |-------------+-----------------+------------+--------->
   RAS                                            X
   SHAPED                       X
   FAST                         X
   PROMOTED                     X
               Tcon(red)      TRAS         Tcon(yellow)   Tcon(green)    time
                  |-------------+-----------------+------------+--------->
   RAS                          X
   SHAPED         X
   FAST           X
   PROMOTED       X



   Table 3.3: yellow packet at the head of shaper.
   selection   Tcon(red)    Tcon(yellow)     Tcon(green)      TRAS       time
   rules          |-------------+-----------------+------------+--------->
   RAS                                                         X
   SHAPED                                         X
   FAST                                           X
   PROMOTED                                       X
               Tcon(red)    Tcon(yellow)         TRAS     Tcon(green)    time
                  |-------------+-----------------+------------+--------->
   RAS                                            X
   SHAPED                       X
   FAST                         X
   PROMOTED                     X
               Tcon(red)      TRAS         Tcon(yellow)   Tcon(green)    time
                  |-------------+-----------------+------------+--------->
   RAS                          X
   SHAPED         X
   FAST           X
   PROMOTED       X



3.7. Behavior of colored RAS when there are only green packets

   The colored RAS results in a lower delay in the shaper and tries to
   keep the current color of the packet.  It could also be possible that



Bonaventure & De Cnodder A rate adaptive shaper                [Page 11]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   the packets are not yet colored or that we are not interested in the
   current color of the packets while still optimizing the delay and the
   amount of green packets.  For this, we can use the green colored RAS,
   which is the same as the colored RAS where all packets are pre-
   colored as green, so it is not really a new shaper.  This means that
   the algorithm in section 3.2 becomes much simpler and is as follows:

   1) TRASprime <- TRAS

   2) calculate TRAS <- TRASprime + L/SR(t)

   3) if Tcon(green) <= TRAS then
                           release packet at Tcon(green), and
                           set TRAS <- max(release time packet, TRASprime)

   4) else (if Tcon(green) > TRAS) sent the packet according to the
   selected mode

   It is the same as the colored RAS but now we take in step 3 of the
   algorithm in section 3.2 the green color instead of the color of the
   packet at the head of the shaper.

   This green colored RAS tries to optimize the delay in the shaper and
   the number of green packets.  In fact, this green colored RAS is the
   same as the colored RAS where all packets are pre-colored as green.
   This means that the configuration and the behavior is exactly the
   same as the colored RAS.  Here, we have described how the colored RAS
   can be used when the packets where not yet colored or when their
   color was of no importance.  This also means that the marker (srTCM
   or trTCM) also has to ignore the color of the packet and thus the
   marker has to be put in the color-blind mode.

4. Assumption

   The shapers discussed in this document assume that the Internet
   traffic is dominated by protocols such as TCP that react
   appropriately to congestion by decreasing their transmission rate.

5. Example services

   The shapers discussed in this document can be used in most situations
   where the TCMs proposed in [Heinanen1] and [Heinanen2] are used. In
   fact, simulations briefly discussed in Appendix A show that the
   performance of TCP can be improved when the trTCM is used in
   conjunction with one of the shapers described in this document than
   when the trTCM is used alone. We expect that similar simulations
   results would be found with the srTCM.




Bonaventure & De Cnodder A rate adaptive shaper                [Page 12]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


   The RAS makes the traffic stream smooth such that as much as possible
   packets are colored as green.  The colored RAS (in particular the
   green colored RAS) tries in addition to decrease the delay in the
   shaper.

6. Security Issues

   The shapers described in this document have no known security
   concerns.

7. Acknowledgement

   We would like to thank Emmanuel Desmet for his comments.

8. References



[Azeem] Feroz Azeem, Amit Rao,Xiuping Lu and Shiv Kalyanaraman, TCP-
        Friendly Traffic Conditioners for Differentiated Services,
        draft-azeem-tcpfriendly-diffserv-00.txt, March 1999, Work in
        progress.


[Bonaventure]
        Olivier Bonaventure, "Integration of ATM under TCP/IP to provide
        services with a guaranteed minimum bandwidth", Ph. D. thesis,
        University of Liege, September 1998.


[Clark] David D. Clark, and Wenjia Fang, "Explicit Allocation of Best-
        Effort Packet Delivery Service", IEEE/ACM Trans. on Networking,
        Vol. 6, No. 4, August 1998.


[Guerin]R. Guerin and J. Heinanen, UBR+ service category definition, ATM
        Forum contribution ATM96-1598, December 1996.


[Heinanen1]
        J. Heinanen, and R. Guerin, "A Single Rate Three Color Marker",
        RFC 2697, September 1999.


[Heinanen2]
        J. Heinanen, and R. Guerin, "A Two Rate Three Color Marker", RFC
        2698, September 1999.




Bonaventure & De Cnodder A rate adaptive shaper                [Page 13]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


[Heinanen3]
        J. Heinanen, F. Baker, W. Weiss, and J. Wroclawski, "Assured
        Forwarding PHB Group", RFC 2597, June 1999.


[Floyd1]Sally Floyd, and Van Jacobson, "Random Early Detection Gateways
        for Congestion Avoidance", IEEE/ACM Transactions on Networking,
        August 1993.


[Floyd2]Sally Floyd, "RED : Optimum functions for computing the drop
        probability", email available at http://www-
        nrg.ee.lbl.gov/floyd/REDfunc.txt, October 1997.


[Nichols]K. Nichols and B. Carpenter, Format for Diffserv Working Group
        Traffic Conditioner Drafts. Internet draft draft-ietf-diffserv-
        traffcon-format-00.txt, February 1999, work in progress


[RFC2475]S. Blake, et al., An Architecture for Differentiated Services.
        RFC 2475, December 1998.


[Stoica]I. Stoica and S. Shenker and H. Zhang, Core-stateless fair
        queueuing : achieving approxiamtely fair bandwidth allocations
        in high speed networks", ACM SIGCOMM98, pp. 118-130, Sept. 1998


[TM41]  ATM Forum, Traffic Management Specification, verion 4.1, 1999

Appendix

 A. Simulation results

  A.1 description of the model

        To evaluate the rate adaptive shaper through simulations, we use
        the network model depicted in Figure A.1.  In this network, we
        consider that a backbone network is used to provide a LAN Inter-
        connection service to ten pairs of LANs. Each LAN corresponds to
        an uncongested switched 10 Mbps LAN with ten workstations
        attached to a customer router (C1-C10 in figure A.1).  The delay
        on the LAN links is set to 1 msec. The MSS size of the worksta-
        tions is set to 1460 bytes.  The workstations on the left hand
        side of the figure send traffic to companion workstations
        located on the right hand side of the figure. All traffic from
        the LAN attached to customer router C1 is sent to the LAN



Bonaventure & De Cnodder A rate adaptive shaper                [Page 14]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


        attached to customer router C1'. There are ten workstations on
        each LAN and each workstation implements SACK-TCP with a maximum
        window size of 64 KBytes.

              2.5 msec, 34 Mbps                      2.5 msec, 34 Mbps
             <-------------->                      <-------------->
        \+---+                                                     +---+/
        -| C1|--------------+                       +--------------|C1'|-
        /+---+              |                       |              +---+\
        \+---+              |                       |              +---+/
        -| C2|------------+ |                       | +------------|C2'|-
        /+---+            | |                       | |            +---+\
        \+---+            | |                       | |            +---+/
        -| C3|----------+ | |                       | | +----------|C3'|-
        /+---+          | | |                       | | |          +---+\
        \+---+          | | |                       | | |          +---+/
        -| C4|--------+ +-+----------+     +----------+-+ +--------|C4'|-
        /+---+        |   |          |     |          |   |        +---+\
        \+---+        +---|          |     |          |---+        +---+/
        -| C5|------------|   ER1    |-----|   ER2    |------------|C5'|-
        /+---+        +---|          |     |          |---+        +---+\
        \+---+        |   |          |     |          |   |        +---+/
        -| C6|--------+   +----------+     +----------+   +--------|C6'|-
        /+---+            ||||                     ||||            +---+\
        \+---+            ||||      <------->      ||||            +---+/
        -| C7|------------+|||       60 Mbps       |||+------------|C7'|-
        /+---+             |||       10 msec       |||             +---+\
        \+---+             |||                     |||             +---+/
        -| C8|-------------+||                     ||+-------------|C8'|-
        /+---+              ||                     ||              +---+\
        \+---+              ||                     ||              +---+/
        -| C9|--------------+|                     |+--------------|C9'|-
        /+---+               |                     |               +---+\
        \+---+               |                     |               +----+/
        -|C10|---------------+                     +---------------|C10'|-
        /+---+                                                     +----+\
        Figure A.1. the simulation model.


        The customer routers are connected with 34 Mbps links to the
        backbone network which is, in our case, composed of a single
        bottleneck 34 Mbps link between the edge routers ER1 and ER2.
        The delay on all the customer-edge 34 Mbps links has been set to
        2.5 msec to model a MAN or small WAN environment.  These links
        and the customer routers are not a bottleneck in our environment
        and no losses occurs inside the edge routers.  The customer
        routers are equipped with a trTCM [Heinanen2] and mark the
        incoming traffic. The parameters of the trTCM are shown in table



Bonaventure & De Cnodder A rate adaptive shaper                [Page 15]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


        A.1.


           Table A.1: configurations of the trTCMs

           Router          CIR               PIR             Line Rate
           C1              2 Mbps            4 Mbps          34 Mbps
           C2              4 Mbps            8 Mbps          34 Mbps
           C3              6 Mbps           12 Mbps          34 Mbps
           C4              8 Mbps           16 Mbps          34 Mbps
           C5             10 Mbps           20 Mbps          34 Mbps
           C6              2 Mbps            4 Mbps          34 Mbps
           C7              4 Mbps            8 Mbps          34 Mbps
           C8              6 Mbps           12 Mbps          34 Mbps
           C9              8 Mbps           16 Mbps          34 Mbps
           C10            10 Mbps           20 Mbps          34 Mbps


        All customer routers are equipped with a trTCM where the CIR are
        2 Mbps for router C1 and C6, 4 Mbps for C2 and C7, 6 Mbps for C3
        and C8, 8 Mbps for C4 and C9 and 10 Mbps for C5 and C10. Routers
        C6-C10 also contain a trRAS in addition to the trTCM while
        routers C1-C5 only contain a trTCM.  In all simulations, the PIR
        is always twice as large as the CIR.  Also the PBS is the double
        of the CBS.  The CBS will be varied in the different simulation
        runs.

        The edge routers, ER1 and ER2, are connected with a 60 Mbps link
        which is the bottleneck link in our environment. These two
        routers implement the RIO algorithm [Clark] that we have
        extended to support three drop preferences instead of two. The
        thresholds of the parameters are 100 and 200 packets (minimum
        and maximum threshold, respectively) for the red packets, 200
        and 400 packets for the yellow packets and 400 and 800 for the
        green packets.  The parameter maxp of RIO was set to 0.02 and we
        used as drop function the function proposed in [Floyd2] such
        that when the average queue length exceeds the maximum thres-
        hold, the drop probability does not suddenly jumps to 1.  The
        weight to calculate the average queue length which is used by
        RED or RIO is set to 0.002 [Floyd1].

        The simulated time is set to 102 seconds where the first two
        seconds are not used to gather TCP statistics (the so-called
        warm-up time) such as goodput.

  A.2 Simulation results for the trRAS

        For our first simulations, we consider that routers C1-C5 only



Bonaventure & De Cnodder A rate adaptive shaper                [Page 16]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


        utilize a trTCM while routers C6-C10 utilize a rate adaptive
        shaper in conjunction with a trTCM. All routers use a CBS of 3
        KBytes. In table A.2, we show the total goodput achieved by the
        workstations attached to each LAN as a function of the CIR of
        the trTCM used on the customer router attached to this LAN. In
        table A.3, we show the total goodput achieved by the worksta-
        tions attached to customer routers with a rate adaptive shaper.

           Table A.2: throughput in Mbps for the unshaped traffic.
                         green           yellow          total
           2Mbps [C1]    1.09            0.83            1.94
           4Mbps [C2]    2.30            1.39            3.71
           6Mbps [C3]    3.70            1.60            5.30
           8Mbps [C4]    5.47            1.66            7.13
           10Mbps [C5]   7.08            1.66            8.74

           Table A.3: throughput in Mbps for the shaped traffic.
                         green           yellow          total
           2Mbps [C6]    2.00            0.81            2.81
           4Mbps [C7]    3.98            1.08            5.06
           6Mbps [C8]    5.86            0.74            6.60
           8Mbps [C9]    7.76            0.58            8.34
           10Mbps [C10]  9.79            0.52            10.3


        This first simulation shows clearly that the workstations
        attached to an edge router with a rate adaptive shaper havea
        clear advantage, from a performance point of view, with respect
        to workstations attached to an edge router with only a trTCM.
        The performance improvement is the result of the higher propor-
        tion of packets marked as green by the edge routers when the
        rate adaptive shaper is used.

        Table A.4 shows the total goodput for workstations attached to
        routers C1 (trTCM - 2_Mbps_unsh), C5 (trTCM - 10_Mbps_unsh), C6
        (trRAS and trTCM 2_Mbps_sh), and C10 (trRAS and trTCM
        10_Mbps_sh) for various values for the maximum burst size when
        the rate adaptive shaper is used.  It is clear that routers with
        the rate adaptive shaper perform better if the CBS is small.
        However, a CBS of a few hundred KBytes is probably too large in
        many environments.










Bonaventure & De Cnodder A rate adaptive shaper                [Page 17]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


           Table A.4: goodput in Mbps (rate adaptive shaper, link rate
        is 60 Mbps) versus CBS in KBytes.
           CBS  2_Mbps_unsh     2_Mbps_sh     10_Mbps_unsh   10_Mbps_sh
           3       1.84            2.71          8.37           9.98
           10      2.62            2.40          8.09           9.68
           25      2.49            2.26          8.33           9.49
           50      2.37            2.15          8.69           9.40
           75      2.32            2.10          8.77           9.22
           100     2.35            2.11          8.88           9.17
           150     2.36            2.12          8.95           9.12
           200     2.33            2.10          9.10           9.06
           300     2.33            2.10          9.24           8.69
           400     2.33            2.04          9.32           8.77

  A.3 Simulation results for the C-trRAS

        We use the same shaper as in A.2 but now we use the C-trRAS.
        The mode used in these simulations is SHAPED and we assume that
        all packets are pre-colored as green.

        Table A.5 and Table A.6 show the results of the same scenario as
        for Table A.2 and Table A.3 but the shaper is now the colored
        shaper.  We see that the shaped traffic performs again much
        bette, also compared to the previous case (i.e. where the trRAS
        was used).  This is because the amount of yellow traffic
        increases with the expense of a slight decrease in the amount of
        green traffic.  This can be explained by the fact that the
        colored shaper introduces some burstiness.

           Table A.5: throughput in Mbps for the unshaped traffic.
                         green           yellow          total
           2Mbps [C1]    1.04            0.77            1.83
           4Mbps [C2]    2.25            1.24            3.51
           6Mbps [C3]    3.62            1.38            5.01
           8Mbps [C4]    5.15            1.51            6.67
           10Mbps [C5]   6.70            1.54            8.24

           Table A.6: throughput in Mbps for the shaped traffic.
                         green           yellow          total
           2Mbps [C6]    1.89            1.46            3.34
           4Mbps [C7]    3.46            2.08            5.54
           6Mbps [C8]    5.04            2.13            7.18
           8Mbps [C9]    6.80            1.82            8.62
           10Mbps [C10]  8.58            1.43            10.0


        The impact of the CBS is shown in Table A.7 which is the same
        scenario as Table A.4 with the only difference that the shaper



Bonaventure & De Cnodder A rate adaptive shaper                [Page 18]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999


        is now the C-trRAS.  We see that the shaped traffic performs
        much better than the unshaped traffic when the CBS is small.
        When the CBS is large, the shaped and unshaped traffic performs
        more or less the same.  This is in contrast with the trRAS,
        where the performance of the shaped traffic was slightly worse
        in case of a large CBS.

           Table A.7: goodput in Mbps (rate adaptive shaper, link rate
        is 60 Mbps) versus CBS in KBytes.
           CBS  2_Mbps_unsh     2_Mbps_sh     10_Mbps_unsh   10_Mbps_sh
           3       1.73            3.23          7.91           9.66
           10      2.54            2.67          8.21           9.26
           25      2.47            2.42          8.35           9.21
           50      2.32            2.33          8.68           8.98
           75      2.32            2.26          8.84           8.90
           100     2.26            2.22          8.81           8.99
           150     2.24            2.17          8.72           9.04
           200     2.21            2.17          8.89           9.14
           300     2.19            2.13          9.06           9.10
           400     2.18            2.12          9.06           9.10

  A.4 Conclusion simulations

        From these simulations, we see that the shaped traffic has much
        higher throughput compared to the unshaped traffic when the CBS
        was small.  When the CBS is large, the shaped traffic performs
        slightly less than the unshaped traffic due to the delay in the
        RAS.  The colored RAS solves this problem.

        Other scenarios and simulations with the modes FAST and PROMOTED
        are for further work.

Authors Addresses

   Olivier Bonaventure
   Institut d'Informatique (CS Dept)
   Facultes Universitaires Notre-Dame de la Paix
   Rue Grandgagnage 21, B-5000 Namur, Belgium.
   E-mail: Olivier.Bonaventure@info.fundp.ac.be
   URL   : http://www.info.fundp.ac.be/~obo

   Stefaan De Cnodder
   Alcatel Corporate Research Center
   Fr. Wellesplein 1, B-2018 Antwerpen, Belgium.
   Phone : 32-3-240-8515
   Fax   : 32-3-240-9932
   E-mail: stefaan.de_cnodder@alcatel.be




Bonaventure & De Cnodder A rate adaptive shaper                [Page 19]

Internet Draft draft-bonaventure-diffserv-rashaper-01.txt      June 1999





















































Bonaventure & De Cnodder A rate adaptive shaper                [Page 20]

