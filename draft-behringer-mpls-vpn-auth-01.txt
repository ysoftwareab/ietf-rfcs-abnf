

PPVPN Working Group                                  Michael Behringer 
Internet Draft                                            Jim Guichard 
Expiration Date: July 2003                           Cisco Systems Inc 
 
 
                                                      January 7th 2002 
 
 
 
                 MPLS VPN Import/Export Verification 
 
                 draft-behringer-mpls-vpn-auth-01.txt 
 
 
Status of this Memo 
 
   This document is an Internet-Draft and is in full conformance with 
   all provisions of Section 10 of RFC2026. 
 
   Internet-Drafts are working documents of the Internet Engineering 
   Task Force (IETF), its areas, and its working groups.  Note that 
   other groups may also distribute working documents as Internet- 
   Drafts. 
 
   Internet-Drafts are draft documents valid for a maximum of six      
   months and may be updated, replaced, or obsoleted by other documents  
   at any time.  It is inappropriate to use Internet-Drafts as  
   reference material or to cite them other than as "work in progress." 
 
   The list of current Internet-Drafts can be accessed at 
   http://www.ietf.org/ietf/1id-abstracts.txt. 
 
   The list of Internet-Draft Shadow Directories can be accessed at 
   http://www.ietf.org/shadow.html.  
 
Abstract 
 
Configuration errors on Provider Edge (PE) routers in MPLS VPN 
[RFC2547] networks can lead to security breaches of the connected VPNs. 
For example the PE could be mistakenly configured such that a connected 
Customer Edge (CE) router belongs to an incorrect VPN.  
Here we propose a scheme that verifies local and remote routing 
information received by the PE router before it installs new VPN routes 
into the VRF. The proposed changes affect only the PE routers.  
 
 
Table of Contents 
 
 
Internet Draft         MPLS VPN Authentication           January 2003 
 
 
1. Conventions used in this document                                 2 
2. Overview                                                          2 
3. Problem Statement                                                 3 
4. CE-CE Authentication                                              3 
5. Supported PE-CE Routing Protocols                                 5 
6. The UPDATE-authenticator attribute                                6 
7. IANA Considerations                                               6 
8. Security Considerations                                           6 
9. Acknowledgements                                                  7 
10. References                                                       7 
11. Author's Addresses                                               7 
12. Full Copyright Statement                                         7 
 
 
1. Conventions used in this document 
 
   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", 
   "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" in  
   this document are to be interpreted as described in [RFC-2119]. 
 
 
2. Overview 
 
The current MPLS standards do not provide any mechanism to determine 
whether an imported route on a PE router originated from the correct 
VPN. This opens a potential security hole where the MPLS Service 
Provider could mistakenly assign on a PE router the incorrect "route-
target" values, thus inadvertently bringing a connected customer site 
into a wrong VPN.  
 
Misconfigurations of this type by the Service Provider are hard to 
detect, and a real issue in [RFC2547] networks. One possible solution 
to this problem is to mount IPsec on all CE routers, but this is often 
perceived as too "heavy-weight". 
 
This proposal aims to solve the problem of accidental misconfiguration 
of MPLS parameters on PE routers. The approach is to re-use the routing 
MD5 key, which is used for PE-CE authentication [RFC2082, 2154, 2385], 
also for the PE-PE routing authentication. Since a PE router can hold 
several virtual routing and forwarding instances (VRFs), the 
authentication between PEs will use the different MD5 keys, based on 
which VRF's routes need to be authenticated.  
 
BGP UPDATE messages between PE routers will include a new BGP 
attribute, hereby referred to as the "UPDATE-authenticator". This 
attribute contains a keyed HMAC MD5 signature of a locally generated 
 
draft-behringer-mpls-vpn-auth-01.txt                            page 2 
Internet Draft         MPLS VPN Authentication           January 2003 
 
per-VRF random number, using the MD5 key that is also used on this PE 
router for the PE-CE routing authentication of that VPN. 
 
The receiving PE router generates a keyed HMAC MD5 signature for the 
incoming UPDATE message using information from the "UPDATE-
authenticator" attribute, and the routing key of the CE router that is 
to receive these routing updates. If the result is different from the 
signature value transmitted in the UPDATE-authenticator attribute, the 
routes within the UPDATE are not imported and a warning is logged.  
 
The proposal imposes some operational constraints to be workable: 
Routing with MD5 authentication [RFC2082, 2154, 2385] must be 
configured for all PE-CE links of a particular VPN, and all CEs of the 
same VPN must use the same MD5 key. If the Service Provider manages the 
CE routers on behalf of the customer, then downstream C routers must 
also use the same MD5 key. MD5 keys must be chosen to be unique to a 
VPN.    
 
 
3. Problem Statement 
 
The current MPLS architecture as defined in [RFC2547] allows a three-
step configuration process for route authentication: From the CE to the 
PE, from that PE to other PEs in the same MPLS network, and from the 
other PEs to the corresponding CEs. The link between these three steps 
depends on correct configuration of the MPLS core network, namely the 
correct configuration of "route-targets" on the PE routers.  
 
If an MPLS Service Provider inadvertently configures the wrong "route-
targets", they may introduce a random CE router with the network behind 
it to another VPN. This error is hard to detect from within the 
customer's network.  
 
A mechanism is required which prevents routes from being passed into  
a PEÆs VRF, unless they are verified to belong to the VPN. Also in  
the case of misconfigurations, the Service Provider must be alerted  
so that the mistake can be rectified.   
 
   
4. CE-CE Authentication 
      
This document proposes to re-use the MD5 key that is being used for PE-
CE routing authentication. This has the advantage that no changes or 
software upgrades are necessary at the CE routers or within the VPN 
site. For this proposal to work each VPN MUST use the same MD5 key on 
all PE-CE links for routing authentication. The MD5 key MUST be unique 
to each VPN. The VPN customer configures thus all their CE routers with 
 
draft-behringer-mpls-vpn-auth-01.txt                            page 3 
Internet Draft         MPLS VPN Authentication           January 2003 
 
this MD5 key. The MPLS Service Provider configures the PEs also with 
this key on all links to the customers CEs. This proposal does not 
affect the CE-PE routing authentication, but the authentication MUST be 
used for this scheme to work. 
 
In normal [RFC2547] networks, the PE router that receives routes from a 
CE advertises these routes via MP-BGP to the other PEs, using a PE 
specific MD5 key. This is a problem as there is no linkage between the 
MD5 key used for PE-CE authentication and the one used for PE-PE 
authentication. This essentially introduces a 3-stage authentication 
process, with each stage disjointed from the other two stages. 
 
Using the mechanisms described within this document, the BGP UPDATE 
message, as defined in [RFC1771], is sent between PE routers (or BGP 
route reflectors), and carries a new UPDATE-authenticator attribute, 
which is handled as follows: 
 
1. The PE will only export routes from a local VRF that is configured 
for MD5 authentication if it can confirm that at least 1 local route 
has been received and authenticated from each CE router that is 
attached to the VRF. This prevents any connected interface or static 
routes from leaking into other VPNs without first confirming the local 
configuration of the PE router. The exception to this rule is the 
'Trusted PE' model (see section 5). 
 
2. The PE will calculate a random number, referred to as the 
'generator', for each VRF that is configured for authentication. 
Alternatively a combination of the local route-target values may be 
used to generate this number. This is implementation specific. 
 
3. The PE sending an MP-BGP UPDATE calculates a keyed HMAC-MD5 
signature, as defined in [RFC2104], over the 'generator', using the key 
of one of the CEs that is connected to the corresponding VRF. The 
result of this calculation is carried, along with the 'generator', 
within the UPDATE-authenticator attribute.    
 
4. The UPDATE message is sent to any MP-BGP peers (other PE routers or 
BGP route reflectors).  
 
5. The route targets in the MP-BGP update determine which VRF/s the 
UPDATE refers to, and these are used as normal to determine which PE 
routers will import which routes.  
 
6. The receiving PE MUST not import a received prefix if it contains 
the UPDATE-authenticator attribute, and the local VRF is NOT configured 
for authentication. Likewise, the receiving PE MUST not import a 

 
draft-behringer-mpls-vpn-auth-01.txt                            page 4 
Internet Draft         MPLS VPN Authentication           January 2003 
 
received prefix if it does not contain the UPDATE-authenticator 
attribute, and the local VRF is configured for authentication. 
 
7. The receiving PE uses the local MD5 key for the importing VRF to 
calculate a HMAC-MD5 signature, and compares the result to the value in 
the received "UPDATE authenticator" path attribute. This comparison is 
ONLY performed if the PE has at least 1 locally authenticated route 
from the CE router. 
 
8. If the values are identical, the UPDATE is processed as normal and 
the routes are installed into the VRF. If not, the PE router MUST check 
if any further keys are available within the VRF. If they are then it 
should cycle through step 7 until either a) there are no more keys 
available, or b) a match is found.  
 
9. If no match is found then the BGP table is updated but the routes 
are marked as 'not authenticated', and a warning is logged to indicate 
a misconfiguration to the Service Provider.  
 
A router MAY verify whether all MD5 keys for a given VRF are the same. 
If it does a warning message MUST be logged if it detects differences.  
 
In the case where the Service Provider manages the CE routers, the 
Service Provider must also configure the key at the CE routers and this 
should match with any downstream C routers within the customer site. If 
the C routers have a different key than the CE router then the CE will 
not authenticate any routes from within the site, and will therefore 
not advertise any routing information to the PE router. The PE router 
is thus able to use the previously described mechanisms and will not 
import/export any routes from/to the customers VRF. 
  
    
5. Supported PE-CE Routing Protocols 
 
This scheme in principle requires a dynamic routing protocol that 
supports MD5 procedures. These currently include RIPv2, OSPF, ISIS, 
EIGRP and BGP4. Static routing is considered a special case and is 
serviced through the 'Trusted PE' model.  
 
The 'Trusted PE' model provides the ability for the Service Provider to 
authenticate routing information that is distributed between PE 
routers, without the requirement of MD5 authentication on the PE-CE 
links. This is useful when static routing is used between the PE and CE 
for example. 
 
Using this model, the PE router will export all routes from within a 
VRF that has been configured for authentication, using the previous 
 
draft-behringer-mpls-vpn-auth-01.txt                            page 5 
Internet Draft         MPLS VPN Authentication           January 2003 
 
described mechanisms. However, the check to see whether a route has 
been authenticated with the CE router is disabled. A receiving PE 
router is able to authenticate the routes using the local VRF key, 
which eliminates a misconfiguration of the route targets from causing 
any leak of routing information between VPNs.  
 
Since it is still possible for the Service Provider to a) misconfigure 
the export route targets AND b) misconfigure the key, the Trusted PE 
model is recommended only in exceptional cases.  
 
 
6. The UPDATE-authenticator attribute  
 
The UPDATE-authenticator attribute is an optional, transitive BGP 
attribute, with an attribute type code value to be assigned. Its length 
is 20 octets, which is the length of the output of an MD5 function (16 
octets), plus the 'generator' field, as shown in the following figure.  
 
       0                   1                   2                   3 
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
      |                          HMAC-MD5                             | 
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
      |                          HMAC-MD5 (cont)                      | 
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
      |                          HMAC-MD5 (cont)                      | 
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
      |                          HMAC-MD5 (cont)                      | 
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
      |                          Generator                            | 
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  
 
    
7. IANA Considerations 
 
The UPDATE-authenticator BGP attribute type will need to be registered 
with IANA, according to the procedures defined in [RFC2042]. 
 
8. Security Considerations 
 
This modification to the behavior of the PE router aims at detecting 
inadvertent configuration mistakes of the Service Provider, and at 
isolating CE routers that appear not to belong to the VPN they were 
configured for.  
 
There is no protection against the Service Provider staff maliciously 
adding a CE router to a VPN. However, the malicious engineer must know 
 
draft-behringer-mpls-vpn-auth-01.txt                            page 6 
Internet Draft         MPLS VPN Authentication           January 2003 
 
the MD5 key of the VPN to be intruded. This threat can be avoided with 
CE-CE IPsec authentication, which is configured by the VPN customer, 
and to which the Service Provider does not have access. 
    
9. Acknowledgements     
 
 
10. References 
 
[RFC1771] "A Border Gateway Protocol 4 (BGP-4)". Y. Rekhter, T. Li. 
March 1995 
 
[RFC2042] "Registering New BGP Attribute Types". B. Manning. January 
1997. 
 
[RFC2082] "RIP-2 MD5 Authentication". F. Baker, R. Atkinson. January 
1997.  
 
[RFC2104] "HMAC: Keyed-Hashing for Message Authentication". H. 
Krawczyk, M. Bellare, R. Canetti. February 1997. 
 
[RFC2154] "OSPF with Digital Signatures". S. Murphy, M. Badger, B. 
Wellington. June 1997.  
 
[RFC2385] "Protection of BGP Sessions via the TCP MD5 Signature 
Option". A. Heffernan. August 1998.  
 
[RFC2547] "BGP/MPLS VPNs". E. Rosen, Y. Rekhter. March 1999. 
 
 
11. Author's Addresses 
 
      Michael H. Behringer  
      Cisco Systems, Inc. 
      Avda de la Vega, 15; 28100 Alcobendas, Madrid; Spain 
      Email: mbehring@cisco.com 
 
      Jim Guichard 
      Cisco Systems, Inc. 
      250 Apollo Drive 
      Chelmsford, MA, 01824 
      Email: jguichar@cisco.com     
 
 
12. Full Copyright Statement 
 
   Copyright (C) The Internet Society (2000).  All Rights Reserved. 
 
draft-behringer-mpls-vpn-auth-01.txt                            page 7 
Internet Draft         MPLS VPN Authentication           January 2003 
 
 
   This document and translations of it may be copied and furnished to 
   others, and derivative works that comment on or otherwise explain it 
   or assist in its implementation may be prepared, copied, published 
   and distributed, in whole or in part, without restriction of any 
   kind, provided that the above copyright notice and this paragraph  
   are included on all such copies and derivative works.  However, this 
   document itself may not be modified in any way, such as by removing 
   the copyright notice or references to the Internet Society or other 
   Internet organizations, except as needed for the purpose of 
   developing Internet standards in which case the procedures for 
   copyrights defined in the Internet Standards process must be 
   followed, or as required to translate it into languages other than 
   English. 
 
   The limited permissions granted above are perpetual and will not be 
   revoked by the Internet Society or its successors or assigns. 
 
   This document and the information contained herein is provided on an 
   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING 
   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING 
   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION 
   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF 
   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. 
 
 






















draft-behringer-mpls-vpn-auth-01.txt                            page 8 