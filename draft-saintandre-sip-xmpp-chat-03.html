<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): One-to-One Text Chat</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): One-to-One Text Chat">
<meta name="keywords" content="Text Chat, Instant Messaging, Session Initiation Protocol, SIP, Message Sessions Relay Protocol, MSRP, Extensible Messaging and Presence Protocol, XMPP">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">P. Saint-Andre</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">E. Gavita</td></tr>
<tr><td class="header">Expires: September 10, 2009</td><td class="header">N. Hossain</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">S. Loreto</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Ericsson</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">March 09, 2009</td></tr>
</table></td></tr></table>
<h1><br />Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): One-to-One Text Chat<br />draft-saintandre-sip-xmpp-chat-03</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.
This document may contain material from IETF Documents or IETF
Contributions published or made publicly available before November
10, 2008. The person(s) controlling the copyright in some of this
material may not have granted the IETF Trust the right to allow
modifications of such material outside the IETF Standards Process.
Without obtaining an adequate license from the person(s) controlling
the copyright in such materials, this document may not be modified
outside the IETF Standards Process, and derivative works of it may
not be created outside the IETF Standards Process, except to format
it for publication as an RFC or to translate it into languages other
than English.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on September 10, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>This document defines a bi-directional protocol mapping for the exchange of instant messages in the context of a one-to-one chat session between a user of the Session Initiation Protocol (SIP) and a user of the Extensible Messaging and Presence Protocol (XMPP).  Specifically for SIP text chat, this document specifies a mapping to the Message Session Relay Protocol (MSRP).
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#intro">1.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#intro-overview">1.1.</a>&nbsp;
Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#intro-scope">1.2.</a>&nbsp;
Scope<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#intro-sessions">1.3.</a>&nbsp;
Formal and Informal Sessions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#intro-heuristics">1.4.</a>&nbsp;
Gateway Heuristics<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#intro-connections">1.5.</a>&nbsp;
Connection Maintenance<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#intro-ack">1.6.</a>&nbsp;
Acknowledgements<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#intro-discuss">1.7.</a>&nbsp;
Discussion Venue<br />
<a href="#xmppf">2.</a>&nbsp;
XMPP Formal Chat Session to MSRP<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xmppf-init">2.1.</a>&nbsp;
Initiating a Formal Session<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xmppf-accept">2.2.</a>&nbsp;
Accepting a Formal Session<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xmppf-exchange">2.3.</a>&nbsp;
Exchanging Messages<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xmppf-terminate">2.4.</a>&nbsp;
Terminating a Formal Session<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xmppf-cancel">2.5.</a>&nbsp;
Cancelling the Negotiation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xmppf-reject">2.6.</a>&nbsp;
Rejecting a Formal Session<br />
<a href="#xmppi">3.</a>&nbsp;
XMPP Informal Session to MSRP<br />
<a href="#msrp">4.</a>&nbsp;
MSRP to XMPP Formal Session<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#msrpf-init">4.1.</a>&nbsp;
Initiating a Session<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#msrpf-accept">4.2.</a>&nbsp;
Accepting a Session<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#msrpf-complete">4.3.</a>&nbsp;
Completing the Transaction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#msrpf-exchange">4.4.</a>&nbsp;
Exchanging Messages<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#msrpf-terminate">4.5.</a>&nbsp;
Terminating a Session<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#msrpf-cancel">4.6.</a>&nbsp;
Cancelling the Transaction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#msrpf-reject">4.7.</a>&nbsp;
Rejecting the Transaction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#msrpf-fail">4.8.</a>&nbsp;
Session Negotiation Fails<br />
<a href="#msrpi">5.</a>&nbsp;
MSRP to XMPP Informal Session<br />
<a href="#security">6.</a>&nbsp;
Security Considerations<br />
<a href="#rfc.references1">7.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">7.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">7.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<a name="intro-overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
Overview</h3>

<p>Both the Session Initiation Protocol <a class='info' href='#SIP'>[SIP]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> and the Extensible Messaging and Presence Protocol <a class='info' href='#XMPP'>[XMPP]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a> can be used for the purpose of one-to-one text chat over the Internet.  To ensure interworking between these technologies, it is important to define bi-directional protocol mappings.
</p>
<p>The architectural assumptions underlying such protocol mappings are provided in <a class='info' href='#SIP-XMPP'>[SIP&#8209;XMPP]<span> (</span><span class='info'>Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; March&nbsp;2009.</span><span>)</span></a>, including mapping of addresses and error conditions.  Mappings for single instant messages (sometimes called "pager-mode" messaging) are provided in <a class='info' href='#SIP-XMPP-IM'>[SIP&#8209;XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Instant Messaging,&rdquo; March&nbsp;2009.</span><span>)</span></a>.  This document specifies mappings for one-to-one text chat sessions (sometimes called "session-mode" messaging); in particular, this document specifies mappings between XMPP and the Message Session Relay Protocol <a class='info' href='#MSRP'>[MSRP]<span> (</span><span class='info'>Campbell, B., Mahy, R., and C. Jennings, &ldquo;The Message Session Relay Protocol (MSRP),&rdquo; September&nbsp;2007.</span><span>)</span></a>.  Mapping of multi-user text chat (sometimes called "groupchat") is out of scope for this document.
</p>
<p>Note: The capitalized key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED",  "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a class='info' href='#TERMS'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [TERMS].
</p>
<a name="intro-scope"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.2"></a><h3>1.2.&nbsp;
Scope</h3>

<p>Both XMPP and SIP/SIMPLE technologies enable end users to send "instant messages" to other end users. The term "instant message" usually refers to messages sent between two end users for delivery in close to real time (rather than messages that are stored and forwarded to the intended recipient upon request). Generally, there are three kinds of instant messages:
</p>
<p>
          </p>
<ol class="text">
<li>Single messages, which are sent from the sender to the recipient outside the context of any one-to-one chat session or multi-user text conference.  The message is immediately delivered and not stored in an inbox.  In XMPP a single message is a &lt;message/&gt; stanza of type "normal" as specified in <a class='info' href='#XMPP-IM'>[XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence,&rdquo; October&nbsp;2004.</span><span>)</span></a>.  In SIP/SIMPLE a single message is sent via the MESSAGE method as specified in <a class='info' href='#SIP-MSG'>[SIP&#8209;MSG]<span> (</span><span class='info'>Campbell, B., Rosenberg, J., Schulzrinne, H., Huitema, C., and D. Gurle, &ldquo;Session Initiation Protocol (SIP) Extension for Instant Messaging,&rdquo; December&nbsp;2002.</span><span>)</span></a>.
</li>
<li>One-to-one chat messages, which are sent from the sender to the recipient (i.e., one-to-one) in the context of a "chat session" between the two entities.  In XMPP a chat message is a &lt;message/&gt; stanza of type "chat".  In SIP/SIMPLE a chat message is sent using an MSRP session as specified in <a class='info' href='#MSRP'>[MSRP]<span> (</span><span class='info'>Campbell, B., Mahy, R., and C. Jennings, &ldquo;The Message Session Relay Protocol (MSRP),&rdquo; September&nbsp;2007.</span><span>)</span></a>.
</li>
<li>Groupchat messages, which are sent from a sender to multiple recipients (i.e., two or more) in the context of a "multi-user chat session", "text conference", or "chatroom".  In XMPP a groupchat message is a &lt;message/&gt; stanza of type "groupchat" that is reflected from the sender to multiple recipients by a multi-user chat service, as defined in <a class='info' href='#MUC'>[MUC]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Multi-User Chat,&rdquo; April&nbsp;2007.</span><span>)</span></a>.  In SIP/SIMPLE a groupchat message is reflected from the sender to multiple recipients by a conference server that uses MSRP to handle groupchat sessions, as defined in <a class='info' href='#MSRP-MULTI'>[MSRP&#8209;MULTI]<span> (</span><span class='info'>Niemi, A., Garcia-Martin, M., and G. Sandbakken, &ldquo;Multi-party Instant Message (IM) Sessions Using the Message Session Relay  Protocol (MSRP),&rdquo; February&nbsp;2008.</span><span>)</span></a>.
</li>
</ol><p>
        
</p>
<p>This document covers only scenario #2 for converting XMPP messages of type "chat" to and from their corresponding SIP INVITE and MSRP message types on the SIP/SIMPLE side.
</p>
<p>As in <a class='info' href='#SIP-XMPP-IM'>[SIP&#8209;XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Instant Messaging,&rdquo; March&nbsp;2009.</span><span>)</span></a> and related documents, the approach taken here is to directly map syntax and semantics from one protocol to another.  The mapping described herein depends on the protocols defined in the following specifications:
</p>
<p>
          </p>
<ul class="text">
<li>XMPP chat sessions using message stanzas of type "chat" are specified in <a class='info' href='#XMPP-IM'>[XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence,&rdquo; October&nbsp;2004.</span><span>)</span></a>.
</li>
<li>A method for formally negotiating an XMPP chat session is specified in the Stanza Session Negotiation extension to XMPP <a class='info' href='#SSN'>[SSN]<span> (</span><span class='info'>Paterson, I. and P. Saint-Andre, &ldquo;Stanza Session Negotiation,&rdquo; January&nbsp;2008.</span><span>)</span></a>.
</li>
<li>SIP-based chat sessions using the SIP INVITE and SEND request types are specified in <a class='info' href='#MSRP'>[MSRP]<span> (</span><span class='info'>Campbell, B., Mahy, R., and C. Jennings, &ldquo;The Message Session Relay Protocol (MSRP),&rdquo; September&nbsp;2007.</span><span>)</span></a>.
</li>
</ul><p>
        
</p>
<a name="intro-sessions"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.3"></a><h3>1.3.&nbsp;
Formal and Informal Sessions</h3>

<p>The traditional model for a one-to-one chat "session" in XMPP is for a user to simply send a message of type "chat" to a contact, without any formal negotiation of session parameters; the contact would then reply to the message, and the sum total of such messages exchanged during a defined period of time can be considered a chat session.  This informal approach to chat sessions in XMPP can be mapped both to SIP pager-mode messaging using the SIP MESSAGE method (as documented in <a class='info' href='#SIP-XMPP'>[SIP&#8209;XMPP]<span> (</span><span class='info'>Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; March&nbsp;2009.</span><span>)</span></a>) and to an MSRP chat session.  How a gateway chooses to map the XMPP chat session to the SIP side is a matter of the implementation, although guidelines are provided under <a class='info' href='#intro-heuristics'>Section&nbsp;1.4<span> (</span><span class='info'>Gateway Heuristics</span><span>)</span></a>.
</p>
<p>However, in XMPP it is also possible to formally request a chat session and negotiate its parameters (e.g., security, privacy, message logging) before beginning the session and exchanging messages.  The protocol for doing so is defined in <a class='info' href='#SSN'>[SSN]<span> (</span><span class='info'>Paterson, I. and P. Saint-Andre, &ldquo;Stanza Session Negotiation,&rdquo; January&nbsp;2008.</span><span>)</span></a>.  In this case, the XMPP chat session SHOULD be translated into an MSRP session.
</p>
<p>This document covers the mapping of both informal and formally-negotiated XMPP chat sessions into MSRP sessions, and from MSRP sessions into XMPP informal and formal sessions.
</p>
<a name="intro-heuristics"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.4"></a><h3>1.4.&nbsp;
Gateway Heuristics</h3>

<p>When a gateway receives a chat message or chat session request intended for a recipient that is registered with the gateway itself or has an account on a local service, it SHOULD adhere to the following process in determining whether to (1) initiate a formal chat session with the recipient, (2) initiate an informal chat session with the recipient, or (3) return an error to the sender.
</p>
<p>
          </p>
<ol class="text">
<li>If the gateway has knowledge of the recipient's online endpoints (available resources in XMPP or registered UAs in SIP), then it SHOULD discover the capabilities of those endpoints.
</li>
<li>If the gateway determines that one or more of the endpoints supports formal chat sessions, it SHOULD initiate a formal chat session with one of those endpoints (deciding among the endpoints based on presence information or communications priority).
</li>
<li>If the gateway determines that none of the endpoints supports formal chat sessions, it SHOULD initiate an informal chat session with one of those endpoints (deciding among the endpoints based on presence information or communications priority).
</li>
<li>If the gateway does not know if the recipient has any online endpoints, it SHOULD return an appropriate error to the sender.
</li>
</ol><p>
        
</p>
<p>The methods by which a gateway determines support for various capabilities are protocol-specific.  For XMPP a gateway SHOULD use the Service Discovery extension defined in <a class='info' href='#DISCO'>[DISCO]<span> (</span><span class='info'>Hildebrand, J., Millard, P., Eatmon, R., and P. Saint-Andre, &ldquo;Service Discovery,&rdquo; June&nbsp;2008.</span><span>)</span></a> or, if it receives presence information from the XMPP endpoint, use the Entity Capabilities extension defined in <a class='info' href='#CAPS'>[CAPS]<span> (</span><span class='info'>Hildebrand, J., Saint-Andre, P., Tron&#xE7;on, R., and J. Konieczny, &ldquo;Entity Capabilities,&rdquo; February&nbsp;2008.</span><span>)</span></a>.  For MSRP a gateway SHOULD use the Session Description Protocol defined in <a class='info' href='#SDP'>[SDP]<span> (</span><span class='info'>Handley, M., Jacobson, V., and C. Perkins, &ldquo;SDP: Session Description Protocol,&rdquo; July&nbsp;2006.</span><span>)</span></a> in conjunction with a high-level protocol that provides a capability query, such as the SIP OPTIONS request defined in <a class='info' href='#SIP'>[SIP]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
</p>
<a name="intro-connections"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.5"></a><h3>1.5.&nbsp;
Connection Maintenance</h3>

<p>XMPP makes use of long-lived TCP connections.  If mobility affecting Layer 3 causes a dropped connection, the connection must be re-established.  If mobility does not preserve the IP address, the TCP connection will be dropped.  Any TLS session and SASL associations must be re-established if the TCP connection is dropped.  XMPP binds directly to TCP in the core specification, so the TCP session must remain open for the entire duration of the chat session.  The XMPP Standards Foundation does define protocol extensions enabling transport of XMPP traffic over HTTP (refer to <a class='info' href='#BOSH'>[BOSH]<span> (</span><span class='info'>Paterson, I., Smith, D., and P. Saint-Andre, &ldquo;Bidirectional-streams Over Synchronous HTTP (BOSH),&rdquo; October&nbsp;2008.</span><span>)</span></a> and <a class='info' href='#BOSH-XMPP'>[BOSH&#8209;XMPP]<span> (</span><span class='info'>Paterson, I., &ldquo;XMPP Over BOSH,&rdquo; October&nbsp;2008.</span><span>)</span></a>), so that individual messages are carried using HTTP and are more robust in environments such as mobile networks, allowing for better recovery if a TCP session is broken.
</p>
<p>SIMPLE is similar when using MSRP.  The Message Session Relay Protocol <a class='info' href='#MSRP'>[MSRP]<span> (</span><span class='info'>Campbell, B., Mahy, R., and C. Jennings, &ldquo;The Message Session Relay Protocol (MSRP),&rdquo; September&nbsp;2007.</span><span>)</span></a> is a protocol for transmitting instant messages (IM) in the context of a session.  The protocol specification describes how the session can be negotiated and established with an offer or answer (see <a class='info' href='#OFFER'>[OFFER]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;An Offer/Answer Model with Session Description Protocol (SDP),&rdquo; June&nbsp;2002.</span><span>)</span></a>) using the Session Description Protocol <a class='info' href='#SDP'>[SDP]<span> (</span><span class='info'>Handley, M., Jacobson, V., and C. Perkins, &ldquo;SDP: Session Description Protocol,&rdquo; July&nbsp;2006.</span><span>)</span></a>.  In SIMPLE, this exchange is carried using SIP as the signaling protocol.  After the TCP connection is established, if it fails for any reason, then an MSRP endpoint MAY choose to re-create such a session using a new SDP exchange in a SIP re-INVITE.  SIMPLE also uses the MESSAGE request type for transporting instant messaging outside the context of a session.  The MESSAGE request is sent inside the signaling path without establishing any dedicated connection.
</p>
<a name="intro-ack"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.6"></a><h3>1.6.&nbsp;
Acknowledgements</h3>

<p>Some text in this document was borrowed from <a class='info' href='#SIP-XMPP'>[SIP&#8209;XMPP]<span> (</span><span class='info'>Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; March&nbsp;2009.</span><span>)</span></a> and from <a class='info' href='#SSN'>[SSN]<span> (</span><span class='info'>Paterson, I. and P. Saint-Andre, &ldquo;Stanza Session Negotiation,&rdquo; January&nbsp;2008.</span><span>)</span></a>.
</p>
<a name="intro-discuss"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.7"></a><h3>1.7.&nbsp;
Discussion Venue</h3>

<p>The authors welcome discussion and comments related to the topics presented in this document.  The preferred forum is the &lt;sip-xmpp@xmpp.org&gt; mailing list, for which archives and subscription information are available at <a href='http://mail.jabber.org/mailman/listinfo/sip-xmpp'>http://mail.jabber.org/mailman/listinfo/sip-xmpp</a>.
</p>
<a name="xmppf"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
XMPP Formal Chat Session to MSRP</h3>

<p>This section describes how to map an XMPP "formal session" to an MSRP session.
</p>
<p>The XMPP formal session is based on the protocol described in <a class='info' href='#SSN'>[SSN]<span> (</span><span class='info'>Paterson, I. and P. Saint-Andre, &ldquo;Stanza Session Negotiation,&rdquo; January&nbsp;2008.</span><span>)</span></a>, which enables the initiation, renegotiation, and termination of a formal chat session on the XMPP side.  This approach maps to the semantic of the SIP INVITE and BYE methods.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
XMPP User                      GW                      SIP User
    |                          |                          |
    |(F1) (XMPP) Stanza session request                   |
    |-------------------------&gt;|                          |
    |                          |(F2) (SIP) INVITE         |
    |                          |-------------------------&gt;|
    |                          |(F3) (SIP) 200 OK         |
    |                          |&lt;-------------------------|
    |(F4) (XMPP) Stanza session acceptance                |
    |&lt;-------------------------|                          |
    |                          |(F5) (SIP) ACK            |
    |                          |-------------------------&gt;|
    |(F6) (XMPP) Stanza session completion                |
    |-------------------------&gt;|                          |
    |(F7) (XMPP) A chat message                           |
    |-------------------------&gt;|                          |
    |                          |(F8) (MSRP) SEND          |
    |                          |-------------------------&gt;|
    |                          |(F9) (MSRP) A reply       |
    |(F10) (XMPP) A reply      |                          |
    |&lt;-------------------------|                          |
    |                          |                          |
    .                          .                          .
    .                          .                          .
    .                          .                          .
    |                          |                          |
    |(F11) (XMPP) Stanza session termination              |
    |-------------------------&gt;|                          |
    |                          |(F12) (SIP) BYE           |
    |                          |-------------------------&gt;|
    |                          |(F13) (SIP) 200 OK        |
    |                          |&lt;-------------------------|
    |(F14) (XMPP) Termination acknowledgment              |
    |&lt;-------------------------|                          |
</pre></div>
<a name="xmppf-init"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
Initiating a Formal Session</h3>

<p>When the XMPP user ("Juliet") wants to initiate a negotiated session with a SIP user ("Romeo"), she sends a &lt;message/> stanza to Romeo containing a &lt;feature/&gt; child qualified by the 'http://jabber.org/protocol/feature-neg' namespace.  The &lt;message/> stanza must not contain a &lt;body/&gt; child (as specified in <a class='info' href='#XMPP-IM'>[XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence,&rdquo; October&nbsp;2004.</span><span>)</span></a>), since that child element is used for human-readable text.  The &lt;message/&gt; stanza type should be "normal".  The stanza MUST contain a &lt;thread/&gt; element for tracking purposes (where the newly-generated ThreadID is unique to the proposed session).  The encapsulated data form MUST contain a FORM_TYPE field whose type is "hidden" and whose value is "urn:xmpp:ssn"; it must also contain a boolean field named "accept".
</p>
<p>The XMPP user may request a session with a specific resource of the contact.  However in this document the resource identifier will be ignored and discarded for cross-system interworking.
</p>
<p>Example: (F1) Juliet starts a formal session
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='normal'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;title&gt;Open chat with Juliet?&lt;/title&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field label='Accept this session?'
             type='boolean'
             var='accept'&gt;
        &lt;value&gt;true&lt;/value&gt;
        &lt;required/&gt;
      &lt;/field&gt;
      &lt;field label='Primary written language of the chat'
             type='list-single'
             var='language'&gt;
        &lt;value&gt;en&lt;/value&gt;
        &lt;option label='English'&gt;&lt;value&gt;en&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Italiano'&gt;&lt;value&gt;it&lt;/value&gt;&lt;/option&gt;
     &lt;/field&gt;
     &lt;field label='XHTML formatting'
            type='list-single'
            var='http://jabber.org/protocol/xhtml-im'&gt;
        &lt;value&gt;may&lt;/value&gt;
        &lt;option label='Allow XHTML formatting'&gt;
          &lt;value&gt;may&lt;/value&gt;
        &lt;/option&gt;
        &lt;option label='Disallow XHTML formatting'&gt;
          &lt;value&gt;mustnot&lt;/value&gt;
        &lt;/option&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>Upon receiving such a session request, the XMPP server to which Juliet has authenticated attempts to deliver the request to a local user or attempts to route the request to the remote domain that services the hostname in the 'to' attribute.  Naturally, in this document we assume that the hostname in the 'to' attribute is an IM-aware SIP service hosted by a separate server.
</p>
<p>As specified in <a class='info' href='#XMPP-IM'>[XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence,&rdquo; October&nbsp;2004.</span><span>)</span></a>, the XMPP server needs to determine the identity of the remote domain, which it does by performing one or more <a class='info' href='#DNS-SRV'>[DNS&#8209;SRV]<span> (</span><span class='info'>Gulbrandsen, A., Vixie, P., and L. Esibov, &ldquo;A DNS RR for specifying the location of services (DNS SRV),&rdquo; February&nbsp;2000.</span><span>)</span></a> lookups.  For message stanzas, the order of lookups recommended by <a class='info' href='#XMPP-IM'>[XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence,&rdquo; October&nbsp;2004.</span><span>)</span></a> is to first try the "_xmpp-server" service as specified in <a class='info' href='#XMPP'>[XMPP]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a> and to then try the "_im" service as specified in <a class='info' href='#IMP-SRV'>[IMP&#8209;SRV]<span> (</span><span class='info'>Peterson, J., &ldquo;Address Resolution for Instant Messaging and Presence,&rdquo; August&nbsp;2004.</span><span>)</span></a>.  Here we assume that the first lookup will fail but that the second lookup will succeed and return a resolution "_im._simple.example.net.", since we have already assumed that the example.net hostname is running a SIP instant messaging service.  (Note: The XMPP server may have previously determined that the remote domain is a SIMPLE server, in which case it would not need to perform the SRV lookups; the caching of such information is a matter of implementation and local service policy, and is therefore out of scope for this document.)
</p>
<p>Once the XMPP server (example.com) has determined that the remote domain is serviced by a SIMPLE server, it hands the XMPP message off to its local XMPP-to-SIP gateway (x2s.example.com), which transforms the message into SIP syntax and routes it to the remote SIMPLE server (example.net).
</p>
<p>Example: (F2) Juliet starts a formal session (SIP transformation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
INVITE sip:romeo@example.net SIP/2.0
To: &lt;sip:romeo@example.net&gt;
From: &lt;sip:juliet@example.com&gt;;tag=786
Subject: Open chat with Juliet?
Call-ID: 711609sa
Content-Type: application/sdp

c=IN IP4 x2s.example.com
m=message 7654 TCP/MSRP *
a=accept-types:text/plain
a=lang:en
a=lang:it
a=path:msrp://x2s.example.com:7654/jshA7weztas;tcp
</pre></div>
<p>Here the Session Description Protocol offer specifies the MSRP-aware XMPP-to-SIP gateway on the XMPP side as well as other particulars of the session.
</p>
<p></p>
<blockquote class="text">
<p>There is no direct mapping for the MSRP URIs.  In fact MSRP URIs identify a session of instant messages at a particular device; they are ephemeral and have no meaning outside the scope of that session.  The authority component of the MSRP URI MUST contain the XMPP-to-SIP gateway hostname or numeric IP address and an explicit port number.
</p>
</blockquote>

<p></p>
<blockquote class="text">
<p>Native XMPP messages as described in <a class='info' href='#XMPP-IM'>[XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence,&rdquo; October&nbsp;2004.</span><span>)</span></a> supports text (i.e., UTF-8) only.  However, there exists an XMPP extension for XHTML-formatted messges, as defined by the XHTML-IM integration set specified in <a class='info' href='#XHTML-IM'>[XHTML&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;XHTML-IM,&rdquo; August&nbsp;2007.</span><span>)</span></a>.  Unless the use of XHTML-formatted messages is supported by the endpoints or negotiated during session establishment, the "accept-types" attribute that follows an MSRP media line SHOULD indicate "text/plain" as the only media-type that is acceptable to the endpoint; if XHTML is supported or negotiated, the "accept-types" attribute MAY also indicate a media-type of "text/html".  (Note: The XHTML-IM integration set supports only a subset of XHTML formatting; it is the responsibility of a gateway to map between full XHTML and XHTML-IM.)
</p>
</blockquote>

<p>As specified in <a class='info' href='#SIP-XMPP'>[SIP&#8209;XMPP]<span> (</span><span class='info'>Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; March&nbsp;2009.</span><span>)</span></a>, the mapping of XMPP syntax elements to SIP and SDP syntax elements SHOULD be as shown in the following table.  (Mappings for elements not mentioned are undefined.)
</p>
<p>Table 1: Message syntax mapping from XMPP to SIP/SDP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-----------------------------+-----------------------------+
|  XMPP Element or Attribute  |  SIP Header or SDP Contents |
+-----------------------------+-----------------------------+
|  &lt;thread/&gt;                  |  Call-ID                    |
|  from                       |  From                       |
|  to                         |  To                         |
|  &lt;title/&gt;                   |  Subject                    |
|  xml:lang                   |  a=lang:&lt;language tag&gt;      |
|  -                          |  a=accept-types:text/plain  |
+-----------------------------+-----------------------------+
</pre></div>
<a name="xmppf-accept"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Accepting a Formal Session</h3>

<p>Here we assume that the SIP user agent that receives the SIP invitation (containing an offered session description that includes a session of MSRP) accepts the invitation and includes an answer session description that acknowledges the choice of media.
</p>
<p>Example: (F3) Romeo accepts the request
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 200 OK
To: &lt;sip:romeo@example.net&gt;;tag=087js
From: &lt;sip:juliet@example.com&gt;;tag=786
Call-ID: 711609sa
Content-Type: application/sdp

c=IN IP4 example.net
m=message 12763 TCP/MSRP *
a=accept-types:text/plain
a=lang:it
a=path:msrp://s2x.example.net:12763/kjhd37s2s20w2a;tcp
</pre></div>
<p>Upon receiving such a response, the SIMPLE server or associated SIP-to-XMPP gateway SHOULD remember that this is a response to a SIP transaction related to an XMPP-SIP translation, based on the SIP Call-ID (which is functionally equivalent to the XMPP &lt;thread/&gt;).  The SIP-to-XMPP gateway is responsible for translating the response into an XMPP message stanza and routing it from the SIP user to the XMPP server or associated XMPP-to-SIP gateway.
</p>
<p>The SIP-to-XMPP gateway MUST include in the response translation values for all the fields that the XMPP request indicated are required.
</p>
<p>Example: (F4) Romeo accepts the request (XMPP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='normal'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/field&gt;
      &lt;field var='language'&gt;&lt;value&gt;it&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>The SIP-to-XMPP gateway MUST also send a SIP ACK to the SIP user.
</p>
<p>Example: (F5) Gateway sends ACK to Romeo's UA
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
ACK sip:romeo@example.net SIP/2.0
To: &lt;sip:romeo@example.net&gt;;tag=087js
From: &lt;sip:juliet@example.com&gt;;tag=786
Call-ID: 711609sa
</pre></div>
<p>If Romeo accepted the session, Juliet MUST either complete or cancel the stanza session negotiation.  The user's client SHOULD verify that the selected values of the fields are acceptable before completing the stanza session negotiation -- and confirming that the session is open -- by replying with the form 'type' attribute set to 'result'.  The form MUST contain the FORM_TYPE field and the "accept" field set to "1" or "true".
</p>
<p>Example: (F6) Juliet completes negotiation
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='normal'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>Upon receiving such a stanza completing the session negotiation, the XMPP server MUST NOT send any confirmation to the SIP side; instead, it MUST route the acceptance to the SIMPLE server or associated SIP-to-XMPP gateway.
</p>
<p>The session is now open and the parties can proceed to exchanging messages.
</p>
<a name="xmppf-exchange"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
Exchanging Messages</h3>

<p>Once the session is created, the endpoints can exchange an unbounded number of messages.
</p>
<p>The XMPP 'id' attribute is not required in the protocol and there is no way to enforce its use for messages.  It is RECOMMENDED to include it as a negotiable item in the SSN negotiation, via the "message-ids" field.  However, it is possible that the 'id' will not be present within the &lt;message/&gt; stanza; in this case the XMPP-to-SIP gateway MUST generate a new unique Message-ID.
</p>
<p>If the XMPP user has not explicitly requested message receipts during the negotiation, it is RECOMMENDED that the SIP-to-XMPP gateway shall insert a Failure-Report header field value of "no" during the creation of a SEND request.  The XMPP user can include a request for message receipts using the Message Receipts XMPP protocol extension <a class='info' href='#RECEIPTS'>[RECEIPTS]<span> (</span><span class='info'>Saint-Andre, P. and J. Hildebrand, &ldquo;Message Receipts,&rdquo; September&nbsp;2007.</span><span>)</span></a>; use of this extension can be negotiated via the "urn:xmpp:receipts" field during SSN negotiation.
</p>
<p>The mapping of XMPP syntax elements to MSRP syntax elements SHOULD be as shown in the following table.  (Mappings for elements not mentioned are undefined.)
</p>
<p>Table 2: Message syntax mapping from XMPP Message to MSRP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-----------------------------+-----------------------------+
|  XMPP Element or Attribute  |  MSRP Header                |
+-----------------------------+-----------------------------+
|  to                         |  To-Path                    |
|  from                       |  From-Path                  |
|  &lt;body/&gt;                    |  body of the SEND request   |
|  -                          |  Content-Type: text/plain   |
|  id                         |  Message-ID                 |
+-----------------------------+-----------------------------+
</pre></div>
<p>The following examples show an exchange of messages.
</p>
<p>Example: (F7) Juliet sends an XMPP message
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='chat'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>Example: (F8) Gateway transforms XMPP message to MSRP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP a786hjs2 SEND
To-Path: msrp://s2x.example.net:12763/kjhd37s2s20w2a;tcp
From-Path: msrp://x2s.example.com:7654/jshA7weztas;tcp
Message-ID: 87652491
Byte-Range: 1-25/25
Content-Type: text/plain

Art thou not Romeo, and a Montague?
-------a786hjs2$
</pre></div>
<p>Upon receiving the SEND request, if the request either contains a Failure-Report header field value of "yes" or does not contain a Failure-Report header at all, Romeo's client MUST immediately generate and send a response.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP d93kswow 200 OK
To-Path: msrp://x2s.example.com:7654/jshA7weztas;tcp
From-Path: msrp://s2x.example.net:12763/kjhd37s2s20w2a;tcp
-------d93kswow$
</pre></div>
<p>Romeo can then send a reply using his MSRP user agent.
</p>
<p>Example: (F9) Romeo sends a reply
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP a786hjs2 SEND
To-Path: msrp://x2s.example.com:7654/jshA7weztas;tcp
From-Path: msrp://s2x.example.net:12763/kjhd37s2s20w2a;tcp
Message-ID: 87652491
Byte-Range: 1-25/25
Content-Type: text/plain

Neither, fair saint, if either thee dislike.
-------a786hjs2$
</pre></div>
<p>The SIP-to-XMPP gateway would then transform that message into appropriate XMPP syntax for routing to the intended recipient.
</p>
<p>Example: (F10) Gateway transforms MSRP message to XMPP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='chat'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>Note: The size of the XML character data of an XMPP message is not limited by the protocol, but is sometimes limited in deployment.  However messages sent using MSRP can be delivered in several SEND requests, so when the XMPP-to-SIP gateway receives a message longer then 2048, it is STRONGLY RECOMMENDED it delivers this message using as few chunks (at least 2048 octets long) as possible.
</p>
<a name="xmppf-terminate"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.4"></a><h3>2.4.&nbsp;
Terminating a Formal Session</h3>

<p>If Juliet decides to terminate the negotiated chat session, her client sends a &lt;message/&gt; stanza to Romeo containing a data form of type "submit".  The &lt;message/&gt; stanza MUST contain a &lt;thread/&gt; element with the same XML character data as the original initiation request.  The data form  containing a boolean field named "terminate" set to a value of "1" or "true".
</p>
<p>Example: (F11) Juliet terminates the chat session
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='normal'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='terminate'&gt;
        &lt;value&gt;1&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>Upon receiving such stanza terminating the chat session, the XMPP-to-SIP gateway terminates the SIP session by sending a SIP BYE to tear down the MSRP session with Romeo's client.  Romeo's SIP client then responds with a 200 OK.
</p>
<p>Example: (F12) Juliet terminates the chat session (SIP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
BYE romeo@example.net sip: SIP/2.0
Max-Forwards: 70
From: &lt;sip:juliet@example.com&gt;;tag=786
To: &lt;sip:romeo@example.net&gt;;tag=087js
Call-ID: 711609sa
Cseq: 1 BYE
Content-Length: 0
</pre></div>
<p>Example: (F13) Romeo acknowledges termination
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 200 OK
From: &lt;sip:juliet@example.com&gt;;tag=786
To: &lt;sip:romeo@example.net&gt;;tag=087js
Call-ID: 711609sa
CSeq: 1 BYE
Content-Length: 0
</pre></div>
<p>Upon receiving the 200 OK, the SIP-to-XMPP gateway acknowledges the termination of the chat session on the XMPP side by sending a &lt;message/&gt; containing a data form of type "result", and the value of the "terminate" field set to "1" or "true".  The client must mirror the &lt;thread/> value it received.
</p>
<p>Example: (F14) Romeo acknowledges termination (XMPP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='normal'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='terminate'&gt;
        &lt;value&gt;1&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<a name="xmppf-cancel"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.5"></a><h3>2.5.&nbsp;
Cancelling the Negotiation</h3>

<p>If Romeo accepted the session but Juliet decides to cancel the stanza session negotiation, the flow is as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
XMPP User                      GW                      SIP User
    |                          |                          |
    |(F1) (XMPP) Stanza session request                   |
    |-------------------------&gt;|                          |
    |                          |(F2) (SIP) INVITE         |
    |                          |-------------------------&gt;|
    |                          |(F3) (SIP) 200 OK         |
    |                          |&lt;-------------------------|
    |(F4) (XMPP) Stanza session acceptance                |
    |&lt;-------------------------|                          |
    |                          |(F5) (SIP) ACK            |
    |                          |-------------------------&gt;|
    |(F6) (XMPP) Stanza session cancelling                |
    |-------------------------&gt;|                          |
    |                          |(F7) (SIP) BYE            |
    |                          |-------------------------&gt;|
    |                          |(F8) (SIP) 200 OK         |
    |                          |&lt;-------------------------|
</pre></div>
<p>That is, Juliet's client shall reply with a data form containing the FORM_TYPE field and the "accept" field set to "0" or "false":
</p>
<p>Example: (F6) User cancels stanza session negotiation
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='normal'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;
        &lt;value&gt;0&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>Upon receiving such stanza cancelling the session negotiation, the XMPP-to-SIP gateway MUST send a SIP BYE.  Once the XMPP-to-SIP gateway receives the 200 OK, the internal session data is removed and the session is officially cancelled also in the SIP-to-XMPP gateway.
</p>
<p>If the SIP user had sent any messages to XMPP while awaiting confirmation of the session, the SIP-to-XMPP gateway MUST return them to the SIP user with an appropriate error.
</p>
<a name="xmppf-reject"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.6"></a><h3>2.6.&nbsp;
Rejecting a Formal Session</h3>

<p>A common scenario occurs when the SIP UA is currently unwilling or unable to accept a formal session, in which case the flow is as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
XMPP User                      GW                      SIP User
    |                          |                          |
    |(F1) (XMPP) Stanza session request                   |
    |-------------------------&gt;|                          |
    |                          |(F2) (SIP) INVITE         |
    |                          |-------------------------&gt;|
    |                          |(F3) (SIP) 4xx/6xx        |
    |                          |&lt;-------------------------|
    |(F4) (XMPP) Stanza session decline                   |
    |&lt;-------------------------|                          |
</pre></div>
<p>Here the SIP UA declining an offer contained in an INVITE SHOULD return a 4xx or a 6xx response, such as 406 Not Acceptable or 603 Decline.  Such a response SHOULD include a Warning header field value explaining why the offer was rejected.
</p>
<p>Example: (F3) SIP user declines offer and specifies reason (SIP)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 603 Decline
From: &lt;sip:juliet@example.com&gt;;tag=786
To: &lt;sip:romeo@example.net&gt;;tag=087js
Call-ID: 711609sa
Warning: I'm busy!
Content-Length: 0
</pre></div>
<p>Upon receiving the error response for the SIP INVITE, the XMPP-to-SIP gateway shall send a "Session Reject" message back to the XMPP Client.  This message contains a data form that MUST contain the FORM_TYPE field and the "accept" field set to "0" or "false".  It is RECOMENDED that the form does not contain any other field even if the request indicated they are required.  The client MAY include a reason in the &lt;body/> child of the &lt;message/&gt; stanza.  The content of the Warning header field present in the SIP response SHOULD be mapped to a "reason" field in the data form.  If the Warning header is not present then the descriptive phrase of the SIP response can be used.
</p>
<p>Example: (F4) SIP user declines offer and specifies reason (XMPP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='normal'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;
        &lt;value&gt;0&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='reason'&gt;
        &lt;value&gt;I&amp;apos;m busy!&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<a name="xmppi"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
XMPP Informal Session to MSRP</h3>

<p>In XMPP, the "informal session" approach is to simply send someone a &lt;message/&gt; of type "chat" without starting any session negotiation ahead of time (as described in <a class='info' href='#XMPP-IM'>[XMPP&#8209;IM]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence,&rdquo; October&nbsp;2004.</span><span>)</span></a>).  The XMPP "informal session" approach maps very well into a SIP MESSAGE request, as described in <a class='info' href='#SIP-XMPP'>[SIP&#8209;XMPP]<span> (</span><span class='info'>Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; March&nbsp;2009.</span><span>)</span></a>.  However, the XMPP informal session approach can also be mapped to MSRP if the XMPP-to-SIP gateway maintains additional state.
</p>
<p>The order of events is as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
XMPP User                      GW                      SIP User
    |                          |                          |
    |(F1) (XMPP) Chat message  |                          |
    |-------------------------&gt;|                          |
    |                          |(F2) (SIP) INVITE         |
    |                          |-------------------------&gt;|
    |                          |(F3) (SIP) 200 OK         |
    |                          |&lt;-------------------------|
    |                          |(F4) (SIP) ACK            |
    |                          |-------------------------&gt;|
    |                          |(F5) (MSRP) SEND          |
    |                          |-------------------------&gt;|
    |                          |(F6) (MSRP) A reply       |
    |                          |&lt;-------------------------|
    |(F7) (XMPP) A reply       |                          |
    |&lt;-------------------------|                          |
    |                          |                          |
    .                          .                          .
    .                          .                          .
    .                          .                          .
    |                          |                          |
    |                          |(F8) (SIP) BYE            |
    |                          |&lt;-------------------------|
    |                          |(F9) (SIP) 200 OK         |
    |                          |-------------------------&gt;|
    |                          |                          |
</pre></div>
<p>First the XMPP user would generate an XMPP chat message.
</p>
<p>Example: (F1) Juliet sends an XMPP message
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='chat'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;body&gt;Art thou not Romeo, and a Montague?&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>The local SIP-to-XMPP gateway at the SIMPLE server would then determine if Romeo supports MSRP.  If so, the SIP-to-XMPP gateway would initiate an MSRP session with Romeo on Juliet's behalf.
</p>
<p>Example: (F2) Gateway starts a formal session on behalf of Juliet
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
INVITE sip:romeo@example.net SIP/2.0
To: &lt;sip:romeo@example.net&gt;
From: &lt;sip:juliet@example.com&gt;;tag=786
Subject: Open chat with Juliet?
Call-ID: 711609sa
Content-Type: application/sdp

c=IN IP4 x2s.example.com
m=message 7654 TCP/MSRP *
a=accept-types:text/plain
a=lang:en
a=lang:it
a=path:msrp://x2s.example.com:7654/jshA7weztas;tcp
</pre></div>
<p>Here we assume that Romeo accepts the MSRP session request.
</p>
<p>Example: (F3) Romeo accepts the request
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 200 OK
To: &lt;sip:romeo@example.net&gt;;tag=087js
From: &lt;sip:juliet@example.com&gt;;tag=786
Call-ID: 711609sa
Content-Type: application/sdp

c=IN IP4 s2x.example.net
m=message 12763 TCP/MSRP *
a=accept-types:text/plain
a=lang:it
a=path:msrp://s2x.example.net:12763/kjhd37s2s20w2a;tcp
</pre></div>
<p>The XMPP-to-SIP gateway then acks the session acceptance on behalf of Juliet.
</p>
<p>Example: (F4) Gateway sends ACK to Romeo's UA
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
ACK sip:romeo@example.net SIP/2.0
To: &lt;sip:romeo@example.net&gt;;tag=087js
From: &lt;sip:juliet@example.com&gt;;tag=786
Call-ID: 711609sa
</pre></div>
<p>The XMPP-to-SIP gateway then transforms the original XMPP chat message into MSRP.
</p>
<p>Example: (F5) Gateway transforms XMPP message to MSRP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP a786hjs2 SEND
From-Path: msrp://x2s.example.com:7654/jshA7weztas;tcp
To-Path: msrp://s2x.example.net:12763/kjhd37s2s20w2a;tcp
Message-ID: 87652491
Byte-Range: 1-25/25
Content-Type: text/plain

Art thou not Romeo, and a Montague?
-------a786hjs2$
</pre></div>
<p>Romeo can then send a reply using his MSRP user agent.
</p>
<p>Example: (F6) Romeo sends a reply
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP a786hjs2 SEND
To-Path: msrp://x2s.example.com:7654/jshA7weztas;tcp
From-Path: msrp://s2x.example.net:12763/kjhd37s2s20w2a;tcp
Message-ID: 87652491
Byte-Range: 1-25/25
Failure-Report: no
Content-Type: text/plain

Neither, fair saint, if either thee dislike.
-------a786hjs2$
</pre></div>
<p>Note: As previously described, if the users have not negotiated the use message receipts, it is RECOMMENDED that the SIP-to-XMPP gateway shall insert a Failure-Report header field value of "no" during the creation of a SEND request.
</p>
<p>The SIP-to-XMPP gateway would then transform that message into appropriate XMPP syntax for routing to the intended recipient.
</p>
<p>Example: (F7) Gateway transforms MSRP message to XMPP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='chat'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;body&gt;Neither, fair saint, if either thee dislike.&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>When the MSRP user wishes to end the chat session, the user's MSRP client sends a SIP BYE.
</p>
<p>Example: (F8) Romeo terminates the chat session
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
BYE juliet@example.com sip: SIP/2.0
Max-Forwards: 70
From: &lt;sip:romeo@example.net&gt;;tag=087js
To: &lt;sip:juliet@example.com&gt;;tag=786
Call-ID: 711609sa
Cseq: 1 BYE
Content-Length: 0
</pre></div>
<p>The BYE is then acknowledged by the XMPP-to-SIP gateway.
</p>
<p>Example: (F9) Gateway acknowledges termination
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 200 OK
From: &lt;sip:juliet@example.com&gt;;tag=786
To: &lt;sip:romeo@example.net&gt;;tag=087js
Call-ID: 711609sa
CSeq: 1 BYE
Content-Length: 0
</pre></div>
<a name="msrp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
MSRP to XMPP Formal Session</h3>

<p>Unlike the XMPP protocol, the MSRP protocol offers only one way to initiate a chat session, typically using the Session Description Protocol <a class='info' href='#SDP'>[SDP]<span> (</span><span class='info'>Handley, M., Jacobson, V., and C. Perkins, &ldquo;SDP: Session Description Protocol,&rdquo; July&nbsp;2006.</span><span>)</span></a> via the SIP offer/answer mechanism (see <a class='info' href='#OFFER'>[OFFER]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;An Offer/Answer Model with Session Description Protocol (SDP),&rdquo; June&nbsp;2002.</span><span>)</span></a>).
</p>
<p>The order of events is as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP User                     GW                     XMPP User
   |                         |                          |
   |(F1)(SIP) INVITE         |                          |
   |------------------------&gt;|                          |
   |                         |(F2)(XMPP) Stanza session request
   |                         |-------------------------&gt;|
   |                         |(F3)(XMPP) Stanza session acceptance
   |                         |&lt;-------------------------|
   |(F4)(SIP) 200 OK         |                          |
   |&lt;------------------------|                          |
   |(F5)(SIP) ACK            |                          |
   |------------------------&gt;|                          |
   |                         |(F6)(XMPP) Stanza session completion
   |                         |-------------------------&gt;|
   |(F7)(MSRP) SEND          |                          |
   |------------------------&gt;|                          |
   |                         |(F8)(XMPP) A chat message |
   |                         |-------------------------&gt;|
   |                         |(F9)(XMPP) A reply        |
   |                         |&lt;-------------------------|
   |(F10)(MSRP) SEND         |                          |
   |&lt;------------------------|                          |
   |                         |                          |
   .                         .                          .
   .                         .                          .
   .                         .                          .
   |                         |                          |
   |(F11)(SIP) BYE           |                          |
   |------------------------&gt;|                          |
   |                         |(F12)(XMPP) Stanza session termination
   |                         |-------------------------&gt;|
   |                         |(F13)(XMPP) Termination acknowledgment
   |                         |&lt;-------------------------|
   |(F14)(SIP) 200 OK        |                          |
   |&lt;------------------------|                          |
</pre></div>
<a name="msrpf-init"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Initiating a Session</h3>

<p>When Romeo wants to start an MSRP message session with Juliet, he first has to start the SIP session by sending out a SIP INVITE request containing an offered session description that includes an MSRP media line accompanied by a mandatory "path" attribute and corresponding URIs.  The MSRP media line is also accompanied by an "accept-types" attribute used to specify the only media-types acceptable for Romeo (i.e., text/plain and/or text/html).
</p>
<p>Note: In addition to plain text messages, MSRP is able to carry arbitrary (binary) Multipurpose Internet Mail Extensions <a class='info' href='#MIME'>[MIME]<span> (</span><span class='info'>Freed, N. and N. Borenstein, &ldquo;Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies,&rdquo; November&nbsp;1996.</span><span>)</span></a> compliant content, such as images or video clips.  Disposition of media types other than text/plain and text/html is out of scope for this specification and is a matter of implementation.
</p>
<p>Example: (F1) SIP user starts the session
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
INVITE sip:juliet@example.com SIP/2.0
To: &lt;sip:juliet@example.com&gt;
From: &lt;sip:romeo@example.net&gt;;tag=576
Subject: Open chat with Romeo?
Call-ID: 742507no
Content-Type: application/sdp

c=IN IP4 s2x.example.net
m=message 7313 TCP/MSRP *
a=accept-types:text/plain
a=lang:en
a=lang:it
a=path:msrp://s2x.example.net:7313/ansp71weztas;tcp
</pre></div>
<p>Upon receiving the INVITE, the SIP-to-XMPP gateway needs to determine the identity of the remote domain, which it does by performing one or more DNS SRV lookups <a class='info' href='#DNS-SRV'>[DNS&#8209;SRV]<span> (</span><span class='info'>Gulbrandsen, A., Vixie, P., and L. Esibov, &ldquo;A DNS RR for specifying the location of services (DNS SRV),&rdquo; February&nbsp;2000.</span><span>)</span></a>.  The SIP-to-XMPP gateway SHOULD resolve the address present in the To header of the INVITE to an im URI, then follow the rules in <a class='info' href='#IMP-SRV'>[IMP&#8209;SRV]<span> (</span><span class='info'>Peterson, J., &ldquo;Address Resolution for Instant Messaging and Presence,&rdquo; August&nbsp;2004.</span><span>)</span></a> regarding the "_im" SRV service for the target domain contained in the To header.  If SRV address resolution fails for the "_im" service, the SIP-to-XMPP gateway MAY attempt a lookup for the "_xmpp-server" service as specified in <a class='info' href='#XMPP'>[XMPP]<span> (</span><span class='info'>Saint-Andre, P., Ed., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a> or MAY return an error to the sender (i.e.  502 Bad Gateway).
</p>
<p>If SRV address resolution succeeds, the SIP-to-XMPP gateway is responsible for translating the request into an XMPP message stanza to initiate a negotiated session from the SIP user to the XMPP user.
</p>
<p>Example: (F2) SIP user starts the session (XMPP transformation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='normal'&gt;
  &lt;thread&gt;742507no&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='form'&gt;
      &lt;title&gt;Open chat with Romeo?&lt;/title&gt;
      &lt;field var='FORM_TYPE' type='hidden'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field label='Accept this session?' type='form' var='accept'&gt;
        &lt;value&gt;true&lt;/value&gt;
        &lt;required/&gt;
      &lt;/field&gt;
      &lt;field label='Primary written language of the chat'
               type='list-single'
               var='language'&gt;
        &lt;value&gt;en&lt;/value&gt;
        &lt;option label='English'&gt;&lt;value&gt;en&lt;/value&gt;&lt;/option&gt;
        &lt;option label='Italiano'&gt;&lt;value&gt;it&lt;/value&gt;&lt;/option&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>The mapping of SIP and SDP syntax elements to XMPP syntax elements SHOULD be as shown in the following table.  (Mappings for elements not mentioned in the foregoing table are undefined.)
</p>
<p>Table 3: Message syntax mapping from SIP to XMPP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-----------------------------+-----------------------------+
|  SIP Header or SDP Contents |  XMPP Element or Attribute  |
+-----------------------------+-----------------------------+
|  Call-ID                    |  &lt;thread/&gt;                  |
|  From                       |  from                       |
|  To                         |  to                         |
|  Subject                    |  &lt;title/&gt;                   |
|  accept-types               |  -                          |
|  a=lang                     |  xml:lang                   |
|  To                         |  to                         |
+-----------------------------+-----------------------------+
</pre></div>
<p>See previous note regarding negotiation and use of the XHTML-IM integration set for XHTML-formatted messages (i.e., the "text/html" accept-type).
</p>
<a name="msrpf-accept"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Accepting a Session</h3>

<p>If the request is accepted then Juliet's client MUST include all the fields that were marked as required in the request message.
</p>
<p>In the example below, we assume that Juliet accepts the session and specifies that she prefers to speak Italian with Romeo.
</p>
<p>Example: (F3) Juliet accepts session and specifies parameters
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='normal'&gt;
  &lt;thread&gt;742507no&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;true&lt;/value&gt;&lt;/field&gt;
      &lt;field var='language'&gt;&lt;value&gt;it&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>Upon receiving such a response, the SIP-to-XMPP gateway SHOULD remember that this is a response to a stanza related to an SIP-XMPP translation, based on the SIP Call-ID.  The SIP-to-XMPP gateway is responsible for translating the response into a SIP response and delivering it from the XMPP user back to the SIP user.
</p>
<p>Example: (F4) Juliet accepts session (SIP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 200 OK
To: &lt;sip:juliet@example.com&gt;;tag=534
From: &lt;sip:romeo@example.net&gt;;tag=576
Call-ID: 742507no
Content-Type: application/sdp

c=IN IP4 x2s.example.com
m=message 8763 TCP/MSRP *
a=accept-types:text/plain
a=lang:it
a=path:msrp://x2s.example.com:8763/lkjh37s2s20w2a;tcp
</pre></div>
<a name="msrpf-complete"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Completing the Transaction</h3>

<p>In this case, the 200 OK is routed back and is received by Romeo's UA.  Finally, Romeo's client sends an acknowledgment message, ACK, to Juliet's client to confirm the reception of the final response (200 OK).
</p>
<p>Example: (F5) Romeo sends ACK
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
ACK sip:juliet@example.com SIP/2.0
To: &lt;sip:juliet@example.com&gt;;tag=534
From: &lt;sip:romeo@example.net&gt;;tag=576
Call-ID: 742507no
</pre></div>
<p>Upon receiving the ACK, the SIP-to-XMPP gateway SHOULD remember this is an acknowledgment to an XMPP formal session.  The SIP-to-XMPP gateway is responsible for translating the acknowledgment into a confirmation stanza, without inserting other content (e.g.  a &lt;body/&gt; element cannot be inserted).
</p>
<p>Example: (F6) Romeo sends ACK (XMPP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='normal'&gt;
  &lt;thread&gt;742507no&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;
        &lt;value&gt;true&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<a name="msrpf-exchange"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Exchanging Messages</h3>

<p>When Romeo wants to send a message, he creates an MSRP SEND request that contains the message.
</p>
<p>Example: (F7) Romeo sends a message
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP ad49kswow SEND
To-Path: msrp://x2s.example.com:8763/lkjh37s2s20w2a;tcp
From-Path: msrp://s2x.example.net:7313/ansp71weztas;tcp
Message-ID: 44921zaqwsx
Byte-Range: 1-32/32
Failure-Report: no
Content-Type: text/plain

I take thee at thy word ...
-------ad49kswow$
</pre></div>
<p>Upon receiving the MSRP SEND request, the SIP-to-XMPP gateway SHOULD remember that the message is for an XMPP user.  The SIP-to-XMPP gateway is responsible for translating the MSRP SEND request into an XMPP message stanza.
</p>
<p>Example: (F8) Romeo sends a message (XMPP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='chat'&gt;
  &lt;thread&gt;742507no&lt;/thread&gt;
  &lt;body&gt;I take thee at thy word ...&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>The mapping of MSRP syntax elements to XMPP syntax elements SHOULD be as shown in the following table.  (Mappings for elements not mentioned are undefined.)
</p>
<p>Table 4: Message syntax mapping from MSRP Message to XMPP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-----------------------------+-----------------------------+
| MSRP Header                 |  XMPP Element or Attribute  |
+-----------------------------+-----------------------------+
|  To-Path                    |  to                         |
|  From-Path                  |  from                       |
|  body of the SEND request   |  &lt;body/&gt;                    |
|  Content-Type: text/plain   |  -                          |
|  Message-ID                 |  id                         |
+-----------------------------+-----------------------------+
</pre></div>
<p>Upon receiving the chat message, Juliet can send a reply.
</p>
<p>Example: (F9) Juliet sends a reply
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='chat'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;body&gt;What man art thou ...?&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>Example: (F10) Gateway transforms XMPP message to MSRP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP a786hjs2 SEND
From-Path: msrp://x2s.example.com:8763/lkjh37s2s20w2a;tcp
To-Path: msrp://s2x.example.net:7313/jshA7weztas;tcp
Message-ID: 87652491
Byte-Range: 1-25/25
Failure-Report: no
Content-Type: text/plain

What man art thou ...?
-------a786hjs2$
</pre></div>
<a name="msrpf-terminate"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Terminating a Session</h3>

<p>When Romeo wants to terminate the session, he is required to send a SIP BYE request.
</p>
<p>Example: (F11) Romeo terminates the session
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
BYE juliet@example.com sip: SIP/2.0
Max-Forwards: 70
From: &lt;sip:romeo@example.net&gt;;tag=576
To: &lt;sip:juliet@example.com&gt;;tag=534
Call-ID: 742507no
Cseq: 1 BYE
Content-Length: 0
</pre></div>
<p>Upon receiving the SIP BYE request, the XMPP-to-SIP gateway SHOULD translate the request to a &lt;message/&gt; stanza containing a data form of type "submit".  The &lt;message/&gt; element MUST contain a &lt;thread/&gt; element with the same XML character data as the original initiation request.  The data form containing a boolean field named "terminate" should be set to a value of "1" or "true".
</p>
<p>Example: (F12) Romeo terminates the session (XMPP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='normal'&gt;
  &lt;thread&gt;742507no&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='terminate'&gt;
        &lt;value&gt;1&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>Juliet explicitly acknowledges the termination of the chat session on the XMPP side by sending a &lt;message/> containing a data form of type "result", and the value of the "terminate" field set to "1" or "true".  The client MUST mirror the &lt;thread/> value it received.
</p>
<p>Example: (F13) Juliet acknowledges the termination of the session
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='normal'&gt;
  &lt;thread&gt;742507no&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='result'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='terminate'&gt;
        &lt;value&gt;1&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>Upon receiving the acknowledgment message, the XMPP-to-SIP gateway SHOULD translate it to a SIP answer 200 OK.
</p>
<p>Example: (F14) Juliet acknowledges the termination of the session (SIP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 200 OK
From: &lt;sip:romeo@example.net&gt;;tag=576
To: &lt;sip:juliet@example.com&gt;;tag=534
Call-ID: 742507no
CSeq: 1 BYE
</pre></div>
<a name="msrpf-cancel"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
Cancelling the Transaction</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP User                    GW                     XMPP User
   |                        |                          |
   |(F1)(SIP) INVITE        |                          |
   |-----------------------&gt;|                          |
   |                        |(F2)(XMPP) Stanza session request
   |                        |-------------------------&gt;|
   |(F3)(SIP) CANCEL        |                          |
   |-----------------------&gt;|                          |
   |                        |(F4)(XMPP) Stanza session termination
   |                        |-------------------------&gt;|
   |                        |(F5)(XMPP) Stanza acknowledgment
   |                        |            session termination
   |                        |&lt;-------------------------|
   |(F6)(SIP) 200 OK        |                          |
   |&lt;-----------------------|                          |
</pre></div>
<p>A common scenario occurs when the SIP user issues an invitation to set up a chat session with an XMPP user and immediately after the SIP invitation is sent, the SIP user decides to cancel it.  The SIP-to-XMPP gateway will receive the CANCEL request and using the Call-ID, To, From and CSeq (sequence number only) header field values as a guide, will issue an XMPP stanza session termination request to the XMPP user to cancel the XMPP formal session (assuming that it was already set up).  Once the XMPP-to-SIP gateway receives an ACK stanza message for the session termination, the XMPP-to-SIP gateway will respond with a status of 200 (OK) back to the SIP user.  It is important to note that if the SIP session transaction does not exist, the XMPP-to-SIP gateway will return a status of 481 (Transaction Does Not Exist) back to the SIP User.
</p>
<a name="msrpf-reject"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7"></a><h3>4.7.&nbsp;
Rejecting the Transaction</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP User                        GW                     XMPP User
    |                           |                          |
    |(F1)(SIP) INVITE           |                          |
    |--------------------------&gt;|                          |
    |                           |(F2)(XMPP) Stanza session request
    |                           |-------------------------&gt;|
    |                           |(F3)(XMPP) Stanza session decline
    |                           |&lt;-------------------------|
    |(F4)(SIP) 4xx/6xx          |                          |
    |&lt;--------------------------|                          |
</pre></div>
<p>Another common scenario occurs when the XMPP UA is currently not willing or able to accept a formal session request.  The XMPP UA SHOULD decline the invitation.  The data form MUST contain the FORM_TYPE field and the "accept" field set to "0" or "false".  It is RECOMMENDED that the form does not contain any other fields even if the request indicated they are required.
</p>
<p>Example: (F3) User declines offer
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='normal'&gt;
  &lt;thread&gt;742507no&lt;/thread&gt;
  &lt;feature xmlns='http://jabber.org/protocol/feature-neg'&gt;
    &lt;x xmlns='jabber:x:data' type='submit'&gt;
      &lt;field var='FORM_TYPE'&gt;
        &lt;value&gt;urn:xmpp:ssn&lt;/value&gt;
      &lt;/field&gt;
      &lt;field var='accept'&gt;&lt;value&gt;0&lt;/value&gt;&lt;/field&gt;
    &lt;/x&gt;
  &lt;/feature&gt;
&lt;/message&gt;
</pre></div>
<p>Upon receiving the declined response for the XMPP formal session request, the XMPP-to-SIP gateway SHOULD return a 4xx or a 6xx SIP response back to the SIP client.
</p>
<a name="msrpf-fail"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.8"></a><h3>4.8.&nbsp;
Session Negotiation Fails</h3>

<p>If the XMPP recipient of a formal session request does not support stanza session negotiation as specified in <a class='info' href='#SSN'>[SSN]<span> (</span><span class='info'>Paterson, I. and P. Saint-Andre, &ldquo;Stanza Session Negotiation,&rdquo; January&nbsp;2008.</span><span>)</span></a>, it will return an XMPP &lt;service-unavailable/&gt; stanza error.  Upon receiving this error from the XMPP recipient, the XMPP-to-SIP gateway SHOULD return a 501 SIP response back to the SIP sender.
</p>
<a name="msrpi"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
MSRP to XMPP Informal Session</h3>

<p>When an MSRP client sends messages through a gateway to an XMPP client that does not support formal sessinos, the order of events is as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP User                     GW                     XMPP User
   |                         |                          |
   |(F1)(SIP) INVITE         |                          |
   |------------------------&gt;|                          |
   |(F2)(SIP) 200 OK         |                          |
   |&lt;------------------------|                          |
   |(F3)(SIP) ACK            |                          |
   |------------------------&gt;|                          |
   |(F4)(MSRP) SEND          |                          |
   |------------------------&gt;|                          |
   |                         |(F5)(XMPP) A chat message |
   |                         |-------------------------&gt;|
   |                         |(F6)(XMPP) A reply        |
   |                         |&lt;-------------------------|
   |                         |                          |
   |(F7)(MSRP) SEND          |                          |
   |&lt;------------------------|                          |
   |                         |                          |
   .                         .                          .
   .                         .                          .
   .                         .                          .
   |                         |                          |
   |(F8)(SIP) BYE            |                          |
   |------------------------&gt;|                          |
   |(F9)(SIP) 200 OK         |                          |
   |&lt;------------------------|                          |
   |                         |                          |
</pre></div>
<p>Example: (F1) SIP user starts the session
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
INVITE sip:juliet@example.com SIP/2.0
To: &lt;sip:juliet@example.com&gt;
From: &lt;sip:romeo@example.net&gt;;tag=576
Subject: Open chat with Romeo?
Call-ID: 742507no
Content-Type: application/sdp

c=IN IP4 s2x.example.net
m=message 7313 TCP/MSRP *
a=accept-types:text/plain
a=lang:en
a=lang:it
a=path:msrp://s2x.example.net:7313/ansp71weztas;tcp
</pre></div>
<p>Example: (F2) Gateway accepts session on Juliet's behalf
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 200 OK
To: &lt;sip:juliet@example.com&gt;;tag=534
From: &lt;sip:romeo@example.net&gt;;tag=576
Call-ID: 742507no
Content-Type: application/sdp

c=IN IP4 x2s.example.com
m=message 8763 TCP/MSRP *
a=accept-types:text/plain
a=lang:it
a=path:msrp://x2s.example.com:8763/lkjh37s2s20w2a;tcp
</pre></div>
<p>Example: (F3) Romeo sends ACK
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
ACK sip:juliet@example.com SIP/2.0
To: &lt;sip:juliet@example.com&gt;;tag=534
From: &lt;sip:romeo@example.net&gt;;tag=576
Call-ID: 742507no
</pre></div>
<p>Example: (F4) Romeo sends a message
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP ad49kswow SEND
To-Path: msrp://x2s.example.com:8763/lkjh37s2s20w2a;tcp
From-Path: msrp://s2x.example.net:7313/ansp71weztas;tcp
Message-ID: 44921zaqwsx
Byte-Range: 1-32/32
Failure-Report: no
Content-Type: text/plain

I take thee at thy word ...
-------ad49kswow$
</pre></div>
<p>Example: (F5) Romeo sends a message (XMPP translation)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net'
         to='juliet@example.com'
         type='chat'&gt;
  &lt;thread&gt;742507no&lt;/thread&gt;
  &lt;body&gt;I take thee at thy word ...&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>Example: (F6) Juliet sends a reply
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='juliet@example.com'
         to='romeo@example.net'
         type='chat'&gt;
  &lt;thread&gt;711609sa&lt;/thread&gt;
  &lt;body&gt;What man art thou ...?&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>Example: (F8) Gateway transforms XMPP message to MSRP
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
MSRP a786hjs2 SEND
To-Path: msrp://s2x.example.net:7313/jshA7weztas;tcp
From-Path: msrp://x2s.example.com:8763/lkjh37s2s20w2a;tcp
Message-ID: 87652491
Byte-Range: 1-25/25
Failure-Report: no
Content-Type: text/plain

What man art thou ...?
-------a786hjs2$
</pre></div>
<p>Example: (F9) Romeo terminates the session
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
BYE juliet@example.com sip: SIP/2.0
Max-Forwards: 70
From: &lt;sip:romeo@example.net&gt;;tag=576
To: &lt;sip:juliet@example.com&gt;;tag=534
Call-ID: 742507no
Cseq: 1 BYE
Content-Length: 0
</pre></div>
<p>Example: (F10) Gateway acknowledges the termination of the session on behalf of XMPP user
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
SIP/2.0 200 OK
From: &lt;sip:romeo@example.net&gt;;tag=576
To: &lt;sip:juliet@example.com&gt;;tag=534
Call-ID: 742507no
CSeq: 1 BYE
</pre></div>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>To follow.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>7.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="IMP-SRV">[IMP-SRV]</a></td>
<td class="author-text">Peterson, J., &ldquo;<a href="http://tools.ietf.org/html/rfc3861">Address Resolution for Instant Messaging and Presence</a>,&rdquo; RFC&nbsp;3861, August&nbsp;2004 (<a href="ftp://ftp.isi.edu/in-notes/rfc3861.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="MSRP">[MSRP]</a></td>
<td class="author-text">Campbell, B., Mahy, R., and C. Jennings, &ldquo;<a href="http://tools.ietf.org/html/rfc4975">The Message Session Relay Protocol (MSRP)</a>,&rdquo; RFC&nbsp;4975, September&nbsp;2007 (<a href="ftp://ftp.isi.edu/in-notes/rfc4975.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="OFFER">[OFFER]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3264">An Offer/Answer Model with Session Description Protocol (SDP)</a>,&rdquo; RFC&nbsp;3264, June&nbsp;2002 (<a href="ftp://ftp.isi.edu/in-notes/rfc3264.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SIP">[SIP]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="ftp://ftp.isi.edu/in-notes/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SSN">[SSN]</a></td>
<td class="author-text"><a href="mailto:ian.paterson@clientside.co.uk">Paterson, I.</a> and <a href="mailto:stpeter@jabber.org">P. Saint-Andre</a>, &ldquo;<a href="http://www.xmpp.org/extensions/xep-0155.html">Stanza Session Negotiation</a>,&rdquo; XSF XEP&nbsp;0155, January&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="TERMS">[TERMS]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="XMPP">[XMPP]</a></td>
<td class="author-text"><a href="mailto:stpeter@jabber.org">Saint-Andre, P., Ed.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc3920">Extensible Messaging and Presence Protocol (XMPP): Core</a>,&rdquo; RFC&nbsp;3920, October&nbsp;2004 (<a href="ftp://ftp.isi.edu/in-notes/rfc3920.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc3920.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc3920.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="XMPP-IM">[XMPP-IM]</a></td>
<td class="author-text"><a href="mailto:stpeter@jabber.org">Saint-Andre, P., Ed.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc3921">Extensible Messaging and Presence Protocol (XMPP): Instant Messaging and Presence</a>,&rdquo; RFC&nbsp;3921, October&nbsp;2004 (<a href="ftp://ftp.isi.edu/in-notes/rfc3921.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc3921.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc3921.xml">XML</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>7.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="BOSH">[BOSH]</a></td>
<td class="author-text"><a href="mailto:ian.paterson@clientside.co.uk">Paterson, I.</a>, <a href="mailto:dizzyd@jabber.org">Smith, D.</a>, and <a href="mailto:stpeter@jabber.org">P. Saint-Andre</a>, &ldquo;<a href="http://www.xmpp.org/extensions/xep-0124.html">Bidirectional-streams Over Synchronous HTTP (BOSH)</a>,&rdquo; XSF XEP&nbsp;0124, October&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="BOSH-XMPP">[BOSH-XMPP]</a></td>
<td class="author-text"><a href="mailto:ian.paterson@clientside.co.uk">Paterson, I.</a>, &ldquo;<a href="http://www.xmpp.org/extensions/xep-0206.html">XMPP Over BOSH</a>,&rdquo; XSF XEP&nbsp;0206, October&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="CAPS">[CAPS]</a></td>
<td class="author-text"><a href="mailto:jhildebrand@jabber.com">Hildebrand, J.</a>, <a href="mailto:">Saint-Andre, P.</a>, <a href="mailto:">Tron&#xE7;on, R.</a>, and <a href="mailto:jajcus@jajcus.net">J. Konieczny</a>, &ldquo;<a href="http://www.xmpp.org/extensions/xep-0115.html">Entity Capabilities</a>,&rdquo; XSF XEP&nbsp;0115, February&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="DISCO">[DISCO]</a></td>
<td class="author-text"><a href="mailto:jhildebrand@jabber.com">Hildebrand, J.</a>, <a href="mailto:">Millard, P.</a>, <a href="mailto:reatmon@jabber.org">Eatmon, R.</a>, and <a href="mailto:">P. Saint-Andre</a>, &ldquo;<a href="http://www.xmpp.org/extensions/xep-0030.html">Service Discovery</a>,&rdquo; XSF XEP&nbsp;0030, June&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="DNS-SRV">[DNS-SRV]</a></td>
<td class="author-text"><a href="mailto:arnt@troll.no">Gulbrandsen, A.</a>, Vixie, P., and <a href="mailto:levone@microsoft.com">L. Esibov</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2782">A DNS RR for specifying the location of services (DNS SRV)</a>,&rdquo; RFC&nbsp;2782, February&nbsp;2000 (<a href="ftp://ftp.isi.edu/in-notes/rfc2782.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="MIME">[MIME]</a></td>
<td class="author-text"><a href="mailto:ned@innosoft.com">Freed, N.</a> and <a href="mailto:nsb@nsb.fv.com">N. Borenstein</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2045">Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies</a>,&rdquo; RFC&nbsp;2045, November&nbsp;1996 (<a href="ftp://ftp.isi.edu/in-notes/rfc2045.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="MSRP-MULTI">[MSRP-MULTI]</a></td>
<td class="author-text">Niemi, A., Garcia-Martin, M., and G. Sandbakken, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-simple-chat-02.txt">Multi-party Instant Message (IM) Sessions Using the Message Session Relay  Protocol (MSRP)</a>,&rdquo; draft-ietf-simple-chat-02 (work in progress), February&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-simple-chat-02.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="MUC">[MUC]</a></td>
<td class="author-text"><a href="mailto:stpeter@jabber.org">Saint-Andre, P.</a>, &ldquo;<a href="http://www.xmpp.org/extensions/xep-0045.html">Multi-User Chat</a>,&rdquo; XSF XEP&nbsp;0045, April&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="RECEIPTS">[RECEIPTS]</a></td>
<td class="author-text"><a href="mailto:">Saint-Andre, P.</a> and <a href="mailto:jhildebrand@jabber.com">J. Hildebrand</a>, &ldquo;<a href="http://www.xmpp.org/extensions/xep-0184.html">Message Receipts</a>,&rdquo; XSF XEP&nbsp;0184, September&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="SDP">[SDP]</a></td>
<td class="author-text">Handley, M., Jacobson, V., and C. Perkins, &ldquo;<a href="http://tools.ietf.org/html/rfc4566">SDP: Session Description Protocol</a>,&rdquo; RFC&nbsp;4566, July&nbsp;2006 (<a href="ftp://ftp.isi.edu/in-notes/rfc4566.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SIP-MSG">[SIP-MSG]</a></td>
<td class="author-text">Campbell, B., Rosenberg, J., Schulzrinne, H., Huitema, C., and D. Gurle, &ldquo;<a href="http://tools.ietf.org/html/rfc3428">Session Initiation Protocol (SIP) Extension for Instant Messaging</a>,&rdquo; RFC&nbsp;3428, December&nbsp;2002 (<a href="ftp://ftp.isi.edu/in-notes/rfc3428.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SIP-XMPP">[SIP-XMPP]</a></td>
<td class="author-text">Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-saintandre-sip-xmpp-core-01.txt">Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Core</a>,&rdquo; draft-saintandre-sip-xmpp-core-01 (work in progress), March&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-saintandre-sip-xmpp-core-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SIP-XMPP-IM">[SIP-XMPP-IM]</a></td>
<td class="author-text">Saint-Andre, P., Houri, A., and J. Hildebrand, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-saintandre-sip-xmpp-im-01.txt">Interworking between the Session Initiation Protocol (SIP) and the Extensible Messaging and Presence Protocol (XMPP): Instant Messaging</a>,&rdquo; draft-saintandre-sip-xmpp-im-01 (work in progress), March&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-saintandre-sip-xmpp-im-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="XHTML-IM">[XHTML-IM]</a></td>
<td class="author-text"><a href="mailto:">Saint-Andre, P.</a>, &ldquo;<a href="http://www.xmpp.org/extensions/xep-0071.html">XHTML-IM</a>,&rdquo; XSF XEP&nbsp;0071, August&nbsp;2007.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Peter Saint-Andre</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:psaintan@cisco.com">psaintan@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Eddy Gavita</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ericsson</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Decarie Boulevard</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Town of Mount Royal, Quebec  </td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:eddy.gavita@ericsson.com">eddy.gavita@ericsson.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nazin Hossain</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ericsson</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Decarie Boulevard</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Town of Mount Royal, Quebec</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Nazin.Hossain@ericsson.com">Nazin.Hossain@ericsson.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Salvatore Loreto</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ericsson</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hirsalantie 11</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jorvas  02420</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Salvatore.Loreto@ericsson.com">Salvatore.Loreto@ericsson.com</a></td></tr>
</table>
</body></html>
