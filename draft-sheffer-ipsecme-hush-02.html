<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>HUSH: Using HUmanly memorable SHared secrets with IKEv2</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology">
<link href="#rfc.section.3" rel="Chapter" title="3 Overview">
<link href="#rfc.section.4" rel="Chapter" title="4 Protocol Sequence">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 The IKE_SA_INIT Exchange">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 The IKE_HUSH Exchange">
<link href="#rfc.section.4.2.1" rel="Chapter" title="4.2.1 Message #1">
<link href="#rfc.section.4.2.2" rel="Chapter" title="4.2.2 Message #2">
<link href="#rfc.section.4.2.3" rel="Chapter" title="4.2.3 Message #3">
<link href="#rfc.section.4.2.4" rel="Chapter" title="4.2.4 Message #4">
<link href="#rfc.section.5" rel="Chapter" title="5 Protocol Formats">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Encrypt Payload">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Protect Payload">
<link href="#rfc.section.6" rel="Chapter" title="6 Cryptographic Details">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Diffie-Hellman Groups">
<link href="#rfc.section.7" rel="Chapter" title="7 IANA Considerations">
<link href="#rfc.section.8" rel="Chapter" title="8 Security Considerations">
<link href="#rfc.section.9" rel="Chapter" title="9 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="10 References">
<link href="#rfc.references.1" rel="Chapter" title="10.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="10.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Change Log">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 -01">
<link href="#rfc.appendix.Appendix%20A.2" rel="Chapter" title="Appendix A.2 -00">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document defines a new mode for IKEv2, where both peers can authenticate using a short, humanly memorable shared secret. This mode is based on the EKE protocol." />
  <meta name="description" content="This document defines a new mode for IKEv2, where both peers can authenticate using a short, humanly memorable shared secret. This mode is based on the EKE protocol." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">Y. Sheffer</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Independent</td>
</tr>
<tr>
<td class="left">Intended status: Informational</td>
<td class="right">S. Fluhrer</td>
</tr>
<tr>
<td class="left">Expires: September 10, 2011</td>
<td class="right">Cisco</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">March 09, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">HUSH: Using HUmanly memorable SHared secrets with IKEv2<br />
  <span class="filename">draft-sheffer-ipsecme-hush-02</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document defines a new mode for IKEv2, where both peers can authenticate using a short, humanly memorable shared secret. This mode is based on the EKE protocol.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on September 10, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Terminology</a>
</li>
<li>3.   <a href="#rfc.section.3">Overview</a>
</li>
<li>4.   <a href="#rfc.section.4">Protocol Sequence</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">The IKE_SA_INIT Exchange</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">The IKE_HUSH Exchange</a>
</li>
<li>4.2.1.   <a href="#rfc.section.4.2.1">Message #1</a>
</li>
<li>4.2.2.   <a href="#rfc.section.4.2.2">Message #2</a>
</li>
<li>4.2.3.   <a href="#rfc.section.4.2.3">Message #3</a>
</li>
<li>4.2.4.   <a href="#rfc.section.4.2.4">Message #4</a>
</li>
<li>5.   <a href="#rfc.section.5">Protocol Formats</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Encrypt Payload</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Protect Payload</a>
</li>
<li>6.   <a href="#rfc.section.6">Cryptographic Details</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">Diffie-Hellman Groups</a>
</li>
<li>7.   <a href="#rfc.section.7">IANA Considerations</a>
</li>
<li>8.   <a href="#rfc.section.8">Security Considerations</a>
</li>
<li>9.   <a href="#rfc.section.9">Acknowledgements</a>
</li>
<li>10.   <a href="#rfc.references">References</a>
</li>
<li>10.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>10.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Change Log</a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">-01</a>
</li>
<li>Appendix A.2.   <a href="#rfc.appendix.Appendix%20A.2">-00</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">There is strong interest in a simple method for bootstrapping an IKE <a href="#RFC4306">[RFC4306]</a> security association between two peers, requiring neither PKI nor AAA infrastructure. Although IKEv2 supports EAP-based authentication in part to provide for this capability, it has been claimed that the use of an extra authentication layer/protocol adds little benefit and increases complexity.</p>
<p id="rfc.section.1.p.2">This protocol integrates the well known EKE protocol <a href="#BM92">[BM92]</a> into IKEv2, to provide password-based authentication. Some of the benefits of this protocol are:</p>
<p></p>

<ul>
<li>EKE is a well known protocol, which has had multiple deep cryptographic analyses applied to it.</li>
<li>EKE provides the benefit of a well known, clear IPR status.</li>
</ul>

<p> </p>
<p id="rfc.section.1.p.4">This protocol is not intended for use in enterprise-scale remote access.  As a result, only the basic authentication capability is provided.  Some capabilities typically associated with the use of passwords for remote access include: password change and expiry, password recovery, and enforcement of password strength policy.</p>
<p id="rfc.section.1.p.5">In this preliminary version of the protocol many issues are not yet covered, such as:</p>
<p></p>

<ul>
<li>Integration with other IKE elements, e.g. optional notifications, Session Resumption...</li>
<li>Error handling.</li>
<li>Generation of a high-quality PSK, so that the password doesn't need to be used for each authentication. Secure signalling of PSK possession.</li>
<li>Security analysis.</li>
</ul>

<p> </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Terminology</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Overview</h1>
<p id="rfc.section.3.p.1">This protocol attempts to preserve the general structure of IKEv2, minimizing the number of new constructs and round trips, while retaining IKE's security guarantees, including identity protection. The resulting protocol only adds one round trip to the shared secret authentication mode of IKEv2.</p>
<div id="#rfc.figure.1"></div>
<pre>
              
        Initiator                           Responder
        ---------                           ---------

HDR, SAi1, KEi, Ni, N(HUSH)

		    &lt;- HDR, SAr1, KEr, Nr, N(HUSH)

HDR, SK{IDi, [IDr,], SAi2, TSi, TSr, Encrypt{Yi}} -&gt;

		    &lt;- HDR, SK{IDr, Encrypt{Yr}, Protect{Nr2}}

HDR, SK{AUTH, Protect{Ni2|Nr2}}

		    &lt;- HDR, SK{AUTH, SAr2, TSi, TSr, Protect{Ni2}}

            </pre>
<p id="rfc.section.3.p.2">At a high level, the message exchange is as follows: </p>
<p id="rfc.section.3.p.3">The changes to IKEv2 are summarized in the following list:</p>
<p></p>

<ul>
<li>The regular IKE_SA_INIT exchange is followed by a new 2-round trip exchange, IKE_HUSH.</li>
<li>Negotiation of the new mode using notifications in IKE_SA_INIT.</li>
<li>Negotiation of cryptographic algorithms: the encryption algorithm, the integrity protection algorithm and the pseudo-random function are the ones negotiated for the IKE SA itself, while a new Diffie-Hellman group is selected for the HUSH exchange, by extending the SAi1/SAr1 negotiation.</li>
<li>A new encrypted payload type, denoted Encrypt{}, for exchanging an ephemeral public key encrypted by the password.</li>
<li>A new encrypted and integrity-protected payload type, denoted Protect{}, for exchanging nonces encrypted by the EKE shared secret.</li>
<li>The IKE AUTH payloads provide cryptographic binding of the IKE shared secret with the password-based authentication.</li>
</ul>

<p> </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#protocol" id="protocol">Protocol Sequence</a>
</h1>
<p id="rfc.section.4.p.1">The protocol consists of a slightly extended IKE_SA_INIT exchange, followed by the 4-message IKE_HUSH exchange.</p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> The IKE_SA_INIT Exchange</h1>
<p id="rfc.section.4.1.p.1">During this exchange, the initiator sends an empty HUSH_SUPPORTED notification.  If the responder understands this protocol and wishes to use it, it sends back another empty HUSH_SUPPORTED notification.</p>
<p id="rfc.section.4.1.p.2">In addition, this protocol defines a new transform type for the IKE protocol, called "EKE D-H Group". Possible transforms are the EKE groups defined in <a href="#dh-groups">Section 6.1</a>.  This transform type is negotiated between the initiator and responder with the usual SAi1, SAr1 payloads. If the initiator suspects that the responder does not support this protocol, it SHOULD also include a proposal that omits this transform, to allow the negotiation to revert to regular IKE. During successful negotiation, an EKE D-H Group MUST be negotiated if (and only if) the responder indicates support for this protocol.</p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> The IKE_HUSH Exchange</h1>
<p id="rfc.section.4.2.p.1">This exchange consists of two message pairs, and includes all payloads normally contained in the IKE_AUTH exchange. These latter payloads are not described in this subsection, in order to focus on the new HUSH payloads.</p>
<h1 id="rfc.section.4.2.1">
<a href="#rfc.section.4.2.1">4.2.1.</a> Message #1</h1>
<p id="rfc.section.4.2.1.p.1">The initiator computes </p>
<p></p>

<ul class="empty"><li>Yi = g^x mod N,</li></ul>

<p> </p>
<p id="rfc.section.4.2.1.p.3">where x is a randomly chosen number in the range 2 .. N-1, as defined by the negotiated Diffie-Hellman group. The randomly chosen number is the private key, and the calculated value is the corresponding public key.  Each of the peers MUST use a fresh, random value for x on each run of the protocol.</p>
<p id="rfc.section.4.2.1.p.4">Note: If Elliptic Curve Diffie-Hellman is used in a future version of this protocol, the corresponding additive group operations are to be understood.</p>
<p id="rfc.section.4.2.1.p.5">The initiator generates the Encrypt payload (<a href="#encrypt-payload">Section 5.1</a>),</p>
<p></p>

<ul class="empty"><li>Encrypt(prf+(password, "HUSH Password"), Yi),</li></ul>

<p> </p>
<p id="rfc.section.4.2.1.p.7">where the literal string is encoded using ASCII with no zero terminator.  The prf+ notation is as defined in <a href="#RFC4306">[RFC4306]</a>.  When using block ciphers, it may be necessary to pad Yi on the right, to fit the encryption algorithm's block size. In such cases, random padding MUST be used, and this randomness is critical to the security of the protocol. Randomness recommendations can be found in <a href="#RFC4086">[RFC4086]</a>.</p>
<p id="rfc.section.4.2.1.p.8">If the password needs to be stored on the server, it is RECOMMENDED to store the randomized password value, i.e. prf+(password, ...), as a password-equivalent, rather than the cleartext password.</p>
<p id="rfc.section.4.2.1.p.9">If the password is non-ASCII, it SHOULD be normalized by the sender before the message is constructed. The normalization method is SASLprep, <a href="#RFC4013">[RFC4013]</a>.  Note that the password is not null-terminated.  </p>
<h1 id="rfc.section.4.2.2">
<a href="#rfc.section.4.2.2">4.2.2.</a> Message #2</h1>
<p id="rfc.section.4.2.2.p.1">Similarly to Message #1, the responder picks a random private key, generates an ephemeral public key Yr, encrypts it by the expanded password and includes the resulting Encrypt payload in the message:</p>
<p></p>

<ul class="empty"><li>Encrypt(prf+(password, "HUSH Password"), Yr),</li></ul>

<p> </p>
<p id="rfc.section.4.2.2.p.3">The responder now calculates</p>
<p></p>

<ul class="empty"><li>EkeSharedSecret = prf(0+, g^(x*y) mod N)</li></ul>

<p> </p>
<p id="rfc.section.4.2.2.p.5">where the first argument to "prf" is a string of zero octets whose length is the output size of the base hash algorithm, e.g. 20 octets for HMAC-SHA1; the result is of the same length.  This extra application of the pseudo-random function is the "extraction step" of <a href="#RFC5869">[RFC5869]</a>.  </p>
<p id="rfc.section.4.2.2.p.6">The responder computes the encryption and authentication (integrity protection) keys: </p>
<p></p>

<ul class="empty"><li>Ke2, Ka2 = prf+(EkeSharedSecret, "HUSH encryption and authentication" | IDi | IDr)</li></ul>

<p> </p>
<p id="rfc.section.4.2.2.p.8">Now the responder can generate the Protect payload included in the message:</p>
<p></p>

<ul class="empty"><li>Protect(Ke2, Ka2, Nr2),</li></ul>

<p> </p>
<p id="rfc.section.4.2.2.p.10">where Nr2 is a randomly generated binary string (nonce). Nr2 has length equal to the block size of the negotiated encryption algorithm for block ciphers, or 32 octets if this algorithm is a stream cipher.  The responder sends this value as an Encrypt payload.</p>
<h1 id="rfc.section.4.2.3">
<a href="#rfc.section.4.2.3">4.2.3.</a> Message #3</h1>
<p id="rfc.section.4.2.3.p.1">The initiator computes the EkeSharedSecret, Ke2 and Ka2 values as above.</p>
<p id="rfc.section.4.2.3.p.2">It then picks a random nonce Ni2, of the same format as Nr2, concatenates the two nonces, and generates</p>
<p></p>

<ul class="empty"><li>Protect(Ke2, Ka2, Ni2 | Nr2),</li></ul>

<p> </p>
<p id="rfc.section.4.2.3.p.4">In addition, it computes</p>
<p></p>

<ul class="empty"><li>AUTH = prf(prf(Shared Secret, Ni2 | Nr2 | IDi | IDr), &lt;InitiatorSignedOctets&gt;) </li></ul>

<p> </p>
<p id="rfc.section.4.2.3.p.6">where the Shared Secret is the regular IKE shared secret, created by the IKE_SA_INIT exchange.</p>
<h1 id="rfc.section.4.2.4">
<a href="#rfc.section.4.2.4">4.2.4.</a> Message #4</h1>
<p id="rfc.section.4.2.4.p.1">The responder verifies Nr2 and the received AUTH payload, and MUST terminate the protocol if either of them fails to verify. The responder generates</p>
<p></p>

<ul class="empty"><li>Protect(Ke2, Ka2, Ni2)</li></ul>

<p> </p>
<p id="rfc.section.4.2.4.p.3">and</p>
<p></p>

<ul class="empty"><li>AUTH = prf(prf(Shared Secret, Ni2 | Nr2 | IDi | IDr), &lt;ResponderSignedOctets&gt;) </li></ul>

<p> </p>
<p id="rfc.section.4.2.4.p.5">The initiator MUST verify the Ni2 and AUTH values when receiving Message #4.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> Protocol Formats</h1>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#encrypt-payload" id="encrypt-payload">Encrypt Payload</a>
</h1>
<p id="rfc.section.5.1.p.1">This payload contains encrypted, but non-integrity protected, data.  Unfortunately the simpler term "Encrypted Payload" is used by IKEv2 for a payload that contains encrypted and integrity-protected data.</p>
<p id="rfc.section.5.1.p.2">Compared to the IKE Encrypted Payload, this payload does not contain other embedded payloads. The payload is denoted Encrypt(key, data), and defined thus:</p>
<div id="#rfc.figure.2"></div>
<pre>
              
                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Next Payload  |C|  RESERVED   |         Payload Length        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     Initialization Vector                     |
   |         (length is block size for encryption algorithm)       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |        Data Length            |                               ~
   |-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|  Encrypted Data               ~
   ~                                                               ~
   ~               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   ~               |                                               ~
   +-+-+-+-+-+-+-+-+      Random Padding (0-255 octets)            ~
   ~                                                               ~
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

            </pre>
<p></p>
<p></p>

<ul>
<li>Data Length is a 2 octet length of the encrypted data, exclusive of padding.  This field itself is unencrypted.</li>
<li>Random Padding MUST indeed be random and unpredictable if it is included.  This randomness is critical to the security of the protocol.</li>
</ul>

<p> </p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#protect-payload" id="protect-payload">Protect Payload</a>
</h1>
<p id="rfc.section.5.2.p.1">This payload contains encrypted and integrity protected data.  </p>
<p id="rfc.section.5.2.p.2">This payload is identical to the Encrypt Payload (<a href="#encrypt-payload">Section 5.1</a>) with the addition of an integrity-protection ICV field.  The payload is denoted by Protect(enc-key, integ-key, data) and defined as follows:</p>
<div id="#rfc.figure.3"></div>
<pre>
              
                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Next Payload  |C|  RESERVED   |         Payload Length        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     Initialization Vector                     |
   |         (length is block size for encryption algorithm)       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |        Data Length            |                               ~
   |-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|  Encrypted Data               ~
   ~                                                               ~
   ~               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   ~               |                                               ~
   +-+-+-+-+-+-+-+-+      Random Padding (0-255 octets)            ~
   ~                                                               ~
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                  Integrity Check Value (ICV)                  |
   |              (length depends on integrity algorithm)          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   
            </pre>
<p></p>
<p></p>

<ul><li>The Integrity Check Value is computed over the Initialization Vector, Data Length, Encrypted Data and Random Padding (if any). The length of the field is determined by the negotiated integrity algorithm.</li></ul>

<p> </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> Cryptographic Details</h1>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> <a href="#dh-groups" id="dh-groups">Diffie-Hellman Groups</a>
</h1>
<p id="rfc.section.6.1.p.1">Many of the commonly used Diffie Hellman groups are inappropriate for use in EKE.  Most of these groups use a generator which is not a primitive element of the group.  As a result, an attacker running a dictionary attack would be able to learn at least 1 bit of information for each decrypted password guess.  </p>
<p id="rfc.section.6.1.p.2">Any MODP Diffie Hellman group defined for use in this protocol MUST have the following properties, to ensure that it does not leak a usable amount of information about the password: </p>

<ol>
<li>The generator is a primitive element of the group.</li>
<li>The most significant 64 bits of the prime number are 1.</li>
<li>The group's order p is a "safe prime", i.e. (p-1)/2 is also prime.  </li>
</ol>

<p> </p>
<p id="rfc.section.6.1.p.3">The last requirement is related to the strength of the Diffie Hellman algorithm, rather than the password encryption. It also makes it easy to verify that the generator is primitive.  </p>
<p id="rfc.section.6.1.p.4">We have defined the following groups. The Value column is used when negotiating the group.  Additional groups may be defined through IANA allocation. Future non-MODP groups require a document to define their interaction with this protocol.  </p>
<div id="#rfc.table.1"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="left">Name</th>
<th class="left">Length</th>
<th class="left">Value</th>
<th class="left">Description</th>
</tr></thead>
<tbody>
<tr>
<td class="left">Reserved</td>
<td class="left"></td>
<td class="left">0</td>
<td class="left"></td>
</tr>
<tr>
<td class="left">DHGROUP_EKE_2</td>
<td class="left">1024</td>
<td class="left">1</td>
<td class="left">The prime number of Group 2 <a href="#RFC4306">[RFC4306]</a>, with the generator 5 (decimal)</td>
</tr>
<tr>
<td class="left">DHGROUP_EKE_5</td>
<td class="left">1536</td>
<td class="left">2</td>
<td class="left">The prime number of Group 5 <a href="#RFC3526">[RFC3526]</a>, g=31</td>
</tr>
<tr>
<td class="left">DHGROUP_EKE_14</td>
<td class="left">2048</td>
<td class="left">3</td>
<td class="left">The prime number of Group 14 <a href="#RFC3526">[RFC3526]</a>, g=11</td>
</tr>
<tr>
<td class="left">DHGROUP_EKE_15</td>
<td class="left">3072</td>
<td class="left">4</td>
<td class="left">The prime number of Group 15 <a href="#RFC3526">[RFC3526]</a>, g=5</td>
</tr>
<tr>
<td class="left">DHGROUP_EKE_16</td>
<td class="left">4096</td>
<td class="left">5</td>
<td class="left">The prime number of Group 16 <a href="#RFC3526">[RFC3526]</a>, g=5</td>
</tr>
<tr>
<td class="left">Available for allocation via IANA</td>
<td class="left"></td>
<td class="left">6-127</td>
<td class="left"></td>
</tr>
<tr>
<td class="left">Reserved for private use</td>
<td class="left"></td>
<td class="left">128-255</td>
<td class="left"></td>
</tr>
</tbody>
</table>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#iana" id="iana">IANA Considerations</a>
</h1>
<p id="rfc.section.7.p.1">TBD: one notification, one transform type, two payloads, a new exchange.  Also a new DH group registry.</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.8.p.1">Will be added.</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> Acknowledgements</h1>
<p id="rfc.section.9.p.1">Much of this protocol is derived from <a href="#I-D.sheffer-emu-eap-eke">[I-D.sheffer-emu-eap-eke]</a>, and authors (and reviewers) of that draft are acknowledged.</p>
<h1 id="rfc.references">
<a href="#rfc.references">10.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">10.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3526">[RFC3526]</b></td>
<td class="top">
<a>Kivinen, T.</a> and <a>M. Kojo</a>, "<a href="http://tools.ietf.org/html/rfc3526">More Modular Exponential (MODP) Diffie-Hellman groups for Internet Key Exchange (IKE)</a>", RFC 3526, May 2003.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4306">[RFC4306]</b></td>
<td class="top">
<a>Kaufman, C.</a>, "<a href="http://tools.ietf.org/html/rfc4306">Internet Key Exchange (IKEv2) Protocol</a>", RFC 4306, December 2005.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">10.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC4013">[RFC4013]</b></td>
<td class="top">
<a>Zeilenga, K.</a>, "<a href="http://tools.ietf.org/html/rfc4013">SASLprep: Stringprep Profile for User Names and Passwords</a>", RFC 4013, February 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4086">[RFC4086]</b></td>
<td class="top">
<a>Eastlake, D.</a>, <a>Schiller, J.</a> and <a>S. Crocker</a>, "<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>", BCP 106, RFC 4086, June 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5869">[RFC5869]</b></td>
<td class="top">
<a>Krawczyk, H.</a> and <a>P. Eronen</a>, "<a href="http://tools.ietf.org/html/rfc5869">HMAC-based Extract-and-Expand Key Derivation Function (HKDF)</a>", RFC 5869, May 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.sheffer-emu-eap-eke">[I-D.sheffer-emu-eap-eke]</b></td>
<td class="top">
<a>Sheffer, Y</a>, <a>Zorn, G</a>, <a>Tschofenig, H</a> and <a>S Fluhrer</a>, "<a href="http://tools.ietf.org/html/draft-sheffer-emu-eap-eke-09">An EAP Authentication Method Based on the EKE Protocol</a>", Internet-Draft draft-sheffer-emu-eap-eke-09, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="BM92">[BM92]</b></td>
<td class="top">
<a>Bellovin, S.</a> and <a>M. Merritt</a>, "<a>Encrypted Key Exchange: Password-Based Protocols Secure Against Dictionary Attacks</a>", Proc. IEEE Symp. on Research in Security and Privacy , May 1992.</td>
</tr>
<tr>
<td class="reference"><b id="BM93">[BM93]</b></td>
<td class="top">
<a>Bellovin, S.</a> and <a>M. Merritt</a>, "<a>Augmented Encrypted Key Exchange: A Password-Based Protocol Secure against Dictionary Attacks and Password File Compromise</a>", Proc. 1st ACM Conference on Computer and Communication Security , 1993.</td>
</tr>
<tr>
<td class="reference"><b id="BMP00">[BMP00]</b></td>
<td class="top">
<a>Boyko, V.</a>, <a>MacKenzie, P.</a> and <a>S. Patel</a>, "<a>Provably Secure Password Authenticated Key Exchange Using Diffie-Hellman</a>", Advances in Cryptology, EUROCRYPT 2000 , 2000.</td>
</tr>
<tr>
<td class="reference"><b id="PA97">[PA97]</b></td>
<td class="top">
<a>Patel, S.</a>, "<a>Number Theoretic Attacks On Secure Password Schemes</a>", Proceedings of the 1997 IEEE Symposium on Security and Privacy , 1997.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> Change Log</h1>
<p id="rfc.section.Appendix A.p.1">Note to RFC Editor: please remove this section before publication.</p>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> -01</h1>
<p id="rfc.section.Appendix A.1.p.1">Reissued, changed the derivation of the payload encryption and authentication keys.</p>
<h1 id="rfc.appendix.Appendix A.2">
<a href="#rfc.appendix.Appendix%20A.2">Appendix A.2.</a> -00</h1>
<p id="rfc.section.Appendix A.2.p.1">Initial version, a very rough draft.</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Yaron Sheffer</span> 
	  <span class="n hidden">
		<span class="family-name">Sheffer</span>
	  </span>
	</span>
	<span class="org vcardline">Independent</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:yaronf.ietf@gmail.com">yaronf.ietf@gmail.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Scott Fluhrer</span> 
	  <span class="n hidden">
		<span class="family-name">Fluhrer</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems.</span>
	<span class="adr">
	  <span>1414 Massachusetts Ave.</span>

	  <span class="vcardline">
		<span class="locality">Boxborough, MA</span>,  
		<span class="region"></span>
		<span class="code">01719</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:sfluhrer@cisco.com">sfluhrer@cisco.com</a></span>

  </address>
</div>

</body>
</html>