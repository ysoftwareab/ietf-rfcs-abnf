m = max(1, ceil(bitlength(H) / BLOCKLEN))
Offset = ENCIPHER(K, zeros(BLOCKLEN))
Offset = times3(Offset)
Offset = times3(Offset)
Checksum = zeros(BLOCKLEN)

Offset = times2(Offset)
Checksum = Checksum xor ENCIPHER(K, H_i xor Offset)
Offset = times2(Offset)
Offset = times3(Offset)
Checksum = Checksum xor H_m
Offset = times3(Offset)
Offset = times3(Offset)
Tmp = H_m || 1 || zeros(BLOCKLEN - (bitlength(H_m) + 1))
Checksum = Checksum xor Tmp
Auth = ENCIPHER(K, Offset xor Checksum)


m = max(1,ceil(bitlength(M) / BLOCKLEN))
Offset = ENCIPHER(K,N)
Checksum = zeros(BLOCKLEN)

Offset = times2(Offset)
Checksum = Checksum xor M_i
C_i = Offset xor ENCIPHER(K, M_i xor Offset)
Offset = times2(Offset)
b = bitlength(M_m)              // Value in 0..BLOCKLEN
Pad = ENCIPHER(K, num2str(b, BLOCKLEN) xor Offset)
C_m = M_m xor Pad[1..b]         // Encrypt M_m
Tmp = M_m || Pad[b+1..BLOCKLEN]
Checksum = Checksum xor Tmp

Offset = times3(Offset)
T = ENCIPHER(K, Checksum xor Offset)
T = T xor PMAC(K, H)
C = C_1 || C_2 || ... || C_m


m = max(1,ceil(bitlength(C) / BLOCKLEN))
Offset = ENCIPHER(K,N)
Checksum = zeros(BLOCKLEN)

Offset = times2(Offset)
M_i = Offset xor DECIPHER(K, C_i xor Offset)
Checksum = Checksum xor M_i
Offset = times2(Offset)
b = bitlength(C_m)              // Value in 0..BLOCKLEN
Pad = ENCIPHER(K, num2str(b, BLOCKLEN) xor Offset)
M_m = C_m xor Pad[1..b]
Tmp = M_m || Pad[b+1..BLOCKLEN]
Checksum = Checksum xor Tmp

Offset = times3(Offset)
FullValidTag = ENCIPHER(K, Offset xor Checksum)
FullValidTag = FullValidTag xor PMAC(K, H)
V = true
M = M_1 || M_2 || ... || M_m
V = false
M = <emptystring>
