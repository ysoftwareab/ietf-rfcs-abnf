<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Domain Name Assertions</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology">
<link href="#rfc.section.3" rel="Chapter" title="3 Protocol Overview">
<link href="#rfc.section.4" rel="Chapter" title="4 Connection Model">
<link href="#rfc.section.5" rel="Chapter" title="5 Channel Establishment and Authentication">
<link href="#rfc.section.6" rel="Chapter" title="6 Authorizing XMPP Stanzas">
<link href="#rfc.section.7" rel="Chapter" title="7 Backward Compatibility">
<link href="#rfc.section.8" rel="Chapter" title="8 Operational Considerations">
<link href="#rfc.section.9" rel="Chapter" title="9 IANA Considerations">
<link href="#rfc.section.10" rel="Chapter" title="10 Security Considerations">
<link href="#rfc.section.11" rel="Chapter" title="11 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="12 References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="The current authentication process in XMPP requires the XMPP server for a domain to present a certificate that contains that domain's name.  This requirement causes several problems in scenarios where XMPP services have been delegated from one domain to another, especially when one domain provides XMPP services for many domains. This document describes an extension to the XMPP authentication process that allows domains to be securely delegated, simplifying authorization in delegation scenarios." />
  <meta name="description" content="The current authentication process in XMPP requires the XMPP server for a domain to present a certificate that contains that domain's name.  This requirement causes several problems in scenarios where XMPP services have been delegated from one domain to another, especially when one domain provides XMPP services for many domains. This document describes an extension to the XMPP authentication process that allows domains to be securely delegated, simplifying authorization in delegation scenarios." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">R.L. Barnes</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">BBN Technologies</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">J. Lindberg</td>
</tr>
<tr>
<td class="left">Expires: September 15, 2011</td>
<td class="right">Google</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">March 14, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Domain Name Assertions<br />
  <span class="filename">draft-ietf-xmpp-dna-01</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>The current authentication process in XMPP requires the XMPP server for a domain to present a certificate that contains that domain's name.  This requirement causes several problems in scenarios where XMPP services have been delegated from one domain to another, especially when one domain provides XMPP services for many domains. This document describes an extension to the XMPP authentication process that allows domains to be securely delegated, simplifying authorization in delegation scenarios.</p>
<h1><a>Requirements Language</a></h1>
<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">RFC 2119</a> <cite title="NONE">[RFC2119]</cite>.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on September 15, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Terminology</a>
</li>
<li>3.   <a href="#rfc.section.3">Protocol Overview</a>
</li>
<li>4.   <a href="#rfc.section.4">Connection Model</a>
</li>
<li>5.   <a href="#rfc.section.5">Channel Establishment and Authentication</a>
</li>
<li>6.   <a href="#rfc.section.6">Authorizing XMPP Stanzas</a>
</li>
<li>7.   <a href="#rfc.section.7">Backward Compatibility</a>
</li>
<li>8.   <a href="#rfc.section.8">Operational Considerations</a>
</li>
<li>9.   <a href="#rfc.section.9">IANA Considerations</a>
</li>
<li>10.   <a href="#rfc.section.10">Security Considerations</a>
</li>
<li>11.   <a href="#rfc.section.11">Acknowledgements</a>
</li>
<li>12.   <a href="#rfc.references">References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">When connecting two XMPP services to provide inter-domain communication, it is important for a service to be able to determine the identity of a peer service to prevent traffic spoofing. The Jabber communities first approach to identity verification was the Server Dialback protocol. When the Jabber protocols were formalized by the XMPP working group of the IETF 2002-04, support for strong identity verification using TLS + SASL was added.</p>
<p id="rfc.section.1.p.2">Server Dialback <a href="#XEP-0220">[XEP-0220]</a> provides weak identity verification and makes it more difficult to spoof hostnames of servers XMPP network. However, it does not provide authentication between servers and is not a security mechanism. It is susceptible to DNS poisoning attacks (unless DNSSEC is used) and cannot protect against attackers capable of hijacking the IP address of a remote service.</p>
<p id="rfc.section.1.p.3">TLS + SASL provides strong identity verification but requires a obtaining a digital certificate by a trusted CA (or the XMPP Intermediate Certification Authority) and using it in the XMPP service, which may be hosted by a 3rd party. This solution does not allow for multiplexing traffic for multiple domain pairs over a connection, possibly requiring a large number of connections between two hosting providers.</p>
<p id="rfc.section.1.p.4">Server Dialback can be used with TLS. When STARTTLS negotiation succeeds with a peer service but the peer's certificate cannot be used to establish the peer's identity, the remote domain may use on Server Dialback for (weak) identity verification. One use case can be an originating server that wish to use TLS for encryption, but only can present a self signed certificate.</p>
<p id="rfc.section.1.p.5">In practice, many XMPP server deployments rely on Server Dialback and either do not support XMPP 1.0 or do not offer negotiation of TLS + SASL.</p>
<p id="rfc.section.1.p.6">This goal of this document is to describe secure authentication using a hosting provide TLS certificate from a trusted CA, combined with a dialback mechanism providing secure delegation based on DNS record delgation verified using DNSSEC.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Terminology</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119 <a href="#RFC2119">[RFC2119]</a>.</p>
<p id="rfc.section.2.p.2">We will refer to four different types of domains in this document:</p>

<ul>
<li>Sender domain: The domain that initially sends out an XMPP message</li>
<li>Target domain: The ultimate destination of an XMPP message</li>
<li>Originating domain: The originating domain of a particular server-to-server connection</li>
<li>Receiving domain: The receiving domain of a particular server-to-server connection</li>
</ul>
<p id="rfc.section.2.p.3">In outsourcing scenarios, the sending and receiving domains are outsourced to the originating and receiving domains, respectively.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Protocol Overview</h1>
<p id="rfc.section.3.p.1">Consider a scenario in which the domain sender.tld has outsourced XMPP services to originating.tld, and target.tld has outsourced to receiving.tld. The particular hosts providing services are xmpp1.originating.tld and xmpp1.receiving.tld. Users romeo@sender.tld and juliet@target.tld maintain client-to-server connections to these servers.</p>
<div id="#rfc.figure.1"></div>
<pre>romeo@sender.tld -- xmpp1.originating.tld 
                            . 
                            .
                    xmpp1.receiving.tld -- juliet@target.tld</pre>
<p id="rfc.section.3.p.2">When Romeo wants to send a message to Juliet, Provider A's server will have to establish a server-to-server connection to Provider B's server. Since they are both acting on behalf of other domains, however, each side will have to verify that the other is authorized to act in that role.</p>
<p id="rfc.section.3.p.3">The first step is to provision records that can be used to verify these delegations. In order for XMPP to work, when the hosting relationships are set up, sender.tld and target.tld have to provision SRV records pointing to their providers' servers. To make this delegation secure, they sign these records using DNSSEC <a href="#RFC4033">[RFC4033]</a>. On the XMPP servers themselves, the originating and receiving domains provision certificates that can be used to authenticate the names xmpp1.originating.tld and xmpp1.receiving.tld.</p>
<p id="rfc.section.3.p.4">When Romeo wants to send a stanza to Juliet, he will first send it to his server, xmpp1.originating.tld. Seeing that the 'to' domain of the stanza is target.tld, the server will retrieve the SRV records for _xmpp-server._tcp.target.tld, plus any associated DNSSEC records <a href="#RFC4034">[RFC4034]</a>.</p>
<div id="#rfc.figure.2"></div>
<pre>_xmpp-server._tcp.target.tld. 400 IN SRV 
            20 0 5269 xmpp1.receiving.tld

_xmpp-server._tcp.target.tld. 400 IN RRSIG 
            SRV 5 3 400 20030322173103 (
              20030220173103 2642 _tcp.target.tld.
              oJB1W6WNGv+ldvQ3WDG0MQkg5IEhjRip8WTr
              PYGv07h108dUKGMeDPKijVCHX3DDKdfb+v6o
              B9wfuh3DTJXUAfI/M0zmO/zz8bW0Rznl8O3t
              GNazPwQKkRN20XPXV6nwwfoXmJQbsLNrLfkG
              J5D6fwFm8nN+6pBzeDQfsS3Ap3o= )

</pre>
<p id="rfc.section.3.p.5">If there are no DNSSEC records, or if the DNSSEC records do not validate, then there is nothing new to do; the server simply connects to the remote domain using normal XMPP procedures. If there is a valid DNSSEC signature on the SRV record, then the server knows that he can allow the remote server to authenticate as either target.tld or xmpp1.receiving.tld.</p>
<p id="rfc.section.3.p.6">Once the TLS connection is established, the two sides negotiate a single bidirectional stream to run over it, using their own names:</p>
<div id="#rfc.figure.3"></div>
<pre>I: &lt;?xml version='1.0'?&gt;
   &lt;stream:stream
       from='xmpp1.originating.tld'
       to='xmpp1.receiving.tld'
       version='1.0'
       xml:lang='en'
       xmlns='jabber:server'
       xmlns:stream='http://etherx.jabber.org/streams'&gt;

R: &lt;?xml version='1.0'?&gt;
   &lt;stream:stream
       from='xmpp1.receiving.tld'
       id='++TR84Sm6A3hnt3Q065SnAbbk3Y='
       to='xmpp1.originating.tld'
       version='1.0'
       xml:lang='en'
       xmlns='jabber:server'
       xmlns:stream='http://etherx.jabber.org/streams'&gt;

R: &lt;stream:features&gt;
     &lt;starttls xmlns='urn:ietf:params:xml:ns:xmpp-tls'/&gt;
     &lt;bidi xmlns='urn:xmpp:bidi'/&gt;
   &lt;/stream:features&gt;</pre>
<p id="rfc.section.3.p.7">When this stream is created, it can immediately carry stanzas directly between the two servers. In order to send messages to and from other domains, the servers have to authenticate and request permission.  So to send Romeo's stanza to Juliet, xmpp1.originating.tld requests permission to send from sender.tld to target.tld.</p>
<p id="rfc.section.3.p.8">The originating server uses STARTTLS to set up a TLS connection. In the ClientHello message initiating the connection, the xmpp1.originating.tld includes a Server Name Indication extension set to xmpp1.receiving.tld <a href="#RFC4366">[RFC4366]</a>. The remote server xmpp1.receiving.tld responds to this request with a certificate for its own name, xmpp1.receiving.tld and requests a client certificate from the originating server. The originating server presents a certificate for its own name, xmpp1.originating.tld.</p>
<p id="rfc.section.3.p.9">At this point, the server xmpp1.originating.tld knows that xmpp1.receiving.tld is authorized to represent either xmpp1.receiving.tld (via the certificate) or target.tld (via DNSSEC).  The other server, xmpp1.receiving.tld knows only that the other server repressents xmpp1.originating.tld.</p>
<p id="rfc.section.3.p.10">Once the two servers have authenticated their own names over TLS, they can request permission to send stanzas:</p>
<div id="#rfc.figure.4"></div>
<pre>I: &lt;db:result from='sender.tld' to='target.tld' /&gt;</pre>
<p id="rfc.section.3.p.11">Since xmpp1.receiving.tld doesn't yet know whether xmpp1.originating.tld is authorized to represent sender.tld, it has to check, using an abbreviated form of dialback. Just as the Provider A server did earlier for target.tld, the Provider B server looks up the SRV records for _xmpp-server._tcp.sender.tld and any associated DNSSEC records. If there are no DNSSEC records or the signature is not valid, then the server rejects the request to send stanzas from that domain. If the record is DNSSEC-signed, then the server checks that the server name in the SRV record is one of the names authenticated for the remote side.</p>
<div id="#rfc.figure.5"></div>
<pre>R: &lt;db:result type='invalid' from='sender.tld' to='target.tld' /&gt;</pre>
<p id="rfc.section.3.p.12">On the other hand, if the DNSSEC signature is valid, then the server can accept the request to send stanzas, and the two servers can exchange stanzas for those domains.</p>
<div id="#rfc.figure.6"></div>
<pre>R: &lt;db:result type='valid' from'sender.tld' to='target.tld' /&gt;

I: &lt;!-- stanza --&gt;

</pre>
<p id="rfc.section.3.p.13">Now that the two servers have established this connection, they can re-used it for other stanzas and other domains. If either server finds another domain that is delegated to the other server, it can send a &lt;db:result&gt; requesting permission to send stanzas for that domain, and the other server will grant or deny permission after checking the delegation.</p>
<p id="rfc.section.3.p.14">The following figure summarizes the overal process:</p>
<div id="#rfc.figure.7"></div>
<pre>Originating                   DNS                     Receiving
  Server                    Server                     Server
-----------               ---------                   --------
    |                          |                          |
    |  Lookup _xmpp-server     |                          |
    |  DNS SRV record for      |                          |
    |  target.tld to find      |                          |
    |  delegation of service   |                          |
    |  to Receiving Server.    |                          |
    |  Verify zone signature   |                          |
    | -----------------------&gt; |                          |
    |                          |                          |
    |  'Receiving Server'      |                          |
    | &lt;----------------------- |                          |
    |                          |                          |
    |                                                     |
    |                                                     |
    |  &lt;stream from='originating.tld' to='receiving.tld'&gt; |
    | --------------------------------------------------&gt; |
    |                                                     |
    |  &lt;stream from='receiving.tld' to='originating.tld'&gt; |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |  &lt;features&gt;&lt;starttls&gt;&lt;/features&gt;                    |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |  &lt;starttls/&gt;                                        |
    | --------------------------------------------------&gt; |
    |                                                     |
    |  &lt;proceed/&gt;                                         |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |                                                     |
    | &lt;====================== TLS ======================&gt; |
    |                                                     |
    |                                                     |
    |  &lt;stream from='originating.tld' to='receiving.tld'&gt; |
    | --------------------------------------------------&gt; |
    |                                                     |
    |  &lt;stream from='receiving.tld' to='originating.tld'&gt; |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |  &lt;features&gt;&lt;bidi&gt;&lt;/features&gt;                        |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |  &lt;db:result from='sender.tld' to='target.tld'/&gt;     |
    | --------------------------------------------------&gt; |
    |                                                     |
    | ...                                                 |</pre>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#chan-mod" id="chan-mod">Connection Model</a>
</h1>
<p id="rfc.section.4.p.1">The core challenge for managing inter-server connections is the multiplexing of stanzas for multiple domains onto a single transport-layer connection. There are two key pieces of state associated with this multiplexing: A list of domain names that have been authenticated for use on a connection, and a table binding pairs of domains that are authorized for a connection.</p>
<p id="rfc.section.4.p.2">First table that a server maintains is a connection table. Each entry in this table contains a connection and a set of domain names. The domain names represent the set of names for which the remote server has been authenticated, according to the procedures described in Section <a href="#chan-est">Section 5</a>. This set of domain names constrains the set of domain pairs that can be bound to this channel; the remote server cannot ask to transmit stanzas for an unauthenticated domain name.</p>
<div id="#rfc.figure.8"></div>
<pre>
+------------+---------------------+------------------------+
| Connection | Server Domain Names | Delegated Domain Names |
+------------+---------------------+------------------------+
| XXX        | xmpp1.provider.com  | capulet.example        |
| YYY        | xmpp2.provider.com  | capulet.example        |
| AAA        | paris.example       | paris.example          |
+------------+---------------------+------------------------+

</pre>
<p id="rfc.section.4.p.3">To determine how to handle incoming and outgoing stanzas, each server maintains a channel binding table. Each row in the binding table contains a "local" domain name, a "remote" domain name, and an ordered list of connections. The identifier for a connection is the stream ID for the single XMPP stream that it carries.</p>
<div id="#rfc.figure.9"></div>
<pre>
+------------------+-----------------+---------------+
| Local            | Remote          | Connections   |
+------------------+-----------------+---------------+
| montague.example | capulet.example | XXX, YYY      |
| laurence.example | capulet.example | AAA           |
| laurence.example | paris.example   | YYY, AAA      |
+------------------+-----------------+---------------+

</pre>
<p id="rfc.section.4.p.4">The binding table acts as a routing table for outgoing stanzas and a filter for incoming stanzas. When the server wishes to send a stanza, it looks in the binding table for a row that has the 'from' domain as the local domain and the 'to' domain as the remote domain. If there is such a in the binding table, then the server MUST transmit the on the first connection in the connection list. Thus, in the above example, a stanza from montague.example to capulet.example would be routed on channel XXX.</p>
<p id="rfc.section.4.p.5">In the same way, when a server receives a stanza over a connection from a remote server, it looks up the relevant entry in the binding table, this time using the 'to' domain as the local domain and the 'from' domain as the remote domain. If the server finds a binding table entry and the connection over which the stanza arrived is listed in the entry, then it accepts the stanza. Otherwise, it MUST discard the stanza and return a stanza error &lt;invalid-connection/&gt;. In the above example, a stanza from capulet.example to escalus.example would be accepted on connections AAA and BBB, but no others.</p>
<p id="rfc.section.4.p.6">When a connection is opened (and at some points thereafter), entries in the name table are established using the processes in Section <a href="#chan-est">Section 5</a>. Once a connection is open, binding table entries are added or removed using the processes in Section <a href="#chan-use">Section 6</a>. When a connection is closed, both servers MUST delete its entry in the name table and remove it from all entries in the binding table.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#chan-est" id="chan-est">Channel Establishment and Authentication</a>
</h1>
<p id="rfc.section.5.p.1">When a server wants to send a stanza and doesn't have an entry in the connection table for the destination domain, it sets one up. The first step is to establish a connection to a server for the destination domain, and validate that the server is authorized to represent the destination domain.</p>
<p id="rfc.section.5.p.2">The originating server MUST take the following steps to establish a secure connection to the server for example.com:</p>

<ol>
<li>Retrieve SRV records for XMPP services for example.com <a href="#I-D.ietf-xmpp-3920bis">[I-D.ietf-xmpp-3920bis]</a>.</li>
<li>Verify that the SRV records have been signed using DNSSEC <a href="#RFC4033">[RFC4033]</a>. The originating server may either retrieve DNSSEC records directly or rely on a validating resolver. If the SRV records are not secured with DNSSEC, then the connection fails.</li>
<li>If there is already a connection in the connection table that has the target of any SRV record in its "server names" list, then this process terminates and the server attempts to use that connection (See Section <a href="#chan-use">Section 6</a>)</li>
<li>If there is no existing connection that matches, establish a TCP connection to any of the servers listed in an SRV record and negotiate an XMPP stream with the following parameters:<ul>
<li>'from' domain: The originating server's name</li>
<li>'to' domain: The receiving server's name from the SRV record</li>
<li>[[ TODO: Add a stream feature to indicate support for this extension ]]</li>
</ul>
</li>
<li>Upgrade the connection to TLS using STARTTLS, using a cipher suite that requires the server to present an X.509 certificate.</li>
<li>Verify that the certificate is valid and chains to a local trust anchor. If the certificate is invalid, the connection fails.</li>
<li>Construct a list of all names that the certificate presents <a href="#I-D.saintandre-tls-server-id-check">[I-D.saintandre-tls-server-id-check]</a>.</li>
<li>Verify that the target name in the SRV record is one of the names in the certificate. If the target name is not found in the list of names from the certificate, then the connection fails.</li>
</ol>
<p id="rfc.section.5.p.3">A server receiving such a connection MUST perform the following steps:</p>

<ol>
<li>Accept the TCP connection from the remote side and accept the stream negotiation using server names.</li>
<li>In the TLS negotiation, require a client certificate from the remote side.</li>
<li>Verify that the remote server name in the stream matches the client certificate <a href="#I-D.saintandre-tls-server-id-check">[I-D.saintandre-tls-server-id-check]</a>. If the certificate does not match, the TLS negotiation fails, and the server MAY terminate the TCP connection.</li>
</ol>
<p id="rfc.section.5.p.4">If this process establishes a new connection, then the originating server knows that it has established a connection to a server that legitimately represents example.com. It should thus initialize a row in the connection table for this connection:</p>

<ul>
<li>Server names: The list of names in the server's certificate</li>
<li>Delegated names: example.com</li>
</ul>
<p id="rfc.section.5.p.5">If the process terminated at Step 3, then the server simply updates the connection table entry to add example.com to the list of delegated names. In either case, the row for a connection is removed from the connection table when the connection is closed.</p>
<p id="rfc.section.5.p.6">In order for this process to work, the domain owner and the hosting provider need to publish information that other XMPP entities can use to verify the delegation. XMPP services are delegated via SRV records (see Section 3.2.1 of <a href="#I-D.ietf-xmpp-3920bis">[I-D.ietf-xmpp-3920bis]</a>), so in order for the delegation to be secure, the domain owner MUST sign these records with DNSSEC. In other words, if the delegated domain is example.com, then the zone _xmpp-server._tcp.example.com MUST be signed.  Each server that acts for a domain MUST be provisioned with a certificate that contains the target name used by SRV records.</p>
<p id="rfc.section.5.p.7">The server on the receiving end of the TLS connection MUST request a client certificate from the originating server during the TLS handshake, and the originating server MUST provide a client certificate. The receiving server can then also initialize an entry in its connection table to which delegated names can be added later:</p>

<ul>
<li>Server names: The list of names from the client certificate (from the originating server), if present. Otherwise, empty.</li>
<li>Delgated names: Empty.</li>
</ul>
<p id="rfc.section.5.p.8">Once the two servers have established a TLS connection, they MUST set up an XMPP stream that will be used for domains that they represent.  This process follows the normal stream initiation procedure <a href="#I-D.ietf-xmpp-3920bis">[I-D.ietf-xmpp-3920bis]</a>, except that the 'to' and 'from' domains MUST be set to the names of the servers themselves: The originating server sends a &lt;stream&gt; stanza with the 'from' domain set to a name for itself that is contained in its client certificate, and the 'to' domain set to the server name used in the SRV record for this connection. If stream negotiation fails, then the connection fails.  If it succeeds, then both sides MUST set the connection identifier in the connection table to be the stream ID for the negotiated stream.</p>
<p id="rfc.section.5.p.9">Since server-to-server connections are by default directional, it is RECOMMENDED that servers also request the &lt;bidi&gt; stream feature to enable bidirectional flows on this connection <a href="#XEP-0288">[XEP-0288]</a>.</p>
<div id="#rfc.figure.10"></div>
<pre>Originating                   DNS                     Receiving
  Server                    Server                     Server
-----------               ---------                   --------
    |                          |                          |
    |  Lookup _xmpp-server     |                          |
    |  DNS SRV record for      |                          |
    |  target.tld to find      |                          |
    |  delegation of service   |                          |
    |  to Receiving Server.    |                          |
    |  Verify zone signature   |                          |
    | -----------------------&gt; |                          |
    |                          |                          |
    |  'Receiving Server'      |                          |
    | &lt;----------------------- |                          |
    |                          |                          |
    |                                                     |
    |                                                     |
    |  &lt;stream from='originating.tld' to='receiving.tld'&gt; |
    | --------------------------------------------------&gt; |
    |                                                     |
    |  &lt;stream from='receiving.tld' to='originating.tld'&gt; |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |  &lt;features&gt;&lt;starttls&gt;&lt;/features&gt;                    |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |  &lt;starttls/&gt;                                        |
    | --------------------------------------------------&gt; |
    |                                                     |
    |  &lt;proceed/&gt;                                         |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |                                                     |
    | &lt;====================== TLS ======================&gt; |
    |                                                     |
    |                                                     |
    |  &lt;stream from='originating.tld' to='receiving.tld'&gt; |
    | --------------------------------------------------&gt; |
    |                                                     |
    |  &lt;stream from='receiving.tld' to='originating.tld'&gt; |
    | &lt;-------------------------------------------------- |
    |                                                     |
    |  &lt;features&gt;&lt;bidi&gt;&lt;/features&gt;                        |
    | &lt;-------------------------------------------------- |</pre>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#chan-use" id="chan-use">Authorizing XMPP Stanzas</a>
</h1>
<p id="rfc.section.6.p.1">Before sending traffic from a Sender Domain to a Target Domain using an established connection, the originating server MUST request permission to do so, and wait until it has received authorization from the remote service. A service receiving traffic MUST verify that the Sender and Target domain pair has been authorized on the connection being used.</p>
<p id="rfc.section.6.p.2">An originating server MUST go through the following steps to reqeust authorization to send traffic from a Sender Domain to a Target Domain:</p>
<p></p>

<ol>
<li>Send a &lt;db:result/&gt; <a href="#XEP-0220">[XEP-0220]</a> element with Sender Domain as 'from' and Target Domain as 'to'. The server may also include a Dialback Key as part of the element's character data, to support legacy deployments.</li>
<li>Wait for remote service to respond with a &lt;db:result&gt; with Target Domain as 'from', Sender Domain as 'to' and 'type' attribute that is either 'valid' or 'invalid'. In case of 'invalid', the originating server SHOULD examine the error cause and take appropriate action and MAY retry requesting authorization on the same connection in the future.</li>
<li>If response 'type' was 'valid', the originating server updates its binding table to indicate that Sender Domain (Local) and Target Domain (Remote) is authorized in the sending direction for the connection used.</li>
<li>Originating server proceeds with sending traffic from Sender Domain to Target Domain.</li>
</ol>
<p id="rfc.section.6.p.4">Upon receiving a &lt;db:result/&gt; stanza, the receiving server MUST take following steps:</p>
<p></p>

<ol>
<li>Verify that the receiving direction is supported for this connection. If not, fail by disconnecting the stream. (By default, connections are one-way)</li>
<li>Verify that domain in to-attribute is hosted by the service. If not, fail and respond with an &lt;item-not-found/&gt; error.</li>
<li>Verify that domain in from-attribute delegates hosting of their XMPP to the remote Server Domain Name by looking up SRV and verifying that the zone is signed. If not, fail with a &lt;not-authorized/&gt; error. Note: a service MAY accept a less secure delegation mechanism such a SRV records in a non signed zone, subject to local policy.</li>
<li>Once secure delegation from Sending Domain to remote Server Domain name has been verified, service adds Sending Domain to list of Delegated Domain Names in the Connection Table, and updates the Binding Table indicating that the Sending Domain (remote) is allowed to send traffic to Target Domain (local) on the connection.</li>
<li>Respond to remote service with a &lt;db:result/&gt; stanza with 'type' set to 'valid'.</li>
</ol>
<p id="rfc.section.6.p.6">A service may revoke authorization for a domain pair at any time by sending a &lt;db:result&gt; with 'type' set to invalid. Once authorization has been revoked, the remote side MUST re-aquire authorization before sending any futher traffic for the domain pair.</p>
<p id="rfc.section.6.p.7">If a server receives a stanza for a to/from pair that it does not consider authorized, then it MUST return a &lt;not-authorized/&gt; error and MAY terminate the TCP connection.</p>
<div id="#rfc.figure.11"></div>
<pre>Originating               Receiving                     DNS
  Server                    Server                     Server
-----------               ---------                   --------
    |                          |                          |
    |  &lt;db:result              |                          |
    |     from='sender.tld'    |                          |
    |     to='target.tld'/&gt;    |                          |
    | -----------------------&gt; |                          |
    |                          |  Lookup _xmpp-server     |
    |                          |  DNS SRV record for      |
    |                          |  sender.tld to verify    |
    |                          |  signed delegation of    |
    |                          |  delegation of service   |
    |                          |  to Originating Server   |
    |                          | -----------------------&gt; |
    |                          |                          |
    |                          |  Result                  |
    |                          | &lt;----------------------- |
    |                          |
    |  &lt;db:result              |
    |    from='target.tld'     |
    |    to='sender.tld'       |
    |    type='valid'/&gt;        |
    | &lt;----------------------- |
    |                          |
    |  (Traffic authorized     |
    |   from sender.tld to     |
    |   target.tld, in one     |
    |   direction.)            |
    |                          |
    |  &lt;message                |
    |    from='r@sender.tld'   |
    |    to='j@target.tld'&gt;    |
    |    &lt;body&gt;hi&lt;/body&gt;       |
    |  &lt;/message&gt;              |
    | -----------------------&gt; |
    </pre>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> Backward Compatibility</h1>
<p id="rfc.section.7.p.1">Using Server Domain Names as to/from attributes in &lt;stream&gt; stanzas is incompatible with XMPP services that do not support this protocol, because it was previously assumed that when receiving a connection the stream to attibute will contains an XMPP domain hosted by the receiving service. It is RECOMMENDED that if the connection fails, the service tries again using the Remote Domain as stream to-attribute.</p>
<p id="rfc.section.7.p.2">Presenting a certificate for the Server Domain Name is incompatible with XMPP services that do not support this protocol, because those will expect the Remote Domain in the certificate. It is RECOMMENDED that if the authorization fails, the service tries again presenting the certificate for the Remote Domain. A service may also choose to fall back on a weaker identification mechanism such as Server Dialback, subject to local policy.</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Operational Considerations</h1>
<p id="rfc.section.8.p.1">[[ What names to put in certs for servers in a cluster, i.e., all of them. ]]</p>
<p id="rfc.section.8.p.2">[[ Do TLS clients support multiple names in certs? ]]</p>
<p id="rfc.section.8.p.3">[[ How DNSSEC validation is done can vary depending on deployment scenario. ]]</p>
<p id="rfc.section.8.p.4">[[ Since SNI is used to signal support for this extension, recommended not to serve end users on the same domain as hosting services. ]]</p>
<p id="rfc.section.8.p.5">[[ Load balancing thoughts, since each connection will handle a lot more traffic? ]]</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#IANA" id="IANA">IANA Considerations</a>
</h1>
<p id="rfc.section.9.p.1">[[ Register XML schema for assertions, if necessary ]]</p>
<p id="rfc.section.9.p.2">[[ Define invalid-connection error element ]]</p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> <a href="#Security" id="Security">Security Considerations</a>
</h1>
<p id="rfc.section.10.p.1">[[ This document simplifies authentication and authorization of XMPP servers in certain scenarios. When used together with DNSSEC-protected delegations, it does not introduce any new security risks. ]]</p>
<p id="rfc.section.10.p.2">[[ If a provider chooses to omit DNSSEC checks or ]]</p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> <a href="#Acknowledgements" id="Acknowledgements">Acknowledgements</a>
</h1>
<p id="rfc.section.11.p.1">Thanks to Joe Hildebrand and Sean Turner for prompting the original work on this problem, and to Stephen Farrell for his work on initial versions of this draft.</p>
<h1 id="rfc.references">
<a href="#rfc.references">12.</a> References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4033">[RFC4033]</b></td>
<td class="top">
<a>Arends, R.</a>, <a>Austein, R.</a>, <a>Larson, M.</a>, <a>Massey, D.</a> and <a>S. Rose</a>, "<a href="http://tools.ietf.org/html/rfc4033">DNS Security Introduction and Requirements</a>", RFC 4033, March 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4034">[RFC4034]</b></td>
<td class="top">
<a>Arends, R.</a>, <a>Austein, R.</a>, <a>Larson, M.</a>, <a>Massey, D.</a> and <a>S. Rose</a>, "<a href="http://tools.ietf.org/html/rfc4034">Resource Records for the DNS Security Extensions</a>", RFC 4034, March 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4366">[RFC4366]</b></td>
<td class="top">
<a>Blake-Wilson, S.</a>, <a>Nystrom, M.</a>, <a>Hopwood, D.</a>, <a>Mikkelsen, J.</a> and <a>T. Wright</a>, "<a href="http://tools.ietf.org/html/rfc4366">Transport Layer Security (TLS) Extensions</a>", RFC 4366, April 2006.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-xmpp-3920bis">[I-D.ietf-xmpp-3920bis]</b></td>
<td class="top">
<a>Saint-Andre, P</a>, "<a href="http://tools.ietf.org/html/draft-ietf-xmpp-3920bis-22">Extensible Messaging and Presence Protocol (XMPP): Core</a>", Internet-Draft draft-ietf-xmpp-3920bis-22, December 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.saintandre-tls-server-id-check">[I-D.saintandre-tls-server-id-check]</b></td>
<td class="top">
<a>Saint-Andre, P</a> and <a>J Hodges</a>, "<a href="http://tools.ietf.org/html/draft-saintandre-tls-server-id-check-14">Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)</a>", Internet-Draft draft-saintandre-tls-server-id-check-14, January 2011.</td>
</tr>
<tr>
<td class="reference"><b id="XEP-0288">[XEP-0288]</b></td>
<td class="top">
<a>Hancke, P.</a> and <a>D. Cridland</a>, "<a>Bidirectional Server-to-Server Connections</a>", XSF XEP 0288, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="XEP-0220">[XEP-0220]</b></td>
<td class="top">
<a>Miller, J.</a>, <a>Saint-Andre, P.</a> and <a>P. Hancke</a>, "<a>Server Dialback</a>", XSF XEP 0220, March 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Richard L. Barnes</span> 
	  <span class="n hidden">
		<span class="family-name">Barnes</span>
	  </span>
	</span>
	<span class="org vcardline">BBN Technologies</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:rbarnes@bbn.com">rbarnes@bbn.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Jonas Lindberg</span> 
	  <span class="n hidden">
		<span class="family-name">Lindberg</span>
	  </span>
	</span>
	<span class="org vcardline">Google</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:jonasl@google.com">jonasl@google.com</a></span>

  </address>
</div>

</body>
</html>