<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Discovering, Querying, and Controlling
    Firewalls and NATs using STUN</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Discovering, Querying, and Controlling
    Firewalls and NATs using STUN">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">BEHAVE</td><td class="header">D. Wing</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">J. Rosenberg</td></tr>
<tr><td class="header">Intended status:  Standards Track</td><td class="header">Cisco Systems</td></tr>
<tr><td class="header">Expires:  April 12, 2008</td><td class="header">H. Tschofenig</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Nokia Siemens Networks</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">October 10, 2007</td></tr>
</table></td></tr></table>
<h1><br />Discovering, Querying, and Controlling
    Firewalls and NATs using STUN<br />draft-wing-behave-nat-control-stun-usage-04</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on April 12, 2008.</p>

<h3>Abstract</h3>

<p>Simple Traversal Underneath NAT (STUN) is a mechanism for traversing
      NATs. STUN requests are transmitted through a NAT to external STUN
      servers. While this works very well, its two primary drawbacks are the
      inability to modify the properties of a NAT binding and the need to
      query a public STUN server for every new NAT binding (e.g., every phone
      call). These drawbacks require frequent keepalive messages, which
      contribute negatively to server and network load.
</p>
<p>This document describes two mechanisms to discover NATs and firewalls
      and a mechanism to query and control them. With these mechanisms,
      binding discovery and keepalive traffic can be reduced to involve only
      the necessary NATs or firewalls. This eliminates the keepalive traffic
      to servers, and vastly reduces keepalive traffic across the network. At
      the same time, backwards compatibility with NATs and firewalls that do
      not support this specification is retained, which allows for incremental
      deployment of these mechanisms.
</p>
<p>This document is discussed on the SAFE mailing list,
      &lt;http://www1.ietf.org/mailman/listinfo/safe&gt;.
</p>
<h3>Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#benefits">2.</a>&nbsp;
Motivation and Benefits<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">2.1.</a>&nbsp;
Comparison with other NAT Traversal Techniques<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">2.1.1.</a>&nbsp;
Simple Security Model<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">2.1.2.</a>&nbsp;
Incremental Deployment<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">2.2.</a>&nbsp;
Optimize STUN keepalive messages<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">2.3.</a>&nbsp;
Optimize ICE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">2.3.1.</a>&nbsp;
Candidate Gathering<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">2.3.2.</a>&nbsp;
Learning STUN Servers without Configuration<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">2.3.3.</a>&nbsp;
Media Keepalive<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">2.4.</a>&nbsp;
Reduce IPsec keepalive messages<br />
<a href="#overview">3.</a>&nbsp;
Overview of Operation<br />
<a href="#discovery">4.</a>&nbsp;
Discovery of Middleboxes (NATs and Firewalls)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#outside-in">4.1.</a>&nbsp;
Outside-In<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#walking_backwards">4.1.1.</a>&nbsp;
Nested NATs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#tagging">4.2.</a>&nbsp;
Tagging<br />
<a href="#query_and_control">5.</a>&nbsp;
Query and Control <br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#client_procedures">5.1.</a>&nbsp;
Client Procedures<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#server_procedures">5.2.</a>&nbsp;
Server Procedures<br />
<a href="#anchor11">6.</a>&nbsp;
New Attributes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#refresh-interval">6.1.</a>&nbsp;
REFRESH-INTERVAL Attribute<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">6.2.</a>&nbsp;
XOR-INTERNAL-ADDRESS Attribute<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">6.3.</a>&nbsp;
PLEASE-TAG Attribute<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">6.4.</a>&nbsp;
TAG Attribute<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#bootnonce">6.5.</a>&nbsp;
BOOTNONCE Attribute<br />
<a href="#anchor15">7.</a>&nbsp;
Limitations of STUN Control<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">7.1.</a>&nbsp;
Overlapping IP Addresses with Nested NATs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">7.2.</a>&nbsp;
Address Dependent NAT on Path<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">7.3.</a>&nbsp;
Address Dependent Filtering<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#legacy-nats">7.4.</a>&nbsp;
Interacting with Legacy NATs<br />
<a href="#security_considerations">8.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#authorization">8.1.</a>&nbsp;
Authorization<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#exhaustion">8.2.</a>&nbsp;
Resource Exhaustion<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">8.3.</a>&nbsp;
Comparison to Other NAT Control Techniques<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rogue_stun_server">8.4.</a>&nbsp;
BOOTNONCE Attribute<br />
<a href="#anchor20">9.</a>&nbsp;
Open Issues and Discussion Points<br />
<a href="#anchor21">10.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor22">11.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">12.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">12.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">12.2.</a>&nbsp;
Informational References<br />
<a href="#anchor25">Appendix&nbsp;A.</a>&nbsp;
Changes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor26">A.1.</a>&nbsp;
Changes in -04<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor27">A.2.</a>&nbsp;
Changes in -03<br />
<a href="#implementation details">Appendix&nbsp;B.</a>&nbsp;
Implementation Details<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor28">B.1.</a>&nbsp;
Internal NAT Operation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#linux-specifics">B.2.</a>&nbsp;
Linux specifics<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>Two common usages of Simple Traversal Underneath NAT (STUN) (<a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>,<a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a>) are Binding Discovery and NAT Keepalive. The
      Binding Discovery usage allows a STUN client to learn its public IP
      address (from the perspective of the STUN server it contacted) and the
      NAT keepalive usage allows a STUN client to keep an active NAT binding
      alive. Unlike some other techniques (e.g., <a class='info' href='#UPnP'>UPnP<span> (</span><span class='info'>UPnP Forum, &ldquo;Universal Plug and Play,&rdquo; 2000.</span><span>)</span></a> [UPnP], <a class='info' href='#RFC3303'>MIDCOM<span> (</span><span class='info'>Srisuresh, P., Kuthan, J., Rosenberg, J., Molitor, A., and A. Rayhan, &ldquo;Middlebox communication architecture and framework,&rdquo; August&nbsp;2002.</span><span>)</span></a> [RFC3303], <a class='info' href='#I-D.cheshire-nat-pmp'>NAT-PMP<span> (</span><span class='info'>Cheshire, S., &ldquo;NAT Port Mapping Protocol (NAT-PMP),&rdquo; April&nbsp;2008.</span><span>)</span></a> [I&#8209;D.cheshire&#8209;nat&#8209;pmp]), <a class='info' href='#I-D.ietf-nsis-nslp-natfw'>NSIS-NSLP<span> (</span><span class='info'>Stiemerling, M., Tschofenig, H., Aoun, C., and E. Davies, &ldquo;NAT/Firewall NSIS Signaling Layer Protocol (NSLP),&rdquo; April&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;nsis&#8209;nslp&#8209;natfw], STUN does not
      interact directly with the NAT. Thus, STUN cannot request additional
      services from the NAT, such as longer lifetimes which would reduce
      keepalive messages. Furthermore, allocating new NAT bindings (e.g., each
      phone call) requires communication with a STUN server located somewhere
      on the Internet.
</p>
<p>This document describes three mechanisms for the STUN client to
      discover NATs and firewalls that are on path with its STUN server. After
      discovering the NATs and firewalls, the STUN client can query and
      control those devices using STUN. The STUN client needs to only ask
      those STUN servers (embedded in the NATs and firewalls) for public IP
      addresses and UDP ports, thereby offloading that traffic from the STUN
      server on the Internet. Additionally, the STUN client can ask the NAT's
      embedded STUN server to extend the NAT binding for the flow, and the
      STUN client can learn the IP address of the next-outermost NAT. By
      repeating this procedure with the next-outermost NAT, all of the NATs
      along that path can have their bindings extended. By learning all of the
      STUN servers on the path between the public Internet and itself, an
      endpoint can optimize the path of peer-to-peer communications.
</p>
<a name="benefits"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Motivation and Benefits</h3>

<p>There are a number of problems with existing NAT traversal
      techniques, such as STUN, UPnP, MIDCOM, NAT-PMP, and NSIS-NSLP:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>nested NATs:</dt>
<dd>Today, many ISPs
          provide their subscribers with modems that have embedded NATs or
          within the ISP's network. These subscribers then install NATs behind
          those devices to provide additional features, such as wireless
          access. In these situations, UPnP and NAT-PMP no longer function, as
          those protocols can only control the first NAT closest to the host.
          STUN continues to function, but is unable to optimize network
          traffic behind those nested NATs (e.g., traffic that stays within
          the same house or within the same apartment building). <br />
<br />
One technique to avoid nested NATs is to disable
          one of the NATs, as recommended by <a class='info' href='#Vista-cert'>[Vista&#8209;cert]<span> (</span><span class='info'>Microsoft, &ldquo;Windows Logo Program Device Requirements,&rdquo; 2006.</span><span>)</span></a>. However, this merely sidesteps the
          problem of nested NATs, as some NATs are installed for a reason
          (e.g., reduce IP address consumption or provide a modicum of
          security). Disabling the NAT is also ineffective if the ISP is
          NATting subscribers within the ISP's network, as ISP NATs do not
          typically support UPnP.<br />
<br />
The technique
          described in this document allows optimization of the traffic behind
          those NATs so that the traffic can traverse the fewest NATs
          possible.
</dd>
<dt>chattiness:</dt>
<dd>To keep NAT
          bindings from timing out and to perform its binding discovery, a
          STUN packets are sent to a server on the Internet. This consumes
          bandwidth across the user's access network, which in some cases is
          bandwidth constrained (e.g., wireless, satellite) and also creates a
          load on the server. STUN's chattiness is often cited as a reason to
          use other NAT traversal techniques such as UPnP or NAT-PMP. <br />
<br />
The technique described in this document provides a
          significant reduction in STUN's chattiness, to the point that the
          only time a STUN client needs to communicate with the STUN server on
          the public Internet is when the STUN client is initialized.
</dd>
<dt>lack of incremental deployment:</dt>
<dd>Many other NAT traversal techniques require the
          endpoint and its NAT to both support the same NAT traversal
          technique or else NAT traversal is not possible at all. Examples
          include NSIS-NSLP, NAT-PMP, UPnP, and MIDCOM.<br />
<br />
The technique described in this document allows
          incremental deployment of local endpoints and NATs that support STUN
          Control. If the local endpoint, or its NATs, does not support the
          STUN Control functionality, then STUN (see <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>), <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>, and <a class='info' href='#I-D.ietf-mmusic-ice'>ICE<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a> [I&#8209;D.ietf&#8209;mmusic&#8209;ice] procedures are used to
          traverse the NATs without the optimizations described in this
          document.
</dd>
</dl></blockquote><p>The protocol described in this document retains the positive
      features of STUN -- incremental deployment and support of nested NATs --
      without introducing drawbacks inherent in other NAT traversal
      techniques. The protocol optimizes the operation of STUN clients when
      those STUN clients are behind a NAT that supports the protocol described
      in this document. STUN clients that are behind a NAT that doesn't
      support the protocol described in this document continue to function as
      they do today, without those optimizations.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
Comparison with other NAT Traversal Techniques</h3>

<p>STUN Control offers the following benefits over other NAT traversal
        and NAT control techniques such as NSIS-NSLP, MIDCOM, NAT-PMP, and
        UPnP.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1.1"></a><h3>2.1.1.&nbsp;
Simple Security Model</h3>

<p>Unlike other middlebox control techniques which have relatively
          complex security models because a separate control channel is used,
          STUN Control's is simple. It is simple because only flows
          originating from the same source IP and UDP port can be controlled
          (i.e., have its NAT timeout queried or extended). Other flows cannot
          be created, queried, or controlled via STUN Control.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1.2"></a><h3>2.1.2.&nbsp;
Incremental Deployment</h3>

<p>STUN Control can be incrementally deployed. If the outer-most NAT
          does not support it, the STUN client behaves as normal -- it merely
          isn't able to optimize its keepalive (see also Section <a class='info' href='#legacy-nats'>Section&nbsp;7.4<span> (</span><span class='info'>Interacting with Legacy NATs</span><span>)</span></a>). If the outer-most NAT does support
          STUN Control, the STUN client can gain some significant
          optimizations as described in the following sections.
</p>
<p>Likewise, there is no change required to applications if NATs are
          deployed which support STUN Control: such applications will be
          unaware of the additional functionality in the NAT, and will not be
          subject to any worse security risks due to the additional
          functionality in the NAT.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Optimize STUN keepalive messages</h3>

<p>The primary value of the protocol and technique described in this
        document is the reduction of STUN's chattiness.
</p>
<p>In <a class='info' href='#I-D.ietf-sip-outbound'>SIP outbound<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a> [I&#8209;D.ietf&#8209;sip&#8209;outbound], the
          SIP proxy is also the STUN server, and a UDP keepalive message is
          sent every 30 seconds to that server. STUN Control as described in
          this document enables two optimizations of SIP-Outbound's keepalive
          mechanism:
</p>
<p></p>
<ol class="text">
<li>all of the on-path NATs can explicitly indicate their
              timeouts, reducing the frequency of keepalive messages.
</li>
<li>STUN keepalive messages need only be sent to the outer-most
              NAT, rather than across the access link to the SIP proxy, which
              vastly reduces the traffic to the SIP proxy, and;
</li>
</ol>

<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
Optimize ICE</h3>

<p>The STUN Control usage provides several opportunities to optimize
          <a class='info' href='#I-D.ietf-mmusic-ice'>ICE<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a> [I&#8209;D.ietf&#8209;mmusic&#8209;ice], as described in this
          section.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3.1"></a><h3>2.3.1.&nbsp;
Candidate Gathering</h3>

<p>During its candidate gathering phase, an ICE endpoint normally
            contacts a STUN server on the Internet. If an ICE endpoint
            discovers that its outer-most NAT runs a STUN server, the ICE
            endpoint can use the outer-most NAT's STUN server rather than
            using the STUN server on the Internet. This saves access bandwidth
            and reduces the reliance on the STUN server on the Internet -- the
            STUN server on the Internet need only be contacted once -- when
            the ICE endpoint first initializes.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3.2"></a><h3>2.3.2.&nbsp;
Learning STUN Servers without Configuration</h3>

<p>ICE allows endpoints to have multiple STUN servers, but it is
            difficult to configure all of the STUN servers in the ICE endpoint
            -- it requires some awareness of network topology. By using the
            'walk backward' technique described in this document, all the
            on-path NATs and their embedded STUN servers can be learned
            without additional configuration. By knowing the STUN servers at
            each address domain, ICE endpoints can optimize the network path
            between two peers.
</p>
<p>
<p>For example, if endpoint-1 is only configured with
                the IP address of the STUN server on the left, endpoint-1 can
                learn about NAT-B and NAT-A. Utilizing the STUN server in
                NAT-A, endpoint-1 and endpoint-2 can optimize their media path
                so they make the optimal path from endpoint-1 to NAT-A to
                endpoint-2:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
             +-------+     +-------+       +-------------+
endpoint-1---| NAT-A +--+--+ NAT-B +-------| STUN Server |
             +-------+  |  +-------+       +-------------+
                        |
                   endpoint-2</pre></div>

<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3.3"></a><h3>2.3.3.&nbsp;
Media Keepalive</h3>

<p>While very minor, STUN Control makes it possible to optimize
            media keepalives. This is useful if a video or audio stream is
            placed on 'hold' or 'mute', but is expected to be resumed in the
            future. ICE uses STUN Indications as its primary media stream
            keepalive mechanism. This document enables two optimizations of
            ICE's keepalive technique:</p>
<ol class="text">
<li>STUN keepalive messages need only be sent to the outer-most
                NAT, rather than across the access link to the remote peer,
                and;
</li>
<li>all of the on-path NATs can explicitly indicate their
                timeouts, which allows reducing the keepalive frequency.
</li>
</ol>

<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.4"></a><h3>2.4.&nbsp;
Reduce IPsec keepalive messages</h3>

<p>STUN Control is also able to reduce keepalive traffic for non-STUN
protocols.  In Section 4 of <a class='info' href='#RFC3948'>[RFC3948]<span> (</span><span class='info'>Huttunen, A., Swander, B., Volpe, V., DiBurro, L., and M. Stenberg, &ldquo;UDP Encapsulation of IPsec ESP Packets,&rdquo; January&nbsp;2005.</span><span>)</span></a>, it is suggested that
IPsec keepalive packets be sent every 20 seconds if an on-path NAT
is detected.  If a host and its NAT were to implement STUN Control,
the host can query and control the NAT's binding lifetime, and thus
reduce the NAT keepalive traffic.  This reduction in keepalive
traffic would slightly reduce the load on its IPsec concentrator.
</p>
<a name="overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Overview of Operation</h3>

<p>This document describes three functions, which are all implemented
      using the STUN protocol:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Discovery of Middleboxes (NATs and Firewalls):</dt>
<dd>This document describes two techniques for finding
          NATs or firewalls (see <a class='info' href='#discovery'>Section&nbsp;4<span> (</span><span class='info'>Discovery of Middleboxes (NATs and Firewalls)</span><span>)</span></a>). These two
          approaches are: <br />
 
<blockquote class="text"><dl>
<dt>Outside-In:</dt>
<dd>Uses STUN to
              find the outer-most NAT and works itself towards the host.
</dd>
<dt>Tagging:</dt>
<dd>Send a STUN
              Request packet to your STUN server, and asks for compliant
              firewalls along the path to indicate their presence by adding an
              IP address to the STUN Response packet.
</dd>
</dl></blockquote>
</dd>
<dt>Querying Discovered Middleboxes:</dt>
<dd>After discovering a NAT or a firewall, it is useful
          to determine characteristics of the NAT binding or the firewall
          pinhole. Two of the most useful things to learn is the duration the
          NAT binding or firewall pinhole will remain open if there is no
          traffic, and the filtering applied to that binding or pinhole. This
          is described in <a class='info' href='#query_and_control'>Section&nbsp;5<span> (</span><span class='info'>Query and Control </span><span>)</span></a>.
</dd>
<dt>Controlling Discovered Middleboxes:</dt>
<dd>A NAT or a firewall might default to a more
          restrictive behavior than desired by an application (e.g.,
          aggressive timeout, filtering). Requesting the NAT or firewall to
          change its default behavior is useful for traffic optimization
          (e.g., reduce keepalive traffic) and network optimization (e.g.,
          adjust filters to eliminate the need for a media relay device <a class='info' href='#I-D.ietf-behave-turn'>[I&#8209;D.ietf&#8209;behave&#8209;turn]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; July&nbsp;2009.</span><span>)</span></a>). A discussion of this
          functionality can be found in <a class='info' href='#query_and_control'>Section&nbsp;5<span> (</span><span class='info'>Query and Control </span><span>)</span></a>.
</dd>
</dl></blockquote>

<a name="discovery"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Discovery of Middleboxes (NATs and Firewalls)</h3>

<p>This document investigates two techniques to discover a NAT and a
      firewall: outside-in and by tagging.
</p>
<p>Ideally, a single technique could be selected as an outcome of the
      standardization process. However, it is possible to combine these two
      techniques.
</p>
<a name="outside-in"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Outside-In</h3>

<p>When a STUN client sends a STUN Request to a STUN server, it
        receives a STUN Response that indicates the IP address and UDP port
        seen by the STUN server. If the IP address and UDP port differs from
        the IP address and UDP port of the socket used to send the request,
        the STUN client knows there is at least one NAT between itself and the
        STUN server. The STUN client also learns the 'public' IP address (and
        port) allocated by the outermost NAT. For example, in the following
        diagram, the STUN client learns the public IP address of its NAT is
        192.0.2.1:
</p><br /><hr class="insert" />
<a name="example_one_nat"></a>

<p>
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>

+--------+             +---------------+
|  STUN  |             |          192.0.2.1             +--------+
| Client +-------------+               +---&lt;Internet&gt;---+  STUN  |
|   10.1.1.2/4193     10.1.1.1         |                | Server |
+--------+             |               |                +--------+
                       |   NAT with    |
                       | Embedded STUN |
                       |    Server     |
                       +---------------+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: One NAT with embedded STUN server&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>After learning the public IP address of its outer-most NAT, the
        STUN client attempts to communicate with the STUN server embedded in
        that outer-most NAT. The STUN client does this by sending a STUN
        Binding Request to the NAT's public IP address. The NAT will return a
        STUN Binding Response message including the XOR-INTERNAL-ADDRESS
        attribute, which will indicate the IP address and UDP port seen on the
        *internal* side of the NAT for that translation (see <a class='info' href='#internal_diagram'>Figure&nbsp;12<span> (</span><span class='info'>Block Diagram of Internal NAT Operation</span><span>)</span></a>). In the example above, the IP
        address and UDP port indicated in XOR-INTERNAL-ADDRESS are the same as
        that used by the STUN client (10.1.1.2/4193), which indicates there
        are no other NATs between the STUN client and that outer-most NAT.
</p><br /><hr class="insert" />
<a name="ladder_diagram"></a>

<p>
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>

  STUN Client                        NAT     STUN Server
      |                               |          |
 1.   |-----Binding Request (UDP)---------------&gt;|
 2.   |&lt;----Binding Response (UDP)---------------|
      |                               |          |
 3.   |--Binding Request (UDP)-------&gt;|          |
 4.   |&lt;-Binding Response (UDP)-------|          |
      |                               |          |
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Communication Flow&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>In the call flow above, steps 1 and 2 correspond to the STUN
        behavior described in <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>1:</dt>
<dd>The STUN client sends a UDP Binding Request to its STUN server
            that is located on the Internet.
</dd>
<dt>2:</dt>
<dd>The STUN server on the Internet responds with a UDP Binding
            Response.
</dd>
</dl></blockquote>

<p>The next steps are the additional steps performed by a STUN client
        that has implemented the STUN Control functionality:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>3:</dt>
<dd>The STUN client sends a UDP Binding Request to the IP address
            learned from the STUN server on the Internet. This will be
            received by the STUN server embedded in the outer-most NAT.
</dd>
<dt>4:</dt>
<dd>The STUN server (embedded in the NAT) responds with a UDP
            Binding Response.
</dd>
</dl></blockquote>

<p>The response obtained in message (4) contains the
        XOR-MAPPED-ADDRESS attribute, which will have the same value as when
        the STUN server on the Internet responded (in step 2). Thereafter, so
        long as the BOOTNONCE value doesn't change, the STUN client can
        perform steps (3) and (4) for any new UDP communication, without
        needing to repeat steps (1) and (2). This meets the desire to reduce
        chattiness. The STUN client also only needs to send keepalives towards
        the outer-most NAT's IP address, as well (reduces chatter for SIP
        outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>).
</p>
<p>The response obtained in message (4) will also contain the
        XOR-INTERNAL-ADDRESS, which allows the STUN client to repeat steps (3)
        and (4) in order to query or control those on-path NATs between itself
        and its STUN server on the Internet. This is described in detail in
        <a class='info' href='#walking_backwards'>Section&nbsp;4.1.1<span> (</span><span class='info'>Nested NATs</span><span>)</span></a>. This functionality meets the
        need to optimize traffic between nested NATs, without requiring
        configuration of intermediate STUN servers.
</p>
<p>The STUN client can request each NAT to increase the binding
        lifetime for that source IP address and source UDP port, as described
        in <a class='info' href='#refresh-interval'>Section&nbsp;6.1<span> (</span><span class='info'>REFRESH-INTERVAL Attribute</span><span>)</span></a>. The STUN client receives
        positive confirmation that the binding lifetime has been extended,
        allowing the STUN client to significantly reduces its NAT keepalive
        traffic. Additionally, as long as the NAT complies with <a class='info' href='#RFC4787'>[RFC4787]<span> (</span><span class='info'>Audet, F. and C. Jennings, &ldquo;Network Address Translation (NAT) Behavioral Requirements for Unicast UDP,&rdquo; January&nbsp;2007.</span><span>)</span></a> (which is indicated by its support of this
        document), the STUN client's keepalive traffic need only be sent to
        the outer-most NAT's IP address. This functionality meets the need to
        reduce STUN's chattiness.
</p>
<a name="walking_backwards"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1.1"></a><h3>4.1.1.&nbsp;
Nested NATs</h3>

<p>Nested NATs are controlled individually. The nested NATs are
          discovered, from outer-most NAT to the inner-most NAT, using the
          XOR-INTERNAL-ADDRESS attribute.
</p>
<p>The example in <a class='info' href='#example_two_nats'>Figure&nbsp;3<span> (</span><span class='info'>Two nested NATs with embedded STUN servers</span><span>)</span></a> shows how
          a STUN client iterates over the NATs to communicate with all of the
          NATs in the path.
</p><br /><hr class="insert" />
<a name="example_two_nats"></a>

<p>The following figure shows two nested NATs:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>

+------+      +--------+     +--------+
| 192.168.1.2 |    10.1.1.2  |  192.0.2.1              +-----------+
| STUN +------+ NAT-B  +-----+ NAT-A  +---&lt;Internet&gt;---+STUN Server|
|Client|   192.168.1.1 |   10.1.1.1   |                +-----------+
+------+      +--------+     +--------+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Two nested NATs with embedded STUN servers&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>First, the STUN client would learn the outer-most NAT's IP
          address by performing the steps shown in <a class='info' href='#ladder_diagram'>Figure&nbsp;2<span> (</span><span class='info'>Communication Flow</span><span>)</span></a>. In the case below, however, the IP
          address and UDP port indicated by the XOR-INTERNAL-ADDRESS will not
          be the STUN client's own IP address and UDP port -- rather, it is
          the IP address and UDP port on the *outer* side of the NAT-B --
          10.1.1.2.
</p>
<p>Because of this, the STUN client repeats the procedure and sends
          another STUN Binding Request to that newly-learned address (the
          *outer* side of NAT-B). NAT-B will respond with a STUN Binding
          Response containing the XOR-INTERNAL-ADDRESS attribute, which will
          match the STUN client's IP address and UDP port. The STUN client
          knows there are no other NATs between itself and NAT-B, and
          finishes.
</p><br /><hr class="insert" />
<a name="outside-in-2-nat-message-flow"></a>

<p>The message flow with two nested NATs is shown
            below:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>

  STUN Client             NAT-B     NAT-A     STUN Server
      |                      |        |          |
 1.   |-----Binding Request (UDP)---------------&gt;|
 2.   |&lt;----Binding Response (UDP)---------------|
      |                      |        |          |
 3.   |--Binding Request (UDP)-------&gt;|          |     }
 4.   |&lt;-Binding Response (UDP)-------|          |     } NAT Control
      |                      |        |          |     } STUN Usage
 5.   |--Binding Req (UDP)--&gt;|        |          |     }
 6.   |&lt;-Binding Resp (UDP)--|        |          |     }
      |                      |        |          |
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: Message Flow for Outside-In with Two NATs&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Once a shared secret has been obtained with each of the on-path
          NATs, the STUN client no longer needs the TLS/TCP connection -- all
          subsequent bindings for individual UDP streams (that is, for each
          subsequent call) are obtained by just sending a Binding Request to
          each of the NATs. By sending a Binding Request to both NAT-A and
          NAT-B, the STUN client has the opportunity to optimize the packet
          flow if their UDP peer is also behind the same NAT.
</p>
<a name="tagging"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Tagging</h3>

<p>To discover an on-path firewall, the PLEASE-TAG attribute is used
        with a STUN Binding Request (a STUN packet sent to UDP/3478) message.
        A firewall would inspect bypassing Binding Request messages and
        determine whether there is a PLEASE-TAG attribute. When the firewall
        sees the associated Binding Response, the firewall appends a TAG
        attribute as the last attribute of the Binding Response. This TAG
        attribute contains the firewall's management IP address and UDP port.
        Each on-path firewall would be able to insert its own TAG attribute.
        In this way, the STUN Response would contain a pointer to each of the
        on-path firewalls between the client and that STUN server.
</p>
<p></p>
<blockquote class="text">
<p>Motivation for developing the Tagging mechanism: The Outside-In
            discovery technique (<a class='info' href='#outside-in'>Section&nbsp;4.1<span> (</span><span class='info'>Outside-In</span><span>)</span></a>) uses the
            public IP address of the NAT to find the outer-most NAT that
            supports STUN Control. Firewalls do not translate packets and
            hence a different technique is needed to identify
            firewalls.<br />
<br />
 Note that tagging is similar
            to how <a class='info' href='#I-D.ietf-nsis-nslp-natfw'>NSIS-NSLP<span> (</span><span class='info'>Stiemerling, M., Tschofenig, H., Aoun, C., and E. Davies, &ldquo;NAT/Firewall NSIS Signaling Layer Protocol (NSLP),&rdquo; April&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;nsis&#8209;nslp&#8209;natfw],
            <a class='info' href='#I-D.shore-tist-prot'>TIST<span> (</span><span class='info'>Shore, M., &ldquo;The TIST (Topology-Insensitive Service Traversal) Protocol,&rdquo; May&nbsp;2002.</span><span>)</span></a> [I&#8209;D.shore&#8209;tist&#8209;prot], and <a class='info' href='#I-D.shore-nls-tl'>NLS<span> (</span><span class='info'>Shore, M., McGrew, D., and K. Biswas, &ldquo;Network-Layer Signaling: Transport Layer,&rdquo; July&nbsp;2008.</span><span>)</span></a> [I&#8209;D.shore&#8209;nls&#8209;tl] function.
</p>
</blockquote>
<br /><hr class="insert" />
<a name="tagging-message-flow"></a>

<p>This figure shows how tagging functions.
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
   STUN Client          firewall           STUN Server
       |                   |                   |
1.     |--Binding Request-&gt;|------------------&gt;|
2.     |                   |&lt;-Binding Response-|
3.     |             [inserts tag]             |
4.     |&lt;-Binding Response-|                   |
5. [firewall discovered]   |                   |
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: Tagging Message Flow&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p></p>
<ol class="text">
<li>A Binding Request, containing the PLEASE-TAG attribute, is sent
            to the IP address of the STUN server that is located somewhere on
            the Internet. This is seen by the firewall, and the firewall
            remembers the STUN transaction id, and permits the STUN Binding
            Request packet.
</li>
<li>When the firewall observes a STUN Binding Response packet it
            checks its cache for the previously stored STUN transaction id. If
            a previous STUN transaction id was found then the firewall inserts
            the TAG attribute, which contains the firewall's management
            address.
</li>
<li>The firewall sends the (modified) STUN Binding Response towards
            the STUN client.
</li>
<li>The STUN client has now discovered the firewall, and can query
            it or control it.
</li>
</ol>

<a name="query_and_control"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Query and Control </h3>

<p>This section describes how to use STUN to query and control a NAT
      that was discovered using the technique described in <a class='info' href='#discovery'>Section&nbsp;4<span> (</span><span class='info'>Discovery of Middleboxes (NATs and Firewalls)</span><span>)</span></a>.
</p>
<a name="client_procedures"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Client Procedures</h3>

<p>After discovering on-path NATs and firewalls with the procedure
        described in <a class='info' href='#discovery'>Section&nbsp;4<span> (</span><span class='info'>Discovery of Middleboxes (NATs and Firewalls)</span><span>)</span></a>, the STUN client begins
        querying and controlling those devices.
</p>
<p>To modify an existing NAT mapping's attributes, or to request a new
        NAT mapping for a new UDP port, the STUN client can now send a STUN
        Binding Request to the IP address of address of the respective NAT or
        firewall (using the STUN UDP port, 3478).
</p>
<p>Client produces for handling the BOOTNONCE attribute can be found
        in <a class='info' href='#bootnonce'>Section&nbsp;6.5<span> (</span><span class='info'>BOOTNONCE Attribute</span><span>)</span></a>.
</p>
<a name="server_procedures"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Server Procedures</h3>

<p>When receiving a STUN Binding Request the STUN controlled NAT will
        respond with a STUN Binding Response containing an XOR-MAPPED-ADDRESS
        attribute (which points at the NAT's public IP address and port --
        just as if the STUN Binding Request had been sent to a STUN server on
        the public Internet) and an XOR-INTERNAL-ADDRESS attribute (which
        points to the source IP address and UDP port the packet STUN Binding
        Request packet had prior to being NATted). See <a class='info' href='#internal_diagram'>Figure&nbsp;12<span> (</span><span class='info'>Block Diagram of Internal NAT Operation</span><span>)</span></a> which depicts how this might be
        implemented in a NAT.
</p>
<p></p>
<blockquote class="text">
<p>For example, looking at <a class='info' href='#example_one_nat'>Figure&nbsp;1<span> (</span><span class='info'>One NAT with embedded STUN server</span><span>)</span></a>,
            the XOR-INTERNAL-ADDRESS is the IP address and UDP port prior to
            the NAPT operation. If there is only one NAT, as shown in <a class='info' href='#example_one_nat'>Figure&nbsp;1<span> (</span><span class='info'>One NAT with embedded STUN server</span><span>)</span></a>, XOR-INTERNAL-ADDRESS would
            contain the STUN client's own IP address and UDP port. If there
            are multiple NATs, XOR-INTERNAL-ADDRESS would indicate the IP
            address of the next NAT (that is, the next NAT closer to the STUN
            client).
</p>
</blockquote>

<p>When receiving a STUN Binding Request the STUN controlled firewall
        will respond with a STUN Binding Response containing an
        XOR-MAPPED-ADDRESS attribute (which points at the public IP address
        and port) and an XOR-INTERNAL-ADDRESS attribute (which points to the
        source IP address of the interface and UDP port where the packet was
        received, i.e., the internal interface).
</p>
<p>Server procedures for handling the BOOTNONCE and REFRESH-INTERVAL
        attributes can be found in <a class='info' href='#bootnonce'>Section&nbsp;6.5<span> (</span><span class='info'>BOOTNONCE Attribute</span><span>)</span></a> and <a class='info' href='#refresh-interval'>Section&nbsp;6.1<span> (</span><span class='info'>REFRESH-INTERVAL Attribute</span><span>)</span></a>.
</p>
<p>STUN Binding Requests, which arrived from its public interface(s),
        MAY be handled as if the server is not listening on that port (e.g.,
        return an ICMP error). This specification does not need them.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
New Attributes</h3>

<a name="refresh-interval"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
REFRESH-INTERVAL Attribute</h3>

<p>In a STUN request, the REFRESH-INTERVAL attribute indicates the
        number of milliseconds that the client wants the NAT binding (or
        firewall pinhole) to be opened. This applies to all bindings that
        exist in that NAT from that same source IP address and same source UDP
        port (see also <a class='info' href='#linux-specifics'>Appendix&nbsp;B.2<span> (</span><span class='info'>Linux specifics</span><span>)</span></a>). In a STUN
        response, the REFRESH-INTERVAL attribute indicates the number of
        milliseconds the STUN server (embedded in the NAT or firewall) will
        keep the bindings open.
</p>
<p>REFRESH-INTERVAL is specified as an unsigned 32 bit integer, and
        represents an interval measured in milliseconds (thus the maximum
        value is approximately 50 days). This attribute can be present in
        Binding Requests and in Binding Responses.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
XOR-INTERNAL-ADDRESS Attribute</h3>

<p>This attribute MUST be present in a Binding Response and is
        necessary to allow a STUN client to perform the outside-in discovery
        technique, in order to discover all of the STUN Control-aware NATs
        along the path.
</p><br /><hr class="insert" />
<a name="xor-internal-address"></a>

<p>The format of the XOR-INTERNAL-ADDRESS attribute
          is:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|x x x x x x x x|    Family     |         X-Port                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                X-Address (32 bits or 128 bits)                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: XOR-INTERNAL-ADDRESS Attribute&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The meaning of Family, X-Port, and X-Address are exactly as in
        <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>. The length of
        X-Address depends on the address family (IPv4 or IPv6).
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
PLEASE-TAG Attribute</h3>

<p>If a STUN client wants to discover on-path firewalls, it MUST
        include this attribute in its Binding Response when performing the
        Binding Discovery usage.
</p>
<p>STUN servers are not expected to understand this attribute; if they
        return this attribute as an unknown attribute, it does not affect the
        operation described in this document.
</p><br /><hr class="insert" />
<a name="please-tag-attribute"></a>

<p>The format of the PLEASE-TAG attribute is:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Mech.|x x x x x x x x x x x x x x x x x x x x x x x x x x x x x|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;7: PLEASE-TAG Attribute&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The 3-bit Mechanism field indicates the control mechanism desired.
        Currently, the only defined mechanism is STUN Control, and is
        indicated with all zeros. The intent of this field is to allow
        additional control mechanisms (e.g., UPnP, NAT-PMP, MIDCOM).
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
TAG Attribute</h3>

<p>The TAG attribute contains the XOR'd management transport address
        of the middlebox. Typically, a firewall as well as a NAT may find this
        technique useful as well.
</p>
<p>If the associated STUN Request contained the PLEASE-TAG attribute,
        a middlebox MUST append this attribute as the last attribute of the
        STUN Response (with that same transaction-id). After appending this
        attribute, the STUN length field MUST be also be adjusted.
</p><br /><hr class="insert" />
<a name="tag-figure"></a>

<p>The format of the TAG attribute is:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Mech.|M|x x x x|    Family     |         X-Port                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                X-Address (32 bits or 128 bit)                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;8: TAG Attribute&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Mech: The 3-bit Mechanism field indicates the control mechanism
        supported on the described port. Currently, the only defined mechanism
        is STUN Control, and is indicated with 0x0. The intent of this field
        is to allow additional control mechanisms (e.g., UPnP, NAT-PMP,
        MIDCOM).
</p>
<p>The one-bit M field indicates if this firewall permits Mobility
        Header packets to flow through it (<a class='info' href='#RFC3775'>[RFC3775]<span> (</span><span class='info'>Johnson, D., Perkins, C., and J. Arkko, &ldquo;Mobility Support in IPv6,&rdquo; June&nbsp;2004.</span><span>)</span></a>).
</p>
<p>The meaning of Family, X-Port, and X-Address are exactly as in
        <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>. The length of
        X-Address depends on the address family (IPv4 or IPv6).
</p>
<a name="bootnonce"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.5"></a><h3>6.5.&nbsp;
BOOTNONCE Attribute</h3>

<p>The BOOTNONCE attribute protects against the attack described in
        <a class='info' href='#rogue_stun_server'>Section&nbsp;8.4<span> (</span><span class='info'>BOOTNONCE Attribute</span><span>)</span></a>.
</p>
<p>Client procedures: The STUN client expects each NAT to return the
        same BOOTNONCE value each time that NAT is contacted. If a NAT returns
        a different value, the STUN client MUST NOT use any information
        returned in the Binding Response and MUST re-run the STUN Control
        procedures from the beginning (i.e., obtain its public IP address from
        the STUN server on the Internet). This would only occur if an attack
        is in progress or if the NAT rebooted. If the NAT rebooted, it is good
        practice to re-run the STUN Control procedures anyway, as the network
        topology could be different as well.
</p>
<p>Server procedures: This attribute's value is a hash of the STUN
        client's IP address and a value that is randomly-generated each time
        the NAT is initialized. The STUN client's IP address is included in
        this hash to thwart an attacker attaching to the NAT's internal
        network and learning the BOOTNONCE value.
</p><br /><hr class="insert" />
<a name="bootnonce-attribute"></a>

<p>The format of the BOOTNONCE attribute is:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                  Boot Nonce value (32 bits)                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;9: BOOTNONCE Attribute&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Limitations of STUN Control</h3>

<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Overlapping IP Addresses with Nested NATs</h3>
<br /><hr class="insert" />
<a name="nested_nats"></a>

<p>If nested NATs have overlapping IP address space, there
          will be undetected NATs on the path. When this occurs, the STUN
          client will be unable to detect the presence of NAT-A if NAT-A
          assigns the same UDP port. For example, in the following figure,
          NAT-A and NAT-B are both using 10.1.1.x as their 'private'
          network.
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
+------+       +--------+     +--------+
|  10.1.1.2    |  10.1.1.2    |  192.0.2.1
| STUN +-------+  NAT-A +-----+  NAT-B +------&lt;Internet&gt;
|client|    10.1.1.1    |    10.1.1.1  |
+------+       +--------+     +--------+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;10: Overlapping Addresses with Nested NATs&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>When this situation occurs, the STUN client can only learn the
        outer-most address. This is not a problem -- the STUN client is still
        able to communicate with the outer-most NAT and is still able to avoid
        consuming access network bandwidth and avoid communicating with the
        public STUN server. All that is lost is the ability to optimize paths
        within the private network that has overlapped addresses.
</p>
<p>Of course when such an overlap occurs the end host (STUN client)
        cannot successfully establish bi-directional communication with hosts
        in the overlapped network, anyway.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
Address Dependent NAT on Path</h3>

<p>In order to utilize the mechanisms described in this document, a
        STUN Request is sent from the same source IP address and source port
        as the original STUN Binding Discovery message, but is sent to a
        different destination IP address -- it is sent to the IP address of an
        on-path NAT. If there is an on-path NAT, between the STUN client and
        the STUN server, with 'address dependent' or 'address and
        port-dependent' mapping behavior (as described in Section 4.1 of <a class='info' href='#RFC4787'>[RFC4787]<span> (</span><span class='info'>Audet, F. and C. Jennings, &ldquo;Network Address Translation (NAT) Behavioral Requirements for Unicast UDP,&rdquo; January&nbsp;2007.</span><span>)</span></a>), that NAT will prevent a STUN client from
        taking advantage of the technique described in this document. When
        this occurs, the ports indicated by XOR-MAPPED-ADDRESS from the public
        STUN server and the NAT's embedded STUN server will differ.
</p><br /><hr class="insert" />
<a name="address_dep_mapping"></a>

<p>An example of such a topology is shown in the following
          figure:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
+------+     +--------+   +--------+
| STUN |     |  10.1.1.2  |  192.0.2.1
|client+-----+  NAT-A +---+  NAT-B +------&lt;Internet&gt;
|      |  10.1.1.1    |  10.1.1.1  |
+------+     +--------+   +--------+
</pre></div>
<p>In this figure, NAT-A is a NAT that has address dependent
          mapping. Thus, when the STUN client sends a STUN Binding Request to
          192.0.2.1 on UDP/3478, NAT-A will choose a new public UDP port for
          that communication. NAT-B will function normally, returning a
          different port in its XOR-MAPPED-ADDRESS, which indicates to the
          STUN client that a symmetric NAT exists between the STUN client and
          the STUN server it just queried (NAT-B, in this
          example).
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;11: Address Dependant NAT on Path&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
Address Dependent Filtering</h3>

<p>If there is an NAT along the path that has address dependent
        filtering (as described in section 5 of <a class='info' href='#RFC4787'>[RFC4787]<span> (</span><span class='info'>Audet, F. and C. Jennings, &ldquo;Network Address Translation (NAT) Behavioral Requirements for Unicast UDP,&rdquo; January&nbsp;2007.</span><span>)</span></a>), and the STUN client sends a STUN packet
        directly to any of the on-path NATs public addresses, the
        address-dependent filtering NAT will filter packets from the remote
        peer. Thus, after communicating with all of the on-path NATs the STUN
        client MUST send a UDP packet to the remote peer, if the remote peer
        is known.
</p>
<a name="legacy-nats"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.4"></a><h3>7.4.&nbsp;
Interacting with Legacy NATs</h3>

<p>There will be cases where the STUN client attempts to communicate
        with an on-path NAT, which does not support STUN Control. There are
        two cases:
</p>
<p></p>
<ul class="text">
<li>the NAT does not run a STUN server on its public interface
            (this will be the most common)
</li>
<li>the NAT does run a STUN server on its public interface, but
            does not return the XOR-INTERNAL-ADDRESS attribute defined in this
            document
</li>
</ul>

<p>In both cases the optimizations described in this section will not
        be available to the STUN client. This is no worse than the condition
        today. This allows incremental upgrades of applications and NATs that
        implement the technique described in this document.
</p>
<a name="security_considerations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>This security considerations section will be expanded in a subsequent
      version of this document. So far, the authors have identified the
      following considerations:
</p>
<a name="authorization"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.1"></a><h3>8.1.&nbsp;
Authorization</h3>

<p>Only hosts that are 'inside' a NAT, which a NAT is already
        providing services for, can query or adjust the timeout of a NAT
        mapping.
</p>
<p>A discussion of additional authorization mechanisms that might be
        needed for firewall traversal can be found at <a class='info' href='#I-D.wing-session-auth'>[I&#8209;D.wing&#8209;session&#8209;auth]<span> (</span><span class='info'>Wing, D., &ldquo;Media Session Authorization,&rdquo; February&nbsp;2006.</span><span>)</span></a>.
</p>
<a name="exhaustion"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.2"></a><h3>8.2.&nbsp;
Resource Exhaustion</h3>

<p>A malicious STUN client could ask for absurdly long NAT bindings
        (days) for many UDP sessions, which would exhaust the resources in the
        NAT. The same attack is possible (without considering this document
        and without considering STUN or other <a class='info' href='#RFC3424'>UNSAF<span> (</span><span class='info'>Daigle, L. and IAB, &ldquo;IAB Considerations for UNilateral Self-Address Fixing (UNSAF) Across Network Address Translation,&rdquo; November&nbsp;2002.</span><span>)</span></a> [RFC3424] NAT traversal techniques) -- a malicious
        TCP (or UDP) client can open many TCP (or UDP) connections, and keep
        them open, causing resource exhaustion in the NAT.
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.3"></a><h3>8.3.&nbsp;
Comparison to Other NAT Control Techniques</h3>

<p>Like UPnP, NAT-PMP, and host-initiated MIDCOM, the STUN usage
        described in this document allows a host to learn its public IP
        address and UDP port mapping, and to request a specific lifetime for
        mappings from that same source IP address and same source UDP
        port.
</p>
<p>However, unlike other NAT traversal technologies, STUN Control
        described in this document only allows each UDP port on the host to
        create and adjust the mapping timeout of its own NAT mappings.
        Specifically, an application on a host can only adjust the duration of
        a NAT bindings for itself, and not for another application on that
        same host, and not for other hosts. This provides security advantages
        over other NAT control mechanisms where malicious software on a host
        can surreptitiously create NAT mappings to another application or to
        another host.
</p>
<a name="rogue_stun_server"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.4"></a><h3>8.4.&nbsp;
BOOTNONCE Attribute</h3>

<p>Using the mechanisms described in this document, a STUN client
        learns the public IP addresses of its NAT which supports the
        mechanisms described in this document. However, without the STUN
        client's knowledge, that NAT may acquire a new IP address (e.g., due
        to DHCP lease expiration or network renumbering). When this occurs,
        the STUN client will send a STUN Binding Request to the NAT's previous
        public IP address. If an attacker were to run a rogue STUN server on
        that address, the attacker will have effectively compromised the STUN
        server, as described in Section 12.2.1 of <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a>. The attacker, upon receiving STUN Binding
        Requests, will reply with STUN Binding Responses indicating an IP
        address the attacker controls. The attacker will thus have access to
        the subsequent flow established by the STUN client (e.g., RTP
        traffic). This attack is possible because the STUN client is unable to
        distinguish the attacker's replies from replies from the legitimate
        NAT.
</p>
<p>To defend against this attack, the STUN server embedded in the NAT
        returns a BOOTNONCE value. The STUN client validates that it receives
        the same BOOTNONCE value in each STUN Binding Response from that NAT.
        If the STUN client receives a new BOOTNONCE value, the STUN client
        discards information about NATs it has learned through the procedures
        in this document, and restarts the procedure described in this
        document.
</p>
<p>A weakness of this approach is that an attacker can learn the
        BOOTNONCE value if the attacker is able to connect to the NAT's
        internal network prior to initiating the attack. This is plausible if
        the internal network has no security (e.g., public WiFi network). For
        this reason, it is RECOMMENDED that the BOOTNONCE value is hashed with
        the STUN client's IP address. Doing so means that a successful
        attacker must acquire both the same IP address as the victim from
        behind the NAT (to learn the BOOTNONCE), and must also acquire the
        NAT's previous public IP address, or needs to be on-path between the
        victim and its NAT (in which case the attacker has no incentive to
        redirect traffic elsewhere to observe such traffic; however, the
        attacker might be interested in redirecting traffic towards another
        endpoint on the Internet. To thwart that attack, the STUN client MUST
        only honor STUN responses that have an X-MAPPED-ADDRESS that matches
        the public IP address of the NAT-embedded STUN server.
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Open Issues and Discussion Points</h3>

<p></p>
<ul class="text">
<li>Discussion Point: After discovering NATs and firewalls,
          controlling those devices might also be done with a middlebox
          control protocol (e.g., by using standard or slightly modified
          versions of SIMCO, UPnP, MIDCOM, or NAT-PMP). This is open for
          discussion as this document is scoped within the IETF.
</li>
<li>Discussion Point: Tagging would also be useful for the
          Connectivity Check usage (which is used by ICE), especially
          considering that a different firewall may be traversed for media
          than for the initial Binding Discovery usage. In such a situation,
          the new on-path firewall's policy might not allow a binding request
          to leave the network or allow a binding response to return. In this
          case, the firewall would need to indicate its presence to the STUN
          client in another way. An ICMP error message may be appropriate, and
          an <a class='info' href='#RFC4884'>ICMP extension<span> (</span><span class='info'>Bonica, R., Gan, D., Tappan, D., and C. Pignataro, &ldquo;Extended ICMP to Support Multi-Part Messages,&rdquo; April&nbsp;2007.</span><span>)</span></a> [RFC4884] could indicate the
          firewall is controllable.
</li>
<li>Open issue: We could resolve the problem of address dependant
          NATs along the path by introducing a new STUN attribute which
          indicates the UDP port the STUN client wants to control. However,
          this changes the security properties of STUN Control, so this seems
          undesirable.<br />
<br />
 Open issue: When the STUN
          client detects an address dependant NAT, should we recommend it
          abandon the STUN Control usage, and revert to operation as if it
          doesn't support the STUN Control usage?
</li>
<li>Open issue: How many filter entries are in address dependent
          filtering NATs? If only one, this does become a real limitation if
          NATs are nested; if they're not nested, the outer-most NAT can avoid
          overwriting its own address in its address dependent filter.
</li>
<li>Discussion: One way to thwart a resource consumption attack is to
          challenge the STUN client. This would allow the STUN server to delay
          the establishment of resources before a return-routability test is
          performed. This functionality is currently not provided by this
          specification. The NONCE attribute <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a> could be useful to
          provide this function. However, the mere sending of a UDP packet
          across a NAT creates a binding (for ~2 minutes), and there isn't a
          return- routability check for that.
</li>
<li>The inside-out discovery technique was removed with version -03
          of this document. The procedure worked as follows: The STUN client
          sends a STUN request to UDP/3478 of the IP address of its default
          router. If there is a STUN server listening there, it will respond,
          and will indicate its default route via the new DEFAULT-ROUTE
          attribute. With that information, the STUN client can discover the
          next-outermost NAT by repeating the procedure. More feedback is
          needed to determine whether the functionality is needed.
</li>
</ul>

<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
IANA Considerations</h3>

<p>This section registers new STUN attributes per the
        procedures in <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Mandatory range:
  0x0029   XOR-INTERNAL-ADDRESS
  0x00..   BOOTNONCE

Optional range:
  0x8024   REFRESH-INTERVAL
  0x80..   PLEASE-TAG
  0x80..   TAG

</pre></div>
<p>
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Acknowledgements</h3>

<p>Thanks to Remi Denis-Courmont, Christian Dickmann, Bajko Gabor,
      Markus Isomaki, Cullen Jennings, and Philip Matthews for their
      suggestions which have improved this document.
</p>
<p>Thanks to Christian Dickmann and Yan Sun for their initial
      implementations of STUN Control.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-behave-rfc3489bis">[I-D.ietf-behave-rfc3489bis]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-rfc3489bis-18.txt">Session Traversal Utilities for (NAT) (STUN)</a>,&rdquo; draft-ietf-behave-rfc3489bis-18 (work in progress), July&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-rfc3489bis-18.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4787">[RFC4787]</a></td>
<td class="author-text">Audet, F. and C. Jennings, &ldquo;<a href="http://tools.ietf.org/html/rfc4787">Network Address Translation (NAT) Behavioral Requirements for Unicast UDP</a>,&rdquo; BCP&nbsp;127, RFC&nbsp;4787, January&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4787.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3489">[RFC3489]</a></td>
<td class="author-text">Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;<a href="http://tools.ietf.org/html/rfc3489">STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs)</a>,&rdquo; RFC&nbsp;3489, March&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3489.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3775">[RFC3775]</a></td>
<td class="author-text">Johnson, D., Perkins, C., and J. Arkko, &ldquo;<a href="http://tools.ietf.org/html/rfc3775">Mobility Support in IPv6</a>,&rdquo; RFC&nbsp;3775, June&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3775.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.2.&nbsp;Informational References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-behave-turn">[I-D.ietf-behave-turn]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-turn-16.txt">Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)</a>,&rdquo; draft-ietf-behave-turn-16 (work in progress), July&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-turn-16.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="UPnP">[UPnP]</a></td>
<td class="author-text">UPnP Forum, &ldquo;<a href="http://www.upnp.org">Universal Plug and Play</a>,&rdquo; 2000.</td></tr>
<tr><td class="author-text" valign="top"><a name="Vista-cert">[Vista-cert]</a></td>
<td class="author-text">Microsoft, &ldquo;<a href="http://download.microsoft.com/download/d/e/1/de1e0c8f-a222-47bc-b78b-1656d4cf3cf7/WLP-DeviceReqs_309.pdf">Windows Logo Program Device Requirements</a>,&rdquo; 2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.cheshire-nat-pmp">[I-D.cheshire-nat-pmp]</a></td>
<td class="author-text">Cheshire, S., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-cheshire-nat-pmp-03.txt">NAT Port Mapping Protocol (NAT-PMP)</a>,&rdquo; draft-cheshire-nat-pmp-03 (work in progress), April&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-cheshire-nat-pmp-03.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3303">[RFC3303]</a></td>
<td class="author-text">Srisuresh, P., Kuthan, J., Rosenberg, J., Molitor, A., and A. Rayhan, &ldquo;<a href="http://tools.ietf.org/html/rfc3303">Middlebox communication architecture and framework</a>,&rdquo; RFC&nbsp;3303, August&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3303.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-mmusic-ice">[I-D.ietf-mmusic-ice]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>,&rdquo; draft-ietf-mmusic-ice-19 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sip-outbound">[I-D.ietf-sip-outbound]</a></td>
<td class="author-text">Jennings, C., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-20.txt">Managing Client Initiated Connections in the Session Initiation Protocol  (SIP)</a>,&rdquo; draft-ietf-sip-outbound-20 (work in progress), June&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-20.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-nsis-nslp-natfw">[I-D.ietf-nsis-nslp-natfw]</a></td>
<td class="author-text">Stiemerling, M., Tschofenig, H., Aoun, C., and E. Davies, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-nsis-nslp-natfw-25.txt">NAT/Firewall NSIS Signaling Layer Protocol (NSLP)</a>,&rdquo; draft-ietf-nsis-nslp-natfw-25 (work in progress), April&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-nsis-nslp-natfw-25.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4884">[RFC4884]</a></td>
<td class="author-text">Bonica, R., Gan, D., Tappan, D., and C. Pignataro, &ldquo;<a href="http://tools.ietf.org/html/rfc4884">Extended ICMP to Support Multi-Part Messages</a>,&rdquo; RFC&nbsp;4884, April&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4884.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.shore-tist-prot">[I-D.shore-tist-prot]</a></td>
<td class="author-text">Shore, M., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-shore-tist-prot-00.txt">The TIST (Topology-Insensitive Service Traversal) Protocol</a>,&rdquo; draft-shore-tist-prot-00 (work in progress), May&nbsp;2002 (<a href="http://www.ietf.org/internet-drafts/draft-shore-tist-prot-00.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.shore-nls-tl">[I-D.shore-nls-tl]</a></td>
<td class="author-text">Shore, M., McGrew, D., and K. Biswas, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-shore-nls-tl-06.txt">Network-Layer Signaling: Transport Layer</a>,&rdquo; draft-shore-nls-tl-06 (work in progress), July&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-shore-nls-tl-06.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3424">[RFC3424]</a></td>
<td class="author-text">Daigle, L. and IAB, &ldquo;<a href="http://tools.ietf.org/html/rfc3424">IAB Considerations for UNilateral Self-Address Fixing (UNSAF) Across Network Address Translation</a>,&rdquo; RFC&nbsp;3424, November&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3424.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3948">[RFC3948]</a></td>
<td class="author-text">Huttunen, A., Swander, B., Volpe, V., DiBurro, L., and M. Stenberg, &ldquo;<a href="http://tools.ietf.org/html/rfc3948">UDP Encapsulation of IPsec ESP Packets</a>,&rdquo; RFC&nbsp;3948, January&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc3948.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.wing-session-auth">[I-D.wing-session-auth]</a></td>
<td class="author-text">Wing, D., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-wing-session-auth-00.txt">Media Session Authorization</a>,&rdquo; draft-wing-session-auth-00 (work in progress), February&nbsp;2006 (<a href="http://www.ietf.org/internet-drafts/draft-wing-session-auth-00.txt">TXT</a>).</td></tr>
</table>

<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Changes</h3>

<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
Changes in -04</h3>

<p></p>
<ul class="text">
<li>Clarified that all existing bindings, for that source IP
            address and UDP port, are controlled with STUN Control.
</li>
<li>Introduction now concentrates on the primary purpose of STUN
            Control, namely reducing keepalive traffic for SIP-Outbound.
</li>
</ul>

<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.2"></a><h3>A.2.&nbsp;
Changes in -03</h3>

<p></p>
<ul class="text">
<li>Removed TLS from normal STUN operation (as few use it, and ICE
            makes it unnecessary anyway)
</li>
<li>BOOTNONCE attribute replaces STUN Control's previous use of
            TLS.
</li>
<li>Added "MIP-capable" bit to TAG attribute
</li>
<li>Removed "inside-out" discovery technique.
</li>
</ul>

<a name="implementation details"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
Implementation Details</h3>

<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.1"></a><h3>B.1.&nbsp;
Internal NAT Operation</h3>

<p><br /><hr class="insert" />
<a name="internal_diagram"></a>

<p>Internally, the NAT can be diagrammed to function like
            this, where the NAT operation occurs before the STUN
            server:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
          |
          | outside interface
          |
+---------+---------------+
|         |               |
|         |    +--------+ |
|         |----+ STUN   | |
|         |    | Server | |
|         |    +---^----+ |
|         |        |      |
|         |       API     |
|         |        |      |
| +-------+--------V----+ |
| |   NAT Function      | |
| +-------+-------------+ |
|         |               |
+---------+---------------+
          |
          | inside interface
          |
          |</pre></div>
<p>The host on the 'inside' interface of the NAT sends
            packets to the NAT's public interface, where the STUN server is
            listening. This STUN server returns the same public IP address
            (XOR-MAPPED-ADDRESS) as a STUN server that resides on a separate
            server on the 'outside' interface. In order to query and to
            control the NAT binding lifetimes, the STUN server uses an API
            with the NAT function.
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;12: Block Diagram of Internal NAT Operation&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


<a name="linux-specifics"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.2"></a><h3>B.2.&nbsp;
Linux specifics</h3>

<p>The Linux NAT implementation maintains a separate connection table
        entry for every binding. When STUN Control is used to control the
        binding lifetime (e.g., extend the lifetime), the binding lifetime for
        each of those connection table entries is modified to the new
        value.
</p>
<p>For example, with the following message flow:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>             STUN Client                        NAT     STUN Server
                 |                               |          |
            1.   |-----Binding Request (UDP)---------------&gt;|
            2.   |&lt;----Binding Response (UDP)---------------|
                 |                               |          |
            3.   |--Binding Request (UDP)-------&gt;|          |
            4.   |&lt;-Binding Response (UDP)-------|          |
                 |                               |          |</pre></div>
<p>
</p>
<p>the following two connection table entries are
          created:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  udp      17 24 src=10.7.2.4 dst=10.7.1.2 sport=1024
           dport=3478 packets=1 bytes=64 src=10.7.1.2
           dst=10.7.1.3 sport=3478 dport=1024 packets=1
           bytes=84 mark=0 use=1
  udp      17 25 src=10.7.2.4 dst=10.7.1.3 sport=1024
           dport=3478 packets=2 bytes=64 src=10.7.1.3
           dst=10.7.2.4 sport=3478 dport=1024 packets=2
           bytes=208 mark=0 use=1</pre></div>
<p>the first src/dst/sport/dport combination is the internal
          and the second one is the external version. Both are equal in the
          second connection, as the NAT function wasn't active for the
          "internal" message.
</p>
<p>s
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dan Wing</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">170 West Tasman Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Jose, CA  95134</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:dwing@cisco.com">dwing@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jonathan Rosenberg</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Edison, NJ  07054</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jdrosen@cisco.com">jdrosen@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hannes Tschofenig</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nokia Siemens Networks</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Otto-Hahn-Ring 6</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Munich, Bavaria  81739</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Germany</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Hannes.Tschofenig@nsn.com">Hannes.Tschofenig@nsn.com</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.tschofenig.com">http://www.tschofenig.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2007).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
