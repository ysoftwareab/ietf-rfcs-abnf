<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>TCP Candidates with Interactive Connectivity Establishment (ICE)</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology">
<link href="#rfc.section.3" rel="Chapter" title="3 Overview of Operation">
<link href="#rfc.section.4" rel="Chapter" title="4 Sending the Initial Offer">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Gathering Candidates">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Prioritization">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Choosing Default Candidates">
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 Lite Implementation Requirements">
<link href="#rfc.section.4.5" rel="Chapter" title="4.5 Encoding the SDP">
<link href="#rfc.section.5" rel="Chapter" title="5 Candidate Collection Techniques">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Host Candidates">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Server Reflexive Candidates">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 NAT-Assisted Candidates">
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 UDP-Tunneled Candidates">
<link href="#rfc.section.5.5" rel="Chapter" title="5.5 Relayed Candidates">
<link href="#rfc.section.6" rel="Chapter" title="6 Receiving the Initial Offer and Answer">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Considerations with Two Lite Agents">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Forming the Check Lists">
<link href="#rfc.section.7" rel="Chapter" title="7 Connectivity Checks">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 STUN Client Procedures">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 STUN Server Procedures">
<link href="#rfc.section.8" rel="Chapter" title="8 Concluding ICE Processing">
<link href="#rfc.section.9" rel="Chapter" title="9 Subsequent Offer/Answer Exchanges">
<link href="#rfc.section.9.1" rel="Chapter" title="9.1 ICE Restarts">
<link href="#rfc.section.10" rel="Chapter" title="10 Media Handling">
<link href="#rfc.section.10.1" rel="Chapter" title="10.1 Sending Media">
<link href="#rfc.section.10.2" rel="Chapter" title="10.2 Receiving Media">
<link href="#rfc.section.11" rel="Chapter" title="11 Connection Management">
<link href="#rfc.section.11.1" rel="Chapter" title="11.1 Connections Formed During Connectivity Checks">
<link href="#rfc.section.11.2" rel="Chapter" title="11.2 Connections Formed for Gathering Candidates">
<link href="#rfc.section.12" rel="Chapter" title="12 Security Considerations">
<link href="#rfc.section.13" rel="Chapter" title="13 IANA Considerations">
<link href="#rfc.section.14" rel="Chapter" title="14 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="15 References">
<link href="#rfc.references.1" rel="Chapter" title="15.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="15.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Limitations of ICE TCP">
<link href="#rfc.appendix.Appendix%20B" rel="Chapter" title="Appendix B Implementation Considerations for BSD Sockets">
<link href="#rfc.appendix.Appendix%20C" rel="Chapter" title="Appendix C SDP Examples">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="Interactive Connectivity Establishment (ICE) defines a mechanism for NAT traversal for multimedia communication protocols based on the offer/answer model of session negotiation. ICE works by providing a set of candidate transport addresses for each media stream, which are then validated with peer-to-peer connectivity checks based on Session Traversal Utilities for NAT (STUN). ICE provides a general framework for describing candidates, but only defines UDP-based transport protocols.  This specification extends ICE to TCP-based media, including the ability to offer a mix of TCP and UDP-based candidates for a single stream." />
  <meta name="description" content="Interactive Connectivity Establishment (ICE) defines a mechanism for NAT traversal for multimedia communication protocols based on the offer/answer model of session negotiation. ICE works by providing a set of candidate transport addresses for each media stream, which are then validated with peer-to-peer connectivity checks based on Session Traversal Utilities for NAT (STUN). ICE provides a general framework for describing candidates, but only defines UDP-based transport protocols.  This specification extends ICE to TCP-based media, including the ability to offer a mix of TCP and UDP-based candidates for a single stream." />
  <meta name="keywords" content="ICE, TCP, NAT, NAT traversal" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">MMUSIC</td>
<td class="right">J.R. Rosenberg</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Skype</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">A. Keranen</td>
</tr>
<tr>
<td class="left">Expires: March 23, 2012</td>
<td class="right">Ericsson</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">B.B. Lowekamp</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Skype</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">A. Roach</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Tekelec</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">September 20, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">TCP Candidates with Interactive Connectivity Establishment (ICE)<br />
  <span class="filename">draft-ietf-mmusic-ice-tcp-15</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>Interactive Connectivity Establishment (ICE) defines a mechanism for NAT traversal for multimedia communication protocols based on the offer/answer model of session negotiation. ICE works by providing a set of candidate transport addresses for each media stream, which are then validated with peer-to-peer connectivity checks based on Session Traversal Utilities for NAT (STUN). ICE provides a general framework for describing candidates, but only defines UDP-based transport protocols.  This specification extends ICE to TCP-based media, including the ability to offer a mix of TCP and UDP-based candidates for a single stream.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on March 23, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>
<p>This document may contain material from IETF Documents or IETF Contributions published or made publicly available before November 10, 2008.  The person(s) controlling the copyright in some of this material may not have granted the IETF Trust the right to allow modifications of such material outside the IETF Standards Process. Without obtaining an adequate license from the person(s) controlling the copyright in such materials, this document may not be modified outside the IETF Standards Process, and derivative works of it may not be created outside the IETF Standards Process, except to format it for publication as an RFC or to translate it into languages other than English.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Terminology</a>
</li>
<li>3.   <a href="#rfc.section.3">Overview of Operation</a>
</li>
<li>4.   <a href="#rfc.section.4">Sending the Initial Offer</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Gathering Candidates</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Prioritization</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Choosing Default Candidates</a>
</li>
<li>4.4.   <a href="#rfc.section.4.4">Lite Implementation Requirements</a>
</li>
<li>4.5.   <a href="#rfc.section.4.5">Encoding the SDP</a>
</li>
<li>5.   <a href="#rfc.section.5">Candidate Collection Techniques</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Host Candidates</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Server Reflexive Candidates</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">NAT-Assisted Candidates</a>
</li>
<li>5.4.   <a href="#rfc.section.5.4">UDP-Tunneled Candidates</a>
</li>
<li>5.5.   <a href="#rfc.section.5.5">Relayed Candidates</a>
</li>
<li>6.   <a href="#rfc.section.6">Receiving the Initial Offer and Answer</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">Considerations with Two Lite Agents</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">Forming the Check Lists</a>
</li>
<li>7.   <a href="#rfc.section.7">Connectivity Checks</a>
</li>
<li>7.1.   <a href="#rfc.section.7.1">STUN Client Procedures</a>
</li>
<li>7.2.   <a href="#rfc.section.7.2">STUN Server Procedures</a>
</li>
<li>8.   <a href="#rfc.section.8">Concluding ICE Processing</a>
</li>
<li>9.   <a href="#rfc.section.9">Subsequent Offer/Answer Exchanges</a>
</li>
<li>9.1.   <a href="#rfc.section.9.1">ICE Restarts</a>
</li>
<li>10.   <a href="#rfc.section.10">Media Handling</a>
</li>
<li>10.1.   <a href="#rfc.section.10.1">Sending Media</a>
</li>
<li>10.2.   <a href="#rfc.section.10.2">Receiving Media</a>
</li>
<li>11.   <a href="#rfc.section.11">Connection Management</a>
</li>
<li>11.1.   <a href="#rfc.section.11.1">Connections Formed During Connectivity Checks</a>
</li>
<li>11.2.   <a href="#rfc.section.11.2">Connections Formed for Gathering Candidates</a>
</li>
<li>12.   <a href="#rfc.section.12">Security Considerations</a>
</li>
<li>13.   <a href="#rfc.section.13">IANA Considerations</a>
</li>
<li>14.   <a href="#rfc.section.14">Acknowledgements</a>
</li>
<li>15.   <a href="#rfc.references">References</a>
</li>
<li>15.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>15.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Limitations of ICE TCP</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.Appendix%20B">Implementation Considerations for BSD Sockets</a>
</li>
<li>Appendix C.   <a href="#rfc.appendix.Appendix%20C">SDP Examples</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">Interactive Connectivity Establishment (ICE) <a href="#RFC5245">[RFC5245]</a> defines a mechanism for NAT traversal for multimedia communication protocols based on the offer/answer model <a href="#RFC3264">[RFC3264]</a> of session negotiation. ICE works by providing a set of candidate transport addresses for each media stream, which are then validated with peer-to-peer connectivity checks based on Session Traversal Utilities for NAT (STUN) <a href="#RFC5389">[RFC5389]</a>. However, ICE only defines procedures for UDP-based transport protocols. </p>
<p id="rfc.section.1.p.2">There are many reasons why ICE support for TCP is important. Firstly, there are media protocols that only run over TCP. Such protocols are used, for example, for screen sharing and instant messaging <a href="#RFC4975">[RFC4975]</a>. For these protocols to work in the presence of NAT, unless they define their own NAT traversal mechanisms, ICE support for TCP is needed. In addition, RTP can also run over TCP <a href="#RFC4571">[RFC4571]</a>. Typically, it is preferable to run RTP over UDP, and not TCP. However, in a variety of network environments, overly restrictive NAT and firewall devices prevent UDP-based communications altogether, but general TCP-based communications are permitted. In such environments, sending RTP over TCP, and thus establishing the media session, may be preferable to having it fail altogether. With this specification, agents can gather UDP and TCP candidates for a media stream, list the UDP ones with higher priority, and then only use the TCP-based ones if the UDP ones fail. This provides a fallback mechanism that allows multimedia communications to be highly reliable. </p>
<p id="rfc.section.1.p.3">The usage of RTP over TCP is particularly useful when combined with Traversal Using Relays around NAT (TURN) <a href="#RFC5766">[RFC5766]</a>. In this case, one of the agents would connect to its TURN server using TCP, and obtain a TCP-based relayed candidate. It would offer this to its peer agent as a candidate. The answerer would initiate a TCP connection towards the TURN server. When that connection is established, media can flow over the connections, through the TURN server. The benefit of this usage is that it only requires the agents to make outbound TCP connections to a server on the public network. This kind of operation is broadly interoperable through NAT and firewall devices. Since it is a goal of ICE and this extension to provide highly reliable communications that "just works" in as broad set of network deployments as possible, this use case is particularly important. </p>
<p id="rfc.section.1.p.4">This specification extends ICE by defining its usage with TCP candidates. It also defines how ICE can be used with RTP and Secure RTP (SRTP) to provide both TCP and UDP candidates. This specification does so by following the outline of ICE itself, and calling out the additions and changes necessary in each section of ICE to support TCP candidates. </p>
<p id="rfc.section.1.p.5">It should be noted that since TCP NAT traversal is more complicated than with UDP, ICE TCP is not in general as efficient as UDP-based ICE. Discussion about this topic can be found in <a href="#limitations">Appendix Appendix A</a>. </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Terminology</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119 <a href="#RFC2119">[RFC2119]</a>. </p>
<p id="rfc.section.2.p.2">This document uses the same terminology as ICE (see Section 3 of <a href="#RFC5245">[RFC5245]</a>). </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Overview of Operation</h1>
<p id="rfc.section.3.p.1">The usage of ICE with TCP is relatively straightforward. The main area of specification is around how and when connections are opened, and how those connections relate to candidate pairs. </p>
<p id="rfc.section.3.p.2">When the agents perform address allocations to gather TCP-based candidates, three types of candidates can be obtained. These are active candidates, passive candidates, and simultaneous-open (S-O) candidates. An active candidate is one for which the agent will attempt to open an outbound connection, but will not receive incoming connection requests. A passive candidate is one for which the agent will receive incoming connection attempts, but not attempt a connection. S-O candidate is one for which the agent will attempt to open a connection simultaneously with its peer. </p>
<p id="rfc.section.3.p.3">When gathering candidates from a host interface, the agent typically obtains active, passive, and S-O candidates.  Similarly, one can use different techniques for obtaining, e.g., server reflexive, NAT-assisted, tunneled, or relayed candidates of these three types (see <a href="#cand-collection">Section 5</a>).  Connections to servers used for relayed and server reflexive candidates are kept open during ICE processing. </p>
<p id="rfc.section.3.p.4">When encoding these candidates into offers and answers, the type of the candidate is signaled. In the case of active candidates, an IP address and port is present, but the port is meaningless, as it is ignored by the peer. As a consequence, active candidates do not need to be physically allocated at the time of address gathering. Rather, the physical allocations, which occur as a consequence of a connection attempt, occur at the time of the connectivity checks. </p>
<p id="rfc.section.3.p.5">When the candidates are paired together, active candidates are always paired with passive, and S-O candidates with each other. When a connectivity check is to be made on a candidate pair, each agent determines whether it is to make a connection attempt for this pair. </p>
<p id="rfc.section.3.p.6">The actual process of generating connectivity checks, managing the state of the check list, and updating the Valid list, work identically for TCP as they do for UDP. </p>
<p id="rfc.section.3.p.7">ICE requires an agent to demultiplex STUN and application layer traffic, since they appear on the same port. This demultiplexing is described in <a href="#RFC5245">[RFC5245]</a>, and is done using the magic cookie and other fields of the message.  Stream-oriented transports introduce another wrinkle, since they require a way to frame the connection so that the application and STUN packets can be extracted in order to determine which is which. For this reason, TCP media streams utilizing ICE use the basic framing provided in RFC 4571 <a href="#RFC4571">[RFC4571]</a>, even if the application layer protocol is not RTP. </p>
<p id="rfc.section.3.p.8">When TLS or DTLS is used, they are also run over the RFC 4571 framing shim, while STUN runs outside of the (D)TLS connection. The resulting ICE TCP protocol stack is shown in <a href="#fig-icetcp">Figure 1</a>; with (D)TLS on the left side and without it on the right side. </p>
<div id="#rfc.figure.1"></div>
<div id="#fig-icetcp"></div>
<pre>
           +----------+
           |          |
           |    App   |
+----------+----------+     +----------+----------+
|          |          |     |          |          |
|   STUN   |  (D)TLS  |     |   STUN   |    App   |
+----------+----------+     +----------+----------+
|                     |     |                     |
|      RFC 4571       |     |      RFC 4571       |
+---------------------+     +---------------------+
|                     |     |                     |
|         TCP         |     |         TCP         |
+---------------------+     +---------------------+
|                     |     |                     |
|         IP          |     |         IP          |
+---------------------+     +---------------------+   
</pre>
<p id="rfc.section.3.p.9">The implication of this is that, for any media stream protected by (D)TLS, the agent will first run ICE procedures, exchanging STUN messages. Then, once ICE completes, (D)TLS procedures begin. ICE and (D)TLS are thus "peers" in the protocol stack. The STUN messages are not sent over the (D)TLS connection, even ones sent for the purposes of keepalive in the middle of the media session. </p>
<p id="rfc.section.3.p.10">When an updated offer is generated by the controlling endpoint, the Session Description Protocol (SDP) extensions for connection oriented media <a href="#RFC4145">[RFC4145]</a> are used to signal that an existing connection should be used, rather than opening a new one. </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#sec-sending-init-offer" id="sec-sending-init-offer">Sending the Initial Offer</a>
</h1>
<p id="rfc.section.4.p.1">For offerers making use of ICE for TCP streams, the procedures below are used. Main differences compared to UDP candidates are the new methods for gathering candidates, how TCP candidates are prioritized, and how they are encoded in the SDP offer and answer. </p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#sec-gather" id="sec-gather">Gathering Candidates</a>
</h1>
<p id="rfc.section.4.1.p.1">Providers of real-time communications services may decide that it is preferable to have no media at all than it is to have media over TCP. To allow for choice, it is RECOMMENDED that agents be configurable with whether they obtain TCP candidates for real time media. </p>
<p></p>

<ul class="empty"><li>Having it be configurable, and then configuring it to be off, is far better than not having the capability at all. An important goal of this specification is to provide a single mechanism that can be used across all types of endpoints. As such, it is preferable to account for provider and network variation through configuration, instead of hard-coded limitations in an implementation. Besides, network characteristics and connectivity assumptions can, and will change over time. Just because an agent is communicating with a server on the public network today, doesn't mean that it won't need to communicate with one behind a NAT tomorrow. Just because an agent is behind a NAT with endpoint-independent mapping today, doesn't mean that tomorrow they won't pick up their agent and take it to a public network access point where there is a NAT with address and port-dependent mapping properties, or one that only allows outbound TCP. The way to handle these cases and build a reliable system is for agents to implement a diverse set of techniques for allocating addresses, so that at least one of them is almost certainly going to work in any situation. Implementors should consider very carefully any assumptions that they make about deployments before electing not to implement one of the mechanisms for address allocation. In particular, implementors should consider whether the elements in the system may be mobile, and connect through different networks with different connectivity. They should also consider whether endpoints which are under their control, in terms of location and network connectivity, would always be under their control. In environments where mobility and user control are possible, a multiplicity of techniques is essential for reliability.  </li></ul>
<p id="rfc.section.4.1.p.3">First, agents SHOULD obtain host candidates as described in <a href="#host-candidates">Section 5.1</a>. Then, each agent SHOULD "obtain" (allocate a placeholder for) an active host candidate for each component of each TCP-capable media stream on each interface that the host has. The agent does not have to yet actually allocate a port for these candidates, but they are used for the creation of the check lists. </p>
<p id="rfc.section.4.1.p.4">The agent SHOULD then obtain server reflexive, NAT-assisted, and/or UDP-tunneled candidates (see <a href="#server-reflexive">Section 5.2</a>, <a href="#nat-assisted">Section 5.3</a>, and <a href="#udp-tunneled">Section 5.4</a>).  The mechanisms for establishing these candidates and the number of candidates to collect vary from technique to technique.  These considerations are discussed in the relevant sections. </p>
<p id="rfc.section.4.1.p.5">Next, the agents SHOULD obtain passive (and possibly S-O) relayed candidates for each component as described in <a href="#relayed-cands">Section 5.5</a>. Each agent SHOULD also allocate a placeholder for an active relayed candidate for each component of each TCP-capable media stream. </p>
<p id="rfc.section.4.1.p.6">It is highly recommended that a host obtains at least one set of host and one set of relayed candidates.  Obtaining additional candidates will increase the chance of successfully creating a direct connection. </p>
<p id="rfc.section.4.1.p.7">Once the candidates have been obtained, the agent MUST keep the TCP connections open until ICE processing has completed. See <a href="#sec-impl">Appendix Appendix B</a> for important implementation guidelines. </p>
<p id="rfc.section.4.1.p.8">If a media stream is UDP-based (such as RTP), an agent MAY use an additional host TCP candidate to request a UDP-based candidate from a TURN server (or some other relay with similar functionality). Usage of such UDP candidates follows the procedures defined in ICE for UDP candidates. </p>
<p id="rfc.section.4.1.p.9">Like its UDP counterparts, TCP-based STUN transactions are paced out at one every Ta seconds. This pacing refers strictly to STUN transactions (both Binding and Allocate requests). If performance of the transaction requires establishment of a TCP connection, then the connection gets opened when the transaction is performed. </p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#priority" id="priority">Prioritization</a>
</h1>
<p id="rfc.section.4.2.p.1">The transport protocol itself is a criteria for choosing one candidate over another. If a particular media stream can run over UDP or TCP, the UDP candidates might be preferred over the TCP candidates.  This allows ICE to use the lower latency UDP connectivity if it exists, but fallback to TCP if UDP doesn't work. </p>
<p id="rfc.section.4.2.p.2">In Section 4.1.2.1. of <a href="#RFC5245">[RFC5245]</a> a recommended formula for UDP ICE candidate prioritization is defined. For the TCP candidates the same formula and candidate type preferences SHOULD be used and the RECOMMENDED type preferences for the new candidate types defined in this document (see <a href="#cand-collection">Section 5</a>) are 105 for NAT-assisted candidates and 75 for UDP-tunneled candidates. </p>
<p id="rfc.section.4.2.p.3">When both UDP and TCP candidates are offered for the same media stream, and one transport protocol should be preferred over the other, the type preferences for the preferred transport protocol candidates SHOULD be increased and/or the type preferences for the other transport protocol candidates SHOULD be decreased. How much the values should be increased or decreased depends on whether it is more important to choose certain transport protocol or certain candidate type. If the candidate type is more important (e.g., even if UDP is preferred, TCP host candidates are preferred over UDP server reflexive candidates) changing type preference values by one for the other transport protocol candidates is enough. On the other hand, if the transport protocol is more important (e.g., any UDP candidate is preferred over any TCP candidate) all the preferred transport protocol candidates SHOULD have type preference higher than the other transport protocol candidates.  However, it is RECOMMENDED that the relayed candidates are still preferred lower than the other candidate types. For RTP-based media streams, it is RECOMMENDED that UDP candidates are preferred over TCP candidates. </p>
<div id="#rfc.figure.2"></div>
<pre>
   local preference = (2^13) * direction-pref + other-pref
        </pre>
<p id="rfc.section.4.2.p.4">With TCP candidates the local preference part of the recommended priority formula is updated to include also the directionality (active, passive, or simultaneous-open) of the TCP connection. The RECOMMENDED local preference is then defined as: </p>
<p></p>

<ul class="empty"><li>The preference priorities listed here are simply recommendations that try to strike a balance between success probability and resulting path's efficiency. Depending on the scenario where ICE TCP is used, different values may be appropriate. For example, if the overhead of a UDP tunnel is not an issue, those candidates should be prioritized higher since they are likely to have a high success probability. Also, simultaneous-open is prioritized higher than active and passive candidates for NAT-assisted and server reflexive candidates since if TCP S-O is supported by the operating systems of both endpoints, it should work at least as well as the act-pass approach. If an implementation is uncertain whether S-O candidates are supported, it may be reasonable to prioritize them lower. For host, UDP-tunneled, and relayed candidates the S-O candidates are prioritized lower than active and passive since act-pass candidates should work with them at least as well as the S-O candidates. </li></ul>
<p id="rfc.section.4.2.p.6">If any two candidates have the same type-preference and direction-pref, they MUST have a unique other-pref.  With this specification, this usually only happens with multi-homed hosts, in which case other-pref is the preference for the particular IP address from which the candidate was obtained. When there is only a single IP address, this value SHOULD be set to the maximum allowed value (8191). </p>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#default-cands" id="default-cands">Choosing Default Candidates</a>
</h1>
<p id="rfc.section.4.3.p.1">The default candidate is chosen primarily based on the likelihood of it working with a non-ICE peer. When media streams supporting mixed modes (both TCP and UDP) are used with ICE, it is RECOMMENDED that, for real-time streams (such as RTP), the default candidates be UDP-based.  However, the default SHOULD NOT be a simultaneous-open candidate. </p>
<p id="rfc.section.4.3.p.2">If a media stream is inherently TCP-based, it is RECOMMENDED for an offering full agent to select an active candidate as the default candidate and use <a href="#RFC4145">[RFC4145]</a> "setup" attribute value "active". This increases the chances for a successful NAT traversal even without ICE support if the agent is behind a NAT and the peer is not. For the same reason, for a lite agent, it is RECOMMENDED to use a passive candidate and "setup" attribute value "passive" in the offer. </p>
<h1 id="rfc.section.4.4">
<a href="#rfc.section.4.4">4.4.</a> <a href="#lite-reqs" id="lite-reqs">Lite Implementation Requirements</a>
</h1>
<p id="rfc.section.4.4.p.1">If an offerer meets the criteria for the lite mode as described in Appendix A of <a href="#RFC5245">[RFC5245]</a> (i.e., it will always have a public, globally unique IP address), it MAY use the lite mode of ICE also for TCP candidates.  In the lite mode, for the TCP candidates, only passive host candidates are gathered; unless active candidates are needed as the default candidates. Otherwise the procedures described for lite mode in <a href="#RFC5245">[RFC5245]</a> apply also to TCP candidates. If UDP and TCP candidates are mixed in a media stream, the mode (lite or full) applies to both UDP and TCP candidates. </p>
<h1 id="rfc.section.4.5">
<a href="#rfc.section.4.5">4.5.</a> <a href="#tcp-sdp-encoding" id="tcp-sdp-encoding">Encoding the SDP</a>
</h1>
<p id="rfc.section.4.5.p.1">TCP-based candidates are encoded into a=candidate lines like the UDP candidates described in <a href="#RFC5245">[RFC5245]</a>. However, the transport protocol (i.e., value of the transport-extension token defined in <a href="#RFC5245">[RFC5245]</a> Section 15.1) is set to "TCP" and the connection type (active, passive, or S-O) is encoded using a new extension attribute. With TCP candidates, the candidate-attribute syntax with Augmented BNF <a href="#RFC5234">[RFC5234]</a> is then: </p>
<div id="#rfc.figure.3"></div>
<pre>
candidate-attribute   = "candidate" ":" foundation SP component-id SP
                        "TCP" SP
                        priority SP
                        connection-address SP
                        port SP
                        cand-type
                        [SP rel-addr]
                        [SP rel-port]
                        SP tcp-type-ext
                        *(SP extension-att-name SP
                             extension-att-value)

tcp-type-ext          = "tcptype" SP tcp-type
tcp-type              = "act" / "pass" / "so"
</pre>
<p id="rfc.section.4.5.p.2">The connection-address encoded into the candidate attribute for active candidates MUST be set to the IP address that will be used for the attempt, but the port(s) MUST be set to 9 (i.e., Discard). For active relayed candidates, the value for connection-address MUST be identical to the IP address of a passive or simultaneous-open candidate from the same relay server. </p>
<p id="rfc.section.4.5.p.3">If the default candidate is TCP-based, the agent MUST include the a=setup and a=connection attributes from RFC 4145 <a href="#RFC4145">[RFC4145]</a>, following the procedures defined there as if ICE was not in use. In particular, if an agent is the answerer, the a=setup attribute MUST meet the constraints in RFC 4145 based on the value in the offer. </p>
<p id="rfc.section.4.5.p.4">If an agent is utilizing SRTP <a href="#RFC3711">[RFC3711]</a>, it MAY include a mix of UDP and TCP candidates. If ICE selects a TCP candidate pair, the agent MUST still utilize SRTP, but run it over the connection established by ICE. The alternative, RTP over TLS, MUST NOT be used. This allows for the higher layer protocols (the security handshakes and media transport) to be independent of the underlying transport protocol. In the case of DTLS-SRTP <a href="#RFC5764">[RFC5764]</a>, the directionality attributes (a=setup) are utilized strictly to determine the direction of the DTLS handshake. Directionality of the TCP connection establishment are determined by the ICE attributes and procedures defined here. </p>
<p id="rfc.section.4.5.p.5">If an agent is securing non-RTP media over TCP/TLS, the SDP MUST be constructed as described in RFC 4572 <a href="#RFC4572">[RFC4572]</a>. The directionality attributes (a=setup) are utilized strictly to determine the direction of the TLS handshake. Directionality of the TCP connection establishment are determined by the ICE attributes and procedures defined here. </p>
<p id="rfc.section.4.5.p.6">Examples of SDP offers and answers with ICE TCP extensions are shown in <a href="#sdp-examples">Appendix Appendix C</a>.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#cand-collection" id="cand-collection">Candidate Collection Techniques</a>
</h1>
<p id="rfc.section.5.p.1">The following sections discuss a number of techniques that can be used to obtain candidates for use with ICE TCP.  It is important to note that this list is not intended to be exhaustive, nor is implementation of any specific technique beyond host candidates (<a href="#host-candidates">Section 5.1</a>) considered mandatory. </p>
<p id="rfc.section.5.p.2">Implementors are encouraged to implement as many of the following techniques from the following list as is practical, as well as to explore additional NAT-traversal techniques beyond those discussed in this document. However, to get a reasonable success ratio, one SHOULD implement at least one relayed technique (e.g., TURN) and one technique for discovering the address given for the host by a NAT (e.g., STUN). </p>
<p id="rfc.section.5.p.3">To increase the success probability with the techniques described below and to aid with transition to IPv6, implementors SHOULD take particular care to include both IPv4 and IPv6 candidates as part of the process of gathering candidates.  If the local network or host does not support IPv6 addressing, then clients SHOULD make use of other techniques, e.g., TURN-IPv6 <a href="#RFC6156">[RFC6156]</a>, Teredo <a href="#RFC4380">[RFC4380]</a> or SOCKS IPv4-IPv6 gatewaying <a href="#RFC3089">[RFC3089]</a>, for obtaining IPv6 candidates. </p>
<p id="rfc.section.5.p.4">While implementations SHOULD support as many techniques as feasible, they SHOULD also consider which of them to use if multiple options are available. Since different candidates are paired with each other, offering a large amount of candidates results in a large checklist and potentially long lasting connectivity checks. For example, using multiple NAT-assisted techniques with the same NAT usually results only in redundant candidates. Similarly, out of multiple different UDP tunneling or relaying techniques using just one is often enough. </p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#host-candidates" id="host-candidates">Host Candidates</a>
</h1>
<p id="rfc.section.5.1.p.1">Host candidates are the most simple candidates since they only require opening TCP sockets on the host's interfaces and sending/receiving connectivity checks from them. However, if the hosts are behind different NATs, host candidates usually fail to work. On the other hand, if there are no NATs between the hosts, host candidates are the most efficient method since they require no additional NAT traversal protocols or techniques. </p>
<p id="rfc.section.5.1.p.2">For each TCP-capable media stream the agent wishes to use (including ones, like RTP, which can either be UDP or TCP), the agent SHOULD obtain two host candidates (each on a different port) for each component of the media stream on each interface that the host has - one for the simultaneous-open, and one for the passive candidate.  If an agent is not capable of acting in one of these modes it would omit those candidates. </p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#server-reflexive" id="server-reflexive">Server Reflexive Candidates</a>
</h1>
<p id="rfc.section.5.2.p.1">Server reflexive techniques aim to discover the address a NAT has given for the host by asking that from a server on the other side of the NAT and then creating proper bindings (unless such already exist) on the NATs with connectivity checks sent between the hosts. Success of these techniques depends on the NATs' mapping and filtering behavior <a href="#RFC5382">[RFC5382]</a> and also whether the NATs and hosts support the TCP simultaneous-open technique. </p>
<p id="rfc.section.5.2.p.2">Obtaining server reflexive passive candidates may require initiating connections from host's passive candidates; see <a href="#sec-impl">Appendix Appendix B</a> for implementation details on this. Server reflexive active candidates can be derived from passive or S-O candidates by using the same IP address as a passive or S-O server reflexive candidate from the same interface has. It is useful to obtain both server reflexive passive and S-O candidates since it depends on the hosts and NATs which one actually works better. Furthermore, some techniques (e.g., TURN relaying) require knowing the IP address of the peer's active candidates beforehand, so also active server reflexive candidates are needed for such techniques to function properly. </p>
<p id="rfc.section.5.2.p.3">A widely used protocol for obtaining server reflexive candidates is STUN, whose TCP-specific behavior is described in <a href="#RFC5389">[RFC5389]</a> Section 7.2.2. </p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> <a href="#nat-assisted" id="nat-assisted">NAT-Assisted Candidates</a>
</h1>
<p id="rfc.section.5.3.p.1">NAT-assisted techniques communicate with the NATs directly and this way discover the address NAT has given to the host and also create proper bindings on the NATs. The benefit of these techniques over the server reflexive techniques is that the NATs can adjust their mapping and filtering behavior so that connections can be successfully created. A downside of NAT-assisted techniques is that they commonly allow communicating only with a NAT that is in the same subnet as the host and thus often fail in scenarios with multiple layers of NATs. These techniques also rely on NATs supporting the specific protocols and that the NATs allow the users to modify their behavior. </p>
<p id="rfc.section.5.3.p.2">These candidates are encoded in the ICE offer and answer like the server reflexive candidates but they (commonly) use a higher priority (as described in <a href="#priority">Section 4.2</a>) and hence are tested before the server reflexive candidates. </p>
<p id="rfc.section.5.3.p.3">Currently, the UPnP forum's Internet Gateway Device (IGD) protocol <a href="#UPnP-IGD">[UPnP-IGD]</a> and the NAT Port Mapping Protocol (PMP) <a href="#I-D.cheshire-nat-pmp">[I-D.cheshire-nat-pmp]</a> are widely supported NAT-assisted techniques. Other known protocols include Port Control Protocol (PCP) <a href="#I-D.ietf-pcp-base">[I-D.ietf-pcp-base]</a>, SOCKS <a href="#RFC1928">[RFC1928]</a>, Realm Specific IP (RSIP) <a href="#RFC3103">[RFC3103]</a>, and SIMCO <a href="#RFC4540">[RFC4540]</a>. Also, MIDCOM MIB <a href="#RFC5190">[RFC5190]</a> defines an SNMP-based mechanism for controlling NATs. </p>
<h1 id="rfc.section.5.4">
<a href="#rfc.section.5.4">5.4.</a> <a href="#udp-tunneled" id="udp-tunneled">UDP-Tunneled Candidates</a>
</h1>
<p id="rfc.section.5.4.p.1">UDP-tunneled NAT traversal techniques utilize the fact that UDP NAT traversal is simpler and more efficient than TCP NAT traversal. With these techniques, the TCP packets (or possibly complete IP packets) are encapsulated in UDP packets. Because of the encapsulation these techniques increase the overhead for the connection and may require support from both of the endpoints, but on the other hand UDP tunneling commonly results in reliable and fairly simple TCP NAT traversal. </p>
<p id="rfc.section.5.4.p.2">UDP-tunneled candidates can be encoded in the ICE offer and answer either as relayed or server reflexive candidates, depending on whether the tunneling protocol utilizes a relay between the hosts. The UDP-tunneled candidates may appear to applications as host candidates from a local pseudo-interface. Treating these candidates as host candidates results in incorrect prioritization and possibly non-optimal candidate selection.  Implementations may attempt to detect pseudo-interfaces, e.g., from the address prefix of the interface, but detection details vary from technique to technique. </p>
<p id="rfc.section.5.4.p.3">For example, the Teredo protocol <a href="#RFC4380">[RFC4380]</a> <a href="#RFC6081">[RFC6081]</a> provides automatic UDP tunneling and IPv6 interworking. The Teredo UDP tunnel is visible to the host application as an IPv6 address and thus Teredo candidates are encoded as IPv6 addresses. </p>
<h1 id="rfc.section.5.5">
<a href="#rfc.section.5.5">5.5.</a> <a href="#relayed-cands" id="relayed-cands">Relayed Candidates</a>
</h1>
<p id="rfc.section.5.5.p.1">Relaying packets through a relay server is often the NAT traversal technique that has the highest success probability: communicating via a relay that is in the public Internet looks like normal client-server communication for the NATs and that is supported in practice by all existing NATs, regardless of their filtering and mapping behavior.  However, using a relay has several drawbacks, e.g., it usually results in a sub-optimal path for the packets, the relay needs to exist and it needs to be discovered, the relay is a possible single point of failure, relaying consumes potentially a lot of resources of the relay server, etc. Therefore, relaying is often used as the last resort when no direct path can be created with other NAT traversal techniques. </p>
<p id="rfc.section.5.5.p.2">With relayed candidates the host commonly needs to obtain only a passive candidate since any of the peer's server reflexive (and NAT-assisted if the peer can communicate with the outermost NAT) active candidates should work with the passive relayed candidate. However, if the relay is behind a NAT or a firewall, using also active and S-O candidates will increase success probability. </p>
<p id="rfc.section.5.5.p.3">Relaying protocols capable of relaying TCP connections include TURN TCP <a href="#RFC6062">[RFC6062]</a> and SOCKS <a href="#RFC1928">[RFC1928]</a> (which can also be used for IPv4-IPv6 gatewaying <a href="#RFC3089">[RFC3089]</a>). It is also possible to use, e.g., an SSH <a href="#RFC4251">[RFC4251]</a> tunnel as a relayed candidate if a suitable server is available and the server permits this. </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> Receiving the Initial Offer and Answer</h1>
<p id="rfc.section.6.p.1">Handling an ICE offer with TCP candidates works in a similar way as with UDP candidates. First, ICE support is verified (including the check for ice-mismatch described in Section 5.1 of <a href="#RFC5245">[RFC5245]</a>) and agent roles are determined.  Candidates are gathered using the techniques described in <a href="#cand-collection">Section 5</a> and prioritized as described in <a href="#priority">Section 4.2</a>. Default candidates are selected taking into account considerations of <a href="#default-cands">Section 4.3</a>. The SDP answer is encoded as in Section 4.3 of <a href="#RFC5245">[RFC5245]</a> with the exception of TCP candidates whose encoding was described in <a href="#tcp-sdp-encoding">Section 4.5</a>. </p>
<p id="rfc.section.6.p.2">When the offerer receives the initial answer, it also verifies ICE support and determines its role. If both of the agents use lite implementations, the offerer takes the controlling role and uses the procedures defined in <a href="#RFC4145">[RFC4145]</a> to select the most preferred candidate pair with a new offer. </p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> Considerations with Two Lite Agents</h1>
<p id="rfc.section.6.1.p.1">If both agents are using the lite mode, and if the offerer uses a=setup:active attribute <a href="#RFC4145">[RFC4145]</a> in the new offer, the offerer MAY initiate the TCP connection on the selected pair in parallel with the new offer to speedup the connection establishment. Consequently, the answerer MUST still accept incoming TCP connections to any of the passive candidates it listed in the answer, from any of the IP addresses the offerer listed in the initial offer. </p>
<p id="rfc.section.6.1.p.2">If the answerer receives the new offer matching to the candidate pair where connection was already created in parallel with the new offer, it MUST accept the offer and respond to it while keeping the already created connection. If the connection that was created in parallel with the new offer does not match to the candidate pair in the new offer, the connection MUST be closed and ICE restart SHOULD be performed. </p>
<p id="rfc.section.6.1.p.3">Since the connection endpoints are not authenticated using the connectivity checks in the scenario where both agents use the lite mode, unless media-level security (e.g., TLS) is used, it is RECOMMENDED to use the full mode instead. For more lite vs. full implementation considerations, see Appendix A of <a href="#RFC5245">[RFC5245]</a>. </p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> Forming the Check Lists</h1>
<p id="rfc.section.6.2.p.1">As with UDP, checklists are formed only by full ICE implementations. When forming candidate pairs, the following types of TCP candidates can be paired with each other: </p>
<div id="#rfc.figure.4"></div>
<pre>
Local             Remote
Candidate         Candidate
----------------------------
tcp-so            tcp-so
tcp-act           tcp-pass
tcp-pass          tcp-act
</pre>
<p id="rfc.section.6.2.p.2">When the agent prunes the check list, it MUST also remove any pair for which the local candidate is a passive TCP candidate. With pruning, the NAT-assisted candidates are treated like server reflexive candidates if the base is used also as a host candidate. </p>
<p id="rfc.section.6.2.p.3">The remainder of check list processing works like in the UDP case. </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> Connectivity Checks</h1>
<p id="rfc.section.7.p.1">The TCP connectivity checks, like with UDP, are generated only by full implementations. The TCP candidate pairs are in the same checklist with the UDP candidate pairs and they are scheduled for connectivity checks, as described in Section 5.8 in <a href="#RFC5245">[RFC5245]</a>, based on the priority order. </p>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> STUN Client Procedures</h1>
<p id="rfc.section.7.1.p.1">When an agent wants to send a TCP-based connectivity check, it first opens a TCP connection, if none yet exists, for the 5-tuple defined by the candidate pair for which the check is to be sent. This connection is opened from the local candidate of the pair to the remote candidate of the pair. If the local candidate is tcp-act, the agent MUST open a connection from the interface associated with that local candidate. This connection SHOULD be opened from an unallocated port. For host candidates, this is readily done by connecting from the local candidate's interface. For relayed, NAT-assisted, and UDP-tunneled candidates, the agent may need to use additional procedures specific to the protocol. </p>
<p id="rfc.section.7.1.p.2">Once the connection is established, the agent MUST utilize the shim defined in RFC 4571 <a href="#RFC4571">[RFC4571]</a> for the duration this connection remains open. The STUN Binding requests and responses are sent on top of this shim, so that the length field defined in RFC 4571 precedes each STUN message. If TLS or DTLS-SRTP is to be utilized for the media session, the TLS or DTLS-SRTP handshakes will take place on top of this shim as well. However, they only start once ICE processing has completed. In essence, the TLS or DTLS-SRTP handshakes are considered a part of the media protocol. STUN is never run within the TLS or DTLS-SRTP session. </p>
<p id="rfc.section.7.1.p.3">If the TCP connection cannot be established, the check is considered to have failed, and a full-mode agent MUST update the pair state to Failed in the check list. See Section 7.2.2 in <a href="#RFC5389">[RFC5389]</a> for more details on STUN over TCP.</p>
<p id="rfc.section.7.1.p.4">Once the connection is established, client procedures are identical to those for UDP candidates. However, retransmissions of the STUN connectivity check messages are not needed, since TCP takes care of reliable delivery of the messages. Note also that STUN responses received on an active TCP candidate will typically produce a peer reflexive candidate. If the response to the first connectivity check on the established TCP connection is something other than a STUN message, the remote candidate address apparently was not one of the peer's addresses and the agent SHOULD close the connection and consider all pairs with that remote candidate as failed. </p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> STUN Server Procedures</h1>
<p id="rfc.section.7.2.p.1">An ICE TCP agent, full or lite, MUST be prepared to receive incoming TCP connection requests on the base of any TCP candidate that is simultaneous-open or passive. When the connection request is received, the agent MUST accept it. The agent MUST utilize the framing defined in RFC 4571 <a href="#RFC4571">[RFC4571]</a> for the lifetime of this connection. Due to this framing, the agent will receive data in discrete frames. Each frame could be media (such as RTP or SRTP), TLS, DTLS, or STUN packets. The STUN packets are extracted as described in <a href="#sec-recvmedia">Section 10.2</a>. </p>
<p id="rfc.section.7.2.p.2">Once the connection is established, STUN server procedures are identical to those for UDP candidates. Note that STUN requests received on a passive TCP candidate will typically produce a remote peer reflexive candidate. </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Concluding ICE Processing</h1>
<p id="rfc.section.8.p.1">If there are TCP candidates for a media stream, a controlling agent MUST use the regular selection algorithm. </p>
<p id="rfc.section.8.p.2">When ICE processing for a media stream completes, each agent SHOULD close all TCP connections (that were opened due to this ICE session) except the ones between the candidate pairs selected by ICE. </p>
<p></p>

<ul class="empty"><li>These two rules are related; the closure of connection on completion of ICE implies that a regular selection algorithm has to be used. This is because aggressive selection might cause transient pairs to be selected. Once such a pair was selected, the agents would close the other connections, one of which may be about to be selected as a better choice. This race condition may result in TCP connections being accidentally closed for the pair that ICE selects. </li></ul>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> Subsequent Offer/Answer Exchanges</h1>
<h1 id="rfc.section.9.1">
<a href="#rfc.section.9.1">9.1.</a> ICE Restarts</h1>
<p id="rfc.section.9.1.p.1">If an ICE restart occurs for a media stream with TCP candidate pairs that have been selected by ICE, the agents MUST NOT close the connections after the restart. In the offer or answer that causes the restart, an agent MAY include a simultaneous-open candidate whose transport address matches the previously selected candidate. If both agents do this, the result will be a simultaneous-open candidate pair matching an existing TCP connection. In this case, the agents MUST NOT attempt to open a new connection (or start new TLS or DTLS-SRTP procedures). Instead, that existing connection is reused and STUN checks are performed. </p>
<p id="rfc.section.9.1.p.2">Once the restart completes, if the selected pair does not match the previously selected pair, the TCP connection for the previously selected pair SHOULD be closed by the agent. </p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> Media Handling</h1>
<h1 id="rfc.section.10.1">
<a href="#rfc.section.10.1">10.1.</a> Sending Media</h1>
<p id="rfc.section.10.1.p.1">When sending media, if the selected candidate pair matches an existing TCP connection, that connection MUST be used for sending media. </p>
<p id="rfc.section.10.1.p.2">The framing defined in RFC 4571 MUST be used when sending media. For media streams that are not RTP-based and do not normally use RFC 4571, the agent treats the media stream as a byte stream, and assumes that it has its own framing of some sort, if needed. It then takes an arbitrary number of bytes from the byte stream, and places that as a payload in the RFC 4571 frames, including the length. Next, the sender checks to see if the resulting set of bytes would be viewed as a STUN packet based on the rules in Sections 6 and 8 of <a href="#RFC5389">[RFC5389]</a>. This includes a check on the most significant two bits, the magic cookie, the length, and the fingerprint. If, based on those rules, the bytes would be viewed as a STUN message, the sender MUST utilize a different number of bytes so that the length checks will fail. Though it is normally highly unlikely that an arbitrary number of bytes from a byte stream would resemble a STUN packet based on all of the checks, it can happen if the content of the application stream happens to contain a STUN message (for example, a file transfer of logs from a client which includes STUN messages). </p>
<p id="rfc.section.10.1.p.3">If TLS or DTLS-SRTP procedures are being utilized to protect the media stream, those procedures start at the point that media is permitted to flow, as defined in the ICE specification <a href="#RFC5245">[RFC5245]</a>. The TLS or DTLS-SRTP handshakes occur on top of the RFC 4571 shim, and are considered part of the media stream for purposes of this specification. </p>
<h1 id="rfc.section.10.2">
<a href="#rfc.section.10.2">10.2.</a> <a href="#sec-recvmedia" id="sec-recvmedia">Receiving Media</a>
</h1>
<p id="rfc.section.10.2.p.1">The framing defined in RFC 4571 MUST be used when receiving media. For media streams that are not RTP-based and do not normally use RFC 4571, the agent extracts the payload of each RFC 4571 frame, and determines if it is a STUN or an application layer data based on the procedures in ICE <a href="#RFC5245">[RFC5245]</a>. If media is being protected with DTLS-SRTP, the DTLS, RTP and STUN packets are demultiplexed as described in Section 5.1.2 <a href="#RFC5764">[RFC5764]</a>. </p>
<p id="rfc.section.10.2.p.2">For non-STUN data, the agent appends this to the ongoing byte stream collected from the frames. It then parses the byte stream as if it had been directly received over the TCP connection. This allows for ICE TCP to work without regard to the framing mechanism used by the application layer protocol. </p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> Connection Management</h1>
<h1 id="rfc.section.11.1">
<a href="#rfc.section.11.1">11.1.</a> Connections Formed During Connectivity Checks</h1>
<p id="rfc.section.11.1.p.1">Once a TCP or TCP/TLS connection is opened by ICE for the purpose of connectivity checks, its life cycle depends on how it is used. If that candidate pair is selected by ICE for usage for media, an agent SHOULD keep the connection open until: </p>

<ul>
<li>The session terminates</li>
<li>The media stream is removed</li>
<li>An ICE restart takes place, resulting in the selection of a different candidate pair. </li>
</ul>

<p> In these cases, the agent SHOULD close the connection when that event occurs. This applies to both agents in a session, in which case usually one of the agents will end up closing the connection first. </p>
<p id="rfc.section.11.1.p.2">If a connection has been selected by ICE, an agent MAY close it anyway. As described in the next paragraph, this will cause it to be reopened almost immediately, and in the interim media cannot be sent. Consequently, such closures have a negative effect and are NOT RECOMMENDED. However, there may be cases where an agent needs to close a connection for some reason. </p>
<p id="rfc.section.11.1.p.3">If an agent needs to send media on the selected candidate pair, and its TCP connection has closed, either on purpose or due to some error, then:  </p>

<ul>
<li>If the agent's local candidate is tcp-act or tcp-so, it MUST reopen a connection to the remote candidate of the selected pair. </li>
<li>If the agent's local candidate is tcp-pass, the agent MUST await an incoming connection request, and consequently, will not be able to send media until it has been opened. </li>
</ul>

<p> If the TCP connection is established, the framing of RFC 4571 is utilized. If the agent opened the connection, and is a full agent, it MUST send a STUN connectivity check. An agent MUST be prepared to receive a connectivity check over a connection it opened or accepted (note that this is true in general; ICE requires that an agent be prepared to receive a connectivity check at any time, even after ICE processing completes). If a full agent receives a connectivity check after re-establishment of the connection, it MUST generate a triggered check over that connection in response if it has not already sent a check. Once an agent has sent a check and received a successful response, the connection is considered Valid and media can be sent (which includes a TLS or DTLS-SRTP session resumption or restart). </p>
<p id="rfc.section.11.1.p.4">If the TCP connection cannot be established, the controlling agent SHOULD restart ICE for this media stream. This will happen in cases where one of the agents is behind a NAT with connection-dependent mapping properties <a href="#RFC5382">[RFC5382]</a>. </p>
<h1 id="rfc.section.11.2">
<a href="#rfc.section.11.2">11.2.</a> Connections Formed for Gathering Candidates</h1>
<p id="rfc.section.11.2.p.1">If the agent opened a connection to a STUN server, or another similar server, for the purposes of gathering a server reflexive candidate, that connection SHOULD be closed by the client once ICE processing has completed. This happens irregardless of whether the candidate learned from the server was selected by ICE. </p>
<p id="rfc.section.11.2.p.2">If the agent opened a connection to a TURN server for the purposes of gathering a relayed candidate, that connection MUST be kept open by the client for the duration of the media session if a relayed candidate from the TURN server was selected by ICE. Otherwise, the connection to the TURN server SHOULD be closed once ICE processing completes. </p>
<p id="rfc.section.11.2.p.3">If, despite efforts of the client, a TCP connection to a TURN server fails during the lifetime of the media session utilizing a transport address allocated by that server, the client SHOULD reconnect to the TURN server, obtain a new allocation, and restart ICE for that media stream. Similar measures SHOULD apply also to other type of relaying servers. </p>
<h1 id="rfc.section.12">
<a href="#rfc.section.12">12.</a> Security Considerations</h1>
<p id="rfc.section.12.p.1">The main threat in ICE is hijacking of connections for the purposes of directing media streams to DoS targets or to malicious users. When full implementations are used, ICE TCP prevents that by only using TCP connections that have been validated. Validation requires a STUN transaction to take place over the connection. This transaction cannot complete without both participants knowing a shared secret exchanged in the rendezvous protocol used with ICE, such as SIP <a href="#RFC3261">[RFC3261]</a>. This shared secret, in turn, is protected by that protocol exchange. In the case of SIP, the usage of the SIPS <a href="#RFC3261">[RFC3261]</a> mechanism is RECOMMENDED. When this is done, an attacker, even if it knows or can guess the port on which an agent is listening for incoming TCP connections, will not be able to open a connection and send media to the agent. </p>
<p id="rfc.section.12.p.2">A STUN amplification attack is described in Section 18.5.2 of <a href="#RFC5245">[RFC5245]</a>. Same considerations apply to TCP, but the amplification effect with TCP is larger due to need for establishing a TCP connection before any checks are performed. Therefore, an ICE agent SHOULD NOT have more than 5 outstanding TCP connection attempts with the same peer to the same IP address. </p>
<p id="rfc.section.12.p.3">If both agents use the lite mode, no connectivity checks are sent, and additional procedures (e.g., media-level security) are needed to validate the connection. The lack of connectivity checks is especially problematic if one of the hosts is behind a NAT and has an address from a private address space: the peer may accidentally connect to a host in a different subnet that uses the same private address space. This is one of the reasons why the lite mode is not appropriate for an ICE agent located behind a NAT. </p>
<p id="rfc.section.12.p.4">A more detailed analysis of different attacks and the various ways ICE prevents them are described in <a href="#RFC5245">[RFC5245]</a>. Those considerations apply to this specification. </p>
<h1 id="rfc.section.13">
<a href="#rfc.section.13">13.</a> IANA Considerations</h1>
<div id="#rfc.figure.5"></div>
<pre>
Token   Reference
-----   ---------
TCP     RFC XXXX Section 4.5
</pre>
<p id="rfc.section.13.p.1">IANA is requested to create a new registry "Interactive Connectivity Establishment (ICE) Transport Extensions" for ICE candidate attribute transport extensions. Initial value is given below; future assignments are to be made through IETF Review or IESG Approval <a href="#RFC5226">[RFC5226]</a>. Assignments consist of an extension token (as defined in Section 15.1 of <a href="#RFC5245">[RFC5245]</a>) and a reference to the document defining the extension.  </p>
<h1 id="rfc.section.14">
<a href="#rfc.section.14">14.</a> Acknowledgements</h1>
<p id="rfc.section.14.p.1">The authors would like to thank Tim Moore, Saikat Guha, Francois Audet, Roni Even, Simon Perreault, Alfred Heggestad, Hadriel Kaplan, Jonathan Lennox, Flemming Andreasen, and Dan Wing for the reviews and input on this document. Special thanks to Marc Petit-Huguenin for providing the SDP examples. </p>
<h1 id="rfc.references">
<a href="#rfc.references">15.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">15.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3261">[RFC3261]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, <a>Schulzrinne, H.</a>, <a>Camarillo, G.</a>, <a>Johnston, A.</a>, <a>Peterson, J.</a>, <a>Sparks, R.</a>, <a>Handley, M.</a> and <a>E. Schooler</a>, "<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>", RFC 3261, June 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3264">[RFC3264]</b></td>
<td class="top">
<a>Rosenberg, J.</a> and <a>H. Schulzrinne</a>, "<a href="http://tools.ietf.org/html/rfc3264">An Offer/Answer Model with Session Description Protocol (SDP)</a>", RFC 3264, June 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3711">[RFC3711]</b></td>
<td class="top">
<a>Baugher, M.</a>, <a>McGrew, D.</a>, <a>Naslund, M.</a>, <a>Carrara, E.</a> and <a>K. Norrman</a>, "<a href="http://tools.ietf.org/html/rfc3711">The Secure Real-time Transport Protocol (SRTP)</a>", RFC 3711, March 2004.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4145">[RFC4145]</b></td>
<td class="top">
<a>Yon, D.</a> and <a>G. Camarillo</a>, "<a href="http://tools.ietf.org/html/rfc4145">TCP-Based Media Transport in the Session Description Protocol (SDP)</a>", RFC 4145, September 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4571">[RFC4571]</b></td>
<td class="top">
<a>Lazzaro, J.</a>, "<a href="http://tools.ietf.org/html/rfc4571">Framing Real-time Transport Protocol (RTP) and RTP Control Protocol (RTCP) Packets over Connection-Oriented Transport</a>", RFC 4571, July 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4572">[RFC4572]</b></td>
<td class="top">
<a>Lennox, J.</a>, "<a href="http://tools.ietf.org/html/rfc4572">Connection-Oriented Media Transport over the Transport Layer Security (TLS) Protocol in the Session Description Protocol (SDP)</a>", RFC 4572, July 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5226">[RFC5226]</b></td>
<td class="top">
<a>Narten, T.</a> and <a>H. Alvestrand</a>, "<a href="http://tools.ietf.org/html/rfc5226">Guidelines for Writing an IANA Considerations Section in RFCs</a>", BCP 26, RFC 5226, May 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5245">[RFC5245]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, "<a href="http://tools.ietf.org/html/rfc5245">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>", RFC 5245, April 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5234">[RFC5234]</b></td>
<td class="top">
<a>Crocker, D.</a> and <a>P. Overell</a>, "<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>", STD 68, RFC 5234, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5389">[RFC5389]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, <a>Mahy, R.</a>, <a>Matthews, P.</a> and <a>D. Wing</a>, "<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>", RFC 5389, October 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5764">[RFC5764]</b></td>
<td class="top">
<a>McGrew, D.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5764">Datagram Transport Layer Security (DTLS) Extension to Establish Keys for the Secure Real-time Transport Protocol (SRTP)</a>", RFC 5764, May 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5766">[RFC5766]</b></td>
<td class="top">
<a>Mahy, R.</a>, <a>Matthews, P.</a> and <a>J. Rosenberg</a>, "<a href="http://tools.ietf.org/html/rfc5766">Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)</a>", RFC 5766, April 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">15.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC1928">[RFC1928]</b></td>
<td class="top">
<a href="mailto:mleech@bnr.ca" title="Bell-Northern Research Ltd">Leech, M.</a>, <a title="International Business Machines">Ganis, M.</a>, <a title="NEC Systems Laboratory">Lee, Y.</a>, <a title="Unify Corporation">Kuris, R.</a>, <a title="Independent Consultant">Koblas, D.</a> and <a title="Hewlett-Packard Company">L. Jones</a>, "<a href="http://tools.ietf.org/html/rfc1928">SOCKS Protocol Version 5</a>", RFC 1928, March 1996.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3089">[RFC3089]</b></td>
<td class="top">
<a>Kitamura, H.</a>, "<a href="http://tools.ietf.org/html/rfc3089">A SOCKS-based IPv6/IPv4 Gateway Mechanism</a>", RFC 3089, April 2001.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3103">[RFC3103]</b></td>
<td class="top">
<a>Borella, M.</a>, <a>Grabelsky, D.</a>, <a>Lo, J.</a> and <a>K. Taniguchi</a>, "<a href="http://tools.ietf.org/html/rfc3103">Realm Specific IP: Protocol Specification</a>", RFC 3103, October 2001.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4251">[RFC4251]</b></td>
<td class="top">
<a>Ylonen, T.</a> and <a>C. Lonvick</a>, "<a href="http://tools.ietf.org/html/rfc4251">The Secure Shell (SSH) Protocol Architecture</a>", RFC 4251, January 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4380">[RFC4380]</b></td>
<td class="top">
<a>Huitema, C.</a>, "<a href="http://tools.ietf.org/html/rfc4380">Teredo: Tunneling IPv6 over UDP through Network Address Translations (NATs)</a>", RFC 4380, February 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4540">[RFC4540]</b></td>
<td class="top">
<a>Stiemerling, M.</a>, <a>Quittek, J.</a> and <a>C. Cadar</a>, "<a href="http://tools.ietf.org/html/rfc4540">NEC's Simple Middlebox Configuration (SIMCO) Protocol Version 3.0</a>", RFC 4540, May 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4975">[RFC4975]</b></td>
<td class="top">
<a>Campbell, B.</a>, <a>Mahy, R.</a> and <a>C. Jennings</a>, "<a href="http://tools.ietf.org/html/rfc4975">The Message Session Relay Protocol (MSRP)</a>", RFC 4975, September 2007.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5190">[RFC5190]</b></td>
<td class="top">
<a>Quittek, J.</a>, <a>Stiemerling, M.</a> and <a>P. Srisuresh</a>, "<a href="http://tools.ietf.org/html/rfc5190">Definitions of Managed Objects for Middlebox Communication</a>", RFC 5190, March 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5382">[RFC5382]</b></td>
<td class="top">
<a>Guha, S.</a>, <a>Biswas, K.</a>, <a>Ford, B.</a>, <a>Sivakumar, S.</a> and <a>P. Srisuresh</a>, "<a href="http://tools.ietf.org/html/rfc5382">NAT Behavioral Requirements for TCP</a>", BCP 142, RFC 5382, October 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6062">[RFC6062]</b></td>
<td class="top">
<a>Perreault, S.</a> and <a>J. Rosenberg</a>, "<a href="http://tools.ietf.org/html/rfc6062">Traversal Using Relays around NAT (TURN) Extensions for TCP Allocations</a>", RFC 6062, November 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6081">[RFC6081]</b></td>
<td class="top">
<a>Thaler, D.</a>, "<a href="http://tools.ietf.org/html/rfc6081">Teredo Extensions</a>", RFC 6081, January 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6156">[RFC6156]</b></td>
<td class="top">
<a>Camarillo, G.</a>, <a>Novo, O.</a> and <a>S. Perreault</a>, "<a href="http://tools.ietf.org/html/rfc6156">Traversal Using Relays around NAT (TURN) Extension for IPv6</a>", RFC 6156, April 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-pcp-base">[I-D.ietf-pcp-base]</b></td>
<td class="top">
<a>Wing, D</a>, <a>Cheshire, S</a>, <a>Boucadair, M</a>, <a>Penno, R</a> and <a>P Selkirk</a>, "<a href="http://tools.ietf.org/html/draft-ietf-pcp-base-17">Port Control Protocol (PCP)</a>", Internet-Draft draft-ietf-pcp-base-17, October 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.cheshire-nat-pmp">[I-D.cheshire-nat-pmp]</b></td>
<td class="top">
<a>Cheshire, S</a>, "<a href="http://tools.ietf.org/html/draft-cheshire-nat-pmp-03">NAT Port Mapping Protocol (NAT-PMP)</a>", Internet-Draft draft-cheshire-nat-pmp-03, April 2008.</td>
</tr>
<tr>
<td class="reference"><b id="UPnP-IGD">[UPnP-IGD]</b></td>
<td class="top">
<a>Warrier, U.</a>, <a>Iyer, P.</a>, <a>Pennerath, F.</a>, <a>Marynissen, G.</a>, <a>Schmitz, M.</a>, <a>Siddiqi, W.</a> and <a>M. Blaszczak</a>, "<a>Internet Gateway Device (IGD) Standardized Device Control Protocol V 1.0</a>", November 2001.</td>
</tr>
<tr>
<td class="reference"><b id="IMC05">[IMC05]</b></td>
<td class="top">
<a title="Cornell University">Guha, S.</a> and <a title="Cornell University">P. Francis</a>, "<a>Characterization and Measurement of TCP Traversal through NATs and Firewalls</a>",  Proceedings of the 5th ACM SIGCOMM conference on Internet Measurement, 2005.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> <a href="#limitations" id="limitations">Limitations of ICE TCP</a>
</h1>
<p id="rfc.section.Appendix A.p.1">Compared to UDP-based ICE, ICE TCP has in general lower success probability for enabling connectivity without a relay if both of the hosts are behind a NAT. This happens because many of the currently deployed NATs have endpoint-dependent mapping behavior or they do not support the flow of TCP handshake packets seen in case of TCP simultaneous-open: e.g., some NATs do not allow incoming TCP SYN packets from an address where a SYN packet has been sent to recently or the subsequent SYN-ACK is not processed properly. </p>
<p id="rfc.section.Appendix A.p.2">It has been reported in <a href="#IMC05">[IMC05]</a> that with the population of NATs deployed at the time of the measurements (2005), one of the NAT traversal techniques described here, TCP simultaneous-open, worked in roughly 45% of the cases. Also, all operating systems do not implement TCP simultaneous-open properly and thus are not able to use such candidates. However, when more NATs comply with the requirements set by <a href="#RFC5382">[RFC5382]</a> and operating system TCP stacks are fixed, the success probability of simultaneous-open is likely to increase. Also, it is important to implement additional techniques with higher success ratio, such as Teredo, whose success in different scenarios is described in Figure 1 of <a href="#RFC6081">[RFC6081]</a>.  </p>
<p id="rfc.section.Appendix A.p.3">Finally, it should be noted that implementing various techniques listed in <a href="#cand-collection">Section 5</a> should increase the success probability, but many of these techniques require support from the endpoints and/or from some network elements (e.g., from the NATs). Without comprehensive experimental data on how well different techniques are supported the actual increase of success probability is hard to evaluate. </p>
<h1 id="rfc.appendix.Appendix B">
<a href="#rfc.appendix.Appendix%20B">Appendix B.</a> <a href="#sec-impl" id="sec-impl">Implementation Considerations for BSD Sockets</a>
</h1>
<p id="rfc.section.Appendix B.p.1">This specification requires unusual handling of TCP connections, the implementation of which in traditional BSD socket APIs is non-trivial.  </p>
<p id="rfc.section.Appendix B.p.2">In particular, ICE requires an agent to obtain a local TCP candidate, bound to a local IP and port, and then from that local port, initiate a TCP connection (e.g., to the STUN server, in order to obtain server reflexive candidates, to the TURN server, to obtain a relayed candidate, or to the peer as part of a connectivity check), and be prepared to receive incoming TCP connections (for passive and simultaneous-open candidates). A "typical" BSD socket is used either for initiating or receiving connections, and not for both. The code required to allow incoming and outgoing connections on the same local IP and port is non-obvious. The following pseudocode, contributed by Saikat Guha, has been found to work on many platforms: </p>
<div id="#rfc.figure.6"></div>
<pre>
for i in 0 to MAX
   sock_i = socket()
   set(sock_i, SO_REUSEADDR)
   bind(sock_i, local)

listen(sock_0)
connect(sock_1, stun)
connect(sock_2, remote_a)
connect(sock_3, remote_b)</pre>
<p id="rfc.section.Appendix B.p.3">The key here is that, prior to the listen() call, the full set of sockets that need to be utilized for outgoing connections must be allocated and bound to the local IP address and port. This number, MAX, represents the maximum number of TCP connections to different destinations that might need to be established from the same local candidate. This number can be potentially large for simultaneous-open candidates. If a request forks, ICE procedures may take place with multiple peers. Furthermore, for each peer, connections would need to be established to each passive or simultaneous-open candidate for the same component. If we assume a worst case of 5 forked branches, and for each peer, five simultaneous-open candidates, that results in MAX=25. </p>
<h1 id="rfc.appendix.Appendix C">
<a href="#rfc.appendix.Appendix%20C">Appendix C.</a> <a href="#sdp-examples" id="sdp-examples">SDP Examples</a>
</h1>
<p id="rfc.section.Appendix C.p.1">This section shows two examples of SDP offer and answer when the ICE TCP extension is used. Both examples are based on the simplified topology of Figure 8 in <a href="#RFC5245">[RFC5245]</a>, with the same IP addresses. The examples shown here should be considered as strictly informative. </p>
<p id="rfc.section.Appendix C.p.2">In the first example, the offer contains only TCP candidates (lines folded in examples to satisfy RFC formatting rules):</p>
<div id="#rfc.figure.7"></div>
<pre>
v=0
o=jdoe 2890844526 2890842807 IN IP4 10.0.1.1
s= 
c=IN IP4 192.0.2.3
t=0 0
a=ice-pwd:asd88fgpdd777uzjYhagZg
a=ice-ufrag:8hhY
m=audio 45664 TCP/RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=setup:active
a=connection:new
a=candidate:1 1 TCP 2128609279 10.0.1.1 9 typ host tcptype act
a=candidate:2 1 TCP 2124414975 10.0.1.1 8998 typ host tcptype pass
a=candidate:3 1 TCP 2120220671 10.0.1.1 8999 typ host tcptype so
a=candidate:4 1 TCP 1688207359 192.0.2.3 9 typ srflx raddr 10.0.1.1
  rport 9 tcptype act
a=candidate:5 1 TCP 1684013055 192.0.2.3 45664 typ srflx raddr
  10.0.1.1 rport 8998 tcptype pass
a=candidate:6 1 TCP 1692401663 192.0.2.3 45687 typ srflx raddr
  10.0.1.1 rport 8999 tcptype so
</pre>
<p id="rfc.section.Appendix C.p.3">The answer to that offer could look like this:</p>
<div id="#rfc.figure.8"></div>
<pre>
v=0
o=bob 2808844564 2808844564 IN IP4 192.0.2.1
s= 
c=IN IP4 192.0.2.1
t=0 0
a=ice-pwd:YH75Fviy6338Vbrhrlp8Yh
a=ice-ufrag:9uB6
m=audio 3478 TCP/RTP/AVP 0
b=RS:0
b=RR:0
a=setup:passive
a=connection:new
a=rtpmap:0 PCMU/8000
a=candidate:1 1 TCP 2128609279 192.0.2.1 9 typ host tcptype act
a=candidate:2 1 TCP 2124414975 192.0.2.1 3478 typ host tcptype pass
a=candidate:3 1 TCP 2120220671 192.0.2.1 3482 typ host tcptype so
</pre>
<p id="rfc.section.Appendix C.p.4">In the second example, UDP and TCP media streams are mixed but S-O candidates are omitted due to hosts not supporting TCP simultaneous-open and UDP candidates are preferred (but preference order for candidate types is kept the same) by decreasing the TCP candidate type preferences by one (i.e., using type preference 125 for the host candidates and 99 for the server reflexive candidates): </p>
<div id="#rfc.figure.9"></div>
<pre>
v=0
o=jdoe 2890844526 2890842807 IN IP4 10.0.1.1
s= 
c=IN IP4 192.0.2.3
t=0 0
a=ice-pwd:asd88fgpdd777uzjYhagZg
a=ice-ufrag:8hhY
m=audio 45664 RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=candidate:1 1 TCP 2111832063 10.0.1.1 9 typ host tcptype act
a=candidate:2 1 TCP 2107637759 10.0.1.1 9012 typ host tcptype pass
a=candidate:3 1 TCP 1671430143 192.0.2.3 9 typ srflx raddr 10.0.1.1
  rport 9 tcptype act
a=candidate:4 1 TCP 1667235839 192.0.2.3 44642 typ srflx raddr
  10.0.1.1 rport 9012 tcptype pass
a=candidate:5 1 UDP 2130706431 10.0.1.1 8998 typ host
a=candidate:6 1 UDP 1694498815 192.0.2.3 45664 typ srflx raddr
  10.0.1.1 rport 8998
</pre>
<p id="rfc.section.Appendix C.p.5">The corresponding answer could look like this:</p>
<div id="#rfc.figure.10"></div>
<pre>
v=0
o=bob 2808844564 2808844564 IN IP4 192.0.2.1
s= 
c=IN IP4 192.0.2.1
t=0 0
a=ice-pwd:YH75Fviy6338Vbrhrlp8Yh
a=ice-ufrag:9uB6
m=audio 3478 RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=candidate:1 1 TCP 2111832063 192.0.2.1 9 typ host tcptype act
a=candidate:2 1 TCP 2107637759 192.0.2.1 3478 typ host tcptype pass
a=candidate:3 1 UDP 2130706431 192.0.2.1 3478 typ host
</pre>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Jonathan Rosenberg</span> 
	  <span class="n hidden">
		<span class="family-name">Rosenberg</span>
	  </span>
	</span>
	<span class="org vcardline">Skype</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:jdrosen@jdrosen.net">jdrosen@jdrosen.net</a></span>

<span class="vcardline">URI: <a href="http://www.jdrosen.net">http://www.jdrosen.net</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Ari Keranen</span> 
	  <span class="n hidden">
		<span class="family-name">Keranen</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson</span>
	<span class="adr">
	  <span>Hirsalantie 11</span>

	  <span class="vcardline">
		<span class="locality">02420 Jorvas</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Finland</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ari.keranen@ericsson.com">ari.keranen@ericsson.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Bruce B. Lowekamp</span> 
	  <span class="n hidden">
		<span class="family-name">Lowekamp</span>
	  </span>
	</span>
	<span class="org vcardline">Skype</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:bbl@lowekamp.net">bbl@lowekamp.net</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Adam Roach</span> 
	  <span class="n hidden">
		<span class="family-name">Roach</span>
	  </span>
	</span>
	<span class="org vcardline">Tekelec</span>
	<span class="adr">
	  <span>17210 Campbell Rd.</span>
<span>Suite 250</span>

	  <span class="vcardline">
		<span class="locality">Dallas, TX 75252</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:adam@nostrum.com">adam@nostrum.com</a></span>

  </address>
</div>

</body>
</html>