<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Protocol Support for High Availability of IKEv2/IPsec</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Protocol Support for High Availability of IKEv2/IPsec">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">R. Singh, Ed.</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">G. Kalyani</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">Cisco</td></tr>
<tr><td class="header">Expires: April 28, 2011</td><td class="header">Y. Nir</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Check Point</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">D. Zhang</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Huawei</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">October 25, 2010</td></tr>
</table></td></tr></table>
<h1><br />Protocol Support for High Availability of IKEv2/IPsec<br />draft-ietf-ipsecme-ipsecha-protocol-02</h1>

<h3>Abstract</h3>

<p> The IPsec protocol suite is widely used for the deployment of virtual private networks (VPNs). 
        In order to make such VPNs highly available, more scalable and failure-resistant, 
        these VPNs are implemented as IPsec High Availability (HA) clusters.
        However there are many issues in IPsec HA clustering, and in particular in IKEv2 clustering. An earlier
        document, "IPsec Cluster Problem Statement", enumerates the issues encountered in
        the IKEv2/IPsec HA cluster environment. This document attempts to resolve these issues with
        the least possible change to the protocol.
      
</p>
<p> This document proposes an extension to the IKEv2 protocol to solve the main issues of
        "IPsec Cluster Problem Statement" in the commonly deployed hot-standby cluster, 
        and provides implementation advice for other issues.
	The main issues to be solved are the synchronization of IKEv2
        Message ID counters, and of IPsec Replay Counters.
      
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on April 28, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#anchor3">3.</a>&nbsp;
Issues Resolved from IPsec Cluster Problem Statement<br />
<a href="#sync_problem">4.</a>&nbsp;
The IKEv2/IPsec SA Counter Synchronization Problem<br />
<a href="#anchor4">5.</a>&nbsp;
Counter Synchronization Solution<br />
<a href="#sync_payload">6.</a>&nbsp;
IKEv2/IPsec Synchronization Notification Payloads<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">6.1.</a>&nbsp;
IKEV2_MESSAGE_ID_SYNC_SUPPORTED<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">6.2.</a>&nbsp;
IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">6.3.</a>&nbsp;
IKEV2_MESSAGE_ID_SYNC<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">6.4.</a>&nbsp;
IPSEC_REPLAY_COUNTER_SYNC<br />
<a href="#anchor9">7.</a>&nbsp;
Implementation Details<br />
<a href="#anchor10">8.</a>&nbsp;
Step by Step Details<br />
<a href="#Security">9.</a>&nbsp;
Security Considerations<br />
<a href="#anchor11">10.</a>&nbsp;
Interaction with other drafts<br />
<a href="#anchor12">11.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor13">12.</a>&nbsp;
Acknowledgements<br />
<a href="#history">13.</a>&nbsp;
Change Log<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">13.1.</a>&nbsp;
Draft  -02<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">13.2.</a>&nbsp;
Draft  -01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">13.3.</a>&nbsp;
Draft  -00<br />
<a href="#rfc.references1">14.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">14.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">14.2.</a>&nbsp;
Informative References<br />
<a href="#Examples">Appendix&nbsp;A.</a>&nbsp;
IKEv2 Message ID Sync Examples<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">A.1.</a>&nbsp;
Normal  Failover - Example 1<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor20">A.2.</a>&nbsp;
Normal  Failover - Example 2<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">A.3.</a>&nbsp;
Simultaneous Failover<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p> The IPsec protocol suite, including IKEv2, is a major building block of virtual private networks (VPNs).
	In order to make such VPNs highly available, more scalable and failure-resistant, these VPNs are implemented as 
        IKEv2/IPsec Highly Available (HA) cluster. However there are many issues with the IKEv2/IPsec HA cluster.
	The problem statement draft  <a class='info' href='#sync_problem'>Section&nbsp;4<span> (</span><span class='info'>The IKEv2/IPsec SA Counter Synchronization Problem</span><span>)</span></a>
        enumerates the issues around the IKEv2/IPsec HA cluster solution. 
      
</p>
<p> In the case of a hot-standby cluster implementation of IKEv2/IPsec based VPNs,
	the IKEv2/IPsec session is first established between the peer and the 
        active member of the cluster. Later, the active member continuously syncs/updates the IKE/IPsec SA state
	to the standby member of the cluster. This 
        primary SA state sync-up takes place upon each SA bring-up and/or rekey.
	Performing the SA state synchronization/update 
        for every single IKE and IPsec message is very costly, so normally it is done periodically.
	As a result, when the failover event happens,
	this is first detected by the standby member and, possibly after a considerable amount of time,
	it becomes the active member.
	During this failover process the peer is unaware of the failover event, and keeps sending IKE requests
	and IPsec packets 
        to the cluster, as in fact it is allowed to do because of the IKEv2 windowing feature.
	After the newly-active member starts, it detects the mismatch in IKE Message 
	ID values and IPsec replay counters and needs to resolve this situation.
	Please see <a class='info' href='#sync_problem'>Section&nbsp;4<span> (</span><span class='info'>The IKEv2/IPsec SA Counter Synchronization Problem</span><span>)</span></a> for more details of the problem. 
      
</p>
<p> This document proposes an extension to the IKEv2 protocol to solve main issues of IKE Message ID
	synchronization and IPsec SA replay counter synchronization and gives 
        implementation advice for others. Following is a summary of the solutions provided in this document:  
      
</p>
<p>
      </p>
<ul class="text">
<li> IKEv2 Message ID synchronization: this is done by syncing up the expected send and receive 
	Message ID values with the peer, and updating the 
	values at the newly active cluster member. 
      
</li>
<li> IPsec Replay Counter synchronization: this is done by incrementing the cluster's outgoing
	SA replay counter values by a "large" number, and synchronizing these values with the peer.
         The peer send its outgoing SA reply counter in the response.
      
</li>
</ul><p>
      
</p>
<p> Although this document describes the IKEv2 Message ID and IPsec replay counter synchronization
	in the context of an IPsec HA cluster, 
	the solution provided is generic and can be used in other scenarios where IKEv2 Message ID or
	IPsec SA replay counter synchronization may be required.
      
</p>
<p> Implementations differ on the need to synchronize the IKEv2 Message ID and/or IPsec replay counters.
	Both of these problem are handled separately, using a separate notification for
        each capability. This provides the flexibility of implementing either or both of these solutions.
      
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in
        <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
      
</p>
<p> "SA Counter Synchronization Request/Response" are the request viz. response of the information exchange 
	defined in this document to synchronize the 
	IKEv2/IPsec SA counter information between one member of the cluster and the peer. 
      
</p>
<p>
        Some of the terms listed below are reused from  <a class='info' href='#RFC6027'>[RFC6027]<span> (</span><span class='info'>Nir, Y., &ldquo;IPsec Cluster Problem Statement,&rdquo; October&nbsp;2010.</span><span>)</span></a> with further clarification 
        in the context of the current document. 
      
</p>
<p>
      </p>
<ul class="text">
<li> "Hot Standby Cluster", or "HS Cluster" is a cluster where only one of the members is active at any one time. 
        This member is also referred to as the "active" member, whereas the other(s) are referred to as "standby" members.  
        VRRP <a class='info' href='#RFC5798'>[RFC5798]<span> (</span><span class='info'>Nadas, S., &ldquo;Virtual Router Redundancy Protocol (VRRP) Version 3 for IPv4 and IPv6,&rdquo; March&nbsp;2010.</span><span>)</span></a> is one method of building such a cluster. The goal of Hot Standby Cluster is that it
        creates illusion of single virtual gateway to the peer(s). 
      
</li>
<li> "Active Member" is the primary member in the Hot-Standby cluster. It is responsible for forwarding packets
        on behalf of the virtual gateway.
      
</li>
<li> "Standby Member" is the primary backup member. This member takes control, i.e. becomes the active member, after
        the failover event. 
      
</li>
<li> "Peer" is an IKEv2/IPsec endpoint that maintains a VPN connection with the Hot-Standby cluster. The Peer 
        identifies the cluster by the cluster's (single) IP address. If a failover event occurs, the standby member of the
        cluster becomes active, and the peer normally doesn't notice that failover has taken place. 
      
</li>
<li> "Failover Count" is a global failover event counter maintained by the HA cluster and incremented by 1 upon each
        failover event in the HA cluster. All members of the HA cluster share the failover count.
      
</li>
<li> "Multiple failover" is the situation where, in a cluster with three or more members,
        failover happens in rapid succession.
        It is our goal that the implementation should be able to handle this situation, i.e. 
	to handle the new failover event even if it is still processing the old failover. 
      
</li>
<li> "Simultaneous failover" is the situation where two clusters have a VPN connection between them,
      and failover happens at the both ends at the same time. 
      It is our goal that implementation should be able to handle simultaneous failover. 
      
</li>
</ul><p>
      
</p>
<p> The generic term "IKEv2/IPsec SA Counters" is used throughout this document.
      This term refers to both IKEv2 Message ID counters (mandatory, and used to ensure reliable delivery
      as well as to protect against message replay in IKEv2)
        and IPsec SA replay counters (optional, and used to provide the IPsec anti-replay feature). 
      
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Issues Resolved from IPsec Cluster Problem Statement</h3>

<p>  The IPsec Cluster Problem Statement <a class='info' href='#RFC6027'>[RFC6027]<span> (</span><span class='info'>Nir, Y., &ldquo;IPsec Cluster Problem Statement,&rdquo; October&nbsp;2010.</span><span>)</span></a>
	enumerates the problems raised by IPsec clusters.
        The following table lists the problem statement's sections that are resolved by this document.
        </p>
<ul class="text">
<li>  3.2.  Lots of Long Lived State 
</li>
<li>  3.3.  IKE Counters
</li>
<li>  3.4.  Outbound SA Counters
</li>
<li>  3.5.  Inbound SA Counters
</li>
<li>  3.6.  Missing Synchronization Messages
</li>
<li>  3.7.  Simultaneous use of IKE and IPsec SAs by Different Members
	    
<ul class="text">
<li>   3.7.1.  Outbound SAs using counter modes
</li>
</ul>
          
</li>
<li>   3.8.  Different IP addresses for IKE and IPsec
</li>
<li>  3.9.  Allocation of SPIs
</li>
</ul><p>
      
</p>
<p> The main problem areas are solved using the protocol extension defined below,
        and additionally this document provides implementation advice for other issues, given as follows.
        
        </p>
<ul class="text">
<li>3.2 This section mentions that there is a large amount of state that needs to be synchronized. 
            However if state is not synchronized, this is not really an interesting cluster:
	    failover is equivalent to a
            reboot of the cluster member, and so the issue need not be solved with protocol extensions. 
          
</li>
<li>
            3.3, 3.4,3.5, and 3.6 are solved by this document. Please see <a class='info' href='#sync_problem'>Section&nbsp;4<span> (</span><span class='info'>The IKEv2/IPsec SA Counter Synchronization Problem</span><span>)</span></a>,
            for more details. 
          
</li>
<li>3.7 is an implementation problem that needs to be solved while building IPsec clusters.  
            However, the peers should be required to accept multiple parallel SAs for 3.7.1.
          
</li>
<li> 3.8 can be solved by using the IKEv2 Redirect mechanism <a class='info' href='#RFC5685'>[RFC5685]<span> (</span><span class='info'>Devarapalli, V. and K. Weniger, &ldquo;Redirect Mechanism for the Internet Key Exchange Protocol Version 2 (IKEv2),&rdquo; November&nbsp;2009.</span><span>)</span></a>.
</li>
<li>3.9 discusses the avoidance of collisions where the same SPI value is used by multiple cluster members. This 
            is outside the document's scope since the problem needs to be solved internally to the cluster and
            does not involve the peer.
          
</li>
</ul><p>
      
</p>
<a name="sync_problem"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
The IKEv2/IPsec SA Counter Synchronization Problem</h3>

<p> The IKEv2 protocol <a class='info' href='#RFC5996'>[RFC5996]<span> (</span><span class='info'>Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;Internet Key Exchange Protocol Version 2 (IKEv2),&rdquo; September&nbsp;2010.</span><span>)</span></a> states that "An IKE endpoint MUST NOT exceed 
      the peer's stated window size for
        transmitted IKE requests".
      
</p>
<p>All IKEv2 messages are required to follow a request-response paradigm. 
        The initiator of an IKEv2 request MUST retransmit the request, until it has received a response from the peer.
        IKEv2 introduces a windowing mechanism that allows multiple requests to be outstanding at a given point of time,
	but mandates
        that the sender window should not move until the oldest message sent from one peer to another is acknowledged.
        Loss of even a single message leads to repeated retransmissions followed by an IKEv2 SA teardown 
	if the retransmissions are unacknowledged.
      
</p>
<p>An IPsec Hot Standby Cluster is required to ensure that in the case of failover, 
	the standby member becomes active immediately.
        The standby member is expected to have the exact value of the Message ID counter as the active member had
	before failover.
        Even assuming the best effort to update the Message ID values from active to standby member, 
	the values at the standby 
        member can still be stale due to the following reasons:
        
        </p>
<ul class="text">
<li> The standby member is unaware of the last message that was received and acknowledged by the 
            previously active member, as the failover event could have happened before the standby member could be updated.
          
</li>
<li> The standby member does not have information about on-going unacknowledged requests received by
	    the previously active member.
            As a result after the failover event, the newly active member cannot retransmit those requests.
          
</li>
</ul><p>
      
</p>
<p> When a standby member takes over as the active member, it can only initialize the Message ID
        values from the previously updated values.
        This would make it reject requests from the peer when these values are stale.
        Conversely, the standby member may end up reusing a stale Message ID value which would cause
	the peer to drop the request.
        Eventually there is a high probability of the IKEv2 and corresponding IPsec SAs getting torn down 
	simply because of a 
        transitory Message ID mismatch and retransmission of requests, negating the benefits of
	the high availability cluster despite the periodic update between the cluster members.
      
</p>
<p>A similar issue is also observed with IPsec anti-replay counters if anti-replay protection/ESN is implemented,
        which is commonly the case. Regardless of how well the ESP and AH SA counters are synchronized from the 
        active to the standby member, there is a chance that the standby member would end up with stale counter values.
	The standby member would then use those stale counter values when sending IPsec packets.
        The peer would reject/drop such packets since when the anti-replay protection feature is enabled,
	duplicate use of counters is not allowed. Note that IPsec allows the sender to skip 
        some counter values and continue sending with higher counter values.
      
</p>
<p>We conclude that a mechanism is required to ensure that the standby member has correct Message ID
        and IPsec counter values when it becomes active, 
        so that sessions are not torn down as a result of mismatched counters.
      
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Counter Synchronization Solution</h3>

<p>In general, when the standby member becomes the active member after the failover event, the standby member 
        sends an authenticated IKEv2 request to the peer, asking it to send its SA counter values.
      
</p>
<p> The standby member then updates its own SA counter values and can resume normally sending and receiving
	protocol messages.
</p>
<p> First, the peer MUST negotiate its ability to support IKEv2 Message ID synchronization 
	with the active member of the cluster by sending
        the IKEV2_MESSAGE_ID_SYNC_SUPPORTED notification in the IKE_AUTH exchange. 
      
</p>
<p> Similarly, to support IPsec Replay Counter synchronization, the peer MUST negotiate this capability 
        with the active member of the cluster by sending the IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED notification 
	in the IKE_AUTH exchange. 
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Peer                                                  Active Member
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
HDR, SK {IDi, [CERT], [CERTREQ], [IDr], AUTH,
     [N(IKEV2_MESSAGE_ID_SYNC_SUPPORTED),]
     [N(IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED),]
     SAi2, TSi, TSr} ----------&gt;

&lt;-------- HDR, SK {IDr, [CERT+], [CERTREQ+], AUTH,
               [N(IKEV2_MESSAGE_ID_SYNC_SUPPORTED),]
               [N(IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED),] SAr2, TSi, TSr}


</pre></div>
<p> When the peer and active member both support SA counter synchronization,
	the active member MUST inform the standby member of the SA counter 
        synchronization capability after the establishment of the IKE SA. The standby member can then use
	this capability when it becomes the active member after a failover event.
      
</p>
<p>  After the failover event, when the standby member becomes active, it has to request
	the SA counters from the peer.
        The newly-active member initiates the synchronization request with an Informational exchange
	with Message ID zero containing either the notification IKEV2_MESSAGE_ID_SYNC or the two notifications
	IKEV2_MESSAGE_ID_SYNC and IPSEC_REPLAY_COUNTER_SYNC, depending on whether the synchronization
	is to be done for IKEv2 Message IDs or for both IKEv2 Message IDs and IPsec replay counters.
	If the active member has only negotiated synchronization of IPsec Replay Counters, the request is sent
	as a regular IKEv2 Informational exchange (i.e. with a non-zero Message ID) containing the notification
	IPSEC_REPLAY_COUNTER_SYNC. 
      
</p>
<p> The initiator of the IKEv2 Message ID synchronization request sends its expected send and receive
	Message ID values and "failover count" in a IKEV2_MESSAGE_ID_SYNC notification.
	The responder compares the received values with its local values. For both send and receive values,
	The higher between the cluster member's and the local value is selected, and sent 
	in the response message with the notification IKEV2_MESSAGE_ID_SYNC. The initiator now updates its
	send and receive IKEv2 Message IDs to the values received in the response and can now start a normal IKEv2
	message exchange. 
      
</p>
<p> The initiator of an IPsec Replay Counter synchronization sends the incremented outgoing IPsec SA
	reply counter value and a "failover count" in a IPSEC_REPLAY_COUNTER_SYNC notification in IKEv2
         INFORMATIONAL exchange.
	
	The responder updates its incoming IPsec SA counter values according to the received value. The responder
	now sends its own incremented outgoing IPsec SA Replay Counter value in a synchronization response message,
	with the same IPSEC_REPLAY_COUNTER_SYNC notification. The initiator can now update its incoming
	IPsec SA counter to values received in the response message and can start normal IPsec data traffic. 
      
</p>
<p>  The IKEV2_MESSAGE_ID_SYNC notification payload
	contain nonce data to avoid a denial-of-service (DoS) attack due to replay of
	SA counter synchronization response.
	The nonce values are selected randomly on each new notification and MUST be validated by the receiver.
	The nonce data sent in the response MUST match the nonce data sent by the newly-active member in its request.
	If the nonce data received in 
         the response does not match the request's nonce data, the cluster member MUST silently discard this response,
	and SHOULD revert to normal IKEv2 behavior of retransmitting the request and waiting for a
	genuine a reply from the peer. Eventually this might result in the SA being torn down because of excessive
	retransmissions.
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Standby [Newly Active] Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
HDR, SK {N(IKEV2_MESSAGE_ID_SYNC),
     [N(IPSEC_REPLAY_COUNTER_SYNC)]} --------&gt;

             &lt;--------- HDR, SK {N(IKEV2_MESSAGE_ID_SYNC),
			     [N(IPSEC_REPLAY_COUNTER_SYNC)]}

</pre></div>
<p>Alternatively, if only IPsec Replay Counter synchronization is desired, a normal Information exchange is used, where the Message ID is non-zero:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Standby [Newly Active] Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
HDR, SK{N(IPSEC_REPLAY_COUNTER_SYNC)} --------&gt;

             &lt;--------- HDR, SK {N(IPSEC_REPLAY_COUNTER_SYNC)}

</pre></div>
<a name="sync_payload"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
IKEv2/IPsec Synchronization Notification Payloads</h3>

<p>This section lists the new notification payloads types defined by this extension.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
IKEV2_MESSAGE_ID_SYNC_SUPPORTED</h3>

<p>IKEV2_MESSAGE_ID_SYNC_SUPPORTED:  This notification payload is included in the IKE_AUTH request/response to indicate 
          support of the IKEv2 Message ID synchronization mechanism described in this document. 
        
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |C|  RESERVED   |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Protocol ID(=0)| SPI Size (=0) |      Notify Message Type      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p> The 'Next Payload', 'Payload Length', 'Protocol ID', 'SPI Size', and 'Notify Message Type'
          fields are the same as described in Section 3 of <a class='info' href='#RFC5996'>[RFC5996]<span> (</span><span class='info'>Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;Internet Key Exchange Protocol Version 2 (IKEv2),&rdquo; September&nbsp;2010.</span><span>)</span></a>
          .
          The 'SPI Size' field MUST be set  to 0 to indicate that the SPI is not present in this message.  
          The 'Protocol ID' MUST be set to 0, since the notification is not specific to a particular security association. 
          
          The 'Payload Length' field is set to the length in octets of the entire payload, including 
          the generic payload header.  The 'Notify Message Type' field is set to indicate 
          IKEV2_MESSAGE_ID_SYNC_SUPPORTED, value TBD by IANA. There is no data associated with this notification.
        
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED</h3>

<p>IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED:  This notification payload is included in the IKE_AUTH request/response to indicate 
          support for the IPsec SA Replay Counter synchronization mechanism described in this document. 
        
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |C|  RESERVED   |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Protocol ID(=0)| SPI Size (=0) |      Notify Message Type      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p> The 'Next Payload', 'Payload Length', 'Protocol ID', 'SPI Size', and 'Notify Message Type'
          fields are the same as described in Section 3 of <a class='info' href='#RFC5996'>[RFC5996]<span> (</span><span class='info'>Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;Internet Key Exchange Protocol Version 2 (IKEv2),&rdquo; September&nbsp;2010.</span><span>)</span></a>
          .
          The 'SPI Size' field MUST be set  to 0 to indicate that the SPI is not present in this message.  
          The 'Protocol ID' MUST be set to 0, since the notification is not specific to a particular security association. 
          
          The 'Payload Length' field is set to the length in octets of the entire payload, including 
          the generic payload header.  The 'Notify Message Type' field is set to indicate 
          IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED, value TBD by IANA. There is no data associated with this notification. 
        
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
IKEV2_MESSAGE_ID_SYNC</h3>

<p> IKEV2_MESSAGE_ID_SYNC :  This notification payload type (value TBD by IANA) is defined to synchronize
	  the IKEv2 Message ID values between
          the newly-active (formerly standby) cluster member and the peer. 
        
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |    RESERVED   |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Protocol ID(=0)| SPI Size (=0) |      Notify Message Type      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Failover Count                                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Nonce Data                                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             EXPECTED_SEND_REQ_MESSAGE_ID                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             EXPECTED_RECV_REQ_MESSAGE_ID                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div>
<p>
           It contains the following data.</p>
<ul class="text">
<li> Failover Count (4 octets): a running count of failover events between cluster members,
	    it is initialized to 0 when the cluster is first set up, and incremented by 1 upon each failover event. 
</li>
<li>  Nonce Data (4 octets): the random nonce data. The data should be identical in the
	    synchronization request and response.
            
</li>
<li> EXPECTED_SEND_REQ_MESSAGE_ID (4 octets): 
              this field is used by the sender of this notification payload to indicate the Message ID it will
	      use in the next request that it will send to the other protocol peer. 
            
</li>
<li> EXPECTED_RECV_REQ_MESSAGE_ID (4 octets): this field is used by the sender of this notification payload
              to indicate the Message ID it is expecting in the next request to be received from the other protocol peer.
            
</li>
</ul><p>
           
        
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
IPSEC_REPLAY_COUNTER_SYNC</h3>

<p> IPSEC_REPLAY_COUNTER_SYNC: This notification payload type (value TBD by IANA) is defined to synchronize
	  the IPsec SA Replay Counters between the newly-active (formerly standby) cluster member and the peer.
	  Since there may be numerous IPsec SAs established under a single IKE SA, we do not directly synchronize
	  the value of each one. Instead, a delta value is sent and all Replay Counters for child SAs
	  of this IKE SA are incremented by the same value. Note that this solution requires that all these
	  Child SAs either use or do not use Extended Sequence Numbers <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
        
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |E| RESERVED    |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Protocol ID(=0)| SPI Size (=0) |      Notify Message Type      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 Outgoing IPsec SA counter                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
           The notification payload contains the following data.

	  </p>
<ul class="text">
<li> E (1 bit): The ESN bit. This MUST be 1 if the IPsec SAs were established with
	    Extended Sequence Numbers. 
</li>
<li> Outgoing IPsec SA delta value (4 or 8 octects): The sender will increment the all the Child SA
	      Replay Counters for its outgoing traffic by this value.
              The size of this field depends on ESN bit: if the ESN bit is 1, its size is 8 octets,
	      otherwise it is 4 octets. 
            
</li>
</ul><p>
        
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Implementation Details</h3>

<p> The Message ID value used in the Informational exchange that contains the IKEV2_MESSAGE_ID_SYNC
        notification MUST be zero so that it is not validated
        upon receipt as required by normal IKEv2 windowing. The Message ID zero MUST be accepted only
	in an Informational exchange that contains a notification of type IKEV2_MESSAGE_ID_SYNC.
	If any Informational exchange has a Message ID zero,
        but not this notification type, such messages MUST be discarded upon decryption
	and the INVALID_SYNTAX notification SHOULD be sent.
	
        Other payloads MUST NOT be sent in this Informational exchange.
	Whenever an IKEV2_MESSAGE_ID_SYNC or IPSEC_REPLAY_COUNTER_SYNC notification payload is received with an invalid 
	failover count or invalid nonce data, the event SHOULD be logged. 
      
</p>
<p>
            The standby member can initiate the synchronization of IKEv2 Message ID's under different circumstances.
	</p>
<ul class="text">
<li>  When it receives a problematic IKEv2/IPsec packet, i.e. a packet outside its expected receive window.
</li>
<li> When it has to send the first IKEv2/IPsec packet after a failover event.
</li>
<li>  When it has just received control from active member and wishes to update the values proactively,
            so that it need not start this exchange later, when sending or receiving the request.
          
</li>
</ul><p>
      
</p>
<p>
            The standby member can initiate the synchronization of IPsec SA Replay Counters:
	</p>
<ul class="text">
<li>  If there has been traffic using the IPsec SA in the recent past and the standby member
	    suspects that its Replay Counter may be stale.
</li>
</ul><p>
      
</p>
<p> Since there can be a large number of sessions at the standby member, and sending synchronization 
	exchanges for all of them may result in overload, the standby member can choose to initiate
	the exchange in a "lazy" fashion: only when it has to
        send or receive the request. In general, the standby member is free to initiate this exchange at its discretion.
      
</p>
<p> A cluster member which has not announced its capability by using IKEV2_MESSAGE_ID_SYNC_SUPPORTED
        MUST NOT send or accept the notification IKEV2_MESSAGE_ID_SYNC.
      
</p>
<p> A cluster member which has not announced its capability by using IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED
        MUST NOT send or accept the notification IPSEC_REPLAY_COUNTER_SYNC.
      
</p>
<p> If a peer receives a IKEV2_MESSAGE_ID_SYNC or IPSEC_REPLAY_COUNTER_SYNC request although it had
	not announced the appropriate capability in the IKE_AUTH exchange, then it MUST silently ignore this message. 
      
</p>
<p> As usual in IKEv2, if any of the notification payloads defined here is malformed,
      the receiver must announce this fact using the INVALID_SYNTAX notification.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Step by Step Details</h3>

<p>
        This section goes through the sequence of steps of a typical failover event, where the IKEv2 Message ID 
	values are synchronized.
        
        </p>
<ul class="text">
<li> The active cluster member and the peer device establish the session.
	  They both announce the capability to synchronize counter information 
            by sending the IKEV2_MESSAGE_ID_SYNC_SUPPORTED notification in the IKE_AUTH Exchange.
          
</li>
<li> The active member dies, and a standby member takes over.
            The standby member sends its own idea of the IKE Message IDs (both incoming and outgoing)
	    to the peer in an Informational
	    message exchange with Message ID zero. 
          
</li>
<li> The peer first authenticates the message and then validates the failover count. 
	    The peer compares the received values with the values available locally and picks the higher value.
	    It then updates its Message IDs with the higher values and also propose the same values in its response.
          
</li>
<li>The peer should not wait for any pending responses while responding with the new Message ID values.
            For example, if the window size is 5 and the peer's window is 3-7, and if the peer has sent
	    requests 3, 4, 5, 6, 7 and received responses only for 4, 5, 6, 7 but not for 3, 
	    then it should include the value 8 in its EXPECTED_SEND_REQ_MESSAGE_ID payload
	    and should not wait for a response to message 3 anymore.
          
</li>
<li>  Similarly, the peer should also not wait for pending (incoming) requests.
	    For example if the window size is 5 and 
            the peer's window is 3-7  and if the peer has received requests 4, 5, 6, 7 but not 3,
	    then it should send the value 8 in the 
            EXPECTED_RECV_REQ_MESSAGE_ID payload, and should not expect to receive message 3 anymore.
          
</li>
</ul><p>
      
</p>
<p> In case multiple successive failover events and sync request getting lost, the failover count value at 
            peer will not be updated and new standby member will become active with incremented failover count value.
            So, peer can receive valid failover count value which is not just incremented by 1 in case of multiple failover.
            Accepting incremented failover count within a range is allowed and increases interoperability. 
        
      
</p>
<a name="Security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Security Considerations</h3>

<p>
        Since Message ID synchronization messages need to be sent with Message ID zero, they are potentially
	vulnerable to replay attacks. Because of the semantics of this protocol, 
	these can only be denial-of-service (DoS) attacks, and we are aware of two variants.
        
        </p>
<ul class="text">
<li>  Replay of Message ID synchronization request:
            
            This is countered by use of the Failover Count, since synchronization starts 
	    after the failover event and each member of the cluster needs to be aware of the failover event. The receiver 
	    of the synchronization request should verify the received Failover Count and maintain its own copy of it.
	    
	    If a peer receives a synchronization request with an already observed Failover Count, it can 
             safely discard the request if it has already received valid IKEv2 request/response from other side peer 
	    after sync exchange. The peer will be not be aware that sync response has reached to other side till it 
             receives a valid IKEv2 request/response from other side. The peer can send the cached response for sync 
             request till it has not  received valid request/response from other side peer or failover count has not increased. 
          
</li>
<li> Replay of the Message ID synchronization response:
            This is countered by sending the nonce data along with the synchronization payload.
	    The same nonce
            data has to be returned in response.  Thus the standby member will accept a reply only for the current request.
            After it receives a valid response, it MUST NOT process the same response again and MUST discard 
	    any additional responses.
          
</li>
</ul><p>
      
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Interaction with other drafts</h3>

<p>
        The usage scenario of the IKEv2/IPsec SA counter synchronization proposal is that an 
	IKEv2 SA has been established between 
        the active member of a hot-standby cluster and a peer, then a failover event occurred with the standby member 
        becoming active. The proposal further assumes that the IKEv2 SA state was continuously synchronized between 
	the active and standby members of the 
        cluster before the failover event.
        
        </p>
<ul class="text">
<li>  
            Session resumption <a class='info' href='#RFC5723'>[RFC5723]<span> (</span><span class='info'>Sheffer, Y. and H. Tschofenig, &ldquo;Internet Key Exchange Protocol Version 2 (IKEv2) Session Resumption,&rdquo; January&nbsp;2010.</span><span>)</span></a> assumes that a peer (client or initiator) 
	    detects the need to re-establish the session. In 
            IKEv2/IPsec SA counter synchronization, it is the newly-active member (a gateway or responder)
            that detects the need to synchronize the SA counter after the failover event. 
            Also in a hot-standby cluster, the peer establishes the IKEv2/IPsec session with a single IP address
	    that represents the whole cluster, so the peer normally does
            not detect the event of failover in the cluster unless the standby member takes too 
	    long to become active and the IKEv2 SA times out by use of the IKEv2
            liveness check mechanism. To conclude, session resumption and SA counter synchronization 
	    after failover are mutually exclusive.
          
</li>
<li> 
            The IKEv2 Redirect mechanism for load-balancing <a class='info' href='#RFC5685'>[RFC5685]<span> (</span><span class='info'>Devarapalli, V. and K. Weniger, &ldquo;Redirect Mechanism for the Internet Key Exchange Protocol Version 2 (IKEv2),&rdquo; November&nbsp;2009.</span><span>)</span></a> can be used 
	    either during the initial stages of SA setup (the IKE_SA_INIT and IKE_AUTH exchanges) or after session 
            establishment. SA counter synchronization is only useful after the IKE SA has been established 
	    and a failover event has occurred.
            So, unlike Redirect, it is irrelevant during the first two exchanges. 
	    Redirect after the session has been established is mostly useful for timed
            or planned shutdown/maintenance. A real failover event cannot be detected by the active member 
	    ahead of time, and so using 
            Redirect after session establishment is not possible in the case of failover. 
	    So, Redirect and SA counter synchronization after failover are mutually exclusive.
          
</li>
<li> IKEv2 Failure Detection <a class='info' href='#I-D.ietf-ipsecme-failure-detection'>[I&#8209;D.ietf&#8209;ipsecme&#8209;failure&#8209;detection]<span> (</span><span class='info'>Nir, Y., Wierbowski, D., Detienne, F., and P. Sethi, &ldquo;A Quick Crash Detection Method for IKE,&rdquo; October&nbsp;2010.</span><span>)</span></a>
            solves a similar problem where the peer can rapidly detect that a cluster member has 
	    crashed based on a token. It is unrelated to the current scenario because the goal in
	    failover is for the peer not to notice that a failure has occurred.
          
</li>
</ul><p>
      
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
IANA Considerations</h3>

<p>
        This document  introduces four new IKEv2 Notification Message types as
        described in Section 6.The new Notify Message Types must be assigned values between 16396 and 40959.
        </p>
<ul class="text">
<li> IKEV2_MESSAGE_ID_SYNC_SUPPORTED. 
</li>
<li> IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED. 
</li>
<li> IKEV2_MESSAGE_ID_SYNC. 
</li>
<li> IPSEC_REPLAY_COUNTER_SYNC.
</li>
</ul><p>
      
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Acknowledgements</h3>

<p>  We would like to thank Pratima Sethi and Frederic Detienne for their review comments and valuable suggestions
        for the initial version of the document.  
      
</p>
<p>  We would also like to thank the following people (in alphabetical order) for their review comments and valuable 
        suggestions:  Dan Harkins, Paul Hoffman, Steve Kent, Tero Kivinen, David McGrew, Pekka Riikonen, and Yaron Sheffer. 
      
</p>
<a name="history"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
Change Log</h3>

<p> This section lists all the changes in this document. 
</p>
<p> NOTE TO RFC EDITOR: Please remove this section before publication.
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13.1"></a><h3>13.1.&nbsp;
Draft  -02</h3>

<p> Addressed comments by Yaron Sheffer posted on the WG mailing list. 
</p>
<p> Numerous editorial changes. 
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13.2"></a><h3>13.2.&nbsp;
Draft  -01</h3>

<p> Added "Multiple and Simultaneous failover' scenarios as pointed out by Pekka Riikonen.
</p>
<p> Now document provides a mechanism to sync either IKEv2 message or IPsec replay counter or both to cater different types of implementations. 
</p>
<p> HA cluster's "failover count' is used to encounter replay of sync requests by attacker. 
</p>
<p> The sync of IPsec SA replay counter optimized to to have just one global bumped-up outgoing IPsec SA counter of ALL Child SAs under an IKEv2 SA. 
</p>
<p> The examples added for IKEv2 Message ID sync to provide more clarity. 
</p>
<p> Some edits as per comments on mailing list to enhance clarity. 
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13.3"></a><h3>13.3.&nbsp;
Draft  -00</h3>

<p> Version 00 is identical to draft-kagarigi-ipsecme-ikev2-windowsync-04, started as WG 
          document.
        
</p>
<p> Added IPSECME WG HA design team members as authors. 
</p>
<p> Added comment in Introduction to discuss the window sync process on WG mailing list to solve some concerns. 
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>14.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4301">[RFC4301]</a></td>
<td class="author-text">Kent, S. and K. Seo, &ldquo;<a href="http://tools.ietf.org/html/rfc4301">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;4301, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4301.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5996">[RFC5996]</a></td>
<td class="author-text">Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;<a href="http://tools.ietf.org/html/rfc5996">Internet Key Exchange Protocol Version 2 (IKEv2)</a>,&rdquo; RFC&nbsp;5996, September&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5996.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC6027">[RFC6027]</a></td>
<td class="author-text">Nir, Y., &ldquo;<a href="http://tools.ietf.org/html/rfc6027">IPsec Cluster Problem Statement</a>,&rdquo; RFC&nbsp;6027, October&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc6027.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>14.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-ipsecme-failure-detection">[I-D.ietf-ipsecme-failure-detection]</a></td>
<td class="author-text">Nir, Y., Wierbowski, D., Detienne, F., and P. Sethi, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-failure-detection-01.txt">A Quick Crash Detection Method for IKE</a>,&rdquo; draft-ietf-ipsecme-failure-detection-01 (work in progress), October&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-failure-detection-01.txt">TXT</a>, <a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-failure-detection-01.ps">PS</a>, <a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-failure-detection-01.pdf">PDF</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5685">[RFC5685]</a></td>
<td class="author-text">Devarapalli, V. and K. Weniger, &ldquo;<a href="http://tools.ietf.org/html/rfc5685">Redirect Mechanism for the Internet Key Exchange Protocol Version 2 (IKEv2)</a>,&rdquo; RFC&nbsp;5685, November&nbsp;2009 (<a href="http://www.rfc-editor.org/rfc/rfc5685.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5723">[RFC5723]</a></td>
<td class="author-text">Sheffer, Y. and H. Tschofenig, &ldquo;<a href="http://tools.ietf.org/html/rfc5723">Internet Key Exchange Protocol Version 2 (IKEv2) Session Resumption</a>,&rdquo; RFC&nbsp;5723, January&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5723.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5798">[RFC5798]</a></td>
<td class="author-text">Nadas, S., &ldquo;<a href="http://tools.ietf.org/html/rfc5798">Virtual Router Redundancy Protocol (VRRP) Version 3 for IPv4 and IPv6</a>,&rdquo; RFC&nbsp;5798, March&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5798.txt">TXT</a>).</td></tr>
</table>

<a name="Examples"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
IKEv2 Message ID Sync Examples</h3>

<p>
        This (non-normative) section presents some examples that illustrate how the IKEv2 Message ID values 
	are synchronized.
        We use a tuple notation, denoting the two counters EXPECTED_SEND_REQ_MESSAGE_ID and EXPECTED_RECV_REQ_MESSAGE_ID
        on a member as (EXPECTED_SEND_REQ_MESSAGE_ID, EXPECTED_RECV_REQ_MESSAGE_ID). 
      
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
Normal  Failover - Example 1</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Standby (Newly Active) Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Sync Request (2, 3) --------&gt;

                          Peer has the values (4, 5) so it sends
             &lt;------------- (4, 5) as the Sync Response

</pre></div>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.2"></a><h3>A.2.&nbsp;
Normal  Failover - Example 2</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Standby (Newly Active) Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Sync Request (2, 5) --------&gt;

                          Peer has the values (2, 4) so it sends
             &lt;-------------(5, 4) as the Sync Response

</pre></div>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.3"></a><h3>A.3.&nbsp;
Simultaneous Failover</h3>

<p>In the case of simultaneous failover, both sides send the synchronization request,
      but whichever side has the higher value will be eventually synchronized.
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Standby (Newly Active) Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

Sync Request (4,4)     -----&gt;

                 &lt;-------------- Sync Request (5,5)

Sync Response (5,5)    ----&gt;

                     &lt;--------  Sync Response (5,5)

</pre></div>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Raj Singh (Editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Divyashree Chambers, B Wing, O'Shaugnessy Road</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bangalore, Karnataka  560025</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">India</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+91 80 4301 3320</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:rsj@cisco.com">rsj@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Kalyani Garigipati</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Divyashree Chambers, B Wing, O'Shaugnessy Road</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bangalore, Karnataka  560025</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">India</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+91 80 4426 4831</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:kagarigi@cisco.com">kagarigi@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Yoav Nir</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Check Point Software Technologies Ltd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5 Hasolelim St.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tel Aviv  67897</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Israel</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ynir@checkpoint.com">ynir@checkpoint.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dacheng Zhang</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Huawei Technologies Ltd.</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:zhangdacheng@huawei.com">zhangdacheng@huawei.com</a></td></tr>
</table>
</body></html>
