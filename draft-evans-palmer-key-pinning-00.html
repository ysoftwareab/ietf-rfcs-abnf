<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Public Key Pinning Extension for HTTP</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 About Notation">
<link href="#rfc.section.2" rel="Chapter" title="2 Server and Client Behavior">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Response Header Field Syntax">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 Semantics of Pins">
<link href="#rfc.section.2.3" rel="Chapter" title="2.3 Noting Pins">
<link href="#rfc.section.2.3.1" rel="Chapter" title="2.3.1 max-age">
<link href="#rfc.section.2.4" rel="Chapter" title="2.4 Validating Pinned Connections">
<link href="#rfc.section.2.5" rel="Chapter" title="2.5 Interactions With Preloaded Pin Lists">
<link href="#rfc.section.2.6" rel="Chapter" title="2.6 Pinning Self-Signed End Entities">
<link href="#rfc.section.3" rel="Chapter" title="3 Security Considerations">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Backup Pins">
<link href="#rfc.section.4" rel="Chapter" title="4 Usability Considerations">
<link href="#rfc.section.5" rel="Chapter" title="5 Acknowledgements">
<link href="#rfc.section.6" rel="Chapter" title="6 What's Changed">
<link href="#rfc.references" rel="Chapter" title="7 References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Fingerprint Generation">
<link href="#rfc.appendix.Appendix%20B" rel="Chapter" title="Appendix B Deployment Guidance">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This memo describes an extension to the HTTP protocol allowing web host operators to instruct user agents (UAs) to remember ("pin") the hosts' cryptographic identities for a given period of time. During that time, UAs will require that the host present a certificate chain including at least one Subject Public Key Info structure whose fingerprint matches one or more of the pinned fingerprints for that host. By effectively reducing the scope of authorities who can authenticate the domain during the lifetime of the pin, pinning may reduce the incidence of man-in-the-middle attacks due to compromised Certification Authorities and other authentication errors and attacks." />
  <meta name="description" content="This memo describes an extension to the HTTP protocol allowing web host operators to instruct user agents (UAs) to remember ("pin") the hosts' cryptographic identities for a given period of time. During that time, UAs will require that the host present a certificate chain including at least one Subject Public Key Info structure whose fingerprint matches one or more of the pinned fingerprints for that host. By effectively reducing the scope of authorities who can authenticate the domain during the lifetime of the pin, pinning may reduce the incidence of man-in-the-middle attacks due to compromised Certification Authorities and other authentication errors and attacks." />
  <meta name="keywords" content="I-D, Internet-Draft, Certificate, Public key, X.509, Certification authority, Public key pinning, HTTPS, TLS, SSL" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Web Security</td>
<td class="right">C. Evans</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">C. Palmer</td>
</tr>
<tr>
<td class="left">Expires: May 17, 2012</td>
<td class="right">Google, Inc.</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">November 14, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Public Key Pinning Extension for HTTP<br />
  <span class="filename">draft-evans-palmer-key-pinning-00</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This memo describes an extension to the HTTP protocol allowing web host operators to instruct user agents (UAs) to remember ("pin") the hosts' cryptographic identities for a given period of time. During that time, UAs will require that the host present a certificate chain including at least one Subject Public Key Info structure whose fingerprint matches one or more of the pinned fingerprints for that host. By effectively reducing the scope of authorities who can authenticate the domain during the lifetime of the pin, pinning may reduce the incidence of man-in-the-middle attacks due to compromised Certification Authorities and other authentication errors and attacks.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on May 17, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>
<h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">We propose a new HTTP header to enable a web host to express to user agents (UAs) which Subject Public Key Info (SPKI) structure(s) UAs MUST expect to be present in the host's certificate chain in future connections using TLS (see <a href="#rfc-5246">[rfc-5246]</a>). We call this "public key pinning". At least one user agent (Google Chrome) has experimented with shipping with a user-extensible embeded set of pins. Although effective, this does not scale. This proposal addresses the scale problem.</p>
<p id="rfc.section.1.p.2">Deploying public key pinning safely will require operational and organizational maturity due to the risk that hosts may make themselves unavailable by pinning to a SPKI that becomes invalid. (See <a href="#security-considerations">Section 3</a>.) We believe that, with care, host operators can greatly reduce the risk of MITM attacks and other false-authentication problems for their users without incurring undue risk.</p>
<p id="rfc.section.1.p.3">We intend for hosts to use public key pinning together with HSTS (as defined in <a href="#hsts-draft">[hsts-draft]</a>, but is possible to pin keys without requiring HSTS.</p>
<p id="rfc.section.1.p.4">This draft is being discussed on the WebSec Working Group mailing list, websec@ietf.org.</p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#notation" id="notation">About Notation</a>
</h1>
<p id="rfc.section.1.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#rfc-2119">[rfc-2119]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#server-client-behavior" id="server-client-behavior">Server and Client Behavior</a>
</h1>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> <a href="#header-syntax" id="header-syntax">Response Header Field Syntax</a>
</h1>
<p id="rfc.section.2.1.p.1">To set a pin, hosts use a new HTTP header field, Public-Key-Pins, in their HTTP responses. <a href="#header-abnf">Figure 1</a> describes the syntax of the header field.</p>
<div id="#rfc.figure.1"></div>
<div id="#header-abnf"></div>
<pre>
Public-Key-Pins = "Public-Key-Pins" ":" LWS directives

directives      = max-age LWS ";" LWS pins
                  / pins LWS ";" LWS max-age

max-age         = "max-age" LWS "=" LWS delta-seconds

pins            = pin
                  / pin LWS ";" LWS pins

pin             = "pin-" token LWS "=" LWS quoted-string
</pre>
<p id="rfc.section.2.1.p.2">In the pin rule, the token is the name of a cryptographic hash algorithm, and MUST be either "sha1" or "sha256". (Future versions of this specification may change the hash functions.) The quoted-string is a sequence of base64 digits: a base64-encoded hash. See <a href="#pin-semantics">Section 2.2</a>.</p>
<p><a href="#pins-examples">Figure 2</a> shows some example response header fields using the pins extension (folded for clarity).</p>
<div id="#rfc.figure.2"></div>
<div id="#pins-examples"></div>
<pre>
Public-Key-Pins: max-age=500;
    pins=sha1-4n972HfV354KP560yw4uqe/baXc=,
    sha1-IvGeLsbqzPxdI0b0wuj2xVTdXgc=

Public-Key-Pins: max-age=31536000;
    pins=sha1-4n972HfV354KP560yw4uqe/baXc=,
    sha256-LPJNul+wow4m6DsqxbninhsWHlwfp0JecwQzYpOLmCQ=

Public-Key-Pins: pins=sha1-4n972HfV354KP560yw4uqe/baXc=,
    sha1-qvTGHdzF6KLavt4PO0gs2a6pQ00=,
    sha256-LPJNul+wow4m6DsqxbninhsWHlwfp0JecwQzYpOLmCQ= ;
    max-age=2592000
</pre>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> <a href="#pin-semantics" id="pin-semantics">Semantics of Pins</a>
</h1>
<p id="rfc.section.2.2.p.1">The fingerprint is the SHA-1 or SHA-256 hash of the DER-encoded ASN.1 representation of the SubjectPublicKeyInfo (SPKI) field of the X.509 certificate. <a href="#spki-definition">Figure 3</a> reproduces the definition of the SubjectPublicKeyInfo structure in <a href="#rfc-5280">[rfc-5280]</a>.</p>
<div id="#rfc.figure.3"></div>
<div id="#spki-definition"></div>
<pre>
SubjectPublicKeyInfo  ::=  SEQUENCE  {
    algorithm            AlgorithmIdentifier,
    subjectPublicKey     BIT STRING  }

AlgorithmIdentifier  ::=  SEQUENCE  {
    algorithm            OBJECT IDENTIFIER,
    parameters           ANY DEFINED BY algorithm OPTIONAL  }
</pre>
<p id="rfc.section.2.2.p.2">The SPKI hash is then encoded in base-64 for use in an HTTP header. (See <a href="#rfc-4648">[rfc-4648]</a>.)</p>
<p id="rfc.section.2.2.p.3">We pin public keys, rather than entire certificates, to enable operators to generate new certificates containing old public keys (see <a href="#why-pin-key">[why-pin-key]</a>).</p>
<p id="rfc.section.2.2.p.4">See <a href="#fingerprint-generation">Appendix Appendix A</a> for an example non-normative program that generates public key fingerprints from SubjectPublicKeyInfo fields in certificates.</p>
<h1 id="rfc.section.2.3">
<a href="#rfc.section.2.3">2.3.</a> <a href="#noting-pins" id="noting-pins">Noting Pins</a>
</h1>
<p id="rfc.section.2.3.p.1">Upon receipt of the Public-Key-Pins response header field, the UA notes the host as a Pinned Host, storing the pins and their associated max-age in non-volatile storage (for example, along with the HSTS metadata). The pins and their associated max-age are collectively known as Pinning Metadata.</p>
<p id="rfc.section.2.3.p.2">The UA MUST observe these conditions when noting a host:</p>
<p></p>

<ul>
<li>The UA MUST note the pins if and only if it received the Public-Key-Pins response header field over an error-free TLS connection.</li>
<li>The UA MUST note the pins if and only if the TLS connection was authenticated with a certificate chain containing at least one of the SPKI structures indicated by at least one of the given fingerprints. (See <a href="#validating-pinned-connections">Section 2.4</a>.)</li>
<li>The UA MUST note the pins if and only if the given set of pins contains at least one pin that does NOT refer to an SPKI in the certificate chain.  (That is, the host must set a Backup Pin; see <a href="#backup-pins">Section 3.1</a>.)</li>
</ul>
<p id="rfc.section.2.3.p.4">If the Public-Key-Pins response header field does not meet all three of these criteria, the UA MUST NOT note the host as a Pinned Host, and MUST discard any previously set Pinning Metadata for that host in its non-volatile store. Public-Key-Pins response header fields that meet all these critera are known as Valid Pinning Headers.</p>
<p id="rfc.section.2.3.p.5">Whenever a UA receives a Valid Pinning Header, it MUST set its Pinning Metadata to the exact pins and max-age given in the most recently received Valid Pinning Header.</p>
<h1 id="rfc.section.2.3.1">
<a href="#rfc.section.2.3.1">2.3.1.</a> <a href="#max-age" id="max-age">max-age</a>
</h1>
<p id="rfc.section.2.3.1.p.1">max-age specifies the number of seconds, after the reception of the Public-Key-Pins HTTP Response Header, during which the UA regards the host as a Pinned Host. The delta-seconds production is specified in <a href="#rfc-2616">[rfc-2616]</a>.</p>
<p id="rfc.section.2.3.1.p.2">Note that by setting a low or 0 value for max-age, hosts effectively instruct UAs to cease regarding them as Pinned Hosts.</p>
<h1 id="rfc.section.2.4">
<a href="#rfc.section.2.4">2.4.</a> <a href="#validating-pinned-connections" id="validating-pinned-connections">Validating Pinned Connections</a>
</h1>
<p id="rfc.section.2.4.p.1">When a UA connects to a Pinned Host, if the TLS connection has errors, it applies its usual policy. For example, depending on the type of failure, the UA might or might now allow the user the option of continuing with the connection anyway. For hosts that are Known HSTS Hosts the UA MUST terminate the connection in case of TLS errors, as required by <a href="#hsts-draft">[hsts-draft]</a>.</p>
<p id="rfc.section.2.4.p.2">If the connection has no errors, the UA will then apply a new correctness check: Pin Validation. To perform Pin Validation, the UA will compute the fingerprints of the SPKI structures in each certificate in the host's certificate chain. The UA will then check that the set of these fingerprints intersects the set of fingerprints in that host's Pinning Metadata. If there is set intersection, the UA continues with the connection as normal.  Otherwise, the UA MUST treat this Pin Failure as a non-recoverable error.</p>
<p id="rfc.section.2.4.p.3">Note that, although the UA has previously received public key pins at the HTTP layer, it can and MUST perform Pin Validation at the TLS layer, before beginning an HTTP conversation over the TLS channel. The TLS layer thus evaluates TLS connections with pinning information the UA received previously, regardless of mechanism: statically preloaded, via HTTP header, or some other means (possibly in the TLS layer itself).</p>
<h1 id="rfc.section.2.5">
<a href="#rfc.section.2.5">2.5.</a> <a href="#interactions-built-in" id="interactions-built-in">Interactions With Preloaded Pin Lists</a>
</h1>
<p id="rfc.section.2.5.p.1">UAs MAY choose to implement built-in public key pins, alongside any built-in HSTS opt-in list. UAs MUST allow users to override a built-in pin list, including turning it off.</p>
<p id="rfc.section.2.5.p.2">UAs MUST use the newest information &#8212; built-in or set via Valid Pinning Header &#8212; when performing Pin Validation for the host.</p>
<h1 id="rfc.section.2.6">
<a href="#rfc.section.2.6">2.6.</a> <a href="#pinning-self-signed" id="pinning-self-signed">Pinning Self-Signed End Entities</a>
</h1>
<p id="rfc.section.2.6.p.1">If UAs accept hosts that authenticate themselves with self-signed end entity certificates, they MAY also allow hosts to pin the public keys in such certificates. The usability and security implications of this practice are outside the scope of this specification.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a>
</h1>
<p id="rfc.section.3.p.1">Pinning public keys helps hosts assert their cryptographic identity, but there is some risk that a host operator could lose or lose control of their host's private key. In this case, the operator would not be able to serve their web site or application in a way that UAs would trust for the duration of their pin's max-age. (Recall that UAs MUST close the connection to a host upon Pin Failure.)</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#backup-pins" id="backup-pins">Backup Pins</a>
</h1>
<p id="rfc.section.3.1.p.1">The primary way to cope with the risk of inadvertant Pin Failure is to keep a Backup Pin. A Backup Pin is a fingerprint for the public key of a secondary, not-yet-deployed key pair. The operator keeps the backup key pair offline, and sets a pin for it in the Public-Key-Pins header. Then, in case the operator loses control of their primary private key, they can deploy the backup key pair. UAs, who have had the backup key pair pinned (when it was set in previous Valid Pinning Headers), can connect to the host without error.</p>
<p id="rfc.section.3.1.p.2">Because having a backup key pair is so important to recovery, UAs MUST require that hosts set a Backup Pin. (See <a href="#noting-pins">Section 2.3</a>.)</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#usability" id="usability">Usability Considerations</a>
</h1>
<p id="rfc.section.4.p.1">When pinning works to detect impostor Pinned Hosts, users will experience denial of service. UAs MUST explain the reason why, i.e. that it was impossible to verify the confirmed cryptographic identity of the host.</p>
<p id="rfc.section.4.p.2">UAs MUST have a way for users to clear current pins for Pinned Hosts.  UAs SHOULD have a way for users to query the current state of Pinned Hosts.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#acknowledgements" id="acknowledgements">Acknowledgements</a>
</h1>
<p id="rfc.section.5.p.1">Thanks to Jeff Hodges, Adam Langley, Nicolas Lidzborski, SM, and Yoav Nir for suggestions and edits that clarified the text. Thanks to Trevor Perrin for suggesting a mechanism to affirmatively break pins (<a href="#pin-break-codes">[pin-break-codes]</a>). Adam Langley provided the SPKI fingerprint generation code.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#what-changed" id="what-changed">What's Changed</a>
</h1>
<p id="rfc.section.6.p.1">Removed the section on pin break codes and verifiers, in favor the of most-recently-received policy (<a href="#noting-pins">Section 2.3</a>).</p>
<p id="rfc.section.6.p.2">Now using a new header field, Public-Key-Pins, separate from HSTS. This allows hosts to use pinning separately from Strict Transport Security.</p>
<p id="rfc.section.6.p.3">Explicitly requiring that UAs perform Pin Validation before the HTTP conversation begins.</p>
<p id="rfc.section.6.p.4">Backup Pins are now required.</p>
<p id="rfc.section.6.p.5">Separated normative from non-normative material. Removed tangential and out-of-scope non-normative discussion.</p>
<h1 id="rfc.references">
<a href="#rfc.references">7.</a> References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="hsts-draft">[hsts-draft]</b></td>
<td class="top">
<a title="PayPal, Inc.">Hodges, J.</a>, <a title="Carnegie Mellon University">Jackson, C.</a> and <a title="Google, Inc.">A. Barth</a>, "<a>HTTP Strict Transport Security (HSTS)</a>", October 2011.</td>
</tr>
<tr>
<td class="reference"><b id="why-pin-key">[why-pin-key]</b></td>
<td class="top">
<a>Langley, A.</a>, "<a>Public Key Pinning</a>", May 2011.</td>
</tr>
<tr>
<td class="reference"><b id="pin-break-codes">[pin-break-codes]</b></td>
<td class="top">
<a>Perrin, T.</a>, "<a>Self-Asserted Key Pinning</a>", September 2011.</td>
</tr>
<tr>
<td class="reference"><b id="rfc-2119">[rfc-2119]</b></td>
<td class="top">
<a>Bradner, S.</a>, "<a>Key words for use in RFCs to Indicate Requirement Levels</a>", March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="rfc-2616">[rfc-2616]</b></td>
<td class="top">
<a>Fielding, R.</a>, <a>Gettys, J.</a>, <a>Mogul, J.</a>, <a>Frystyk, H.</a>, <a>Masinter, L.</a>, <a>Leach, P.</a> and <a>T. Berners-Lee</a>, "<a>Hypertext Transfer Protocol -- HTTP/1.1</a>", June 1999.</td>
</tr>
<tr>
<td class="reference"><b id="rfc-4648">[rfc-4648]</b></td>
<td class="top">
<a>Josefsson, S.</a>, "<a>The Base16, Base32, and Base64 Data Encodings</a>", October 2006.</td>
</tr>
<tr>
<td class="reference"><b id="rfc-5246">[rfc-5246]</b></td>
<td class="top">
<a>Rescorla, E.</a> and <a>T. Dierks</a>, "<a>The Transport Layer Security (TLS) Protocol Version 1.2</a>", August 2008.</td>
</tr>
<tr>
<td class="reference"><b id="rfc-5280">[rfc-5280]</b></td>
<td class="top">
<a>Cooper, D.</a>, <a>Santesson, S.</a>, <a>Farrell, S.</a>, <a>Boeyen, S.</a>, <a>Housley, R.</a> and <a>W. Polk</a>, "<a>Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile</a>", May 2008.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> <a href="#fingerprint-generation" id="fingerprint-generation">Fingerprint Generation</a>
</h1>
<p id="rfc.section.Appendix A.p.1">This Go program generates public key fingerprints, suitable for use in pinning, from PEM-encoded certificates. It is non-normative.</p>
<div id="#rfc.figure.4"></div>
<div id="#fingerprint-generation-figure"></div>
<pre>
package main

import (
       "io/ioutil"
       "os"
       "crypto/sha1"
       "crypto/x509"
       "encoding/base64"
       "encoding/pem"
       "fmt"
)

func main() {
       if len(os.Args) &lt; 2 {
               fmt.Printf("Usage: %s PEM-filename\n", os.Args[0])
               os.Exit(1)
       }
       pemBytes, err := ioutil.ReadFile(os.Args[1])
       if err != nil {
               panic(err.String())
       }
       block, _ := pem.Decode(pemBytes)
       if block == nil {
               panic("No PEM structure found")
       }
       derBytes := block.Bytes
       certs, err := x509.ParseCertificates(derBytes)
       if err != nil {
               panic(err.String())
       }
       cert := certs[0]
       h := sha1.New()
       h.Write(cert.RawSubjectPublicKeyInfo)
       digest := h.Sum()

       fmt.Printf("Hex: %x\nBase64: %s\n", digest,
               base64.StdEncoding.EncodeToString(digest))
}
</pre>
<h1 id="rfc.appendix.Appendix B">
<a href="#rfc.appendix.Appendix%20B">Appendix B.</a> <a href="#deployment-guidance" id="deployment-guidance">Deployment Guidance</a>
</h1>
<p id="rfc.section.Appendix B.p.1">This section is non-normative guidance which may smooth the adoption of public key pinning.</p>
<p></p>

<ul>
<li>Operators SHOULD get the backup public key signed by a different (root and/or intermediary) CA than their primary certificate, and store the backup key pair safely offline.</li>
<li>It is most economical to have the backup certificate signed by a completely different signature chain than the live certificate, to maximize recoverability in the event of either root or intermediary signer compromise.</li>
<li>Operators SHOULD periodically exercise their Backup Pin plan &#8212; an untested backup is no backup at all.</li>
<li>Operators SHOULD start small. Operators SHOULD first deploy public key pinning by setting a max-age of minutes or a few hours, and gradually increase max-age as they gain confidence in their operational capability.</li>
</ul>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Chris Evans</span> 
	  <span class="n hidden">
		<span class="family-name">Evans</span>
	  </span>
	</span>
	<span class="org vcardline">Google, Inc.</span>
	<span class="adr">
	  <span>1600 Amphitheatre Pkwy</span>

	  <span class="vcardline">
		<span class="locality">Mountain View</span>,  
		<span class="region">CA</span> 
		<span class="code">94043</span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:cevans@google.com">cevans@google.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Chris Palmer</span> 
	  <span class="n hidden">
		<span class="family-name">Palmer</span>
	  </span>
	</span>
	<span class="org vcardline">Google, Inc.</span>
	<span class="adr">
	  <span>1600 Amphitheatre Pkwy</span>

	  <span class="vcardline">
		<span class="locality">Mountain View</span>,  
		<span class="region">CA</span> 
		<span class="code">94043</span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:palmer@google.com">palmer@google.com</a></span>

  </address>
</div>
  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">About Notation</a>
</li>
<li>2.   <a href="#rfc.section.2">Server and Client Behavior</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">Response Header Field Syntax</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">Semantics of Pins</a>
</li>
<li>2.3.   <a href="#rfc.section.2.3">Noting Pins</a>
</li>
<li>2.3.1.   <a href="#rfc.section.2.3.1">max-age</a>
</li>
<li>2.4.   <a href="#rfc.section.2.4">Validating Pinned Connections</a>
</li>
<li>2.5.   <a href="#rfc.section.2.5">Interactions With Preloaded Pin Lists</a>
</li>
<li>2.6.   <a href="#rfc.section.2.6">Pinning Self-Signed End Entities</a>
</li>
<li>3.   <a href="#rfc.section.3">Security Considerations</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Backup Pins</a>
</li>
<li>4.   <a href="#rfc.section.4">Usability Considerations</a>
</li>
<li>5.   <a href="#rfc.section.5">Acknowledgements</a>
</li>
<li>6.   <a href="#rfc.section.6">What's Changed</a>
</li>
<li>7.   <a href="#rfc.references">References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Fingerprint Generation</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.Appendix%20B">Deployment Guidance</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  

</body>
</html>