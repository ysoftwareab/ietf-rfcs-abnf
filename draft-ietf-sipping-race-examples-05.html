<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Example calls flows of race conditions in the Session Initiation Protocol (SIP)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Example calls flows of race conditions in the Session Initiation Protocol (SIP)">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">sipping</td><td class="header">M. Hasebe</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">J. Koshiko</td></tr>
<tr><td class="header">Intended status: BCP</td><td class="header">NTT-east Corporation</td></tr>
<tr><td class="header">Expires: August 22, 2008</td><td class="header">Y. Suzuki</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">NTT Corporation</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">T. Yoshikawa</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">NTT-east Corporation</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">P. Kyzivat</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Cisco Systems, Inc.</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">February 19, 2008</td></tr>
</table></td></tr></table>
<h1><br />Example calls flows of race conditions in the Session Initiation Protocol (SIP)<br />draft-ietf-sipping-race-examples-05</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on August 22, 2008.</p>

<h3>Abstract</h3>

<p>This document gives examples call flows of race conditions 
         in the Session Initiation Protocol (SIP). Race conditions are 
	 inherently confusing and difficult to thwart; this document 
	 shows the best  practices to handle them. The elements in these 
	 call flows include SIP User Agents and SIP Proxy Servers.  
	 Call flow diagrams and message details are given.
      
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">1.1.</a>&nbsp;
General Assumptions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">1.2.</a>&nbsp;
Legend for Message Flows<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">1.3.</a>&nbsp;
SIP Protocol Assumptions<br />
<a href="#sec.invite-dsm">2.</a>&nbsp;
The Dialog State Machine for INVITE dialog usage<br />
<a href="#anchor5">3.</a>&nbsp;
Race Conditions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">3.1.</a>&nbsp;
Receiving message in the Moratorium State<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">3.1.1.</a>&nbsp;
Receiving Initial INVITE retransmission
                 (Preparative state) while in the Moratorium state<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">3.1.2.</a>&nbsp;
Receiving CANCEL (Early state) when in Moratorium state<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec.rcv-bye-early-moratorium">3.1.3.</a>&nbsp;
Receiving BYE (Early state) while in the Moratorium state<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec.rcv-reinvite-est-moratorium-1">3.1.4.</a>&nbsp;
Receiving re-INVITE (Established state) while in the Moratorium state (case 1)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec.rcv-reinvite-est-moratorium-2">3.1.5.</a>&nbsp;
Receiving re-INVITE (Established state) while in the Moratorium state (case 2)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">3.1.6.</a>&nbsp;
Receiving BYE (Established state) while in the Moratorium state<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">3.2.</a>&nbsp;
Receiving message in the Mortal State<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">3.2.1.</a>&nbsp;
Receiving BYE (Established state) while in the Mortal state<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">3.2.2.</a>&nbsp;
Receiving re-INVITE (Established state) while in the Mortal state<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec.rcv-200-reinvite-mortal">3.2.3.</a>&nbsp;
Receiving 200 OK for re-INVITE (Established state) while in the Mortal state<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">3.2.4.</a>&nbsp;
Receiving ACK (Moratorium state) while in the Mortal state<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">3.3.</a>&nbsp;
Other race conditions<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">3.3.1.</a>&nbsp;
Re-INVITE crossover<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec.update-reinvite-cross">3.3.2.</a>&nbsp;
UPDATE and re-INVITE crossover<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">3.3.3.</a>&nbsp;
Receiving REFER (Established state) while in the Mortal state<br />
<a href="#anchor17">4.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor18">5.</a>&nbsp;
Security Considerations<br />
<a href="#anchor19">6.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">7.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">7.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">7.2.</a>&nbsp;
Informative References<br />
<a href="#anchor22">Appendix&nbsp;A.</a>&nbsp;
BYE in the Early Dialog<br />
<a href="#anchor23">Appendix&nbsp;B.</a>&nbsp;
BYE request overlapping with re-INVITE<br />
<a href="#anchor24">Appendix&nbsp;C.</a>&nbsp;
UA's behavior for CANCEL<br />
<a href="#anchor25">Appendix&nbsp;D.</a>&nbsp;
Notes on the request in the Mortal state<br />
<a href="#anchor26">Appendix&nbsp;E.</a>&nbsp;
Forking and receiving new To tags<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Overview</h3>

<p>The call flows shown in this document were developed in the
         design of a SIP IP communications network. These examples are 
	 of race conditions, which stem from transitions in dialog states; 
	 mainly  transitions during session establishment after the 
	 sending of an INVITE.
      <br />
<br />

         When implementing SIP, various complex situations may arise.
         Therefore, it is helpful to provide implementors of the
         protocol with examples of recommended terminal and server
         behavior.
      <br />
<br />

         This document clarifies SIP UA behaviors when messages cross
         each other as race conditions. By clarifying the operation under
         race conditions, inconsistent interpretations between
         implementations are avoided and interoperability is expected
         to be promoted.
      <br />
<br />

         It is the hope of the authors that this document will be useful
         for SIP implementors, designers, and protocol researchers and
         will help them achieve the goal of a standard implementation
         of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1].
      <br />
<br />

         These call flows are based on the version 2.0 of SIP defined
         in <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1] with SDP usage as described
         in <a class='info' href='#RFC3264'>RFC 3264<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;An Offer/Answer Model with Session Description Protocol (SDP),&rdquo; June&nbsp;2002.</span><span>)</span></a> [2].
      <br />
<br />

         The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", 
         "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY",
         and "OPTIONAL" in this document are to be interpreted as 
         described in BCP 14, <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [3].
      
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
General Assumptions</h3>

<p>A number of architectural, network, and protocol assumptions
           underlie the call flows in this document.  Note that these
           assumptions are not requirements. They are outlined in this
           section so that they may be taken into consideration and help
           understanding of the call flow examples.
        <br />
<br />

           These flows do not assume specific underlying transport protocols
           such as TCP, TLS, and UDP.  See the discussion in <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1] for details of the transport issues for SIP.
        
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.2"></a><h3>1.2.&nbsp;
Legend for Message Flows</h3>

<p>Dashed lines (---) and slash lines (/, \) represent signaling
           messages that are mandatory to the call scenario. (X)
           represents the crossover of signaling messages. (->x, x&lt;-) indicate
           that the packet is lost. The arrow indicates the direction of
           message flow. Double dashed lines (===) represent media paths
           between network elements.
        <br />
<br />

           Messages are identified in the figures as F1, F2, etc. These
           numbers are used for references to the message details that
           follow the Figure. Comments in the message details are shown 
           in the following form:
        <br />
<br />

           /* Comments. &nbsp;*/
        
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.3"></a><h3>1.3.&nbsp;
SIP Protocol Assumptions</h3>

<p>This document does not prescribe the flows precisely as they
           are shown, but rather illustrates the principles for best 
           practice. They are best practice usages (orderings, syntax,
           selection of features for the purpose, or handling of errors)
           of SIP methods, headers and parameters. Note: The flows in 
           this document must not be copied as-is by implementors
           because additional annotations have been incorporated into this
           document for ease of explanation. To sum up, the procedures
           described in this document represent well-reviewed examples
           of SIP usage, which exemplify best common practice according to
           IETF consensus.
        <br />
<br />

           For reasons of simplicity in reading and editing the document, there are
           a number of differences between some of the examples and actual
           SIP messages. For instance, Call-IDs are often replicated, CSeq
           often begins at 1, header fields are usually shown in the same
           order, usually only the minimum required header field set is
           shown, and other headers which would usually be included such
           as Accept, Allow, etc. are not shown.
        <br />
<br />

           Actors:
        
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Element     Display Name  URI                            IP Address
-------     ------------  ---                            ----------

User Agent  Alice         sip:alice@atlanta.example.com  192.0.2.101
User Agent  Bob           sip:bob@biloxi.example.com     192.0.2.201
User Agent  Carol         sip:carol@chicago.example.com  192.0.2.202
Proxy Server              ss.atlanta.example.com         192.0.2.111
</pre></div>
<p>The term "session" is used in this document in the same way 
	it is used in <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1] sections 13-15. 
	(Which differs somewhat from the definition of the term in RFC 3261.) 
	<a class='info' href='#RFC5057'>RFC 5057<span> (</span><span class='info'>Sparks, R., &ldquo;Multiple Dialog Usages in the Session Initiation Protocol,&rdquo; November&nbsp;2007.</span><span>)</span></a> [6] introduces
	another term, "invite dialog usage", which is more precisely
	defined.  The term "session" used herein is almost, but not quite, 
	identical to the term "invite dialog usage". The two have differing 
	definitions of when the state ends -- the session ends earlier, 
	when BYE is sent or received.
        
</p>
<a name="sec.invite-dsm"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
The Dialog State Machine for INVITE dialog usage</h3>

<p>Race conditions are generated when the dialog state of the
         receiving side differs from that of the sending side.
      <br />
<br />

         For instance, a race condition occurs when a UAC (User Agent
         Client) sends a CANCEL in the Early state while the UAS (User
         Agent Server) is transitioning from the Early state to the
         Confirmed state by sending a 200 OK to an initial INVITE
         (indicated as "ini-INVITE" hereafter). The DSM (dialog state
         machine) for the INVITE dialog usage is presented as follows to
         help understanding of the UA's behavior in race conditions.
      <br />
<br />

         The DSM clarifies the UA's behavior by subdividing the dialog state
         shown in <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1] into various internal states.
         We call the state before the establishment of a dialog the Preparative state.
         The Confirmed state is subdivided into two substates, the Moratorium
         and the Established states, and the Terminated state is subdivided into
         the Mortal and Morgue states. Messages which are the triggers for
         the state transitions between these states are indicated with arrows.
         In this figure, messages which are not related to state transition
         are omitted.
      <br />
<br />

         Below are the DSMs, first for the caller and then for the callee.
      
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
INV +-----------------------------------------------+
---&gt;|                 Preparative                   |
    +-----------------------------------------------+
      |                    |                      |
      | 3xx-6xx            | 1xx-tag              | 2xx
      |                    |                      |
      |                    |        1xx-tag       |
      |                    V        w/new tag     |
      |         +-----------------+  [new DSM]    |
      | 3xx-6xx |                 |   | (new DSM  |
      +&lt;--------|      Early      |   |  instance |
      |         |                 |&lt;--+  created) |
      |         +-----------------+               |
      |            |             |                |  2xx w/new tag
      |            | BYE         | 2xx            |   [new DSM]
      |            |             +------------&gt;+&lt;-+      | (new DSM
      |            |                           |         |  instance
+-----C------------C-----+         +-----------C------+  |  created)
|     | Terminated |     |         | Confirmed |      |  |
|     |            +&lt;----C---------|           |      |  |
|     |            |     | BYE(sr) |           |      |  |
|     |            V     |         |           V      |  |
| 2xx |  +-----------+   |         |   +-----------+  |  |
| +---C--|           |---C-+       |   |           |  |  |
| |   |  |   Mortal  |   | | BYE(r)|   | Moratorium|&lt;-C--+
| +---C-&gt;|           |&lt;--C-+       |   |           |  |
| ACK |  +-----------+   |         |   +-----------+  |
|     |    |             |         |         |        |
|     |    | Timeout     |         |         | ACK    |
|     |    |             |         |         |        |
|     V    V             |         |         V        |
|   +---------------+    |         |   +-----------+  |
|   |               |    |         |   |           |--C-+
|   |     Morgue    |    |         |   |Established|  | | 2xx,ACK
|   |               |    |         |   |           |&lt;-C-+
|   +---------------+    |         |   +-----------+  |
|                        |         |                  |
+------------------------+         +------------------+

(r): indicates that only reception is allowed.
     Where (r) is not used as an indicator, "response" means
     receive, and "request" means send.
(sr): indicates that both sending and reception are allowed.
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure 1: DSM for INVITE dialog usage (Caller)&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Figure 1 represents the caller's 
         DSM for the INVITE dialog usage. 
	 The caller MAY send a BYE in the Early state, even though
         this behavior is NOT RECOMMENDED. A BYE sent in the Early
         state terminates the early dialog using a specific To tag.
         That is, when a proxy is performing forking, the BYE is only
         able to terminate the early dialog with a particular UA.
         If the caller wants to terminate all early dialogs instead of that
         with a particular UA, it needs to send CANCEL, not BYE. However,
         it is not illegal to send BYE in the Early state to terminate a
         specific early dialog if this is to the caller's intent. Moreover,
         until the caller receives a final response and terminates the INVITE
         transaction, the caller MUST be prepared to establish a dialog by
         receiving a new response to the INVITE even if it has already sent a
         CANCEL or BYE and terminated the dialog (see Appendix A).
      
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
INV +-----------------------------------------------+
---&gt;|                 Preparative                   |
    +-----------------------------------------------+
      |                         |                 |
      | 3xx-6xx                 | 1xx-tag         | 2xx
      |                         |                 |
      |                         V                 |
      |         +------------------+              |
      | 3xx-6xx |                  |              |
      +&lt;--------|      Early       |              |
      |         |                  |              |
      |         +------------------+              |
      |            |             |                |
      |            | BYE         | 2xx            |
      |            |             +------------&gt;+&lt;-+
      |            |                           |
+-----C------------C-----+         +-----------C------+
|     | Terminated |     |         | Confirmed |      |
|     |            +&lt;----C---------|           |      |
|     |            |     | BYE(sr) |           |      |
|     |            V     |         |           V      |
|     | +------------+   |         |   +-----------+  |
|     | |            |---C-+       |   |           |--C-+
|     | |   Mortal   |   | | BYE   |   | Moratorium|  | | 2xx
|     | |            |&lt;--C-+       |   |           |&lt;-C-+ if ACK not
|     | +------------+   |         |   +-----------+  |   received
|     |   |              |         |         |        |
|     |   | Timeout      |         |         | ACK    |
|     |   |              |         |         |        |
|     V   V              |         |         V        |
|   +---------------+    |         |   +-----------+  |
|   |               |    |         |   |           |  |
|   |     Morgue    |    |         |   |Established|  |
|   |               |    |         |   |           |  |
|   +---------------+    |         |   +-----------+  |
|                        |         |                  |
+------------------------+         +------------------+

 (sr): indicates that both sending and reception are allowed.
      Where (sr) is not used as an indicator, "response" means send,
      and "request" means receive.
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure 2: DSM for INVITE dialog usage (Callee)&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Figure 2 represents the callee's DSM 
         for the INVITE dialog usage. 
         The figure does not illustrate the state transition related to CANCEL 
	 requests. A CANCEL request does not cause a dialog state transition. 
	 However, the callee terminates the dialog and triggers
         the dialog transition by sending 487 immediately after the reception
         of the CANCEL.  This behavior upon the reception of
         the CANCEL request is further explained in Appendix C.
      <br />
<br />

         The UA's behavior in each state is as follows.
        </p>
<blockquote class="text"><dl>
<dt>Preparative (Pre):</dt>
<dd>
             The Preparative state is in effect until the early dialog is
             established by sending or receiving a provisional response
             with a To tag after an ini-INVITE is sent or received. The
             dialog does not yet exist in the Preparative state. If the UA
             sends or receives a 2xx response, the dialog state transitions
             from the Preparative to the Moratorium state, which is a
             substate of the Confirmed state. In addition, if UA sends
             or receives a 3xx-6xx response the dialog state transitions to
             the Morgue state which is a substate of the Terminated state.
             Sending an ACK for a 3xx-6xx response and retransmissions of
             3xx-6xx are not shown on the DSMs because they are sent
             by the INVITE transaction.
          
</dd>
<dt>Early (Ear):</dt>
<dd>
             The early dialog is established by sending or receiving a
             provisional response except 100 Trying. The early dialog exists
             even though the dialog does not exist in this state yet. The dialog
             state transitions from the Early to the Moratorium state, a substate
             of the Confirmed state, by sending or receiving a 2xx response.
             In addition, the dialog state transitions to the Morgue state, a
             substate of the Terminated state, by sending or receiving a
             3xx-6xx response. Sending an ACK for a 3xx-6xx response and
             retransmissions of 3xx-6xx are not shown on this DSM
             because they are automatically processed on the transaction
             layer and don't influence the dialog state. The UAC may send
             a CANCEL in the Early state. The UAC may also send a BYE (although it is
             not recommended). The UAS may send a 1xx-6xx response. The sending
             or receiving of a CANCEL request does not have a direct
             influence on the dialog state. The UA's behavior upon the
             reception of the CANCEL request is explained further in
             Appendix C.
          
</dd>
<dt>Confirmed (Con):</dt>
<dd>
             The sending or receiving of a 2xx final response establishes a
             dialog. The dialog starts in this state. The Confirmed state
             transitions to the Mortal state, a substate of the Terminated
             state, by sending or receiving a BYE request. The Confirmed
             state has two substates, the Moratorium and the Established states,
             which are different with regard to the messages that UAs are allowed to send.
          
</dd>
<dt>Moratorium (Mora):</dt>
<dd>
             The Moratorium state is a substate of the Confirmed state
             and inherits its behavior. The Moratorium
             state transitions to the Established state by sending or receiving
             an ACK request. The UAC may send an ACK and the UAS may send a 2xx final
             response.
          
</dd>
<dt>Established (Est):</dt>
<dd>
             The Established state is a substate of the Confirmed state
             and inherits its behavior. Both caller and
             callee may send various messages which influence a dialog.
             The caller supports the transmission of ACK to the
             retransmission of a 2xx response to an ini-INVITE.
          
</dd>
<dt>Terminated (Ter):</dt>
<dd>
             The Terminated state is subdivided into two substates, the
             Mortal and Morgue states, to cover the behavior when a
             dialog is being terminated. In this state, the UA holds
             information about the dialog which is being terminated.
          
</dd>
<dt>Mortal (Mort):</dt>
<dd>
             The caller and callee enter the Mortal state by sending or
             receiving a BYE. The UA MUST NOT send any new requests within
             the dialog because there is no dialog. (Here the new requests
             do not include ACK for 2xx and BYE for 401 or 407 as further
             explained in Appendix D below.) In the Mortal state, 
	     BYE can be accepted, and the other messages in the INVITE 
	     dialog usage are responded with an error.
	     This addresses the case where BYE is sent by both
             a caller and a callee to exchange reports about the session
             when it is being terminated. Therefore the UA possesses
             dialog information for internal processing but the dialog
             shouldn't be externally visible. The UA stops managing its
             dialog state and changes it to the Morgue state, when the
             BYE transaction is terminated.
          
</dd>
<dt>Morgue (Morg):</dt>
<dd>
             The dialog no longer exists in this state. The sending or
             receiving of signaling which influences a dialog is not
             performed. (A dialog is literally terminated.) The caller and
             callee enter the Morgue state via the termination of the BYE
             or INVITE transaction.
          
</dd>
</dl></blockquote><p>
      
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Race Conditions</h3>

<p>This section details a race condition between two SIP UAs, Alice
         and Bob. Alice (sip:alice@atlanta.example.com) and Bob
         (sip:bob@biloxi.example.com) are assumed to be SIP phones or
         SIP-enabled devices.  Only significant signaling is illustrated.
         Dialog state transitions caused by the sending or receiving of SIP
         messages are shown and race conditions are indicated by
   '*race*'.
        (For abbreviations for the dialog state transitions,
         refer to <a class='info' href='#sec.invite-dsm'>Section&nbsp;2<span> (</span><span class='info'>The Dialog State Machine for INVITE dialog usage</span><span>)</span></a>.) 
	 '*race*' indicates the moment when a race
         condition occurs.
      <br />
<br />

         Examples of race conditions are described below.
      <br />
<br />

      
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Receiving message in the Moratorium State</h3>

<p>This section shows some examples of call flow race conditions
           when receiving messages from other states while in the Moratorium
           state.
        
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.1"></a><h3>3.1.1.&nbsp;
Receiving Initial INVITE retransmission
                 (Preparative state) while in the Moratorium state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                               Bob  State
       |                                     |
       |            ini-INVITE F1            |
       |------------------------------------&gt;|
  Pre  |         180 F2(Packet loss)         |  Pre
       |            x&lt;-----------------------|
       |                                     |  Ear
       | ini-INVITE F4(=F1)           200 F3 |
       |------------------     --------------|
       |                   \ /               |  Mora
       |                    X                |
       |                   / \               |
       |&lt;-----------------     -------------&gt;|  *race*
 Mora  |                ACK F5               |
       |------------------------------------&gt;|
  Est  |                                     |  Est
       |                                     |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when the UAS receives a Preparative message while in the Moratorium
             state. All provisional responses to the initial INVITE
             (ini-INVITE F1) are lost, and the UAC retransmits an ini-INVITE
             (F4). At the same time as this retransmission, the UAS generates a
             200 OK (F3) to the ini-INVITE and terminates the INVITE
             server transaction, according to Section 13.3.1.4 of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1].
          <br />
<br />

             However, it is reported that terminating an INVITE server
             transaction when sending 200 OK is a SIP bug. (<a href='http://bugs.sipit.net'>http://bugs.sipit.net</a>,
             #769) Therefore, the INVITE server transaction is not
             terminated by F3, and the F4 MUST be handled properly as a
             retransmission. (UAs that do not deal with this bug still
             need to recognize the dialog by relying on its From tag and
             Call-ID, and the retransmitted request by relying on the CSeq
             header field value even though it does not match the transaction.)
          <br />
<br />

             In <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1], it is not specified
             whether UAS retransmits 200 to the retransmission of ini-INVITE.
             Considering the retransmission of 200 triggered by a timer (the TU
             keeps retransmitting 200 based on T1 and T2 until it receives
             an ACK), according to Section 13.3.1.4 of <a class='info' href='#RFC3261'>RFC
             3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1], it seems unnecessary to retransmit 200 when the
             UAS receives the retransmission of ini-INVITE.  (For implementation,
             it does not matter if the UAS sends the retransmission of 200,
             since the 200 does not cause any problem.)
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 180 response is lost and does not reach Alice. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F3 200 OK Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 According to Section 13.3.1.4 of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1],
                 the INVITE server transaction is terminated at this point.
                 However, this has been reported as a SIP bug, and the UAS MUST
                 correctly recognize the ini-INVITE (F4) as a retransmission. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F4 INVITE (retransmission) Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 F4 is a retransmission of F1.  They are exactly the same INVITE
                 request.  For UAs that have not dealt with bug report #769 (an
                 INVITE server transaction is terminated when sending 200 to INVITE), this
                 request does not match the transaction as well as the dialog
                 since it does not have a To tag.  However, Bob must recognize
                 the retransmitted INVITE correctly, without treating it as a new
                 INVITE. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F5 ACK Alice -> Bob
          
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.2"></a><h3>3.1.2.&nbsp;
Receiving CANCEL (Early state) when in Moratorium state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                        Bob  State
       |                              |
       |          INVITE F1           |
       |-----------------------------&gt;|
  Pre  |       180 Ringing F2         |  Pre
       |&lt;-----------------------------|
  Ear  |                              |  Ear
       |CANCEL F3       200(INVITE) F4|
       |------------     -------------|
       |             \ /              |  Mora
       |              X               |
       |             / \              |
       |&lt;-----------     ------------&gt;|  *race*
 Mora  |                              |
       | ACK F6         200(CANCEL) F5|
       |------------     -------------|
  Est  |             \ /              |
       |              X               |
       |             / \              |
       |&lt;-----------     ------------&gt;|
       |                              |  Est
       |       One Way RTP Media      |
       | (Two Way RTP Media possible) |
       |&lt;=============================|
       |            BYE F7            |
       |-----------------------------&gt;|
 Mort  |            200 F8            |  Mort
       |&lt;-----------------------------|
       | ^                          ^ |
       | | Timer K                  | |
       | V                          | |
 Morg  |                    Timer J | |
       |                            V |
       |                              |  Morg
       |                              |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when the UAS receives an Early message, CANCEL, while in the Moratorium
             state. Alice sends a CANCEL and Bob sends a 200 OK response
             to the initial INVITE message at the same time. As described
             in the previous section, according to <a class='info' href='#RFC3261'>RFC
             3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1], an INVITE server transaction is supposed to be
             terminated by a 200 response, but this has been reported as
             bug #769.
          <br />
<br />

             This section describes a case in which an INVITE server
             transaction is not terminated by a 200 response to the INVITE
             request. In this case, there is an INVITE transaction which
             the CANCEL request matches, so a 200 response to the request is sent.
             This 200 response simply means that the next hop
             receives the CANCEL request (Successful CANCEL (200) does
             not mean an INVITE failure). When a UAS has not dealt with
             bug #769, the UAC MAY receive a 481 response to the CANCEL since there
             is no transaction which the CANCEL request matches. This
             481 simply means that there is no matching INVITE server
             transaction and CANCEL is not sent to the next hop. Regardless
             of the success/failure of the CANCEL, Alice checks the final
             response to the INVITE, and if she receives 200 to the INVITE
             request she immediately sends a BYE and terminates the dialog.
             (Section 15, <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1])
          <br />
<br />

             From the time F1 is received by Bob until the time that F8
             is sent by Bob, media may be flowing one way from Bob to 
             Alice. From the time that an answer is received by Alice 
             from Bob there is the possibility that media may flow from
             Alice to Bob as well. However, once Alice has decided to cancel
             the call, she presumably will not send media, so practically
             speaking the media stream will remain one way.
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 CANCEL Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice sends a CANCEL in the Early state. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F4 200 OK (INVITE) Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice receives a 200 to INVITE (F1) in the Moratorium state.
                 Alice has the potential to send as well as receive media, but in
                 practice will not send because there is an intent to end the
                 call. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F5 200 OK (CANCEL) Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 200 to CANCEL simply means that the CANCEL was received.
                 The 200 response is sent, since this case assumes the fix to bug
                 #769 has been made.  If an INVITE server transaction is terminated
                 according to the procedure stated in 
		 <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1], UAC MAY
                 receive a 481 response instead of 200. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F6 ACK Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 INVITE is successful, and the CANCEL becomes invalid. Bob
                 establishes RTP streams. However, the next BYE request 
                 immediately terminates the dialog and session. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F7 BYE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F8 200 OK Bob -> Alice
          <br />
<br />

          
</p>
<a name="sec.rcv-bye-early-moratorium"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.3"></a><h3>3.1.3.&nbsp;
Receiving BYE (Early state) while in the Moratorium state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                          Bob  State
       |                                |
       |         ini-INVITE F1          |
       |-------------------------------&gt;|
  Pre  |            180 F2              |  Pre
       |&lt;-------------------------------|
  Ear  |                                |  Ear
       |    BYE F4        200(INVITE) F3|
       |-------------     --------------|
 Mort  |              \ /               |  Mora
       |               X                |
       |              / \               |
       |&lt;------------     -------------&gt;|  *race*
       |                                |  Mort
       |    ACK F5         200(BYE) F6  |
       |-------------     --------------|
       |              \ /            ^  |
       |               X             |  |
       |              / \            |  |
       |&lt;------------     -------------&gt;|
       | ^                           |  |
       | | Timer K                   |  |
       | V                           |  |
 Morg  |                     Timer J |  |
       |                             V  |
       |                                |  Morg
       |                                |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when UAS receives an Early message, BYE, while in the Moratorium state.
             Alice sends a BYE in the Early state and Bob sends a 200 OK
             to the initial INVITE request at the same time. Bob
             receives the BYE in the Confirmed dialog state although Alice
             sent the request in the Early state 
	     (As explained in <a class='info' href='#sec.invite-dsm'>Section&nbsp;2<span> (</span><span class='info'>The Dialog State Machine for INVITE dialog usage</span><span>)</span></a>
             and Appendix A, this behavior is NOT RECOMMENDED). When a proxy
             is performing forking, the BYE is only able to terminate the
             early dialog with a particular UA. If the caller wants to terminate
             all early dialogs instead of only that with a particular UA, it needs
             to send CANCEL, not BYE. However, it is not illegal to send
             BYE in the Early state to terminate a specific early dialog
             if that is the caller's intent.
          <br />
<br />

             The BYE functions normally even if it is received after the
             INVITE transaction termination because BYE differs from CANCEL,
             and is sent not to the request but to the dialog. Alice enters
             the Mortal state on sending the BYE request, and remains
             Mortal until the Timer K timeout occurs.  In the Mortal state,
             the UAC does not establish a session, even though it receives a
             200 response to the INVITE. Even so, the UAC sends an ACK to 200
             in order to complete of the INVITE transaction. The ACK is always
             sent to complete the three-way handshake of the INVITE transaction
             (Further explained in Appendix D below).
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK (ini-INVITE) Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 BYE Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice transitions to the Mortal state upon sending BYE.
                 Therefore, after this, she does not begin a session
                 even though she receives a 200 response with an answer. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F5 ACK Alice -> Bob
          <br />
<br />

          <br />
<br />

             F6 200 OK (BYE) Bob -> Alice
          
</p>
<a name="sec.rcv-reinvite-est-moratorium-1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.4"></a><h3>3.1.4.&nbsp;
Receiving re-INVITE (Established state) while in the Moratorium state (case 1)</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                          Bob  State
       |                                |
       |    ini-INVITE w/offer1 F1      |
       |-------------------------------&gt;|
  Pre  |             180 F2             |  Pre
       |&lt;-------------------------------|
  Ear  |                                |  Ear
       |   200(ini-INV) w/answer1 F3    |
       |&lt;-------------------------------|
 Mora  |       ACK F4(packet loss)      |  Mora
       |--------------------&gt;x          |
  Est  |                                |
       | re-INVITE F6      200 F5(=F3)  |
       |   w/offer2         w/answer1   |
       |-------------     --------------|
       |              \ /               |
       |               X                |
       |              / \               |
       |&lt;------------     -------------&gt;|  *race*
       |                  200(re-INV) F8|
       | ACK F7(=F4)        w/answer2   |
       |-------------     --------------|
       |              \ /               |
       |               X                |
       |              / \               |
       |&lt;------------     -------------&gt;|
       |         ACK (re-INV) F9        |  Est
       |-------------------------------&gt;|
       |                                |
       |                                |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when the UAS receives a re-INVITE request sent from the Established
             state, while in the Moratorium state.
          <br />
<br />

             The UAS receives a re-INVITE (w/offer2) before receiving an
             ACK for ini-INVITE (w/offer1). The UAS sends a 200 OK
             (w/answer2) to the re-INVITE (F8) because it has sent a
             200 OK (w/answer1) to the ini-INVITE (F3, F5) and the dialog
             has already been established. (Because F5 is a retransmission
             of F3, SDP negotiation is not performed here.)
          <br />
<br />

             If a 200 OK to the ini-INVITE contains an offer and the answer
             is in the ACK, it is recommended that the UA return a 491 to
             the re-INVITE (refer to 
	     <a class='info' href='#sec.rcv-reinvite-est-moratorium-2'>Section&nbsp;3.1.5<span> (</span><span class='info'>Receiving re-INVITE (Established state) while in the Moratorium state (case 2)</span><span>)</span></a>). 
	     (Note: 500 with a Retry-After
             header may be returned, if the 491 response is understood
             to indicate request collision. However, 491 is recommended
             here because 500 applies to so many cases that it is difficult
             to determine what the real problem was.) As can be seen in
             <a class='info' href='#sec.update-reinvite-cross'>Section&nbsp;3.3.2<span> (</span><span class='info'>UPDATE and re-INVITE crossover</span><span>)</span></a> below, 
	     the 491 response seems to be closely
             related to session establishment, even in cases other than
             INVITE cross-over. This example recommends that 200 be sent instead
             of 491 because it does not have an influence on the session. However,
             a 491 response can also lead to the same outcome, 
	     so either response can be used.
          <br />
<br />

             Moreover, if UAS doesn't receive an ACK for a long time,
             it should send a BYE and terminate the dialog. Note that
             ACK F7 has the same CSeq number as ini-INVITE F1 (See 
             Section 13.2.2.4 of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1]).
             The UA should not reject or drop the ACK on grounds of the CSeq
             number.
          <br />
<br />

             Note: Here is a hint for implementors to avoid race conditions of this type. 
	     That is for the caller to delay
             sending re-INVITE F6 for some period of time (2 seconds,
             perhaps), after which the caller can reasonably
             assume that its ACK has been received. Implementors can
             decouple the actions of the user (e.g. pressing the hold
             button) from the actions of the protocol (the sending of
             re-INVITE F6), so that the UA can behave like this. In this case,
             it is the implementor's choice as to how long to wait.
             In most cases, such an implementation may be useful to prevent
             the type of race condition shown in this section.
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

F1 INVITE Alice -> Bob
          <br />
<br />

INVITE sip:bob@biloxi.example.com SIP/2.0
          <br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf9
          <br />

Max-Forwards: 70
          <br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
          <br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;
          <br />

Call-ID: 3848276298220188511@atlanta.example.com
          <br />

CSeq: 1 INVITE
          <br />

Contact: &lt;sip:alice@client.atlanta.example.com;transport=udp&gt;
          <br />

Content-Type: application/sdp
          <br />

Content-Length: 137
          <br />
<br />

v=0
          <br />

o=alice 2890844526 2890844526 IN IP4 client.atlanta.example.com
          <br />

s=-
          <br />

c=IN IP4 192.0.2.101
          <br />

t=0 0
          <br />

m=audio 49172 RTP/AVP 0
          <br />

a=rtpmap:0 PCMU/8000
          <br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Detailed messages are shown for the sequence to illustrate the offer
                 and answer examples.  &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

F2 180 Ringing Bob -> Alice
          <br />
<br />

SIP/2.0 180 Ringing
          <br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf9
          <br />

 ;received=192.0.2.101
          <br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
          <br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
          <br />

Call-ID: 3848276298220188511@atlanta.example.com
          <br />

CSeq: 1 INVITE
          <br />

Contact: &lt;sip:bob@client.biloxi.example.com;transport=udp&gt;
          <br />

Content-Length: 0
          <br />
<br />

          <br />
<br />

F3 200 OK Bob -> Alice
          <br />
<br />

SIP/2.0 200 OK
          <br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf9
          <br />

 ;received=192.0.2.101
          <br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
          <br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
          <br />

Call-ID: 3848276298220188511@atlanta.example.com
          <br />

CSeq: 1 INVITE
          <br />

Contact: &lt;sip:bob@client.biloxi.example.com;transport=udp&gt;
          <br />

Content-Type: application/sdp
          <br />

Content-Length: 133
          <br />
<br />

v=0
          <br />

o=bob 2890844527 2890844527 IN IP4 client.biloxi.example.com
          <br />

s=-
          <br />

c=IN IP4 192.0.2.201
          <br />

t=0 0
          <br />

m=audio 3456 RTP/AVP 0
          <br />

a=rtpmap:0 PCMU/8000
          <br />
<br />

          <br />
<br />

F4 ACK Alice -> Bob
          <br />
<br />

ACK sip:bob@client.biloxi.example.com SIP/2.0
          <br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bKnashd8
          <br />

Max-Forwards: 70
          <br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
          <br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
          <br />

Call-ID: 3848276298220188511@atlanta.example.com
          <br />

CSeq: 1 ACK
          <br />

Content-Length: 0
          <br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 ACK request is lost.  &nbsp;*/
              
</dd>
</dl></blockquote><p>
<br />
<br />

             F5(=F3) 200 OK Bob -> Alice (retransmission)
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 UAS retransmits a 200 OK to the ini-INVITE since it has not
                 received an ACK. &nbsp;*/
              
</dd>
</dl></blockquote><p>

<br />
<br />

F6 re-INVITE Alice -> Bob
<br />
<br />

INVITE sip:sip:bob@client.biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf91
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 2 INVITE
<br />

Content-Length: 147
<br />
<br />

v=0
<br />

o=alice 2890844526 2890844527 IN IP4 client.atlanta.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.101
<br />

t=0 0
<br />

m=audio 49172 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

a=sendonly
<br />
<br />

          <br />
<br />

             F7(=F4) ACK Alice -> Bob (retransmission)
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
"(=F4)" of ACK F7 shows that it is equivalent to F4 in that it is an
ACK for F3. This doesn't mean that F4 and F7 must be equal in Via-branch value.
Although it is ambiguous whether Via-branch of ACK F7 differs from F4 in
RFC3261, it doesn't affect UAS's behavior. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

F8 200 OK (re-INVITE) Bob -> Alice
          <br />
<br />

SIP/2.0 200 OK
          <br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf91
          <br />

Max-Forwards: 70
          <br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
          <br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
          <br />

Call-ID: 3848276298220188511@atlanta.example.com
          <br />

CSeq: 2 INVITE
          <br />

Content-Length: 143
          <br />
<br />

v=0
          <br />

o=bob 2890844527 2890844528 IN IP4 client.biloxi.example.com
          <br />

s=-
          <br />

c=IN IP4 192.0.2.201
          <br />

t=0 0
          <br />

m=audio 3456 RTP/AVP 0
          <br />

a=rtpmap:0 PCMU/8000
          <br />

a=recvonly
          <br />
<br />

          <br />
<br />

F9 ACK (re-INVITE) Alice -> Bob
<br />
<br />

ACK sip:sip:bob@client.biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK230f21
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 2 ACK
<br />

Content-Length: 0
<br />
<br />


</p>
<a name="sec.rcv-reinvite-est-moratorium-2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.5"></a><h3>3.1.5.&nbsp;
Receiving re-INVITE (Established state) while in the Moratorium state (case 2)</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                          Bob  State
       |                                |
       |    ini-INVITE (no offer) F1    |
       |-------------------------------&gt;|
  Pre  |             180 F2             |  Pre
       |&lt;-------------------------------|
  Ear  |                                |  Ear
       |    200(ini-INV) w/offer1 F3    |
       |&lt;-------------------------------|
 Mora  |  ACK w/answer1 F4(packet loss) |  Mora
       |--------------------&gt;x          |
  Est  |                                |
       | re-INVITE F6      200 F5(=F3)  |
       |   w/offer2         w/offer1    |
       |-------------     --------------|
       |              \ /               |
       |               X                |
       |              / \               |
       |&lt;------------     -------------&gt;|
       | ACK F7(=F4)      491(re-INV) F8|
       |-------------     --------------|
       |              \ /               |
       |               X                |
       |              / \               |
       |&lt;------------     -------------&gt;|
       |        ACK (re-INV) F9         |  Est
       |-------------------------------&gt;|
       |                                |
       |                                |
</pre></div>
<p>This scenario is basically the same as that of 
	     <a class='info' href='#sec.rcv-reinvite-est-moratorium-1'>Section&nbsp;3.1.4<span> (</span><span class='info'>Receiving re-INVITE (Established state) while in the Moratorium state (case 1)</span><span>)</span></a>,
             but differs in sending an offer in the 200 and an answer in the ACK.
             In contrast to the previous case, the offer in the 200 (F3)
             and the offer in the re-INVITE (F6) collide with each other.
          <br />
<br />

             Bob sends a 491 to the re-INVITE (F6) since he is not able to
             properly handle a new request until he receives an answer.
             (Note: 500 with Retry-After header may be returned, if the
             491 response is understood to indicate request collision.
             However, 491 is recommended here because 500 applies to so
             many cases that it is difficult to determine what the real
             problem was.) The same result will be reached if F6 is 
	     an UPDATE with offer.
          <br />
<br />

             Note: As noted in <a class='info' href='#sec.rcv-reinvite-est-moratorium-1'>Section&nbsp;3.1.4<span> (</span><span class='info'>Receiving re-INVITE (Established state) while in the Moratorium state (case 1)</span><span>)</span></a>, 
	     it may be useful for the
             caller to delay sending a re-INVITE F6 for some period of time
             (2 seconds, perhaps), after which the caller may reasonably
             assume that its ACK has been received, to prevent this
             type of race condition.
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

F1 INVITE Alice -> Bob
          <br />
<br />

INVITE sip:bob@biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf9
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 1 INVITE
<br />

Contact: &lt;sip:alice@client.atlanta.example.com;transport=udp&gt;
<br />

Content-Length: 0
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 The request does not contain an offer. Detailed messages are
                 shown for the sequence to illustrate offer and answer examples. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

F3 200 OK Bob -> Alice
<br />
<br />

SIP/2.0 200 OK
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf9
<br />

 ;received=192.0.2.101
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 1 INVITE
<br />

Contact: &lt;sip:bob@client.biloxi.example.com;transport=udp&gt;
<br />

Content-Type: application/sdp
<br />

Content-Length: 133
<br />
<br />

v=0
<br />

o=bob 2890844527 2890844527 IN IP4 client.biloxi.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.201
<br />

t=0 0
<br />

m=audio 3456 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 An offer is made in 200. &nbsp;*/
              
</dd>
</dl></blockquote><p>
<br />
<br />

F4 ACK Alice -> Bob
<br />
<br />

ACK sip:bob@client.biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bKnashd8
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 1 ACK
<br />

Content-Type: application/sdp
<br />

Content-Length: 137
<br />
<br />

v=0
<br />

o=alice 2890844526 2890844526 IN IP4 client.atlanta.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.101
<br />

t=0 0
<br />

m=audio 49172 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 The request contains an answer, but the request is lost. &nbsp;*/
              
</dd>
</dl></blockquote><p>
            <br />
<br />

             F5(=F3) 200 OK Bob -> Alice (retransmission)
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 UAS retransmits a 200 OK to the ini-INVITE since it has not
                 received an ACK. &nbsp;*/
              
</dd>
</dl></blockquote><p>
            <br />
<br />

F6 re-INVITE Alice -> Bob
<br />
<br />

INVITE sip:sip:bob@client.biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf91
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 2 INVITE
<br />

Content-Length: 147
<br />
<br />

v=0
<br />

o=alice 2890844526 2890844527 IN IP4 client.atlanta.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.101
<br />

t=0 0
<br />

m=audio 49172 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

a=sendonly
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 The request contains an offer. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F7(=F4) ACK Alice -> Bob (retransmission)
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 A retransmission triggered by the reception of a retransmitted
                 200. "(=F4)" of ACK F7 shows that it is equivalent to the F4 
		 in that it is an ACK for F3. This doesn't mean that F4 and F7 
		 are necessarily equal in Via-branch value.
		 Although it is ambiguous whether Via-branch of ACK F7 differs 
		 from F4 in RFC3261, it doesn't affect UAS's behavior. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F8 491 (re-INVITE) Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Bob sends 491 (Request Pending), since Bob has a pending
                 offer. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F9 ACK (re-INVITE) Alice -> Bob
          
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.6"></a><h3>3.1.6.&nbsp;
Receiving BYE (Established state) while in the Moratorium state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                     Bob  State
       |                           |
       |         INVITE F1         |
       |--------------------------&gt;|
  Pre  |      180 Ringing F2       |  Pre
       |&lt;--------------------------|
  Ear  |                           |  Ear
       |         200 OK F3         |
       |&lt;--------------------------|
 Mora  |    ACK F4(packet loss)    |  Mora
       |---------------&gt;x          |
  Est  |   Both Way RTP Media      |
       |&lt;=========================&gt;|
       |   BYE F6       200 F5(=F3)|
       |-----------     -----------|
 Mort  |            \ /            |
       |             X             |
       |            / \            |
       |&lt;----------     ----------&gt;|  *race*
       |ACK F7(=F4)     200(BYE) F8|  Mort
       |-----------     -----------|
       |            \ /            |
       |             X             |
       |            / \            |
       |&lt;----------     ----------&gt;|
       | ^                       ^ |
       | | Timer K               | |
       | V                       | |
 Morg  |                 Timer J | |
       |                         V |
       |                           |  Morg
       |                           |
</pre></div>
<p>This scenario illustrates the race condition which occurs
            when the UAS receives an Established message, BYE, while in the
            Moratorium state. An ACK request for a 200 OK response is
            lost (or delayed). Bob retransmits the 200 OK to the
            ini-INVITE, and at the same time Alice sends a BYE request
            and terminates the session. Upon receipt of retransmitted
            200 OK Alice's UA might be inclined to reestablish the session.
            But that is wrong - the session should not be reestablished
            when the dialog is in the Mortal state. Moreover, in the case
            where the UAS sends an offer in a 200 OK, the UAS should not start a
            session again, for the same reason, if the UAS receives a
            retransmitted ACK after receiving a BYE.
          <br />
<br />

             Note: As noted in <a class='info' href='#sec.rcv-reinvite-est-moratorium-1'>Section&nbsp;3.1.4<span> (</span><span class='info'>Receiving re-INVITE (Established state) while in the Moratorium state (case 1)</span><span>)</span></a>, 
	     there is a hint for
             implementors to avoid race conditions of this type.
             That is for the caller to delay sending BYE F6 for some
             period of time (2 seconds, perhaps), after which the caller
             can reasonably assume that its ACK has been received.
             Implementors can decouple the actions of the user (e.g.
             hanging up) from the actions of the protocol (the sending of
             BYE F6), so that the UA can behave like this.  In this case, it is
             the implementor's choice as to how long to wait.
             In most cases, such an implementation may be useful to prevent
             the type of race condition shown in this section.
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 ACK Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 ACK request is lost. &nbsp;*/
              
</dd>
</dl></blockquote><p>
<br />
<br />

             F5(=F3) 200 OK Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 UAS retransmits a 200 OK to the ini-INVITE since it has not
                 received an ACK. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F6 BYE Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Bob retransmits a 200 OK and Alice sends a BYE at the same time.
                 Alice transitions to the Mortal state, so she does not begin a
                 session after this even though she receives a 200 response to
                 the re-INVITE. &nbsp;*/
              
</dd>
</dl></blockquote><p>
<br />
<br />

             F7(=F4) ACK Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
"(=F4)" of ACK F7 shows that it is equivalent to the F4 in that it is an
ACK for F3. This doesn't mean that F4 and F7 must be equal in Via-branch value.
Although it is ambiguous whether Via-branch of ACK F7 differs from F4 in
RFC3261, it doesn't affect UAS's behavior. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F8 200 OK (BYE) Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Bob sends a 200 OK to the BYE. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

          
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Receiving message in the Mortal State</h3>

<p>This section shows some examples of call flow race conditions
           when receiving messages from other states while in the Mortal state.
        
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.1"></a><h3>3.2.1.&nbsp;
Receiving BYE (Established state) while in the Mortal state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                  Bob  State
       |                        |
       |       INVITE F1        |
       |-----------------------&gt;|
  Pre  |    180 Ringing F2      |  Pre
       |&lt;-----------------------|
  Ear  |                        |  Ear
       |       200 OK F3        |
       |&lt;-----------------------|
 Mora  |         ACK F4         |  Mora
       |-----------------------&gt;|
  Est  |   Both Way RTP Media   |  Est
       |&lt;======================&gt;|
       |                        |
       | BYE F5         BYE F6  |
       |---------     ----------|
 Mort  |          \ /           |  Mort
       |           X            |
       |          / \           |
       |&lt;--------     ---------&gt;|  *race*
       |                        |
       | 200 F8         200 F7  |
       |---------     ----------|
       |          \ /           |
       |           X            |
       |          / \           |
       |&lt;--------     ---------&gt;|
       | ^                    ^ |
       | | Timer K            | |
       | V                    | |
 Morg  |              Timer J | |
       |                      V |
       |                        |  Morg
       |                        |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when the UAS receives an Established message, BYE, while in the
             Mortal state. Alice and Bob send a BYE at the same time.
             A dialog and session are ended shortly after a BYE request
             is passed to a client transaction. As shown in 
	     <a class='info' href='#sec.invite-dsm'>Section&nbsp;2<span> (</span><span class='info'>The Dialog State Machine for INVITE dialog usage</span><span>)</span></a>, the UA remains in the Mortal state.
          <br />
<br />

             UAs in the Mortal state return error responses to the requests
             that operate within a dialog or session, such as re-INVITE, UPDATE,
             or REFER. However, the UA shall return 200 OK to the BYE taking
             the use case into consideration where a BYE request is sent by
             both a caller and a callee to exchange reports about the
             session when it is being terminated. (Since the dialogue and
             the session both terminate when a BYE is sent, the choice of
             sending a 200 or an error response upon receiving a BYE while in the
             Mortal state does not affect the resulting termination.
             Therefore, even though this example uses a 200 response,
             other responses can also be used.)
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 ACK Alice -> Bob
          <br />
<br />

          <br />
<br />

             F5 BYE Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 The session is terminated at the moment Alice sends a BYE.
                 The dialog still exists then, but it is certain to be terminated
                 in a short period of time. The dialog is completely terminated
                 when the timeout of the BYE request occurs. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F6 BYE Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Bob has also transmitted a BYE simultaneously with Alice.
                 Bob terminates the session and the dialog. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F7 200 OK Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since the dialog is in the Moratorium state, Bob responds with
                 a 200 to the BYE request. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F8 200 OK Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since Alice has transitioned from the Established state to the Mortal
                 state by sending a BYE, Alice responds with a 200 to the BYE
                 request. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

          
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.2"></a><h3>3.2.2.&nbsp;
Receiving re-INVITE (Established state) while in the Mortal state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 State  Alice                  Bob  State
        |                        |
        |       INVITE F1        |
        |-----------------------&gt;|
   Pre  |    180 Ringing F2      |  Pre
        |&lt;-----------------------|
   Ear  |                        |  Ear
        |       200 OK F3        |
        |&lt;-----------------------|
  Mora  |         ACK F4         |  Mora
        |-----------------------&gt;|
   Est  |   Both Way RTP Media   |  Est
        |&lt;======================&gt;|
        |                        |
        | BYE F5     re-INVITE F6|
        |---------     ----------|
  Mort  |          \ /           |
        |           X            |
        |          / \           |
*race*  |&lt;--------     ---------&gt;|
        |                        |  Mort
        | 481 F8         200 F7  |
        | (re-INV)       (BYE)   |
        |---------     ----------|
        |          \ /           |^
        |           X            ||
        |          / \           ||Timer J
        |&lt;--------     ---------&gt;||
       ^|    ACK (re-INV) F9     ||
       ||&lt;-----------------------||
Timer K||                        ||
       V|                        ||
  Morg  |                        |V
        |                        |  Morg
        |                        |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when the UAS receives an Established message, re-INVITE, while in the
             Mortal state. Bob sends a re-INVITE, and Alice sends a BYE
             at the same time. The re-INVITE receives a 481 response, since
             the TU of Alice has transitioned from the Established state to
             the Mortal state by sending BYE. Bob sends an ACK for the 481
             response, because the ACK for error responses is handled by
             the transaction layer and at the point of receiving the 481
             the INVITE client transaction still remains (even though the
             dialog has been terminated).
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 ACK Alice -> Bob
          <br />
<br />

          <br />
<br />

             F5 BYE Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice sends a BYE and terminates the session, and transitions from
                 the Established state to the Mortal state. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F6 re-INVITE Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice sends a BYE, and Bob sends a re-INVITE at the same time.
                 The dialog state transitions to the Mortal state at the moment
                 Alice sends the BYE, but Bob does not know this until he receives
                 the BYE. Therefore, the dialog is in the Terminated state from
                 Alice's point of view, but in the Confirmed state from Bob's
                 point of view. A race condition occurs. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F7 200 OK (BYE) Bob -> Alice
          <br />
<br />

          <br />
<br />

             F8 481 Call/Transaction Does Not Exist (re-INVITE) Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since Alice is in the Mortal state, she responds with a 481 to the
                 re-INVITE. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F9 ACK (re-INVITE) Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 ACK for an error response is handled by Bob's INVITE client
                 transaction. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

          
</p>
<a name="sec.rcv-200-reinvite-mortal"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.3"></a><h3>3.2.3.&nbsp;
Receiving 200 OK for re-INVITE (Established state) while in the Mortal state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                  Bob  State
       |                        |
       |       INVITE F1        |
       |-----------------------&gt;|
  Pre  |    180 Ringing F2      |  Pre
       |&lt;-----------------------|
  Ear  |                        |  Ear
       |       200 OK F3        |
       |&lt;-----------------------|
 Mora  |         ACK F4         |  Mora
       |-----------------------&gt;|
  Est  |   Both Way RTP Media   |  Est
       |&lt;======================&gt;|
       |                        |
       |      re-INVITE F5      |
       |&lt;-----------------------|
       | 200 F7         BYE F6  |
       |---------     ----------|
       |          \ /           |  Mort
       |           X            |
       |          / \           |
       |&lt;--------     ---------&gt;|  *race*
 Mort  | 200 F8         ACK F9  |
       | (BYE)         (re-INV) |
       |---------     ----------|
       | ^        \ /           |
       | |         X            |
       | |        / \           |
       |&lt;--------     ---------&gt;|
       | |                    ^ |
       | |            Timer K | |
       | |                    V |
       | | Timer J              |  Morg
       | V                      |
 Morg  |                        |
       |                        |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when the UAS receives an Established message, 200 to a re-INVITE,
             while in the Mortal state. Bob sends a BYE immediately after
             sending a re-INVITE. (For example, in the case of
             a telephone application, it is possible that a user hangs up
             the phone immediately after refreshing the session.) Bob sends an ACK for
             a 200 response to INVITE while in the Mortal state, 
             completing the INVITE transaction.
          <br />
<br />

             Note: As noted in <a class='info' href='#sec.rcv-reinvite-est-moratorium-1'>Section&nbsp;3.1.4<span> (</span><span class='info'>Receiving re-INVITE (Established state) while in the Moratorium state (case 1)</span><span>)</span></a>, 
	     there is a hint for implementators to avoid race conditions of this type.
             That is for the UAC to delay sending a BYE F6 until the re-INVITE
             transaction F5 completes. Implementors can decouple the
             actions of the user (e.g. hanging up) from the actions of
             the protocol (the sending of BYE F6), so that the UA can behave
             like this. In this case, it is the implementor's
             choice as to how long to wait. In most cases, such an implementation
             may be useful in preventing the type of race condition described in
             this section.
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 ACK Alice -> Bob
          <br />
<br />

          
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
F5 re-INVITE Bob -&gt; Alice

INVITE sip:alice@client.atlanta.example.com SIP/2.0
Via: SIP/2.0/UDP client.biloxi.example.com:5060;branch=z9hG4bKnashd7
Session-Expires: 300;refresher=uac
Supported: timer
Max-Forwards: 70
From: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
To: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
Call-ID: 3848276298220188511@atlanta.example.com
CSeq: 1 INVITE
Content-Length: 0
</pre></div>
<p>
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Some detailed messages are shown for the sequence to illustrate
                 that the re-INVITE is handled in the usual manner in the Mortal
                 state. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F6 BYE Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Bob sends BYE immediately after sending the re-INVITE.
                 Bob terminates the session and transitions from the Established
                 state to the Mortal state. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

F7 200 OK (re-INVITE) Alice -> Bob
          <br />
<br />

SIP/2.0 200 OK
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bKnashd7
<br />

 ;received=192.0.2.201
<br />

Require: timer
<br />

Session-Expires: 300;refresher=uac
<br />

From: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

To: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 1 INVITE
<br />

Content-Length: 0
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Bob sends BYE, and Alice responds with a 200 OK to the re-INVITE.
                 A race condition occurs. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F8 200 OK (BYE) Alice -> Bob
          <br />
<br />

          <br />
<br />

F9 ACK (re-INVITE) Bob -> Alice
<br />
<br />

ACK sip:alice@client.atlanta.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.biloxi.example.com:5060;branch=z9hG4bK74b44
<br />

Max-Forwards: 70
<br />

From: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

To: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 2 ACK
<br />

Content-Length: 0
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Bob sends ACK in the Mortal state to complete the three-way
                 handshake of the INVITE transaction. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

          
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.4"></a><h3>3.2.4.&nbsp;
Receiving ACK (Moratorium state) while in the Mortal state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
State  Alice                          Bob  State
       |                                |
       |         ini-INVITE F1          |
       |-------------------------------&gt;|
  Pre  |            180 F2              |  Pre
       |&lt;-------------------------------|
  Ear  |            200 F3              |  Ear
       |&lt;-------------------------------|
 Mora  |                                |  Mora
       |    ACK F4            BYE F5    |
       |-------------     --------------|
  Est  |              \ /               |  Mort
       |               X                |
       |              / \               |
       |&lt;------------     -------------&gt;|  *race*
 Mort  |            200 F6              |
       |-------------------------------&gt;|
       | ^                            ^ |
       | |                    Timer K | |
       | |                            V |
       | | Timer J                      |  Morg
       | V                              |
 Morg  |                                |
       |                                |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when the UAS receives an Established message, ACK to 200, while in
             the Mortal state. Alice sends an ACK and Bob sends a BYE
             at the same time. When the offer is in a 2xx, and the
             answer is in an ACK, there is a race condition.
             A session is not started when the ACK is received because
             Bob has already terminated the session by sending a BYE.
             The answer in the ACK request is just ignored.
          <br />
<br />

             Note: As noted in <a class='info' href='#sec.rcv-reinvite-est-moratorium-1'>Section&nbsp;3.1.4<span> (</span><span class='info'>Receiving re-INVITE (Established state) while in the Moratorium state (case 1)</span><span>)</span></a>, 
	     there is a hint for
             implementors to avoid race conditions of this type.
             Implementors can decouple the actions of the user (e.g.
             hanging up) from the actions of the protocol (the sending
             of BYE F5), so that the UA can behave like this. In this case, it
             is the implementor's choice as to how long to wait.
             In most cases, such an implementation may be useful in preventing the
             type of race condition described in this section.
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 ACK Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 RTP streams are established between Alice and Bob &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F5 BYE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F6 200 OK Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice sends a BYE and terminates the session and dialog. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

          
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Other race conditions</h3>

<p>This section shows examples of race conditions that are not
           directly related to dialog state transition. In SIP,
           processing functions are deployed in three layers, dialog,
           session, and transaction. They are related each other, but
           have to be treated separately. Section 17 of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1] details the processing of transactions. This
           draft has tried so far to clarify the processing on dialogs.
           This section explains race conditions which are related to
           sessions established with SIP.
        
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.1"></a><h3>3.3.1.&nbsp;
Re-INVITE crossover</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Alice                         Bob
  |                            |
  |         INVITE F1          |
  |---------------------------&gt;|
  |      180 Ringing F2        |
  |&lt;---------------------------|
  |          200 OK F3         |
  |&lt;---------------------------|
  |           ACK F4           |
  |---------------------------&gt;|
  |     Both Way RTP Media     |
  |&lt;==========================&gt;|
  |                            |
  |re-INVITE F5   re-INVITE F6 |
  |------------   -------------|
  |            \ /             |
  |             X              |
  |            / \             |
  |&lt;-----------   ------------&gt;|
  |   491 F8        491 F7     |
  |------------   -------------|
  |            \ /             |
  |             X              |
  |            / \             |
  |&lt;-----------   ------------&gt;|
  |  ^ ACK F9         ^ ACK F10|
  |--|---------   ----|--------|
  |  |          \ /   |        |
  |  |           X    |        |
  |  |          / \   |        |
  |&lt;-|----------   ---|-------&gt;|
  |  |                |        |
  |  |0-2.0 sec       |        |
  |  |                |        |
  |  v  re-INVITE F11(=F6)     |
  |&lt;------------------|--------|
  |     200 OK F12    |        |
  |-------------------|-------&gt;|
  |       ACK F13     |        |
  |&lt;------------------|--------|
  |                   |        |
  |                   |2.1-4.0 sec
  |                   |        |
  |re-INVITE F14(=F5) v        |
  |---------------------------&gt;|
  |         200 OK F15         |
  |&lt;---------------------------|
  |          ACK F16           |
  |---------------------------&gt;|
  |                            |
  |                            |
</pre></div>
<p>In this scenario, Alice and Bob send re-INVITE at the same
             time. When two re-INVITEs cross in the same dialog, they
             are retried, each after a different interval, according
             to Section 14.1, of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1]. When
             Alice sends the re-INVITE and it crosses with Bob's, the re-INVITE will
             be retried after 2.1-4.0 seconds because she owns the
             Call-ID (she generated it). Bob will retry his INVITE again
             after 0.0-2.0 seconds, because Bob isn't the owner of the
             Call-ID. Therefore, each user agent must remember whether
             it has generated the Call-ID of the dialog or not, in case
             an INVITE may cross with another INVITE.
          <br />
<br />

             In this example, Alice's re-INVITE is for session modification
             and Bob's re-INVITE is for session refresh.  In this case,
             after the 491 responses, Bob retransmits the re-INVITE for
             session refresh earlier than Alice. If Alice was to retransmit
             her re-INVITE (that is, if she was not the owner of Call-ID),
             the request would refresh and modify the session at the same
             time. Then Bob would know that he would not need to retransmit
             his re-INVITE to refresh the session.
          <br />
<br />

             In another instance where two re-INVITEs for session modification,
             cross over, retransmitting the same re-INVITE again after a
             491 by the Call-ID owner (the UA which retransmits its re-INVITE
             after the other UA) may result in unintended behavior, so the UA must decide
             if the retransmission of the re-INVITE is necessary. (For
             example, when a call hold and an addition of video media cross
             over, mere retransmission of the re-INVITE at the firing of
             the timer may result in the situation where the video is
             transmitted immediately after the holding of the audio.  This
             behavior is probably not intended by the users.)
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 ACK Alice -> Bob
          <br />
<br />

          <br />
<br />

F5 re-INVITE Alice -> Bob
<br />
<br />

INVITE sip:sip:bob@client.biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf9
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 2 INVITE
<br />

Content-Length: 147
<br />
<br />

v=0
<br />

o=alice 2890844526 2890844527 IN IP4 client.atlanta.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.101
<br />

t=0 0
<br />

m=audio 49172 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

a=sendonly
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Some detailed messages are shown for the sequence to illustrate
                 what sort of INVITE requests crossed over each other. &nbsp;*/
              
</dd>
</dl></blockquote><p>
<br />
<br />

F6 re-INVITE Bob -> Alice
<br />
<br />

INVITE sip:alice@client.atlanta.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.biloxi.example.com:5060;branch=z9hG4bKnashd7
<br />

Session-Expires: 300;refresher=uac
<br />

Supported: timer
<br />

Max-Forwards: 70
<br />

From: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

To: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 1 INVITE
<br />

Content-Length: 0
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 A re-INVITE request for a session refresh and another for a call hold
                 are sent at the same time. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F7 491 Request Pending Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since a re-INVITE is in progress, a 491 response is returned. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F8 491 Request Pending Alice -> Bob
          <br />
<br />

          <br />
<br />

             F9 ACK (INVITE) Alice -> Bob
          <br />
<br />

          <br />
<br />

             F10 ACK (INVITE) Bob -> Alice
          <br />
<br />

          <br />
<br />

F11 re-INVITE Bob -> Alice
          <br />
<br />

INVITE sip:alice@client.atlanta.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.biloxi.example.com:5060;branch=z9hG4bKnashd71
<br />

Session-Expires: 300;refresher=uac
<br />

Supported: timer
<br />

Max-Forwards: 70
<br />

From: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

To: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 2 INVITE
<br />

Content-Type: application/sdp
<br />

Content-Length: 133
<br />
<br />

v=0
<br />

o=bob 2890844527 2890844527 IN IP4 client.biloxi.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.201
<br />

t=0 0
<br />

m=audio 3456 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since Bob is not the owner of the Call-ID, he sends a re-INVITE
                 again after 0.0-2.0 seconds. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F12 200 OK Alice -> Bob
          <br />
<br />

          <br />
<br />

             F13 ACK Bob -> Alice
          <br />
<br />

          <br />
<br />

F14 re-INVITE Alice -> Bob
          <br />
<br />

INVITE sip:sip:bob@client.biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf91
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 3 INVITE
<br />

Content-Length: 147
<br />
<br />

v=0
<br />

o=alice 2890844526 2890844527 IN IP4 client.atlanta.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.101
<br />

t=0 0
<br />

m=audio 49172 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

a=sendonly
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since Alice is the owner of the Call-ID, Alice sends a re-INVITE
                 again after 2.1-4.0 seconds. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F15 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F16 ACK Alice -> Bob
          
          
</p>
<a name="sec.update-reinvite-cross"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.2"></a><h3>3.3.2.&nbsp;
UPDATE and re-INVITE crossover</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Alice                         Bob
  |                            |
  |         INVITE F1          |
  |---------------------------&gt;|
  |      180 Ringing F2        |
  |&lt;---------------------------|
  |                            |
  |          200 OK F3         |
  |&lt;---------------------------|
  |           ACK F4           |
  |---------------------------&gt;|
  |     Both Way RTP Media     |
  |&lt;==========================&gt;|
  |                            |
  |  UPDATE F5    re-INVITE F6 |
  |------------   -------------|
  |            \ /             |
  |             X              |
  |            / \             |
  |&lt;-----------   ------------&gt;|
  |   491 F8        491 F7     |
  |   (re-INVITE)   (UPDATE)   |
  |------------   -------------|
  |            \ /             |
  |             X              |
  |            / \             |
  |&lt;-----------   ------------&gt;|
  |  ^       ACK F9   ^        |
  |&lt;-|----------------|--------|
  |  |                |        |
  |  |0-2.0 sec       |        |
  |  |                |        |
  |  v  re-INVITE F10 |        |
  |&lt;------------------|--------|
  |     200 OK F11    |        |
  |-------------------|-------&gt;|
  |       ACK F12     |        |
  |&lt;------------------|--------|
  |                   |        |
  |                   |2.1-4.0 sec
  |                   |        |
  |      UPDATE F13   v        |
  |---------------------------&gt;|
  |         200 OK F14         |
  |&lt;---------------------------|
  |                            |
  |                            |
</pre></div>
<p>In this scenario, the UPDATE contains an SDP offer, therefore
             the UPDATE and re-INVITE are both responded to with 491 as in the
             case of "re-INVITE crossover". When an UPDATE for session refresh
             which doesn't contain a session description and a re-INVITE
             cross each other, both requests succeed with 200 (491
             means that a UA has a pending request). The same is
             true for UPDATE crossover. In the former case where
             either UPDATE contains a session description the requests
             fail with 491, and in the latter cases succeed with 200.
            </p>
<blockquote class="text"><dl>
<dt>Note:</dt>
<dd>
              
                 A 491 response is sent because an SDP offer is pending, and
                 491 is an error which is related to matters that impact
                 the session established by SIP.
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 ACK Alice -> Bob
          <br />
<br />

          <br />
<br />

F5 UPDATE Alice -> Bob
          <br />
<br />

UPDATE sip:sip:bob@client.biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf9
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 2 UPDATE
<br />

Content-Length: 147
<br />
<br />

v=0
<br />

o=alice 2890844526 2890844527 IN IP4 client.atlanta.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.101
<br />

t=0 0
<br />

m=audio 49172 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

a=sendonly
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Some detailed messages are shown for the sequence to illustrate
                 messages crossing over each other. &nbsp;*/
              
</dd>
</dl></blockquote><p>
<br />
<br />

F6 re-INVITE Bob -> Alice
<br />
<br />

INVITE sip:alice@client.atlanta.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.biloxi.example.com:5060;branch=z9hG4bKnashd7
<br />

Session-Expires: 300;refresher=uac
<br />

Supported: timer
<br />

Max-Forwards: 70
<br />

From: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

To: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 1 INVITE
<br />

Content-Length: 0
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 A case where a re-INVITE for a session refresh and a UPDATE for a
                 call hold are sent at the same time. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F7 491 Request Pending (UPDATE) Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since a re-INVITE is in process, a 491 response is returned. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F8 491 Request Pending (re-INVITE) Alice -> Bob
          <br />
<br />

          <br />
<br />

             F9 ACK (re-INVITE) Alice -> Bob
          <br />
<br />

          <br />
<br />

F10 re-INVITE Bob -> Alice
          <br />
<br />

INVITE sip:alice@client.atlanta.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.biloxi.example.com:5060;branch=z9hG4bKnashd71
<br />

Session-Expires: 300;refresher=uac
<br />

Supported: timer
<br />

Max-Forwards: 70
<br />

From: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

To: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 2 INVITE
<br />

Content-Type: application/sdp
<br />

Content-Length: 133
<br />
<br />

v=0
<br />

o=bob 2890844527 2890844527 IN IP4 client.biloxi.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.201
<br />

t=0 0
<br />

m=audio 3456 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since Bob is not the owner of the Call-ID, Bob sends an INVITE again
                 after 0.0-2.0 seconds. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F11 200 OK Alice -> Bob
          <br />
<br />

          <br />
<br />

             F12 ACK Bob -> Alice
          <br />
<br />

          <br />
<br />

F13 UPDATE Alice -> Bob
          <br />
<br />

UPDATE sip:sip:bob@client.biloxi.example.com SIP/2.0
<br />

Via: SIP/2.0/UDP client.atlanta.example.com:5060;branch=z9hG4bK74bf91
<br />

Max-Forwards: 70
<br />

From: Alice &lt;sip:alice@atlanta.example.com&gt;;tag=9fxced76sl
<br />

To: Bob &lt;sip:bob@biloxi.example.com&gt;;tag=8321234356
<br />

Call-ID: 3848276298220188511@atlanta.example.com
<br />

CSeq: 3 UPDATE
<br />

Content-Length: 147
<br />
<br />

v=0
<br />

o=alice 2890844526 2890844527 IN IP4 client.atlanta.example.com
<br />

s=-
<br />

c=IN IP4 192.0.2.101
<br />

t=0 0
<br />

m=audio 49172 RTP/AVP 0
<br />

a=rtpmap:0 PCMU/8000
<br />

a=sendonly
<br />

            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Since Alice is the owner of the Call-ID, Alice sends the UPDATE
                 again after 2.1-4.0 seconds. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F14 200 OK Bob -> Alice
          <br />
<br />

          
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.3"></a><h3>3.3.3.&nbsp;
Receiving REFER (Established state) while in the Mortal state</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 State  Alice                  Bob  State
        |                        |
        |       INVITE F1        |
        |-----------------------&gt;|
   Pre  |    180 Ringing F2      |  Pre
        |&lt;-----------------------|
   Ear  |                        |  Ear
        |       200 OK F3        |
        |&lt;-----------------------|
  Mora  |         ACK F4         |  Mora
        |-----------------------&gt;|
   Est  |   Both Way RTP Media   |  Est
        |&lt;======================&gt;|
        |                        |
        | BYE F5        REFER F6 |
        |---------     ----------|
  Mort  |          \ /           |
        |           X            |
        |          / \           |
*race*  |&lt;--------     ---------&gt;|
        |                        |  Mort
        | 481 F8         200 F7  |
        | (REFER)        (BYE)   |
        |---------     ----------|
        |          \ /         ^ |
        |           X          | |
        |          / \         | |
        |&lt;--------     ---------&gt;|
        | ^                    | |
        | | Timer K            | |
        | V            Timer J | |
  Morg  |                      V |
        |                        |  Morg
        |                        |
</pre></div>
<p>This scenario illustrates the race condition which occurs
             when the UAS receives an Established message, REFER, while in the
             Mortal state. Bob sends a REFER, and Alice sends a BYE at
             the same time. Bob sends the REFER in the same dialog. Alice's
             dialog state moves to the Mortal state at the point of sending
             BYE. In the Mortal state, the UA possesses dialog information 
             for an internal process but the dialog shouldn't exist outwardly.
             Therefore, the UA sends an error response to the REFER, which is
             transmitted as a mid-dialog request. So Alice, in the Mortal
             state, sends an error response to the REFER. However, Bob has
             already started the SUBSCRIBE usage with REFER, so the dialog
             continues until the SUBSCRIBE usage terminates, even though
             the INVITE dialog usage terminates by receiving BYE. Bob's
             behavior in this case needs to follow the procedures in
	     <a class='info' href='#RFC5057'>RFC 5057<span> (</span><span class='info'>Sparks, R., &ldquo;Multiple Dialog Usages in the Session Initiation Protocol,&rdquo; November&nbsp;2007.</span><span>)</span></a> [6].
          <br />
<br />

          <br />
<br />

             Message Details
          <br />
<br />

             F1 INVITE Alice -> Bob
          <br />
<br />

          <br />
<br />

             F2 180 Ringing Bob -> Alice
          <br />
<br />

          <br />
<br />

             F3 200 OK Bob -> Alice
          <br />
<br />

          <br />
<br />

             F4 ACK Alice -> Bob
          <br />
<br />

          <br />
<br />

             F5 BYE Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice sends a BYE request and terminates the session, and transitions
                 from the Confirmed state to the Terminated state. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F6 REFER Bob -> Alice
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice sends a BYE, and Bob sends a REFER at the same time.  Bob
                 sends the REFER on the INVITE dialog.  The dialog state transitions
                 to the Mortal state at the moment Alice sends the BYE, but Bob
                 doesn't know this until he receives the BYE.  A race condition
                 occurs. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          <br />
<br />

             F7 200 OK (BYE) Bob -> Alice
          <br />
<br />

          <br />
<br />

             F8 481 Call/Transaction Does Not Exist (REFER) Alice -> Bob
            </p>
<blockquote class="text"><dl>
<dt>/*</dt>
<dd>
                 Alice in the Mortal state sends a 481 to the REFER. &nbsp;*/
              
</dd>
</dl></blockquote><p>
          
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
IANA Considerations</h3>

<p>This document has no actions for IANA.
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Security Considerations</h3>

<p>This document contains clarifications of behavior specified in 
      <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1], <a class='info' href='#RFC3264'>RFC 3264<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;An Offer/Answer Model with Session Description Protocol (SDP),&rdquo; June&nbsp;2002.</span><span>)</span></a> [2] and
      <a class='info' href='#RFC3515'>RFC 3515<span> (</span><span class='info'>Sparks, R., &ldquo;The Session Initiation Protocol (SIP) Refer Method,&rdquo; April&nbsp;2003.</span><span>)</span></a> [4].  The security considerations of 
      those documents continue to apply after the application of these 
      clarifications.
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Acknowledgements</h3>

<p>The authors would like to thank Robert Sparks, Dean Willis,
      Cullen Jennings, James M. Polk, Gonzalo Camarillo, Kenichi Ogami,
      Akihiro Shimizu, Mayumi Munakata, Yasunori Inagaki,
      Tadaatsu Kidokoro, Kenichi Hiragi, Dale Worley, Vijay K. Gurbani and
      Anders Kristensen for their comments on this document.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>7.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC3261">[1]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3264">[2]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3264">An Offer/Answer Model with Session Description Protocol (SDP)</a>,&rdquo; RFC&nbsp;3264, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3264.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[3]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3515">[4]</a></td>
<td class="author-text">Sparks, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3515">The Session Initiation Protocol (SIP) Refer Method</a>,&rdquo; RFC&nbsp;3515, April&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3515.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3262">[5]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3262">Reliability of Provisional Responses in Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3262, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3262.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>7.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC5057">[6]</a></td>
<td class="author-text">Sparks, R., &ldquo;<a href="http://tools.ietf.org/html/rfc5057">Multiple Dialog Usages in the Session Initiation Protocol</a>,&rdquo; RFC&nbsp;5057, November&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc5057.txt">TXT</a>).</td></tr>
</table>

<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
BYE in the Early Dialog</h3>

<p>This section, related to <a class='info' href='#sec.rcv-bye-early-moratorium'>Section&nbsp;3.1.3<span> (</span><span class='info'>Receiving BYE (Early state) while in the Moratorium state</span><span>)</span></a>, explains why BYE is not
         recommended in the Early state, illustrating a case in which
         a BYE in the early dialog triggers confusion.
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Alice            Proxy               Bob   Carol
  |                |                  |      |
  |   INVITE F1    |                  |      |
  |---------------&gt;|    INVITE F2     |      |
  |     100 F3     |-----------------&gt;|      |
  |&lt;---------------| 180(To tag=A) F4 |      |
  |    180(A) F5   |&lt;-----------------|      |
  |&lt;---------------|                  |      |
  |                |       INVITE(Fork) F6   |
  |                |------------------------&gt;|
  |                |                100 F7   |
  |    BYE(A) F8   |&lt;------------------------|
  |---------------&gt;|    BYE(A) F9     |      |
  |                |-----------------&gt;|      |
  |                |  200(A,BYE) F10  |      |
  | 200(A,BYE) F11 |&lt;-----------------|      |
  |&lt;---------------|  487(A,INV) F12  |      |
  |                |&lt;-----------------|      |
  |                |    ACK(A) F13    |      |
  |                |-----------------&gt;|      |
  |                |                  |      |
  |                |                         |
  |                |     200(To tag=B) F13   |
  |   200(B) F14   |&lt;------------------------|
  |&lt;---------------|                         |
  |   ACK(B) F15   |                         |
  |---------------&gt;|            ACK(B) F16   |
  |                |------------------------&gt;|
  |   BYE(B) F17   |                         |
  |---------------&gt;|            BYE(B) F18   |
  |                |------------------------&gt;|
  |                |            200(B) F19   |
  |   200(B) F20   |&lt;------------------------|
  |&lt;---------------|                         |
  |                |                         |
  |                |                         |
</pre></div>
<p>Care is advised in sending BYE in the Early state when forking
         by a proxy is expected. In this example, the BYE request
         progresses normally, and it succeeds in correctly terminating
         the dialog with Bob. After Bob terminates the dialog by receiving
         the BYE, he sends a 487 to the ini-INVITE. According to Section
         15.1.2 of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1], it is RECOMMENDED
         for the UAS to generate a 487 to any pending requests after receiving
         a BYE. In the example, Bob sends a 487 to the ini-INVITE since he
         receives the BYE while the ini-INVITE is in pending state.
      <br />
<br />

         However, Alice receives a final response to the INVITE (a 200 from
         Carol) even though she has successfully terminated the dialog
         with Bob. This means that, regardless of the success/failure
         of the BYE in the Early state, Alice MUST be prepared for the
         establishment of a new dialog until receiving the final response
         for the INVITE and terminating the INVITE transaction.
      <br />
<br />

         It is not illegal to send a BYE in the Early state to terminate a
         specific early dialog - it may satisfy the intent of some callers. However,
         the choice of BYE or CANCEL in the Early state must be made
         carefully. CANCEL is appropriate when the goal is to abandon
         the call attempt entirely. BYE is appropriate when the goal is
         to abandon a particular early dialog while allowing the call
         to be completed with other destinations. When using either BYE
         or CANCEL the UAC must be prepared for the possibility that a
         call may still be established to one (or more) destinations.
      
</p>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
BYE request overlapping with re-INVITE</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  UAC                    UAS
   |                      |
The session has been already established
  ==========================
   |   re-INVITE F1       |
   |---------------------&gt;|
   |   BYE F2             |
   |---------------------&gt;|
   |   200(BYE) F3        |
   |&lt;---------------------|
   |   INVITE F4(=F1)     |
   |---------------------&gt;|
   |                      |
   |                      |
</pre></div>
<p>This case could look similar to the one in 
         <a class='info' href='#sec.rcv-200-reinvite-mortal'>Section&nbsp;3.2.3<span> (</span><span class='info'>Receiving 200 OK for re-INVITE (Established state) while in the Mortal state</span><span>)</span></a>. However,
         it is not a race condition. This case describes the behavior when
         there is no response to the INVITE for some reason. The appendix
         explains the behavior in this case and its rationale, since
         this case is likely to cause confusion.
      <br />
<br />

         First of all, it is important not to confuse the behavior of the
         transaction layer and that of the dialog layer. <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1] details the transaction layer behavior. The dialog
         layer behavior is explained in this document. It has to be noted
         that these two behaviors are independent of each other, even though
         both layers may be triggered to change their states by sending or
         receiving the same SIP messages. (A dialog can be terminated
         even though a transaction still remains, and vice versa.)
      <br />
<br />

         In the sequence above, there is no response to F1, and F2 (BYE)
         is sent immediately after F1 (F1 is a mid-dialog request. If F1
         was an ini-INVITE, BYE could not be sent before the UAC received a
         provisional response to the request with a To tag).
      <br />
<br />

         Below is a figure which illustrates the UAC's dialog state and the
         transaction state.
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
BYE   INV  dialog UAC                    UAS
             :     |                      |
             :     |                      |
             |     |   re-INVITE F1       |
       o     |     |---------------------&gt;|
       |     |     |   BYE F2             |
 o     |  (Mortal) |---------------------&gt;|
 |     |     |     |   200(BYE) F3        |
 |     |     |     |&lt;---------------------|
 |     |     |     |   INVITE F4(=F1)     |
 |     |     |     |---------------------&gt;|
 |     |     |     |   481(INV) F5        |
 |     |     |     |&lt;---------------------|
 |     |     |     |   ACK(INV) F6        |
 |     |     |     |---------------------&gt;|
 |     |     |     |                      |
 o     |     o     |                      |
       |           |                      |
       o           |                      |
                   |                      |
</pre></div>
<p>For the UAC, the INVITE client transaction begins at the point F1
         is sent. The UAC sends BYE (F2) immediately after F1.  This is
         a legitimate behavior. (Usually the usage of each SIP method
         is independent, for BYE and others. However, it should be noted
         that it is prohibited to send a request with an SDP offer while
         the previous offer is in progress.)
      <br />
<br />

         After that, F2 triggers the BYE client transaction. At the same
         time, the dialog state transitions to the Mortal state and then only
         a BYE or a response to a BYE can be handled.
      <br />
<br />

         It is permitted to send F4 (a retransmission of INVITE) in the
         Mortal state, because the retransmission of F1 is handled by
         the transaction layer, and the INVITE transaction has not yet
         transitioned to the Terminated state. As is mentioned above,
         the dialog and the transaction behave independently each other.
         Therefore the transaction handling has to be continued even
         though the dialog has moved to the Terminated state.
          <br />
<br />

             Note: As noted in <a class='info' href='#sec.rcv-reinvite-est-moratorium-1'>Section&nbsp;3.1.4<span> (</span><span class='info'>Receiving re-INVITE (Established state) while in the Moratorium state (case 1)</span><span>)</span></a>, 
	     there is a hint for implementation to avoid this case.
             That is for the UAC to delay sending BYE F2 until the re-INVITE
             transaction F1 completes.
             Implementors can decouple the actions of the user (e.g.
             hanging up) from the actions of the protocol (the sending
             of BYE F2), so that the UA can behave like this. In this case, it
             is the implementor's choice as to how long to wait.
             In most cases, such an implementation may be useful to prevent this case.
      <br />
<br />

         Next, the UAS's state is shown below.
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
UAC                    UAS dialog  INV   BYE
 |                      |     :
 |                      |     :
 |   re-INVITE F1       |     |
 |--------------&gt;x      |     |
 |   BYE F2             |     |
 |---------------------&gt;|     |           o
 |   200(BYE) F3        |  (Mortal)       |
 |&lt;---------------------|     |           |&lt;-Start Timer J
 |   INVITE F4(=F1)     |     |           |
 |---------------------&gt;|     |     o     |
 |   4xx/5xx(INV) F5    |     o     |     o
 |&lt;---------------------|           |
 |   ACK(INV) F6        |           |
 |---------------------&gt;|           |&lt;-Start Timer I
 |                      |           |
 |                      |           |
 |                      |           o
 |                      |
</pre></div>
<p>For the UAS, it can be considered that packet the F1 is lost or delayed
         (here the behavior is explained for the case that the UAS receives F2
         BYE before F1 INVITE). Therefore, F2 triggers the BYE transaction
         for UAS, and simultaneously the dialog moves to the Mortal state.
         Then, upon the reception of F4 the INVITE server transaction
         begins. (It is permitted to start the INVITE server transaction
         in the Mortal state. The INVITE server transaction begins to
         handle the received SIP request regardless of the dialog state.)
         The UAS's TU sends an appropriate error response for the F4 INVITE,
         either 481 (because the TU knows that the dialog which matches
         the INVITE is in the Terminated state) or 500 (because the
         re-sent F4 has an out-of-order CSeq). (It is mentioned above
         that INVITE message F4 (and F1) is a mid-dialog request. Mid-dialog
         requests have a To tag. It should be noted that the UAS's TU does
         not begin a new dialog upon the reception of INVITE with a
         To tag.)
      
</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.C"></a><h3>Appendix C.&nbsp;
UA's behavior for CANCEL</h3>

<p>This section explains the CANCEL behaviors which indirectly
         impact the dialog state transition in the Early state.
         CANCEL does not have any influence on the UAC's dialog state.
         However, the request has a indirect influence on the dialog
         state transition because it has a significant effect on ini-INVITE.
         For the UAS the CANCEL request has more direct effects on the dialog
         than the sending of a CANCEL by the UAC, because it can be a trigger
         to send the 487 response. Figure 3 explains UAS's behavior in the
         Early state. This flow diagram is only an explanatory figure,
         and the actual dialog state transition is as illustrated in
         Figures 1 and 2.
      <br />
<br />

	 In the flow, full lines are related to dialog state transition,
         and dotted lines are involved with CANCEL. (r) represents the
         reception of signaling, and (s) means sending. There is no dialog
         state for CANCEL, but here the Cancelled state is
         handled virtually just for the ease of understanding of the UA's behavior
         when it sends and receives CANCEL.
      
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
+-------------+
| Preparative |---+
+-------------+   |
  :   | 1xx(s)    |
  :   V           |
  : +-------+     | 2xx(s)
  : | Early |-----+------+
  : +-------+            |
  :     :                V
  :     :           +-----------+
  :     :           | Confirmed |&lt;...
  :.....:           +-----------+   :
     :                   |  :       :
     :             BYE(r)|  :       :
     : CANCEL(r)         |  :.......:
     V                   |    CANCEL(r)
 .............           |
 : Cancelled :           |
 :...........:           |
    | 487(s)             |
    |                    |
    +--------------------+
               |
               V
         +------------+
         | Terminated |
         +------------+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure 3: CANCEL flow diagram for UAS&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>There are two behaviors for the UAS depending on the state when it
         receives a CANCEL.
      <br />
<br />

         The first behavior is when the UAS receives a CANCEL in the Early state.  In this
         case the UAS immediately sends a 487 for the INVITE, and the
         dialog transitions to the Terminated state.
      <br />
<br />

         The other is the case in which the UAS receives a CANCEL while in the
         Confirmed state. In this case the dialog state transition does
         not occur because UAS has already sent a final response to the
         INVITE to which the CANCEL is targeted. (Note that, because of
         the UAC's behavior, a UAS that receives a CANCEL in the Confirmed
         state can expect to receive a BYE immediately and move to the
         Terminated state. However, the UAS's state does not transition
         until it actually receives a BYE.)
      
</p>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.D"></a><h3>Appendix D.&nbsp;
Notes on the request in the Mortal state</h3>

<p>This section describes the UA's behavior in the Mortal state, which
         needs careful attention. Note that every transaction completes
         independently of others, following the principle of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1]. 
      <br />
<br />

         In the Mortal state, only a BYE can be accepted, and the other messages
         in the INVITE dialog usage are responded to with an error. However,
         sending of ACK and the authentication procedure for BYE are
         conducted in this state. (The handling of messages concerning
         multiple dialog usages is out of the scope of this document. 
         Refer to <a class='info' href='#RFC5057'>RFC 5057<span> (</span><span class='info'>Sparks, R., &ldquo;Multiple Dialog Usages in the Session Initiation Protocol,&rdquo; November&nbsp;2007.</span><span>)</span></a> [6]
         for further information.)
      <br />
<br />

         ACK for error responses is handled by the transaction layer,
         so the handling is not related to the dialog state. Unlike the
         ACK for error responses, ACK for 2xx responses is a request
         newly generated by a TU. However, the ACK for 2xx and the ACK
         for error responses are both a part of the INVITE transaction,
         even though their handling differs (Section 17.1.1.1, <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1]). Therefore, the INVITE transaction
         is completed by the three-way handshake, which includes ACK,
         even in the Mortal state.
      <br />
<br />

         Considering actual implementation, the UA needs to keep the INVITE
         dialog usage until the Mortal state finishes, so that it is
         able to send ACK for a 2xx response in the Mortal state. If a 2xx to
         INVITE is received in the Mortal state, the duration of the
         INVITE dialog usage will be extended to 64*T1 seconds after the
         receiving of the 2xx, to cope with the possible 2xx retransmission.
         (The duration of the 2xx retransmission is 64*T1, so the UA
         needs to be prepared to handle the retransmission for this
         duration.) However, the UA shall send an error response to other
         requests, since the INVITE dialog usage in the Mortal state is
         kept only for the sending of ACK for 2xx.
      <br />
<br />

         The BYE authentication procedure shall be processed in the Mortal
         state. When authentication is requested by a 401 or 407 response,
         UAC resends BYE with appropriate credentials. Also the UAS
         handles the retransmission of the BYE for which it requested
         authentication.
      
</p>
<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.E"></a><h3>Appendix E.&nbsp;
Forking and receiving new To tags</h3>

<p>This section details the behavior of the TU when it receives multiple
         responses with a different To tag to ini-INVITE.
      <br />
<br />

         When an INVITE is forked inside a SIP network, there is a
         possibility that the TU receives multiple responses to the ini-INVITE with
         differing To tags (See Section 12.1, 13.1, 13.2.2.4,
         16.7, 19.3, etc. of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1]). If the
         TU receives multiple 1xx responses with different To tags,
         the original DSM forks and a new DSM instance is created. As
         a consequence multiple early dialogs are generated.
      <br />
<br />

         If one of the multiple early dialogs receives a 2xx response, it
         naturally transitions to the Confirmed state.  No DSM state transition
         occurs for the other early dialogs, and their sessions (early
         media) terminate. The TU of the UAC terminates the INVITE
         transaction after 64*T1 seconds starting at the point of receiving
         the first 2xx response. Moreover, all mortal early dialogs
         which do not transition to the Established state are terminated
         (See Section 13.2.2.4 of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1]).
         By "mortal early dialog" we mean any early dialog that the
         UA will terminate when another early dialog is confirmed.
      <br />
<br />

         Below is an example sequence in which two 180 responses with
         different To tags are received, and then a 200 response for
         one of the early dialogs (dialog A) is received. Dotted lines
         (..) in the sequences are auxiliary lines to represent the
         influence on dialog B.
      
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                UAC
                 dialog(A)       |    INVITE F1
                  Pre o          |-------------------------&gt;
                      |          |    100 F2
                      |          |&lt;-------------------------
                      |          |    180(To tag=A) F3
                  Ear |          |&lt;-------------------------
       dialog(B)      |          |
   forked new DSM     |          |    180(To tag=B) F4
       Ear o..........|..........|&lt;-------------------------
           |          |          |
           |          |          |    200(A) F5
terminate-&gt;|.....Mora |..........|&lt;-------------------------
  early    |          | ^        |    ACK(A) F6
   media   |      Est | |        |-------------------------&gt;
           |          | |        |
           |          | |64*T1   |
           |          | |(13.2.2.4 of RFC 3261 [1])
           |          | |        |
           |          | |        |
           |          | V        |
           o..........|.(terminate INVITE transaction)
       terminated     |          |
        dialog(B)     |          |
                      |          |
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure 4: Receiving 1xx responses with different To tags&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The figure above shows the DSM inside a SIP TU. Triggered by
         the reception of a provisional response with a different To
         tag (F4 180(To tag=B)), the DSM forks and the early dialog B is
         generated. 64*T1 seconds later dialog A receives a
         200 OK response. Dialog B, which does not transition to the
         Established state, terminates.
      <br />
<br />

         Next, the behavior of a TU which receives multiple 2xx responses
         with different To tags is explained. When a mortal early dialog,
         which did not match the first 2xx response that the TU received,
         receives another 2xx response which matches its To tag before the
         64*T1 INVITE transaction timeout, its DSM transitions to the
         Confirmed state. However, the session on the mortal early dialog
         is terminated when the TU receives the first 2xx to establish
         a dialog, so no session is established for the mortal early
         dialog. Therefore, when the mortal early dialog receives a 2xx
         response, the TU sends an ACK and, immediately after, the TU
         usually sends a BYE to terminate the DSM. (In special cases, e.g.
         if a UA intends to establish multiple dialogs, the TU may not send
         the BYE.)
      <br />
<br />

         The handling of the second early dialog after receiving the 200
         for the first dialog is quite appropriate for a typical device,
         such as a phone. It is important to note that what is being
         shown is a typical useful action and not the only valid one.
         Some devices might want to handle things differently. For
         instance, a conference focus that has sent out an INVITE that
         forks may want to accept and mix all the dialogs it gets. 
         In that case, no early dialog is treated as mortal.
      <br />
<br />

         Below is an example sequence in which two 180 responses with a
         different To tag are received and then a 200 response for each
         of the early dialogs is received.
      
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                UAC
                 dialog(A)       |    INVITE F1
                  Pre o          |-----------------------&gt;
                      |          |    100 F2
                      |          |&lt;-----------------------
                      |          |    180(To tag=A) F3
      dialog(B)   Ear |          |&lt;-----------------------
  forked new DSM      |          |    180(To tag=B) F4
       Ear o..........|..........|&lt;-----------------------
           |          |          |
           |          |          |    200(A) F5
terminate-&gt;|.....Mora |..........|&lt;-----------------------
  early    |          | ^        |    ACK(A) F6
   media   |      Est | |        |-----------------------&gt;
           |          | |64*T1   |
           |          | |        |    200(B) F7
      Mora |..........|.|........|&lt;-----------------------
           |          | |        |    ACK(B) F8
       Est |..........|.|........|-----------------------&gt;
           |          | |        |    BYE(B) F9
      Mort |..........|.|........|-----------------------&gt;
       ^   |          | |        |    200(B) F10
       |   |          | |        |&lt;-----------------------
       |Timer K       | |        |
       |   |          | V        |
       |   |          | (terminate INVITE transaction)
       V   |          |          |
      Morg o          |          |
                      |          |
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure 5: Receiving 1xx and 2xx responses with different To tags&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Below is an example sequence when a TU receives multiple 200 responses
         with different To tags before the 64*T1 timeout of the INVITE transaction
	 in the absence of a provisional response.  Even though a TU does not
	 receive a provisional response, the TU needs to process the 2xx responses
         (See Section 13.2.2.4 of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [1]). In that
         case, the DSM state is forked at the Confirmed state, and then
         the TU sends an ACK for the 2xx response and, immediately after,
         the TU usually sends a BYE. (In special cases, e.g. if a UA intends
         to establish multiple dialogs, the TU may not send the BYE.)
      
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                              UAC
               dialog(A)       |    INVITE F1
                Pre o          |-----------------------&gt;
                    |          |    100 F2
                    |          |&lt;-----------------------
                    |          |    180(To tag=A) F3
                Ear |          |&lt;-----------------------
                    |          |
                    |          |    200(A) F4
               Mora |..........|&lt;-----------------------
                    | ^        |    ACK(A) F5
                Est | |        |-----------------------&gt;
                    | |        |
    dialog(B)       | |64*T1   |
forked new DSM      | |        |    200(To tag=B) F6
    Mora o..........|.|........|&lt;-----------------------
         |          | |        |    ACK(B) F7
     Est |..........|.|........|-----------------------&gt;
         |          | |        |    BYE(B) F8
    Mort |..........|.|........|-----------------------&gt;
     ^   |          | |        |    200(B) F9
     |   |          | |        |&lt;-----------------------
     |   |          | V        |
     |Timer K       | (terminate INVITE transaction)
     |   |          |          |
     V   |          |          |
    Morg o          |          |
                    |          |
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure 6: Receiving 2xx responses with different To tags&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Below is an example sequence in which the option tag 100rel
         (<a class='info' href='#RFC3262'>RFC 3262<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Reliability of Provisional Responses in Session Initiation Protocol (SIP),&rdquo; June&nbsp;2002.</span><span>)</span></a> [5]) is required by a 180.
      <br />
<br />

         If a forking proxy supports 100rel, it transparently transmits
         to the UAC a provisional response which contains a Require
         header with the value of 100rel. Upon receiving a provisional
         response with 100rel, the UAC establishes the early dialog (B)
         and sends PRACK. (Here, also, every transaction completes
         independently of others.)
      <br />
<br />

         As in Figure 4, 
	 the early dialog (B) terminates at the same time
         the INVITE transaction terminates. In the case where a proxy
         does not support 100rel, the provisional response will be
         handled in the usual way (a provisional response with 100rel
         is discarded by the proxy, not to be transmitted to the UAC).
      
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                             UAC
              dialog(A)       |    INVITE F1
               Pre o          |-------------------------&gt;
                   |          |    100 F2
                   |          |&lt;-------------------------
                   |          |    180(To tag=A) F3
               Ear |          |&lt;-------------------------
                   |          |    200(A) F4
              Mora |..........|&lt;-------------------------
                   | ^        |    ACK(A) F5
               Est | |        |-------------------------&gt;
    dialog(B)      | |        |
forked new DSM     | |        |    180(To tag=B) w/100rel F6
    Ear o..........|.|........|&lt;-------------------------
        |          | |        |    PRACK(B) F7
        |          | |        |-------------------------&gt;
        |          | |        |    200(B,PRACK) F8
        |          | |        |&lt;-------------------------
        |          | |64*T1   |
        |          | |(13.2.2.4 of RFC 3261 [1])
        |          | |        |
        |          | |        |
        |          | |        |
        |          | V        |
        o..........|.(terminate INVITE transaction)
    terminated     |          |
     dialog(B)     |          |
                   |          |
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure 7: Receiving 1xx responses with different To tags 
                     when using the mechanism for reliable provisional responses (100rel)&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Miki Hasebe</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">NTT-east Corporation</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">19-2 Nishi-shinjuku 3-chome</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shinjuku-ku, Tokyo  163-8019</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">JP</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:hasebe.miki@east.ntt.co.jp">hasebe.miki@east.ntt.co.jp</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jun Koshiko</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">NTT-east Corporation</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">19-2 Nishi-shinjuku 3-chome</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shinjuku-ku, Tokyo  163-8019</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">JP</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:j.koshiko@east.ntt.co.jp">j.koshiko@east.ntt.co.jp</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Yasushi Suzuki</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">NTT Corporation</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">9-11, Midori-cho 3-Chome</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Musashino-shi, Tokyo  180-8585</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">JP</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:suzuki.yasushi@lab.ntt.co.jp">suzuki.yasushi@lab.ntt.co.jp</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tomoyuki Yoshikawa</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">NTT-east Corporation</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">19-2 Nishi-shinjuku 3-chome</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shinjuku-ku, Tokyo  163-8019</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">JP</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:tomoyuki.yoshikawa@east.ntt.co.jp">tomoyuki.yoshikawa@east.ntt.co.jp</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Paul H. Kyzivat</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1414 Massachusetts Avenue</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Boxborough, MA  01719</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:pkyzivat@cisco.com">pkyzivat@cisco.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
