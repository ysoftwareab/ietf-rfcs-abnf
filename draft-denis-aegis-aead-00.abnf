ct = {}

ad_blocks = Split(Pad(ad, 256), 256)
msg_blocks = Split(Pad(msg, 256), 256)
ct = ct || Enc(xi)

tag = Finalize(|ad|, |msg|)
msg = Truncate(msg, |ct|)

msg = {}

ad_blocks = Split(Pad(ad, 256), 256)
ct_blocks = Split(ct, 256)
cn = Tail(ct, |ct| mod 256)

msg = msg || Dec(ci)

msg = msg || DecPartial(cn)

expected_tag = Finalize(|ad|, |msg|)

S0 = key ^ nonce
S1 = C1
S2 = C0
S3 = C1
S4 = key ^ nonce
S5 = key ^ C0
S6 = key ^ C1
S7 = key ^ C0

S0  = S'0
S1  = S'1
S2  = S'2
S3  = S'3
S4  = S'4
S5  = S'5
S6  = S'6
S7  = S'7
z0 = S6 ^ S1 ^ (S2 & S3)
z1 = S2 ^ S5 ^ (S6 & S7)

out0 = t0 ^ z0
out1 = t1 ^ z1

ci = out0 || out1

z0 = S6 ^ S1 ^ (S2 & S3)
z1 = S2 ^ S5 ^ (S6 & S7)

out0 = t0 ^ z0
out1 = t1 ^ z1

xi = out0 || out1

z0 = S6 ^ S1 ^ (S2 & S3)
z1 = S2 ^ S5 ^ (S6 & S7)

out0 = t0 ^ z0
out1 = t1 ^ z1

xn = Truncate(out0 || out1, |cn|)

t = S2 ^ (LE64(ad_len) || LE64(msg_len))

tag = S0 ^ S1 ^ S2 ^ S3 ^ S4 ^ S5 ^ S6

ct = {}

ad_blocks = Split(Pad(ad, 128), 128)
msg_blocks = Split(Pad(msg, 128), 128)
ct = ct || Enc(xi)

tag = Finalize(|ad|, |msg|)

msg = {}

ad_blocks = Split(Pad(ad, 128), 128)
ct_blocks = Split(Pad(ct, 128), 128)
cn = Tail(ct, |ct| mod 128)

msg = msg || Dec(ci)

msg = msg || DecPartial(cn)

expected_tag = Finalize(|ad|, |msg|)

S0 = k0 ^ n0
S1 = k1 ^ n1
S2 = C1
S3 = C0
S4 = k0 ^ C0
S5 = k1 ^ C1

S0  = S'0
S1  = S'1
S2  = S'2
S3  = S'3
S4  = S'4
S5  = S'5

z = S1 ^ S4 ^ S5 ^ (S2 & S3)

ci = xi ^ z

z = S1 ^ S4 ^ S5 ^ (S2 & S3)

xi = ci ^ z

z = S1 ^ S4 ^ S5 ^ (S2 & S3)

t = Pad(ci, 128)
out = t ^ z

xn = Truncate(out, |cn|)

v = Pad(xn, 128)
t = S3 ^ (LE64(ad_len) || LE64(msg_len))

tag = S0 ^ S1 ^ S2 ^ S3 ^ S4 ^ S5

combined_ct = ct || tag

