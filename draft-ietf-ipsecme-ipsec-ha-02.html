<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>IPsec High Availability and Load Sharing Problem Statement</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="IPsec High Availability and Load Sharing Problem Statement">
<meta name="keywords" content="Internet-Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">Y. Nir</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Check Point</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">April 15, 2010</td></tr>
<tr><td class="header">Expires: October 17, 2010</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />IPsec High Availability and Load Sharing Problem Statement<br />draft-ietf-ipsecme-ipsec-ha-02</h1>

<h3>Abstract</h3>

<p>This document describes a requirement from IKE and IPsec to allow for more scalable 
        and available deployments for VPNs. It defines terminology for high availability and load 
        sharing clusters implementing IKE and IPsec, and describes gaps in the existing standards.
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on October 17, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<p>
This document may contain material from IETF Documents or IETF
Contributions published or made publicly available before November
10, 2008.  The person(s) controlling the copyright in some of this
material may not have granted the IETF Trust the right to allow
modifications of such material outside the IETF Standards Process.
Without obtaining an adequate license from the person(s) controlling
the copyright in such materials, this document may not be modified
outside the IETF Standards Process, and derivative works of it may
not be created outside the IETF Standards Process, except to format
it for publication as an RFC or to translate it into languages other
than English.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#introduction">1.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#mustshouldmay">1.1.</a>&nbsp;
Conventions Used in This Document<br />
<a href="#Term">2.</a>&nbsp;
Terminology<br />
<a href="#PS">3.</a>&nbsp;
The Problem Statement<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#state">3.1.</a>&nbsp;
Lots of Long Lived State<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ikecounters">3.2.</a>&nbsp;
IKE Counters<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ipsec_ocounters">3.3.</a>&nbsp;
Outbound SA Counters<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ipsec_icounters">3.4.</a>&nbsp;
Inbound SA Counters<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#missing">3.5.</a>&nbsp;
Missing Synch Messages<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ls_simul">3.6.</a>&nbsp;
Simultaneous use of IKE and IPsec SAs by Different Members<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ipsec_ctr">3.6.1.</a>&nbsp;
Outbound SAs using counter modes<br />
<a href="#sec">4.</a>&nbsp;
Security Considerations<br />
<a href="#acknowledgements">5.</a>&nbsp;
Acknowledgements<br />
<a href="#history">6.</a>&nbsp;
Change Log<br />
<a href="#rfc.references1">7.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="introduction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p> IKEv2, as described in <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> and <a class='info' href='#RFC4718'>[RFC4718]<span> (</span><span class='info'>Eronen, P. and P. Hoffman, &ldquo;IKEv2 Clarifications and Implementation Guidelines,&rdquo; October&nbsp;2006.</span><span>)</span></a>, and IPsec, 
        as described in <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> and others, allows deployment of VPNs between 
        different sites as well as from VPN clients to protected networks.
</p>
<p> As VPNs become increasingly important to the organizations deploying them, there is a 
        demand to make IPsec solutions more scalable and less prone to down time, by using more 
        than one physical gateway to either share the load or back each other up. Similar demands 
        have been made in the past for other critical pieces of an organizations's infrastructure, 
        such as DHCP and DNS servers, web servers, databases and others.
</p>
<p> IKE and IPsec are in particular less friendly to clustering than these other protocols,
        because they store more state, and that state is more volatile. <a class='info' href='#Term'>Section&nbsp;2<span> (</span><span class='info'>Terminology</span><span>)</span></a> 
        defines terminology for use in this document, and in the envisioned solution documents.
</p>
<p> In general, deploying IKE and IPsec in a cluster requires such a large amount of 
        information to be synchronized among the members of the cluster, that it becomes 
        impractical. Alternatively, if less information is synchronized, failover would mean a 
        prolonged and intensive recovery phase, which negates the scalability and availability
        promises of using clusters. In <a class='info' href='#PS'>Section&nbsp;3<span> (</span><span class='info'>The Problem Statement</span><span>)</span></a> we will describe this in more detail.
</p>
<a name="mustshouldmay"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
Conventions Used in This Document</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
          "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described
          in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="Term"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p> "Single Gateway" is an implementation of IKE and IPsec enforcing a certain policy, as
          described in <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
</p>
<p> "Cluster" is a set of two or more gateways, implementing the same security policy, and
          protecting the same domain. Clusters exist to provide both high availability through 
          redundancy, and scalability through load sharing.
</p>
<p> "Member" is one gateway in a cluster.
</p>
<p> "High Availability" is a condition of a system, not a configuration type. A system is 
          said to have high availability if its expected down time is low. High availability can be
          achieved in various ways, one of which is clustering. All the clusters described in this
          document achieve high availability.
</p>
<p> "Fault Tolerance" is a condition related to high availability, where a system maintains
          service availability, even when a specified set of fault conditions occur. In clusters,
          we expect the system to maintain service availability, when one or more of the cluster 
          members fails.
</p>
<p> "Completely Transparent Cluster" is a cluster where the occurence of a fault is never
          visible to the peers.
</p>
<p> "Partially Transparent Cluster" is a cluster where the occurence of a fault may be 
          visible to the peers.
</p>
<p> "Hot Standby Cluster", or "HS Cluster" is a cluster where only one of the members
          is active at any one time. This member is also referred to as the the "active", whereas 
          the others are referred to as "stand-bys". <a class='info' href='#VRRP'>[VRRP]<span> (</span><span class='info'>Hinden, R., &ldquo;Virtual Router Redundancy Protocol (VRRP),&rdquo; April&nbsp;2004.</span><span>)</span></a> is one method of 
          building such a cluster.
</p>
<p> "Load Sharing Cluster", or "LS Cluster" is a cluster where more than one of the members
          may be active at the same time. The term "load balancing" is also common, but it implies
          that the load is actually balanced between the members, and we don't want to even imply
          that this is a requirement.
</p>
<p> "Failover" is the event where a one member takes over some load from some other member.
          In a hot standby cluster, this hapens when a standby memeber becomes active due to a 
          failure of the former active member, or because of an administrator command. In a load
          sharing cluster this usually happens because of a failure of one of the members, but 
          certain load-balancing technologies may allow a particular load (such as all the flows 
          associated with a particular child SA) to move from one member to another to even out the 
          load, even without any failures.
</p>
<p> "Tight Cluster" is a cluster where all the members share an IP address. This could be
          accomplished using configured interfaces with specialized protocols or hardware, such as
          VRRP, or through the use of multicast addresses, but in any case, peers need only be 
          configured with one IP address in the PAD.
</p>
<p> "Loose Cluster" is a cluster where each member has a different IP address. Peers find 
          the correct member using some method such as DNS queries or <a class='info' href='#REDIRECT'>[REDIRECT]<span> (</span><span class='info'>Devarapalli, V. and K. Weniger, &ldquo;Redirect Mechanism for IKEv2,&rdquo; November&nbsp;2009.</span><span>)</span></a>. In
          some cases, members IP addresses may be allocated to other members at failover.
</p>
<p> "Synch Channel" is a communications channel among the cluster members, used to transfer
          state information. The synch channel may or may not be IP based, may or may not be 
          encrypted, and may work over short or long distances. The security and physical
          characteristics of this channel are out of scope for this document, but it is a
          requirement that its use be minimized for scalability.
</p>
<a name="PS"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
The Problem Statement</h3>

<p> This document will make no attempt to describe the problems in setting up a cluster.
          The following subsections describe the problems related to the protocol itself.
</p>
<p> We also ignore the problem of synchronizing the policy between cluster members, as this
          is an administrative issue that is not particular to either clusters or to IPsec.
</p>
<p> Note that the interesting scenario here is VPN, whether tunneled site-to-site or remote
          access. host-to-host transport mode is not expected to benefit from this work.
</p>
<a name="state"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Lots of Long Lived State</h3>

<p> IKE and IPsec have a lot of long lived state:</p>
<ul class="text">
<li> IKE SAs last for minutes, hours, or days, and carry keys and other information. 
              Some gateways may carry thousands to hundreds of thousands of IKE SAs.
</li>
<li> IPsec SAs last for minutes or hours, and carry keys, selectors and other 
              information. Some gateways may carry hundreds of thousands such IPsec SAs.
</li>
<li> SPD Cache entries. While the SPD is unchanging, the SPD cache changes on the fly
              due to narrowing. Entries last at least as long as the SAD entries, but
              tend to last even longer than that.
</li>
</ul>

<p> A naive implementation of a high availability cluster would have no synchronized 
            state, and a failover would produce an effect similar to that of a rebooted gateway.
            <a class='info' href='#resumption'>[resumption]<span> (</span><span class='info'>Sheffer, Y. and H. Tschofenig, &ldquo;IKEv2 Session Resumption,&rdquo; January&nbsp;2010.</span><span>)</span></a> describes how new IKE and IPsec SAs can be recreated in 
            such a case.
</p>
<a name="ikecounters"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
IKE Counters</h3>

<p> We can overcome the first problem described in <a class='info' href='#state'>Section&nbsp;3.1<span> (</span><span class='info'>Lots of Long Lived State</span><span>)</span></a>, by 
            synchronizing states - whenever an SA is created, we can synch this new state to all 
            other members. However, those states are not only long-lived, they are also ever 
            changing.
</p>
<p> IKE has message counters. A peer may not process message n until after it has 
            processed message n-1. Skipping message IDs is not allowed. So a newly-active member 
            needs to know the last message IDs both received and transmitted.
</p>
<p> Often, it is feasible to synchronize the IKE message counters for every IKE
            exchange. This way, the newly active member knows what messages it is allowed to 
            process, and what message IDs to use on IKE requests, so that peers process them.
</p>
<a name="ipsec_ocounters"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Outbound SA Counters</h3>

<p> ESP and AH have an optional anti-replay feature, where every protected packet carries 
            a counter number. Repeating counter numbers is considered an attack, so the newly-active
            member must not use a replay counter number that has already been used. The peer will
            drop those packets as duplicates and/or warn of an attack.
</p>
<p> Though it may be feasible to synchronize the IKE message counters, it is almost never 
            feasible to synchronize the IPsec packet counters for every IPsec packet transmitted. 
            So we have to assume that at least for IPsec, the replay counter will not be up-to-date 
            on the newly-active member, and the newly-active member may repeat a counter.
</p>
<p> A possible solution is to synch replay counter information, not for each packet 
            emitted, but only at regular intervals, say, every 10,000 packets or every 0.5 seconds. 
            After a failover, the newly-active member advances the counters for outbound SAs by 
            10,000. To the peer this looks like up to 10,000 packets were lost, but this should 
            be acceptable, as neither ESP nor AH guarantee reliable delivery.
</p>
<a name="ipsec_icounters"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
Inbound SA Counters</h3>

<p> An even tougher issue, is the synchronization of packet counters for inbound SAs. If
            a packet arrives at a newly-active member, there is no way to determine whether this
            packet is a replay or not. The periodic synch does not solve the problem at all, 
            because suppose we synchronize every 10,000 packets, and the last synch before the
            failover had the counter at 170,000. It is probable, though not certain, that packet 
            number 180,000 has not yet been processed, but if packet 175,000 arrives at the newly-
            active member, it has no way of determining whether or not that packet has or has not
            already been processed. The synchronization does prevent the processing of really old
            packets, such as those with counter number 165,000. Ignoring all counters below 180,000 
            won't work either, because that's up to 10,000 dropped packets, which may be very 
            noticeable.
</p>
<p> The easiest solution is to learn the replay counter from the incoming traffic. This
            is allowed by the standards, because replay counter verification is an optional 
            feature. The case can even be made that it is relatively secure, because non-attack
            traffic will reset the counters to what they should be, so an attacker faces the dual
            challenge of a very narrow window for attack, and the need to time the attack to a 
            failover event. Unless the attacker can actually cause the failover, this would be very 
            difficult. It should be noted, though, that although this solution is acceptable as far
            as RFC 4301 goes, it is a matter of policy whether this is acceptable.
</p>
<p> Another possible solution to the inbound SA problem is to rekey all child SAs 
            following a failover. This may or may not be feasible depending on the implementation 
            and the configuration.
</p>
<a name="missing"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5"></a><h3>3.5.&nbsp;
Missing Synch Messages</h3>

<p> The synch channel is very likely not to be infallible. Before failover is detected,
            some synchronization messages may have been missed. For example, the active member may 
            have created a new Child SA using message n. The new information (entry in the SAD and 
            update to counters of the IKE SA) is sent on the synch channel. Still, with every
            possible technology, the update may be missed before the failover.
</p>
<p> This is a bad situation, because the IKE SA is doomed. the newly-active member has 
            two problems: </p>
<ul class="text">
<li> It does not have the new IPsec SA pair. It will drop all incoming packets protected
              with such an SA. This could be fixed by sending some DELETEs and INVALID_SPI 
              notifications, if it wasn't for the other problem...
</li>
<li> The counters for the IKE SA show that only request n-1 has been sent. The next 
              request will get the message ID n, but that will be rejected by the peer. After
              a sufficient number of retransmissions and rejections, the whole IKE SA with all
              associated IPsec SAs will get dropped.
</li>
</ul>

<p> The above scenario may be rare enough that it is acceptable that on a configuration
            with thousands of IKE SAs, a few will need to be recreated from scratch or using 
            session resumption techniques. However, detecting this may take a long time (several
            minutes) and this negates the goal of creating a high availability cluster in the first
            place.
</p>
<a name="ls_simul"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.6"></a><h3>3.6.&nbsp;
Simultaneous use of IKE and IPsec SAs by Different Members</h3>

<p> For load sharing clusters, all active members may need to use the same SAs, both IKE
            and IPsec. This is an even greater problem than in the case of HA, because consecutive
            packets may need to be sent by different members to the same peer gateway.
</p>
<p> The solution to the IKE SA issue is up to the application. It's possible to create
            some locking mechanism over the synch channel, or else have one member "own" the IKE SA
            and manage the child SAs for all other members. For IPsec, solutions fall into two 
            broad categories.
</p>
<p> The first is the "sticky" category, where all communications with a single peer, or
            all communications involving a certain SPD cache entry go through a single peer. In
            this case, all packets that match any particular SA go through the same member, so no
            synchronization of the replay counter needs to be done. Inbound processing is a "sticky"
            issue, because the packets have to be processed by the correct member based on peer and
            SPI. Another issue is that commodity load balancers will not be able to match the SPIs
            of the encrypted side to the clear traffic, and so the wrong member may get the the 
            other half of the flow.
</p>
<p> The other way, is to duplicate the child SAs, and have a pair of IPsec SAs for each
            active member. Different packets for the same peer go through different members, and
            get protected using different SAs with the same selectors and matching the same entries
            in the SPD cache.  This has some shortcomings:</p>
<ul class="text">
<li>It requires multiple parallel SAs, which the peer has no use for. Section 2.8 or 
              <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> specifically allows this, but some implementation might
              have a policy against long term maintenance of redundant SAs.
</li>
<li>Different packets that belong to the same flow may be protected by different SAs,
              which may seem "weird" to the peer gateway, especially if it is integrated with 
              some deep inspection middleware such as a firewall. It is not known whether this will
              cause problems with current gateways. It is also impossible to mandate against this, 
              because the definition of "flow" varies from one implementation to another.
</li>
<li>Reply packets may arrive with an IPsec SA that is not "matched" to the one used
              for the outgoing packets. Also, they might arrive at a different member. This problem
              is beyond the scope of this document and should be solved by the application, perhaps
              by forwarding misdirected packets to the correct gateway for deep inspection.
</li>
</ul>

<a name="ipsec_ctr"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.6.1"></a><h3>3.6.1.&nbsp;
Outbound SAs using counter modes</h3>

<p> For SAs involving counter mode ciphers such as <a class='info' href='#CTR'>[CTR]<span> (</span><span class='info'>Housley, R., &ldquo;Using Advanced Encryption Standard (AES) Counter Mode,&rdquo; January&nbsp;2009.</span><span>)</span></a> or 
              <a class='info' href='#GCM'>[GCM]<span> (</span><span class='info'>Viega, J. and D. McGrew, &ldquo;The Use of Galois/Counter Mode (GCM) in IPsec Encapsulating Security Payload (ESP),&rdquo; June&nbsp;2005.</span><span>)</span></a> there is yet another complication. The initial vector for such
              modes must never be repeated, and senders use methods such as counters or LFSRs to 
              ensure this. An SA shared between more than one active member, or even failing over
              from one member to another need to make sure that they do not generate the same 
              initial vector. See <a class='info' href='#COUNTER_MODES'>[COUNTER_MODES]<span> (</span><span class='info'>McGrew, D. and B. Weis, &ldquo;Using Counter Modes with Encapsulating Security Payload (ESP) and Authentication Header (AH) to Protect Group Traffic,&rdquo; March&nbsp;2010.</span><span>)</span></a> for a discussion of this problem in 
              another context.
</p>
<a name="sec"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Security Considerations</h3>

<p>Implementations running on clusters MUST be as secure as implementations running on 
          single gateways. In other words, no extension or interpretation used to allow operation
          in a cluster may facilitate attacks that are not possible for single gateways.
</p>
<p>Moreover, thought must be given to the synching requirements of any protocol extension,
          to make sure that it does not create an opportunity for denial of service attacks on the
          cluster.
</p>
<p> As mentioned in <a class='info' href='#ipsec_icounters'>Section&nbsp;3.4<span> (</span><span class='info'>Inbound SA Counters</span><span>)</span></a>, allowing an inbound child SA to fail
          over to another member has the effect of disabling replay counter protection for a short
          time. Though the threat is arguably low, it is a policy decision whether this is 
          acceptable.
</p>
<a name="acknowledgements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Acknowledgements</h3>

<p> This document is the collective work, and includes contribution from many people who
          participate in the IPsecME working group.
</p>
<p> The editor would particularly like to acknowledge the extensive contribution of the 
          following people (in alphabetical order): Dan Harkins, Steve Kent, Tero Kivinen, Yaron 
          Sheffer, Melinda Shore, and Rodney Van Meter.
</p>
<a name="history"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Change Log</h3>

<p> NOTE TO RFC EDITOR: REMOVE THIS SECTION BEFORE PUBLICATION
</p>
<p> Version 00 was identical to draft-nir-ipsecme-ipsecha-ps-00, re-spun as an WG 
          document.
</p>
<p> Version 01 included closing issues 177, 178 and 180, with updates to terminology, and
          added discussion of inbound SAs and the CTR issue.
</p>
<p> Version 02 includes comments by Yaron Sheffer and the acknowledgement section.
</p>
<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>7.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="COUNTER_MODES">[COUNTER_MODES]</a></td>
<td class="author-text">McGrew, D. and B. Weis, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-msec-ipsec-group-counter-modes.txt">Using Counter Modes with Encapsulating Security Payload (ESP) and Authentication Header (AH) to Protect Group Traffic</a>,&rdquo; draft-ietf-msec-ipsec-group-counter-modes (work in progress), March&nbsp;2010 (<a href="http://tools.ietf.org/id/draft-ietf-msec-ipsec-group-counter-modes">TXT</a>, <a href="http://tools.ietf.org/html/draft-ietf-msec-ipsec-group-counter-modes">HTML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="CTR">[CTR]</a></td>
<td class="author-text">Housley, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3686">Using Advanced Encryption Standard (AES) Counter Mode</a>,&rdquo; RFC&nbsp;3686, January&nbsp;2009 (<a href="http://www.ietf.org/rfc/rfc3686.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc3686.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc3686.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="GCM">[GCM]</a></td>
<td class="author-text">Viega, J. and D. McGrew, &ldquo;<a href="http://tools.ietf.org/html/rfc4106">The Use of Galois/Counter Mode (GCM) in IPsec Encapsulating Security Payload (ESP)</a>,&rdquo; RFC&nbsp;4106, June&nbsp;2005 (<a href="http://www.ietf.org/rfc/rfc4106.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc4106.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc4106.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="REDIRECT">[REDIRECT]</a></td>
<td class="author-text">Devarapalli, V. and K. Weniger, &ldquo;<a href="http://tools.ietf.org/html/rfc5685">Redirect Mechanism for IKEv2</a>,&rdquo; RFC&nbsp;5685, November&nbsp;2009 (<a href="http://www.ietf.org/rfc/rfc5685.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc5685.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc5685.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4301">[RFC4301]</a></td>
<td class="author-text">Kent, S. and K. Seo, &ldquo;<a href="http://tools.ietf.org/html/rfc4301">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;4301, December&nbsp;2005 (<a href="http://www.ietf.org/rfc/rfc4301.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc4301.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc4301.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4306">[RFC4306]</a></td>
<td class="author-text">Kaufman, C., &ldquo;<a href="http://tools.ietf.org/html/rfc4306">Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4306, December&nbsp;2005 (<a href="http://www.ietf.org/rfc/rfc4306.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc4306.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc4306.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4718">[RFC4718]</a></td>
<td class="author-text">Eronen, P. and P. Hoffman, &ldquo;<a href="http://tools.ietf.org/html/rfc4718">IKEv2 Clarifications and Implementation Guidelines</a>,&rdquo; RFC&nbsp;4718, October&nbsp;2006 (<a href="http://www.ietf.org/rfc/rfc4718.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc4718.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc4718.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="VRRP">[VRRP]</a></td>
<td class="author-text">Hinden, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3768">Virtual Router Redundancy Protocol (VRRP)</a>,&rdquo; RFC&nbsp;3768, April&nbsp;2004 (<a href="http://www.ietf.org/rfc/rfc3768.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc3768.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc3768.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="resumption">[resumption]</a></td>
<td class="author-text">Sheffer, Y. and H. Tschofenig, &ldquo;<a href="http://tools.ietf.org/html/rfc5723">IKEv2 Session Resumption</a>,&rdquo; RFC&nbsp;5723, January&nbsp;2010 (<a href="http://www.ietf.org/rfc/rfc5723.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc5723.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc5723.xml">XML</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Yoav Nir</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Check Point Software Technologies Ltd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5 Hasolelim st.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tel Aviv  67897</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Israel</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ynir@checkpoint.com">ynir@checkpoint.com</a></td></tr>
</table>
</body></html>
