<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>IKEv2/IPsec SA counter synchronization</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="IKEv2/IPsec SA counter synchronization">
<meta name="keywords" content="Internet-Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">G. Kalyani</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">July 11, 2010</td></tr>
<tr><td class="header">Expires: January 12, 2011</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />IKEv2/IPsec SA counter synchronization<br />draft-kagarigi-ipsecme-ikev2-windowsync-03</h1>

<h3>Abstract</h3>

<p>   This document describes an extension to the IKEv2 protocol that
        allows the synchronization of IKEv2/IPsec SA counters between the peers.
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on January 12, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#Term">2.</a>&nbsp;
Terminology<br />
<a href="#anchor2">3.</a>&nbsp;
Issues solved from IPsec Cluster Problem Statement<br />
<a href="#sync_problem">4.</a>&nbsp;
IKEv2/IPsec SA Counter Synchronization Problem <br />
<a href="#anchor3">5.</a>&nbsp;
IKEv2/IPsec SA Counter Synchronization Solution<br />
<a href="#sync_payload">6.</a>&nbsp;
SA counter synchronization notify and payload types<br />
<a href="#anchor4">7.</a>&nbsp;
Details of implementation<br />
<a href="#Security">8.</a>&nbsp;
Security Considerations<br />
<a href="#anchor5">9.</a>&nbsp;
Interaction with other drafts<br />
<a href="#anchor6">10.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor7">11.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">12.</a>&nbsp;
Normative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p> IKEv2 and IPsec Protocols are used in delpoying VPN. 
 But the protocols are prone to certain issues which make them bring down the SA's  in case of Clusters, 
 which is not desirable.The draft <a class='info' href='#IPsec Cluster Problem Statement'>[IPsec Cluster Problem Statement]<span> (</span><span class='info'>Nir, Y., &ldquo;IPsec Cluster Problem Statement,&rdquo; July&nbsp;2010.</span><span>)</span></a> enumerates all the issues encountered in
IKEv2 and IPsec in HA cluster environment.This draft solves the main issues and gives implementation advice for others. 
</p>
<a name="Term"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in
          <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement             Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].
</p>
<p> "Hot Standby Cluster", or "HS Cluster" is a cluster where only one of  the members is active at any one time. 
                 This member is also referred  to as the "active", whereas the other(s) are referred to as "standbys".  
                  VRRP ([RFC5798]) is one method of building such a cluster. The goal of Hot Standby Cluster is that it
                  creates illusion of single virtual gateway to the peer(s). 
</p>
<p> "Active Member" is the primary member in the Hot Standby cluster. It is responsible for forwarding packets
                for the virtual gateway. 
</p>
<p> "Standby Member" is the primary backup router. The member takes control i.e. becomes active member after
                 the "failvover" event. 
</p>
<p> "Peer" is the IKEv2/IPsec endpoint which establishes VPN connection with Hot Standby cluster. The Peer 
                 knows Hot Standby Cluster by single cluster's IP address. In case of "failover", the standby member of the
                 cluster becomes active, so the peer normally doesn't notice that "failover" has occured in the cluster. 
</p>
<p> "SA Counter SYNC Request" is the information exchange request defined in this draft to synchronize the 
                 IKEv2/IPsec SA counter information between member of the cluster and the peer. 
</p>
<p> "SA Counter SYNC Response" is the information exchange response defined in this draft to synchronize 
                 the IKEv2/IPsec SA counter information between member of the cluster and the peer. 
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Issues solved from IPsec Cluster Problem Statement</h3>

<p>  IPsec Cluster Problem Statement defines the problems encountered in IPsec Clusters.
      The problems along with their section names as given in  the statement is as follows.   
</p>
<ul class="text">
<li>   3.2.  Lots of Long Lived State 
</li>
<li>  3.3.  IKE Counters
</li>
<li>  3.4.  Outbound SA Counters
</li>
<li> 3.5.  Inbound SA Counters
</li>
<li>  3.6.  Missing Synch Messages
</li>
<li>  3.7.  Simultaneous use of IKE and IPsec SAs by Different
           Members    
<ul class="text">
<li>   3.7.1.  Outbound SAs using counter modes
</li>
</ul>
     
</li>
<li>   3.8.  Different IP addresses for IKE and IPsec
</li>
<li>  3.9.  Allocation of SPIs
</li>
</ul><p>
    
</p>
<p> This draft solves the main issues using the protocol extention,
 and provides implementation advice for other issues, given as follows.

</p>
<ul class="text">
<li>3.2 Just says that there's lots of state that needs to be synchronized. 
If state is not synchronized, it's not really an interesting cluster - failover will be just like a 
reboot, so the issue need not be solved with protocol extensions. 
</li>
<li>3.3, 3.4,3.5, and 3.6 are solved by this draft. Please see <a class='info' href='#sync_problem'>Section&nbsp;4<span> (</span><span class='info'>IKEv2/IPsec SA Counter Synchronization Problem </span><span>)</span></a>, 
     for more details. 
</li>
<li>3.7 is  the problem to be solved while building clusters.  
        However,  the peers should be mandated to accept multiple parallel SAs for 3.7.1 
</li>
<li> 3.8 can be solved by using IKEv2 Redirect Mechanism [RFC-5685].
</li>
<li>3.9 is really a problem faced by all kinds of clusters - 
DHCP servers must not allocate the same IP. If DHCP can manage to do it, so can the cluster.
</li>
</ul><p>

</p>
<p> 
</p>
<a name="sync_problem"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
IKEv2/IPsec SA Counter Synchronization Problem </h3>

<p>  IKEv2 RFC states that "An IKE endpoint MUST NOT exceed the peer's stated window size for
        transmitted IKE requests".
</p>
<p>As per the protocol, all IKEv2 packets follows request-response paradigm. 
        The initiator of an IKEv2 request MUST retrssansmit the request, until it has received a response from the peer.
        IKEv2 introduces a windowing mechanism that allows multiple requests to be outstanding at a given point of time, but mandates
        that the sender window does not move until the oldest message sent from one peer to another is acknowledged.
        Loss of even a single packet leads to repeated retransmissions followed by an IKEv2 SA teardown if the retransmissions are unacknowledged.
</p>
<p> IPsec Hot Standby Cluster  is required to ensure that in case of failover of active member, the standby member becomes active immediately.
        The standby member is expected to have the exact values of message id fields of active member before failover.
        Even with the best efforts to update the message Id values from active to standby member, the values at standby 
        member can be stale due to following reasons:

        </p>
<ul class="text">
<li> Standby member is unaware of the last message that was received and acknowledged by the 
          older active member as failover could have happened before the standby could be updated.
</li>
<li> Standby member does not have information about on-going unackowledged requests of active member before the failover event.
              So after failover event when standby member becomes active, it can not re-transmits those requests.
</li>
</ul><p>
         
</p>
<p> 
</p>
<p> When a standby member takes over as the active member, it would start the message id ranges from previously updated values.
        This would make it reject requests from the peer, since the values would be stale.
        As a sender, the standby member may end up reusing a stale message id which will cause the peer to drop the request.
        Eventually there is a high probability of the IKEv2 and corresponding IPsec SAs getting torn down simply because of a 
        transitory message id mismatch and re-transmission of requests.  This is not a desirable feature of HA. Even after updating 
        standby memeber periodically the cluster can loose IKE and so all IPsec SA due to message id i.e. SA counter mismatch. 
</p>
<p>Hence a mechanism is required in HA to ensure that the standby member has correct values of message Id values, 
        so that sessions are not torn down just because of window ranges.
</p>
<p>Similar issue is observed in IPsec counters also.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
IKEv2/IPsec SA Counter Synchronization Solution</h3>

<p>After the standby member becomes the active member after failover event in the cluster, the standby member 
        would send an authenticated IKEv2 request to the peer to send its values of SA counters.
</p>
<p> The standby member would then update its values of SA counters and then start sending/receiving the requests.
</p>
<p> The peer MUST negotiate its ability to support SA counter synchronization information with active member by sending the 
            SYNC_SA_COUNTER_INFO_SUPPORTED notification in IKE_AUTH exchange. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

    Peer                                                Active Member
    - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   HDR, SK {IDi, [CERT], [CERTREQ], [IDr], AUTH,
    N[SYNC_SA_COUNTER_INFO_SUPPORTED], SAi2, TSi, TSr} ----------&gt;

    &lt;---------- HDR, SK {IDr, [CERT+], [CERTREQ+], AUTH,
                  N[SYNC_SA_COUNTER_INFO_SUPPORTED], SAr2, TSi, TSr}

</pre></div>
<p> When peer and active member both supports SA counter synchronization, the active member MUST sync/update SA counter 
               synchronization capability to the standby member after the establishment of the IKE SA. So that standby member is aware of 
               the capability and can use it when it becomes the active member after failover event.
</p>
<p>  After failover event, when the standby member becomes the active member, it has to request the peer for the SA counters.
                Standby member would initiate the SYNC Request with an INFORMATIONAL exchange containing the notify SYNC_SA_COUNTER_INFO.
                The SYNC_SA_COUNTER_INFO information can be used for update IKEv2 counters i.e. message ids and also IPsec SA replay counters. 
</p>
<p>  The peer will  respond back with the notify SYNC_SA_COUNTER_INFO. The SYNC_SA_COUNTER_INFO request contains 
                NONCE data to avoid DOS attack due to replay of SA counter sync response. The Nonce data send in SYNC_SA_COUNTER_INFO
                response MUST match with nonce data sent by newly-active member in SYNC_SA_COUNTER_INFO request. If nonce data received in 
                SYNC_SA_COUNTER_INFO response does not match with nonce data sent in SYNC_SA_COUNTER_INFO request, the standby i.e. 
                newly-active member MUST discard this SYNC_SA_COUNTER_INFO response, and normal IKEv2 behaviour of re-transmitting the
                request and waiting for genuine reply from the peer SHOULD follow, before tearing down the SA becuase of re-transmits. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

   Standby [Newly Active] Member                            Peer
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   HDR, SK {N[SYNC_SA_COUNTER_INFO]+} --------&gt;

             &lt;--------- HDR, SK {N[SYNC_SA_COUNTER_INFO]+}

</pre></div>
<a name="sync_payload"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
SA counter synchronization notify and payload types</h3>

<p>Below are the new notify and payload types that are defined </p>
<ul class="text">
<li>SYNC_SA_COUNTER_INFO_SUPPORTED:  This notify is included in the IKE_AUTH request by the peer to indicate the 
     support for IKEv2/IPsec SA counter synchronization mechanism described in this document. 
      
      <br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                          1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    | Next Payload  |C|  RESERVED   |         Payload Length        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |Protocol ID(=0)| SPI Size (=0) |      Notify Message Type      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;SYNC_SA_COUNTER_INFO_SUPPORTED&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

      
</li>
<li> The 'Next Payload', 'Payload Length', 'Protocol ID', 'SPI Size', and 'Notify Message Type'
           fields are the same as described in Section 3 of <a class='info' href='#IKEv2bis'>[IKEv2bis]<span> (</span><span class='info'>Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;Internet Key Exchange Protocol: IKEv2,&rdquo; May&nbsp;2010.</span><span>)</span></a>.  
            The 'SPI Size' field MUST be set  to 0 to indicate that the SPI is not present in this message.  
            The 'Protocol ID' MUST be set to 0, since the notification is not specific to a particular security association. 
      
            'Payload Length' field is set to the length in octets of the entire payload, including 
             the generic payload header.  The 'Notify Message Type' field is set to indicate the 
            SYNC_SA_COUNTER_INFO_SUPPORTED payload. 
</li>
<li> SYNC_SA_COUNTER_INFO :  This payload type is defined to sync the SA counter information among
             newly-active [standby] member and the peer. The SYNC_SA_COUNTER_INFO payload can be used 
             to synchronize IKE SA counter and IPsec SA counters as well. So, multiple payloads of this type can be 
             used in the single exchange where one payload is used to sync the IKE SA counter information, 
             another payload can be used to sync the Child SA [ e.g. ESP, AH etc] information.

     
          
          <br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

         1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    | Next Payload  |M|  RESERVED   |         Payload Length        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |Protocol ID    | SPI Size      | # of SPI's    |Counter Size   |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    | 							            |
    ~                                                               ~
    |                                                               |
    ~                     Nonce Data                                ~
    |                                                               |
    ~                                                               ~
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |             EXPECTED_SEND_REQ_MESSAGE_ID                      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |             EXPECTED_RECV_REQ_MESSAGE_ID                      |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                            SPI                                |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                                                               |
    ~            Last Counter                                       ~
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;SYNC_SA_COUNTER_INFO&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

 It contains the following data.
<ul class="text">
<li> Protocol ID (1 octet) - Must be 1 for an IKE SA, 2 for AH, or 3 for ESP.
</li>
<li>SPI Size (1 octet) - Length in octets of the SPI as defined by the
      protocol ID.  It MUST be zero for IKE or four for AH and ESP.
</li>
<li>  # of SPIs (1 octet) - The number of SPIs contained in this
            payload.  The size of each SPI is defined by the SPI Size field. It MUST be 
          zero if protocol is IKE.
</li>
<li> Counter Size (1 octet) is  the size of IPsec SA counter in octets. It is 4 if the Extended 
            Sequence Numbers option is not set for the SAs described in this payload, or 8 otherwise.
             It MUST be zero if protocol is IKE.
</li>
<li>  Nonce Data (4 octets) - The nonce data MUST be present if protocol IS is IKE. The nonce 
              data is used to counter the replay of SYNC_SA_COUNTER_INFO response by the attacker. 
</li>
<li> EXPECTED_SEND_REQ_MESSAGE_ID (4 octets) : This MUST be present only if protocol ID is IKE. 
            This field is used by the sender of this notify,  to indicate the message Id it will use in the next request, t
             that it will send to the peer. It MUST be present only in SA counter synchronization response and MUST 
             be ignored in SA counter synchronization request. 
</li>
<li>  The peer should not wait for pending request For example if window size is 5 and 
              peer window is 3-7  and if peer has sent requests 3, 4,5,6,7 and but got response only for 4,5,6,7 but not 3 then  
              it should send the EXPECTED_SEND_REQ_MESSAGE_ID as 8 and should not wait for response of 3 anymore
</li>
<li> EXPECTED_RECV_REQ_MESSAGE_ID(4 octets) : This field is used by the sender of this notify,
              to indicate the message Id it can accept in the next request, received from the peer.This data MUST be present
              only in response and MUST be ignored if present in REQUEST.This MUST be present only if protocol ID is IKE.
</li>
<li>
     The peer should not wait for pending request For example if window size is 5 and 
 peer window is 3-7  and if peer has received requests 4,5,6,7 but not 3 then  it should send the
EXPECTED_RECV_REQ_MESSAGE_ID as 8 and should not wait for 3 anymore.
</li>
<li> SPI (4 octets) is the Security Parameter Index of the outbound SA
      for the sender, or the inbound SA for the receiver. 
</li>
<li> Last Counter (4 or 8 octets) is the counter number of the last
      packet sent.  The receiver MUST drop any IPsec packet with replay
      counter lower than this. 
</li>
<li> M (More - 1 bit) - This flag MUST be set when there are some IPsec are left to be synced, but can not 
       be send due to packet size or some other limitation. When M bit is zero it, it tell it is last SA counter sync message.
</li>
</ul>

        
</li>
</ul><p>
    
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Details of implementation</h3>

<p> The message Id used in this exchange MUST be zero so that it is not vaildated
   upon receipt. Message Id zero MUST be permitted only for informational exchange that would have
   NOTIFY of type SYNC_SA_COUNTER_INFO. If any packet uses the message Id Zero,
   without having this Notify along with the Nonce payload, then such packets MUST be discarded upon decryption.
   No other payloads are allowed in this Informational exchange.
</p>
<p>    The standby member can initiate this Exchange    </p>
<ul class="text">
<li>  When it receives the bad IKEv2/IPsec packet. The 'bad" IKEv2/IPsec packet means a packet outside receive window.
</li>
<li> When it has to send an IKEv2/IPsec packet after failover event.
</li>
<li>  It has just got the control from active member and want to update the values before-hand,
        so that it need not start this exchange at the time of sending/receiving the request.
</li>
</ul><p>
      
</p>
<p> Since there can be many sessions at Standby member, and sending exchanges from all of the
        sessions can cause throttling, the standby member can choose to initiate the exchange when it has to
        send or receive the request. Thus the trigger to initiate this exchange depends on the requirement/discretion
        of the standby member.
</p>
<p> The member which has not announced its capability  SYNC_SA_COUNTER_INFO_SUPPORTED
            MUST NOT send/receive  the notify SYNC_SA_COUNTER_INFO. 
</p>
<p> If a peer gets SYNC_SA_COUNTER_INFO request even though it did not announce its capability in IKE_AUTH exchange,
            then it MUST ignore this message. 
</p>
<a name="Security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>
There can be two types of DOS attacks.

 </p>
<ul class="text">
<li>  Replay of Message SYNC Request.
   This can be countered by rate limiting the number of such requests a peer member can receive.
   The rate limiting can be done either by number or the time delay between which Message SYNC request 
can be received or both.These options are configurable. 
</li>
<li> Replay of Message SYNC Response.
   This can be countered by sending the NONCE data along with the SYNC_SA_COUNTER_INFO notify. The same  NONCE 
    data has to be returned in response.  Thus the standby member can accept the reply only for the current request.
   After it receives the response, it MUST not accept the same response again and MUST drop the response.

</li>
</ul><p>   


</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Interaction with other drafts</h3>

<p>
         The primary assumption of IKEv2/IPsec SA Counter Synchronization prososal is IKE SA has established between 
          active member of Hot Standby Cluster and peer, after that the failover event occurred and now standby member 
          has "become" active. It also assumes the IKE SA state was synced between active and standby member of the 
          Hot Standby Cluster before the failover event.

 </p>
<ul class="text">
<li>  Session Resumption. 
          While session resumption assumes that peer i.e. client or initiator detects the need to re-establish the session. On the
          other hand in IKEv2/IPsec SA counter cynchronization, standby member which becomes active i.e. gateway or responder
          detects the need to synchronize the SA counter after the failover event. 
          Also in Hot Standby Cluster, peer establishes the IKE/IPsec session with single cluster's IP address, so peer normally does
          not detect the event of failover in the cluster until standby member took very long to become active and IKE SA times out via
          liveness check. So, session resumption and SA counter synchronization after failover are mutually exclusive.
    
</li>
<li> Redirect.
         Redirect mechanism for load-balancing can be used during init (IKE_SA_INIT) and auth (IKE_AUTH) and after session 
         establishment. While SA counter sync is used after IKE SA has been established and failover event has occurred.
         So it is mutually exclusive with redirect during init and auth. The redirect after session established is used for timed
         or planned shutdown/maintenance. The failover event can not be detected on active member beforehand and so using 
         redirect after session establishment is not possible in case of failover. So, Redirect and SA counter synchronization 
         after failover are mutually exclusive.
    
</li>
<li> Crash detection. 
         Either SA counter information sync or crash detection approach can be taken by standby member on failover event.
    
</li>
</ul><p>   


</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
IANA Considerations</h3>

<p>
        This document  introduces two new IKEv2 Notification Message types as
        described in Section 5.The new Notify Message Types must be assigned values between 16396 and 40959.
   </p>
<ul class="text">
<li>  SYNC_SA_COUNTER_INFO_SUPPORTED
</li>
<li>  SYNC_SA_COUNTER_INFO
</li>
</ul><p>
    
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Acknowledgements</h3>

<p>  This draft is the combined effort of HA Design team which consists of the following members (in alphabetical order)  
Dacheng Zhang, Min Huang, Raj Singh, Yaron Sheffer and Yoav Nir.
I would like to thank Pratima Sethi and Frederic Detienne for their valuable reviews and suggestions.  
</p>
<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="IKEv2bis">[IKEv2bis]</a></td>
<td class="author-text">Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-ikev2bis.txt">Internet Key Exchange Protocol: IKEv2</a>,&rdquo; draft-ietf-ipsecme-ikev2bis (work in progress), May&nbsp;2010 (<a href="http://tools.ietf.org/id/draft-ietf-ipsecme-ikev2bis">TXT</a>, <a href="http://tools.ietf.org/html/draft-ietf-ipsecme-ikev2bis">HTML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="IPsec Cluster Problem Statement">[IPsec Cluster Problem Statement]</a></td>
<td class="author-text">Nir, Y., &ldquo;IPsec Cluster Problem Statement,&rdquo; July&nbsp;2010.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement
            Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5685">[RFC5685]</a></td>
<td class="author-text">Devarapalli, V. and K. Weniger, &ldquo;<a href="http://tools.ietf.org/html/rfc5685">Redirect Mechanism for IKEv2</a>,&rdquo; RFC&nbsp;5685, November&nbsp;2009 (<a href="http://www.ietf.org/rfc/rfc5685.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc5685.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc5685.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5723">[RFC5723]</a></td>
<td class="author-text">Sheffer, Y. and H. Tschofenig, &ldquo;<a href="http://tools.ietf.org/html/rfc5723">IKEv2 Session Resumption</a>,&rdquo; RFC&nbsp;5723, January&nbsp;2010 (<a href="http://www.ietf.org/rfc/rfc5723.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc5723.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc5723.xml">XML</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Kalyani Garigipati</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">SEZ Unit, Cessna Business Park</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bangalore, Karnataka  560025</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">India</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+91 80 4426 4831</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:kagarigi@cisco.com">kagarigi@cisco.com</a></td></tr>
</table>
</body></html>
