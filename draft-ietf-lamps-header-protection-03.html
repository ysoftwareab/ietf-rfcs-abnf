<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Header Protection for S/MIME</title>
<meta content="Daniel Kahn Gillmor" name="author">
<meta content="Bernie Hoeneisen" name="author">
<meta content="Alexey Melnikov" name="author">
<meta content="
       S/MIME version 3.1 has introduced a feasible standardized option to
accomplish Header Protection.
However, few implementations generate messages using this structure, and
several legacy and non-legacy implementations have revealed rendering issues at the receiving side.
Clearer specifications regarding message processing, particularly with
respect to header sections, are needed in order to resolve these
rendering issues.
Some mail user agents are also sending and receiving cryptographically-protected message headers using a different structure. 
       In order to help implementers to correctly compose and
render email messages with Header Protection, this document
updates S/MIME Header Protection specifications with additional guidance
on MIME format, sender and receiver processing. 
    " name="description">
<meta content="xml2rfc 3.5.0" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-ietf-lamps-header-protection-03" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.5.0
    Python 3.6.12
    appdirs 1.4.4
    ConfigArgParse 1.3
    google-i18n-address 2.4.0
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 2.11.3
    kitchen 1.2.6
    lxml 4.6.2
    pycountry 20.7.3
    pyflakes 2.2.0
    PyYAML 5.4.1
    requests 2.25.1
    setuptools 53.0.0
    six 1.15.0
-->
<link href="/tmp/draft-ietf-lamps-header-protection-qoz332r1.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necssary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: 'Noto Sans', Arial, Helvetica, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre, code {
  background-color: #f9f9f9;
  font-family: 'Roboto Mono', monospace;
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: "Noto Sans",Arial,Helvetica,sans-serif;
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {

    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The follwing is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre, code {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
pre.sourcecode,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact informatio look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background sligthtly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: avoid-page;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottim margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the comact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div:first-child > pre.sourcecode,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<script type="application/javascript">async function addMetadata(){try{const e=document.styleSheets[0].cssRules;for(let t=0;t<e.length;t++)if(/#identifiers/.exec(e[t].selectorText)){const a=e[t].cssText.replace("#identifiers","#external-updates");document.styleSheets[0].insertRule(a,document.styleSheets[0].cssRules.length)}}catch(e){console.log(e)}const e=document.getElementById("external-metadata");if(e)try{var t,a="",o=function(e){const t=document.getElementsByTagName("meta");for(let a=0;a<t.length;a++)if(t[a].getAttribute("name")===e)return t[a].getAttribute("content");return""}("rfc.number");if(o){t="https://www.rfc-editor.org/rfc/rfc"+o+".json";try{const e=await fetch(t);a=await e.json()}catch(e){t=document.URL.indexOf("html")>=0?document.URL.replace(/html$/,"json"):document.URL+".json";const o=await fetch(t);a=await o.json()}}if(!a)return;e.style.display="block";const s="",d="https://datatracker.ietf.org/doc",n="https://datatracker.ietf.org/ipr/search",c="https://www.rfc-editor.org/info",l=a.doc_id.toLowerCase(),i=a.doc_id.slice(0,3).toLowerCase(),f=a.doc_id.slice(3).replace(/^0+/,""),u={status:"Status",obsoletes:"Obsoletes",obsoleted_by:"Obsoleted By",updates:"Updates",updated_by:"Updated By",see_also:"See Also",errata_url:"Errata"};let h="<dl style='overflow:hidden' id='external-updates'>";["status","obsoletes","obsoleted_by","updates","updated_by","see_also","errata_url"].forEach(e=>{if("status"==e){a[e]=a[e].toLowerCase();var t=a[e].split(" "),o=t.length,w="",p=1;for(let e=0;e<o;e++)p<o?w=w+r(t[e])+" ":w+=r(t[e]),p++;a[e]=w}else if("obsoletes"==e||"obsoleted_by"==e||"updates"==e||"updated_by"==e){var g,m="",b=1;g=a[e].length;for(let t=0;t<g;t++)a[e][t]&&(a[e][t]=String(a[e][t]).toLowerCase(),m=b<g?m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>, ":m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>",b++);a[e]=m}else if("see_also"==e){var y,L="",C=1;y=a[e].length;for(let t=0;t<y;t++)if(a[e][t]){a[e][t]=String(a[e][t]);var _=a[e][t].slice(0,3),v=a[e][t].slice(3).replace(/^0+/,"");L=C<y?"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>, ":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>, ":"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>",C++}a[e]=L}else if("errata_url"==e){var R="";R=a[e]?R+"<a href='"+a[e]+"'>Errata exist</a> | <a href='"+d+"/"+l+"'>Datatracker</a>| <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>":"<a href='"+d+"/"+l+"'>Datatracker</a> | <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>",a[e]=R}""!=a[e]?"Errata"==u[e]?h+=`<dt>More info:</dt><dd>${a[e]}</dd>`:h+=`<dt>${u[e]}:</dt><dd>${a[e]}</dd>`:"Errata"==u[e]&&(h+=`<dt>More info:</dt><dd>${a[e]}</dd>`)}),h+="</dl>",e.innerHTML=h}catch(e){console.log(e)}else console.log("Could not locate metadata <div> element");function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}}window.removeEventListener("load",addMetadata),window.addEventListener("load",addMetadata);</script>
</head>
<body>
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">Header Protection S/MIME</td>
<td class="right">February 2021</td>
</tr></thead>
<tfoot><tr>
<td class="left">Gillmor, et al.</td>
<td class="center">Expires 26 August 2021</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">LAMPS Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-lamps-header-protection-03</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2021-02-22" class="published">22 February 2021</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2021-08-26">26 August 2021</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">D.K. Gillmor</div>
<div class="org">American Civil Liberties Union</div>
</div>
<div class="author">
      <div class="author-name">B. Hoeneisen</div>
<div class="org">pEp Foundation</div>
</div>
<div class="author">
      <div class="author-name">A. Melnikov</div>
<div class="org">Isode Ltd</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Header Protection for S/MIME</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">S/MIME version 3.1 has introduced a feasible standardized option to
accomplish Header Protection.
However, few implementations generate messages using this structure, and
several legacy and non-legacy implementations have revealed rendering issues at the receiving side.
Clearer specifications regarding message processing, particularly with
respect to header sections, are needed in order to resolve these
rendering issues.
Some mail user agents are also sending and receiving cryptographically-protected message headers using a different structure.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
<p id="section-abstract-2">In order to help implementers to correctly compose and
render email messages with Header Protection, this document
updates S/MIME Header Protection specifications with additional guidance
on MIME format, sender and receiver processing.<a href="#section-abstract-2" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 26 August 2021.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2021 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a><a href="#section-toc.1-1.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="xref">1.1</a>.  <a href="#name-two-schemes-of-protected-he" class="xref">Two Schemes of Protected Headers</a><a href="#section-toc.1-1.1.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.1.2.2">
                <p id="section-toc.1-1.1.2.2.1" class="keepWithNext"><a href="#section-1.2" class="xref">1.2</a>.  <a href="#name-problems-with-wrapped-messa" class="xref">Problems with Wrapped Messages</a><a href="#section-toc.1-1.1.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.1.2.3">
                <p id="section-toc.1-1.1.2.3.1" class="keepWithNext"><a href="#section-1.3" class="xref">1.3</a>.  <a href="#name-motivation" class="xref">Motivation</a><a href="#section-toc.1-1.1.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.1.2.4">
                <p id="section-toc.1-1.1.2.4.1"><a href="#section-1.4" class="xref">1.4</a>.  <a href="#name-other-protocols-to-protect-" class="xref">Other Protocols to Protect Email Headers</a><a href="#section-toc.1-1.1.2.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.1.2.5">
                <p id="section-toc.1-1.1.2.5.1"><a href="#section-1.5" class="xref">1.5</a>.  <a href="#name-requirements-language" class="xref">Requirements Language</a><a href="#section-toc.1-1.1.2.5.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.1.2.6">
                <p id="section-toc.1-1.1.2.6.1"><a href="#section-1.6" class="xref">1.6</a>.  <a href="#name-terms" class="xref">Terms</a><a href="#section-toc.1-1.1.2.6.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="xref">2</a>.  <a href="#name-problem-statement" class="xref">Problem Statement</a><a href="#section-toc.1-1.2.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1"><a href="#section-2.1" class="xref">2.1</a>.  <a href="#name-privacy" class="xref">Privacy</a><a href="#section-toc.1-1.2.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a href="#section-2.2" class="xref">2.2</a>.  <a href="#name-security" class="xref">Security</a><a href="#section-toc.1-1.2.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.2.2.3">
                <p id="section-toc.1-1.2.2.3.1"><a href="#section-2.3" class="xref">2.3</a>.  <a href="#name-usability" class="xref">Usability</a><a href="#section-toc.1-1.2.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.2.2.4">
                <p id="section-toc.1-1.2.2.4.1"><a href="#section-2.4" class="xref">2.4</a>.  <a href="#name-interoperability" class="xref">Interoperability</a><a href="#section-toc.1-1.2.2.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-use-cases" class="xref">Use Cases</a><a href="#section-toc.1-1.3.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-interactions" class="xref">Interactions</a><a href="#section-toc.1-1.3.2.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.3.2.1.2.1">
                    <p id="section-toc.1-1.3.2.1.2.1.1"><a href="#section-3.1.1" class="xref">3.1.1</a>.  <a href="#name-main-use-case" class="xref">Main Use Case</a><a href="#section-toc.1-1.3.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.3.2.1.2.2">
                    <p id="section-toc.1-1.3.2.1.2.2.1"><a href="#section-3.1.2" class="xref">3.1.2</a>.  <a href="#name-backward-compatibility-use-" class="xref">Backward Compatibility Use Cases</a><a href="#section-toc.1-1.3.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-protection-levels" class="xref">Protection Levels</a><a href="#section-toc.1-1.3.2.2.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.3.2.2.2.1">
                    <p id="section-toc.1-1.3.2.2.2.1.1"><a href="#section-3.2.1" class="xref">3.2.1</a>.  <a href="#name-in-scope" class="xref">In-Scope</a><a href="#section-toc.1-1.3.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.3.2.2.2.2">
                    <p id="section-toc.1-1.3.2.2.2.2.1"><a href="#section-3.2.2" class="xref">3.2.2</a>.  <a href="#name-out-of-scope" class="xref">Out-of-Scope</a><a href="#section-toc.1-1.3.2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-specification" class="xref">Specification</a><a href="#section-toc.1-1.4.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="xref">4.1</a>.  <a href="#name-main-use-case-2" class="xref">Main Use Case</a><a href="#section-toc.1-1.4.2.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.4.2.1.2.1">
                    <p id="section-toc.1-1.4.2.1.2.1.1"><a href="#section-4.1.1" class="xref">4.1.1</a>.  <a href="#name-mime-format" class="xref">MIME Format</a><a href="#section-toc.1-1.4.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.4.2.1.2.2">
                    <p id="section-toc.1-1.4.2.1.2.2.1"><a href="#section-4.1.2" class="xref">4.1.2</a>.  <a href="#name-sending-side" class="xref">Sending Side</a><a href="#section-toc.1-1.4.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.4.2.1.2.3">
                    <p id="section-toc.1-1.4.2.1.2.3.1"><a href="#section-4.1.3" class="xref">4.1.3</a>.  <a href="#name-default-header-confidential" class="xref">Default Header Confidentiality Policy</a><a href="#section-toc.1-1.4.2.1.2.3.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.4.2.1.2.4">
                    <p id="section-toc.1-1.4.2.1.2.4.1"><a href="#section-4.1.4" class="xref">4.1.4</a>.  <a href="#name-receiving-side" class="xref">Receiving Side</a><a href="#section-toc.1-1.4.2.1.2.4.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="xref">4.2</a>.  <a href="#name-backward-compatibility-use-c" class="xref">Backward Compatibility Use Cases</a><a href="#section-toc.1-1.4.2.2.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.4.2.2.2.1">
                    <p id="section-toc.1-1.4.2.2.2.1.1"><a href="#section-4.2.1" class="xref">4.2.1</a>.  <a href="#name-receiving-side-mime-conforma" class="xref">Receiving Side MIME-Conformant</a><a href="#section-toc.1-1.4.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.4.2.2.2.2">
                    <p id="section-toc.1-1.4.2.2.2.2.1"><a href="#section-4.2.2" class="xref">4.2.2</a>.  <a href="#name-receiving-side-not-mime-conf" class="xref">Receiving Side Not MIME-Conformant</a><a href="#section-toc.1-1.4.2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-usability-considerations" class="xref">Usability Considerations</a><a href="#section-toc.1-1.5.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-mixed-protections-within-a-" class="xref">Mixed Protections Within a Message Are Hard To Understand</a><a href="#section-toc.1-1.5.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-users-should-not-have-to-ch" class="xref">Users Should Not Have To Choose a Header Confidentiality Policy</a><a href="#section-toc.1-1.5.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-security-considerations" class="xref">Security Considerations</a><a href="#section-toc.1-1.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-privacy-considerations" class="xref">Privacy Considerations</a><a href="#section-toc.1-1.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-iana-considerations" class="xref">IANA Considerations</a><a href="#section-toc.1-1.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="xref">9</a>.  <a href="#name-acknowledgments" class="xref">Acknowledgments</a><a href="#section-toc.1-1.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="xref">10</a>. <a href="#name-references" class="xref">References</a><a href="#section-toc.1-1.10.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="xref">10.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a><a href="#section-toc.1-1.10.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="xref">10.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a><a href="#section-toc.1-1.10.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-appendix.a" class="xref">Appendix A</a>.  <a href="#name-test-vectors" class="xref">Test Vectors</a><a href="#section-toc.1-1.11.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-a.1" class="xref">A.1</a>.  <a href="#name-wrapped-message-examples" class="xref">Wrapped Message examples</a><a href="#section-toc.1-1.11.2.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.11.2.1.2.1">
                    <p id="section-toc.1-1.11.2.1.2.1.1"><a href="#section-a.1.1" class="xref">A.1.1</a>.  <a href="#name-wrapped-message-signed-only" class="xref">Wrapped Message: signed-only, with PKCS7 signedData</a><a href="#section-toc.1-1.11.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.1.2.2">
                    <p id="section-toc.1-1.11.2.1.2.2.1"><a href="#section-a.1.2" class="xref">A.1.2</a>.  <a href="#name-wrapped-message-signed-only-" class="xref">Wrapped Message: signed-only, using multipart/signed</a><a href="#section-toc.1-1.11.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.1.2.3">
                    <p id="section-toc.1-1.11.2.1.2.3.1"><a href="#section-a.1.3" class="xref">A.1.3</a>.  <a href="#name-wrapped-message-signed-and-" class="xref">Wrapped Message: signed-and-encrypted</a><a href="#section-toc.1-1.11.2.1.2.3.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-a.2" class="xref">A.2</a>.  <a href="#name-injected-headers-examples" class="xref">Injected Headers examples</a><a href="#section-toc.1-1.11.2.2.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.11.2.2.2.1">
                    <p id="section-toc.1-1.11.2.2.2.1.1"><a href="#section-a.2.1" class="xref">A.2.1</a>.  <a href="#name-injected-headers-signed-onl" class="xref">Injected Headers: signed-only, with PKCS7 signedData</a><a href="#section-toc.1-1.11.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.2.2.2">
                    <p id="section-toc.1-1.11.2.2.2.2.1"><a href="#section-a.2.2" class="xref">A.2.2</a>.  <a href="#name-injected-headers-signed-only" class="xref">Injected Headers: signed-only, using multipart/signed</a><a href="#section-toc.1-1.11.2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.2.2.3">
                    <p id="section-toc.1-1.11.2.2.2.3.1"><a href="#section-a.2.3" class="xref">A.2.3</a>.  <a href="#name-injected-headers-signed-and" class="xref">Injected Headers: signed-and-encrypted with Legacy Display part</a><a href="#section-toc.1-1.11.2.2.2.3.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.2.2.4">
                    <p id="section-toc.1-1.11.2.2.2.4.1"><a href="#section-a.2.4" class="xref">A.2.4</a>.  <a href="#name-injected-headers-signed-and-" class="xref">Injected Headers: signed-and-encrypted without Legacy Display part</a><a href="#section-toc.1-1.11.2.2.2.4.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.3">
                <p id="section-toc.1-1.11.2.3.1"><a href="#section-a.3" class="xref">A.3</a>.  <a href="#name-messages-without-header-pro" class="xref">Messages without Header Protection</a><a href="#section-toc.1-1.11.2.3.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.11.2.3.2.1">
                    <p id="section-toc.1-1.11.2.3.2.1.1"><a href="#section-a.3.1" class="xref">A.3.1</a>.  <a href="#name-unprotected-headers-signed-" class="xref">Unprotected Headers: signed-only, with PKCS7 signedData</a><a href="#section-toc.1-1.11.2.3.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.3.2.2">
                    <p id="section-toc.1-1.11.2.3.2.2.1"><a href="#section-a.3.2" class="xref">A.3.2</a>.  <a href="#name-unprotected-headers-signed-o" class="xref">Unprotected Headers: signed-only, using multipart/signed</a><a href="#section-toc.1-1.11.2.3.2.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.11.2.3.2.3">
                    <p id="section-toc.1-1.11.2.3.2.3.1"><a href="#section-a.3.3" class="xref">A.3.3</a>.  <a href="#name-unprotected-headers-signed-a" class="xref">Unprotected Headers: signed-and-encrypted</a><a href="#section-toc.1-1.11.2.3.2.3.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-appendix.b" class="xref">Appendix B</a>.  <a href="#name-additional-information" class="xref">Additional information</a><a href="#section-toc.1-1.12.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-b.1" class="xref">B.1</a>.  <a href="#name-stored-variants-of-messages" class="xref">Stored Variants of Messages with Bcc</a><a href="#section-toc.1-1.12.2.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-appendix.c" class="xref">Appendix C</a>.  <a href="#name-text-moved-from-above" class="xref">Text Moved from Above</a><a href="#section-toc.1-1.13.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#section-c.1" class="xref">C.1</a>.  <a href="#name-mime-format-2" class="xref">MIME Format</a><a href="#section-toc.1-1.13.2.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.13.2.1.2.1">
                    <p id="section-toc.1-1.13.2.1.2.1.1"><a href="#section-c.1.1" class="xref">C.1.1</a>.  <a href="#name-s-mime-specification" class="xref">S/MIME Specification</a><a href="#section-toc.1-1.13.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.13.2.1.2.2">
                    <p id="section-toc.1-1.13.2.1.2.2.1"><a href="#section-c.1.2" class="xref">C.1.2</a>.  <a href="#name-sending-side-2" class="xref">Sending Side</a><a href="#section-toc.1-1.13.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-appendix.d" class="xref">Appendix D</a>.  <a href="#name-document-considerations" class="xref">Document Considerations</a><a href="#section-toc.1-1.14.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-appendix.e" class="xref">Appendix E</a>.  <a href="#name-document-changelog" class="xref">Document Changelog</a><a href="#section-toc.1-1.15.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-appendix.f" class="xref">Appendix F</a>.  <a href="#name-open-issues" class="xref">Open Issues</a><a href="#section-toc.1-1.16.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#section-appendix.g" class="xref"></a><a href="#name-authors-addresses" class="xref">Authors' Addresses</a><a href="#section-toc.1-1.17.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">Privacy and security issues regarding email Header Protection in
S/MIME have been identified for some time.  Most current
implementations of cryptographically-protected electronic mail protect
only the body of the message, which leaves significant room for
attacks against otherwise-protected messages. For example, lack
of header protection allows an attacker to substitute the message subject
and/or author.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">This document describes two different structures for how message headers can be cryptographically protected, and provides guidance for implementers of MUAs that generate and interpret such messages.
It takes particular care to ensure that messages interact reasonably well with legacy MUAs.<a href="#section-1-2" class="pilcrow">¶</a></p>
<div id="two-schemes-of-protected-headers">
<section id="section-1.1">
        <h3 id="name-two-schemes-of-protected-he">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-two-schemes-of-protected-he" class="section-name selfRef">Two Schemes of Protected Headers</a>
        </h3>
<p id="section-1.1-1">Unfortunately, there are two different schemes for cryptographically-protected email headers that may be in use on the Internet today.
This document addresses them both and provides guidance to implementers.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">One scheme is the form specified in S/MIME 3.1 and later, which involves wrapping a <code>message/rfc822</code> MIME object with a Cryptographic Envelope.
This document calls this scheme "Wrapped Message", and it is documented in more detail in <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>.
Experience has shown that this form does not interact well with some legacy MUAs (see <a href="#wrapped-message-problems" class="xref">Section 1.2</a>).<a href="#section-1.1-2" class="pilcrow">¶</a></p>
<p id="section-1.1-3">Consequently, another form of header protection is produced and consumed by some MUAs, where the protected headers are placed directly on the Cryptographic Payload, without using an intervening <code>message/*</code> MIME object.
This document calls this scheme "Injected Headers", and it is documented in more detail in <span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span>.<a href="#section-1.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="wrapped-message-problems">
<section id="section-1.2">
        <h3 id="name-problems-with-wrapped-messa">
<a href="#section-1.2" class="section-number selfRef">1.2. </a><a href="#name-problems-with-wrapped-messa" class="section-name selfRef">Problems with Wrapped Messages</a>
        </h3>
<p id="section-1.2-1">Several legacy MUAs have revealed rendering issues when dealing with a message with headers protected by the Wrapped Message scheme.
In some cases the user sees an attachment
suggesting a forwarded email message, which -- in fact -- contains the
protected email message that should be rendered directly. For these cases,
the user can click on the attachment to view the protected message. However,
there have also been reports of email clients displaying garbled text,
or sometimes nothing at all. In those cases the email clients on the
receiving side are (most likely) not fully MIME-capable.<a href="#section-1.2-1" class="pilcrow">¶</a></p>
<p id="section-1.2-2">The following shortcomings have been identified to cause these issues:<a href="#section-1.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.2-3.1">Broken or incomplete implementations<a href="#section-1.2-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.2-3.2">Lack of a simple means to distinguish "forwarded message" and
"wrapped message" (for the sake of Header Protection)<a href="#section-1.2-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.2-3.3">Not enough guidance with respect to handling of Header Fields on both
the sending and the receiving side<a href="#section-1.2-3.3" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="motivation">
<section id="section-1.3">
        <h3 id="name-motivation">
<a href="#section-1.3" class="section-number selfRef">1.3. </a><a href="#name-motivation" class="section-name selfRef">Motivation</a>
        </h3>
<p id="section-1.3-1">Furthermore, the need (technical) Data Minimization, which includes
data sparseness and hiding all technically concealable information,
has grown in importance over the past several years. In addition, backwards
compatibility must be considered when it is possible to do so without
compromising privacy and security.<a href="#section-1.3-1" class="pilcrow">¶</a></p>
<p id="section-1.3-2">No mechanism for Header Protection has been standardized for
PGP/MIME (Pretty Good Privacy) <span>[<a href="#RFC3156" class="xref">RFC3156</a>]</span> yet.  PGP/MIME
developers have implemented ad-hoc header-protection,
and would like to see a specification that is
applicable to both S/MIME and PGP/MIME.<a href="#section-1.3-2" class="pilcrow">¶</a></p>
<p id="section-1.3-3">This document describes the problem statement (<a href="#problem-statement" class="xref">Section 2</a>),
generic use cases (<a href="#use-cases" class="xref">Section 3</a>) and the specification for Header
Protection (<a href="#specification" class="xref">Section 4</a>) with guidance on MIME format,
sender and receiver processing
.<a href="#section-1.3-3" class="pilcrow">¶</a></p>
<p id="section-1.3-4"><span>[<a href="#I-D.ietf-lamps-header-protection-requirements" class="xref">I-D.ietf-lamps-header-protection-requirements</a>]</span> defines the
requirements that this specification is based on.<a href="#section-1.3-4" class="pilcrow">¶</a></p>
<p id="section-1.3-5">This document is in an early draft state and contains a proposal on which
to base future discussions of this topic. In any case, the final
mechanism is to be determined by the IETF LAMPS WG.<a href="#section-1.3-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="other-protocols-to-protect-email-headers">
<section id="section-1.4">
        <h3 id="name-other-protocols-to-protect-">
<a href="#section-1.4" class="section-number selfRef">1.4. </a><a href="#name-other-protocols-to-protect-" class="section-name selfRef">Other Protocols to Protect Email Headers</a>
        </h3>
<p id="section-1.4-1">A range of protocols for the protection of electronic mail (email)
exists, which allows one to assess the authenticity and integrity of the
email headers section or selected Header Fields from the domain-level
perspective, specifically DomainKeys Identified Mail (DKIM)
<span>[<a href="#RFC6376" class="xref">RFC6376</a>]</span>, as used by Domain-based Message Authentication,
Reporting, and Conformance (DMARC) <span>[<a href="#RFC7489" class="xref">RFC7489</a>]</span>. These protocols
provide a domain-based reputation mechanism that can be used to
mitigate some forms of unsolicited email (spam).  At the same time,
these protocols can provide a level of cryptographic integrity and
authenticity for some headers, depending on how they are used.
However, integrity protection and proof of authenticity are both tied
to the domain name of the sending e-mail address, not the sending
address itself, so these protocols do not provide end-to-end protection,
and are incapable of providing any form of confidentiality.<a href="#section-1.4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="requirements-language">
<section id="section-1.5">
        <h3 id="name-requirements-language">
<a href="#section-1.5" class="section-number selfRef">1.5. </a><a href="#name-requirements-language" class="section-name selfRef">Requirements Language</a>
        </h3>
<p id="section-1.5-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span>.<a href="#section-1.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="terms">
<section id="section-1.6">
        <h3 id="name-terms">
<a href="#section-1.6" class="section-number selfRef">1.6. </a><a href="#name-terms" class="section-name selfRef">Terms</a>
        </h3>
<p id="section-1.6-1">The following terms are defined for the scope of this document:<a href="#section-1.6-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.6-2.1">
            <p id="section-1.6-2.1.1">Man-in-the-middle (MITM) attack: cf. <span>[<a href="#RFC4949" class="xref">RFC4949</a>]</span>, which states: "A
form of active wiretapping attack in which the attacker intercepts
and selectively modifies communicated data to masquerade as one or
more of the entities involved in a communication association."<a href="#section-1.6-2.1.1" class="pilcrow">¶</a></p>
<p id="section-1.6-2.1.2">
Note: Historically, MITM has stood for '<em>Man</em>-in-the-middle'.
However, to indicate that the entity in the middle is not always a
human attacker, MITM can also stand for 'Machine-in-the-middle' or
'Meddler-in-the-middle'.<a href="#section-1.6-2.1.2" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.6-2.2">S/MIME: Secure/Multipurpose Internet Mail Extensions (cf. <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>)<a href="#section-1.6-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.3">PGP/MIME: MIME Security with OpenPGP (cf. <span>[<a href="#RFC3156" class="xref">RFC3156</a>]</span>)<a href="#section-1.6-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.4">
            <p id="section-1.6-2.4.1">Message: An Email Message consisting of Header Fields
(collectively called "the Header Section of the message") followed,
optionally, by a Body; cf. <span>[<a href="#RFC5322" class="xref">RFC5322</a>]</span>.<a href="#section-1.6-2.4.1" class="pilcrow">¶</a></p>
<p id="section-1.6-2.4.2">
Note: To avoid ambiguity, this document does not use the terms
      "Header" or "Headers" in isolation, but instead always uses
      "Header Field" to refer to the individual field and "Header
      Section" to refer to the entire collection; cf. <span>[<a href="#RFC5322" class="xref">RFC5322</a>]</span>.<a href="#section-1.6-2.4.2" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.6-2.5">Header Field (HF): cf. <span>[<a href="#RFC5322" class="xref">RFC5322</a>]</span> Header Fields are lines beginning
with a field name, followed by a colon (":"), followed by a field
body (value), and terminated by CRLF.<a href="#section-1.6-2.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.6">Header Section (HS): The Header Section is a sequence of lines of
characters with special syntax as defined in <span>[<a href="#RFC5322" class="xref">RFC5322</a>]</span>.  It is the
(top) section of a Message containing the Header Fields.<a href="#section-1.6-2.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.7">Body: The Body is simply a sequence of bytes that follows the
Header Section and is separated from the Header Section by an empty
line (i.e., a line with nothing preceding the CRLF); cf <span>[<a href="#RFC5322" class="xref">RFC5322</a>]</span>.
It is the (bottom) section of Message containing the payload of a
Message. Typically, the Body consists of a (possibly multipart) MIME
<span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span> construct.<a href="#section-1.6-2.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.8">MIME Header Fields: Header Fields describing content of a MIME entity
<span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span>, in particular the MIME structure. Each MIME Header Field
name starts with "Content-" prefix.<a href="#section-1.6-2.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.9">MIME Header Section (part): The collection of MIME Header Fields.
"MIME Header Section" refers to a Header Sections that contains only
MIME Header Fields, whereas "MIME Header Section part" refers to the
MIME Header Fields of a Header Section that - in addition to MIME
Header Fields - also contains non-MIME Header Fields.<a href="#section-1.6-2.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.10">Essential Header Fields (EHF): The minimum set of Header Fields an
Outer Message Header Section SHOULD contain; cf. <a href="#outer-msg-hf" class="xref">Appendix C.1.2.5</a>.<a href="#section-1.6-2.10" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.11">Header Protection (HP): cryptographic protection of email Header
Sections (or parts of it) for signatures and/or encryption<a href="#section-1.6-2.11" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.12">Protection Levels (PL): The level of protection applied to a
Message, e.g.  'signature and encryption' or 'signature only'
(cf. <a href="#protection-levels" class="xref">Section 3.2</a>).<a href="#section-1.6-2.12" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.13">Protected: Portions of a message that have had any Protection Levels applied.<a href="#section-1.6-2.13" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.14">Protected Message: A Message that has had any Protection Levels applied.<a href="#section-1.6-2.14" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.15">Unprotected: Portions of a Message that has had no Protection Levels applied.<a href="#section-1.6-2.15" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.16">Unprotected Message: A Message that has had no Protection Levels applied.<a href="#section-1.6-2.16" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.17">
            <p id="section-1.6-2.17.1">Submission Entity: The entity which executes further processing of
the Message (incl. transport towards the receiver), after protection
measures have been applied to the Message.<a href="#section-1.6-2.17.1" class="pilcrow">¶</a></p>
<p id="section-1.6-2.17.2">
Note: The Submission Entity varies among implementations, mainly
      depending on the stage where protection measures are applied:
      E.g. a Message Submission Agent (MSA) <span>[<a href="#RFC6409" class="xref">RFC6409</a>]</span> or another
      (proprietary) solution. The latter is particularly relevant,
      if protection is implemented as a plugin solution. Some
      implementations may determine the destination recipients by
      reading the To, Cc and Bcc Header Fields of the Outer Message.<a href="#section-1.6-2.17.2" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.6-2.18">Original Message (OrigM): The Message to be protected before any
protection-related processing has been applied on the sending side.
If the source is not a "message/rfc822" Message, OrigM is defined as
the "virtual" Message that would be constructed for sending it as
unprotected email.<a href="#section-1.6-2.18" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.19">Inner Message (InnerM): The Message to be protected which has had
wrapping and protection measures aapplied on the sending side
OR the resulting Message once decryption and unwrapping on the receiving side
has been performed. Typically, the Inner Message is in clear text. The
Inner Message is a subset of (or the same as) the Original Message.
The Inner Message must be the same on the
sending and the receiving side.<a href="#section-1.6-2.19" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.20">Outer Message (OuterM): The Message as provided to the Submission
Entity or received from the last hop respectively. The Outer Message
normally differs on the sending and the receiving side (e.g. new
Header Fields are added by intermediary nodes).<a href="#section-1.6-2.20" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.21">Receiving User Facing Message (RUFM): The Message used for rendering
at the receiving side. Typically this is the same as the Inner
Message.<a href="#section-1.6-2.21" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.22">Data Minimization: Data sparseness and hiding of all technically
concealable information whenever possible.<a href="#section-1.6-2.22" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.23">Cryptographic Layer, Cryptographic Payload, Cryptographic
Envelope, Structural Headers, and MUA are all used as defined in
<span>[<a href="#I-D.dkg-lamps-e2e-mail-guidance" class="xref">I-D.dkg-lamps-e2e-mail-guidance</a>]</span><a href="#section-1.6-2.23" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.24">User-Facing Headers are defined in <span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span>.<a href="#section-1.6-2.24" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.25">Legacy MUA: a MUA that does not understand protected headers as described in this document.
A Legacy Non-Crypto MUA is incapable of doing any end-to-end cryptographic operations.
A Legacy Crypto MUA is capable of doing cryptographic operations, but does not understand or generate protected headers.<a href="#section-1.6-2.25" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.26">Wrapped Message: The protected headers scheme that uses the mechanism described in <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>, where the Cryptographic Payload is a <code>message/rfc822</code> or <code>message/global</code> MIME object.<a href="#section-1.6-2.26" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.27">Injected Headers: The protected headers scheme that uses the mechanism described in <span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span>, where the protected headers are inserted on the Cryptographic Payload directly.<a href="#section-1.6-2.27" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.6-2.28">Header Confidentiality Policy: documented in <a href="#header-confidentiality-policy" class="xref">Section 4.1.2.2</a><a href="#section-1.6-2.28" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="problem-statement">
<section id="section-2">
      <h2 id="name-problem-statement">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-problem-statement" class="section-name selfRef">Problem Statement</a>
      </h2>
<p id="section-2-1">The LAMPS charter contains the following Work Item:<a href="#section-2-1" class="pilcrow">¶</a></p>
<ul class="ulEmpty normal">
<li class="ulEmpty normal" id="section-2-2.1">Update the specification for the cryptographic protection of email
headers -- both for signatures and encryption -- to improve the
implementation situation with respect to privacy, security, usability
and interoperability in cryptographically-protected electronic mail.
Most current implementations of cryptographically-protected electronic
mail protect only the body of the message, which leaves significant
room for attacks against otherwise-protected messages.<a href="#section-2-2.1" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-2-3">In the following a set of challenges to be addressed:<a href="#section-2-3" class="pilcrow">¶</a></p>
<p id="section-2-4">[[ TODO: Enhance this section, add more items to the following. ]]<a href="#section-2-4" class="pilcrow">¶</a></p>
<div id="privacy">
<section id="section-2.1">
        <h3 id="name-privacy">
<a href="#section-2.1" class="section-number selfRef">2.1. </a><a href="#name-privacy" class="section-name selfRef">Privacy</a>
        </h3>
<ul class="normal">
<li class="normal" id="section-2.1-1.1">(Technical) Data Minimization, which includes data sparseness and
hiding all technically concealable information whenever possible<a href="#section-2.1-1.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="security">
<section id="section-2.2">
        <h3 id="name-security">
<a href="#section-2.2" class="section-number selfRef">2.2. </a><a href="#name-security" class="section-name selfRef">Security</a>
        </h3>
<ul class="normal">
<li class="normal" id="section-2.2-1.1">Prevent MITM attacks (cf. <span>[<a href="#RFC4949" class="xref">RFC4949</a>]</span>)<a href="#section-2.2-1.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="usability">
<section id="section-2.3">
        <h3 id="name-usability">
<a href="#section-2.3" class="section-number selfRef">2.3. </a><a href="#name-usability" class="section-name selfRef">Usability</a>
        </h3>
<ul class="normal">
<li class="normal" id="section-2.3-1.1">Improved User interaction / User experience, in particular at the
receiving side<a href="#section-2.3-1.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="interoperability">
<section id="section-2.4">
        <h3 id="name-interoperability">
<a href="#section-2.4" class="section-number selfRef">2.4. </a><a href="#name-interoperability" class="section-name selfRef">Interoperability</a>
        </h3>
<ul class="normal">
<li class="normal" id="section-2.4-1.1">Interoperability with <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span> implementations<a href="#section-2.4-1.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="use-cases">
<section id="section-3">
      <h2 id="name-use-cases">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-use-cases" class="section-name selfRef">Use Cases</a>
      </h2>
<p id="section-3-1">In the following, the reader can find a list of the generic use cases
that need to be addressed for Messages with Header Protection
(HP). These use cases apply regardless of technology (S/MIME,
PGP/MIME, etc.) used to achieve HP.<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="interactions">
<section id="section-3.1">
        <h3 id="name-interactions">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-interactions" class="section-name selfRef">Interactions</a>
        </h3>
<p id="section-3.1-1">The following use cases assume that at least the sending side supports
Header Protection as specified in this document. Receiving sides that
support this specification are expected to be able to distinguish
between Messages that use Header Protection as specified in this
document, and (legacy) Mail User Agents (MUAs) which do not implement
this specification.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">[[ TODO: Verify once solution is stable and update last sentence. ]]<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<div id="uc-ia-main-use-case">
<section id="section-3.1.1">
          <h4 id="name-main-use-case">
<a href="#section-3.1.1" class="section-number selfRef">3.1.1. </a><a href="#name-main-use-case" class="section-name selfRef">Main Use Case</a>
          </h4>
<p id="section-3.1.1-1">Both the sending and receiving side (fully) support Header Protection
as specified in this document.<a href="#section-3.1.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1.1-2">The main use case is specified in <a href="#main-use-case" class="xref">Section 4.1</a>.<a href="#section-3.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="uc-ia-backward-compatibility-use-cases">
<section id="section-3.1.2">
          <h4 id="name-backward-compatibility-use-">
<a href="#section-3.1.2" class="section-number selfRef">3.1.2. </a><a href="#name-backward-compatibility-use-" class="section-name selfRef">Backward Compatibility Use Cases</a>
          </h4>
<p id="section-3.1.2-1">Regarding backward compatibility, the main distinction is based on
whether or not the receiving side conforms to MIME according to
<span>[<a href="#RFC2046" class="xref">RFC2046</a>]</span>, ff., which in particular also includes Section 2 of
<span>[<a href="#RFC2049" class="xref">RFC2049</a>]</span> on "MIME Conformance". The following excerpt is
contextually relevant:<a href="#section-3.1.2-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-3.1.2-2">
<pre>
  A mail user agent that is MIME-conformant MUST:

  [...]

       -- Recognize and display at least the RFC822 message
       encapsulation (message/rfc822) in such a way as to
       preserve any recursive structure, that is, displaying
       or offering to display the encapsulated data in
       accordance with its media type.

       -- Treat any unrecognized subtypes as if they were
       "application/octet-stream".

  [...]

  An MUA that meets the above conditions is said to be MIME-
  conformant.  A MIME-conformant MUA is assumed to be "safe" to
  send virtually any kind of properly-marked data to users of
  such mail systems, because these systems are, at a minimum,
  capable of treating the data as undifferentiated binary, and
  will not simply splash it onto the screen of unsuspecting
  users.

</pre><a href="#section-3.1.2-2" class="pilcrow">¶</a>
</div>
<p id="section-3.1.2-3">[[ TODO: The compatibility of legacy HP systems with this new
           solution, and how to handle issues surrounding future
           maintenance for these legacy systems, will be decided by
           the LAMPS WG. ]]<a href="#section-3.1.2-3" class="pilcrow">¶</a></p>
<div id="uc-ia-bc-receiving-side-mime-conformant">
<section id="section-3.1.2.1">
            <h5 id="name-receiving-side-mime-conform">
<a href="#section-3.1.2.1" class="section-number selfRef">3.1.2.1. </a><a href="#name-receiving-side-mime-conform" class="section-name selfRef">Receiving Side MIME-Conformant</a>
            </h5>
<p id="section-3.1.2.1-1">The sending side (fully) supports Header Protection as specified in
this document, while the receiving side does not support this
specification. However, the receiving side is MIME-conformant
according to <span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span>,
ff. (cf. <a href="#uc-ia-backward-compatibility-use-cases" class="xref">Section 3.1.2</a>).<a href="#section-3.1.2.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1.2.1-2">This use case is specified in <a href="#receiving-side-mime-conformant" class="xref">Section 4.2.1</a>.<a href="#section-3.1.2.1-2" class="pilcrow">¶</a></p>
<p id="section-3.1.2.1-3">Note: This case should perform as expected if the sending side applies
      this specification as outlined in <a href="#main-use-case" class="xref">Section 4.1</a>.<a href="#section-3.1.2.1-3" class="pilcrow">¶</a></p>
<p id="section-3.1.2.1-4">[[ TODO: Verify once solution is stable and update last sentence. ]]<a href="#section-3.1.2.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="uc-ia-bc-receiving-side-not-mime-conformant">
<section id="section-3.1.2.2">
            <h5 id="name-receiving-side-not-mime-con">
<a href="#section-3.1.2.2" class="section-number selfRef">3.1.2.2. </a><a href="#name-receiving-side-not-mime-con" class="section-name selfRef">Receiving Side Not MIME-Conformant</a>
            </h5>
<p id="section-3.1.2.2-1">The sending side (fully) supports Header Protection as specified in
this document, while the receiving side does not support this
specification. Furthermore, the receiving side is <strong>not</strong>
MIME-conformant according to <span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span>, ff.
(cf. <a href="#uc-ia-backward-compatibility-use-cases" class="xref">Section 3.1.2</a>).<a href="#section-3.1.2.2-1" class="pilcrow">¶</a></p>
<p id="section-3.1.2.2-2">This use case is specified in <a href="#receiving-side-not-mime-conformant" class="xref">Section 4.2.2</a>.<a href="#section-3.1.2.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="protection-levels">
<section id="section-3.2">
        <h3 id="name-protection-levels">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-protection-levels" class="section-name selfRef">Protection Levels</a>
        </h3>
<div id="pl-in-scope">
<section id="section-3.2.1">
          <h4 id="name-in-scope">
<a href="#section-3.2.1" class="section-number selfRef">3.2.1. </a><a href="#name-in-scope" class="section-name selfRef">In-Scope</a>
          </h4>
<p id="section-3.2.1-1">The following Protection Levels are in scope for this document:<a href="#section-3.2.1-1" class="pilcrow">¶</a></p>
<p id="section-3.2.1-2">a)  Signature and encryption<a href="#section-3.2.1-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-3.2.1-3">
<pre>
Messages containing a cryptographic signature, which are also
encrypted.
</pre><a href="#section-3.2.1-3" class="pilcrow">¶</a>
</div>
<p id="section-3.2.1-4">b)  Signature only<a href="#section-3.2.1-4" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-3.2.1-5">
<pre>
Messages containing a cryptographic signature, but which are not
encrypted.
</pre><a href="#section-3.2.1-5" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="pl-out-of-scope">
<section id="section-3.2.2">
          <h4 id="name-out-of-scope">
<a href="#section-3.2.2" class="section-number selfRef">3.2.2. </a><a href="#name-out-of-scope" class="section-name selfRef">Out-of-Scope</a>
          </h4>
<p id="section-3.2.2-1">Legacy implementations, implementations not (fully) compliant with this document
or corner-cases may lead to further Protection Levels to appear on the receiving
side, such as (list not exhaustive):<a href="#section-3.2.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2.2-2.1">Triple wrap<a href="#section-3.2.2-2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-3.2.2-2.2">Encryption only<a href="#section-3.2.2-2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-3.2.2-2.3">Encryption before signature<a href="#section-3.2.2-2.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-3.2.2-2.4">
              <p id="section-3.2.2-2.4.1">Signature and encryption, but:<a href="#section-3.2.2-2.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2.2-2.4.2.1">Signature fails to validate<a href="#section-3.2.2-2.4.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-3.2.2-2.4.2.2">Signature validates but the signing certificate revoked<a href="#section-3.2.2-2.4.2.2" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-3.2.2-2.5">
              <p id="section-3.2.2-2.5.1">Signature only, but:<a href="#section-3.2.2-2.5.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2.2-2.5.2.1">with multiple valid signatures, layered atop each other<a href="#section-3.2.2-2.5.2.1" class="pilcrow">¶</a>
</li>
              </ul>
</li>
          </ul>
<p id="section-3.2.2-3">These Protection Levels, as well as any further Protection Levels not
listed in <a href="#pl-in-scope" class="xref">Section 3.2.1</a> are beyond the scope of this document.<a href="#section-3.2.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="specification">
<section id="section-4">
      <h2 id="name-specification">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-specification" class="section-name selfRef">Specification</a>
      </h2>
<p id="section-4-1">This section contains the specification for Header Protection in
S/MIME to update and clarify Section 3.1 of <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span> (S/MIME 4.0).<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">Note: It is likely that PGP/MIME <span>[<a href="#RFC3156" class="xref">RFC3156</a>]</span> will also incorporate
      this specification or parts of it.<a href="#section-4-2" class="pilcrow">¶</a></p>
<p id="section-4-3">This specification applies to the Protection Levels "signature &amp;
encryption" and "signature only" (cf. <a href="#protection-levels" class="xref">Section 3.2</a>):<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">Sending and receiving sides MUST implement the "signature and
encryption" Protection Level, which SHOULD be used as default on the
sending side.<a href="#section-4-4" class="pilcrow">¶</a></p>
<p id="section-4-5">Certain implementations may decide to send "signature only" Messages,
depending on the circumstances and customer requirements.  Sending
sides MAY and receiving sides MUST implement "signature only"
Protection Level.<a href="#section-4-5" class="pilcrow">¶</a></p>
<p id="section-4-6">It generally is NOT RECOMMENDED to send a Message with any other
Protection Level. On the other hand, the receiving side must be
prepared to receive Messages with other Protection Levels.<a href="#section-4-6" class="pilcrow">¶</a></p>
<p id="section-4-7">[[ TODO: Further study is necessary to determine whether - and if
           yes to what extent - additional guidance for handling
           messages with other Protection Levels, e.g. "encryption
           only" at the receiving side should be included in this
           document. ]]<a href="#section-4-7" class="pilcrow">¶</a></p>
<div id="main-use-case">
<section id="section-4.1">
        <h3 id="name-main-use-case-2">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-main-use-case-2" class="section-name selfRef">Main Use Case</a>
        </h3>
<p id="section-4.1-1">This section applies to the main use case, where the sending and
receiving side (fully) support Header Protection as specified
herein (cf. <a href="#uc-ia-main-use-case" class="xref">Section 3.1.1</a>).<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2">Note: The sending side specification of the main use case is also
      applicable to the cases where the sending side (fully) supports
      Header Protection as specified herein, while the receiving side
      does not, but is MIME-conformant according to <span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span>,
      ff. (cf. <a href="#uc-ia-backward-compatibility-use-cases" class="xref">Section 3.1.2</a> and
      <a href="#uc-ia-bc-receiving-side-mime-conformant" class="xref">Section 3.1.2.1</a>).<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1-3">Further backward compatibility cases are defined in
<a href="#backward-compatibility-use-cases" class="xref">Section 4.2</a>.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
<div id="mime-format">
<section id="section-4.1.1">
          <h4 id="name-mime-format">
<a href="#section-4.1.1" class="section-number selfRef">4.1.1. </a><a href="#name-mime-format" class="section-name selfRef">MIME Format</a>
          </h4>
<div id="mime-format-introduction">
<section id="section-4.1.1.1">
            <h5 id="name-introduction-2">
<a href="#section-4.1.1.1" class="section-number selfRef">4.1.1.1. </a><a href="#name-introduction-2" class="section-name selfRef">Introduction</a>
            </h5>
<p id="section-4.1.1.1-1">As per S/MIME version 3.1 and later (cf. <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>), the sending
client MAY wrap a full MIME message in a message/RFC822 wrapper in
order to apply S/MIME security services to these header fields.<a href="#section-4.1.1.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1.1.1-2">To help the receiving side to distinguish between a forwarded and a
wrapped message, the Content-Type header field parameter "forwarded"
is added as defined in <span>[<a href="#I-D.melnikov-iana-reg-forwarded" class="xref">I-D.melnikov-iana-reg-forwarded</a>]</span>.<a href="#section-4.1.1.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1.1.1-3">The simplified (cryptographic overhead not shown) MIME structure of
such an Email Message looks as follows:<a href="#section-4.1.1.1-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.1.1-4">
<pre>
  &lt;Outer Message Header Section (unprotected)&gt;

  &lt;Outer Message Body (protected)&gt;

    &lt;MIME Header Section (wrapper)&gt;

      &lt;Inner Message Header Section&gt;

      &lt;Inner Message Body&gt;

</pre><a href="#section-4.1.1.1-4" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1.1-5">The following example demonstrates how an Original Message might be
protected, i.e., the Original Message is contained as Inner Message in
the Protected Body of an Outer Message. It illustrates the first Body
part (of the Outer Message) as a "multipart/signed"
(application/pkcs7-signature) media type:<a href="#section-4.1.1.1-5" class="pilcrow">¶</a></p>
<p id="section-4.1.1.1-6">Lines are prepended as follows:<a href="#section-4.1.1.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.1.1-7.1">"O: " Outer Message Header Section<a href="#section-4.1.1.1-7.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.1.1-7.2">"I: " Message Header Section<a href="#section-4.1.1.1-7.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.1.1-7.3">"W: " Wrapper (MIME Header Section)<a href="#section-4.1.1.1-7.3" class="pilcrow">¶</a>
</li>
            </ul>
<div class="artwork art-text alignLeft" id="section-4.1.1.1-8">
<pre>
  O: Date: Mon, 25 Sep 2017 17:31:42 +0100 (GMT Daylight Time)
  O: Message-ID: &lt;e4a483cb-1dfb-481d-903b-298c92c21f5e@m.example.net&gt;
  O: Subject: Meeting at my place
  O: From: "Alexey Melnikov" &lt;alexey.melnikov@example.net&gt;
  O: To: somebody@example.net
  O: MIME-Version: 1.0
  O: Content-Type: multipart/signed; charset=us-ascii; micalg=sha1;
  O:  protocol="application/pkcs7-signature";
  O:  boundary=boundary-AM

     This is a multipart message in MIME format.
     --boundary-AM
  W: Content-Type: message/RFC822; forwarded=no
  W:
  I: Date: Mon, 25 Sep 2017 17:31:42 +0100 (GMT Daylight Time)
  I: From: "Alexey Melnikov" &lt;alexey.melnikov@example.net&gt;
  I: Message-ID: &lt;e4a483cb-1dfb-481d-903b-298c92c21f5e@m.example.net&gt;
  I: MIME-Version: 1.0
  I: MMHS-Primary-Precedence: 3
  I: Subject: Meeting at my place
  I: To: somebody@example.net
  I: X-Mailer: Isode Harrier Web Server
  I: Content-Type: text/plain; charset=us-ascii

     This is an important message that I don't want to be modified.

     --boundary-AM
     Content-Transfer-Encoding: base64
     Content-Type: application/pkcs7-signature

     [[base-64 encoded signature]]

     --boundary-AM--

</pre><a href="#section-4.1.1.1-8" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1.1-9">The Outer Message Header Section is unprotected, while the remainder
(Outer Message Body) is protected. The Outer Message Body consists of
the wrapper (MIME Header Section) and the Inner Message (Header
Section and Body).<a href="#section-4.1.1.1-9" class="pilcrow">¶</a></p>
<p id="section-4.1.1.1-10">The wrapper is a simple MIME Header Section with media type
"message/rfc822" containing a Content-Type header field parameter
"forwarded=no" followed by an empty line.<a href="#section-4.1.1.1-10" class="pilcrow">¶</a></p>
<p id="section-4.1.1.1-11">If the source is an Original (message/rfc822) Message, the Inner
Message Header Section is typically the same as (or a subset of) the
Original Message Header Section, and the Inner
Message Body is typically the same as the Original Message Body.<a href="#section-4.1.1.1-11" class="pilcrow">¶</a></p>
<p id="section-4.1.1.1-12">The Inner Message itself may contain any MIME structure.<a href="#section-4.1.1.1-12" class="pilcrow">¶</a></p>
<p id="section-4.1.1.1-13">Note: It is still to be decided by the LAMPS WG whether or not to
recommend an alternative MIME format as described in
<a href="#option-ex-memory-hole" class="xref">Appendix C.1.1.1</a> (instead of the currently standardized and
above defined format).<a href="#section-4.1.1.1-13" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="sending-side">
<section id="section-4.1.2">
          <h4 id="name-sending-side">
<a href="#section-4.1.2" class="section-number selfRef">4.1.2. </a><a href="#name-sending-side" class="section-name selfRef">Sending Side</a>
          </h4>
<p id="section-4.1.2-1">This section describes the process an MUA should use to apply cryptographic protection to an e-mail message with header protection.
We start by describing the legacy message composition process as a baseline.<a href="#section-4.1.2-1" class="pilcrow">¶</a></p>
<div id="compose-legacy">
<section id="section-4.1.2.1">
            <h5 id="name-composing-a-cryptographical">
<a href="#section-4.1.2.1" class="section-number selfRef">4.1.2.1. </a><a href="#name-composing-a-cryptographical" class="section-name selfRef">Composing a Cryptographically-Protected Message Without Header Protection</a>
            </h5>
<p id="section-4.1.2.1-1"><span>[<a href="#I-D.dkg-lamps-e2e-mail-guidance" class="xref">I-D.dkg-lamps-e2e-mail-guidance</a>]</span> describes the typical process for a legacy crypto MUA to apply cryptographic protections to an e-mail message.
That guidance and terminology is replicated here for reference:<a href="#section-4.1.2.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.1-2.1">
                <code>origbody</code>: the traditional unprotected message body as a well-formed MIME tree (possibly just a single MIME leaf part).
As a well-formed MIME tree, <code>origbody</code> already has structural headers (<code>Content-*</code>) present.<a href="#section-4.1.2.1-2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.2.1-2.2">
                <code>origheaders</code>: the intended non-structural headers for the message, represented here as a list of <code>(h,v)</code> pairs, where <code>h</code> is a header field name and <code>v</code> is the associated value.
Note that these are header fields that the MUA intends to be visible to the recipient of the message.
In particular, if the MUA uses the <code>Bcc</code> header during composition, but plans to omit it from the message (see section 3.6.3 of <span>[<a href="#RFC5322" class="xref">RFC5322</a>]</span>), it will not be in <code>origheaders</code>.<a href="#section-4.1.2.1-2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.2.1-2.3">
                <code>crypto</code>: The series of cryptographic protections to apply (for example, "sign with the secret key corresponding to X.509 certificate X, then encrypt to X.509 certificates X and Y").
This is a routine that accepts a MIME tree as input (the Cryptographic Payload), wraps the input in the appropriate Cryptographic Envelope, and returns the resultant MIME tree as output.<a href="#section-4.1.2.1-2.3" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.1.2.1-3">The algorithm returns a MIME object that is ready to be injected into the mail system:<a href="#section-4.1.2.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.1-4.1">Apply <code>crypto</code> to <code>origbody</code>, yielding MIME tree <code>output</code><a href="#section-4.1.2.1-4.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.2.1-4.2">
                <p id="section-4.1.2.1-4.2.1">For each header name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-4.1.2.1-4.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.1-4.2.2.1">Add header <code>h</code> of <code>output</code> with value <code>v</code><a href="#section-4.1.2.1-4.2.2.1" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.1-4.3">Return <code>output</code><a href="#section-4.1.2.1-4.3" class="pilcrow">¶</a>
</li>
            </ul>
</section>
</div>
<div id="header-confidentiality-policy">
<section id="section-4.1.2.2">
            <h5 id="name-header-confidentiality-poli">
<a href="#section-4.1.2.2" class="section-number selfRef">4.1.2.2. </a><a href="#name-header-confidentiality-poli" class="section-name selfRef">Header Confidentiality Policy</a>
            </h5>
<p id="section-4.1.2.2-1">When composing an encrypted message with protected headers, the composing MUA needs a Header Confidentialiy Policy.
In this document, we represent that Header Confidentiality Policy as a function <code>hcp</code>:<a href="#section-4.1.2.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.2-2.1">
                <code>hcp(name, val_in) --&gt; val_out</code>: this function takes a header field name <code>name</code> and initial value <code>val_in</code> as arguments, and returns a replacement header value <code>val_out</code>.
If <code>val_out</code> is the special value <code>null</code>, it mean that the header in question should be omitted from the set of headers visible outside the Cryptographic Envelope.<a href="#section-4.1.2.2-2.1" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.1.2.2-3">For example, an MUA that only obscures the <code>Subject</code> header field by replacing it with the literal string <code>[...]</code> and does not offer confidentiality to any other header fields would be represented as (in pseudocode):<a href="#section-4.1.2.2-3" class="pilcrow">¶</a></p>
<p id="section-4.1.2.2-4"><code>
hcp(name, val_in) --&gt; val_out:
    if name is 'Subject':
        return '[...]'
    else:
        return val_in
</code><a href="#section-4.1.2.2-4" class="pilcrow">¶</a></p>
<p id="section-4.1.2.2-5">Note that such a policy is only needed when the end-to-end protections include encryption (confidentiality).
No comparable policy is needed for other end-to-end cryptographic protections (integrity and authenticity), as they are simply uniformly applied so that all header fields known by the sender have these protections.<a href="#section-4.1.2.2-5" class="pilcrow">¶</a></p>
<p id="section-4.1.2.2-6">This asymmetry is an unfortunate consequence of complexities in message delivery systems, some of which may reject, drop, or delay messages where all headers are removed from the top-level MIME object.<a href="#section-4.1.2.2-6" class="pilcrow">¶</a></p>
<p id="section-4.1.2.2-7">This document does not mandate any particular Header Confidentiality Policy, though it offers guidance for MUA implementers in selecting one in <a href="#default-hcp" class="xref">Section 4.1.3</a>.
Future documents may recommend or mandate such a policy for an MUA with specific needs.
Such a recommendation might be motivated by descriptions of metadata-derived attacks, or stem from research about message deliverability, or describe new signalling mechanisms, but these topics are out of scope for this document.<a href="#section-4.1.2.2-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="compose-wrapped-message">
<section id="section-4.1.2.3">
            <h5 id="name-composing-with-wrapped-mess">
<a href="#section-4.1.2.3" class="section-number selfRef">4.1.2.3. </a><a href="#name-composing-with-wrapped-mess" class="section-name selfRef">Composing with "Wrapped Message" Header Protection</a>
            </h5>
<p id="section-4.1.2.3-1">To compose a message using "Wrapped Message" header protection, we use those inputs described in <a href="#compose-legacy" class="xref">Section 4.1.2.1</a> plus the Header Confidentiality Policy <code>hcp</code> defined in <a href="#header-confidentiality-policy" class="xref">Section 4.1.2.2</a>.
The new algorithm is:<a href="#section-4.1.2.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.3-2.1">
                <p id="section-4.1.2.3-2.1.1">For header name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-4.1.2.3-2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.3-2.1.2.1">Add header <code>h</code> of <code>origbody</code> with value <code>v</code><a href="#section-4.1.2.3-2.1.2.1" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.3-2.2">
                <p id="section-4.1.2.3-2.2.1">If any of the header fields in <code>origbody</code>, including headers in the nested internal MIME structure, contain any 8-bit UTF-8 characters (see section section 3.7 of <span>[<a href="#RFC6532" class="xref">RFC6532</a>]</span>):<a href="#section-4.1.2.3-2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.3-2.2.2.1">Let <code>payload</code> be a new MIME part with one header: <code>Content-Type: message/global; forwarded=no</code>, and whose body is <code>origbody</code>.<a href="#section-4.1.2.3-2.2.2.1" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.3-2.3">
                <p id="section-4.1.2.3-2.3.1">Else:<a href="#section-4.1.2.3-2.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.3-2.3.2.1">Let <code>payload</code> be a new MIME part with one header: <code>Content-Type: message/rfc822; forwarded=no</code>, and whose body is <code>origbody</code>.<a href="#section-4.1.2.3-2.3.2.1" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.3-2.4">Apply <code>crypto</code> to <code>payload</code>, yielding MIME tree <code>output</code><a href="#section-4.1.2.3-2.4" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.2.3-2.5">
                <p id="section-4.1.2.3-2.5.1">If <code>crypto</code> contains encryption:<a href="#section-4.1.2.3-2.5.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.3-2.5.2.1">Create new empty list of header field names and values <code>newh</code><a href="#section-4.1.2.3-2.5.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.2.3-2.5.2.2">
                    <p id="section-4.1.2.3-2.5.2.2.1">For header name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-4.1.2.3-2.5.2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.3-2.5.2.2.2.1">Let <code>newval</code> be <code>hcp(h, v)</code><a href="#section-4.1.2.3-2.5.2.2.2.1" class="pilcrow">¶</a>
</li>
                      <li class="normal" id="section-4.1.2.3-2.5.2.2.2.2">
                        <p id="section-4.1.2.3-2.5.2.2.2.2.1">If <code>newval</code> is not <code>null</code>:<a href="#section-4.1.2.3-2.5.2.2.2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.3-2.5.2.2.2.2.2.1">Append <code>(h,newval)</code> to <code>newh</code><a href="#section-4.1.2.3-2.5.2.2.2.2.2.1" class="pilcrow">¶</a>
</li>
                        </ul>
</li>
                    </ul>
</li>
                  <li class="normal" id="section-4.1.2.3-2.5.2.3">Set <code>origheaders</code> to <code>newh</code><a href="#section-4.1.2.3-2.5.2.3" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.3-2.6">
                <p id="section-4.1.2.3-2.6.1">For header name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-4.1.2.3-2.6.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.3-2.6.2.1">Add header <code>h</code> of <code>output</code>  with value <code>v</code><a href="#section-4.1.2.3-2.6.2.1" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.3-2.7">Return <code>output</code><a href="#section-4.1.2.3-2.7" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.1.2.3-3">Note that the Header Confidentiality Policy <code>hcp</code> is ignored if <code>crypto</code> does not contain encryption.
This is by design.<a href="#section-4.1.2.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="compose-injected-headers">
<section id="section-4.1.2.4">
            <h5 id="name-composing-with-injected-hea">
<a href="#section-4.1.2.4" class="section-number selfRef">4.1.2.4. </a><a href="#name-composing-with-injected-hea" class="section-name selfRef">Composing with "Injected Headers" Header Protection</a>
            </h5>
<p id="section-4.1.2.4-1">To compose a message using "Injected Headers" header protection, the composing MUA needs one additional input in addition to the Header Confidentiality Policy <code>hcp</code> defined in <a href="#header-confidentiality-policy" class="xref">Section 4.1.2.2</a>.<a href="#section-4.1.2.4-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-2.1">
                <code>legacy</code>: a boolean value, indicating whether any recipient of the message is believed to have a legacy client.
If all recipients are known to implement this draft, <code>legacy</code> should be set to <code>false</code>.
(How a MUA determines the value of <code>legacy</code> is out of scope for this document; an initial implementation can simply set it to <code>true</code>)<a href="#section-4.1.2.4-2.1" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.1.2.4-3">The revised algorithm for applying cryptographic protection to a message is as follows:<a href="#section-4.1.2.4-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.1">Create a new MIME leaf part <code>legacydisplay</code> with header <code>Content-Type: text/plain; protected-headers="v1"</code> and an empty body.<a href="#section-4.1.2.4-4.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.2.4-4.2">
                <p id="section-4.1.2.4-4.2.1">if <code>crypto</code> contains encryption, and <code>legacy</code> is <code>true</code>:<a href="#section-4.1.2.4-4.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.2.2.1">
                    <p id="section-4.1.2.4-4.2.2.1.1">For each header name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-4.1.2.4-4.2.2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.2.2.1.2.1">
                        <p id="section-4.1.2.4-4.2.2.1.2.1.1">If <code>h</code> is user-facing (see <span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span>):<a href="#section-4.1.2.4-4.2.2.1.2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.2.2.1.2.1.2.1">
                            <p id="section-4.1.2.4-4.2.2.1.2.1.2.1.1">If <code>hcp(h,v)</code> is not <code>v</code>:<a href="#section-4.1.2.4-4.2.2.1.2.1.2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.2.2.1.2.1.2.1.2.1">Add <code>h: v</code> to the body of <code>legacydisplay</code>.  For example, if <code>h</code> is <code>Subject</code>, and <code>v</code> is <code>lunch plans?</code>, then add the line <code>Subject: lunch plans?</code> to the body of <code>legacydisplay</code><a href="#section-4.1.2.4-4.2.2.1.2.1.2.1.2.1" class="pilcrow">¶</a>
</li>
                            </ul>
</li>
                        </ul>
</li>
                    </ul>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.4-4.3">
                <p id="section-4.1.2.4-4.3.1">If the body of <code>legacydisplay</code> is empty:<a href="#section-4.1.2.4-4.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.3.2.1">Let <code>payload</code> be MIME part <code>origbody</code>, discarding <code>legacydisplay</code><a href="#section-4.1.2.4-4.3.2.1" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.4-4.4">
                <p id="section-4.1.2.4-4.4.1">Else: (body of <code>legacydisplay</code> is not empty)<a href="#section-4.1.2.4-4.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.4.2.1">Construct a new MIME part <code>wrapper</code> with <code>Content-Type: multipart/mixed</code><a href="#section-4.1.2.4-4.4.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.2.4-4.4.2.2">Give <code>wrapper</code> exactly two subparts: <code>legacydisplay</code> and <code>origbody</code>, in that order.<a href="#section-4.1.2.4-4.4.2.2" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.2.4-4.4.2.3">Let <code>payload</code> be MIME part <code>wrapper</code><a href="#section-4.1.2.4-4.4.2.3" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.4-4.5">
                <p id="section-4.1.2.4-4.5.1">For each header name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-4.1.2.4-4.5.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.5.2.1">Add header <code>h</code> of MIME part <code>payload</code> with value <code>v</code><a href="#section-4.1.2.4-4.5.2.1" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.4-4.6">Set the <code>protected-headers</code> parameter on the <code>Content-Type</code> of <code>payload</code> to <code>v1</code><a href="#section-4.1.2.4-4.6" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.2.4-4.7">Apply <code>crypto</code> to <code>payload</code>, producing MIME tree <code>output</code><a href="#section-4.1.2.4-4.7" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.2.4-4.8">
                <p id="section-4.1.2.4-4.8.1">If <code>crypto</code> contains encryption:<a href="#section-4.1.2.4-4.8.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.8.2.1">Create new empty list of header field names and values <code>newh</code><a href="#section-4.1.2.4-4.8.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.2.4-4.8.2.2">
                    <p id="section-4.1.2.4-4.8.2.2.1">For header name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-4.1.2.4-4.8.2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.8.2.2.2.1">Let <code>newval</code> be <code>hcp(h, v)</code><a href="#section-4.1.2.4-4.8.2.2.2.1" class="pilcrow">¶</a>
</li>
                      <li class="normal" id="section-4.1.2.4-4.8.2.2.2.2">
                        <p id="section-4.1.2.4-4.8.2.2.2.2.1">If <code>newval</code> is not <code>null</code>:<a href="#section-4.1.2.4-4.8.2.2.2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.8.2.2.2.2.2.1">Add <code>newh[h]</code> to <code>newval</code><a href="#section-4.1.2.4-4.8.2.2.2.2.2.1" class="pilcrow">¶</a>
</li>
                        </ul>
</li>
                    </ul>
</li>
                  <li class="normal" id="section-4.1.2.4-4.8.2.3">Set <code>origheaders</code> to <code>newh</code><a href="#section-4.1.2.4-4.8.2.3" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.4-4.9">
                <p id="section-4.1.2.4-4.9.1">For each header name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-4.1.2.4-4.9.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.4-4.9.2.1">Add header <code>h</code> of <code>output</code> with value <code>v</code><a href="#section-4.1.2.4-4.9.2.1" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.1.2.4-4.10">Return <code>output</code><a href="#section-4.1.2.4-4.10" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.1.2.4-5">Note that both new parameters (<code>hcp</code> and <code>legacy</code>) are effectively ignored if <code>crypto</code> does not contain encryption.
This is by design, because they are irrelevant for signed-only cryptographic protections.<a href="#section-4.1.2.4-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="choosing-between-wrapped-message-and-injected-headers">
<section id="section-4.1.2.5">
            <h5 id="name-choosing-between-wrapped-me">
<a href="#section-4.1.2.5" class="section-number selfRef">4.1.2.5. </a><a href="#name-choosing-between-wrapped-me" class="section-name selfRef">Choosing Between Wrapped Message and Injected Headers</a>
            </h5>
<p id="section-4.1.2.5-1">When composing a message with end-to-end cryptographic protections, an MUA SHOULD protect the headers of that message as well as the body.<a href="#section-4.1.2.5-1" class="pilcrow">¶</a></p>
<p id="section-4.1.2.5-2">An MUA MAY protect the headers of any outbound message using either the "Wrapped Message" or the "Injected Headers" style of protection.
See <a href="#backward-compatibility-use-cases" class="xref">Section 4.2</a> for more discussion about reasons to choose one mechanism or another.<a href="#section-4.1.2.5-2" class="pilcrow">¶</a></p>
<p id="section-4.1.2.5-3">[[ TODO: this document should recommend generation of one particular scheme by default for new implementers ]]<a href="#section-4.1.2.5-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="default-hcp">
<section id="section-4.1.3">
          <h4 id="name-default-header-confidential">
<a href="#section-4.1.3" class="section-number selfRef">4.1.3. </a><a href="#name-default-header-confidential" class="section-name selfRef">Default Header Confidentiality Policy</a>
          </h4>
<p id="section-4.1.3-1">An MUA SHOULD have a sensible default Header Confidentiality Policy, and SHOULD NOT require the user to select one.<a href="#section-4.1.3-1" class="pilcrow">¶</a></p>
<p id="section-4.1.3-2">The default Header Confidentiality Policy SHOULD provide confidentiality for the <code>Subject</code> header field by replacing it with the literal string <code>[...]</code>.
Most users treat the Subject of a message the same way that they treat the body, and they are surprised to find that the Subject of an encrypted message is visible.<a href="#section-4.1.3-2" class="pilcrow">¶</a></p>
<p id="section-4.1.3-3">[[ TODO: select one of the two policies below the recommended default ]]<a href="#section-4.1.3-3" class="pilcrow">¶</a></p>
<div id="minimal-hcp">
<section id="section-4.1.3.1">
            <h5 id="name-minimalist-header-confident">
<a href="#section-4.1.3.1" class="section-number selfRef">4.1.3.1. </a><a href="#name-minimalist-header-confident" class="section-name selfRef">Minimalist Header Confidentiality Policy</a>
            </h5>
<p id="section-4.1.3.1-1">Accordingly, the most conservative recommended Header Confidentiality Policy only protects the <code>Subject</code>:<a href="#section-4.1.3.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1.3.1-2"><code>
hcp_minimal(name, val_in) --&gt; val_out:
    if name is 'Subject':
        return '[...]'
    else:
        return val_in
</code><a href="#section-4.1.3.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="strong-hcp">
<section id="section-4.1.3.2">
            <h5 id="name-strong-header-confidentiali">
<a href="#section-4.1.3.2" class="section-number selfRef">4.1.3.2. </a><a href="#name-strong-header-confidentiali" class="section-name selfRef">Strong Header Confidentiality Policy</a>
            </h5>
<p id="section-4.1.3.2-1">Alternately, a more aggressive (and therefore more privacy-preserving) Header Confidentiality Policy only leaks a handful of fields whose absence is known to increase rates of delivery failure, and simultaneously obscures the <code>Message-ID</code> behind a random new one:<a href="#section-4.1.3.2-1" class="pilcrow">¶</a></p>
<p id="section-4.1.3.2-2"><code>
hcp_strong(name, val_in) --&gt; val_out:
    if name in ['From', 'To', 'Cc', 'Date']:
        return val_in
    else if name is 'Subject':
        return '[...]'
    else if name is 'Message-ID':
        return generate_new_message_id()
    else:
        return null
</code><a href="#section-4.1.3.2-2" class="pilcrow">¶</a></p>
<p id="section-4.1.3.2-3">The function <code>generate_new_message_id()</code> represents whatever process the MUA typically uses to generate a <code>Message-ID</code> for a new outbound message.<a href="#section-4.1.3.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="offering-stronger-header-confidentiality">
<section id="section-4.1.3.3">
            <h5 id="name-offering-stronger-header-co">
<a href="#section-4.1.3.3" class="section-number selfRef">4.1.3.3. </a><a href="#name-offering-stronger-header-co" class="section-name selfRef">Offering Stronger Header Confidentiality</a>
            </h5>
<p id="section-4.1.3.3-1">A MUA MAY offer even stronger confidentiality for headers of an encrypted message than described in <a href="#strong-hcp" class="xref">Section 4.1.3.2</a>.
For example, it might implement an HCP that obfuscates the <code>From</code> field, or omits the <code>Cc</code> field, or ensures <code>Date</code> is represented in <code>UTC</code> (obscuring the local timezone).<a href="#section-4.1.3.3-1" class="pilcrow">¶</a></p>
<p id="section-4.1.3.3-2">The authors of this document hope that implementers with deployment experience will document their chosen Header Confidentiality Policy and the rationale behind their choice.<a href="#section-4.1.3.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="receiving-side">
<section id="section-4.1.4">
          <h4 id="name-receiving-side">
<a href="#section-4.1.4" class="section-number selfRef">4.1.4. </a><a href="#name-receiving-side" class="section-name selfRef">Receiving Side</a>
          </h4>
<p id="section-4.1.4-1">An MUA that receives a cryptographically-protected e-mail will render it for the user.<a href="#section-4.1.4-1" class="pilcrow">¶</a></p>
<p id="section-4.1.4-2">The receiving MUA will render the message body, a selected subset of header fields, and (as described in <span>[<a href="#I-D.dkg-lamps-e2e-mail-guidance" class="xref">I-D.dkg-lamps-e2e-mail-guidance</a>]</span>) provide a summary of the cryptographic properties of the message.<a href="#section-4.1.4-2" class="pilcrow">¶</a></p>
<p id="section-4.1.4-3">Most MUAs only render a subset of header fields by default.
For example, few MUAs typically render <code>Message-Id</code> or <code>Received</code> header fields for the user, but most do render <code>From</code>, <code>To</code>, <code>Cc</code>, <code>Date</code>, and <code>Subject</code>.<a href="#section-4.1.4-3" class="pilcrow">¶</a></p>
<p id="section-4.1.4-4">A MUA that knows how to handle a message with protected headers makes the following two changes to its behavior when rendering a message:<a href="#section-4.1.4-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.4-5.1">If it detects that an incoming message had protected headers, it renders header fields for the message from the protected headers, ignoring the external (unprotected) headers.<a href="#section-4.1.4-5.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.1.4-5.2">It includes information in the message's cryptographic summary to indicate the types of protection that applied to each rendered header field (if any).<a href="#section-4.1.4-5.2" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-4.1.4-6">A MUA that handles protected headers does <em>not</em> need to render any new header fields that it did not render before.<a href="#section-4.1.4-6" class="pilcrow">¶</a></p>
<div id="identifying-that-a-message-has-protected-headers">
<section id="section-4.1.4.1">
            <h5 id="name-identifying-that-a-message-">
<a href="#section-4.1.4.1" class="section-number selfRef">4.1.4.1. </a><a href="#name-identifying-that-a-message-" class="section-name selfRef">Identifying that a Message has Protected Headers</a>
            </h5>
<p id="section-4.1.4.1-1">An incoming message can be identified as having protected headers based on one of two signals:<a href="#section-4.1.4.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.4.1-2.1">The Cryptographic Payload has <code>Content-Type: message/rfc822</code> or <code>Content-Type: message/global</code> and the parameter <code>forwarded</code> has a value of <code>no</code>.
See <a href="#rendering-wrapped-message" class="xref">Section 4.1.4.3</a> for rendering guidance.<a href="#section-4.1.4.1-2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.4.1-2.2">The Cryptographic Payload has some other <code>Content-Type</code> and it has parameter <code>protected-headers</code> set to <code>v1</code>.
See <a href="#rendering-injected-headers" class="xref">Section 4.1.4.4</a> for rendering guidance.<a href="#section-4.1.4.1-2.2" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.1.4.1-3">Messages of both types exist in the wild, and a sensible MUA should be able to handle them both.
They provide the same semantics and the same meaning.<a href="#section-4.1.4.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="updating-the-cryptographic-summary">
<section id="section-4.1.4.2">
            <h5 id="name-updating-the-cryptographic-">
<a href="#section-4.1.4.2" class="section-number selfRef">4.1.4.2. </a><a href="#name-updating-the-cryptographic-" class="section-name selfRef">Updating the Cryptographic Summary</a>
            </h5>
<p id="section-4.1.4.2-1">Regardless of whether a cryptographically-protected message has protected headers, the cryptographic summary of the message should be modified to indicate what protections the headers have.<a href="#section-4.1.4.2-1" class="pilcrow">¶</a></p>
<p id="section-4.1.4.2-2">Each header individually has exactly one the following protections:<a href="#section-4.1.4.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.4.2-3.1">
                <code>unprotected</code> (this is the case for all headers in messages that have no protected headers)<a href="#section-4.1.4.2-3.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.4.2-3.2">
                <code>signed-only</code> (bound into the same validated signature as the enclosing message, but also visible in transit)<a href="#section-4.1.4.2-3.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.4.2-3.3">
                <code>encrypted-only</code> (only appears within the cryptographic payload; the corresponding external header was either omitted or obfuscated)<a href="#section-4.1.4.2-3.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.4.2-3.4">
                <code>encrypted-and-signed</code> (same as encrypted, but additionally is under a validatd signature)<a href="#section-4.1.4.2-3.4" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.1.4.2-4">Note that while the message itself may be <code>encrypted-and-signed</code>, some headers may be replicated on the outside of the message (e.g. <code>Date</code>)
Those headers would be <code>signed-only</code>, despite the message itself being <code>encrypted-and-signed</code>.<a href="#section-4.1.4.2-4" class="pilcrow">¶</a></p>
<p id="section-4.1.4.2-5">Rendering this information is likely to be complex and messy --- users may not understand it.
It is beyond the scope of this document to suggest any specific graphical affordances or user experience.
Future work should include examples of successful rendering of this information.<a href="#section-4.1.4.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="rendering-wrapped-message">
<section id="section-4.1.4.3">
            <h5 id="name-rendering-a-wrapped-message">
<a href="#section-4.1.4.3" class="section-number selfRef">4.1.4.3. </a><a href="#name-rendering-a-wrapped-message" class="section-name selfRef">Rendering a Wrapped Message</a>
            </h5>
<p id="section-4.1.4.3-1">When the Cryptographic Payload has <code>Content-Type</code> of <code>message/rfc822</code> or <code>message/global</code>, and the parameter <code>forwarded</code> is set to <code>no</code>, the values of the protected headers are drawn from the headers of the Cryptographic Payload, and the body that is rendered is the body of the Cryptographic Payload.<a href="#section-4.1.4.3-1" class="pilcrow">¶</a></p>
<div id="example-signed-only-wrapped-message">
<section id="section-4.1.4.3.1">
              <h6 id="name-example-signed-only-wrapped">
<a href="#section-4.1.4.3.1" class="section-number selfRef">4.1.4.3.1. </a><a href="#name-example-signed-only-wrapped" class="section-name selfRef">Example Signed-Only Wrapped Message</a>
              </h6>
<p id="section-4.1.4.3.1-1">Consider a message with this structure, where the MUA is able to validate the cryptographic signature:<a href="#section-4.1.4.3.1-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.3.1-2">
<pre>
A └─╴application/pkcs7-mime; smime-type="signed-data"
   ⇩ (unwraps to)
B  └┬╴message/rfc822 [Cryptographic Payload]
C   └┬╴multipart/alternative [Rendered Body]
D    ├─╴text/plain
E    └─╴text/html
</pre><a href="#section-4.1.4.3.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.3.1-3">The message body should be rendered the same way as this message:<a href="#section-4.1.4.3.1-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.3.1-4">
<pre>
C └┬╴multipart/alternative
D  ├─╴text/plain
E  └─╴text/html
</pre><a href="#section-4.1.4.3.1-4" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.3.1-5">It should render header fields taken from part <code>C</code>.<a href="#section-4.1.4.3.1-5" class="pilcrow">¶</a></p>
<p id="section-4.1.4.3.1-6">Its cryptographic summary should indicates that the message was signed and all rendered header fields were included in the signature.<a href="#section-4.1.4.3.1-6" class="pilcrow">¶</a></p>
<p id="section-4.1.4.3.1-7">The MUA SHOULD ignore header fields from part <code>A</code> for the purposes of rendering.<a href="#section-4.1.4.3.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="example-signed-and-encrypted-wrapped">
<section id="section-4.1.4.3.2">
              <h6 id="name-example-encrypted-and-signe">
<a href="#section-4.1.4.3.2" class="section-number selfRef">4.1.4.3.2. </a><a href="#name-example-encrypted-and-signe" class="section-name selfRef">Example Encrypted-and-Signed Wrapped Message</a>
              </h6>
<p id="section-4.1.4.3.2-1">Consider a message with this structure, where the MUA is able to validate the cryptographic signature:<a href="#section-4.1.4.3.2-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.3.2-2">
<pre>
F └─╴application/pkcs7-mime; smime-type="enveloped-data"
   ↧ (decrypts to)
G  └─╴application/pkcs7-mime; smime-type="signed-data"
    ⇩ (unwraps to)
H   └┬╴message/rfc822 [Cryptographic Payload]
I    └┬╴multipart/alternative [Rendered Body]
J     ├─╴text/plain
K     └─╴text/html
</pre><a href="#section-4.1.4.3.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.3.2-3">The message body should be rendered the same way as this message:<a href="#section-4.1.4.3.2-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.3.2-4">
<pre>
I └┬╴multipart/alternative
J  ├─╴text/plain
K  └─╴text/html
</pre><a href="#section-4.1.4.3.2-4" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.3.2-5">It should render headers taken from part <code>I</code>.<a href="#section-4.1.4.3.2-5" class="pilcrow">¶</a></p>
<p id="section-4.1.4.3.2-6">Its cryptographic summary should indicates that the message was signed and encrypted.
Each rendered header field found in <code>I</code> should be compared against the header field of the same name from <code>F</code>.
If the value found in <code>F</code> matches the value found in <code>I</code>, the header field should be marked as <code>signed-only</code>.
If no matching header field was found in <code>F</code>, or the value found did not match the value from <code>I</code>, the header field should be marked as <code>signed-and-encrypted</code>.<a href="#section-4.1.4.3.2-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="rendering-injected-headers">
<section id="section-4.1.4.4">
            <h5 id="name-rendering-a-message-with-in">
<a href="#section-4.1.4.4" class="section-number selfRef">4.1.4.4. </a><a href="#name-rendering-a-message-with-in" class="section-name selfRef">Rendering a Message with Injected Headers</a>
            </h5>
<p id="section-4.1.4.4-1">When the Cryptographic Payload does not have a <code>Content-Type</code> of <code>message/rfc822</code> or <code>message/global</code>, and the parameter <code>protected-headers</code> is set to <code>v1</code>, the values of the protected headers are drawn from the headers of the Cryptographic Payload, and the body that is rendered is the Cryptographic Payload itself.<a href="#section-4.1.4.4-1" class="pilcrow">¶</a></p>
<div id="example-signed-only-message-with-injected-headers">
<section id="section-4.1.4.4.1">
              <h6 id="name-example-signed-only-message">
<a href="#section-4.1.4.4.1" class="section-number selfRef">4.1.4.4.1. </a><a href="#name-example-signed-only-message" class="section-name selfRef">Example Signed-only Message with Injected Headers</a>
              </h6>
<div class="artwork art-text alignLeft" id="section-4.1.4.4.1-1">
<pre>
L └─╴application/pkcs7-mime; smime-type="signed-data"
   ⇩ (unwraps to)
M  └┬╴multipart/alternative [Cryptographic Payload + Rendered Body]
N   ├─╴text/plain
O   └─╴text/html
</pre><a href="#section-4.1.4.4.1-1" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.4.1-2">The message body should be rendered the same way as this message:<a href="#section-4.1.4.4.1-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.4.1-3">
<pre>
M └┬╴multipart/alternative
N  ├─╴text/plain
O  └─╴text/html
</pre><a href="#section-4.1.4.4.1-3" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.4.1-4">It should render header fieldss taken from part <code>M</code>.<a href="#section-4.1.4.4.1-4" class="pilcrow">¶</a></p>
<p id="section-4.1.4.4.1-5">Its cryptographic summary should indicates that the message was signed and all rendered header fields were included in the signature.<a href="#section-4.1.4.4.1-5" class="pilcrow">¶</a></p>
<p id="section-4.1.4.4.1-6">The MUA SHOULD ignore header fields from part <code>L</code> for the purposes of rendering.<a href="#section-4.1.4.4.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="example-signed-and-encrypted-injected">
<section id="section-4.1.4.4.2">
              <h6 id="name-example-signed-and-encrypte">
<a href="#section-4.1.4.4.2" class="section-number selfRef">4.1.4.4.2. </a><a href="#name-example-signed-and-encrypte" class="section-name selfRef">Example Signed-and-Encrypted Message with Injected Headers</a>
              </h6>
<p id="section-4.1.4.4.2-1">Consider a message with this structure, where the MUA is able to validate the cryptographic signature:<a href="#section-4.1.4.4.2-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.4.2-2">
<pre>
P └─╴application/pkcs7-mime; smime-type="enveloped-data"
   ↧ (decrypts to)
Q  └─╴application/pkcs7-mime; smime-type="signed-data"
    ⇩ (unwraps to)
R   └┬╴multipart/alternative [Cryptographic Payload + Rendered Body]
S    ├─╴text/plain
T    └─╴text/html
</pre><a href="#section-4.1.4.4.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.4.2-3">The message body should be rendered the same way as this message:<a href="#section-4.1.4.4.2-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.4.2-4">
<pre>
R └┬╴multipart/alternative
S  ├─╴text/plain
T  └─╴text/html
</pre><a href="#section-4.1.4.4.2-4" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.4.2-5">It should render headers taken from part <code>R</code>.<a href="#section-4.1.4.4.2-5" class="pilcrow">¶</a></p>
<p id="section-4.1.4.4.2-6">Its cryptographic summary should indicates that the message was signed and encrypted.
As in <a href="#example-signed-and-encrypted-wrapped" class="xref">Section 4.1.4.3.2</a>, each rendered header field found in <code>R</code> should be compared against the header field of the same name from <code>P</code>.
If the value found in <code>P</code> matches the value found in <code>R</code>, the header field should be marked as <code>signed-only</code>.
If no matching header field was found in <code>P</code>, or the value found did not match the value from <code>R</code>, the header field should be marked as <code>signed-and-encrypted</code>.<a href="#section-4.1.4.4.2-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="do-not-render-legacy-display-part">
<section id="section-4.1.4.4.3">
              <h6 id="name-do-not-render-legacy-displa">
<a href="#section-4.1.4.4.3" class="section-number selfRef">4.1.4.4.3. </a><a href="#name-do-not-render-legacy-displa" class="section-name selfRef">Do Not Render Legacy Display Part</a>
              </h6>
<p id="section-4.1.4.4.3-1">As described <span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span>, a message with cryptographic confidentiality protection  MAY include a "Legacy Display" part for backward-compatibility with legacy MUAs<a href="#section-4.1.4.4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.1.4.4.3-2">The receiving MUA SHOULD avoid rendering the Legacy Display part to the user at all, since it is aware of and can render the actual Protected Headers.<a href="#section-4.1.4.4.3-2" class="pilcrow">¶</a></p>
<p id="section-4.1.4.4.3-3">If a Legacy Display part is detected, it and its enclosing <code>multipart/mixed</code> wrapper should be discarded before rendering.<a href="#section-4.1.4.4.3-3" class="pilcrow">¶</a></p>
<div id="legacy-display-detection-algorithm">
<section id="section-4.1.4.4.3.1">
                <h6 id="name-legacy-display-detection-al">
<a href="#section-4.1.4.4.3.1" class="section-number selfRef">4.1.4.4.3.1. </a><a href="#name-legacy-display-detection-al" class="section-name selfRef">Legacy Display Detection Algorithm</a>
                </h6>
<p id="section-4.1.4.4.3.1-1">A receiving MUA acting on a message SHOULD detect the presence of a Legacy Display part and the corresponding "original body" with the following simple algorithm:<a href="#section-4.1.4.4.3.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.4.4.3.1-2.1">Check that all of the following are true for the message:<a href="#section-4.1.4.4.3.1-2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.4.4.3.1-2.2">The Cryptographic Envelope must contain an encrypting Cryptographic Layer<a href="#section-4.1.4.4.3.1-2.2" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.4.4.3.1-2.3">The Cryptographic Payload must have a <code>Content-Type</code> of <code>multipart/mixed</code><a href="#section-4.1.4.4.3.1-2.3" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.4.4.3.1-2.4">The Cryptographic Payload must have exactly two subparts<a href="#section-4.1.4.4.3.1-2.4" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.4.4.3.1-2.5">The first subpart of the Cryptographic Payload must have a <code>Content-Type</code> of <code>text/plain</code> or <code>text/rfc822-headers</code><a href="#section-4.1.4.4.3.1-2.5" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.4.4.3.1-2.6">The first subpart of the Cryptographic Payload's <code>Content-Type</code> must contain a property of <code>protected-headers</code>, and its value must be <code>v1</code>.<a href="#section-4.1.4.4.3.1-2.6" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.1.4.4.3.1-2.7">If all of the above are true, then the first subpart is the Legacy Display part, and the second subpart is the "original body".  Otherwise, the message does not have a Legacy Display part.<a href="#section-4.1.4.4.3.1-2.7" class="pilcrow">¶</a>
</li>
                </ul>
</section>
</div>
<div id="legacy-display-example">
<section id="section-4.1.4.4.3.2">
                <h6 id="name-legacy-display-example">
<a href="#section-4.1.4.4.3.2" class="section-number selfRef">4.1.4.4.3.2. </a><a href="#name-legacy-display-example" class="section-name selfRef">Legacy Display Example</a>
                </h6>
<p id="section-4.1.4.4.3.2-1">Consider a message with this structure, where the MUA is able to validate the cryptographic signature:<a href="#section-4.1.4.4.3.2-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.4.3.2-2">
<pre>
U └─╴application/pkcs7-mime; smime-type="enveloped-data"
   ↧ (decrypts to)
V  └─╴application/pkcs7-mime; smime-type="signed-data"
    ⇩ (unwraps to)
W   └┬╴multipart/mixed [Cryptographic Payload]
X    ├─╴text/plain [Legacy Display]
Y    └┬╴multipart/alternative [Rendered Body]
Z     ├─╴text/plain
A'    └─╴text/html
</pre><a href="#section-4.1.4.4.3.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.4.3.2-3">The message body should be rendered the same way as this message, effectively hiding the Legacy Display part (<code>X</code>) and its wrapper:<a href="#section-4.1.4.4.3.2-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1.4.4.3.2-4">
<pre>
Y └┬╴multipart/alternative
Z  ├─╴text/plain
A' └─╴text/html
</pre><a href="#section-4.1.4.4.3.2-4" class="pilcrow">¶</a>
</div>
<p id="section-4.1.4.4.3.2-5">It should render headers taken from part <code>W</code>, following the same guidance as in <a href="#example-signed-and-encrypted-injected" class="xref">Section 4.1.4.4.2</a> and <a href="#example-signed-and-encrypted-wrapped" class="xref">Section 4.1.4.3.2</a> about the cryptographic status of each rendered header field.<a href="#section-4.1.4.4.3.2-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="debugging-and-troubleshooting">
<section id="section-4.1.4.5">
            <h5 id="name-affordances-for-debugging-a">
<a href="#section-4.1.4.5" class="section-number selfRef">4.1.4.5. </a><a href="#name-affordances-for-debugging-a" class="section-name selfRef">Affordances for Debugging and Troubleshooting</a>
            </h5>
<p id="section-4.1.4.5-1">Note that advanced users of an MUA may need access to the original message, for example to troubleshoot problems with the MUA itself, or problems with the SMTP transport path taken by the message.<a href="#section-4.1.4.5-1" class="pilcrow">¶</a></p>
<p id="section-4.1.4.5-2">A MUA that applies these rendering guidelines SHOULD ensure that the full original source of the message as it was received remains available to such a user for debugging and troubleshooting.<a href="#section-4.1.4.5-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="composing-a-reply-to-an-encrypted-message-with-protected-headers">
<section id="section-4.1.4.6">
            <h5 id="name-composing-a-reply-to-an-enc">
<a href="#section-4.1.4.6" class="section-number selfRef">4.1.4.6. </a><a href="#name-composing-a-reply-to-an-enc" class="section-name selfRef">Composing a Reply to an Encrypted Message with Protected Headers</a>
            </h5>
<p id="section-4.1.4.6-1">When composing a reply to an encrypted message with protected headers, the MUA is acting both as a receiving MUA and as a sending MUA.
Special guidance applies here, as things can go wrong in at least two ways: leaking previously-confidential information, and replying to the wrong party.<a href="#section-4.1.4.6-1" class="pilcrow">¶</a></p>
<div id="avoid-leaking-encrypted-headers-in-reply">
<section id="section-4.1.4.6.1">
              <h6 id="name-avoid-leaking-encrypted-hea">
<a href="#section-4.1.4.6.1" class="section-number selfRef">4.1.4.6.1. </a><a href="#name-avoid-leaking-encrypted-hea" class="section-name selfRef">Avoid Leaking Encrypted Headers in Reply</a>
              </h6>
<p id="section-4.1.4.6.1-1">As noted in <span>[<a href="#I-D.dkg-lamps-e2e-mail-guidance" class="xref">I-D.dkg-lamps-e2e-mail-guidance</a>]</span>, an MUA in this position MUST NOT leak previously-encrypted content in the clear in a followup message.
The same is true for protected headers.<a href="#section-4.1.4.6.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1.4.6.1-2">Values from any header field that was identified as either <code>encrypted</code> or <code>signed-and-encrypted</code> based on the steps outlined above MUST NOT be placed in cleartext output when generating a message.<a href="#section-4.1.4.6.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1.4.6.1-3">In particular, if <code>Subject</code> was encrypted, and it is copied into the draft encrypted reply, the replying MUA MUST obfuscate the <code>Subject</code> field in the cleartext header as described above.<a href="#section-4.1.4.6.1-3" class="pilcrow">¶</a></p>
<p id="section-4.1.4.6.1-4">[[ TODO: formally describe how a replying MUA should generate a message-specific Header Protection policy based on the cryptographic status of the headers of the incoming message ]]<a href="#section-4.1.4.6.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="avoid-misdirected-replies">
<section id="section-4.1.4.6.2">
              <h6 id="name-avoid-misdirected-replies-t">
<a href="#section-4.1.4.6.2" class="section-number selfRef">4.1.4.6.2. </a><a href="#name-avoid-misdirected-replies-t" class="section-name selfRef">Avoid Misdirected Replies to Encrypted Messages with Protected Headers</a>
              </h6>
<p id="section-4.1.4.6.2-1">When replying to a message, the Composing MUA typically decides who to send the reply to based on:<a href="#section-4.1.4.6.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.4.6.2-2.1">the <code>Reply-To</code>, <code>Mail-Followup-To</code>, or <code>From</code> headers<a href="#section-4.1.4.6.2-2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-4.1.4.6.2-2.2">optionally, the other <code>To</code> or <code>Cc</code> headers (if the user chose to "reply all")<a href="#section-4.1.4.6.2-2.2" class="pilcrow">¶</a>
</li>
              </ul>
<p id="section-4.1.4.6.2-3">When a message has protected headers, the replying MUA MUST populate the destination fields of the draft message using the protected headers, and ignore any unprotected headers.<a href="#section-4.1.4.6.2-3" class="pilcrow">¶</a></p>
<p id="section-4.1.4.6.2-4">This mitigates against an attack where Mallory gets a copy of an encrypted message from Alice to Bob, and then replays the message to Bob with an additional <code>Cc</code> to Mallory's own e-mail address in the message's outer header.<a href="#section-4.1.4.6.2-4" class="pilcrow">¶</a></p>
<p id="section-4.1.4.6.2-5">If Bob knows Mallory's certificate already, and he replies to such a message without following the guidance in this section, it's likely that his MUA will encrypt the cleartext of the message directly to Mallory.<a href="#section-4.1.4.6.2-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="implicitly-rendered-header-fields">
<section id="section-4.1.4.7">
            <h5 id="name-implicitly-rendered-header-">
<a href="#section-4.1.4.7" class="section-number selfRef">4.1.4.7. </a><a href="#name-implicitly-rendered-header-" class="section-name selfRef">Implicitly-rendered Header Fields</a>
            </h5>
<p id="section-4.1.4.7-1">While <code>From</code> and <code>To</code> and <code>Cc</code> and <code>Subject</code> and <code>Date</code> are often explicitly rendered to the user, some header fields do affect message display, without being explicitly rendered.<a href="#section-4.1.4.7-1" class="pilcrow">¶</a></p>
<p id="section-4.1.4.7-2">For example, <code>Message-Id</code>, <code>References</code>, and <code>In-Reply-To</code> header fields may collectively be used to place a message in a "thread" or series of messages.<a href="#section-4.1.4.7-2" class="pilcrow">¶</a></p>
<p id="section-4.1.4.7-3">In another example, <a href="#avoid-misdirected-replies" class="xref">Section 4.1.4.6.2</a> observes that the value of the <code>Reply-To</code> field can influence the draft reply message.
So while the user may never see the <code>Reply-To</code> header directly, it is implicitly "rendered" when the user interacts with the message by replying to it.<a href="#section-4.1.4.7-3" class="pilcrow">¶</a></p>
<p id="section-4.1.4.7-4">An MUA that depends on any implicitly-rendered header field in a message with protected headers SHOULD use the value from the protected header, and SHOULD NOT use any value found outside the cryptographic protection.<a href="#section-4.1.4.7-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="unprotected-headers-added-in-transit">
<section id="section-4.1.4.8">
            <h5 id="name-unprotected-headers-added-i">
<a href="#section-4.1.4.8" class="section-number selfRef">4.1.4.8. </a><a href="#name-unprotected-headers-added-i" class="section-name selfRef">Unprotected Headers Added in Transit</a>
            </h5>
<p id="section-4.1.4.8-1">Some headers are legitimately added in transit, and could not have been known to the sender at message composition time.<a href="#section-4.1.4.8-1" class="pilcrow">¶</a></p>
<p id="section-4.1.4.8-2">The most common of these headers are <code>Received</code> and <code>DKIM-Signature</code>, neither of which are typically rendered, either explicitly or implicitly.<a href="#section-4.1.4.8-2" class="pilcrow">¶</a></p>
<p id="section-4.1.4.8-3">If a receiving MUA has specific knowledge about a given header field, including that:<a href="#section-4.1.4.8-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.4.8-4.1">the header field would not have been known to the original sender, and<a href="#section-4.1.4.8-4.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.1.4.8-4.2">the header field might be rendered explicitly or implicitly,<a href="#section-4.1.4.8-4.2" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.1.4.8-5">then the MUA MAY decide to operate on the value of that header field from the unprotected header section, even though the message has protected headers.<a href="#section-4.1.4.8-5" class="pilcrow">¶</a></p>
<p id="section-4.1.4.8-6">The MUA MAY prefer to verify that the headers in question have additional transit-derived cryptographic protections (e.g., to test whether they are covered by a valid <code>DKIM-Signature</code>) before rendering or acting on them.<a href="#section-4.1.4.8-6" class="pilcrow">¶</a></p>
<p id="section-4.1.4.8-7">Specific examples appear below.<a href="#section-4.1.4.8-7" class="pilcrow">¶</a></p>
<div id="mailing-list-headers-list-and-archived-at">
<section id="section-4.1.4.8.1">
              <h6 id="name-mailing-list-headers-list-a">
<a href="#section-4.1.4.8.1" class="section-number selfRef">4.1.4.8.1. </a><a href="#name-mailing-list-headers-list-a" class="section-name selfRef">Mailing list headers: List-* and Archived-At</a>
              </h6>
<p id="section-4.1.4.8.1-1">If the message arrives through a mailing list, the list manager itself may inject headers (most of which start with <code>List-</code>) in the message:<a href="#section-4.1.4.8.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.4.8.1-2.1">
                  <code>List-Archive</code><a href="#section-4.1.4.8.1-2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-4.1.4.8.1-2.2">
                  <code>List-Subscribe</code><a href="#section-4.1.4.8.1-2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-4.1.4.8.1-2.3">
                  <code>List-Unsubscribe</code><a href="#section-4.1.4.8.1-2.3" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-4.1.4.8.1-2.4">
                  <code>List-Id</code><a href="#section-4.1.4.8.1-2.4" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-4.1.4.8.1-2.5">
                  <code>List-Help</code><a href="#section-4.1.4.8.1-2.5" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-4.1.4.8.1-2.6">
                  <code>List-Post</code><a href="#section-4.1.4.8.1-2.6" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-4.1.4.8.1-2.7">
                  <code>Archived-At</code><a href="#section-4.1.4.8.1-2.7" class="pilcrow">¶</a>
</li>
              </ul>
<p id="section-4.1.4.8.1-3">For some MUAs, these headers are implicitly rendered, by providing buttons for actions like "Subscribe", "View Archived Version", "Reply List", "List Info", etc.<a href="#section-4.1.4.8.1-3" class="pilcrow">¶</a></p>
<p id="section-4.1.4.8.1-4">An MUA that receives a message with protected headers that contains these header fields in the unprotected section, and that has reason to believe the message is coming through a mailing list MAY decide to render them to the user (explicitly or implicitly) even though they are not protected.<a href="#section-4.1.4.8.1-4" class="pilcrow">¶</a></p>
<p id="section-4.1.4.8.1-5">FIXME: other examples of unprotected transit headers?<a href="#section-4.1.4.8.1-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="backward-compatibility-use-cases">
<section id="section-4.2">
        <h3 id="name-backward-compatibility-use-c">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-backward-compatibility-use-c" class="section-name selfRef">Backward Compatibility Use Cases</a>
        </h3>
<div id="receiving-side-mime-conformant">
<section id="section-4.2.1">
          <h4 id="name-receiving-side-mime-conforma">
<a href="#section-4.2.1" class="section-number selfRef">4.2.1. </a><a href="#name-receiving-side-mime-conforma" class="section-name selfRef">Receiving Side MIME-Conformant</a>
          </h4>
<p id="section-4.2.1-1">This section applies to the case where the sending side (fully)
supports Header Protection as specified in this document, while the
receiving side does not support this specification, but is
MIME-conformant according to <span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span>,
ff. (cf. <a href="#uc-ia-backward-compatibility-use-cases" class="xref">Section 3.1.2</a> and
<a href="#uc-ia-bc-receiving-side-mime-conformant" class="xref">Section 3.1.2.1</a>)<a href="#section-4.2.1-1" class="pilcrow">¶</a></p>
<p id="section-4.2.1-2">The sending side specification of the main use case
(cf. <a href="#main-use-case" class="xref">Section 4.1</a>) MUST ensure that receiving sides can still
recognize and display or offer to display the encapsulated data in
accordance with its media type (cf. <span>[<a href="#RFC2049" class="xref">RFC2049</a>]</span>, Section 2). In
particular, receiving sides that do not support this specification,
but are MIME-conformant according to <span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span>, ff. can still
recognize and display the Message intended for the user.<a href="#section-4.2.1-2" class="pilcrow">¶</a></p>
<p id="section-4.2.1-3">[[ TODO: Verify once solution is stable and update last sentence. ]]<a href="#section-4.2.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="receiving-side-not-mime-conformant">
<section id="section-4.2.2">
          <h4 id="name-receiving-side-not-mime-conf">
<a href="#section-4.2.2" class="section-number selfRef">4.2.2. </a><a href="#name-receiving-side-not-mime-conf" class="section-name selfRef">Receiving Side Not MIME-Conformant</a>
          </h4>
<p id="section-4.2.2-1">This section applies to cases where the sending side (fully)
supports Header Protection as specified in this document, while the
receiving side neither supports this specification
<strong>nor</strong> is MIME-conformant according to <span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span>, ff.
(cf. <a href="#uc-ia-backward-compatibility-use-cases" class="xref">Section 3.1.2</a>  and
<a href="#uc-ia-bc-receiving-side-not-mime-conformant" class="xref">Section 3.1.2.2</a>).<a href="#section-4.2.2-1" class="pilcrow">¶</a></p>
<p id="section-4.2.2-2"><span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span> describes a possible way to
achieve backward compatibility with existing S/MIME (and PGP/MIME)
implementations that predate this specification and are not
MIME-conformant (Legacy Display) either. It mainly focuses on email clients
that do not render emails which utilize header protection in a user friendly
manner, which may confuse the user. While this has been observed
occasionally in PGP/MIME (cf. <span>[<a href="#RFC3156" class="xref">RFC3156</a>]</span>), the extent of this problem
with S/MIME implementations is still unclear. (Note: At this time,
none of the samples in <span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span> apply
header protection as specified in Section 3.1 of <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>, which is
wrapping as Media Type "message/RFC822".)<a href="#section-4.2.2-2" class="pilcrow">¶</a></p>
<p id="section-4.2.2-3">Should serious backward compatibility issues with rendering at the
receiving side be discovered, the Legacy Display format described in
<span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span> may serve as a basis to
mitigate those issues (cf. <a href="#backward-compatibility-use-cases" class="xref">Section 4.2</a>).<a href="#section-4.2.2-3" class="pilcrow">¶</a></p>
<p id="section-4.2.2-4">Another variant of backward compatibility has been implemented by pEp
<span>[<a href="#I-D.pep-email" class="xref">I-D.pep-email</a>]</span>, i.e. pEp Email Format 1.0. At this time pEp
has implemented this for PGP/MIME, but not yet S/MIME.<a href="#section-4.2.2-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="usability-considerations">
<section id="section-5">
      <h2 id="name-usability-considerations">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-usability-considerations" class="section-name selfRef">Usability Considerations</a>
      </h2>
<p id="section-5-1">This section describes concerns for MUAs that are interested in easy adoption of header protection by normal users.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">While they are not protocol-level artifacts, these concerns motivate the protocol features described in this document.<a href="#section-5-2" class="pilcrow">¶</a></p>
<p id="section-5-3">See also the Usability section in <span>[<a href="#I-D.dkg-lamps-e2e-mail-guidance" class="xref">I-D.dkg-lamps-e2e-mail-guidance</a>]</span>.<a href="#section-5-3" class="pilcrow">¶</a></p>
<div id="mixed-protections">
<section id="section-5.1">
        <h3 id="name-mixed-protections-within-a-">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-mixed-protections-within-a-" class="section-name selfRef">Mixed Protections Within a Message Are Hard To Understand</a>
        </h3>
<p id="section-5.1-1">[[ TODO ]]<a href="#section-5.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sensible-default-hcp">
<section id="section-5.2">
        <h3 id="name-users-should-not-have-to-ch">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-users-should-not-have-to-ch" class="section-name selfRef">Users Should Not Have To Choose a Header Confidentiality Policy</a>
        </h3>
<p id="section-5.2-1">[[ TODO ]]<a href="#section-5.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-6">
      <h2 id="name-security-considerations">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-6-1">[[ TODO ]]<a href="#section-6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="privacy-considerations">
<section id="section-7">
      <h2 id="name-privacy-considerations">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-privacy-considerations" class="section-name selfRef">Privacy Considerations</a>
      </h2>
<p id="section-7-1">[[ TODO ]]<a href="#section-7-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana-considerations">
<section id="section-8">
      <h2 id="name-iana-considerations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-8-1">This document requests no action from IANA.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">[[ RFC Editor: This section may be removed before publication. ]]<a href="#section-8-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="acknowledgments">
<section id="section-9">
      <h2 id="name-acknowledgments">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="section-9-1">The authors would like to thank the following people who have provided
helpful comments and suggestions for this document: Berna Alp, Claudio
Luck, David Wilson, Hernani Marques, juga, Krista
Bennett, Kelly Bristol, Lars Rohwedder, Robert Williams, Russ Housley,
Sofia Balicka, Steve Kille, Volker Birk, and Wei Chuang.<a href="#section-9-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-10">
      <h2 id="name-references">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-10.1">
        <h3 id="name-normative-references">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.dkg-lamps-e2e-mail-guidance">[I-D.dkg-lamps-e2e-mail-guidance]</dt>
        <dd>
<span class="refAuthor">Gillmor, D. K.</span>, <span class="refTitle">"Guidance on End-to-End E-mail Security"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-dkg-lamps-e2e-mail-guidance-01</span>, <time datetime="2021-02-22" class="refDate">22 February 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-dkg-lamps-e2e-mail-guidance-01.txt">https://www.ietf.org/archive/id/draft-dkg-lamps-e2e-mail-guidance-01.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-lamps-header-protection-requirements">[I-D.ietf-lamps-header-protection-requirements]</dt>
        <dd>
<span class="refAuthor">Melnikov, A.</span><span class="refAuthor"> and B. Hoeneisen</span>, <span class="refTitle">"Problem Statement and Requirements for Header Protection"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-lamps-header-protection-requirements-01</span>, <time datetime="2019-10-29" class="refDate">29 October 2019</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-lamps-header-protection-requirements-01.txt">https://www.ietf.org/archive/id/draft-ietf-lamps-header-protection-requirements-01.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2045">[RFC2045]</dt>
        <dd>
<span class="refAuthor">Freed, N.</span><span class="refAuthor"> and N. Borenstein</span>, <span class="refTitle">"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies"</span>, <span class="seriesInfo">RFC 2045</span>, <span class="seriesInfo">DOI 10.17487/RFC2045</span>, <time datetime="1996-11" class="refDate">November 1996</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2045">https://www.rfc-editor.org/info/rfc2045</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2046">[RFC2046]</dt>
        <dd>
<span class="refAuthor">Freed, N.</span><span class="refAuthor"> and N. Borenstein</span>, <span class="refTitle">"Multipurpose Internet Mail Extensions (MIME) Part Two: Media Types"</span>, <span class="seriesInfo">RFC 2046</span>, <span class="seriesInfo">DOI 10.17487/RFC2046</span>, <time datetime="1996-11" class="refDate">November 1996</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2046">https://www.rfc-editor.org/info/rfc2046</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2049">[RFC2049]</dt>
        <dd>
<span class="refAuthor">Freed, N.</span><span class="refAuthor"> and N. Borenstein</span>, <span class="refTitle">"Multipurpose Internet Mail Extensions (MIME) Part Five: Conformance Criteria and Examples"</span>, <span class="seriesInfo">RFC 2049</span>, <span class="seriesInfo">DOI 10.17487/RFC2049</span>, <time datetime="1996-11" class="refDate">November 1996</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2049">https://www.rfc-editor.org/info/rfc2049</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5322">[RFC5322]</dt>
        <dd>
<span class="refAuthor">Resnick, P., Ed.</span>, <span class="refTitle">"Internet Message Format"</span>, <span class="seriesInfo">RFC 5322</span>, <span class="seriesInfo">DOI 10.17487/RFC5322</span>, <time datetime="2008-10" class="refDate">October 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5322">https://www.rfc-editor.org/info/rfc5322</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8551">[RFC8551]</dt>
      <dd>
<span class="refAuthor">Schaad, J.</span><span class="refAuthor">, Ramsdell, B.</span><span class="refAuthor">, and S. Turner</span>, <span class="refTitle">"Secure/Multipurpose Internet Mail Extensions (S/MIME) Version 4.0 Message Specification"</span>, <span class="seriesInfo">RFC 8551</span>, <span class="seriesInfo">DOI 10.17487/RFC8551</span>, <time datetime="2019-04" class="refDate">April 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8551">https://www.rfc-editor.org/info/rfc8551</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-10.2">
        <h3 id="name-informative-references">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.autocrypt-lamps-protected-headers">[I-D.autocrypt-lamps-protected-headers]</dt>
        <dd>
<span class="refAuthor">Einarsson, B. R.</span><span class="refAuthor">, juga</span><span class="refAuthor">, and D. K. Gillmor</span>, <span class="refTitle">"Protected Headers for Cryptographic E-mail"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-autocrypt-lamps-protected-headers-02</span>, <time datetime="2019-12-20" class="refDate">20 December 2019</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-autocrypt-lamps-protected-headers-02.txt">https://www.ietf.org/archive/id/draft-autocrypt-lamps-protected-headers-02.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.dkg-lamps-samples">[I-D.dkg-lamps-samples]</dt>
        <dd>
<span class="refAuthor">Gillmor, D. K.</span>, <span class="refTitle">"S/MIME Example Keys and Certificates"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-dkg-lamps-samples-05</span>, <time datetime="2021-02-18" class="refDate">18 February 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-dkg-lamps-samples-05.txt">https://www.ietf.org/archive/id/draft-dkg-lamps-samples-05.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.melnikov-iana-reg-forwarded">[I-D.melnikov-iana-reg-forwarded]</dt>
        <dd>
<span class="refAuthor">Melnikov, A.</span><span class="refAuthor"> and B. Hoeneisen</span>, <span class="refTitle">"IANA Registration of Content-Type Header Field Parameter 'forwarded'"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-melnikov-iana-reg-forwarded-00</span>, <time datetime="2019-11-04" class="refDate">4 November 2019</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-melnikov-iana-reg-forwarded-00.txt">https://www.ietf.org/archive/id/draft-melnikov-iana-reg-forwarded-00.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.pep-email">[I-D.pep-email]</dt>
        <dd>
<span class="refAuthor">Marques, H.</span>, <span class="refTitle">"pretty Easy privacy (pEp): Email Formats and Protocols"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-pep-email-01</span>, <time datetime="2020-11-02" class="refDate">2 November 2020</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-pep-email-01.txt">https://www.ietf.org/archive/id/draft-pep-email-01.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="pEp.mixnet">[pEp.mixnet]</dt>
        <dd>
<span class="refAuthor">pEp Foundation</span>, <span class="refTitle">"Mixnet"</span>, <time datetime="2020-06" class="refDate">June 2020</time>, <span>&lt;<a href="https://dev.pep.foundation/Mixnet">https://dev.pep.foundation/Mixnet</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3156">[RFC3156]</dt>
        <dd>
<span class="refAuthor">Elkins, M.</span><span class="refAuthor">, Del Torto, D.</span><span class="refAuthor">, Levien, R.</span><span class="refAuthor">, and T. Roessler</span>, <span class="refTitle">"MIME Security with OpenPGP"</span>, <span class="seriesInfo">RFC 3156</span>, <span class="seriesInfo">DOI 10.17487/RFC3156</span>, <time datetime="2001-08" class="refDate">August 2001</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3156">https://www.rfc-editor.org/info/rfc3156</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4949">[RFC4949]</dt>
        <dd>
<span class="refAuthor">Shirey, R.</span>, <span class="refTitle">"Internet Security Glossary, Version 2"</span>, <span class="seriesInfo">FYI 36</span>, <span class="seriesInfo">RFC 4949</span>, <span class="seriesInfo">DOI 10.17487/RFC4949</span>, <time datetime="2007-08" class="refDate">August 2007</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4949">https://www.rfc-editor.org/info/rfc4949</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6376">[RFC6376]</dt>
        <dd>
<span class="refAuthor">Crocker, D., Ed.</span><span class="refAuthor">, Hansen, T., Ed.</span><span class="refAuthor">, and M. Kucherawy, Ed.</span>, <span class="refTitle">"DomainKeys Identified Mail (DKIM) Signatures"</span>, <span class="seriesInfo">STD 76</span>, <span class="seriesInfo">RFC 6376</span>, <span class="seriesInfo">DOI 10.17487/RFC6376</span>, <time datetime="2011-09" class="refDate">September 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6376">https://www.rfc-editor.org/info/rfc6376</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6409">[RFC6409]</dt>
        <dd>
<span class="refAuthor">Gellens, R.</span><span class="refAuthor"> and J. Klensin</span>, <span class="refTitle">"Message Submission for Mail"</span>, <span class="seriesInfo">STD 72</span>, <span class="seriesInfo">RFC 6409</span>, <span class="seriesInfo">DOI 10.17487/RFC6409</span>, <time datetime="2011-11" class="refDate">November 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6409">https://www.rfc-editor.org/info/rfc6409</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6532">[RFC6532]</dt>
        <dd>
<span class="refAuthor">Yang, A.</span><span class="refAuthor">, Steele, S.</span><span class="refAuthor">, and N. Freed</span>, <span class="refTitle">"Internationalized Email Headers"</span>, <span class="seriesInfo">RFC 6532</span>, <span class="seriesInfo">DOI 10.17487/RFC6532</span>, <time datetime="2012-02" class="refDate">February 2012</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6532">https://www.rfc-editor.org/info/rfc6532</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7489">[RFC7489]</dt>
      <dd>
<span class="refAuthor">Kucherawy, M., Ed.</span><span class="refAuthor"> and E. Zwicky, Ed.</span>, <span class="refTitle">"Domain-based Message Authentication, Reporting, and Conformance (DMARC)"</span>, <span class="seriesInfo">RFC 7489</span>, <span class="seriesInfo">DOI 10.17487/RFC7489</span>, <time datetime="2015-03" class="refDate">March 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7489">https://www.rfc-editor.org/info/rfc7489</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="test-vectors">
<section id="section-appendix.a">
      <h2 id="name-test-vectors">
<a href="#section-appendix.a" class="section-number selfRef">Appendix A. </a><a href="#name-test-vectors" class="section-name selfRef">Test Vectors</a>
      </h2>
<p id="section-appendix.a-1">This section contains sample messages using the different schemes described in this document.
Each sample contains a MIME object, and examples of how an MUA might render it.<a href="#section-appendix.a-1" class="pilcrow">¶</a></p>
<p id="section-appendix.a-2">The cryptographic protections used in this document use the S/MIME standard, and keying material and certificates come from <span>[<a href="#I-D.dkg-lamps-samples" class="xref">I-D.dkg-lamps-samples</a>]</span>.<a href="#section-appendix.a-2" class="pilcrow">¶</a></p>
<p id="section-appendix.a-3">For the signed-and-encrypted messages, only the <code>Subject</code> header is obscured.<a href="#section-appendix.a-3" class="pilcrow">¶</a></p>
<div id="wrapped-message-examples">
<section id="section-a.1">
        <h2 id="name-wrapped-message-examples">
<a href="#section-a.1" class="section-number selfRef">A.1. </a><a href="#name-wrapped-message-examples" class="section-name selfRef">Wrapped Message examples</a>
        </h2>
<p id="section-a.1-1">The examples in this subsection use the "Wrapped Message" header protection scheme.<a href="#section-a.1-1" class="pilcrow">¶</a></p>
<div id="wrapped-message-signed-only-with-pkcs7-signeddata">
<section id="section-a.1.1">
          <h3 id="name-wrapped-message-signed-only">
<a href="#section-a.1.1" class="section-number selfRef">A.1.1. </a><a href="#name-wrapped-message-signed-only" class="section-name selfRef">Wrapped Message: signed-only, with PKCS7 signedData</a>
          </h3>
<p id="section-a.1.1-1">[[ TODO ]]<a href="#section-a.1.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="wrapped-message-signed-only-using-multipartsigned">
<section id="section-a.1.2">
          <h3 id="name-wrapped-message-signed-only-">
<a href="#section-a.1.2" class="section-number selfRef">A.1.2. </a><a href="#name-wrapped-message-signed-only-" class="section-name selfRef">Wrapped Message: signed-only, using multipart/signed</a>
          </h3>
<p id="section-a.1.2-1">[[ TODO ]]<a href="#section-a.1.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="wrapped-message-signed-and-encrypted">
<section id="section-a.1.3">
          <h3 id="name-wrapped-message-signed-and-">
<a href="#section-a.1.3" class="section-number selfRef">A.1.3. </a><a href="#name-wrapped-message-signed-and-" class="section-name selfRef">Wrapped Message: signed-and-encrypted</a>
          </h3>
<p id="section-a.1.3-1">[[ TODO ]]<a href="#section-a.1.3-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="injected-headers-examples">
<section id="section-a.2">
        <h2 id="name-injected-headers-examples">
<a href="#section-a.2" class="section-number selfRef">A.2. </a><a href="#name-injected-headers-examples" class="section-name selfRef">Injected Headers examples</a>
        </h2>
<p id="section-a.2-1">The examples in this subsection use the "Injected Headers" header protection scheme.<a href="#section-a.2-1" class="pilcrow">¶</a></p>
<div id="injected-headers-signed-only-with-pkcs7-signeddata">
<section id="section-a.2.1">
          <h3 id="name-injected-headers-signed-onl">
<a href="#section-a.2.1" class="section-number selfRef">A.2.1. </a><a href="#name-injected-headers-signed-onl" class="section-name selfRef">Injected Headers: signed-only, with PKCS7 signedData</a>
          </h3>
<p id="section-a.2.1-1">[[ TODO ]]<a href="#section-a.2.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="injected-headers-signed-only-using-multipartsigned">
<section id="section-a.2.2">
          <h3 id="name-injected-headers-signed-only">
<a href="#section-a.2.2" class="section-number selfRef">A.2.2. </a><a href="#name-injected-headers-signed-only" class="section-name selfRef">Injected Headers: signed-only, using multipart/signed</a>
          </h3>
<p id="section-a.2.2-1">[[ TODO ]]<a href="#section-a.2.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="injected-headers-signed-and-encrypted-with-legacy-display-part">
<section id="section-a.2.3">
          <h3 id="name-injected-headers-signed-and">
<a href="#section-a.2.3" class="section-number selfRef">A.2.3. </a><a href="#name-injected-headers-signed-and" class="section-name selfRef">Injected Headers: signed-and-encrypted with Legacy Display part</a>
          </h3>
<p id="section-a.2.3-1">[[ TODO ]]<a href="#section-a.2.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="injected-headers-signed-and-encrypted-without-legacy-display-part">
<section id="section-a.2.4">
          <h3 id="name-injected-headers-signed-and-">
<a href="#section-a.2.4" class="section-number selfRef">A.2.4. </a><a href="#name-injected-headers-signed-and-" class="section-name selfRef">Injected Headers: signed-and-encrypted without Legacy Display part</a>
          </h3>
<p id="section-a.2.4-1">[[ TODO ]]<a href="#section-a.2.4-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="messages-without-header-protection">
<section id="section-a.3">
        <h2 id="name-messages-without-header-pro">
<a href="#section-a.3" class="section-number selfRef">A.3. </a><a href="#name-messages-without-header-pro" class="section-name selfRef">Messages without Header Protection</a>
        </h2>
<p id="section-a.3-1">The examples in this subsection have cryptographic protection, but no header protection.
They are provided in this document as a counterexample.
An MUA implementer can use these messages to verify that the reported cryptographic summary of the message indicates no header protection.<a href="#section-a.3-1" class="pilcrow">¶</a></p>
<div id="unprotected-headers-signed-only-with-pkcs7-signeddata">
<section id="section-a.3.1">
          <h3 id="name-unprotected-headers-signed-">
<a href="#section-a.3.1" class="section-number selfRef">A.3.1. </a><a href="#name-unprotected-headers-signed-" class="section-name selfRef">Unprotected Headers: signed-only, with PKCS7 signedData</a>
          </h3>
<p id="section-a.3.1-1">[[ TODO ]]<a href="#section-a.3.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="unprotected-headers-signed-only-using-multipartsigned">
<section id="section-a.3.2">
          <h3 id="name-unprotected-headers-signed-o">
<a href="#section-a.3.2" class="section-number selfRef">A.3.2. </a><a href="#name-unprotected-headers-signed-o" class="section-name selfRef">Unprotected Headers: signed-only, using multipart/signed</a>
          </h3>
<p id="section-a.3.2-1">[[ TODO ]]<a href="#section-a.3.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="unprotected-headers-signed-and-encrypted">
<section id="section-a.3.3">
          <h3 id="name-unprotected-headers-signed-a">
<a href="#section-a.3.3" class="section-number selfRef">A.3.3. </a><a href="#name-unprotected-headers-signed-a" class="section-name selfRef">Unprotected Headers: signed-and-encrypted</a>
          </h3>
<p id="section-a.3.3-1">[[ TODO ]]<a href="#section-a.3.3-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="additional-information">
<section id="section-appendix.b">
      <h2 id="name-additional-information">
<a href="#section-appendix.b" class="section-number selfRef">Appendix B. </a><a href="#name-additional-information" class="section-name selfRef">Additional information</a>
      </h2>
<div id="bcc-handling">
<section id="section-b.1">
        <h2 id="name-stored-variants-of-messages">
<a href="#section-b.1" class="section-number selfRef">B.1. </a><a href="#name-stored-variants-of-messages" class="section-name selfRef">Stored Variants of Messages with Bcc</a>
        </h2>
<p id="section-b.1-1">Messages containing at least one recipient address in the Bcc
header field may appear in up to three different variants:<a href="#section-b.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-b.1-2">
<li id="section-b.1-2.1">The Message for the recipient addresses listed in To or Cc
header fields, which must not include the Bcc header field neither
for signature calculation nor for encryption.<a href="#section-b.1-2.1" class="pilcrow">¶</a>
</li>
          <li id="section-b.1-2.2">
            <p id="section-b.1-2.2.1">The Message(s) sent to the recipient addresses in the Bcc header
field, which depends on the implementation:<a href="#section-b.1-2.2.1" class="pilcrow">¶</a></p>
<p id="section-b.1-2.2.2">
a) One Message for each recipient in the Bcc header field
   separately, with a Bcc header field containing only the address
   of the recipient it is sent to.<a href="#section-b.1-2.2.2" class="pilcrow">¶</a></p>
<p id="section-b.1-2.2.3">
b) The same Message for each recipient in the Bcc header field with
   a Bcc header field containing an indication such as "Undisclosed
   recipients", but no addresses.<a href="#section-b.1-2.2.3" class="pilcrow">¶</a></p>
<p id="section-b.1-2.2.4">
c) The same Message for each recipient in the Bcc header field
   which does not include a Bcc header field (this Message is
   identical to 1. / cf. above).<a href="#section-b.1-2.2.4" class="pilcrow">¶</a></p>
</li>
          <li id="section-b.1-2.3">The Message stored in the 'Sent'-Folder of the sender, which
usually contains the Bcc unchanged from the original Message,
i.e., with all recipient addresses.<a href="#section-b.1-2.3" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-b.1-3">The most privacy preserving method of the alternatives (2a, 2b, and
2c) is to standardize 2a, as in the other cases (2b and 2c),
information about hidden recipients is revealed via keys. In any case,
the Message has to be cloned and adjusted depending on the recipient.<a href="#section-b.1-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="text-moved-from-above">
<section id="section-appendix.c">
      <h2 id="name-text-moved-from-above">
<a href="#section-appendix.c" class="section-number selfRef">Appendix C. </a><a href="#name-text-moved-from-above" class="section-name selfRef">Text Moved from Above</a>
      </h2>
<p id="section-appendix.c-1">Note: Per an explicit request by the chair of the LAMPS WG to
only present one option for the specification, the following text has
been stripped from the main body of the draft. It is preserved in an
Appendix for the time being and may be moved back to the main body
or deleted, depending on the decision of the LAMPS WG.<a href="#section-appendix.c-1" class="pilcrow">¶</a></p>
<div id="void1">
<section id="section-c.1">
        <h2 id="name-mime-format-2">
<a href="#section-c.1" class="section-number selfRef">C.1. </a><a href="#name-mime-format-2" class="section-name selfRef">MIME Format</a>
        </h2>
<p id="section-c.1-1">Currently there are two options in discussion:<a href="#section-c.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-c.1-2">
<li id="section-c.1-2.1">The option according to the current S/MIME specification
(cf. <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>)<a href="#section-c.1-2.1" class="pilcrow">¶</a>
</li>
          <li id="section-c.1-2.2">An alternative option that is based on the former "memory hole"
approach (cf. <span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span>)<a href="#section-c.1-2.2" class="pilcrow">¶</a>
</li>
        </ol>
<div id="option-smime-spec">
<section id="section-c.1.1">
          <h3 id="name-s-mime-specification">
<a href="#section-c.1.1" class="section-number selfRef">C.1.1. </a><a href="#name-s-mime-specification" class="section-name selfRef">S/MIME Specification</a>
          </h3>
<p id="section-c.1.1-1">Note: This is currently described in the main part of this document.<a href="#section-c.1.1-1" class="pilcrow">¶</a></p>
<div id="option-ex-memory-hole">
<section id="section-c.1.1.1">
            <h4 id="name-alternative-option-autocryp">
<a href="#section-c.1.1.1" class="section-number selfRef">C.1.1.1. </a><a href="#name-alternative-option-autocryp" class="section-name selfRef">Alternative Option Autocrypt "Protected Headers" (Ex-"Memory Hole")</a>
            </h4>
<p id="section-c.1.1.1-1">An alternative option (based on the former autocrypt "Memory Hole" approach)
to be considered, is described in
<span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span>.<a href="#section-c.1.1.1-1" class="pilcrow">¶</a></p>
<p id="section-c.1.1.1-2">Unlike the option described in <a href="#option-smime-spec" class="xref">Appendix C.1.1</a>, this option does
not use a "message/RFC822" wrapper to unambiguously delimit the Inner
Message.<a href="#section-c.1.1.1-2" class="pilcrow">¶</a></p>
<p id="section-c.1.1.1-3">Before choosing this option, the following two issues must be assessed
to ensure no interoperability issues result from it:<a href="#section-c.1.1.1-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-c.1.1.1-4">
<li id="section-c.1.1.1-4.1">
                <p id="section-c.1.1.1-4.1.1">How current MIME parser implementations treat non-MIME Header
Fields, which are not part of the outermost MIME entity and not
part of a Message wrapped into a MIME entity of media type
"message/rfc822", and how such Messages are rendered to the user.<a href="#section-c.1.1.1-4.1.1" class="pilcrow">¶</a></p>
<p id="section-c.1.1.1-4.1.2"><span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span> provides some examples
for testing this.<a href="#section-c.1.1.1-4.1.2" class="pilcrow">¶</a></p>
</li>
              <li id="section-c.1.1.1-4.2">MIME-conformance, i.e. whether or not this option is (fully)
MIME-conformant <span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span> ff., in particular also Section 5.1. of
<span>[<a href="#RFC2046" class="xref">RFC2046</a>]</span> on "Multipart Media Type). In the following an excerpt
of paragraphs that may be relevant in this context:<a href="#section-c.1.1.1-4.2" class="pilcrow">¶</a>
</li>
            </ol>
<div class="artwork art-text alignLeft" id="section-c.1.1.1-5">
<pre>
      The only header fields that have defined meaning for body parts
      are those the names of which begin with "Content-".  All other
      header fields may be ignored in body parts.  Although they
      should generally be retained if at all possible, they may be
      discarded by gateways if necessary.  Such other fields are
      permitted to appear in body parts but must not be depended on.
      "X-" fields may be created for experimental or private
      purposes, with the recognition that the information they
      contain may be lost at some gateways.
</pre><a href="#section-c.1.1.1-5" class="pilcrow">¶</a>
</div>
<div class="artwork art-text alignLeft" id="section-c.1.1.1-6">
<pre>
      NOTE:  The distinction between an RFC 822 Message and a body
      part is subtle, but important.  A gateway between Internet and
      X.400 mail, for example, must be able to tell the difference
      between a body part that contains an image and a body part
      that contains an encapsulated Message, the body of which is a
      JPEG image.  In order to represent the latter, the body part
      must have "Content-Type: message/rfc822", and its body (after
      the blank line) must be the encapsulated Message, with its own
      "Content-Type: image/jpeg" header field.  The use of similar
      syntax facilitates the conversion of Messages to body parts,
      and vice versa, but the distinction between the two must be
      understood by implementors.  (For the special case in which
      parts actually are Messages, a "digest" subtype is also
      defined.)
</pre><a href="#section-c.1.1.1-6" class="pilcrow">¶</a>
</div>
<p id="section-c.1.1.1-7">The MIME structure of an Email Message looks as follows:<a href="#section-c.1.1.1-7" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-c.1.1.1-8">
<pre>
  &lt;Outer Message Header Section (unprotected)&gt;

  &lt;Outer Message Body (protected)&gt;

    &lt;Inner Message Header Section&gt;

    &lt;Inner Message Body&gt;

</pre><a href="#section-c.1.1.1-8" class="pilcrow">¶</a>
</div>
<p id="section-c.1.1.1-9">The following example demonstrates how an Original Message might be
protected, i.e., the Original Message is contained as Inner Message in
the Protected Body of an Outer Message. It illustrates the first Body
part (of the Outer Message) as a "multipart/signed"
(application/pkcs7-signature) media type:<a href="#section-c.1.1.1-9" class="pilcrow">¶</a></p>
<p id="section-c.1.1.1-10">Lines are prepended as follows:<a href="#section-c.1.1.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-c.1.1.1-11.1">"O: " Outer Message Header Section<a href="#section-c.1.1.1-11.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-c.1.1.1-11.2">"I: " Message Header Section<a href="#section-c.1.1.1-11.2" class="pilcrow">¶</a>
</li>
            </ul>
<div class="artwork art-text alignLeft" id="section-c.1.1.1-12">
<pre>
  O: Date: Mon, 25 Sep 2017 17:31:42 +0100 (GMT Daylight Time)
  O: Message-ID: &lt;e4a483cb-1dfb-481d-903b-298c92c21f5e@m.example.net&gt;
  O: Subject: Meeting at my place
  O: From: "Alexey Melnikov" &lt;alexey.melnikov@example.net&gt;
  O: MIME-Version: 1.0
  O: Content-Type: multipart/signed; charset=us-ascii; micalg=sha1;
  O:  protocol="application/pkcs7-signature";
  O:  boundary=boundary-AM

     This is a multipart message in MIME format.
     --boundary-AM
  I: Date: Mon, 25 Sep 2017 17:31:42 +0100 (GMT Daylight Time)
  I: From: "Alexey Melnikov" &lt;alexey.melnikov@example.net&gt;
  I: Message-ID: &lt;e4a483cb-1dfb-481d-903b-298c92c21f5e@m.example.net&gt;
  I: MIME-Version: 1.0
  I: MMHS-Primary-Precedence: 3
  I: Subject: Meeting at my place
  I: To: somebody@example.net
  I: X-Mailer: Isode Harrier Web Server
  I: Content-Type: text/plain; charset=us-ascii

     This is an important message that I don't want to be modified.

     --boundary-AM
     Content-Transfer-Encoding: base64
     Content-Type: application/pkcs7-signature

     [[base-64 encoded signature]]

     --boundary-AM--

</pre><a href="#section-c.1.1.1-12" class="pilcrow">¶</a>
</div>
<p id="section-c.1.1.1-13">The Outer Message Header Section is unprotected, while the remainder
(Outer Message Body) is protected. The Outer Message Body consists of
the Inner Message (Header Section and Body).<a href="#section-c.1.1.1-13" class="pilcrow">¶</a></p>
<p id="section-c.1.1.1-14">The Inner Message Header Section is the same as (or a subset of) the
Original Message Header Section.<a href="#section-c.1.1.1-14" class="pilcrow">¶</a></p>
<p id="section-c.1.1.1-15">The Inner Message Body is the same as the Original Message Body.<a href="#section-c.1.1.1-15" class="pilcrow">¶</a></p>
<p id="section-c.1.1.1-16">The Original Message itself may contain any MIME structure.<a href="#section-c.1.1.1-16" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="sending-side-1">
<section id="section-c.1.2">
          <h3 id="name-sending-side-2">
<a href="#section-c.1.2" class="section-number selfRef">C.1.2. </a><a href="#name-sending-side-2" class="section-name selfRef">Sending Side</a>
          </h3>
<p id="section-c.1.2-1">To ease explanation, the following describes the case where an Original
(message/rfc822) Message to be protected is present. If this is not
the case, Original Message means the (virtual) Message that would be
constructed for sending it as unprotected email.<a href="#section-c.1.2-1" class="pilcrow">¶</a></p>
<div id="inner-msg-hf">
<section id="section-c.1.2.1">
            <h4 id="name-inner-message-header-fields">
<a href="#section-c.1.2.1" class="section-number selfRef">C.1.2.1. </a><a href="#name-inner-message-header-fields" class="section-name selfRef">Inner Message Header Fields</a>
            </h4>
<p id="section-c.1.2.1-1">It is RECOMMENDED that the Inner Message contains all Header Fields of
the Original Message with the exception of the following Header Field,
which MUST NOT be included within the Inner Message nor within any
other protected part of the Message:<a href="#section-c.1.2.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-c.1.2.1-2.1">Bcc<a href="#section-c.1.2.1-2.1" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-c.1.2.1-3">[[ TODO: Bcc handling needs to be further specified (see also
           <a href="#bcc-handling" class="xref">Appendix B.1</a>). Certain MUAs cannot properly decrypt
           Messages with Bcc recipients. ]]<a href="#section-c.1.2.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="wrapper">
<section id="section-c.1.2.2">
            <h4 id="name-wrapper">
<a href="#section-c.1.2.2" class="section-number selfRef">C.1.2.2. </a><a href="#name-wrapper" class="section-name selfRef">Wrapper</a>
            </h4>
<p id="section-c.1.2.2-1">The wrapper is a simple MIME Header Section followed by an empty line
preceding the Inner Message (inside the Outer Message Body). The media
type of the wrapper MUST be "message/RFC822" and MUST contain the
Content-Type header field parameter "forwarded=no" as defined in
<span>[<a href="#I-D.melnikov-iana-reg-forwarded" class="xref">I-D.melnikov-iana-reg-forwarded</a>]</span>. The wrapper unambiguously
delimits the Inner Message from the rest of the Message.<a href="#section-c.1.2.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="cryptographic-layers-envelope">
<section id="section-c.1.2.3">
            <h4 id="name-cryptographic-layers-envelo">
<a href="#section-c.1.2.3" class="section-number selfRef">C.1.2.3. </a><a href="#name-cryptographic-layers-envelo" class="section-name selfRef">Cryptographic Layers / Envelope</a>
            </h4>
<p id="section-c.1.2.3-1">[[ TODO: Basically refer to S/MIME standards ]]<a href="#section-c.1.2.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sending-side-message-processing">
<section id="section-c.1.2.4">
            <h4 id="name-sending-side-message-proces">
<a href="#section-c.1.2.4" class="section-number selfRef">C.1.2.4. </a><a href="#name-sending-side-message-proces" class="section-name selfRef">Sending Side Message Processing</a>
            </h4>
<p id="section-c.1.2.4-1">For a protected Message the following steps are applied before a
Message is handed over to the Submission Entity:<a href="#section-c.1.2.4-1" class="pilcrow">¶</a></p>
<div id="sending-side-step-1">
<section id="section-c.1.2.4.1">
              <h5 id="name-step-1-decide-on-protection">
<a href="#section-c.1.2.4.1" class="section-number selfRef">C.1.2.4.1. </a><a href="#name-step-1-decide-on-protection" class="section-name selfRef">Step 1: Decide on Protection Level and Information Disclosure</a>
              </h5>
<p id="section-c.1.2.4.1-1">The implementation which applies protection to a Message must decide:<a href="#section-c.1.2.4.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-c.1.2.4.1-2.1">Which Protection Level (signature and/or encryption) shall be applied
to the Message? This depends on user request and/or local policy as
well as availability of cryptographic keys.<a href="#section-c.1.2.4.1-2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.4.1-2.2">Which Header Fields of the Original Message shall be part of the
Outer Message Header Section? This typically depends on local
policy. By default, the Essential Header Fields are part of the Outer
Message Header Section; cf. <a href="#outer-msg-hf" class="xref">Appendix C.1.2.5</a>.<a href="#section-c.1.2.4.1-2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.4.1-2.3">Which of these Header Fields are to be obfuscated?  This depends on
local policy and/or specific Privacy requirements of the user. By
default only the Subject Header Field is
obfuscated; cf. <a href="#outer-msg-hf" class="xref">Appendix C.1.2.5</a>.<a href="#section-c.1.2.4.1-2.3" class="pilcrow">¶</a>
</li>
              </ul>
</section>
</div>
<div id="sending-side-step-2">
<section id="section-c.1.2.4.2">
              <h5 id="name-step-2-compose-the-outer-me">
<a href="#section-c.1.2.4.2" class="section-number selfRef">C.1.2.4.2. </a><a href="#name-step-2-compose-the-outer-me" class="section-name selfRef">Step 2: Compose the Outer Message Header Section</a>
              </h5>
<p id="section-c.1.2.4.2-1">Depending on the decision in <a href="#sending-side-step-1" class="xref">Appendix C.1.2.4.1</a>, the implementation
shall compose the Outer Message Header Section. (Note that this also
includes the necessary MIME Header Section part for the following
protection layer.)<a href="#section-c.1.2.4.2-1" class="pilcrow">¶</a></p>
<p id="section-c.1.2.4.2-2">Outer Header Fields that are not obfuscated should contain the same
values as in the Original Message (except for MIME Header Section
part, which depends on the Protection Level selected in
<a href="#sending-side-step-1" class="xref">Appendix C.1.2.4.1</a>).<a href="#section-c.1.2.4.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sending-side-step-3">
<section id="section-c.1.2.4.3">
              <h5 id="name-step-3-apply-protection-to-">
<a href="#section-c.1.2.4.3" class="section-number selfRef">C.1.2.4.3. </a><a href="#name-step-3-apply-protection-to-" class="section-name selfRef">Step 3: Apply Protection to the Original Message</a>
              </h5>
<p id="section-c.1.2.4.3-1">Depending on the Protection Level selected in <a href="#sending-side-step-1" class="xref">Appendix C.1.2.4.1</a>,
the implementation applies signature and/or encryption to the Original
Message, including the wrapper (as per <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>), and sets the
resulting package as the Outer Message Body.<a href="#section-c.1.2.4.3-1" class="pilcrow">¶</a></p>
<p id="section-c.1.2.4.3-2">The resulting (Outer) Message is then typically handed over to the
Submission Entity.<a href="#section-c.1.2.4.3-2" class="pilcrow">¶</a></p>
<p id="section-c.1.2.4.3-3">[[ TODO: Example ]]<a href="#section-c.1.2.4.3-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="outer-msg-hf">
<section id="section-c.1.2.5">
            <h4 id="name-outer-message-header-fields">
<a href="#section-c.1.2.5" class="section-number selfRef">C.1.2.5. </a><a href="#name-outer-message-header-fields" class="section-name selfRef">Outer Message Header Fields</a>
            </h4>
<div id="encrypted-messages">
<section id="section-c.1.2.5.1">
              <h5 id="name-encrypted-messages">
<a href="#section-c.1.2.5.1" class="section-number selfRef">C.1.2.5.1. </a><a href="#name-encrypted-messages" class="section-name selfRef">Encrypted Messages</a>
              </h5>
<p id="section-c.1.2.5.1-1">To maximize Privacy, it is strongly RECOMMENDED to follow the
principle of Data Minimization (cf. <a href="#privacy" class="xref">Section 2.1</a>).<a href="#section-c.1.2.5.1-1" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-2">However, the Outer Message Header Section SHOULD contain the Essential
Header Fields and, in addition, MUST contain the Header Fields of the
MIME Header Section part to describe Cryptographic Layer of the
protected MIME subtree as per <span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>.<a href="#section-c.1.2.5.1-2" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-3">The following Header Fields are defined as the Essential Header Fields:<a href="#section-c.1.2.5.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-c.1.2.5.1-4.1">From<a href="#section-c.1.2.5.1-4.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-4.2">To (if present in the Original Message)<a href="#section-c.1.2.5.1-4.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-4.3">Cc (if present in the Original Message)<a href="#section-c.1.2.5.1-4.3" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-4.4">Bcc (if present in the Original Message, see also <a href="#bcc-handling" class="xref">Appendix B.1</a>)<a href="#section-c.1.2.5.1-4.4" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-4.5">Date<a href="#section-c.1.2.5.1-4.5" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-4.6">Message-ID<a href="#section-c.1.2.5.1-4.6" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-4.7">Subject<a href="#section-c.1.2.5.1-4.7" class="pilcrow">¶</a>
</li>
              </ul>
<p id="section-c.1.2.5.1-5">Further processing by the Submission Entity normally depends on part
of these Header Fields, e.g. From and Date HFs are required by
<span>[<a href="#RFC5322" class="xref">RFC5322</a>]</span>. Furthermore, not including certain Header
Fields may trigger spam detection to flag the Message, and/or
lead to user experience (UX) issues.<a href="#section-c.1.2.5.1-5" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-6">For further Data Minimization, the value of the Subject Header Field
SHOULD be obfuscated as follows:<a href="#section-c.1.2.5.1-6" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-c.1.2.5.1-7">
<pre>
* Subject: [...]
</pre><a href="#section-c.1.2.5.1-7" class="pilcrow">¶</a>
</div>
<p id="section-c.1.2.5.1-8">and it is RECOMMENDED to replace the Message-ID by a new randomly
generated Message-ID.<a href="#section-c.1.2.5.1-8" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-9">In addition, the value of other Essential Header Fields MAY be
obfuscated.<a href="#section-c.1.2.5.1-9" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-10">Non-Essential Header Fields SHOULD be omitted from the Outer Message
Header Section where possible. If Non-essential Header Fields are included
in the Outer Message Header Section, those MAY be obfuscated too.<a href="#section-c.1.2.5.1-10" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-11">Header Fields that are not obfuscated should contain the same values
as in the Original Message.<a href="#section-c.1.2.5.1-11" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-12">If an implementation obfuscates the From, To, and/or Cc
Header Fields, it may need to provide access to the clear text content
of these Header Fields to the Submission Entity for processing purposes.
This is particularly relevant, if proprietary Submission Entities are
used. Obfuscation of Header Fields may adversely impact spam filtering.<a href="#section-c.1.2.5.1-12" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-13">(A use case for obfuscation of all Outer Message Header Fields is
routing email through the use of onion routing or mix networks,
e.g. <span>[<a href="#pEp.mixnet" class="xref">pEp.mixnet</a>]</span>.)<a href="#section-c.1.2.5.1-13" class="pilcrow">¶</a></p>
<p id="section-c.1.2.5.1-14">The MIME Header Section part is the collection of MIME Header Fields
describing the following MIME structure as defined in <span>[<a href="#RFC2045" class="xref">RFC2045</a>]</span>.
A MIME Header Section part typically includes the following Header
Fields:<a href="#section-c.1.2.5.1-14" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-c.1.2.5.1-15.1">Content-Type<a href="#section-c.1.2.5.1-15.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-15.2">Content-Transfer-Encoding<a href="#section-c.1.2.5.1-15.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-15.3">Content-Disposition<a href="#section-c.1.2.5.1-15.3" class="pilcrow">¶</a>
</li>
              </ul>
<p id="section-c.1.2.5.1-16">The following example shows the MIME Header Section part of an S/MIME signed
Message (using application/pkcs7-mime with SignedData):<a href="#section-c.1.2.5.1-16" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-c.1.2.5.1-17">
<pre>
   MIME-Version: 1.0
   Content-Type: application/pkcs7-mime; smime-type=signed-data;
      name=smime.p7m
   Content-Transfer-Encoding: base64
   Content-Disposition: attachment; filename=smime.p7m

</pre><a href="#section-c.1.2.5.1-17" class="pilcrow">¶</a>
</div>
<p id="section-c.1.2.5.1-18">Depending on the scenario, further Header Fields MAY be exposed in the
Outer Message Header Section, which is NOT RECOMMENDED unless
justified. Such Header Fields may include e.g.:<a href="#section-c.1.2.5.1-18" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-c.1.2.5.1-19.1">References<a href="#section-c.1.2.5.1-19.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-19.2">Reply-To<a href="#section-c.1.2.5.1-19.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-c.1.2.5.1-19.3">In-Reply-To<a href="#section-c.1.2.5.1-19.3" class="pilcrow">¶</a>
</li>
              </ul>
</section>
</div>
<div id="unencrypted-messages">
<section id="section-c.1.2.5.2">
              <h5 id="name-unencrypted-messages">
<a href="#section-c.1.2.5.2" class="section-number selfRef">C.1.2.5.2. </a><a href="#name-unencrypted-messages" class="section-name selfRef">Unencrypted Messages</a>
              </h5>
<p id="section-c.1.2.5.2-1">The Outer Message Header Section of unencrypted Messages SHOULD
contain at least the Essential Header Fields and, in addition, MUST
contain the Header Fields of the MIME Header Section part to describe
Cryptographic Layer of the protected MIME subtree as per
<span>[<a href="#RFC8551" class="xref">RFC8551</a>]</span>. It may contain further Header Fields, in particular those
also present in the Inner Message Header Section.<a href="#section-c.1.2.5.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="document-considerations">
<section id="section-appendix.d">
      <h2 id="name-document-considerations">
<a href="#section-appendix.d" class="section-number selfRef">Appendix D. </a><a href="#name-document-considerations" class="section-name selfRef">Document Considerations</a>
      </h2>
<p id="section-appendix.d-1">[[ RFC Editor: This section is to be removed before publication ]]<a href="#section-appendix.d-1" class="pilcrow">¶</a></p>
<p id="section-appendix.d-2">This draft is built from markdown source, and its development is
tracked in <a href="https://gitlab.com/dkg/lamps-header-protection">a git repository</a>.<a href="#section-appendix.d-2" class="pilcrow">¶</a></p>
<p id="section-appendix.d-3">While minor editorial suggestions and nit-picks can be made as <a href="https://gitlab.com/dkg/lamps-header-protection">merge
requests</a>, please
direct all substantive discussion to <a href="https://www.ietf.org/mailman/listinfo/spasm">the LAMPS mailing
list</a> at <code>spasm@ietf.org</code>.<a href="#section-appendix.d-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="document-changelog">
<section id="section-appendix.e">
      <h2 id="name-document-changelog">
<a href="#section-appendix.e" class="section-number selfRef">Appendix E. </a><a href="#name-document-changelog" class="section-name selfRef">Document Changelog</a>
      </h2>
<p id="section-appendix.e-1">[[ RFC Editor: This section is to be removed before publication ]]<a href="#section-appendix.e-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-appendix.e-2.1">
          <p id="section-appendix.e-2.1.1">draft-ietf-lamps-header-protection-03<a href="#section-appendix.e-2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-appendix.e-2.1.2.1">dkg takes over from Bernie as primary author<a href="#section-appendix.e-2.1.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.1.2.2">Add Usability section<a href="#section-appendix.e-2.1.2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.1.2.3">describe two distinct formats "Wrapped Message" and "Injected Headers"<a href="#section-appendix.e-2.1.2.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.1.2.4">Introduce Header Confidentiality Policy model<a href="#section-appendix.e-2.1.2.4" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.1.2.5">Overhaul message composition guidance<a href="#section-appendix.e-2.1.2.5" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.1.2.6">Simplify document creation workflow, move public face to gitlab<a href="#section-appendix.e-2.1.2.6" class="pilcrow">¶</a>
</li>
          </ul>
</li>
        <li class="normal" id="section-appendix.e-2.2">
          <p id="section-appendix.e-2.2.1">draft-ietf-lamps-header-protection-02<a href="#section-appendix.e-2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-appendix.e-2.2.2.1">editorial changes / improve language<a href="#section-appendix.e-2.2.2.1" class="pilcrow">¶</a>
</li>
          </ul>
</li>
        <li class="normal" id="section-appendix.e-2.3">
          <p id="section-appendix.e-2.3.1">draft-ietf-lamps-header-protection-01<a href="#section-appendix.e-2.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-appendix.e-2.3.2.1">Add DKG as co-author<a href="#section-appendix.e-2.3.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.3.2.2">Partial Rewrite of Abstract and Introduction [HB/AM/DKG]<a href="#section-appendix.e-2.3.2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.3.2.3">Adding definiations for Cryptographic Layer, Cryptographic
Payload, and Cryptographic Envelope (reference to
<span>[<a href="#I-D.dkg-lamps-e2e-mail-guidance" class="xref">I-D.dkg-lamps-e2e-mail-guidance</a>]</span>) [DKG]<a href="#section-appendix.e-2.3.2.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.3.2.4">Enhanced MITM Definition to include Machine- /
Meddler-in-the-middle [HB]<a href="#section-appendix.e-2.3.2.4" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.3.2.5">Relaxed definition of Original message, which may not be of type
"message/rfc822" [HB]<a href="#section-appendix.e-2.3.2.5" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.3.2.6">Move "memory hole" option to the Appendix (on request by Chair to
only maintain one option in the specification) [HB]<a href="#section-appendix.e-2.3.2.6" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.3.2.7">Updated Scope of Protection Levels according to WG discussion
during IETF-108 [HB]<a href="#section-appendix.e-2.3.2.7" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.3.2.8">Obfuscation recommendation only for Subject and Message-Id and
distinguish between Encrypted and Unencrypted Messages [HB]<a href="#section-appendix.e-2.3.2.8" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-appendix.e-2.3.2.9">Removed (commented out) Header Field Flow Figure (it appeared to
be confusing as is was) [HB]<a href="#section-appendix.e-2.3.2.9" class="pilcrow">¶</a>
</li>
          </ul>
</li>
        <li class="normal" id="section-appendix.e-2.4">
          <p id="section-appendix.e-2.4.1">draft-ietf-lamps-header-protection-00<a href="#section-appendix.e-2.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-appendix.e-2.4.2.1">Initial version (text partially taken over from
<span>[<a href="#I-D.ietf-lamps-header-protection-requirements" class="xref">I-D.ietf-lamps-header-protection-requirements</a>]</span><a href="#section-appendix.e-2.4.2.1" class="pilcrow">¶</a>
</li>
          </ul>
</li>
      </ul>
</section>
</div>
<div id="open-issues">
<section id="section-appendix.f">
      <h2 id="name-open-issues">
<a href="#section-appendix.f" class="section-number selfRef">Appendix F. </a><a href="#name-open-issues" class="section-name selfRef">Open Issues</a>
      </h2>
<p id="section-appendix.f-1">[[ RFC Editor: This section should be empty and is to be removed
     before publication. ]]<a href="#section-appendix.f-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-appendix.f-2.1">Ensure "protected header" (Ex-Memory-Hole) option is (fully)
compliant with the MIME standard, in particular also <span>[<a href="#RFC2046" class="xref">RFC2046</a>]</span>,
Section 5.1. (Multipart Media Type) <a href="#option-ex-memory-hole" class="xref">Appendix C.1.1.1</a>.<a href="#section-appendix.f-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.2">Test Vectors!
This should be a new appendix section, to avoid injecting large blobs of unreadable data in the main text.
Once present, we can point to the relevant test vector in the main text by reference.<a href="#section-appendix.f-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.3">Should Outer Message Header Section (as received) be preserved for
the user? (<a href="#debugging-and-troubleshooting" class="xref">Section 4.1.4.5</a>)<a href="#section-appendix.f-2.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.4">Decide on whether or not merge requirements from
<span>[<a href="#I-D.ietf-lamps-header-protection-requirements" class="xref">I-D.ietf-lamps-header-protection-requirements</a>]</span> into this
document.<a href="#section-appendix.f-2.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.5">Decide what parts of <span>[<a href="#I-D.autocrypt-lamps-protected-headers" class="xref">I-D.autocrypt-lamps-protected-headers</a>]</span> to
merge into this document.<a href="#section-appendix.f-2.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.6">Enhance Introduction <a href="#introduction" class="xref">Section 1</a> and Problem Statement
(<a href="#problem-statement" class="xref">Section 2</a>).<a href="#section-appendix.f-2.6" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.7">Decide on whether or not specification for more legacy HP
requirements should be added to this document
(<a href="#uc-ia-backward-compatibility-use-cases" class="xref">Section 3.1.2</a>).<a href="#section-appendix.f-2.7" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.8">Verify simple backward compatibility case (Receiving Side
MIME-Conformant) is working; once solution is stable and update
paragraphs in <a href="#main-use-case" class="xref">Section 4.1</a>,
<a href="#uc-ia-bc-receiving-side-mime-conformant" class="xref">Section 3.1.2.1</a> and
<a href="#receiving-side-mime-conformant" class="xref">Section 4.2.1</a> accordingly.<a href="#section-appendix.f-2.8" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.9">Verify ability to distinguish between Messages with Header
Protection as specified in this document and legacy clients and
update <a href="#interactions" class="xref">Section 3.1</a> accordingly.<a href="#section-appendix.f-2.9" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.10">Improve definitions of Protection Levels and enhance list of
Protection Levels (<a href="#protection-levels" class="xref">Section 3.2</a>, <a href="#specification" class="xref">Section 4</a>).<a href="#section-appendix.f-2.10" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.11">Privacy Considerations <a href="#privacy-considerations" class="xref">Section 7</a><a href="#section-appendix.f-2.11" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-appendix.f-2.12">Security Considerations <a href="#security-considerations" class="xref">Section 6</a><a href="#section-appendix.f-2.12" class="pilcrow">¶</a>
</li>
      </ul>
</section>
</div>
<div id="authors-addresses">
<section id="section-appendix.g">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Daniel Kahn Gillmor</span></div>
<div dir="auto" class="left"><span class="org">American Civil Liberties Union</span></div>
<div dir="auto" class="left"><span class="street-address">125 Broad St.</span></div>
<div dir="auto" class="left">
<span class="locality">New York, NY</span>,  <span class="postal-code">10004</span>
</div>
<div dir="auto" class="left"><span class="country-name">United States of America</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:dkg@fifthhorseman.net" class="email">dkg@fifthhorseman.net</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Bernie Hoeneisen</span></div>
<div dir="auto" class="left"><span class="org">pEp Foundation</span></div>
<div dir="auto" class="left"><span class="street-address">Oberer Graben 4</span></div>
<div dir="auto" class="left">CH- <span class="locality">CH-8400 Winterthur</span>
</div>
<div dir="auto" class="left"><span class="country-name">Switzerland</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:bernie.hoeneisen@pep.foundation" class="email">bernie.hoeneisen@pep.foundation</a>
</div>
<div class="url">
<span>URI:</span>
<a href="https://pep.foundation/" class="url">https://pep.foundation/</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Alexey Melnikov</span></div>
<div dir="auto" class="left"><span class="org">Isode Ltd</span></div>
<div dir="auto" class="left"><span class="street-address">14 Castle Mews</span></div>
<div dir="auto" class="left"><span class="locality">Hampton, Middlesex</span></div>
<div dir="auto" class="left"><span class="postal-code">TW12 2NP</span></div>
<div dir="auto" class="left"><span class="country-name">United Kingdom</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:alexey.melnikov@isode.com" class="email">alexey.melnikov@isode.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
