<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>JavaScript Message Security Format</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Conventions Used In This Document">
<link href="#rfc.section.3" rel="Chapter" title="3 Overview">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Operational Modes">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Conventions">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Certificate Processing">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Certificate Discovery">
<link href="#rfc.section.4" rel="Chapter" title="4 Message Format">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Base64 Handling">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Content Object">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Common Elements">
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 Signed Data">
<link href="#rfc.section.4.4.1" rel="Chapter" title="4.4.1 Signature Computation">
<link href="#rfc.section.4.4.2" rel="Chapter" title="4.4.2 Signature Verification">
<link href="#rfc.section.4.4.2.1" rel="Chapter" title="4.4.2.1 Certificate Processing">
<link href="#rfc.section.4.5" rel="Chapter" title="4.5 Encrypted Data">
<link href="#rfc.section.4.5.1" rel="Chapter" title="4.5.1 Message Encryption">
<link href="#rfc.section.4.5.2" rel="Chapter" title="4.5.2 Message Decryption">
<link href="#rfc.section.4.5.3" rel="Chapter" title="4.5.3 Key Derivation">
<link href="#rfc.section.4.5.4" rel="Chapter" title="4.5.4 CMK Encryption">
<link href="#rfc.section.4.5.4.1" rel="Chapter" title="4.5.4.1 Asymmetric Encryption">
<link href="#rfc.section.4.5.4.2" rel="Chapter" title="4.5.4.2 Symmetric Encryption">
<link href="#rfc.section.4.6" rel="Chapter" title="4.6 Composition">
<link href="#rfc.section.5" rel="Chapter" title="5 Version Processing">
<link href="#rfc.section.6" rel="Chapter" title="6 IANA Considerations">
<link href="#rfc.section.7" rel="Chapter" title="7 Security Considerations">
<link href="#rfc.references" rel="Chapter" title="8 References">
<link href="#rfc.references.1" rel="Chapter" title="8.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="8.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A JSON Schema">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 Message Contents Schema">
<link href="#rfc.appendix.Appendix%20A.2" rel="Chapter" title="Appendix A.2 Common Elements Schema">
<link href="#rfc.appendix.Appendix%20A.3" rel="Chapter" title="Appendix A.3 Signed Message Schema">
<link href="#rfc.appendix.Appendix%20A.4" rel="Chapter" title="Appendix A.4 PKIX Certificate Chain Schema">
<link href="#rfc.appendix.Appendix%20A.5" rel="Chapter" title="Appendix A.5 Encrypted Message Schema">
<link href="#rfc.appendix.Appendix%20A.6" rel="Chapter" title="Appendix A.6 Recipient Schema">
<link href="#rfc.appendix.Appendix%20B" rel="Chapter" title="Appendix B Acknowledgments">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="Many applications require the ability to send cryptographically secured messages. While the IETF has defined a number of formats for such messages (e.g. CMS) those formats use encodings which are not congenial for Web applications. This document describes a new cryptographic message format which is based on JavaScript Object Notation (JSON) and thus is easy for Web applications to generate and parse." />
  <meta name="description" content="Many applications require the ability to send cryptographically secured messages. While the IETF has defined a number of formats for such messages (e.g. CMS) those formats use encodings which are not congenial for Web applications. This document describes a new cryptographic message format which is based on JavaScript Object Notation (JSON) and thus is easy for Web applications to generate and parse." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">E. Rescorla</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">RTFM, Inc.</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">J. Hildebrand</td>
</tr>
<tr>
<td class="left">Expires: September 09, 2011</td>
<td class="right">Cisco Systems, Inc.</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">March 08, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">JavaScript Message Security Format<br />
  <span class="filename">draft-rescorla-jsms-00.txt</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>Many applications require the ability to send cryptographically secured messages. While the IETF has defined a number of formats for such messages (e.g. CMS) those formats use encodings which are not congenial for Web applications. This document describes a new cryptographic message format which is based on JavaScript Object Notation (JSON) and thus is easy for Web applications to generate and parse.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on September 09, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>
<p>This document may contain material from IETF Documents or IETF Contributions published or made publicly available before November 10, 2008.  The person(s) controlling the copyright in some of this material may not have granted the IETF Trust the right to allow modifications of such material outside the IETF Standards Process. Without obtaining an adequate license from the person(s) controlling the copyright in such materials, this document may not be modified outside the IETF Standards Process, and derivative works of it may not be created outside the IETF Standards Process, except to format it for publication as an RFC or to translate it into languages other than English.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Conventions Used In This Document</a>
</li>
<li>3.   <a href="#rfc.section.3">Overview</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Operational Modes</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Conventions</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Certificate Processing</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Certificate Discovery</a>
</li>
<li>4.   <a href="#rfc.section.4">Message Format</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Base64 Handling</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Content Object</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Common Elements</a>
</li>
<li>4.4.   <a href="#rfc.section.4.4">Signed Data</a>
</li>
<li>4.4.1.   <a href="#rfc.section.4.4.1">Signature Computation</a>
</li>
<li>4.4.2.   <a href="#rfc.section.4.4.2">Signature Verification</a>
</li>
<li>4.4.2.1.   <a href="#rfc.section.4.4.2.1">Certificate Processing</a>
</li>
<li>4.5.   <a href="#rfc.section.4.5">Encrypted Data</a>
</li>
<li>4.5.1.   <a href="#rfc.section.4.5.1">Message Encryption</a>
</li>
<li>4.5.2.   <a href="#rfc.section.4.5.2">Message Decryption</a>
</li>
<li>4.5.3.   <a href="#rfc.section.4.5.3">Key Derivation</a>
</li>
<li>4.5.4.   <a href="#rfc.section.4.5.4">CMK Encryption</a>
</li>
<li>4.5.4.1.   <a href="#rfc.section.4.5.4.1">Asymmetric Encryption</a>
</li>
<li>4.5.4.2.   <a href="#rfc.section.4.5.4.2">Symmetric Encryption</a>
</li>
<li>4.6.   <a href="#rfc.section.4.6">Composition</a>
</li>
<li>5.   <a href="#rfc.section.5">Version Processing</a>
</li>
<li>6.   <a href="#rfc.section.6">IANA Considerations</a>
</li>
<li>7.   <a href="#rfc.section.7">Security Considerations</a>
</li>
<li>8.   <a href="#rfc.references">References</a>
</li>
<li>8.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>8.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">JSON Schema</a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">Message Contents Schema</a>
</li>
<li>Appendix A.2.   <a href="#rfc.appendix.Appendix%20A.2">Common Elements Schema</a>
</li>
<li>Appendix A.3.   <a href="#rfc.appendix.Appendix%20A.3">Signed Message Schema</a>
</li>
<li>Appendix A.4.   <a href="#rfc.appendix.Appendix%20A.4">PKIX Certificate Chain Schema</a>
</li>
<li>Appendix A.5.   <a href="#rfc.appendix.Appendix%20A.5">Encrypted Message Schema</a>
</li>
<li>Appendix A.6.   <a href="#rfc.appendix.Appendix%20A.6">Recipient Schema</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.Appendix%20B">Acknowledgments</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">Many applications require the ability to send cryptographically secured (encrypted, digitally signed, etc.) messages. While the IETF has defined a number of formats for such messages, those formats are widely viewed as being excessively complicated for the demands of Web applications, which typically only need the ability to secure simple messages. In addition, existing formats use encoding mechanisms (e.g., ASN.1 BER/DER) which are not congenial for Web applications. This presents an obstacle to the deployment of strong security by such applications.</p>
<p id="rfc.section.1.p.2">This document describes a new cryptographic message format, JavaScript Message Security (JSMS) intended to meet the need of the Web environment. While JSMS is modeled on existing formats -- principally CMS <a href="#RFC5652">[RFC5652]</a> -- it uses JavaScript Object Notation (JSON) rather than ASN.1/BER/DER, making it far easier for Web applications to handle. In the interest of simplicity, JSMS also omits as many as possible of the CMS modes (multiple signatures, password-based encryption).</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Conventions Used In This Document</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Overview</h1>
<p id="rfc.section.3.p.1">The JSMS message format is simply a JSON <a href="#RFC4627">[RFC4627]</a> dictionary with an appropriate collection of fields.  Each operating mode will have a separate set of fields, with a common field to distinguish between the modes.  </p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> Operational Modes</h1>
<p id="rfc.section.3.1.p.1">JSMS supports two operational modes:</p>
<p></p>

<dl>
<dt>Encrypted Data</dt>
<dd style="margin-left: 8"></dd>
<dt></dt>
<dd style="margin-left: 8">A block of data encrypted under a random message encryption key (MEK). The MEK is then separately encrypted for each recipient, either via symmetric or asymmetric encryption. The data is always integrity protected, either via a separate Message Authentication Code (MAC) or an Authenticated Encryption with Associated Data (AEAD) algorithm such as AES-GCM or AES-CCM.</dd>
<dt>Signed Data</dt>
<dd style="margin-left: 8"></dd>
<dt></dt>
<dd style="margin-left: 8">A block of data signed by a single signer using his asymmetric key and optionally carrying his certificate. Multiple signatures are not permitted in order to keep things simple.</dd>
</dl>
<p id="rfc.section.3.1.p.3">Any other desired security functions are provided by composition of these modes. For instance, a signed and encrypted message is produced by first creating a Signed message and then encrypting that data. (See <a href="#sec.msg-composition">Section 4.6</a> for more on composition.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> Conventions</h1>
<p id="rfc.section.3.2.p.1">In general, JSMS follows the following structural conventions:</p>
<p></p>

<dl>
<dt>Minimize implementation complexity</dt>
<dd style="margin-left: 8"></dd>
<dt></dt>
<dd style="margin-left: 8">Wherever possible, protocol choices have been made such that the time and effort required to implement the protocol in many different programming languages will be minimized.  This means that optimizations for bandwidth, CPU, and memory utilization have been explicitly avoided.</dd>
<dt>Base64 as the only encoding</dt>
<dd style="margin-left: 8"></dd>
<dt></dt>
<dd style="margin-left: 8">Any data that does not have a straightforward string representation (binary values, large integers, etc.) is base64-encoded (see: <a href="#RFC4648">[RFC4648]</a>). In some cases, hexadecimal encodings might be more convenient, but consistency is even more important to reduce implementation complexity.</dd>
<dt>No canonicalization</dt>
<dd style="margin-left: 8"></dd>
<dt></dt>
<dd style="margin-left: 8">In many cryptographic message formats, canonical encodings are used to allow the same value to be computed at both sender and recipient (e.g., for digital signatures). This is inconvenient in JSON, which just views messages as a bundle of key/value pairs. Instead, whenever canonicalization would be required, the relevant data is serialized and base64-encoded for transport, allowing both sides to run computations over the same original set of octets.</dd>
<dt>In-memory processing</dt>
<dd style="margin-left: 8"></dd>
<dt></dt>
<dd style="margin-left: 8">We assume that the entire message can fit in main memory and make no effort to design a wire representation which can be handled in small chunks in a single pass. This means, for instance, that there is no need to have a message digest indicator at the beginning of the message and then the signature at the end, as is done in CMS. Fields are simply serialized in whatever order is most convenient for the JSON implementation. The examples in this document are generally shown in whatever order seems most readable and are not normative.</dd>
</dl>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> Certificate Processing</h1>
<p id="rfc.section.3.3.p.1">Experience has shown that certificate handling (path construction) is one of the trickier parts of building a cryptographic system. While JSMS supports PKIX certificates, its certificate processing is far simpler than that of CMS. When a JSMS agent provides its certificate, it must provide an ordered chain (as in TLS <a href="#RFC5246">[RFC5246]</a>) terminating in its own certificate, thus removing the need to construct certificate paths. The certificates MUST be ordered with the end-entity certificate first and each certificate that follows signing the certificate immediately preceding it.  In addition, because many implementations will not want to do any ASN.1/BER processing at all, we will define a Web Service which applications can use for chain validation and translation to an easy-to-parse format. (See [TODO]).</p>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> Certificate Discovery</h1>
<p id="rfc.section.3.4.p.1">JSMS will often be used in an online messaging environment with users that have an address of the form user@domain, such as email, XMPP, or SIP.  As such, protocols such as WebFinger <a href="#I-D.hammer-webfinger">[I-D.hammer-webfinger]</a> or an end-to-end protocol can be used to retrieve appropriate certificates.  Downstream uses of JSMS SHOULD define a discovery mechanism suitable for the intended use.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Message Format</h1>
<p id="rfc.section.4.p.1">All of the field definitions in this section make use of JSON Schema <a href="#I-D.zyp-json-schema">[I-D.zyp-json-schema]</a>.  For each of the fields that is designed to hold an enumerated value, a registry will be created allowing other values to be used in addition to the values enumerated in the schema.</p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#sec.base64" id="sec.base64">Base64 Handling</a>
</h1>
<p id="rfc.section.4.1.p.1">As stated in section 3.1 of <a href="#RFC4648">[RFC4648]</a>, Base64 does not require linefeeds after a specific number of characters.  Since linefeeds are not valid characters in a JSON string, whenever a field is specified to be Base64-encoded in this document, it MUST NOT include any line breaks.  Base64-encoded fields also MUST NOT include JSON-encoded linefeeds such as "\n".  Any linebreaks in the middle of Base64-encoded sections of the examples are unintended side-effects of the production process.</p>
<p></p>

<dl>
<dt>Implementation Note:</dt>
<dd style="margin-left: 8">Much existing Base64-encoding code will generate linefeeds every 64 or 76 characters of output.  Ensure that these linefeeds are removed before inserting the output into a JSON structure.</dd>
</dl>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#sec.content" id="sec.content">Content Object</a>
</h1>
<p id="rfc.section.4.2.p.1">JSMS operates by providing transformations on "Content" objects, which are just mime-typed JSON objects. These objects are then wrapped in a signed/encrypted wrapper with the following fields:</p>
<p></p>

<dl>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>ContentType:</dt>
<dd style="margin-left: 8">A MIME <a href="#RFC2045">[RFC2045]</a> media type that MUST be included indicating the type of the "Data" field.</dd>
<dt>Type:</dt>
<dd style="margin-left: 8">The constant string "content", to facilitate easy determination that this is the target content.  This is useful (for example) in certain operating conditions where you must continue to unwrap layers of signatures until you get to the content.  This field MUST be included.</dd>
<dt>Data:</dt>
<dd style="margin-left: 8">The data value MUST be included as a text encoded as Base64 (See: <a href="#RFC4648">[RFC4648]</a>).</dd>
<dt>ID:</dt>
<dd style="margin-left: 8">An OPTIONAL universally unique ID that identifies this message, for use in detecting replay attacks.</dd>
<dt>Created:</dt>
<dd style="margin-left: 8">An OPTIONAL field describing the UTC date/time that the content was encoded into JSON, formatted according to the "date-time" production of <a href="#RFC3339">[RFC3339]</a>.</dd>
</dl>
<p id="rfc.section.4.2.p.3">Signing and encryption transform a "Content" object into "Signed" and "Encrypted" objects respectively. Verification and decryption transform "Signed" and "Encrypted" objects back into "Content" objects. For example:</p>
<div id="#rfc.figure.1"></div>
<div id="#fig.content"></div>
<pre>
{
    "ContentType":"text/plain; charset=UTF-8",
    "Type":"content",
    "Data":"SGVsbG8sIFdvcmxkCg==",
    "ID":"746a4c9f-8e84-4313-b669-81590ee2949e",
    "Created":"2011-03-07T16:17Z"
}</pre>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#sec.message-common" id="sec.message-common">Common Elements</a>
</h1>
<p id="rfc.section.4.3.p.1">A JSMS message is a JSON dictionary object containing a set of specific values.</p>
<p id="rfc.section.4.3.p.2">The following fields MUST be present in all messages:</p>
<p></p>

<dl>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>Version:</dt>
<dd style="margin-left: 8">The version number. For this specification this value MUST be set to the string "1.0".  See <a href="#sec.version">Section 5</a> for details on version handling.</dd>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>Type:</dt>
<dd style="margin-left: 8">The type of the message. MUST be either "signed" or "encrypted", to indicate a signed message (<a href="#sec.signed">Section 4.4</a>) or an encrypted message (<a href="#sec.encrypted">Section 4.5</a>) respectively.</dd>
</dl>
<h1 id="rfc.section.4.4">
<a href="#rfc.section.4.4">4.4.</a> <a href="#sec.signed" id="sec.signed">Signed Data</a>
</h1>
<p id="rfc.section.4.4.p.1">A "signed" message contains a signed data block plus a digital signature over that data. To simplify implementation, only one signer is allowed. In addition to the required fields from <a href="#sec.message-common">Section 4.3</a>, the fields in a signature message are:</p>
<p></p>

<dl>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>SignedData:</dt>
<dd style="margin-left: 8">This field MUST consist of a Base64-encoded "Content" structure (see <a href="#sec.content">Section 4.2</a>), which MUST have been encoded into octets as UTF-8 prior to Base64-encoding.  The signature is computed over the UTF-8 octet stream before Base64-encoding to ensure that the sender and receiver have the exact same representation.</dd>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>DigestAlgorithm:</dt>
<dd style="margin-left: 8">The message digest used to compute the signature. This field MUST be present for RSA-based signatures but MAY be omitted for future signatures which do not allow flexible digests.  For now, this field MUST have the value "SHA-256", meaning the digest algorithm was SHA-256 <a href="#FIPS-180-3">[FIPS-180-3]</a>.  </dd>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>SignatureAlgorithm:</dt>
<dd style="margin-left: 8">The signature algorithm used to compute the signature. This field MUST be present.  For now, this field MUST have the value "RSA-PKCS1-1.5", meaning the signature algorithm was RSASSA-PKCS1-v1_5 as specified in <a href="#RFC3447">[RFC3447]</a>.</dd>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>Signer:</dt>
<dd style="margin-left: 8">The signer's identity, expressed as a URI <a href="#RFC3986">[RFC3986]</a>. This field MUST be present.</dd>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>CertChain:</dt>
<dd style="margin-left: 8">The signer's certificate chain, if any (see <a href="#sec.certificates">Section 4.4.2.1</a>).</dd>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>Signature:</dt>
<dd style="margin-left: 8">The Base64-encoded signature, which MUST be included (see <a href="#sec.signature_computation">Section 4.4.1</a>).</dd>
</dl>
<div id="#rfc.figure.2"></div>
<div id="#fig.signed"></div>
<pre>
{
    "SignedData":"ewogICAgIkNvbnRlbnRUeXBlIjoidGV4dC9wbGFpbjsgY2hhcn
                  NldD1VVEYtOCIsCiAgICAiVHlwZSI6ImNvbnRlbnQiLAogICAg
                  IkRhdGEiOiJTR1ZzYkc4c0lGZHZjbXhrQ2c9PSIsCiAgICAiSU
                  QiOiI3NDZhNGM5Zi04ZTg0LTQzMTMtYjY2OS04MTU5MGVlMjk0
                  OWUiLAogICAgIkNyZWF0ZWQiOiIyMDExLTAzLTA3VDE2OjE3Wi
                  IKfQ==",
    "DigestAlgorithm":"SHA-256",
    "SignatureAlgorithm":"RSA-PKCS1-1.5",
    "Signer":"xmpp:romeo@example.net",
    "Signature":"sNsxJltUaz4pSzAtJiPZagUMV4SwWugWexGbffK/WJRDi2uq7TxN
                 /V9SwG/kvQ7CaTABbeUuc6cKGO5YxnH5hME3bHB5L9PKPWSjxzxo
                 68RPxQyPli2YJDDHKVPbofEa86CLqYcwTF5qrcL7fQFvlRSOVxpS
                 SJfIdiAJNA+nEnk="
}</pre>
<h1 id="rfc.section.4.4.1">
<a href="#rfc.section.4.4.1">4.4.1.</a> <a href="#sec.signature_computation" id="sec.signature_computation">Signature Computation</a>
</h1>
<p id="rfc.section.4.4.1.p.1">The signature is computed over the string prior to base64 encoding. I.e., the processing order for encoding is:</p>
<p></p>

<ol>
<li>Serialize the inner "Content" value into a UTF8-encoded octet series X.</li>
<li>Compute the signature value over X, and call the result Y. (In the case of signatures which use digests, this means feed the literal octets of the signature into the digest function.)</li>
<li>Compute the Base64 representation of X and insert it into the "SignedData" field of the message.</li>
<li>Compute the Base64 representation of Y, and insert the result into the "Signature" field.</li>
</ol>
<p id="rfc.section.4.4.1.p.3">This procedure removes dependencies on the exact serialization algorithm; variation in spacing, field order, etc. do not affect signature validity since the Base64 representation preserves them on the wire and protects them from modification by intermediaries.</p>
<p></p>

<dl>
<dt>Note:</dt>
<dd style="margin-left: 8">An alternative algorithm would be to compute the signature on the base64 representation itself, but this has two disadvantages: (1) any intermediaries which change spacing/line breaks would break the signature. (2) it is inconsistent with the algorithm for encryption (<a href="#sec.encrypted">Section 4.5</a>), which is designed to avoid multiple base64 encoding.</dd>
</dl>
<p id="rfc.section.4.4.1.p.5">This procedure only specifies the input to the signature computation. The details of the computation depend on the signature algorithm itself. The mapping from code points to algorithms is found in <a href="#sec.iana-cons">Section 6</a>.</p>
<h1 id="rfc.section.4.4.2">
<a href="#rfc.section.4.4.2">4.4.2.</a> <a href="#sec.signature_verification" id="sec.signature_verification">Signature Verification</a>
</h1>
<p id="rfc.section.4.4.2.p.1">In order to verify the signature, the steps of the previous section are reversed.</p>
<p></p>

<ol>
<li>Process the provided "Signer" and "CertChain" fields as described in <a href="#sec.certificates">Section 4.4.2.1</a> in order to determine the sender's public key.</li>
<li>Base64 decode the "SignedData" field in order to recover a string X.</li>
<li>Verify the "Signature" field against X using the sender's public key and the "SignatureAlgorithm" and "DigestAlgorithm" fields. If the signature fails, return an error.</li>
<li>Deserialize X to recover the inner "Content" value.</li>
<li>Check any "ID" or "Created" fields for replay.</li>
<li>Using the value of the "ContentType" field to give MIME type context, Base64-decode the "Data" field to retrieve the intended message.</li>
</ol>
<p></p>
<h1 id="rfc.section.4.4.2.1">
<a href="#rfc.section.4.4.2.1">4.4.2.1.</a> <a href="#sec.certificates" id="sec.certificates">Certificate Processing</a>
</h1>
<p id="rfc.section.4.4.2.1.p.1">JSMS uses the "CertChain" element to carry certificate chains.  For the moment, each certificate in the chain is expected to be a PKIX certificate BER-encoded then Base64-encoded.  Future versions of this document will likely specify other valid certificate formats, since one of the goals of this format is to avoid . The meaning of the fields is described below:</p>
<p></p>

<dl>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>Type:</dt>
<dd style="margin-left: 8">The type of the certificate chain. The only defined value is "PKIX", referring to PKIX <a href="#RFC5280">[RFC5280]</a> certificates.</dd>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>Chain:</dt>
<dd style="margin-left: 8">An array of certificate values. In the case of "PKIX" certificates this is a list of base64-encoded DER/BER PKIX certificate values. PKIX certificates MUST be represented in order with each certificate certifying the next and the final certificate representing the end-entity.</dd>
</dl>
<div id="#rfc.figure.3"></div>
<div id="#fig.pkixchain"></div>
<pre>
{
    "Type":"PKIX",
    "Chain":[
        "MIICPjCCAaegAwIBAgIBETANBgkqhkiG9w0BAQUFADBDMRMwEQ
         YKCZImiZPyLGQBGRYDY29tMRcwFQYKCZImiZPyLGQBGRYHZXhh
         bXBsZTETMBEGA1UEAxMKRXhhbXBsZSBDQTAeFw0wNDA0MzAxND
         I1MzRaFw0wNTA0MzAxNDI1MzRaMEMxEzARBgoJkiaJk/IsZAEZ
         FgNjb20xFzAVBgoJkiaJk/IsZAEZFgdleGFtcGxlMRMwEQYDVQ
         QDEwpFeGFtcGxlIENBMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCB
         iQKBgQDC15dtKHCqW88jLoBwOe7bb9Ut1WpPejQt+SJyR3Ad74
         DpyjCMAMSabltFtG6l5myUDfqR6UD8JZ3Ht2gZVo8RcGrX8ckR
         Tzp+P5mNbnaldF9epFVT5cdoNlPHHTsSpoX+vW6hyt81UKwI17
         m0flz+4qMs0SOEqpjAm2YYmmhH6QIDAQABo0IwQDAdBgNVHQ4E
         FgQUCGivhTPIOUp6+IKTjnBqSiCELDIwDgYDVR0PAQH/BAQDAg
         EGMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQEFBQADgYEA
         bPgCdKZh4mQEplQMbHITrTxH+/ZlE6mFkDPqdqMm2fzRDhVfKL
         fvk7888+I+fLlS/BZuKarh9Hpv1X/vs5XK82aIg06hNUWEy7yb
         uMitxV5G2QsOjYDhMyvcviuSfkpDqWrvimNhs25HOL7oDaNnXf
         P6kYE8krvFXyUl63zn2KE=",
        "MIICcTCCAdqgAwIBAgIBEjANBgkqhkiG9w0BAQUFADBDMRMwEQ
         YKCZImiZPyLGQBGRYDY29tMRcwFQYKCZImiZPyLGQBGRYHZXhh
         bXBsZTETMBEGA1UEAxMKRXhhbXBsZSBDQTAeFw0wNDA5MTUxMT
         Q4MjFaFw0wNTAzMTUxMTQ4MjFaMEMxEzARBgoJkiaJk/IsZAEZ
         FgNjb20xFzAVBgoJkiaJk/IsZAEZFgdleGFtcGxlMRMwEQYDVQ
         QDEwpFbmQgRW50aXR5MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCB
         iQKBgQDhauQDMJcCPPQQ87UeTX8Ue/b10HjppIrwo3Xs7bZWln
         +ImYWa8j5od4frntGfwLQX3KuJI6QdfhYjTE+oTfUxuHyq4xpJ
         CfRLJtsnZzCCEgFK6Rq2wQxTi2z8L3pD7DM2fjKye9WqzwEUxh
         LsE/ItFHqLIVgUE0xGo5ryFpX/IwIDAQABo3UwczAhBgNVHREE
         GjAYgRZlbmQuZW50aXR5QGV4YW1wbGUuY29tMB0GA1UdDgQWBB
         QXe5Iw/0TWZuGQECJsFk/AjkHdbTAfBgNVHSMEGDAWgBQIaK+F
         M8g5Snr4gpOOcGpKIIQsMjAOBgNVHQ8BAf8EBAMCBsAwDQYJKo
         ZIhvcNAQEFBQADgYEAACAoNFtoMgG7CjYOrXHFlRrhBM+urcdi
         FKQbNjHA4gw92R7AANwQoLqFb0HLYnq3TGOBJl7SgEVeM+dwRT
         s5OyZKnDvyJjZpCHm7+5ZDd0thi6GrkWTg8zdhPBqjpMmKsr9z
         1E3kWORi6rwgdJKGDs6EYHbpc7vHhdORRepiXc0="
    ]
}</pre>
<p id="rfc.section.4.4.2.1.p.3">The recipient MUST verify the certificate chain (in the case of PKIX certificates according to <a href="#RFC5280">[RFC5280]</a>). If any validation failure occurs, the implementation MUST abort processing and return an error.</p>
<p id="rfc.section.4.4.2.1.p.4">Once the certificate chain is validated, the end-entity certificate must contain an identity which matches the "Signer" field. In the case of PKIX certificates, the certificate MUST contain a subjectAltName field of type "uniformResourceIdentifier". This field MUST be equivalent to the URI in the "Signer" field. If not, an error MUST be returned.</p>
<h1 id="rfc.section.4.5">
<a href="#rfc.section.4.5">4.5.</a> <a href="#sec.encrypted" id="sec.encrypted">Encrypted Data</a>
</h1>
<p id="rfc.section.4.5.p.1">An "encrypted" message contains an encrypted "Content" block. All "encrypted" messages contain a symmetric integrity check, either via a MAC or via an AEAD <a href="#RFC5116">[RFC5116]</a> algorithm such as Galois/Counter Mode (GCM: <a href="#GCM">[GCM]</a>). A message may be encrypted to an arbitrary number of recipients. Each recipient is represented by a "Recipient" block, which contains a copy of the keying material encrypted for that recipient. Both symmetric and asymmetric key establishment is supported. In order to support both integrity and encryption, what is carried in the Recipient block is a Content Master Key (CMK) which is then used with a Key Derivation Function (KDF) to generate the Content Encryption Key (CEK) used to encrypt the message and the Content Integrity Key (CIK) used with the MAC. In addition to the required fields from <a href="#sec.message-common">Section 4.3</a> the fields in an encrypted message are:</p>
<p></p>
<p></p>

<dl>
<dt>Recipients:</dt>
<dd style="margin-left: 8">The list of recipients. This is an array of Recipient objects, each of which establishes the CMK for that recipient.</dd>
<dt>KDF:</dt>
<dd style="margin-left: 8">Specifies the key derivation function used to generate the CEK and the CIK from the CMK. This field MAY be absent if an AEAD algorithm is used, in which case the CEK is derived by copying the CMK.</dd>
<dt>Encryption:</dt>
<dd style="margin-left: 8">Specifies the properties of the encryption. The Algorithm field MUST contain the encryption algorithm and the IV field specifies the initialization vector (if required for the algorithm).  This field MUST be present.</dd>
<dt>Integrity:</dt>
<dd style="margin-left: 8">Specifies the properties of the integrity check. The Algorithm field MUST contain the MAC algorithm and the Value field MUST contain the MAC. This field MAY be absent if no integrity check is used.</dd>
<dt>Data:</dt>
<dd style="margin-left: 8">Contains the ciphertext.</dd>
</dl>
<p id="rfc.section.4.5.p.4">Each Recipient object provides an encrypted copy of the CMK for a single recipient.  The meaning of the fields is described below:</p>
<p></p>

<dl>
<dt></dt>
<dd style="margin-left: 8"></dd>
<dt>KEKidentifier</dt>
<dd style="margin-left: 8">Describes the key encrypting key (KEK) used to encrypt the CMK.  Either a "RecipientName" or a "KeyIdentifier" MUST be provided. If the "RecipientName" is provided, then a "CertificateDigest" SHOULD be provided.</dd>
<dt></dt>
<dd style="margin-left: 8"><dl>
<dt>RecipientName:</dt>
<dd style="margin-left: 8">Provides the recipient's name in URI form.</dd>
<dt>CertificateDigest:</dt>
<dd style="margin-left: 8">For now, the SHA-1 fingerprint of the PKIX certificate associated with the recipient.</dd>
<dt>KeyIdentifier</dt>
<dd style="margin-left: 8">The name of a shared symmetric key known to both sender and recipient. This need not be globally unique as long as it is unique within the recipient's context.</dd>
</dl></dd>
<dt>Algorithm:</dt>
<dd style="margin-left: 8">The algorithm used to encrypt the CMK.  For now, one of "RSA-PKCS1-1.5" (meaning RSASSA-PKCS1-v1_5 as specified in <a href="#RFC3447">[RFC3447]</a>) or "AES-256-CBC" (meaning <a href="#FIPS-180-3">[FIPS-180-3]</a>).  Note the JSMS only supports key transport and not key agreement (since key agreement can always be turned into key transport).</dd>
<dt>Value:</dt>
<dd style="margin-left: 8">The CMK encrypted under the specified algorithm and key.</dd>
</dl>
<h1 id="rfc.section.4.5.1">
<a href="#rfc.section.4.5.1">4.5.1.</a> <a href="#sec.encryption" id="sec.encryption">Message Encryption</a>
</h1>
<p id="rfc.section.4.5.1.p.1">The message encryption process is as follows.</p>
<p></p>

<ol>
<li>Generate a random CMK. The CMK MUST have a length at least equal to that of the larger of the required integrity or encryption keys and MUST be generated randomly. See <a href="#RFC4086">[RFC4086]</a> for considerations on generating random values. [[ TODO - we need a section on generating randomness in browsers - it's easy to screw up ]]</li>
<li>Encrypt the CMK for each recipient (see <a href="#sec.encrypt_cmk">Section 4.5.4</a>)</li>
<li>Generate a random IV (if required for the algorithm).</li>
<li>Run the key derivation algorithm (see <a href="#sec.key_derivation">Section 4.5.3</a>) to generate the CEK and CIK (if not using an AEAD algorithm).</li>
<li>Serialize the content into a bitstring M.</li>
<li>Encrypt M using the CEK and IV to form the bitstring C.</li>
<li>Set the Value element equal to the base64-encoded representation of C.</li>
<li>If not using an AEAD algorithm, compute the function I = MAC(CIK, C) using the chosen integrity algorithm. Note that this is EtA encryption which is considered the best cryptographic choice (See: <a href="#krawczyk-ate">[krawczyk-ate]</a>). Set the Integrity.Value element equal to the base64-encoded representation of I.</li>
</ol>
<h1 id="rfc.section.4.5.2">
<a href="#rfc.section.4.5.2">4.5.2.</a> <a href="#sec.decryption" id="sec.decryption">Message Decryption</a>
</h1>
<p id="rfc.section.4.5.2.p.1">The message decryption process is the reverse of the encryption process.</p>
<p></p>

<ol>
<li>Identify a Recipient block which appears to reference a key known to the recipient.</li>
<li>Decrypt the CMK. If this fails and another Recipient block appears plausible, that MAY be tried.</li>
<li>Run the key derivation algorithm (see <a href="#sec.key_derivation">Section 4.5.3</a>) to generate the CEK and CIK (if not using an AEAD algorithm).</li>
<li>If not using an AEAD algorithm, compute the integrity check value I' on the binary representation of the Value element using the indicated integrity check. If the Integrity.Value does not match I', then an error MUST be reported and processing MUST be aborted.</li>
<li>Decrypt the binary representation of the Value element and output the result</li>
</ol>
<h1 id="rfc.section.4.5.3">
<a href="#rfc.section.4.5.3">4.5.3.</a> <a href="#sec.key_derivation" id="sec.key_derivation">Key Derivation</a>
</h1>
<p id="rfc.section.4.5.3.p.1">The key derivation process converts the CMK into a CEK. It assumes as a primitive a Key Derivation Function (KDF) which notionally takes three arguments: <a href="#RFC5246">[RFC5246]</a> PRF using P_XXX as the underlying P_hash function. </p>

<dl>
<dt>MasterKey:</dt>
<dd style="margin-left: 8">The master key used to compute the individual use keys</dd>
<dt>Label:</dt>
<dd style="margin-left: 8">The use key label, used to differentiate individual use keys</dd>
<dt>Length:</dt>
<dd style="margin-left: 8">The length of the desired use key</dd>
</dl>

<p> The only real KDF specified in this document is the TLS PRF, which is invoked as PRF(MasterKey, Label) with an empty seed and produces an arbitrary length output. The appropriate number of bits (Length) is simply extracted from the beginning of the output.  The KDF name "P_XXX" in this document refers the the TLS </p>
<p id="rfc.section.4.5.3.p.2">To compute the CEK from the CMK, the label "Encryption" is used.</p>
<p id="rfc.section.4.5.3.p.3">To compute the CIK from the CMK, the label "Integrity" is used.</p>
<p id="rfc.section.4.5.3.p.4">When AEAD algorithms are used the KDF element MUST NOT be present. When they are not used, it MUST be present.</p>
<h1 id="rfc.section.4.5.4">
<a href="#rfc.section.4.5.4">4.5.4.</a> <a href="#sec.encrypt_cmk" id="sec.encrypt_cmk">CMK Encryption</a>
</h1>
<p id="rfc.section.4.5.4.p.1">JSMS supports two forms of CMK encryption:</p>
<p></p>

<ul>
<li>Asymmetric encryption under the recipient's public key.</li>
<li>Symmetric encryption under a shared key.</li>
</ul>
<h1 id="rfc.section.4.5.4.1">
<a href="#rfc.section.4.5.4.1">4.5.4.1.</a> <a href="#sec.asymmetric_encryption" id="sec.asymmetric_encryption">Asymmetric Encryption</a>
</h1>
<p id="rfc.section.4.5.4.1.p.1">In the asymmetric encryption mode, the CMK is encrypted under the recipient's public key. The only currently defined asymmetric encryption mode is RSA-PKCS1-1.5, which refers to <a href="#RFC3447">[RFC3447]</a> RSAES-PKCS1-v1_5.</p>
<h1 id="rfc.section.4.5.4.2">
<a href="#rfc.section.4.5.4.2">4.5.4.2.</a> <a href="#sec.symmetric_encryption" id="sec.symmetric_encryption">Symmetric Encryption</a>
</h1>
<p id="rfc.section.4.5.4.2.p.1">In the symmetric encryption mode, the CMK is encrypted under a symmetric key shared between the sender and receiver. All such modes MUST provide integrity for the CMK. This document defines four such modes: AES-128-CBC, AES-256-CBC referring to the <a href="#RFC5649">[RFC5649]</a> AES key wrapping modes and AES-128-GCM, AES-256-GCM, referring to AES encryption with GCM. For GCM the random 64-bit IV is prepended to the ciphertext.</p>
<h1 id="rfc.section.4.6">
<a href="#rfc.section.4.6">4.6.</a> <a href="#sec.msg-composition" id="sec.msg-composition">Composition</a>
</h1>
<p id="rfc.section.4.6.p.1">This document does not specify a combination signed and encrypted mode. However, because the contents of a message can be arbitrary, and encryption and data origin authentication can be provided by recursively encapsulating multiple JSMS messages. In general, senders SHOULD sign the message and then encrypt the result (thus encrypting the signature). This prevents attacks in which the signature is stripped, leaving just an encrypted message, as well as providing privacy for the signer.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#sec.version" id="sec.version">Version Processing</a>
</h1>
<p id="rfc.section.5.p.1">For the moment, all version numbers in the protocol MUST be 1.0.  Receivers MUST return an error for any other version number.  More interesting version processing will be defined in the future.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#sec.iana-cons" id="sec.iana-cons">IANA Considerations</a>
</h1>
<p id="rfc.section.6.p.1">[TODO] </p>

<ul>
<li>Register MIME types</li>
<li>Registries for signature, encryption, MAC</li>
<li>Well known HTTP URLs</li>
</ul>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#sec.sec-cons" id="sec.sec-cons">Security Considerations</a>
</h1>
<p id="rfc.section.7.p.1">Much more to follow here.</p>
<h1 id="rfc.references">
<a href="#rfc.references">8.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">8.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2045">[RFC2045]</b></td>
<td class="top">
<a href="mailto:ned@innosoft.com" title="Innosoft International, Inc.">Freed, N.</a> and <a href="mailto:nsb@nsb.fv.com" title="First Virtual Holdings">N.S. Borenstein</a>, "<a href="http://tools.ietf.org/html/rfc2045">Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies</a>", RFC 2045, November 1996.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3339">[RFC3339]</b></td>
<td class="top">
<a href="mailto:GK@ACM.ORG" title="Clearswift Corporation">Klyne, G.</a> and <a href="mailto:chris.newman@sun.com" title="Sun Microsystems">C. Newman</a>, "<a href="http://tools.ietf.org/html/rfc3339">Date and Time on the Internet: Timestamps</a>", RFC 3339, July 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3447">[RFC3447]</b></td>
<td class="top">
<a>Jonsson, J.</a> and <a>B. Kaliski</a>, "<a href="http://tools.ietf.org/html/rfc3447">Public-Key Cryptography Standards (PKCS) #1: RSA Cryptography Specifications Version 2.1</a>", RFC 3447, February 2003.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4086">[RFC4086]</b></td>
<td class="top">
<a>Eastlake, D.</a>, <a>Schiller, J.</a> and <a>S. Crocker</a>, "<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>", BCP 106, RFC 4086, June 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4627">[RFC4627]</b></td>
<td class="top">
<a>Crockford, D.</a>, "<a href="http://tools.ietf.org/html/rfc4627">The application/json Media Type for JavaScript Object Notation (JSON)</a>", RFC 4627, July 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4648">[RFC4648]</b></td>
<td class="top">
<a>Josefsson, S.</a>, "<a href="http://tools.ietf.org/html/rfc4648">The Base16, Base32, and Base64 Data Encodings</a>", RFC 4648, October 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5116">[RFC5116]</b></td>
<td class="top">
<a>McGrew, D.</a>, "<a href="http://tools.ietf.org/html/rfc5116">An Interface and Algorithms for Authenticated Encryption</a>", RFC 5116, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5246">[RFC5246]</b></td>
<td class="top">
<a>Dierks, T.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5246">The Transport Layer Security (TLS) Protocol Version 1.2</a>", RFC 5246, August 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5280">[RFC5280]</b></td>
<td class="top">
<a>Cooper, D.</a>, <a>Santesson, S.</a>, <a>Farrell, S.</a>, <a>Boeyen, S.</a>, <a>Housley, R.</a> and <a>W. Polk</a>, "<a href="http://tools.ietf.org/html/rfc5280">Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile</a>", RFC 5280, May 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5649">[RFC5649]</b></td>
<td class="top">
<a>Housley, R.</a> and <a>M. Dworkin</a>, "<a href="http://tools.ietf.org/html/rfc5649">Advanced Encryption Standard (AES) Key Wrap with Padding Algorithm</a>", RFC 5649, September 2009.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.zyp-json-schema">[I-D.zyp-json-schema]</b></td>
<td class="top">
<a>Zyp, K</a> and <a>G Court</a>, "<a href="http://tools.ietf.org/html/draft-zyp-json-schema-03">A JSON Media Type for Describing the Structure and Meaning of JSON Documents</a>", Internet-Draft draft-zyp-json-schema-03, November 2010.</td>
</tr>
<tr>
<td class="reference"><b id="FIPS-180-3">[FIPS-180-3]</b></td>
<td class="top">
<a>National Institute of Standards and Technology (NIST) </a>, "<a>Secure Hash Standard (SHS)</a>", FIPS PUB 180-3, October 2008.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">8.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC3986">[RFC3986]</b></td>
<td class="top">
<a href="mailto:timbl@w3.org" title="World Wide Web Consortium">Berners-Lee, T.</a>, <a href="mailto:fielding@gbiv.com" title="Day Software">Fielding, R.</a> and <a href="mailto:LMM@acm.org" title="Adobe Systems Incorporated">L. Masinter</a>, "<a href="http://tools.ietf.org/html/rfc3986">Uniform Resource Identifier (URI): Generic Syntax</a>", STD 66, RFC 3986, January 2005.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.hammer-webfinger">[I-D.hammer-webfinger]</b></td>
<td class="top">
<a>Hammer-Lahav, E</a>, <a>Fitzpatrick, B</a> and <a>B Cook</a>, "<a href="http://tools.ietf.org/html/draft-hammer-webfinger-00">The WebFinger Protocol</a>", Internet-Draft draft-hammer-webfinger-00, October 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5652">[RFC5652]</b></td>
<td class="top">
<a>Housley, R.</a>, "<a href="http://tools.ietf.org/html/rfc5652">Cryptographic Message Syntax (CMS)</a>", STD 70, RFC 5652, September 2009.</td>
</tr>
<tr>
<td class="reference"><b id="krawczyk-ate">[krawczyk-ate]</b></td>
<td class="top">
<a>Krawczyk, H.</a>, "<a>The Order of Encryption and Authentication for Protecting Communications (or: How Secure Is SSL?)</a>", Advances in cryptology--CRYPTO 2001 August 2001, .</td>
</tr>
<tr>
<td class="reference"><b id="GCM">[GCM]</b></td>
<td class="top">
<a>National Institute of Standards and Technology (NIST) </a>, "<a>Recommendation for Block Cipher Modes of Operation: Galois/Counter Mode (GCM) and GMAC</a>", SP 800-38D, November 2007.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> JSON Schema</h1>
<p id="rfc.section.Appendix A.p.1">The following schemas formally define various namespaces used in this document, in conformance with <a href="#I-D.zyp-json-schema">[I-D.zyp-json-schema]</a>.  Because validation of JSON documents is optional, these schemas are not normative and are provided for descriptive purposes only.</p>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> <a href="#schema.content" id="schema.content">Message Contents Schema</a>
</h1>
<div id="#rfc.figure.4"></div>
<pre>
{
    "description":"Message Contents",
    "type":"object",
    "properties":{
        "ContentType":{
            "description":"A MIME content type",
            "type":"string",
            "required":true
        },
        "Type":{
            "description":"Dictionary type",
            "type":"string",
            "enum":["content"],
            "required":true
        },
        "Data":{
            "description":"The underlying data",
            "type":"string",
            "required":true
        },
        "ID":{
            "description":"(optional) unique ID for this message",
            "type":"string"
        },
        "Created":{
            "description":"(optional) time the message was created",
            "type":"string",
            "format":"date-time"
        }
    }
}</pre>
<h1 id="rfc.appendix.Appendix A.2">
<a href="#rfc.appendix.Appendix%20A.2">Appendix A.2.</a> <a href="#schema.common" id="schema.common">Common Elements Schema</a>
</h1>
<div id="#rfc.figure.5"></div>
<pre>
{
    "description":"The basic schema for a JSMS message",
    "type":"object",
    "properties":{
        "Type":{
            "description":"Message type",
            "type":"string",
            "enum":["signed", "encrypted"]
        },
        "Version":{
            "description":"Version number for the message",
            "type":"string",
            "enum":["1.0"]
        }
    }
}</pre>
<h1 id="rfc.appendix.Appendix A.3">
<a href="#rfc.appendix.Appendix%20A.3">Appendix A.3.</a> <a href="#schema.signed" id="schema.signed">Signed Message Schema</a>
</h1>
<div id="#rfc.figure.6"></div>
<pre>
{
    "description":"A signed message",
    "type":"object",
    "extends":message_schema,
    "properties":{
        "Signature":{
            "description":"The signature over the SignedData",
            "type":"object",
            "properties":{
                "SignedData":{
                    "description":"content to be signed, Base64",
                    "type":"string",
                    "required":true
                },
                "DigestAlgorithm":{
                    "description":"",
                    "type":"string",
                    "enum":["SHA-256"] 
                },
                "SignatureAlgorithm":{
                    "description":"",
                    "type":"string",
                    "enum":["RSA-PKCS1-1.5"] 
                },
                "Signer":{
                    "description":"",
                    "type":"string",
                    "format":"uri",
                    "required":true 
                },
                "CertChain": {
                    "description":"the signer's cert chain",
                    "type":"PKIXcertchain"
                },
                "Signature":{
                    "description":"the signature",
                    "type":"string",
                    "required":true
                }
            }
        }
    }
}</pre>
<h1 id="rfc.appendix.Appendix A.4">
<a href="#rfc.appendix.Appendix%20A.4">Appendix A.4.</a> <a href="#schema.PKIXcertchain" id="schema.PKIXcertchain">PKIX Certificate Chain Schema</a>
</h1>
<div id="#rfc.figure.7"></div>
<pre>
{
    "description":"A chain of PKIX certificates",
    "id":"PKIXcertchain",
    "properties":{
        "Type":{
            "description":"The type of certificate chain",
            "type":"string",
            "enum":["PKIX"] },
        "Chain":{
            "description":"PKIX certs ordered from root to end",
            "type":"array",
            "items":{
                "description":"A base64-encoded BER certificate",
                "type":"string"
            }
        }
    }
}</pre>
<h1 id="rfc.appendix.Appendix A.5">
<a href="#rfc.appendix.Appendix%20A.5">Appendix A.5.</a> <a href="#schema.ecncrypted" id="schema.ecncrypted">Encrypted Message Schema</a>
</h1>
<div id="#rfc.figure.8"></div>
<pre>
{
    "description":"An encrypted object",
    "type":"object",
    "extends":message_schema,
    "properties":{
        "Recipients":{
            "description":"The list of recipient blocks",
            "type":"array",
            "required":true,
            "items":{
                "description":"A single recipient block",
                "type":"Recipient"
            }
        },
        "KDF":{
            "description":
            "The KDF used to derive the MAC and encryption keys",
            "type":"string",
            "enum":["P_SHA256"]
        },
        "Encryption":{
            "description":"Encryption control information",
            "type":"object",
            "required":true,
            "properties":{
                "Algorithm":{
                    "description":"The algorithm used to encrypt",
                    "type":"string",
                    "enum":["AES-256-CBC"]
                },
                "IV":{
                    "description":"Initialization vector (base64)",
                    "type":"string"
                } 
            }
        },
        "Integrity":{
            "description":"The integrity control information",
            "type":"object",
            "properties":{
                "Algorithm":{
                    "description":"The MAC algorithm",
                    "type":"string",
                    "enum":["HMAC-SHA-256"]
                },
                "Value":{
                    "description":"The MAC value (base64-encoded)",
                    "type":"string",
                    "required":true
                }
            }
        },
        "Data":{
            "description":"The ciphertext (Base64-encoded)",
            "type":"string",
            "required":true
        }
    }
}</pre>
<h1 id="rfc.appendix.Appendix A.6">
<a href="#rfc.appendix.Appendix%20A.6">Appendix A.6.</a> <a href="#schema.recipient" id="schema.recipient">Recipient Schema</a>
</h1>
<div id="#rfc.figure.9"></div>
<pre>
{
    "description":"The recipient of an encrypted object",
    "type":"object",
    "id":"Recipient",
    "properties":{
        "KEKidentifier":{
            "type":"object",
            "description":"Identifies the key encrypting key",
            "properties":{
                "RecipientName":{
                    "type":"string",
                    "description":"The recipient's name",
                    "format":"uri"
                },
                "CertificateDigest":{
                    "type":"string",
                    "description":"Recipient's cert fingerprint"
                },
                "KeyIdentifier":{
                    "type":"string",
                    "description": "Shared symmetric key (opaque)"
                }
            }
        },
        "Algorithm":{
            "description":"The algorithm used to protect the CMK",
            "type":"string",
            "enum":["RSA-PKCS1-1.5", "AES-256-CBC"]
        },
        "Value":{
            "description": "Base64 of the encrypted CMK",
            "type":"string"
        }
    }
}</pre>
<h1 id="rfc.appendix.Appendix B">
<a href="#rfc.appendix.Appendix%20B">Appendix B.</a> Acknowledgments</h1>
<p id="rfc.section.Appendix B.p.1">[TODO]</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Eric Rescorla</span> 
	  <span class="n hidden">
		<span class="family-name">Rescorla</span>
	  </span>
	</span>
	<span class="org vcardline">RTFM, Inc.</span>
	<span class="adr">
	  <span>2064 Edgewood Drive</span>

	  <span class="vcardline">
		<span class="locality">Palo Alto</span>,  
		<span class="region">CA</span> 
		<span class="code">94303</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ekr@rtfm.com">ekr@rtfm.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Joe Hildebrand</span> 
	  <span class="n hidden">
		<span class="family-name">Hildebrand</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>1899 Wyknoop Street, Suite 600</span>

	  <span class="vcardline">
		<span class="locality">Denver</span>,  
		<span class="region">CO</span> 
		<span class="code">80202</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:jhildebr@cisco.com">jhildebr@cisco.com</a></span>

  </address>
</div>

</body>
</html>