<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>NAT confessions: revealing the hosts behind the translator</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="NAT confessions: revealing the hosts behind the translator">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">A. Yourtchenko</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">D. Wing</td></tr>
<tr><td class="header">Intended status:  Standards Track</td><td class="header">cisco</td></tr>
<tr><td class="header">Expires:  February 26, 2011</td><td class="header">August 25, 2010</td></tr>
</table></td></tr></table>
<h1><br />NAT confessions: revealing the hosts behind the translator<br />draft-yourtchenko-nat-reveal-hash-00</h1>

<h3>Abstract</h3>

<p>
When an IP address is shared among several subscribers, it is impossible to determine which subscriber has initiated that TCP connection.&nbsp; This memo describes a technique to share the identity of a subscriber that initiated a TCP connection with the TCP server.. The proposed method avoids altering the application-level payload and works well with SSL-protected connections.

</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on February 26, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Notational Conventions<br />
<a href="#anchor3">3.</a>&nbsp;
Description<br />
<a href="#anchor4">4.</a>&nbsp;
Calculating the Internal Address Mapping<br />
<a href="#anchor5">5.</a>&nbsp;
Calculating the Verifier<br />
<a href="#anchor6">6.</a>&nbsp;
Encoding of the VFY into the packet: IP ID encoding<br />
<a href="#anchor7">7.</a>&nbsp;
Encoding of the VFY into the packet: TSval encoding<br />
<a href="#anchor8">8.</a>&nbsp;
Operation of the mechanism<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">8.1.</a>&nbsp;
Translator Operation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">8.2.</a>&nbsp;
Server Operation<br />
<a href="#anchor11">9.</a>&nbsp;
Interaction with TCP SYN cookies<br />
<a href="#anchor12">10.</a>&nbsp;
Other Mechanisms to Encode Client Identifier<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">10.1.</a>&nbsp;
Defining a new TCP option to store the address<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">10.2.</a>&nbsp;
Using TSecr in TCP SYN<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">10.3.</a>&nbsp;
Reserving the different port ranges per client<br />
<a href="#anchor16">11.</a>&nbsp;
Security Considerations<br />
<a href="#anchor17">12.</a>&nbsp;
IANA considerations<br />
<a href="#anchor18">13.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">14.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">14.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">14.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>
There are several scenarios where it is valuable to know the identity of a TCP client, including geolocation, DoS blocking, and spam blacklists. Today, this is done by equating IPv4 address with 'identity'.&nbsp; However, the identity of a TCP client is obscured when an IP address is shared <a class='info' href='#I-D.ietf-intarea-shared-addressing-issues'>I-D.ietf-intarea-shared-addressing-issues<span> (</span><span class='info'>Ford, M., Boucadair, M., Durand, A., Levis, P., and P. Roberts, &ldquo;Issues with IP Address Sharing,&rdquo; June&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;intarea&#8209;shared&#8209;addressing&#8209;issues].&nbsp; IP address sharing is done by both network address and port translators (NAPT) and by application-layer proxies (e.g., HTTP or FTP proxies).

</p>
<p>
The current state of the art requires the address sharing alter the application-level payload and include the identity of the internal host -- usually the internal host's private IP address.&nbsp; This incurs several drawbacks,</p>
<ul class="text">
<li>adjustment of TCP sequence numbers and acknowledgement numbers for the duration of the TCP session
</li>
<li>risk of false-positive application matching (e.g., accidentally inserting an HTTP header into a non-HTTP payload).
</li>
<li>interference with application payload by increasing packet size (e.g., MTU)
</li>
</ul><p>
&nbsp;With SSL-protected applications the current state of the art requires breaking the end-to-end encrypted connection. This results in several undesirable consequences:</p>
<ul class="text">
<li>necessity for the translator to break the end-to-end encryption, typically by installing an addional Certificate Authority on the client's CA trust list
</li>
<li>noticeable increase in the processing power required on the address sharing device to decrypt and re-encrypt that application payload
</li>
</ul><p>


</p>
<p>
This specification avoids the problems described above, and defines the method of communicating the TCP client's identity to the TCP server by overloading the TCP timestamp field and IP Identifier field of the initial TCP SYN.&nbsp;&nbsp;

</p>
<p>
This extension is necessary because IP address sharing, deployed by NAT64 devices, will allow malicious users to connect to IPv4-capable servers.&nbsp; Thus, until a server is only accessible via IPv6 (and inaccessible via IPv4), the IPv4-capable server will suffer from an inability to identify individual TCP clients as discussed in <a class='info' href='#I-D.ietf-intarea-shared-addressing-issues'>I-D.ietf-intarea-shared-addressing-issues<span> (</span><span class='info'>Ford, M., Boucadair, M., Durand, A., Levis, P., and P. Roberts, &ldquo;Issues with IP Address Sharing,&rdquo; June&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;intarea&#8209;shared&#8209;addressing&#8209;issues].

</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Notational Conventions</h3>

<p>
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a class='info' href='#RFC2119'>RFC2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].

</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Description</h3>

<p>
This proposal leverages the common deployment of&nbsp; TCP timestamps and that a timestamp-aware TCP server will echo the timestamp..

</p>
<p>
The caveat with the above is that the remote peer must know in advance if the TCP client implements this technique or not -- the timestamp on the server side looks just the same. This could be resolved by manual configuration but that is impractical, so an automatic detection mechanism is proposed. The automatic mechanism&nbsp; calculates a hash over the values of interest and placing the result into another field. The receiver can then perform the same operation and verify. If the received and computed values match, then the TCP timestamp received does contain the encoded internal address. The verifier value is computed as a hash function over the mapped value encoded into the timestamp, address after translation, and the TCP initial sequence number - i.e. the sequence number within the SYN segment. The usage of the TCP initial sequence number allows to avoid the verifier value being almost always the same. The reason for doing so is to satisfy the protocol constraints of the field that is used to convey this value.

</p>
<p>
In order to find some place for storing this verification value, we make another observation: TCP SYN segments are generally rather small, and the minimum MTU on IPv4 is 576. Typical stacks send the TCP SYN with DF=1. Therefore, they would never be fragmented. This means we could use the 16-bit value of the IP ID to put the verifier value in. The verifier is dependent on the initial sequence number (ISN) -- which is should have some randomness properties as described in <a class='info' href='#RFC1948'>RFC1948<span> (</span><span class='info'>Bellovin, S., &ldquo;Defending Against Sequence Number Attacks,&rdquo; May&nbsp;1996.</span><span>)</span></a> [RFC1948], therefore the IP ID will be reasonably different to still serve its purpose even in the extremely unlikely case that the TCP SYN is fragmented.

</p>
<p>
Using a 16-bit value as a verifier gives 1 in 65536 chances (or, 0.0015%) probability of erroneously judging that the timestamp contains the encoded internal address. This may be insufficient assurance for some of the scenarios. Therefore, we calculate the verifier (referred to as VFY value) to be a 32-bit integer - and store 16 or more bits of this value - at the expense of storing less bits of Internal Address Mapping (iAM). However, we expect that the range of iAM for a single public translation would be relatively small - so, no information will be lost in this process.

</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Calculating the Internal Address Mapping</h3>

<p>
The main useful property of iAM is that it MUST stay the same for the same internal address unless the configuration on the translator has changed. Since the goal is to provide the stable mapping, rather than fully reveal the internal address, any method that has this property is acceptable - and the choice of it is left to the implementors of the translator. If the addresses to be translated are configured as a prefix, then the iAM can be obtained just by taking the host bits of the address within the prefix. If the assignment of these addresses is on an individual basis, then the simple enumeration might be used. If the internal addresses are assigned to the pool as set of subnets - then the combination of the two methods above (the host bits in the least significant part, and the enumeration in the most significant part) will give good results. This also stimulates allocation of the internal address in equal-sized chunks, which should make the maintenance of the network easier.

</p>
<p>
As a result, the calculation of the iAM on the outgoing SYN segment MUST return two values:

</p>
<p>
</p>
<ul class="text">
<li>iAM = Internal Address Mapping: a 32-bit unsigned integer
</li>
<li>siAM = Size of Internal Address Mapping, in bits: integer, allowed range 9..24 - this is the number of significant bits within the iAM.
</li>
</ul><p>


</p>
<p>
The minimum value of siAM being 9 was chosen based on the following logic:</p>
<ul class="text">
<li>having a room of 512 possible hosts allows to keep the property of iAM to not change during the smaller configuration changes, in case the pool is made up of individual hosts.
</li>
<li>the range 9..24 has exactly 16 possible values, which will be useful for encoding.
</li>
</ul><p>


</p>
<p>
By encoding only the significant bits of the internal address mapping the operator of the translator can minimize the probability of the error - all the unused bits are allocated for the value used to "fingerprint" the presence of the internal identifier. The more bits this "Verifier" value can contain - the less is the chance of accidental match - and erroneous record of the internal identifier when there is none.

</p>
<p>
The range from 9 bits to 24 bits allows to encode between 512 and 16777216 internal identifiers for a single public IP address.

</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Calculating the Verifier</h3>

<p>
The verifier is calculated as a 32-bit result of a hash function. This hash function is not expected to be cryptographically strong (the 'Security considerations' section explains why), however it should have good distribution, good collision resistance, good avalanche behavior and be fast and cheap to compute. These properties are satisfied by <a class='info' href='#URL.Murmur-hash'>Murmur hash<span> (</span><span class='info'>, &ldquo;Murmur hash,&rdquo; .</span><span>)</span></a> [URL.Murmur&#8209;hash] function, therefore it is the hash that we will use.

</p>
<p>
The calculation of the VFY is performed as follows:

</p>
<p>
VFY = murmur(iAM | AddrPub | siAM, TCP-ISN)

</p>
<p>
</p>
<ul class="text">
<li>iAM is included into the calculation as a 32 bit word.
</li>
<li>siAM is included into the hash calculation as a single byte. (TBD: the 'selector' referenced below might be a more natural number to check against, instead of siAM ?).
</li>
</ul><p>


</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Encoding of the VFY into the packet: IP ID encoding</h3>

<p>
The low 16 bits of the VFY are encoded in network order into the IP ID of the packet after translation. the remaining 16 bits form the "VFYhi" value, which we attempt to fit into the TSval along with the other information.

</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Encoding of the VFY into the packet: TSval encoding</h3>

<p>
The TCP timestamp field encodes the iAM and VFYhi as follows:</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|E E E E|S S S S| iAM MSB ... iAM LSB  | VFYhi MSB .. VFYhi LSB |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><p>


</p>
<p>
The range of siAM gives 16 possible ways to store iAM (along with the same number of degrees of assurance for the detection). In order to distinguish between those, we introduce the encoding selector (S) field, which will determine how the lower 24 bits are split between the iAM and the upper 16 bit of VFY. Note that the smallest value of siAM being 9, we will never be able to store the most significant bit of VFY.

</p>
<p>
The value of S is the number of zero-fill right-shift operations it would take on the low 24 bit in order to "normalize" the iAM - or, in other words, it is the number of bits of VFYhi stored within the timestamp.

</p>
<p>
Best practices in <a class='info' href='#I-D.ietf-tcpm-tcp-timestamps'>I-D.ietf-tcpm-tcp-timestamps<span> (</span><span class='info'>Gont, F., &ldquo;Reducing the TIME-WAIT state using TCP timestamps,&rdquo; June&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;tcpm&#8209;tcp&#8209;timestamps], mention that to reduce the TIME-WAIT state the timestamp value should be monotonously increasing across the connections with the same 5-tuple. To give the translators an opportunity to achieve this property, we reserve several most significant bits within the timestamp to signify the "Epoch" (E).This would require storing some additional state per 5-tuple, and the implementation of such a mechanism is outside of scope for this document. The implementations that do not implement the monotonously increasing timestamps, MUST keep the Epoch bits intact from the original value of the timestamp.

</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Operation of the mechanism</h3>

<p>
This section outlines the use of this mechanism by the translators and servers.

</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.1"></a><h3>8.1.&nbsp;
Translator Operation</h3>

<p>


</p>
<p>
The translator is involved into processing of the initial SYN segment (calculating the new version of the TCP timestamp and IP ID), as well as the SYN-ACK segments (restoring the original value of the TCP timestamp within the TSecr field).

</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.2"></a><h3>8.2.&nbsp;
Server Operation</h3>

<p>


</p>
<p>
The server would operate on every SYN that is of interest for the logging. It would extract the candidate iAM, and calculate the VFY value based on the public address and TCP ISN within the received SYN segment. Then it would compare the VFY against the corresponding bits in the TSval and IP ID fields. If there is a match, it means (with a reasonable probability) that the iAM was a valid one calculated by the translator inbetween.&nbsp; This information is stored for later access by the application listening on that socket (e.g., stored in the TCB).

</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Interaction with TCP SYN cookies</h3>

<p>
TCP SYN cookies are commonly deployed to mitigate TCP SYN attacks <a class='info' href='#RFC4987'>RFC4987<span> (</span><span class='info'>Eddy, W., &ldquo;TCP SYN Flooding Attacks and Common Mitigations,&rdquo; August&nbsp;2007.</span><span>)</span></a> [RFC4987]. The mechanism described in this document requires the server store extra information which arrives on the TCP SYN, which increases the TCP server's attack surface.&nbsp; To mitigate this, the translator should apply the similar algorithm to the timestamp of the ACK segment that is sent by the initiator of the connection in response to the server's SYN ACK. The authors considered that serverside might use the TSval in its SYN ACK segment, however this would interfere with the Extended syncookies. This section needs further discussion.

</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Other Mechanisms to Encode Client Identifier</h3>

<p>
This section outlines other mechanisms that we considered, and outlines the reasons we consider them not applicable.

</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1"></a><h3>10.1.&nbsp;
Defining a new TCP option to store the address</h3>

<p>


</p>
<p>
This would be the cleanest and simplest approach, and is discussed in [ I-D.wing-reveal-address].&nbsp;

</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2"></a><h3>10.2.&nbsp;
Using TSecr in TCP SYN</h3>

<p>


</p>
<p>
This value is set to zero, and is effectively unused - so it looks like a convenient place. However this violates the <a class='info' href='#RFC1323'>RFC1323<span> (</span><span class='info'>Jacobson, V., Braden, B., and D. Borman, &ldquo;TCP Extensions for High Performance,&rdquo; May&nbsp;1992.</span><span>)</span></a> [RFC1323], and this would require much more thorough testing - and update to <a class='info' href='#RFC1323'>RFC1323<span> (</span><span class='info'>Jacobson, V., Braden, B., and D. Borman, &ldquo;TCP Extensions for High Performance,&rdquo; May&nbsp;1992.</span><span>)</span></a> [RFC1323].

</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.3"></a><h3>10.3.&nbsp;
Reserving the different port ranges per client</h3>

<p>


</p>
<p>
This approach has an appeal due to its simplicity, but it would be specific to each NAPT device operated by each service provider.&nbsp; That is, there is no way to identify the device or know the source port range assigned to an TCP client without contacting the administrator of the NAPT device.&nbsp; Restricting clients to a specific range also exposes the clients to some security risk <a class='info' href='#I-D.ietf-tsvwg-port-randomization'>I-D.ietf-tsvwg-port-randomization<span> (</span><span class='info'>Larsen, M. and F. Gont, &ldquo;Transport Protocol Port Randomization Recommendations,&rdquo; August&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;tsvwg&#8209;port&#8209;randomization].

</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Security Considerations</h3>

<p>
The connections that happen, today, without aNAPT necessarily reveal the source address of the TCP client -- so revealing the identity of the client this should not be a concern except for the installations that attempt to use NAPT for "privacy" reasons. If such an installation exists, it is easy to see that any 1:1 remapping of e.g., IP ID would cause the failure of the validation algorithm - therefore "protecting the identity".&nbsp;

</p>
<p>
Therefore, if an organization has more than one level of NAPT and wants to ensure that the internal translators do not disclose the information about the internal addresses, it can alter any of the elements used for the calculations - e.g. randomize the ISN, or remap the IP ID.

</p>
<p>
An attacker might might use this functionality to appear as if IP address sharing is occuring, in the hopes that a naive server will allow additional attack traffic. TCP servers and applications SHOULD NOT assume the mere presence of the functionality described in this paper indicates there are other&nbsp; (benign) users sharing the same IP address.

</p>
<p>
The modification of the TSVal option value will break TCP-AO&nbsp; <a class='info' href='#RFC5925'>RFC5925<span> (</span><span class='info'>Touch, J., Mankin, A., and R. Bonica, &ldquo;The TCP Authentication Option,&rdquo; June&nbsp;2010.</span><span>)</span></a> [RFC5925], which provides integrity protection of the&nbsp; TCP SYN (including TCP options).&nbsp; However, TCP-AO is already known to not survive address sharing (through a NAPT or through an application&nbsp; proxy).&nbsp;&nbsp;

</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
IANA considerations</h3>

<p>
None.

</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
Acknowledgements</h3>

<p>
Thanks to Nicholas Leavy for the review.

</p>
<p>

</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>14.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC1323">[RFC1323]</a></td>
<td class="author-text"><a href="mailto:van@CSAM.LBL.GOV">Jacobson, V.</a>, <a href="mailto:Braden@ISI.EDU">Braden, B.</a>, and <a href="mailto:dab@cray.com">D. Borman</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1323">TCP Extensions for High Performance</a>,&rdquo; RFC&nbsp;1323, May&nbsp;1992 (<a href="http://www.rfc-editor.org/rfc/rfc1323.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5925">[RFC5925]</a></td>
<td class="author-text">Touch, J., Mankin, A., and R. Bonica, &ldquo;<a href="http://tools.ietf.org/html/rfc5925">The TCP Authentication Option</a>,&rdquo; RFC&nbsp;5925, June&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5925.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>14.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-intarea-shared-addressing-issues">[I-D.ietf-intarea-shared-addressing-issues]</a></td>
<td class="author-text">Ford, M., Boucadair, M., Durand, A., Levis, P., and P. Roberts, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-intarea-shared-addressing-issues-01.txt">Issues with IP Address Sharing</a>,&rdquo; draft-ietf-intarea-shared-addressing-issues-01 (work in progress), June&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-intarea-shared-addressing-issues-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-tcpm-tcp-timestamps">[I-D.ietf-tcpm-tcp-timestamps]</a></td>
<td class="author-text">Gont, F., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tcpm-tcp-timestamps-00.txt">Reducing the TIME-WAIT state using TCP timestamps</a>,&rdquo; draft-ietf-tcpm-tcp-timestamps-00 (work in progress), June&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-tcpm-tcp-timestamps-00.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-tsvwg-port-randomization">[I-D.ietf-tsvwg-port-randomization]</a></td>
<td class="author-text">Larsen, M. and F. Gont, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tsvwg-port-randomization-09.txt">Transport Protocol Port Randomization Recommendations</a>,&rdquo; draft-ietf-tsvwg-port-randomization-09 (work in progress), August&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-tsvwg-port-randomization-09.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1948">[RFC1948]</a></td>
<td class="author-text"><a href="mailto:smb@research.att.com">Bellovin, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1948">Defending Against Sequence Number Attacks</a>,&rdquo; RFC&nbsp;1948, May&nbsp;1996 (<a href="http://www.rfc-editor.org/rfc/rfc1948.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4987">[RFC4987]</a></td>
<td class="author-text">Eddy, W., &ldquo;<a href="http://tools.ietf.org/html/rfc4987">TCP SYN Flooding Attacks and Common Mitigations</a>,&rdquo; RFC&nbsp;4987, August&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4987.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="URL.Murmur-hash">[URL.Murmur-hash]</a></td>
<td class="author-text">&ldquo;<a href="http://sites.google.com/site/murmurhash/">Murmur hash</a>.&rdquo;</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Andrew Yourtchenko</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">cisco</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">6a de Kleetlaan</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Diegem  1831</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">BE</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+32 2 704 5494</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ayourtch@cisco.com">ayourtch@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dan Wing</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">cisco</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">170 West Tasman Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Jose  CA 95134</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:dwing@cisco.com">dwing@cisco.com</a></td></tr>
</table>
</body></html>
