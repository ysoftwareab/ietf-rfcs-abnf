<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Internal BGP as PE-CE protocol </title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Requirements Language">
<link href="#rfc.section.3" rel="Chapter" title="3 IP VPN network as a Route Server">
<link href="#rfc.section.4" rel="Chapter" title="4 Path attributes">
<link href="#rfc.section.5" rel="Chapter" title="5 BGP customer route attributes">
<link href="#rfc.section.6" rel="Chapter" title="6 Next-hop handling">
<link href="#rfc.section.7" rel="Chapter" title="7 Exchanging routes between different VPN customer networks">
<link href="#rfc.section.8" rel="Chapter" title="8 Deployment considerations">
<link href="#rfc.section.9" rel="Chapter" title="9 Security considerations">
<link href="#rfc.section.10" rel="Chapter" title="10 IANA considerations">
<link href="#rfc.section.11" rel="Chapter" title="11 Acknowledgments">
<link href="#rfc.references" rel="Chapter" title="12 References">
<link href="#rfc.references.1" rel="Chapter" title="12.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="12.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document defines protocol extensions and procedures for BGP PE-CE router iteration in " />
  <meta name="description" content="This document defines protocol extensions and procedures for BGP PE-CE router iteration in " />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">P. Marques</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">R. Raszuk</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">K. Patel</td>
</tr>
<tr>
<td class="left">Expires: November 03, 2011</td>
<td class="right">Cisco Systems</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">K. Kumaki</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">T. Yamagata</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">KDDI Corporation</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">May 02, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Internal BGP as PE-CE protocol <br />
  <span class="filename">draft-ietf-l3vpn-ibgp-05</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document defines protocol extensions and procedures for BGP PE-CE router iteration in <a href="#RFC4364">BGP/MPLS IP VPN</a> <cite title="NONE">[RFC4364]</cite> networks.  These have the objective of making the usage of the BGP/MPLS IP VPN transparent to the customer network, as far as routing information is concerned.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on November 03, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Requirements Language</a>
</li>
<li>3.   <a href="#rfc.section.3">IP VPN network as a Route Server</a>
</li>
<li>4.   <a href="#rfc.section.4">Path attributes</a>
</li>
<li>5.   <a href="#rfc.section.5">BGP customer route attributes</a>
</li>
<li>6.   <a href="#rfc.section.6">Next-hop handling</a>
</li>
<li>7.   <a href="#rfc.section.7">Exchanging routes between different VPN customer networks</a>
</li>
<li>8.   <a href="#rfc.section.8">Deployment considerations</a>
</li>
<li>9.   <a href="#rfc.section.9">Security considerations</a>
</li>
<li>10.   <a href="#rfc.section.10">IANA considerations</a>
</li>
<li>11.   <a href="#rfc.section.11">Acknowledgments</a>
</li>
<li>12.   <a href="#rfc.references">References</a>
</li>
<li>12.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>12.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">In current deployments, when BGP is used as the PE-CE routing protocol, these peering sessions are typically configured as an external peering between the VPN provider AS and the customer network AS.  At each External BGP boundary, <a href="#RFC4271">BGP Path Attributes</a> <cite title="NONE">[RFC4271]</cite> are modified as per standard BGP rules.  This includes prepending the AS_PATH attribute with the autonomous system of the originating customer CE and the autonomous system(s) of the provider edge router(s).</p>
<p id="rfc.section.1.p.2">In order for such routes not to be rejected by AS_PATH loop detection, a PE router advertising a route received from a remote PE, often remaps the customer network autonomous-system number to its own.  Otherwise the customer network can use different autonomous- system numbers at different sites or configure their CE routers to accept routes containing their own AS number.</p>
<p id="rfc.section.1.p.3">While this technique works well in situations where there are no BGP routing exchanges between the client network and other networks, it does have drawbacks for customer networks that use BGP internally for purposes other than interaction between CE and PE routers.</p>
<p id="rfc.section.1.p.4">In order to make the usage of BGP/MPLS VPN services as transparent as possible to any external interaction, it is desirable to define a mechanism by which PE-CE routers can exchange BGP routes by means other than external BGP.</p>
<p id="rfc.section.1.p.5">One can consider a BGP/MPLS VPN as a provider-managed backbone service interconnecting several customer-managed sites. While this model is not universal it does constitute a good starting point.</p>
<p id="rfc.section.1.p.6">Independently of the presence of VPN service, networks often use an hierarchical design utilizing either <a href="#RFC4456">BGP route reflection</a> <cite title="NONE">[RFC4456]</cite> or <a href="#RFC5065">confederations</a> <cite title="NONE">[RFC5065]</cite>.  This document assumes that the IP VPN service interacts with the customer network following a similar model.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Requirements Language</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">RFC 2119</a> <cite title="NONE">[RFC2119]</cite>.  </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> IP VPN network as a Route Server</h1>
<p id="rfc.section.3.p.1">In a typical backbone/area hierarchical design, routers that attach an area (or site) to the core, use BGP route reflection (or confederations) to distribute routes between the top-level core iBGP mesh and the local area iBGP cluster.</p>
<p id="rfc.section.3.p.2">To provide equivalent functionality in a network using a provider provisioned backbone, one can consider the VPN network as the equivalent of an Internal BGP Route Server which multiplexes information from _N_ VPN attachment points.</p>
<p id="rfc.section.3.p.3">A route learned by any of the PEs in the IP VPN network, is available to all other PEs that import the Route Target used to identify the customer network.  This is conceptually equivalent to a centralized route server.</p>
<p id="rfc.section.3.p.4">In a PE router, PE received routes are not advertised back to other PEs.  It is this split horizon technique that prevents routing loops in an IP VPN environment.  This is also consistent with the behavior of a top level mesh of RRs.  </p>
<p id="rfc.section.3.p.5">In order to complete the Route Server model, is necessary to be able to transparently carry the Internal BGP PATH attributes of customer network routes through the BGP/MPLS VPN core.  This is achieved by using a new BGP path attribute described below that allows the customer network attributes to be saved and restored at the BGP/MPLS VPN boundaries.</p>
<p id="rfc.section.3.p.6">When a route is advertised from PE to CE, if it is advertised as an iBGP route, the CE will not advertise it further unless it is itself configured as a Route Reflector (or has an external BGP session). This is a consequence of the default BGP behavior of not advertising iBGP routes back to iBGP peers.  This behavior is not modified.</p>
<p id="rfc.section.3.p.7">On a BGP/MPLS VPN PE, a CE-received route MUST be advertised to other VPN PEs that import the Route Targets which are associated with the route.  This is independent of whether the CE route has been received as an external or internal route.  However, a CE received route is not readvertised back to other CEs unless Route Reflection is explicitly configured.  This is the equivalent of disabling client to client reflection in BGP RR implementations.</p>
<p id="rfc.section.3.p.8">When reflection is configured on the PE router, with local CE routers as clients, there is no need to internally mesh multiple CEs that may exist in the site.</p>
<p id="rfc.section.3.p.9">This Route Server model can also be used to support a confederation style abstraction to CE devices.  We choose not to describe in detail the procedures for that mode of operation, at this point. Confederations are considered to be less common than route reflection in enterprise environments.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Path attributes</h1>
<div id="#rfc.figure.1"></div>
<pre>
                
          --&gt; push path attributes --&gt; vrf-export --&gt; 2547
VRF route                                             PE-PE route
                                                      advertisement
          &lt;--  pop path attributes &lt;--  vrf-import &lt;--
</pre>
<p id="rfc.section.4.p.1">The diagram above shows the BGP path attribute stack processing in relation to existing 2547 route processing procedures.  BGP path attributes received from a customer network are pushed into the stack, before adding the Export Route Targets to the BGP path attributes.  Conversely, the stack is poped after the Import Target processing step that identifies the VRF table in which a PE received route is accepted.</p>
<p id="rfc.section.4.p.2">When the advertising PE performs a "push" operation at the "vrf-export" processing stage it SHOULD initialize the attributes of the BGP IP VPN route advertisement as if for a locally originated route from the respective VRF context.  </p>
<p id="rfc.section.4.p.3">When a PE received route is imported into a VRF, its IGP metric, as far as BGP path selection is concerned, should be the metric to the remote PE address, expressed in terms of the service provider metric domain.</p>
<p id="rfc.section.4.p.4">For the purposes of VRF route selection performed at the PE, between routes received from local CEs and remote PEs, VPN network IGP metrics should always be considered higher (thus least preferred) than local site metrics.</p>
<p id="rfc.section.4.p.5">When backdoor links are present, this would tend to direct the traffic between two sites through the backdoor link for BGP routes originated by a remote site.  However BGP already has policy mechanisms to address this type of situations such as the LOCAL_PREF attribute.</p>
<p id="rfc.section.4.p.6">When a given CE is connected to more than one PE, it will not advertise the route that it receives from a PE to another PE unless configured as a route reflector, due to the standard BGP route advertisement rules.</p>
<p id="rfc.section.4.p.7">When a CE reflects a PE received route to another PE, the fact that the original attributes of a route are preserved across the VPN network prevents the formation of routing loops due to mutual redistribution between the two networks.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> BGP customer route attributes</h1>
<p id="rfc.section.5.p.1">In order to transparently carry the BGP Path Attributes of customer route, this document defines a new BGP Path Attribute: </p>
<p></p>

<ul class="empty">
<li>ATTR_SET (type code 128)</li>
<li>ATTR_SET is an optional transitive attribute that carries a set of BGP path attributes.  An attribute set (ATTR_SET) can include any BGP attribute that can occur in a BGP UPDATE message, except the MP_REACH and MP_UNREACH attributes. </li>
</ul>
<p id="rfc.section.5.p.3">The ATTR_SET attribute is encoded as follows:</p>
<div id="#rfc.figure.2"></div>
<pre>                
+------------------------------+
| Attr Flags (O|T) Code = 128  |
+------------------------------+
| Attr. Length (1 or 2 octets) |
+------------------------------+
| Origin AS (4 octets)         |
+------------------------------+
| Path attributes (variable)   |
+------------------------------+
</pre>
<p id="rfc.section.5.p.4">The attribute value consists on a 4 octet "origin AS" value followed by a variable length field which conforms to the BGP UPDATE message path attribute encoding rules.  The attribute length is 4 plus the total length of the encoded attributes.</p>
<p id="rfc.section.5.p.5">This attribute is used by a PE router to store the original set of BGP attributes it receives from a CE.  When a PE router advertises a PE-received route to a CE, it will use the path attributes carried in the ATTR_SET attribute.</p>
<p id="rfc.section.5.p.6">In other words, the BGP Path Attributes are "pushed" into this stack like attribute when the route is received by the VPN network and "popped" when the route is advertised in the PE to CE direction.</p>
<p id="rfc.section.5.p.7">Using this mechanism isolates the customer network from the attributes used in the VPN network and vice versa.  Attributes as the route reflection cluster list attribute are segregated such that customer network cluster identifiers won't be considered by the VPN network route reflectors and vice-versa.</p>
<p id="rfc.section.5.p.8">The Origin autonomous system number is designed to prevent a route originating in a given autonomous-system iBGP to be leaked into a different autonomous-system, without proper AS_PATH manipulation.  It should contain the autonomous system of the customer network that originates the given set of attributes.  The value is encoded as a 32-bit unsigned integer in network byte order, regardless of whether or not the originating PE supports <a href="#RFC4893">Four-octet AS Numbers</a> <cite title="NONE">[RFC4893]</cite>. </p>
<p id="rfc.section.5.p.9">The AS_PATH and AGGREGATOR attributes contained within an ATTR_SET attribute MUST be encoded using <a href="#RFC4893">Four-octet AS Numbers</a> <cite title="NONE">[RFC4893]</cite>, regardless of the capabilities advertised by the BGP speaker to which the ATTR_SET attribute is transmitted.  BGP speakers that support the extensions defined in this document must also support <a href="#RFC4893">RFC4893</a> <cite title="NONE">[RFC4893]</cite>.  The reason for this requirement is to remove ambiguity between two-octet and four-octet AS_PATH attribute encoding.</p>
<p id="rfc.section.5.p.10">The NEXT_HOP attribute SHOULD NOT be included in an ATTR_SET.  When present it should be ignored by the receiving PE.</p>
<p id="rfc.section.5.p.11">The ATTR_SET attribute SHALL be considered malformed if any of the following applies:</p>
<p></p>

<ul>
<li>Its length is less than 4 octets.</li>
<li>The original path attributes carried in the variable length attribute data include the MP_REACH or MP_UNREACH attribute.</li>
<li>The included attributes are malformed themselves.</li>
</ul>
<p id="rfc.section.5.p.13">An UPDATE message with a malformed ATTR_SET attribute SHALL be handled as follows. If its Partial flag is set and its Neighbor-Complete flag is clear, the UPDATE is treated as a route withdraw as discussed in <a href="#I-D.ietf-idr-optional-transitive">[I-D.ietf-idr-optional-transitive]</a>.  Otherwise (i.e. Partial flag is clear or Neighbor-Complete is set), the procedures of the <a href="#RFC4271">BGP-4 base specification</a> <cite title="NONE">[RFC4271]</cite> MUST be followed with respect to an Optional Attribute Error.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> Next-hop handling</h1>
<p id="rfc.section.6.p.1">When BGP/MPLS VPNs are not in use, the NEXT_HOP attribute in iBGP routes carries the address of the border router advertising the route into the domain.  The IGP distance to the NEXT_HOP of the route is an important component of BGP route selection.</p>
<p id="rfc.section.6.p.2">When a BGP/MPLS VPN service is used to provide interconnection between different sites, since the VPN network runs a different IGP domain, metrics between the VPN and customer networks are not comparable.</p>
<p id="rfc.section.6.p.3">However, the most important component of a metric is the inter-area metric, which is known to the VPN network.  The intra-area metric is typically negligible.</p>
<p id="rfc.section.6.p.4">The use of route reflection, for instance, requires metrics to be configured so that inter-cluster/area metrics are always greater than intra-cluster metrics.</p>
<p id="rfc.section.6.p.5">The approach taken by this document is to rewrite the NEXT_HOP attribute at the VRF import/export boundary. PE routers take into account the PE-PE IGP distance calculated by the VPN network IGP, when selecting between routes advertised from different PEs.</p>
<p id="rfc.section.6.p.6">An advantage of the proposed method is that the customer network can run independent IGPs at each site.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> Exchanging routes between different VPN customer networks</h1>
<p id="rfc.section.7.p.1">In the traditional model, where External BGP sessions are used between the BGP/MPLS VPN PE and CE, the PE router identifies itself as belonging to the VPN network autonomous-system.</p>
<p id="rfc.section.7.p.2">In order to use Internal BGP sessions the PE router has to identify itself as belonging to the Customer AS. More specifically, the VRF that is used to interconnect to that customer site is assigned to the Customer AS rather than the VPN provider AS.</p>
<p id="rfc.section.7.p.3">The Origin AS element in the ATTR_SET path attribute conveys the AS number of the originating VRF. This AS number is used in a receiving PE in order to identify route exchanges between VRFs in different ASes.</p>
<p id="rfc.section.7.p.4">In scenarios such as what is commonly referred to an "extranet" VPN, routes MAY be advertised to both internal and external VPN attachments, belonging to different autonomous systems.</p>
<div id="#rfc.figure.3"></div>
<pre>                

        +-----+                 +-----+
        | PE1 |-----------------| PE2 |
        +-----+                 +-----+
       /       \                   |
+-----+         +-----+         +-----+
| CE1 |         | CE2 |         | CE3 |
+-----+         +-----+         +-----+
  AS 1            AS 2            AS 1
</pre>
<p id="rfc.section.7.p.5">Consider the example given above where (PE1, CE1) and (PE2, CE3) sessions are iBGP.  In BGP/MPLS VPNs, a route received from CE1 above may be distributed to the VRFs corresponding to the attachment points for CEs 2 and 3.</p>
<p id="rfc.section.7.p.6">The desired result, in such a scenario is to present the internal peer (CE3) with a BGP advertisement that contains the same BGP Path Attributes received from CE1 and to the external peer (CE 2) a BGP advertisement that would correspond to a situation where AS 1 and 2 have an external BGP session between them.  </p>
<p id="rfc.section.7.p.7">It order to achieve this goal the following set of rules apply:</p>
<p></p>

<ul class="empty">
<li>When importing a VPN route that contains the ATTR_SET attribute into a destination VRF, a PE router MUST check that the autonomous-system contained in the ATTR_SET attribute matches the autonomous system associated with the VRF. </li>
<li>In case the autonomous-systems do match, the route is imported into the VRF with the attributes contained in the ATTR_SET attribute.  Otherwise, in the case of an autonomous-system mismatch, the set of attributes to be associated with the route shall be constructed as follows: </li>
<li><ol>
<li>The path attributes are set to the attributes contained in the ATTR_SET attribute.  </li>
<li>Internal BGP specific attributes are discarded (LOCAL_PREF, ORIGINATOR, CLUSTER_LIST, etc).  </li>
<li>The autonomous-system contained in the ATTR_SET attribute is prepended to the as-path following the rules that would apply to an external BGP peering between the source and destination ASes.  </li>
<li>If the autonomous-system associated with the VRF is the same as the VPN network autonomous-system, if the AS_PATH attribute of the VPN route is not empty, it SHALL be prepended to the AS_PATH attribute of the VRF route.  </li>
</ol></li>
<li>When advertising the VRF route to an Exterior BGP peer, a PE router shall apply steps 1 to 4 defined above and subsequently prepend its own autonomous-system number to the AS_PATH attribute. For example, if the route originated in a VRF that supports Internal BGP peering and the ATTR_SET attribute and is advertised to a CE that is configured in the traditional Exterior BGP mode then both the originator AS, the VPN AS_PATH segment and the VPN network AS are prepended to the AS_PATH.</li>
<li>When importing a route without the ATTR_SET attribute to a VRF that supports Interior BGP mode, a PE router MUST prepend its own as number to the AS_PATH. </li>
</ul>
<p id="rfc.section.7.p.9">In all cases where a route containing the ATTR_SET attribute is imported, attributes present on the VPN route other than the NEXT_HOP attribute are ignored, both from the point of view of route selection in the VRF Adj-RIB-in and route advertisement to a CE router. In order words, the information contained in ATTR_SET attribute overrides the VPN route attributes on "vrf-import".  </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Deployment considerations</h1>
<p id="rfc.section.8.p.1">It is recommend that different VRFs of the same VPN (i.e. in different PE routers) which are configured with iBGP PE-CE peering sessions use different Route Distinguisher values.  Otherwise (in the case where the same RD is used) the BGP IP VPN infrastructure may select a single BGP customer path for a given IP NLRI; without access to the detailed path information that is contained in the ATTR_SET attribute.</p>
<p id="rfc.section.8.p.2">As mentioned previously, the model for this service is a "Route Server" where the IP VPN provides the customer network with all the BGP paths known by the CEs.  This effectively implies the use of unique RDs per VRF.</p>
<p id="rfc.section.8.p.3">The stated goal of this extension is to isolate the customer network from the BGP path attribute operations performed by the IP VPN and conversely isolate the service provider network from any attributes injected by the customer.  For instance, BGP communities can be used to influence the behavior of the IP VPN infrastructure.  Using this extension, the service provider network can transparently carry these attributes without interference with its operations.</p>
<p id="rfc.section.8.p.4">Another example of unwanted interaction between customer and IP VPN BGP attributes is a scenario where the same Service Provider autonomous-system number is used both to provide Internet service as well as the IP VPN service.  In this case, it is not uncommon to have a VPN customer route contain the AS Number of the Service Provider. The IP VPN network should work transparently in this case as in all others.</p>
<p id="rfc.section.8.p.5">This protocol extension is designed to behave such that each PE VRF operates as a router in the configured AS. Previously VRFs operate in the VPN network AS only. The VPN backbone provides interconnection between VRFs of the same AS, as well as interconnection between different ASes (subject to the appropriate policies). When interconnecting VRFs in the same AS, the VPN backbone operates as a top level Route Reflection mesh. When interconnecting VRFs in different ASes, the VPN network provides an implicit peering relationship between the ASes that originate and import a specific route.</p>
<p id="rfc.section.8.p.6">This extension is also applicable to scenarios where the VPN backbone spans multiple ASes. When the VPN backbone Inter-AS operation follows option b) or c) as defined in Section 10 of <a href="#RFC4364">[RFC4364]</a>, the Provider networks are able to influence the route attributes and route selection of the VPN routes while providing a transparent service to the customer AS. Both internal BGP connectivity or extranets can be provided to the customer AS.</p>
<p id="rfc.section.8.p.7">When VPN Provider networks interconnect via option a), there is no possibility of providing a fully transparent service. By definition option a) implies that each ASBR has a VRF associated with the customer VPN that is configured to operate in the respective Provider AS. These ASBR VRFs then communicate via eBGP with their peer Provider ASes.</p>
<p id="rfc.section.8.p.8">In this case it is still possible to have all the customer VRFs with one Provider network to be configured in the same customer AS. This customer AS will then peer with the Provider AS implicitly at the ABSR. Which will in turn peer explicitly with a second Provider AS. This is not however a scenario in which transparency to the customer AS is possible.  </p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> Security considerations</h1>
<p id="rfc.section.9.p.1">It is worthwhile to consider the security implications of this proposal from two independent perspectives: the IP VPN provider and the IP VPN customer.  </p>
<p id="rfc.section.9.p.2">From an IP VPN provider perspective, this mechanism will assure separation between the BGP path attributes advertised by the customer CE router and the BGP attributes used within the provider network, thus potentially improving security.  </p>
<p id="rfc.section.9.p.3">Although this behavior is largely implementation dependent, currently it is possible for a CE device to inject BGP attributes (extended communities, for example) that have semantics on the IP VPN provider network, unless explicitly disabled by configuration in the PE.  </p>
<p id="rfc.section.9.p.4">With the rules specified for the ATTR_SET path attribute, any attribute that has been received from a CE is pushed into the stack before the route is advertised out to other PEs.  </p>
<p id="rfc.section.9.p.5">From the perspective of the VPN customer network, it is our opinion that there is no change to the security profile of PE-CE interaction. While having an iBGP session allows the PE to specify additional attributes not allowed on an eBGP session (e.g. local-pref), this does not significantly change the fact that the VPN customer must trust its service provider to provide it correct routing information.  </p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> IANA considerations</h1>
<p id="rfc.section.10.p.1">This document defines a new BGP path attribute which is part of a registry space managed by IANA.  We request that IANA update its BGP Path Attributes registry with the value specified above (128) for the ATTR_SET path attribute.  </p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> Acknowledgments</h1>
<p id="rfc.section.11.p.1">The authors would like to thank Stephane Litkowski and Bruno Decraene for their comments.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">12.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">12.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4271">[RFC4271]</b></td>
<td class="top">
<a>Rekhter, Y.</a>, <a>Li, T.</a> and <a>S. Hares</a>, "<a href="http://tools.ietf.org/html/rfc4271">A Border Gateway Protocol 4 (BGP-4)</a>", RFC 4271, January 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4364">[RFC4364]</b></td>
<td class="top">
<a>Rosen, E.</a> and <a>Y. Rekhter</a>, "<a href="http://tools.ietf.org/html/rfc4364">BGP/MPLS IP Virtual Private Networks (VPNs)</a>", RFC 4364, February 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4893">[RFC4893]</b></td>
<td class="top">
<a>Vohra, Q.</a> and <a>E. Chen</a>, "<a href="http://tools.ietf.org/html/rfc4893">BGP Support for Four-octet AS Number Space</a>", RFC 4893, May 2007.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4456">[RFC4456]</b></td>
<td class="top">
<a>Bates, T.</a>, <a>Chen, E.</a> and <a>R. Chandra</a>, "<a href="http://tools.ietf.org/html/rfc4456">BGP Route Reflection: An Alternative to Full Mesh Internal BGP (IBGP)</a>", RFC 4456, April 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5065">[RFC5065]</b></td>
<td class="top">
<a>Traina, P.</a>, <a>McPherson, D.</a> and <a>J. Scudder</a>, "<a href="http://tools.ietf.org/html/rfc5065">Autonomous System Confederations for BGP</a>", RFC 5065, August 2007.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">12.2.</a> Informative References</h1>
<table><tbody><tr>
<td class="reference"><b id="I-D.ietf-idr-optional-transitive">[I-D.ietf-idr-optional-transitive]</b></td>
<td class="top">
<a>Scudder, J</a>, <a>Chen, E</a>, <a>Mohapatra, P</a> and <a>K Patel</a>, "<a href="http://tools.ietf.org/html/draft-ietf-idr-optional-transitive-04">Revised Error Handling for BGP UPDATE Messages</a>", Internet-Draft draft-ietf-idr-optional-transitive-04, October 2011.</td>
</tr></tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Pedro Marques</span> 
	  <span class="n hidden">
		<span class="family-name">Marques</span>
	  </span>
	</span>
	<span class="org vcardline"></span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:pedro.r.marques@gmail.com">pedro.r.marques@gmail.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Robert Raszuk</span> 
	  <span class="n hidden">
		<span class="family-name">Raszuk</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  <span>170 W. Tasman Dr.</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">CA</span> 
		<span class="code">95134</span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:raszuk@cisco.com">raszuk@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Keyur Patel</span> 
	  <span class="n hidden">
		<span class="family-name">Patel</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  <span>170 W. Tasman Dr.</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">CA</span> 
		<span class="code">95134</span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:keyupate@cisco.com">keyupate@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Kenji Kumaki</span> 
	  <span class="n hidden">
		<span class="family-name">Kumaki</span>
	  </span>
	</span>
	<span class="org vcardline">KDDI Corporation</span>
	<span class="adr">
	  <span>Garden Air Tower</span>
<span>Iidabashi</span>

	  <span class="vcardline">
		<span class="locality">Chiyoda-ku</span>,  
		<span class="region">Tokyo</span> 
		<span class="code">102-8460</span>
	  </span>
	  <span class="country-name vcardline">Japan</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ke-kumaki@kddi.com">ke-kumaki@kddi.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Tomohiro Yamagata</span> 
	  <span class="n hidden">
		<span class="family-name">Yamagata</span>
	  </span>
	</span>
	<span class="org vcardline">KDDI Corporation</span>
	<span class="adr">
	  <span>Garden Air Tower</span>
<span>Iidabashi</span>

	  <span class="vcardline">
		<span class="locality">Chiyoda-ku</span>,  
		<span class="region">Tokyo</span> 
		<span class="code">102-8460</span>
	  </span>
	  <span class="country-name vcardline">Japan</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:to-yamagata@kddi.com">to-yamagata@kddi.com</a></span>

  </address>
</div>

</body>
</html>