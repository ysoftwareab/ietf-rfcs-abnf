<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>ENUM Implementation Issues and Experiences</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="ENUM Implementation Issues and Experiences">
<meta name="keywords" content="DNS, E.164, NAPTR, Experiences, Internet-Draft, Implementation">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">ENUM</td><td class="header">L. Conroy</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">RMRL</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">K. Fujiwara</td></tr>
<tr><td class="header">Expires: May 25, 2009</td><td class="header">JPRS</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">November 21, 2008</td></tr>
</table></td></tr></table>
<h1><br />ENUM Implementation Issues and Experiences<br />&lt;draft-ietf-enum-experiences-11.txt&gt;</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on May 25, 2009.</p>

<h3>Abstract</h3>

<p>This document captures experience in implementing systems based on the ENUM protocol, and experience of ENUM data that have been created by others. As such, it clarifies the ENUM and Dynamic Delegation Discovery System standards. Its aim is to help others by reporting what is "out there" and the potential pitfalls in interpreting the set of documents that specify the protocol. It does not revise the standards, but it is intended to provide technical input to future revisions of those documents.

</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#Terminology">1.</a>&nbsp;
Terminology<br />
<a href="#I-D-Intro">2.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#InTheVainHopeThatTheIlliterateWillReadBeforeHowling">2.1.</a>&nbsp;
Document Goal<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#TheStorySoFar">2.2.</a>&nbsp;
Changes since last version<br />
<a href="#CharacterSets">3.</a>&nbsp;
Character Sets and ENUM<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#SpeakEnglishOrDie">3.1.</a>&nbsp;
Character Sets - Non-ASCII considered harmful<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#regexpSyntaxIsHideous">3.1.1.</a>&nbsp;
Non-ASCII in Regular expression Field<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#nonASCIIconclusions">3.1.2.</a>&nbsp;
Non-ASCII Support - Conclusions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#CaseSens">3.2.</a>&nbsp;
Case Sensitivity<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#RegexpFieldDelim">3.3.</a>&nbsp;
Regexp field delimiter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#RegexpMetaChar">3.4.</a>&nbsp;
Regexp Meta-character Issue<br />
<a href="#dislikedNAPTRs">4.</a>&nbsp;
Unsupported NAPTRs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#duffClients">4.1.</a>&nbsp;
Non-compliant client behaviour<br />
<a href="#OrderPriority">5.</a>&nbsp;
ENUM NAPTR Processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#noncom">5.1.</a>&nbsp;
Common Non-Compliant ENUM Processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#noncomexample">5.1.1.</a>&nbsp;
Example<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#OrderGeneral">5.2.</a>&nbsp;
Order/Priority values - Processing sequence<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ORDERPREForder">5.3.</a>&nbsp;
Use of Order and Preference fields<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#IdenticalOrderPrio">5.4.</a>&nbsp;
NAPTRs with identical ORDER/PRIORITY values<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#CompoundNAPTRSort">5.4.1.</a>&nbsp;
Compound NAPTRs and implicit ORDER/REFERENCE Values<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#OrderAcrossZones">5.5.</a>&nbsp;
Processing Order value across Domains<br />
<a href="#NonTerminalNAPTRs">6.</a>&nbsp;
Non-Terminal NAPTR Processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#NonTerminalsConsideredHarmful">6.1.</a>&nbsp;
Non-Terminal NAPTRs - necessity<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#NonTerminalImplementation">6.2.</a>&nbsp;
Non-Terminal NAPTRs - considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#NonTerminalNAPTRGen">6.2.1.</a>&nbsp;
Non-Terminal NAPTRs - general<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#NonTerminalNAPTRLoops">6.2.2.</a>&nbsp;
Non-Terminal NAPTRs - loop detection and response<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#DecodingTheGibberish">6.2.3.</a>&nbsp;
Field content in Non-Terminal NAPTRs<br />
<a href="#BackwardsCompat">7.</a>&nbsp;
Backwards Compatibility<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#SvcFieldSyntax">7.1.</a>&nbsp;
Services field syntax<br />
<a href="#provSysImplications">8.</a>&nbsp;
Collected Implications for ENUM Provisioning<br />
<a href="#clientImplications">9.</a>&nbsp;
Collected Implications for ENUM clients<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ntn4clients">9.1.</a>&nbsp;
Non-terminal NAPTR processing<br />
<a href="#Sec-Cons">10.</a>&nbsp;
Security Considerations<br />
<a href="#IANA-Cons">11.</a>&nbsp;
IANA Considerations<br />
<a href="#Acknowledgements">12.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">13.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">13.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">13.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="Terminology"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="I-D-Intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Introduction</h3>

<a name="InTheVainHopeThatTheIlliterateWillReadBeforeHowling"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
Document Goal</h3>

<p>The goal of this document is to clarify the ENUM and Dynamic Delegation Discovery System (DDDS) standards. It does not itself revise ENUM or DDDS standards, but is intended to provide technical input to future revisions of those documents.

It also serves to advise implementers on the pitfalls that they may find. It highlights areas where ENUM implementations have differed over interpretation of the standards documents, or have outright failed to implement some features as specified.
</p>
<p>As well as clarifications to standards text, this document also mentions potential choices that can be made, in an attempt to help to foster interworking between components that use this protocol. The reader is reminded that others may make different choices.
</p>
<p>The core specifications for the E.164 Number Mapping (ENUM) protocol (<a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>) and the Dynamic Delegation Discovery System (DDDS, <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> <a class='info' href='#RFC3401'>[RFC3401]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part One: The Comprehensive DDDS,&rdquo; October&nbsp;2002.</span><span>)</span></a> <a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a> <a class='info' href='#RFC3404'>[RFC3404]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Four: The Uniform Resource Identifiers (URI),&rdquo; October&nbsp;2002.</span><span>)</span></a> <a class='info' href='#RFC3405'>[RFC3405]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Five: URI.ARPA Assignment Procedures,&rdquo; October&nbsp;2002.</span><span>)</span></a>) are defined elsewhere. Unfortunately, this document cannot provide an overview of the specifications, so the reader is assumed to have read and understood the complete set of ENUM normative documents.
</p>
<p>The Domain Name System (DNS) is ENUM's database. ENUM uses the NAPTR (Naming Authority Pointer) resource record type to store its DDDS rules into DNS domains. ENUM relies on DNS services. Thus it is also important for ENUM implementers to carry out a thorough analysis of all of the existing DNS standard documents to understand what services are provided to ENUM, and the load that ENUM provisioning and queries will place on DNS.
</p>
<p>A great deal of the rationale for making the choices listed in this document is available to those who explore the standards. The trick of course is in understanding those standards and the subtle implications that are involved in some of their features. In almost all cases, the choices presented here are merely selections from values that are permissible within the standards.
</p>
<a name="TheStorySoFar"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Changes since last version</h3>

<p>----[RFC Editor: This section to be removed before publication]----
<br />

V10-V11: Further clarification, particularly of order/preference processing, and a few stray typos were removed.
</p>
<p>V9-V10: Revisions to cover IESG discussions - document goal has been re-clarified, acronym expansions updated, strengths adjusted to reflect the standards correctly, text pre-phrased in several places, text on non-ASCII characters sharpened and spelt out as operational issue only, mentioned expected clarification to service field syntax text in future revision of ENUM, forward references to Security Considerations added, ENUM processing sequence (ORDER/PREFERENCE issues) section extensively re-written, and added new sub-section highlighting that some common behaviour is non-compliant, and explaining rationale for this behaviour.
</p>
<p>V8-V9: After AD review - emphasised document role as clarification, and de-emphasised input to standard revision. Corrected more typos, and simplified phrasing are re-structured slightly.
</p>
<p>V7-V8: Minor textual changes have been made as a result of GEN-ART and LC comments. The IANA requirement has been clarified, as has non-terminal loop detection. Several cases of non-compliant behaviour have been made explicit; these were implied but not stated in earlier versions.
</p>
<p>V6-V7: The previous version classified its advice in terms of potential clarifications to standards, reminders of existing standards, advice on encountered client and provisioning (mis-)behaviours, and recommendations to improve interworking. Each proposal was "tagged" to show the kind of recommendation made. These hints have been removed in this version; they didn't help. This document supports implementers of ENUM clients that consume E2U Naming Authority Pointer (NAPTR) data published in DNS, and those who design systems to provision data into those zones, by helping them make choices on values and implementation strategies. To make this clearer, this version has collected the recommendations for Provisioning systems and Clients in their own sections.
</p>
<a name="CharacterSets"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Character Sets and ENUM</h3>

<a name="SpeakEnglishOrDie"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Character Sets - Non-ASCII considered harmful</h3>

<p><a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> and <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> specify respectively that ENUM and NAPTRs (Naming Authority Pointer resource records) support Unicode using the UTF-8 encoding defined in <a class='info' href='#RFC3629'>[RFC3629]<span> (</span><span class='info'>Yergeau, F., &ldquo;UTF-8, a transformation format of ISO 10646,&rdquo; November&nbsp;2003.</span><span>)</span></a>. This raises an issue where implementations use "single byte" string processing routines. If there are multi-byte characters within an ENUM NAPTR, incorrect processing may well result from these UTF-8 unaware systems.
</p>
<p>The UTF-8 encoding has a "US-ASCII equivalent range", so that all characters in US-ASCII <a class='info' href='#ASCII'>[ASCII]<span> (</span><span class='info'>American National Standards Institute, &ldquo;Coded Character Set - 7-bit American Standard Code for Information Interchange,&rdquo; 1986.</span><span>)</span></a> from 0x00 to 0x7F hexadecimal have an identity map to the UTF-8 encoding; the encodings are the same. In UTF-8, characters with Unicode code points above this range will be encoded using more than one byte, all of which will be in the range 0x80 to 0xFF hexadecimal. Thus it is important to consider the different fields of a NAPTR and whether or not multi-byte characters can or should appear in them.
</p>
<p>In addition, characters in the "non-printable" portion of US-ASCII (0x00 to 0x1F hexadecimal, plus 0x7F hexadecimal) are "difficult". Although NAPTRs are processed by machine, they may sometimes need to be written in a "human readable" form. Specifically, if NAPTR content is shown to an end user so that he or she may choose, it is imperative that the content is human readable. Thus it is unwise to use non-printable characters even if they lie within the US-ASCII range; the ENUM client may have good reason to reject NAPTRs that include these characters as they cannot readily be presented to an end-user.
</p>
<p>There are two numeric fields in a NAPTR; the ORDER and PREFERENCE/PRIORITY fields. As these contain binary values, no risk is involved as string processing should not be applied to them. The string-based fields are the Flags, Services, and Regexp fields. The Replacement field holds an uncompressed domain name encoded according to the standard DNS mechanism <a class='info' href='#RFC1034'>[RFC1034]<span> (</span><span class='info'>Mockapetris, P., &ldquo;Domain names - concepts and facilities,&rdquo; November&nbsp;1987.</span><span>)</span></a><a class='info' href='#RFC1035'>[RFC1035]<span> (</span><span class='info'>Mockapetris, P., &ldquo;Domain names - implementation and specification,&rdquo; November&nbsp;1987.</span><span>)</span></a>. Internationalized Domain Name (IDN) can be supported (as specified in <a class='info' href='#RFC3490'>[RFC3490]<span> (</span><span class='info'>Faltstrom, P., Hoffman, P., and A. Costello, &ldquo;Internationalizing Domain Names in Applications (IDNA),&rdquo; March&nbsp;2003.</span><span>)</span></a>, <a class='info' href='#RFC3491'>[RFC3491]<span> (</span><span class='info'>Hoffman, P. and M. Blanchet, &ldquo;Nameprep: A Stringprep Profile for Internationalized Domain Names (IDN),&rdquo; March&nbsp;2003.</span><span>)</span></a>, and <a class='info' href='#RFC3492'>[RFC3492]<span> (</span><span class='info'>Costello, A., &ldquo;Punycode: A Bootstring encoding of Unicode for Internationalized Domain Names in Applications (IDNA),&rdquo; March&nbsp;2003.</span><span>)</span></a>). Any such  IDN MUST be further encoded using Punycode <a class='info' href='#RFC3492'>[RFC3492]<span> (</span><span class='info'>Costello, A., &ldquo;Punycode: A Bootstring encoding of Unicode for Internationalized Domain Names in Applications (IDNA),&rdquo; March&nbsp;2003.</span><span>)</span></a>. As the Replacement field holds a domain name that is not subject to replacement or modification (other than Punycode processing), it is not of concern here.
</p>
<p>Taking the string fields in turn, the Flags field contains characters that indicate the disposition of the NAPTR. This may be empty, in which case the NAPTR is "non-terminal", or it may include a flag character as specified in <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>. These characters all fall into the printable US-ASCII equivalent range, so multi-byte characters cannot occur.
</p>
<p>The Services field includes the DDDS Application identifier ("E2U") used for ENUM, the '+' character used to separate Enumservices and this application identifier, and a set of Enumservice identifiers, any of which may embed the ':' separator character. In section 2.4.2 of <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> these identifier tokens are specified as 1*32 ALPHA/DIGIT, so there is no possibility of non-ASCII characters in the Services field.
</p>
<a name="regexpSyntaxIsHideous"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.1"></a><h3>3.1.1.&nbsp;
Non-ASCII in Regular expression Field</h3>

<p>The Regexp field is more complex. It forms a sed-like substitution expression, defined in <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a>, and consists of two sub-fields:
</p>
<ul class="text">
<li>the POSIX Extended Regular Expression (ERE) sub-field <a class='info' href='#IEEE.1003-2.1992'>[IEEE.1003&#8209;2.1992]<span> (</span><span class='info'>Institute of Electrical and Electronics Engineers, &ldquo;Information Technology - Portable Operating System Interface (POSIX) - Part 2: Shell and Utilities (Vol. 1),&rdquo; January&nbsp;1993.</span><span>)</span></a>
</li>
<li>a replacement (Repl) sub-field <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a>.
</li>
</ul><p>

</p>
<p>Additionally, <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> specifies that a flag character may be appended, but the only flag currently defined there (the 'i' case insensitivity flag) is not appropriate for ENUM - see later in this document.
</p>
<p>The ERE sub-field matches against the "Application Unique String"; for ENUM, this is defined in <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> to consist of digit characters, with an initial '+' character.  It is similar to a global-number-digits production of a tel: URI, as specified in <a class='info' href='#RFC3966'>[RFC3966]<span> (</span><span class='info'>Schulzrinne, H., &ldquo;The tel URI for Telephone Numbers,&rdquo; December&nbsp;2004.</span><span>)</span></a>, but with visual-separators removed.  In short, it is a telephone number (see [E.164]) in restricted format.  All of these characters fall into the US-ASCII equivalent range of UTF-8 encoding, as do the characters significant to the ERE processing.
</p>
<p>Strictly, the ERE might include other characters. The ERE could include choice elements matching against different items, some of which might not be an ENUM Application Unique String. Those alternative matching elements might conceivably include non-ASCII characters. As an operational issue, it is not reasonable to include such constructs as ENUM NAPTRs match against telephone numbers.
</p>
<p>In the normal situation in which E2U NAPTRs are provisioned in ENUM domains, there will be no multi-byte characters within this sub-field as the ERE will be intended to match against telephone numbers. ENUM clients must be able to handle NAPTRs that do contain such multi-byte characters (as the standard does not preclude them), but there is no operational reason for these ever being provisioned in ENUM domains. If NAPTRs provisioned in ENUM domains are encountered containing such multi-byte characters, these could reasonably be discarded.
</p>
<p>The Repl sub-field can include a mixture of explicit text used to construct a URI and characters significant to the substitution expression, as defined in <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a>. Whilst the latter set all fall into the US-ASCII equivalent range of UTF-8 encoding, this might not be the case for all conceivable text used to construct a URI. Presence of multi-byte characters could complicate URI generation and processing routines.
</p>
<p>URI generic syntax is defined in <a class='info' href='#RFC3986'>[RFC3986]<span> (</span><span class='info'>Berners-Lee, T., Fielding, R., and L. Masinter, &ldquo;Uniform Resource Identifier (URI): Generic Syntax,&rdquo; January&nbsp;2005.</span><span>)</span></a> as a sequence of characters chosen from a limited subset of the repertoire of US-ASCII characters. The current URIs use the standard URI character escaping rules specified in the URI generic syntax, and so any multi-byte characters will be pre-processed; they will not occur in the explicit text used to construct a URI within the Repl sub-field.
</p>
<a name="future IRIs"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.1.1"></a><h3>3.1.1.1.&nbsp;
Impact of Future Support for IRIs</h3>

<p>As currently specified, ENUM only permits URIs to be generated in the Regexp field. However, even if this were to be extended in future revisions of the ENUM specification to allow the use of Internationalised Resource Identifiers (IRI, defined in <a class='info' href='#RFC3987'>[RFC3987]<span> (</span><span class='info'>Duerst, M. and M. Suignard, &ldquo;Internationalized Resource Identifiers (IRIs),&rdquo; January&nbsp;2005.</span><span>)</span></a>), further support for non-ASCII characters may be avoided.

The IRI is defined as extending the syntax of URIs, and specifies a mapping from an IRI to a URI. IRI syntax allows characters with multi-byte UTF-8 encoding.
</p>
<p>Given that this is the only place within an ENUM NAPTR where such multi-byte encodings might reasonably be found, a simple solution is to use the mapping method specified in section 3.1 of <a class='info' href='#RFC3987'>[RFC3987]<span> (</span><span class='info'>Duerst, M. and M. Suignard, &ldquo;Internationalized Resource Identifiers (IRIs),&rdquo; January&nbsp;2005.</span><span>)</span></a> to convert any IRI into its equivalent URI.
</p>
<p>This process consists of two elements; the domain part of an IRI MUST be processed using Punycode if it has a non-ASCII domain name, and the remainder MUST be processed using the extended escaping rules specified in the IRI document if it contains characters outside the normal URI repertoire. Using this process, there will be no non-ASCII characters in any part of any URI, even if it has been converted from an IRI that contains such characters.
</p>
<a name="nonASCIIconclusions"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.2"></a><h3>3.1.2.&nbsp;
Non-ASCII Support - Conclusions</h3>

<p>From the analysis just given, the only place within an ENUM NAPTR where non-ASCII characters might be found is the Regexp field. It is possible to remove any requirement to process characters outside the US-ASCII equivalent range by adding very few operational restrictions.  There is no obvious benefit in providing characters outside this range. Handling multi-byte characters complicates development and operation of client programs, and many existing programs do not include such support.
</p>
<p>As the gain from permitting characters outside the US-ASCII equivalent range is unclear, and the costs of multi-byte character processing are very clear, ENUM NAPTRs SHOULD NOT include characters outside the printable US-ASCII equivalent range.
</p>
<a name="CaseSens"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Case Sensitivity</h3>

<p>The only place where NAPTR field content is case sensitive is in any static text in the Repl sub-field of the Regexp field. Everywhere else, case insensitive processing can be used.
</p>
<p>The case insensitivity flag ('i') could be added at the end of the Regexp field. However, in ENUM, the ERE sub-field operates on a string defined as the '+' character, followed by a sequence of digit characters. This flag is redundant for E2U NAPTRs, as it does not act on the Repl sub-field contents.
</p>
<p>Thus the case sensitivity flag is inappropriate for ENUM, and SHOULD NOT be provisioned into E2U NAPTRs.
</p>
<a name="RegexpFieldDelim"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Regexp field delimiter</h3>

<p>It is not possible to select a delimiter character that cannot appear in one of the sub-fields. The '!' character is used as a delimiter in all of the examples in <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> and in <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>. It is the only character seen in existing zones, and a number of different client implementations are still "hardwired" to expect this character as a delimiter.
</p>
<p>The '!' character will not normally appear in the ERE sub-field. It may appear in the content of some URIs, as it is a valid character (e.g. in http URLs). If it is present in the Regexp field, then that instance MUST be escaped using the standard technique proposed in section 3.2 of <a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a>; a backslash character (U+005C) should be inserted before it in the string. Otherwise, a client may attempt to process this as a standard delimiter and interpret the Regexp field contents differently from the system that provisioned it.
</p>
<a name="RegexpMetaChar"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
Regexp Meta-character Issue</h3>

<p>In ENUM, the ERE sub-field may include a literal character '+', as the Application Unique String on which it operates includes this. However, if it is present, then '+' MUST be escaped using a single backslash character (to produce the sub-string U+005C U+002B), as '+' is a meta-character in POSIX Extended Regular Expression syntax.
</p>
<p>Not escaping the '+' character produces an invalid ERE, but is a common mistake. Even standards have given incorrect examples; the obsolete <a class='info' href='#RFC2916'>[RFC2916]<span> (</span><span class='info'>Faltstrom, P., &ldquo;E.164 number and DNS,&rdquo; September&nbsp;2000.</span><span>)</span></a> (Section 3.4.3 example 3) has this problem.
</p>
<p>For example, the following NAPTR example is incorrect:<br />

* IN NAPTR 100 10 "u" "E2U+sip" "!^+4655(.*)$!sip:\\1@example.net!" .
</p>
<p>A correct way to write this example is:<br />

* IN NAPTR 100 10 "u" "E2U+sip" "!^\\+4655(.*)$!sip:\\1@example.net!"<br />

&nbsp;&nbsp;&nbsp;&nbsp;.
</p>
<p>Note that when a NAPTR RR is shown in DNS master file syntax (as in this example above), the backslash itself must be escaped using a second backslash. The DNS on-the-wire packet will have only a single backslash.
</p>
<a name="dislikedNAPTRs"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Unsupported NAPTRs</h3>

<p>An ENUM client MAY discard a NAPTR received in response to an ENUM query because:
</p>
<ul class="text">
<li>the NAPTR is syntactically or semantically incorrect,
</li>
<li>the NAPTR has a different (non-empty) DDDS Application identifier from the 'E2U' used in ENUM,
</li>
<li>the NAPTR's ERE does not match the Application Unique String for this ENUM query,
</li>
<li>the ENUM client does not recognise any Enumservice held in this NAPTR, or
</li>
<li>this NAPTR (only) contains an Enumservice that is unsupported.
</li>
</ul>

<p>These conditions SHOULD NOT cause the whole ENUM query to terminate, and processing SHOULD continue with the next NAPTR in the returned Resource Record Set (RRSet).
</p>
<p>When an ENUM client encounters a compound NAPTR (i.e. one containing more than one Enumservice - see also <a class='info' href='#CompoundNAPTRSort'>Section&nbsp;5.4.1<span> (</span><span class='info'>Compound NAPTRs and implicit ORDER/REFERENCE Values</span><span>)</span></a>) and cannot process or cannot recognise one of the Enumservices within it, that ENUM client SHOULD ignore this Enumservice and continue with the next Enumservice within this NAPTR's Services field, discarding the NAPTR only if it cannot handle any of the Enumservices contained.  These conditions SHOULD NOT be considered errors.
</p>
<p>ENUM uses regular expression processing when generating URIs from the REGEXP field of "terminal" NAPTRs. In common with all uses of regular expressions, there is a potential for buffer overrun when generating this output. There may be repeated back-reference patterns in a NAPTR's Repl sub-field, and the output these generate may consume a considerable amount of buffer space.
</p>
<p>Even if an ENUM client would normally encounter only NAPTRs with short URIs, it may also receive NAPTRs with repeated back-reference patterns in their Repl sub-fields that could generate strings longer than the client's buffer. Such NAPTRs may have been misconfigured accidentally or by design. The client MUST NOT fail in this case. It SHOULD NOT discard the entire ENUM query, but instead just discard the NAPTR that would otherwise have caused this overrun.
</p>
<p>If a problem is detected when processing an ENUM query across multiple domains (by following non-terminal NAPTR references), then the ENUM query SHOULD NOT be abandoned, but instead processing SHOULD continue at the next NAPTR after the non-terminal NAPTR that referred to the domain in which the problem would have occurred. See <a class='info' href='#NonTerminalNAPTRLoops'>Section&nbsp;6.2.2<span> (</span><span class='info'>Non-Terminal NAPTRs - loop detection and response</span><span>)</span></a> for more details.
</p>
<a name="duffClients"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Non-compliant client behaviour</h3>

<p>From experience monitoring current ENUM clients, a number of non-compliant behaviours have been detected. These behaviours are incorrect, but may be encountered in still operational client implementations.
</p>
<p>ENUM clients have been known to discard NAPTRs in which the Services field holds more than one Enumservice.
</p>
<p>ENUM clients have also been known to discard NAPTRs with a "non-greedy" ERE sub-field expression (i.e. EREs that are dissimilar to "^.*$").
</p>
<p>ENUM clients have been known to discard NAPTRs that do not use '!' as their Regexp delimiter character.
</p>
<p>ENUM clients have been known to discard NAPTRs in which the delimiter is NOT the last character in the Regexp field.
</p>
<p>ENUM clients have been known to discard NAPTRs with an empty Flags field (i.e. "non-terminal" NAPTRs).
</p>
<p>ENUM clients have been known to ignore the ORDER field value entirely, sorting the NAPTRs in an RRSet based solely on the PREFERENCE/PRIORITY field values.
</p>
<p>Finally, many ENUM clients have been known to discard a NAPTR where they have local knowledge that the URI that would be generated by processing the NAPTR is unusable.<br />
This behaviour is strictly speaking non-compliant, but might be considered reasonable (see <a class='info' href='#noncom'>Section&nbsp;5.1<span> (</span><span class='info'>Common Non-Compliant ENUM Processing</span><span>)</span></a>).
</p>
<a name="OrderPriority"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
ENUM NAPTR Processing</h3>

<p>ENUM is a DDDS Application, and the way in which NAPTRs in an RRSet are processed reflects this. The details are described in section 3.3 of <a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a>. The client is expected to sort the records it receives into a sequence and then to process these in that sequence. The sequence reflects the ORDER and PREFERENCE/PRIORITY field values in each of the NAPTRs.
</p>
<p>The ORDER field value is the major or most significant sort term and the PREFERENCE/PRIORITY field value is the minor or least significant sort term. The combination of ORDER and PREFERENCE/PRIORITY field values indicates the sequence chosen by the publisher of this data, and NAPTRs will be considered in this sequence.
</p>
<p>Once the NAPTRs are sorted into sequence, further processing is done to determine if each of the NAPTRs is appropriate for this ENUM evaluation. This involves looking at the Flags field. If the flag field is empty, this is a "non-terminal" NAPTR, and is processed as described in <a class='info' href='#NonTerminalNAPTRs'>Section&nbsp;6<span> (</span><span class='info'>Non-Terminal NAPTR Processing</span><span>)</span></a>.
</p>
<p>If the "u" Flag is present (and so the NAPTR is a "terminal" rule that generates a URI), the Services field is checked to ensure that this NAPTR is intended for ENUM (i.e. that this NAPTR includes the "E2U" DDDS Application Identifier in the Services field). The ERE in the Regexp field is checked and must match the Application Unique String (AUS) for this ENUM evaluation (the queried telephone number). Unless each of these checks succeeds, the NAPTR is discarded and the next in sequence is processed.
</p>
<p>During this processing, clients will also consider the Enumservices within the Services field. Enumservices indicate the kind of interaction that can be achieved through use of the URI this NAPTR generates. If there is local knowledge that a NAPTR includes only an Enumservice that is either not supported or not recognised, then this NAPTR can be discarded and the next in sequence will be processed. Thus, for a system that has support only for SIP interactions, if it receives an RRSet in which the "best" NAPTR indicates the H323 Enumservice, then that client could reasonably discard that NAPTR and go on to the next in sequence.
</p>
<a name="noncom"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Common Non-Compliant ENUM Processing</h3>

<p>The processing of ORDER and PREFERENCE/PRIORITY fields has been a significant source of confusion, and many ENUM clients do not implement the processing exactly as specified.
</p>
<p>In particular, many ENUM clients use local prior knowledge about URIs during ENUM processing. If a client has prior knowledge that a particular URI will not result in an acceptable outcome, it might discard that NAPTR and consider the next one in the sequence. Examples of such local prior knowledge are - the URI does not resolve, authentication has been recently rejected, or even that user policies mark a particular URI as unacceptable (the URI could be a "premium rate" telephone number that would be charged at an unacceptable rate).
</p>
<p>Strictly speaking, this behaviour is non-compliant if the next NAPTR record has a different ORDER value. The ENUM algorithm (<a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a> Section 3.3, and <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> section 4.1) states that, once a match has been found for the Application Unique String (AUS), and the service description satisfies the client's requirements, NAPTR records with a larger ORDER values must not be considered (but that other NAPTR records with the same ORDER value can still be considered).
</p>
<p>However, embedding local knowledge about the URI within the ENUM evaluation process is almost universal in systems employing ENUM. Also, since the difference between ORDER and PRIORITY/PREFERENCE has been unclear, NAPTR records have been provisioned in ways that would make strictly compliant systems unusable in practice. Given that such systems are intended to provide communications, this non-compliant "embedded decision" behaviour is understandable.
</p>
<p>It is proposed that when the ENUM specification is updated, processing of ORDER and PRIORITY/PREFERENCE should be updated based on implementation and deployment experience described in this document.
</p>
<a name="noncomexample"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1.1"></a><h3>5.1.1.&nbsp;
Example</h3>

<p>The example in this section is intended to help understanding the difference between what <a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a> and <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> specify, and what existing ENUM clients do.
</p>
<p>WARNING: The NAPTR records shown in this section are intended to
illustrate somewhat unclear corner cases, and are not intended as
good examples of how to do ENUM provisioning.
</p>
<p>Consider the following RRset, which maps numbers in the UK drama
range to one server, and all other numbers to a second server:<br />

* 3600 IN NAPTR 1 1 "u" "e2u+sip"<br />

&nbsp;&nbsp;&nbsp;&nbsp;"!^(\\+441632960.*)$!sips:\\1@atlanta.example.com!" .<br />

* 3600 IN NAPTR 2 1 "u" "e2u+sip"<br />

&nbsp;&nbsp;&nbsp;&nbsp;"!^(.*)$!sip:\\1@biloxi.example.com!" .
</p>
<p>According to the processing specified in <a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a> and <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a>, the ENUM client is never intended to consider the second rule for e.g. AUS "+441632960123", even if it does not support "sips" URIs, or the atlanta.example.com server cannot be reached, or the user indicates not wishing to contact atlanta.example.com. However, existing ENUM implementations are known to do this, and as described above, it can be useful if the alternative is failing to communicate at all.
</p>
<p>To prevent a client from considering the second rule for the UK
drama range, the example could be rewritten to have more
predictable behaviour as follows:<br />


* 3600 IN NAPTR 1 1 "u" "e2u+sip"<br />

&nbsp;&nbsp;&nbsp;&nbsp;"!^(\\+441632960.*)$!sips:\\1@atlanta.example.com!" .<br />

* 3600 IN NAPTR 2 1 "u" "e2u+sip"<br />

&nbsp;&nbsp;&nbsp;&nbsp;"!^(\\+[^4].*|\\+4[^4].*|\\+44[^1].*|\\+441[^6].*|\\+4416[^3].*|<br />

&nbsp;&nbsp;&nbsp;&nbsp;\\+44163[^2].*|\\+441632[^9].*|\\+4416329[^6].*|<br />

&nbsp;&nbsp;&nbsp;&nbsp;\\+44163296[^0].*)$!sip:\\1@biloxi.example.com!" .
</p>
<a name="OrderGeneral"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Order/Priority values - Processing sequence</h3>

<p><a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> and <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> state that the ENUM client MUST sort the NAPTRs using the ORDER field value ("lowest value is first") and SHOULD order the NAPTRs using the PREFERENCE/PRIORITY field value as the minor sort term (again, lowest value first). The NAPTRs in the sorted list must be processed in order. Subsequent NAPTRs with worse ORDER values must only be dealt with once the current ones with a better ORDER value have been processed.
</p>
<p>However, as described in the introduction to this section, this stated behaviour is a simplification. Once sorted into a sequence reflecting ORDER and PREFERENCE/PRIORITY values, other fields are also considered during evaluation of retrieved NAPTRs and local knowledge may play a factor in the decision process, once a NAPTR has reached that point in the sequence at which it is considered.
</p>
<p>ENUM clients may also include the end user "in the decision loop", offering the end user the choice from a list of possible NAPTRs. Conceptually this choice is embedded within step 4 of the DDDS algorithm (as described in section 3.3 of <a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a>). Given that the ORDER field value is the major sort term, one would expect a conforming ENUM client to present only those NAPTRs with the currently "best" ORDER field value as choices. When/if all the presented options had been rejected, then the ENUM client might offer those with the "next best" ORDER field value, and so on. As this may be confusing for the end user, some clients simply offer all of the available NAPTRs as options to the end user for his or her selection at once, in the sequence defined by the ORDER and PREFERENCE/PRIORITY fields.
</p>
<p>In summary, ENUM clients will take into account the Services field value, the Flags field, and the Regexp ERE sub-field, along with the ORDER and PREFERENCE/PRIORITY field values, and may consider local policies or available local knowledge.
</p>
<p>The Registrant and the ENUM zone provisioning system he or she uses must be aware of this and SHOULD NOT rely on ENUM clients solely taking account of the value of the ORDER and the PREFERENCE/PRIORITY fields alone.
</p>
<p>Specifically, it is unsafe to assume that a ENUM client will not consider another NAPTR if there is one with a better ORDER value. The instruction (in sections 4.1 and section 8 of <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a>) may or may not be followed strictly by different ENUM clients for perfectly justifiable reasons.
</p>
<p>Where the ENUM client presents a list of possible URLs to the end user for his or her choice, it MUST do so in the sequence defined by the ORDER and PREFERENCE/PRIORITY values specified by the Registrant.
</p>
<p>However, a Registrant SHOULD place into his or her zone only contacts that he or she is willing to support; even those with the worst ORDER and PREFERENCE/PRIORITY values MAY be selected by an end user.
</p>
<a name="ORDERPREForder"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Use of Order and Preference fields</h3>

<p>NAPTRs in ENUM zones that hold incorrect ORDER values can cause major problems. <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> highlights that having both ORDER and PREFERENCE/PRIORITY fields is a historical artifact of the NAPTR resource record type. It is reasonable to have a common default value for the ORDER field, relying on the PREFERENCE/PRIORITY field to indicate the preferred sort.
</p>
<p>We have noticed a number of ENUM domains with NAPTRs that have identical PREFERENCE/PRIORITY field values and different ORDER values. This may be the result of an ENUM zone provisioning system "bug" or a misunderstanding over the uses of the two fields, or simply a difference of interpretation of the standards.
</p>
<p>To clarify, the ORDER field value is the major sort term, and the PREFERENCE/PRIORITY field value is the minor sort term. Thus one should expect to have a set of NAPTRs in a zone with identical ORDER field values and different PREFERENCE/PRIORITY field values; not the other way around.
</p>
<p>To avoid these common interoperability issues, it is recommended that ENUM NAPTRs SHOULD hold a default value in their ORDER field.
</p>
<a name="IdenticalOrderPrio"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
NAPTRs with identical ORDER/PRIORITY values</h3>

<p>From experience, there are zones that hold discrete NAPTRs with identical ORDER and identical PREFERENCE/PRIORITY field values. This will lead to indeterminate client behaviour and so SHOULD NOT normally occur.
</p>
<p>Such a condition indicates that these NAPTRs are truly identical in priority, and there is no preference between the services these NAPTRs offer. Implementers SHOULD NOT assume that the DNS will deliver NAPTRs within an RRSet in a particular sequence.
</p>
<p>Multiple NAPTRs with identical ORDER and identical PREFERENCE/PRIORITY field values SHOULD NOT be provisioned into an RRSet, unless the intent is that these NAPTRs are truly identical in priority and there is no preference between them.
</p>
<p>Some ENUM client implementations have considered this case to be an error, and have rejected such duplicates entirely. Others have attempted to further randomise the order in which such duplicates are processed. Thus use of such duplicate NAPTRs is unwise, as client implementations exist that will behave in different ways.
</p>
<a name="CompoundNAPTRSort"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4.1"></a><h3>5.4.1.&nbsp;
Compound NAPTRs and implicit ORDER/REFERENCE Values</h3>

<p>With <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>, it is possible to have more than one Enumservice associated with a single NAPTR. These Enumservices share the same Regexp field and so generate the same URI. Such a "compound" NAPTR could well be used to indicate a mobile phone that supports both "voice:tel" and "sms:tel" Enumservices. <br />

The services field in that case would be "E2U+voice:tel+sms:tel".
</p>
<p>A Compound NAPTR can be treated as a set of NAPTRs each holding a single Enumservice. These reconstructed NAPTRs share the same ORDER and PREFERENCE/PRIORITY field values but should be treated as if each had a logically different priority. In this case the reconstructed NAPTR holding the leftmost Enumservice within the Compound NAPTR has a better priority, and the reconstructed NAPTR holding the rightmost Enumservice has the worst priority in this set.
</p>
<p>To avoid indeterminate behaviour, it is recommended that ENUM clients SHOULD process the Enumservices within a compound NAPTR in a left to right sequence. ENUM provisioning systems SHOULD assume that such a processing order will be used and provision the Enumservices within a compound NAPTR accordingly.
</p>
<a name="OrderAcrossZones"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.5"></a><h3>5.5.&nbsp;
Processing Order value across Domains</h3>

<p>Using a different ORDER field value in different domains is unimportant for most queries. However, DDDS includes a mechanism for continuing a search for NAPTRs in another domain by including a reference to that other domain in a "non-terminal" NAPTR. The treatment of non-terminal NAPTRs is covered in the next section, but if these are supported then it does have a bearing on the way that ORDER and PREFERENCE/PRIORITY field values are processed.
</p>
<p>Two main questions remain from the specifications of DDDS and <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>:
</p>
<ul class="text">
<li>If there is a different (lower) order field value in a domain referred to by a non-terminal NAPTR, then does this mean that the ENUM client discards any remaining NAPTRs in the referring RRSet?
</li>
<li>Conversely, if the domain referred to by a non-terminal NAPTR contains entries that only have a higher ORDER field value, then does the ENUM client ignore those NAPTRs in the referenced domain?
</li>
</ul><p>

</p>
<p> Whilst one interpretation of <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> is that the answer to both questions is "yes", this is not the way that those examples of non-terminal NAPTRs that do exist (and those ENUM clients that support them) seem to be designed.
</p>
<p>In keeping with the interpretation made so far, ENUM implementations MUST consider the ORDER and PREFERENCE/PRIORITY values only within the context of the domain currently being processed in an ENUM query. These values MUST be discarded when processing other RRSets in the query.
</p>
<a name="NonTerminalNAPTRs"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Non-Terminal NAPTR Processing</h3>

<a name="NonTerminalsConsideredHarmful"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Non-Terminal NAPTRs - necessity</h3>

<p>Consider an ENUM RRSet that contains a non-terminal NAPTR record. This non-terminal NAPTR holds, as its target, another domain that has a set of NAPTRs. In effect, this is similar to the non-terminal NAPTR being replaced by the NAPTRs contained in the domain to which it points.
</p>
<p>It is possible to have a non-terminal NAPTR in a domain that is, itself, pointed to by another non-terminal NAPTR. Thus a set of domains forms a "chain", and the list of NAPTRs to be considered is the set of all NAPTRs contained in all of the domains in that chain.
</p>
<p>For an ENUM management system to support non-terminal NAPTRs, it is necessary for it to be able to analyse, validate and (where needed) correct not only the NAPTRs in its current ENUM domain but also those referenced by non-terminal NAPTRs in other domains. If the domains pointed to have non-terminal NAPTRs of their own, the management system will have to check each of the referenced domains in turn, as their contents forms part of the result of a query on the "main" ENUM domain. The domain content in the referenced domains may well not be under the control of the ENUM management system, and so it may not be possible to correct any errors in those RRSets. This is both complex and prone to error in the management system design, and any reported errors in validation may well be non-intuitive for users.
</p>
<p>For an ENUM client, supporting non-terminal NAPTRs can also be difficult. Processing non-terminal NAPTRs causes a set of sequential DNS queries that can take an indeterminate time, and requires extra resources and complexity to handle fault conditions like non-terminal loops. The indeterminacy of response time makes ENUM supported Telephony Applications difficult (such as in an "ENUM-aware" PBX), whilst the added complexity and resources needed makes support problematic in embedded devices like "ENUM-aware" mobile phones.
</p>
<p>Given that, in principle, a non-terminal NAPTR can be replaced by the NAPTRs in the domain to which it points, support of non-terminal NAPTRs is not needed and non-terminal NAPTRs may not be useful. Furthermore, some existing ENUM clients do not support non-terminal NAPTRs and ignore them if received.
</p>
<p>To avoid interoperability problems, some kind of acceptable advice is needed on non-terminal NAPTRs. As current support is limited, non-terminal NAPTRs SHOULD NOT be used in ENUM unless it is clear that all ENUM clients this environment supports can process these.
</p>
<a name="NonTerminalImplementation"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Non-Terminal NAPTRs - considerations</h3>

<p>The following specific issues need to be considered if non-terminal NAPTRs are to be supported in a particular environment. These issues are gleaned from experience, and indicate the kinds of conditions that should be considered before support for non-terminal NAPTRs is contemplated. Note that these issues are in addition to the point just mentioned on ENUM provisioning or management system complexity and the potential for that management system to have no control over the zone contents to which non-terminal NAPTRs in its managed zones refer.
</p>
<a name="NonTerminalNAPTRGen"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.1"></a><h3>6.2.1.&nbsp;
Non-Terminal NAPTRs - general</h3>

<p>As mentioned earlier, a non-terminal NAPTR in one RRSet refers to the NAPTRs contained in another domain. The NAPTRs in the domain referred to by the non-terminal NAPTR may have a different ORDER value from that in the referring non-terminal NAPTR. See <a class='info' href='#OrderAcrossZones'>Section&nbsp;5.5<span> (</span><span class='info'>Processing Order value across Domains</span><span>)</span></a> for details.
</p>
<a name="NonTerminalNAPTRLoops"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.2"></a><h3>6.2.2.&nbsp;
Non-Terminal NAPTRs - loop detection and response</h3>

<p>Where a chain of non-terminal NAPTRs refers back to a domain already traversed in the current query, this implies a "non-terminal" or referential loop.

An implementation MAY treat a chain of more than 5 domains traversed during a single ENUM query as an indication that a self-referential loop has been entered.
</p>
<p>There are many techniques that can be used to detect such a loop, but the simple approach of counting the number of domains queried in the current ENUM query suffices.
</p>
<p>Where a loop has been detected, processing SHOULD continue at the next NAPTR in the referring domain (i.e. after the non-terminal NAPTR that included the reference that triggered the loop detection).
</p>
<a name="DecodingTheGibberish"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.3"></a><h3>6.2.3.&nbsp;
Field content in Non-Terminal NAPTRs</h3>

<p>The set of specifications defining DDDS and its applications are complex and multi-layered. This reflects the flexibility that the system provides, but it does mean that some of the specifications need clarification as to their interpretation, particularly where non-terminal rules are concerned.
</p>
<a name="FlagsInterp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.3.1"></a><h3>6.2.3.1.&nbsp;
Flags field content with Non-Terminal NAPTRs</h3>

<p><a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>, section 2.4.1 states that the only flag character valid for use with the "E2U" DDDS Application is 'u'. The flag 'u' is defined (in <a class='info' href='#RFC3404'>[RFC3404]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Four: The Uniform Resource Identifiers (URI),&rdquo; October&nbsp;2002.</span><span>)</span></a>, section 4.3) thus: 'The "u" flag means that the output of the Rule is a URI'.
</p>
<p><a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> section 2.4.1 also states that an empty Flags field indicates a non-terminal NAPTR. This is also the case for other DDDS Application specifications, such as that specified in <a class='info' href='#RFC3404'>[RFC3404]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Four: The Uniform Resource Identifiers (URI),&rdquo; October&nbsp;2002.</span><span>)</span></a>. One could well argue that this is a feature potentially common to all DDDS Applications, and so might have been specified in <a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a> or <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a>.
</p>
<p>The Flags field will be empty in non-terminal NAPTRs encountered in ENUM processing. ENUM does not have any other way to indicate a non-terminal NAPTR.
</p>
<a name="ServInterp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.3.2"></a><h3>6.2.3.2.&nbsp;
Services field content with Non-Terminal NAPTRs</h3>

<p>Furthermore, <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> states that any Enumservice Specification requires definition of the URI that is the expected output of this Enumservice. This means that, at present, there is no way to specify an Enumservice that is non-terminal; such a non-terminal NAPTR has, by definition, no URI as its expected output, instead returning a key (DNS domain name) that is to be used in the "next round" of DDDS processing.
</p>
<p>This in turn means that a non-terminal NAPTR cannot hold a valid (non-empty) Services field when used in ENUM. Section 2.4.2 of <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> specifies the syntax for this field content, and requires at least one element of type &lt;servicespec&gt; (i.e. at least one Enumservice identifier). Given that there cannot be a non-terminal Enumservice (and so no such Registered Enumservice identifier), this syntax cannot be met with a non-terminal NAPTR; there are no non-terminal Enumservices to put into this field.
</p>
<p>A reasonable interpretation of the specifications is that for a non-terminal NAPTR, the Services field must also be empty. This appears to be the approach taken by those clients that do either process non-terminal NAPTRs or check the validity of the fields.
</p>
<p>It is expected that future revisions of the ENUM standard will clarify this text, making this interpretation plain. This was the intent of the current standard, and the intent will be made explicit in its revision.
</p>
<p>In keeping with existing implementations, in a non-terminal NAPTR encountered in an ENUM query, the Services field SHOULD be empty, and clients SHOULD ignore any content it contains.
</p>
<p>Of course, such non-terminal NAPTRs with an empty services field are not specific to any DDDS application. Thus other means must be used to ensure a non-terminal NAPTR that is intended only for a particular DDDS application cannot be encountered during a lookup for another DDDS application (for example, by ensuring that the same domain is not used to host NAPTRs for more than one such DDDS application).
</p>
<a name="RegexpReplInterp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.3.3"></a><h3>6.2.3.3.&nbsp;
Regular Expression and Replacement field content with Non-terminal NAPTRs</h3>

<p>The descriptive text in section 4.1 of <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> is intended to explain how the fields are to be used in a NAPTR. However, the descriptions associated with the Regexp and Replacement elements have led to some confusion over which of these should be considered when dealing with non-terminal NAPTRs.
</p>
<p><a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> is specific; these two elements are mutually exclusive. This means that if the Regexp element is not empty then the Replacement element must be empty, and vice versa. However, is does not specify which is used with terminal and non-terminal rules.
</p>
<p>The descriptive text of section 4.1 of <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a> for the NAPTR Replacement element shows that this element holds an uncompressed domain name. Thus it is clear that this element cannot be used to deliver the terminal string for any DDDS application that does not have a domain name as its intended terminal output.
</p>
<p>However, the first paragraph of descriptive text for the NAPTR Regexp element has led to some confusion. It appears that the Regexp element is to be used to find "the next domain name to lookup". This might be interpreted as meaning that a client program processing the DDDS application could need to examine each non-terminal NAPTR to decide whether the Regexp element or instead the Replacement element were to be used to construct the key (a domain name) to be used next in non-terminal rule processing.
</p>
<p>Given that a NAPTR holding a terminal rule (a "terminal NAPTR") must use the Substitution expression field to generate the expected output of that DDDS application, the Regexp element is also used in such rules. Indeed, unless that DDDS application has a domain name as its terminal output, the Regexp element is the only possibility.
</p>
<p>Thus from the descriptive text of this section, a Replacement element can be used only in NAPTRs holding a non-terminal rule (a "non-terminal NAPTR") unless that DDDS Application has a domain name as its terminal output, whilst the alternative Regexp element may be used either to generate a domain name as the next key to be used in the non-terminal case, or to generate the output of the DDDS application.
</p>
<p>Note that each DDDS Application is free to specify the set of flags to be used with that application. This includes specifying whether a particular flag is associated with a terminal or non-terminal rule, and also to specify the interpretation of an empty Flags field (i.e. whether this is to be interpreted as a terminal or non-terminal rule, and if it is terminal, then the expected output). ENUM (as specified in section 2.4.1 of <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>) uses only the 'u' flag, with an empty Flags field indicating a non-terminal NAPTR.
</p>
<p>The general case in which a client program must check which of the two elements to use in non-terminal NAPTR processing complicates implementation, and this interpretation has NOT been made in current ENUM implementations. It would be useful to define exactly when a client program can expect to process the Regexp element and when to expect to process the Replacement element, if only to improve robustness. Generating an ENUM domain name from the Regexp field is difficult at best and impossible for the general case of a variable length telephone number, or one that has more than 9 digits. Thus, it is proposed that when the ENUM specification is updated, this option is deprecated, and using the Regexp field for non-terminal ENUM NAPTRs is prohibited.
</p>
<p>In keeping with current implementations, the target domain of a non-terminal ENUM NAPTR MUST be placed in the (non-empty) Replacement field. This field MUST be interpreted as holding the domain name that forms the next key output from this non-terminal rule. Conversely, the Regexp field MUST be empty in a non-terminal NAPTR encountered in ENUM processing and ENUM clients MUST ignore its content.
</p>
<a name="BackwardsCompat"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Backwards Compatibility</h3>

<a name="SvcFieldSyntax"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Services field syntax</h3>

<p><a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> is the current standard for the syntax for NAPTRs supporting the ENUM DDDS application. This obsoletes the original specification that was given in <a class='info' href='#RFC2916'>[RFC2916]<span> (</span><span class='info'>Faltstrom, P., &ldquo;E.164 number and DNS,&rdquo; September&nbsp;2000.</span><span>)</span></a>. There has been a change to the syntax of the Services field of the NAPTR that reflects a refinement of the concept of ENUM processing.
</p>
<p>As defined in <a class='info' href='#RFC3403'>[RFC3403]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database,&rdquo; October&nbsp;2002.</span><span>)</span></a>, there is now a single identifier that indicates the DDDS Application. In the obsolete specification (<a class='info' href='#RFC2915'>[RFC2915]<span> (</span><span class='info'>Mealling, M. and R. Daniel, &ldquo;The Naming Authority Pointer (NAPTR) DNS Resource Record,&rdquo; September&nbsp;2000.</span><span>)</span></a>), there were zero or more "Resolution Service" identifiers (the equivalent of the DDDS Application). The same identifier string is defined in both <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> and in the old <a class='info' href='#RFC2916'>[RFC2916]<span> (</span><span class='info'>Faltstrom, P., &ldquo;E.164 number and DNS,&rdquo; September&nbsp;2000.</span><span>)</span></a> specifications for the DDDS identifier or the Resolution Service; "E2U".
</p>
<p>Also, <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> defines at least one but potentially several Enumservice sub-fields; in the obsolete specification, only one "protocol" sub-field was allowed.
</p>
<p>In many ways, the most important change for implementations is that the order of the sub-fields has been reversed. <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> specifies that the DDDS Application identifier is the leftmost sub-field, followed by one or more Enumservice sub-fields, each separated by the '+' character delimiter. <a class='info' href='#RFC2916'>[RFC2916]<span> (</span><span class='info'>Faltstrom, P., &ldquo;E.164 number and DNS,&rdquo; September&nbsp;2000.</span><span>)</span></a> specified that the protocol sub-field was the leftmost, followed by the '+' delimiter, in turn followed by the "E2U" resolution service tag.
</p>
<p><a class='info' href='#RFC2915'>[RFC2915]<span> (</span><span class='info'>Mealling, M. and R. Daniel, &ldquo;The Naming Authority Pointer (NAPTR) DNS Resource Record,&rdquo; September&nbsp;2000.</span><span>)</span></a> and <a class='info' href='#RFC2916'>[RFC2916]<span> (</span><span class='info'>Faltstrom, P., &ldquo;E.164 number and DNS,&rdquo; September&nbsp;2000.</span><span>)</span></a> have been obsoleted by <a class='info' href='#RFC3401'>[RFC3401]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part One: The Comprehensive DDDS,&rdquo; October&nbsp;2002.</span><span>)</span></a> - <a class='info' href='#RFC3404'>[RFC3404]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Four: The Uniform Resource Identifiers (URI),&rdquo; October&nbsp;2002.</span><span>)</span></a> and by <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>. However, <a class='info' href='#RFC3824'>[RFC3824]<span> (</span><span class='info'>Peterson, J., Liu, H., Yu, J., and B. Campbell, &ldquo;Using E.164 numbers with the Session Initiation Protocol (SIP),&rdquo; June&nbsp;2004.</span><span>)</span></a> suggests that ENUM clients should be prepared to accept NAPTRs with the obsolete syntax. Thus, an ENUM client implementation may have to deal with both forms. This need not be difficult. For example, an implementation could process the Services field into a set of tokens, and expect exactly one of these tokens to be "E2U". In this way, the ENUM client might be designed to handle both the old and the current forms without added complexity.
</p>
<p>To facilitate this method, IANA should reject any request to register an Enumservice with the label "E2U".
</p>
<p>To summarise, ENUM clients MUST support ENUM NAPTRs according to <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> syntax. ENUM clients SHOULD also support ENUM NAPTRs according to the obsolete syntax of <a class='info' href='#RFC2916'>[RFC2916]<span> (</span><span class='info'>Faltstrom, P., &ldquo;E.164 number and DNS,&rdquo; September&nbsp;2000.</span><span>)</span></a>; there are still zones that hold "old" syntax NAPTRs. ENUM zones MUST NOT be provisioned with NAPTRs according to the obsolete form, and MUST be provisioned with NAPTRs in which the Services field is according to <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>.
</p>
<a name="provSysImplications"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Collected Implications for ENUM Provisioning</h3>

<p>ENUM NAPTRs SHOULD NOT include characters outside the printable US-ASCII equivalent range (U+0020 to U+007E) unless it is clear that all ENUM clients they are designed to support will be able correctly to process such characters. If ENUM zone provisioning systems require non-ASCII characters, these systems SHOULD encode the non-ASCII data to emit only US-ASCII characters by applying the appropriate mechanism (<a class='info' href='#RFC3492'>[RFC3492]<span> (</span><span class='info'>Costello, A., &ldquo;Punycode: A Bootstring encoding of Unicode for Internationalized Domain Names in Applications (IDNA),&rdquo; March&nbsp;2003.</span><span>)</span></a>, <a class='info' href='#RFC3987'>[RFC3987]<span> (</span><span class='info'>Duerst, M. and M. Suignard, &ldquo;Internationalized Resource Identifiers (IRIs),&rdquo; January&nbsp;2005.</span><span>)</span></a>). Non-printable characters SHOULD NOT be used, as ENUM clients may need to present NAPTR content in a human-readable form.
</p>
<p>The case sensitivity flag ('i') is inappropriate for ENUM, and SHOULD NOT be provisioned into the Regexp field of E2U NAPTRs.
</p>
<p>ENUM zone provisioning systems SHOULD use '!' (U+0021) as their Regexp delimiter character.
</p>
<p>If the Regexp delimiter is a character in the static text of the Repl sub-field, it MUST be "escaped" using the escaped-delimiter production of the BNF specification shown in section 3.2 of <a class='info' href='#RFC3402'>[RFC3402]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm,&rdquo; October&nbsp;2002.</span><span>)</span></a> (i.e. "\!", U+005C U+0021). Note that when a NAPTR RR is entered in DNS master file syntax, the backslash itself must be escaped using a second backslash.
</p>
<p>If present in the ERE sub-field of an ENUM NAPTR, the literal character '+' MUST be escaped as "\+" (i.e. U+005C U+002B). Note that, as always, when a NAPTR RR is entered in DNS master file syntax, the backslash itself must be escaped using a second backslash.
</p>
<p>
</p>
<p>The Registrant and the ENUM zone provisioning system he or she uses SHOULD NOT rely on ENUM clients solely taking account of the value of the ORDER and the PREFERENCE/PRIORITY fields in ENUM NAPTRs. Thus, a Registrant SHOULD place into his or her zone only contacts that he or she is willing to support; even those with the worst ORDER and PREFERENCE/PRIORITY values MAY be selected by an end user.
</p>
<p>Many apparent mistakes in ORDER and PREFERENCE/PRIORITY values have been detected in provisioned ENUM zones. To avoid these common interoperability issues, provisioning systems SHOULD NOT use different ORDER field values for NAPTRs in a Resource Record Set (RRSet). To generalise, all ENUM NAPTRs SHOULD hold a default value in their ORDER field. A value of "100" is recommended, as it seems to be used in most provisioned domains.
</p>
<p>Multiple NAPTRs with identical ORDER and identical PREFERENCE/PRIORITY field values SHOULD NOT be provisioned into an RRSet, unless the intent is that these NAPTRs are truly identical and there is no preference between them. Implementers SHOULD NOT assume that the DNS will deliver NAPTRs within an RRSet in a particular sequence.
</p>
<p>An ENUM zone provisioning system SHOULD assume that, if it generates compound NAPTRs, the Enumservices will normally be processed in left to right order within such NAPTRs.
</p>
<p>ENUM zone provisioning systems SHOULD assume that, once a non-terminal NAPTR has been selected for processing, the ORDER field value in a domain referred to by that non-terminal NAPTR will be considered only within the context of that referenced domain (i.e. the ORDER value will be used only to sort within the current RRSet, and will not be used in the processing of NAPTRs in any other RRSet).
</p>
<p>Whilst this client behaviour is non-compliant, ENUM provisioning systems and their users should be aware that some ENUM clients have been detected with poor (or no) support for non-trivial ERE sub-field expressions.
</p>
<p>ENUM provisioning systems SHOULD be cautious in the use of multiple back-reference patterns in the Repl sub-field of NAPTRs they provision. Some Clients have limited buffer space for character expansion when generating URIs (See also <a class='info' href='#dislikedNAPTRs'>Section&nbsp;4<span> (</span><span class='info'>Unsupported NAPTRs</span><span>)</span></a>). These provisioning systems SHOULD check the back-reference replacement patterns they use, ensuring that regular expression processing will not produce excessive length URIs.
</p>
<p>As current support is limited, non-terminal NAPTRs SHOULD NOT be provisioned in ENUM zones unless it is clear that all ENUM clients this environment supports can process these.
</p>
<p>When populating a set of domains with NAPTRs, ENUM zone provisioning systems SHOULD NOT configure non-terminal NAPTRs so that more than 5 such NAPTRs will be processed in an ENUM query.
</p>
<p>In a non-terminal NAPTR encountered in an ENUM query (i.e. one with an empty Flags field), the Services field SHOULD be empty.
</p>
<p>A non-terminal NAPTR MUST include its target domain in the (non-empty) Replacement field. This field MUST be interpreted as holding the domain name that forms the next key output from this non-terminal rule. The Regexp field MUST be empty in a non-terminal NAPTR intended to be encountered during an ENUM query.
</p>
<p>
</p>
<p>ENUM zones MUST NOT be provisioned with NAPTRs according to the obsolete form, and MUST be provisioned with NAPTRs in which the services field is according to <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>.
</p>
<a name="clientImplications"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Collected Implications for ENUM clients</h3>

<p>ENUM clients SHOULD NOT discard NAPTRs in which they detect characters outside the US-ASCII "printable" range (0x20 to 0x7E hexadecimal).
</p>
<p>ENUM clients MAY discard NAPTRs that have octets in the Flags, Services, or Regexp fields that have byte values outside the US-ASCII equivalent range (i.e. byte values above 0x7F). Clients MUST be ready to encounter NAPTRs with such values without failure.
</p>
<p>ENUM clients SHOULD NOT assume that the delimiter is the last character of the Regexp field.
</p>
<blockquote class="text">
<p>Unless they are sure that in their environment this is the case, in general an ENUM client may still encounter NAPTRs that have been provisioned with a following 'i' (case insensitive) flag, even though that flag has no effect at all in an ENUM scenario.
</p>
</blockquote>

<p>ENUM clients SHOULD discard NAPTRs that have more or less than 3 unescaped instances of the delimiter character within the Regexp field.
</p>
<blockquote class="text">
<p>In the spirit of being liberal with what it will accept, if the ENUM client is sure how the Regexp field should be interpreted, then it may choose to process the NAPTR even in the face of an incorrect number of unescaped delimiter characters. If this is not clear, then the client must discard the NAPTR.
</p>
</blockquote>

<p>
</p>
<p>Where the ENUM client presents a list of possible URLs to the end user for his or her choice, it MAY present all NAPTRs, not just the ones with the highest currently unprocessed ORDER field value. The client SHOULD keep to the ORDER and PREFERENCE/PRIORITY values specified by the Registrant.
</p>
<p>ENUM clients SHOULD accept all NAPTRs with identical ORDER and identical PREFERENCE/PRIORITY field values, and process them in the sequence in which they appear in the DNS response. (There is no benefit in further randomising the order in which these are processed, as intervening DNS Servers might have done this already).
</p>
<p>ENUM clients receiving compound NAPTRs (i.e. ones with more than one Enumservice) SHOULD process these Enumservices using a left-to-right sort ordering, so that the first Enumservice to be processed will be the leftmost one, and the last will be the rightmost one.
</p>
<p>ENUM clients SHOULD consider the ORDER field value only when sorting NAPTRs within a single RRSet. The ORDER field value SHOULD NOT be taken into account when processing NAPTRs across a sequence of DNS queries created by traversal of non-terminal NAPTR references.
</p>
<p>
</p>
<p>ENUM clients MUST be ready to process NAPTRs that use a different character from '!' as their Regexp Delimiter without failure.
</p>
<p>ENUM clients MUST be ready to process NAPTRs that have non-trivial patterns in their ERE sub-field values without failure.
</p>
<p>ENUM clients MUST be ready to process NAPTRs with a DDDS Application identifier other than 'E2U' without failure.
</p>
<p>ENUM clients MUST be ready to process NAPTRs with many copies of back-reference patterns within the Repl sub-field without failure (see also <a class='info' href='#dislikedNAPTRs'>Section&nbsp;4<span> (</span><span class='info'>Unsupported NAPTRs</span><span>)</span></a>).
</p>
<p>If a NAPTR is discarded, this SHOULD NOT cause the whole ENUM query to terminate and processing SHOULD continue with the next NAPTR in the returned Resource Record Set (RRSet).
</p>
<p>When an ENUM client encounters a compound NAPTR (i.e. one containing more than one Enumservice) and cannot process or cannot recognise one of the Enumservices within it, that ENUM client SHOULD ignore this Enumservice and continue with the next Enumservice within this NAPTR's Services field, discarding the NAPTR only if it cannot handle any of the Enumservices contained.  These conditions SHOULD NOT be considered errors.
</p>
<p>
</p>
<p>ENUM clients MUST support ENUM NAPTRs according to <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a> syntax.
ENUM clients SHOULD also support ENUM NAPTRs according to the obsolete syntax of <a class='info' href='#RFC2916'>[RFC2916]<span> (</span><span class='info'>Faltstrom, P., &ldquo;E.164 number and DNS,&rdquo; September&nbsp;2000.</span><span>)</span></a>; there are still zones that hold "old" syntax NAPTRs.
</p>
<p>
</p>
<a name="ntn4clients"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.1"></a><h3>9.1.&nbsp;
Non-terminal NAPTR processing</h3>

<p>ENUM clients MUST be ready to process NAPTRs with an empty Flags field ("non-terminal" NAPTRs) without failure. More generally, non-terminal NAPTR processing SHOULD be implemented, but ENUM clients MAY discard non-terminal NAPTRs they encounter.
</p>
<p>ENUM clients SHOULD ignore any content of the Services field when encountering a non-terminal NAPTR with an empty Flags field.
</p>
<p>ENUM clients receiving a non-terminal NAPTR with an empty Flags field MUST treat the Replacement field as holding the domain name to be used in the next round of the ENUM query. An ENUM client MUST discard such a non-terminal NAPTR if the Replacement field is empty or does not contain a valid domain name. By definition, it follows that the Regexp field will be empty in such a non-terminal NAPTR. If present in a non-terminal NAPTR, a non-empty Regexp field MUST be ignored by ENUM clients.
</p>
<p>If a problem is detected when processing an ENUM query across multiple domains (by following non-terminal NAPTR references), then the ENUM query SHOULD NOT be abandoned, but instead processing SHOULD continue at the next NAPTR after the non-terminal NAPTR that referred to the domain in which the problem would have occurred.
</p>
<p>If all NAPTRs in a domain traversed as a result of a reference in a non-terminal NAPTR have been discarded, then the ENUM client SHOULD continue its processing with the next NAPTR in the "referring" RRSet (i.e. the one including the non-terminal NAPTR that caused the traversal).
</p>
<p>ENUM clients MAY consider a chain of more than 5 "non-terminal" NAPTRs traversed in a single ENUM query as an indication that a referential loop has been entered.
</p>
<p>Where a domain is about to be entered as the result of a reference in a non-terminal NAPTR, and the ENUM client has detected a potential referential loop, then the client SHOULD discard the non-terminal NAPTR from its processing and continue with the next NAPTR in its list. It SHOULD NOT make the DNS query indicated by that non-terminal NAPTR.
</p>
<a name="Sec-Cons"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Security Considerations</h3>

<p>In addition to the security implications of recommendations in this document, those in the basic use of ENUM (and specified in the normative documents for this protocol) should be considered as well; this document does not negate those in any way.
</p>
<p>The clarifications throughout this document are intended only as that; clarifications of text in the normative documents. They do not appear to have any security implications above those mentioned in the normative documents.
</p>
<p>The suggestions in <a class='info' href='#CharacterSets'>Section&nbsp;3<span> (</span><span class='info'>Character Sets and ENUM</span><span>)</span></a>, <a class='info' href='#OrderPriority'>Section&nbsp;5<span> (</span><span class='info'>ENUM NAPTR Processing</span><span>)</span></a>, and <a class='info' href='#BackwardsCompat'>Section&nbsp;7<span> (</span><span class='info'>Backwards Compatibility</span><span>)</span></a> do not appear to have any security considerations (either positive or negative).
</p>
<p>The suggestions in <a class='info' href='#NonTerminalNAPTRLoops'>Section&nbsp;6.2.2<span> (</span><span class='info'>Non-Terminal NAPTRs - loop detection and response</span><span>)</span></a> are a valid approach to a known security threat. It does not open an advantage to an attacker in causing excess processing or memory usage in the client. It does, however, mean that an ENUM client will traverse a "tight loop" of non-terminal NAPTRs in two domains 5 times before the client detects this as a loop; this does introduce slightly higher processing load than would be provided using other methods, but avoids the risks they incur.
</p>
<p>As mentioned in <a class='info' href='#dislikedNAPTRs'>Section&nbsp;4<span> (</span><span class='info'>Unsupported NAPTRs</span><span>)</span></a>, ENUM uses regular expressions to generate URIs. Though it is a standard feature of DDDS, use of "non-greedy" regular expressions with multiple back-reference patterns in the Repl sub-field does create the potential for buffer overrun attacks. Provisioning system designers SHOULD be aware of this and SHOULD limit the repeated use of Back-reference replacement patterns. Conversely, ENUM client implementers SHOULD avoid using fixed character buffers when generating URIs from Repl sub-fields that include Back-reference patterns, and MUST avoid failure in the case of buffer exhaustion.
</p>
<a name="IANA-Cons"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
IANA Considerations</h3>

<p>This document includes one IANA consideration. This is the suggestion (in <a class='info' href='#SvcFieldSyntax'>Section&nbsp;7.1<span> (</span><span class='info'>Services field syntax</span><span>)</span></a>) that no-one should be allowed to register an Enumservice with any of its identifying tags set to "E2U".
</p>
<p>This document cannot require IANA action. However, it is expected that the update to the ENUM standard will reflect the proposal made here, and so the following requirement will be included there.
</p>
<blockquote class="text">
<p>IANA MUST NOT register an Enumservice with any of its identifying tags set to "E2U". Any such requests SHALL be rejected.
</p>
</blockquote>

<a name="Acknowledgements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Acknowledgements</h3>

<p>We would like to thank the various development teams who implemented ENUM (both creation systems and clients) and who read the normative documents differently - without these differences it would have been harder for us all to develop robust clients and suitably conservative management systems. We would also thank those who allowed us to check their implementations to explore behaviour; their trust and help were much appreciated.
</p>
<p>In particular, thanks to Richard Stastny for his hard work on a similar task <a class='info' href='#ETSI-TS102172'>TS 102 172<span> (</span><span class='info'>ETSI, &ldquo;Minimum Requirements for Interoperability of European ENUM Implementations,&rdquo; October&nbsp;2004.</span><span>)</span></a> [ETSI&#8209;TS102172] under the aegis of ETSI, and for supporting some of the ENUM implementations that exist today.
</p>
<p>Finally, thanks for the dedication of Michael Mealling in giving us such detailed DDDS specifications, without which the ENUM development effort would have had a less rigourous framework on which to build. This document reflects how complex a system it is: Without the intricacy of <a class='info' href='#RFC3401'>[RFC3401]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part One: The Comprehensive DDDS,&rdquo; October&nbsp;2002.</span><span>)</span></a> - <a class='info' href='#RFC3404'>[RFC3404]<span> (</span><span class='info'>Mealling, M., &ldquo;Dynamic Delegation Discovery System (DDDS) Part Four: The Uniform Resource Identifiers (URI),&rdquo; October&nbsp;2002.</span><span>)</span></a> and the work that went into them, it could have been very difficult to ensure interoperability.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>13.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="E.164">[E.164]</a></td>
<td class="author-text"><a href="mailto:">ITU-T</a>, &ldquo;The International Public Telecommunication Number Plan,&rdquo; Recommendation&nbsp;E.164, February&nbsp;2005.</td></tr>
<tr><td class="author-text" valign="top"><a name="IEEE.1003-2.1992">[IEEE.1003-2.1992]</a></td>
<td class="author-text">Institute of Electrical and Electronics Engineers, &ldquo;Information Technology - Portable Operating System Interface (POSIX) - Part 2: Shell and Utilities (Vol. 1),&rdquo; IEEE&nbsp;Standard 1003.2, January&nbsp;1993.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1034">[RFC1034]</a></td>
<td class="author-text">Mockapetris, P., &ldquo;<a href="http://tools.ietf.org/html/rfc1034">Domain names - concepts and facilities</a>,&rdquo; STD&nbsp;13, RFC&nbsp;1034, November&nbsp;1987 (<a href="http://www.rfc-editor.org/rfc/rfc1034.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1035">[RFC1035]</a></td>
<td class="author-text">Mockapetris, P., &ldquo;<a href="http://tools.ietf.org/html/rfc1035">Domain names - implementation and specification</a>,&rdquo; STD&nbsp;13, RFC&nbsp;1035, November&nbsp;1987 (<a href="http://www.rfc-editor.org/rfc/rfc1035.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3402">[RFC3402]</a></td>
<td class="author-text">Mealling, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3402">Dynamic Delegation Discovery System (DDDS) Part Two: The Algorithm</a>,&rdquo; RFC&nbsp;3402, October&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3402.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3403">[RFC3403]</a></td>
<td class="author-text">Mealling, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3403">Dynamic Delegation Discovery System (DDDS) Part Three: The Domain Name System (DNS) Database</a>,&rdquo; RFC&nbsp;3403, October&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3403.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3404">[RFC3404]</a></td>
<td class="author-text">Mealling, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3404">Dynamic Delegation Discovery System (DDDS) Part Four: The Uniform Resource Identifiers (URI)</a>,&rdquo; RFC&nbsp;3404, October&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3404.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3405">[RFC3405]</a></td>
<td class="author-text">Mealling, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3405">Dynamic Delegation Discovery System (DDDS) Part Five: URI.ARPA Assignment Procedures</a>,&rdquo; BCP&nbsp;65, RFC&nbsp;3405, October&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3405.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3490">[RFC3490]</a></td>
<td class="author-text">Faltstrom, P., Hoffman, P., and A. Costello, &ldquo;<a href="http://tools.ietf.org/html/rfc3490">Internationalizing Domain Names in Applications (IDNA)</a>,&rdquo; RFC&nbsp;3490, March&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3490.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3491">[RFC3491]</a></td>
<td class="author-text">Hoffman, P. and M. Blanchet, &ldquo;<a href="http://tools.ietf.org/html/rfc3491">Nameprep: A Stringprep Profile for Internationalized Domain Names (IDN)</a>,&rdquo; RFC&nbsp;3491, March&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3491.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3492">[RFC3492]</a></td>
<td class="author-text">Costello, A., &ldquo;<a href="http://tools.ietf.org/html/rfc3492">Punycode: A Bootstring encoding of Unicode for Internationalized Domain Names in Applications (IDNA)</a>,&rdquo; RFC&nbsp;3492, March&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3492.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3629">[RFC3629]</a></td>
<td class="author-text">Yergeau, F., &ldquo;<a href="http://tools.ietf.org/html/rfc3629">UTF-8, a transformation format of ISO 10646</a>,&rdquo; STD&nbsp;63, RFC&nbsp;3629, November&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3629.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3761">[RFC3761]</a></td>
<td class="author-text">Faltstrom, P. and M. Mealling, &ldquo;<a href="http://tools.ietf.org/html/rfc3761">The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM)</a>,&rdquo; RFC&nbsp;3761, April&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3761.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3966">[RFC3966]</a></td>
<td class="author-text">Schulzrinne, H., &ldquo;<a href="http://tools.ietf.org/html/rfc3966">The tel URI for Telephone Numbers</a>,&rdquo; RFC&nbsp;3966, December&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3966.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3986">[RFC3986]</a></td>
<td class="author-text"><a href="mailto:timbl@w3.org">Berners-Lee, T.</a>, <a href="mailto:fielding@gbiv.com">Fielding, R.</a>, and <a href="mailto:LMM@acm.org">L. Masinter</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc3986">Uniform Resource Identifier (URI): Generic Syntax</a>,&rdquo; STD&nbsp;66, RFC&nbsp;3986, January&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc3986.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc3986.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc3986.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3987">[RFC3987]</a></td>
<td class="author-text">Duerst, M. and M. Suignard, &ldquo;<a href="http://tools.ietf.org/html/rfc3987">Internationalized Resource Identifiers (IRIs)</a>,&rdquo; RFC&nbsp;3987, January&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc3987.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>13.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="ASCII">[ASCII]</a></td>
<td class="author-text">American National Standards Institute, &ldquo;Coded Character Set - 7-bit American Standard Code for Information Interchange,&rdquo; ANSI&nbsp;X3.4, 1986.</td></tr>
<tr><td class="author-text" valign="top"><a name="ETSI-TS102172">[ETSI-TS102172]</a></td>
<td class="author-text"><a href="mailto:">ETSI</a>, &ldquo;Minimum Requirements for Interoperability of European ENUM Implementations,&rdquo; ETSI TS&nbsp;102 172, October&nbsp;2004.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2915">[RFC2915]</a></td>
<td class="author-text">Mealling, M. and R. Daniel, &ldquo;<a href="http://tools.ietf.org/html/rfc2915">The Naming Authority Pointer (NAPTR) DNS Resource Record</a>,&rdquo; RFC&nbsp;2915, September&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2915.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2916">[RFC2916]</a></td>
<td class="author-text">Faltstrom, P., &ldquo;<a href="http://tools.ietf.org/html/rfc2916">E.164 number and DNS</a>,&rdquo; RFC&nbsp;2916, September&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2916.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3401">[RFC3401]</a></td>
<td class="author-text">Mealling, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3401">Dynamic Delegation Discovery System (DDDS) Part One: The Comprehensive DDDS</a>,&rdquo; RFC&nbsp;3401, October&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3401.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3824">[RFC3824]</a></td>
<td class="author-text">Peterson, J., Liu, H., Yu, J., and B. Campbell, &ldquo;<a href="http://tools.ietf.org/html/rfc3824">Using E.164 numbers with the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3824, June&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3824.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Lawrence Conroy</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Roke Manor Research</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Roke Manor</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Old Salisbury Lane</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Romsey</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">United Kingdom</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+44-1794-833666</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:lconroy@insensate.co.uk">lconroy@insensate.co.uk</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.sienum.co.uk">http://www.sienum.co.uk</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Kazunori Fujiwara</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Japan Registry Service Co., Ltd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Chiyoda First Bldg. East 13F</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">3-8-1 Nishi-Kanda Chiyoda-ku</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tokyo 101-0165</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">JAPAN</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:fujiwara@jprs.co.jp">fujiwara@jprs.co.jp</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://jprs.jp/en/">http://jprs.jp/en/</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
