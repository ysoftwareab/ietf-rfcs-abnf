<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Session-Specific Explicit
Diameter Request Routing</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Session-Specific Explicit
Diameter Request Routing">
<meta name="keywords" content="Diameter routing">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">T. Tsou</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Huawei Technologies</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">G. Zorn</td></tr>
<tr><td class="header">Expires: December 24, 2010</td><td class="header">Network Zen</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">T. Taylor, Ed.</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Huawei Technologies</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">June 22, 2010</td></tr>
</table></td></tr></table>
<h1><br />Session-Specific Explicit
Diameter Request Routing<br />draft-tsou-diameter-explicit-routing-05</h1>

<h3>Abstract</h3>

<p>   
      This document describes a mechanism to enable specific Diameter proxies
to remain in the path of all message exchanges constituting a Diameter session.
This document is being published to provide the basis for a standardized
solution to a problem raised by some architectures (e.g., WLAN 3GPP IP access,
3GPP TS23.234) that use Diameter. The intended use will be as a reference
within the non-IETF specification of a Diameter application that meets the
needs of these architectures.     
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on December 24, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<p>
This document may contain material from IETF Documents or IETF
Contributions published or made publicly available before November
10, 2008.  The person(s) controlling the copyright in some of this
material may not have granted the IETF Trust the right to allow
modifications of such material outside the IETF Standards Process.
Without obtaining an adequate license from the person(s) controlling
the copyright in such materials, this document may not be modified
outside the IETF Standards Process, and derivative works of it may
not be created outside the IETF Standards Process, except to format
it for publication as an RFC or to translate it into languages other
than English.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#intro">1.</a>&nbsp;
Introduction<br />
<a href="#term">2.</a>&nbsp;
Terminology<br />
<a href="#wlan">3.</a>&nbsp;
The 3GPP Wireless LAN (WLAN) Access Architecture<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#keepPath">3.1.</a>&nbsp;
Maintaining the Routing Path<br />
<a href="#explicit">4.</a>&nbsp;
Diameter Explicit Routing (ER)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expOrig">4.1.</a>&nbsp;
Originating a request (ER-Originator)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expRel">4.2.</a>&nbsp;
Relaying and Proxying Requests (ER-Proxy)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expRecv">4.3.</a>&nbsp;
Receiving Requests (ER-Destination)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expAns">4.4.</a>&nbsp;
Diameter answer processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expFail">4.5.</a>&nbsp;
Failover and Failback Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#AVPs">4.6.</a>&nbsp;
Attribute-Value Pairs<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expPathRecAVP">4.6.1.</a>&nbsp;
Explicit-Path-Record AVP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#pathProxrlm">4.6.1.1.</a>&nbsp;
Proxy-Realm AVP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expPathAVP">4.6.2.</a>&nbsp;
Explicit-Path AVP<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expErr">4.7.</a>&nbsp;
Error Handling<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#expExamp">4.8.</a>&nbsp;
Example Message Flow<br />
<a href="#RADDiam">5.</a>&nbsp;
RADIUS/Diameter Protocol Interactions<br />
<a href="#IANA">6.</a>&nbsp;
IANA Considerations<br />
<a href="#secur">7.</a>&nbsp;
Security Considerations<br />
<a href="#ack">8.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">9.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">9.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">9.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>   
      In the Diameter base protocol <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>, the routing of
request messages is based solely on the routing decisions made separately by
each node along the path. <a class='info' href='#RFC5729'>[RFC5729]<span> (</span><span class='info'>Korhonen, J., Jones, M., Morand, L., and T. Tsou, &ldquo;Clarifications on the Routing of Diameter Requests Based on the Username and the Realm,&rdquo; December&nbsp;2009.</span><span>)</span></a> has added the ability to
force messages to pass through a specified set of realms through the use of NAI
decoration. However, no other specification provides the ability to force
routing through a specific set of agents. Therefore, in a topology where
multiple paths exist from source to destination, there is no guarantee that all
messages relating to a given session will take the same path. In general, this
has not caused problems, but some architectures (e.g., WLAN 3GPP IP access <a class='info' href='#TS23.234'>[TS23.234]<span> (</span><span class='info'>3GPP, &ldquo;3GPP system to Wireless Local Area Network (WLAN) interworking; System description,&rdquo; 2006.</span><span>)</span></a>) require that once certain agents become engaged in a
session, they are able to process all subsequent messages for that session.
		
</p>
<p>While the solution presented in this document is valid, it violates one of
the basic premises of Diameter, the robustness of its architecture. With normal
Diameter routing, sessions will survive failures of agents along the routing
path. With the proposals in this document, routing becomes pinned to specific
agents whose failure will terminate the session. The IETF does not endorse this
specification because of its impact on Diameter session survivability, but do
not object to its publication for use in specialized situations where the loss
of robustness is acceptable. 
</p>
<p>The authors see no interaction between explicit routing and the specific
applications with which it is employed. Hence in principle it can be added to
existing applications if they support the necessary extensibility, and equally
can be used with new applications.
</p>
<a name="term"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>
      The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document
are to be interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
			<br />
<br />

      The following terms are used to define the functionality and
participants in the routing extensions described in this document.
			</p>
<blockquote class="text"><dl>
<dt>ER</dt>
<dd> 
					
      Explicit routing, the mechanism provided by this specification to allow
proxies traversed by the initial message of a session to ensure that they
remain on the messaging path for all subsequent request messages of a session.
				
</dd>
<dt>ER-proxy</dt>
<dd>
					
      A proxy that implements the ER mechanism and can therefore use it to
remain in the path for subsequent messages of a session.
                        
</dd>
<dt>ER-Destination</dt>
<dd>
					
      A Diameter node which is capable of participating in ER and which will
ultimately consume the request sent by an ER-Originator.
				
</dd>
<dt>ER-Originator</dt>
<dd>
					
	A Diameter node initiating a session and sending the requests. The ER-
Originator can be any Diameter node sending a request, i.e. client, server or
proxy capable of initiating sessions and participating in ER.
				
</dd>
<dt>AAA Relays</dt>
<dd>
					
	Other Diameter nodes interspersed between the ER-Originator, ER-Proxies, and
the ER-Destination. These nodes represent existing Diameter agents and proxies
that do not participate in ER and do not recognize Explicit-Path AVPs.
				
</dd>
</dl></blockquote><p>
		
</p>
<a name="wlan"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
The 3GPP Wireless LAN (WLAN) Access Architecture</h3>

<p>
	One example of a system requiring  that certain agents (stateful proxies, in
this case) remain in the forwarding path of all session messages is the 3GPP
WLAN IP access architecture <a class='info' href='#TS23.234'>[TS23.234]<span> (</span><span class='info'>3GPP, &ldquo;3GPP system to Wireless Local Area Network (WLAN) interworking; System description,&rdquo; 2006.</span><span>)</span></a>. The 3GPP WLAN
interworking architecture extends 3GPP services to the WLAN access side,
enabling a 3GPP subscriber to use a WLAN to access 3GPP services.
		<br />
<br />

	WLAN AAA provides access to the WLAN to be authenticated and authorized through
the 3GPP system. This access control can permit or deny a subscriber the access
to the WLAN system and/or the 3GPP system.
		<br />
<br />

	There are two 3GPP WLAN interworking reference models:
		</p>
<ol class="text">
<li>
	In the non-roaming case, the model includes the WLAN access network and the
3GPP AAA server in the home network. The 3GPP AAA server is responsible for
access control as well as charging.
			
</li>
<li>
	In the roaming case, the model includes the WLAN access network, the 3GPP AAA
proxy in the visited network and the 3GPP AAA server in the home network. The
3GPP AAA server is responsible for access control. Charging records may be
generated by the AAA proxy and/or the AAA server. The AAA proxy relays access
control and charging messages to the AAA server. The AAA proxy will also do
offline charging, if required.
			
</li>
</ol><p>
	The roaming case presents two problems for which the Diameter routing
mechanism described in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a> does not offer any unambiguous
and standard solution.
			</p>
<blockquote class="text"><dl>
<dt>Network Selection</dt>
<dd>
					
	Selecting an initial message path for the Diameter session through (possibly
many) alternative visited network(s) to the home network.
				
</dd>
<dt>Explicit Routing</dt>
<dd> 
					 
	Maintaining the selected message path for all messages in the Diameter session.
				
</dd>
</dl></blockquote><p>
	The former is outside the scope of this document; the latter is described in
detail below.
	
</p>
<a name="keepPath"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Maintaining the Routing Path</h3>

<p>
	After a successful authentication, a Diameter session is established
involving (at least) the following stateful entities:
			</p>
<ul class="text">
<li>   
	the Diameter client in the WLAN access node,
				
</li>
<li>
	a Diameter proxy (the 3GPP AAA proxy) in the visited mobile network, and
				
</li>
<li>
	a Diameter server in the user's home realm.
				
</li>
</ul><p>
	The functions assigned to the 3GPP AAA proxy include:
			</p>
<ul class="text">
<li>
	Reporting charging information to the offline charging system in the visited
network
				
</li>
<li>
	Policy enforcement based on roaming agreements
				
</li>
<li>
	Service termination initiated by the visited network operator
				
</li>
</ul><p>
	These functions all require that state be maintained within the visited
network. The 3GPP choice is to maintain that state at the 3GPP AAA proxy. This
means that the latter must remain in the messaging path for all subsequent
messages relating to the same session.
		
</p>
<a name="explicit"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Diameter Explicit Routing (ER)</h3>

<p>
	This section outlines a Diameter ER mechanism by which Diameter nodes
participating in ER can remain in the path of all request messages for a
specific session. A new Explicit-Path AVP is
defined to enable ER participants to manipulate the Destination-Host and/or
Destination-Realm AVPs of request messages in order to ensure the correct
routing behavior. The following sections describe the extensions to the request
routing in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a> to implement the ER mechanism. The proposed
extensions utilize existing routing strategies in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a> and
do not mandate modifications to it. The scheme also differs from existing strict
source routing schemes in which all hops in the path have to participate. In the
ER mechanism, only Diameter nodes interested in participating in the ER scheme
will be involved in it. 
	
</p>
<a name="expOrig"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Originating a request (ER-Originator)</h3>

<p>	A Diameter node acting as an ER-Originator for a particular session MUST
maintain a local cache which enumerates all the Diameter identities of the ER-
Proxies that the request messages must traverse along the path to the ER-
Destination.  
	The identity of a Diameter node is defined in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>.  
	The local cache may also include the node's realm.  
	The data structure of the cache is left up to the implementation and should
persist as part of the session attributes or properties.
</p>
<p>	An ER-Originator sending request messages MUST add an Explicit-Path AVP to
these requests.  
	The contents of the cache SHOULD be used to populate the Explicit-Path AVP
where each cached entry is represented by a corresponding instance of the
Explicit-Path-Record AVP.  
	ER-Proxies along the path of the request message MUST examine the contents of
the Explicit-Path AVP and make routing adjustments based on records it
contains.  
	An example of the message flow is shown in <a class='info' href='#expExamp'>Section&nbsp;4.8<span> (</span><span class='info'>Example Message Flow</span><span>)</span></a>.  
	Note that the ER-Originator can be any Diameter node, i.e. client, server or
proxy.
</p>
<p>	The ER-Originator can populate the cache either by pre-configuring its
contents or by using the first request message of the session to gather
identities of participating ER-Proxies along the routing path. 
	The latter scheme is known as Explicit-Path discovery.  
	The contents of the cache can be pre-configured if the ER-Originator has
explicit knowledge of the ER-Proxies the request messages must traverse;
otherwise it can use Explicit-Path discovery.  
	It is recommended that Explicit-Path discovery be used whenever possible
since pre-configuration is less flexible by nature. 
</p>
<p>	Explicit-Path discovery is useful if the identities of the ER-Proxies are
not known or if there are several ER capable proxies (a cluster of proxies)
that can be dynamically chosen based on other routing policies. 
	In Explicit-Path discovery, the cache of the ER-originator is initially
empty.  
	When the ER-Originator sends the first request message of a session, the
Explicit-Path AVP will contain only one Explicit-Path-Record AVP with the
identity and/or the realm of the ER-Originator.  
	The Destination-Host and/or Destination-Realm AVP of the request message is
set to the identity and/or the realm of the ER-Destination respectively as
specified in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>. 
	</p>
<blockquote class="text">
<p>It should be noted that ER-Originator initial request message routing
procedures and the population of Destination-Realm may be affected by the User-
Name AVP NAI decoration <a class='info' href='#RFC5729'>[RFC5729]<span> (</span><span class='info'>Korhonen, J., Jones, M., Morand, L., and T. Tsou, &ldquo;Clarifications on the Routing of Diameter Requests Based on the Username and the Realm,&rdquo; December&nbsp;2009.</span><span>)</span></a>.  
	NAI decoration is a form of request message source routing and defines realms
that the request message must traverse through before routing towards the ER-
Destination.  
	Diameter nodes participating to the request message routing must examine and
process the User-Name AVP, and modify the Destination-Realm AVP accordingly as
long as there are realms left in the decorated NAI.  
	Source routing based upon NAI decoration does not affect the Explicit-Path
discovery as defined in this document.
</p>
</blockquote><p>
 
</p>
<p>	When the request message is received and processed by an ER-Proxy, the ER-
Proxy MUST append a new Explicit-Path-Record containing its own identity and/or
realm to the Explicit-Path AVP prior to forwarding the message.  
	Subsequent ER-Proxies along the path that wish to participate in the ER MUST
also append their own Explicit-Path-Record in the same manner (<a class='info' href='#expRel'>Section&nbsp;4.2<span> (</span><span class='info'>Relaying and Proxying Requests (ER-Proxy)</span><span>)</span></a>).  
	When the request reaches the ER-Destination, it MUST append a new Explicit-
Path-Record to the Explicit-Path AVP in a similar manner.  
	The ER-Destination MUST copy the resulting Explicit-Path AVP to the answer
message (<a class='info' href='#expRecv'>Section&nbsp;4.3<span> (</span><span class='info'>Receiving Requests (ER-Destination)</span><span>)</span></a>).  
	Once the answer message reaches the ER-Originator, the Explicit-Path AVP will
contain one or more Explicit-Path-Records containing the ER-Originator's
identity, the identities of all participating ER-Proxies and the identity of
the ER-Destination.  
	The ER-Originator SHOULD populate its local cache with the contents of the
Explicit-Path AVP received in this initial answer message.
</p>
<p>	If the answer message does not contain an Explicit-Path AVP or the Result-
Code AVP is set to Diameter_ER_NOT_AVAILABLE (<a class='info' href='#expErr'>Section&nbsp;4.7<span> (</span><span class='info'>Error Handling</span><span>)</span></a>), it is
an indication to the ER-Originator that the destination of the request does not
support ER and that the ER-Originator SHOULD avoid sending an Explicit-Path AVP
in subsequent request messages.
</p>
<p>	If, after performing Explicit-Path discovery, the Explicit-Path AVP in the
answer message contains only the Explicit-Path-Record of the ER-Originator and
ER-Destination then this SHOULD be an indication to the ER-Originator that
there are no Diameter proxies capable of participating in ER along the path and
that the ER-Originator SHOULD NOT send an Explicit-Path AVP in subsequent
request messages of this session. 
	See <a class='info' href='#expFail'>Section&nbsp;4.5<span> (</span><span class='info'>Failover and Failback Considerations</span><span>)</span></a> for more discussion.  
	In such cases, the situation may be transient and Explicit-Path discovery in
succeeding sessions may find participating proxies.  
	It is left up to the ER-Originator to decide if Explicit-Path discovery
should be attempted in succeeding sessions. 
</p>
<p>	Once the ER-Originator's local cache has been populated, whether by pre-
configuration or through Explicit-Path discovery, all request messages for the
session MUST include the Explicit-Path AVP using the contents of the local
cache.  
	The Explicit-Path AVP MUST contain the Explicit-Path-Records of all the nodes
enumerated in the cache except that of the ER-Originator itself. 
	The identities enumerated in the Explicit-Path AVP MUST appear in the order
they will be traversed in the routing path.  
	The last entry in the Explicit-Path AVP MUST be the Explicit-Path-Record of
the ER-Destination.  
	In addition, the value of the Destination-Host and/or Destination-Realm AVP
of the request messages MUST be set to the value of the Proxy-Host and/or Proxy-
Realm of the first Explicit-Path-Record AVP present in the Explicit-Path AVP.  
</p>
<blockquote class="text">
<p>		
	This ensures that the ER-Originator as well as any AAA relays in between the
ER-Originator and the first ER-Proxy will route the message towards the first
ER-Proxy as specified in RFC3588 <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>.
     
</p>
</blockquote><p>
	Subsequent actions taken by the first ER-Proxy upon receipt of the message
are described in <a class='info' href='#expRel'>Section&nbsp;4.2<span> (</span><span class='info'>Relaying and Proxying Requests (ER-Proxy)</span><span>)</span></a> and will mimic those of the ER-
Originator.
</p>
<p>	Answer messages received by the ER-Originator to subsequent request
messages after the ER path has been established SHOULD NOT have an Explicit-
Path AVP. Otherwise, this SHOULD be considered a suspect condition that may be
caused by a misbehaving ER participant.  
	It is left up to the ER-Originator whether to continue using the ER scheme
when such a condition arises or to attempt another Explicit-Path discovery on
subsequent sessions.
</p>
<a name="expRel"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Relaying and Proxying Requests (ER-Proxy)</h3>

<p> 
	The basic action taken by an ER-Proxy upon receiving a request is to check
whether explicit routing is supported in the request and if so, check whether
it is already a participant in explicit routing for the said request.
      If it is an existing participant, the ER-Proxy MUST pop/remove the
Explicit-Path-Record AVP pertaining to itself from the Explicit-Path AVP and
then use the next Explicit-Path-Record AVP for subsequent routing.
      Details of this operation are as follows.
			<br />
<br />

	An ER-Proxy is not required to keep local state or cache state regarding the
explicit routing procedure.
      However, it MUST check whether an incoming request contains an Explicit-
Path AVP. 
			</p>
<ol class="text">
<li>
	If an incoming request does not contain an Explicit-Path AVP then the ER-
Proxy MUST process and forward the request as specified in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>.  				
				
</li>
<li>
	If the incoming request contains an Explicit-Path AVP, the ER-Proxy MUST
check whether its identity is present in the Explicit-Path AVP.
      Determining whether its identity is present can be done by matching its
identity to the Proxy-Host AVPs contained in each Explicit-Path-Record.
					
<blockquote class="text"><dl>
<dt>A.</dt>
<dd>
	If its identity is not present and it wishes to participate in explicit
routing, the ER-Proxy MUST append a new Explicit-Path-Record as the last AVP in
the Explicit-Path AVP prior to forwarding the request.
      The new Explicit-Path-Record MUST contain at the least a Proxy-Host AVP
set to the proxy's identity.
      This scenario is part of the Explicit-Path discovery scheme described in
<a class='info' href='#expOrig'>Section&nbsp;4.1<span> (</span><span class='info'>Originating a request (ER-Originator)</span><span>)</span></a>.						
						
</dd>
<dt>B.</dt>
<dd>
	However, if its identity is not present and the ER-Proxy does not wish to
participate in the ER, it SHOULD NOT modify the Explicit-Path AVP and SHOULD
simply forward the request as specified in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a> using the
existing value of Destination-Host and/or Destination-Realm AVP.
      Non ER-proxies and relays that do not support ER and do not recognize
Explicit-Path AVP will take the same action.
						
</dd>
<dt>C.</dt>
<dd>
	If the identity of the ER-Proxy is present in the Explicit-Path AVP, then it
MUST be the first Explicit-Path-Record in the AVP; otherwise, this SHOULD be
considered an error and an answer message with the e-bit set and the Result-
Code set to Diameter_INVALID_PROXY_PATH_STACK must be sent back to the ER-
Originator (<a class='info' href='#expErr'>Section&nbsp;4.7<span> (</span><span class='info'>Error Handling</span><span>)</span></a>).
      If the identity of the ER-Proxy matches the first Explicit-Path-Record,
the ER-Proxy MUST remove this record from Explicit-Path AVP and set the
Destination-Host and/or Destination-Realm AVP to the next Explicit-Path-Record
present in the Explicit-Path AVP.
      Setting the Destination-Host and/or Destination-Realm AVP will ensure
that the ER-Proxy as well as all AAA relays in between the current ER-Proxy and
the next ER-Proxy enumerated in the Explicit-Path AVP will route the message
towards the next ER-Proxy.
      The process of removing the ER-Proxy's record is analogous to removing
an entry in a stack represented by the Explicit-Path AVP. 						
						
</dd>
</dl></blockquote>
				
</li>
</ol><p>
	Note that in the case of the ER-Destination, the Explicit-Path AVP MUST be
empty once its own record is removed (<a class='info' href='#expRecv'>Section&nbsp;4.3<span> (</span><span class='info'>Receiving Requests (ER-Destination)</span><span>)</span></a>).  
	Note also that the behavior specified above applies to a Diameter node that
acts as a relay agent and participates in the ER scheme.
		
</p>
<a name="expRecv"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Receiving Requests (ER-Destination)</h3>

<p>   
	A Diameter node that locally processes requests sent by the ER-Originator
(<a class='info' href='#expOrig'>Section&nbsp;4.1<span> (</span><span class='info'>Originating a request (ER-Originator)</span><span>)</span></a>) and is able to support ER (an ER-Destination) MUST
check for the presence of an Explicit-Path AVP in the request message.  
			</p>
<ol class="text">
<li>
	If an incoming request does not contain an Explicit-Path AVP then it is an
indication that messages belonging to this session will not use ER.
      The Diameter node SHOULD process the request for local consumption and
formulate an answer message as specified in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>.  				
				
</li>
<li>
	If the incoming request contains an Explicit-Path AVP, the Diameter node MUST
check whether its identity is present in the Explicit-Path AVP.  	
					
<blockquote class="text"><dl>
<dt>A.</dt>
<dd>
							If its identity is not present in the Explicit-Path and it wishes to
participate in the ER, the Diameter node MUST append a new Explicit-Path-Record
to the Explicit-Path AVP in the received message.
      The new Explicit-Path-Record MUST contain at the least a Proxy-Host AVP
set to the ER-Destination's identity.
      The ER-Destination MUST then copy the resulting Explicit-Path AVP to the
subsequent answer message.
      This scenario is part of the proxy path discovery scheme described in
<a class='info' href='#expOrig'>Section&nbsp;4.1<span> (</span><span class='info'>Originating a request (ER-Originator)</span><span>)</span></a>.  
						
</dd>
<dt>B.</dt>
<dd>
	If its identity is not present and the ER-Destination supports ER but does
not wish to or cannot participate, it MAY send a Result-Code AVP set to
Diameter_ER_NOT_AVAILABLE as defined in <a class='info' href='#expErr'>Section&nbsp;4.7<span> (</span><span class='info'>Error Handling</span><span>)</span></a>.
      The ER-Destination SHOULD NOT include any Explicit-Path AVP in the
subsequent answer.
      The same scenario applies to ER-destinations that do not support ER and
do not recognize Explicit-Path AVP and is a hint to the ER-Originator that the
destination does not support ER.
						
</dd>
<dt>C.</dt>
<dd>
	If the identity of the ER-Destination matches a record in the Explicit-Path
AVP, then it MUST be the only Explicit-Path-Record present in the Explicit-Path
AVP otherwise, this SHOULD be considered an error and an answer message with
the 'E' bit set and containing an Experimental-Result-Code AVP with the set to
Diameter_INVALID_PROXY_PATH_STACK MUST be sent back to the ER-Originator (<a class='info' href='#expErr'>Section&nbsp;4.7<span> (</span><span class='info'>Error Handling</span><span>)</span></a>).
      If the identity of the of the ER-Destination matches the only existing
Explicit-Path-Record, then this is an indication of a successful ER, but with
no participating ER-Proxies.
      The ER-Destination SHOULD NOT copy the Explicit-Path AVP into the
subsequent answer message.						
						
</dd>
</dl></blockquote>			
				
</li>
</ol><p>
		
</p>
<a name="expAns"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Diameter answer processing</h3>

<p>   
	There is no requirement on Diameter nodes participating in ER to provide
special handling or routing of answer messages.
	Answer messages SHOULD be processed normally as specified in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>.  
	However, a Diameter node acting as an ER-Destination MUST formulate a proper
Explicit-Path AVP in answer messages as described in <a class='info' href='#expRecv'>Section&nbsp;4.3<span> (</span><span class='info'>Receiving Requests (ER-Destination)</span><span>)</span></a>.
		
</p>
<a name="expFail"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Failover and Failback Considerations</h3>

<p>  
	If there is no ER-Proxy along the selected path, the answer message will
contain an Explicit-Path AVP that contains only the Explicit-Route-Records of
the ER-Originator and the ER-Destination, indicating that there is no ER
support found in Diameter nodes along the path.  
	It is left to the ER-Originator to continue with processing of the request
without ER support or terminate the session.  
	The ER-Originator SHOULD NOT attempt to perform Explicit-Path discovery in
subsequent request messages of this session in such cases so as to protect
against failback conditions where an ER-Proxy suddenly appears in the path and
attempts to add a new Explicit-Path-Record for request messages other than the
initial request.

</p>
<blockquote class="text">
<p>
      Allowing an ER-Proxy to join the session after the initial request is
permissible only if the application requirements do not mandate that any
participating ER-Proxy receive all of the messages of a session.

</p>
</blockquote><p>
  
	However, based on local policy, the ER-Originator MAY attempt Explicit-Path
discovery in subsequent sessions.
			<br />
<br />

	If a failover occurs in a Diameter node preceding an ER-Proxy when the ER
path is already established, it is possible that an Diameter_UNABLE_TO_DELIVER
error will be received by the ER-Originator if there are no alternative paths
towards the ER-proxy.
      In such a case, it is left to the ER-Originator to handle the error as
specified in Diameter application or in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>.
		
</p>
<a name="AVPs"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
Attribute-Value Pairs</h3>

<p>
	The following sections define the AVPs used in the ER process.  
	All of these AVPs MUST have the 'V' bit set and the 'M' bit cleared, with the
Vendor-ID field set to 2011 (as assigned in 
http://www.iana.org/assignments/enterprise-numbers). 
		
</p>
<a name="expPathRecAVP"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6.1"></a><h3>4.6.1.&nbsp;
Explicit-Path-Record AVP</h3>

<p>
	The Explicit-Path-Record AVP (AVP Code 35001) is of type Group.  
	The identity added in the Proxy-Host <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a> element of this
AVP MUST be the same as the one advertised by the Diameter node in the Origin-
Host AVP during the Capabilities Exchange messages. 
				</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     Explicit-Path-Record ::= &lt; AVP Header: 35001 &gt;
                              { Proxy-Host }
                              [ Proxy-Realm ]
</pre></div><p>

			
</p>
<a name="pathProxrlm"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6.1.1"></a><h3>4.6.1.1.&nbsp;
Proxy-Realm AVP</h3>

<p>
	The Proxy-Realm AVP (AVP Code 35002) is of type DiameterIdentity, and
contains the realm of the ER node inserting the record.  
					<br />
<br />

	It is recommended that the Proxy-Host AVP be present and used to uniquely
identify an ER-Proxy within the AAA realm being traversed by a request.  
	Otherwise, ER will need to rely on realm routing.  
	Realm routing would require a well-known topology for the ER scheme to work
properly since the hostname of the proxy is not specified. 
	In such a case, the Proxy-Realm AVP MUST be present and is used to identify
the ER-Proxy of the realm.
					<br />
<br />

	When a Proxy-Host AVP is present in the Explicit-Path-Record AVP, the realm
name included in the hostname MUST correspond to the identity present in the
Proxy-Realm AVP.
				
</p>
<a name="expPathAVP"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6.2"></a><h3>4.6.2.&nbsp;
Explicit-Path AVP</h3>

<p>
	The Explicit-Path AVP (AVP Code 35003) is of type Grouped.
      This AVP SHOULD be present in all request and answer messages performing
ER.
				</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      Explicit-Path ::= &lt; AVP Header: 35003 &gt;
                     1* [ Explicit-Path-Record ]
                      * [ AVP ]
</pre></div><p>

			
</p>
<a name="expErr"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7"></a><h3>4.7.&nbsp;
Error Handling</h3>

<p>   
	The following error conditions may occur during ER processing.  
	All error indications MUST be encapsulated in an instance of the Experimental-
Result AVP <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a> with the Vendor-Id AVP set to 2011 and the
Experimental-Result-Code set as specified below.
			</p>
<blockquote class="text"><dl>
<dt>DIAMETER_INVALID_PROXY_PATH_STACK 	3501</dt>
<dd>
					
	A request message received by an ER-Proxy or ER-Destination after an ER path
has been established has the first or only Explicit-Path-Record AVP not
matching the ER-Proxy or the ER-Destinations identity.  
      The same error applies to ER-Destinations receiving a Explicit-Path-AVP
containing more than one Explicit-Path-Record or an Explicit-Path-AVP with only
one Explicit-Path-Record not matching its own identity.
					<br />
<br />

	This error SHOULD be considered a protocol failure and SHOULD be treated on a
per-hop basis; Diameter proxies may attempt to correct the error, if possible.
	Diameter answer messages containing this error indication MUST have the 'E'
bit set and MUST conform to Section 7.2 of <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>.
				
</dd>
<dt>DIAMETER_ER_NOT_AVAILABLE 			4501</dt>
<dd>
									
	An ER-Destination which supports ER routing but is unable to comply for
unknown reasons MAY send an answer message with the Result-Code AVP set to this
error code.
      This error value SHOULD be considered a transient failure indicating
that subsequent ER attempts may succeed.
				
</dd>
</dl></blockquote><p>
		
</p>
<a name="expExamp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.8"></a><h3>4.8.&nbsp;
Example Message Flow</h3>

<p>
	The example presented here illustrates the flow of Diameter messages with the
typical attributes present in the ER scenario.
			<br />
<br />

	The ER-Originator in the example below shows the use of Explicit-Path
discovery with the first request. 
	However, the ER-Originator may also use a pre-configured cache.
      The ER-Originator can be any Diameter node sending a request, i.e.
client, server or proxy.
	In this scenario, the local cache of the ER-Originator is initially empty.
			<br />
<br />

	The AAA relays in between the ER-Proxies, ER-Originator and ER-Destination
may or may not be present and are shown here to depict routing paths that the
requests may take prior to being processed by nodes participating in the ER
scheme.  
	The AAA relays also depict existing Diameter relays or proxies that do not
recognize Explicit-Path AVPs and therefore do not participate in ER.
			<br /><hr class="insert" />
<a name="fig_examp"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
       ER-                     ER-                   ER-         ER-
   Originator   AAA relays   proxy1   AAA relays   proxy2    Destination
      (o.r1                  (p.r1                 (p.r2       (d.r2
     .example)              .example)             .example)   .example)
                     |          |          |          |          |
   cache=(empty)     |          |          |          |          |
       -------------&gt;|---------&gt;|          |          |          |
    (1st request of the session)|          |          |          |
         Explicit-Path=         |          |          |          |
           o.r1.example,r1.example         |          |          |
     dest-host=d.r2.example     |          |          |          |
     dest-realm=r2.example      |          |          |          |
                     |          |          |          |          |
                     |          |---------&gt;|---------&gt;|          |
                     |          |  (forwarded request)|          |
                     |          |  Explicit-Path=     |          |
                     |          |    record1=o.r1.example,reaml1.example
                     |          |    record2=p.r1.example,r1.example
                     |          |  dest-host=d.r2.example        |
                     |          |  dest-realm=r2.example         |
                     |          |          |          |          |
                     |          |          |          |---------&gt;|
                     |          |          |      (forwarded request)
                     |          |          |      Explicit-Path=
                     |          |          |       record1=o.r1.example,
                     |          |          |               r1.example
                     |          |          |       record2=p.r1.example,
                     |          |          |               r1.example
                     |          |          |       record3=p.r2.example,
                     |          |          |               r2.example
                     |          |          |     dest-host=d.r2.example
                     |          |          |     dest-realm=r2.example
                     |          |          |          |          |
    cache=           |&lt;---------|&lt;---------|&lt;---------|&lt;---------|
      record1=o.r1.example,r1.example         (answer)           |
      record2=p.r1.example,r1.example   Explicit-Path=
      record3=p.r2.example,r2.example    record1=o.r1.example,r1.example
      record4=d.r2.example,r2.example    record2=p.r1.example,r1.example
                     |          |        record3=p.r2.example,r2.example
                     |          |        record4=d.r2.example,r2.example
    Note: An originator pre-configuring    |          |          |
          its local cache can skip the     |          |          |
          exchange above and send the      |          |          |
          initial request as shown below   |          |          |
                     |          |          |          |          |
       -------------&gt;|---------&gt;|          |          |          |
    (subsequent request of the session)    |          |          |
         Explicit-Path=         |          |          |          |
   record1=p.r1.example,r1.example         |          |          |
   record2=p.r2.example,r2.example         |          |          |
   record3=d.r2.example,r2.example         |          |          |
     dest-host=p.r1.example     |          |          |          |
     dest-realm=r1.example      |          |          |          |
                     |          |---------&gt;|---------&gt;|          |
                     |          |  (forwarded request)|          |
                     |          |  Explicit-Path=     |          |
                     |          |      record1=p.r2.example,r2.example
                     |          |      record2=d.r2.example,r2.example
                     |          |  dest-host=p.r2.example        |
                     |          |  dest-realm=r2.example         |
                     |          |          |          |          |
                     |          |          |          |---------&gt;|
                     |          |          |     (forwarded request)
                     |          |          |     Explicit-Path
                     |          |          |       record1=d.r2.example,
                     |          |          |               r2.example
                     |          |          |     dest-host=d.r2.example
                     |          |          |     dest-realm=r2.example
                     |          |          |          |          |
    cache=           |&lt;---------|&lt;---------|&lt;---------|&lt;---------|
      record1=o.r1.example,r1.example    (answer)     |          |
      record2=p.r1.example,r1.example    * no Explicit-Path-AVP present
      record3=p.r2.example,r2.example      |          |          |
      record4=d.r2.example,r2.example      |          |          |
                     |          |          |          |          |
                     |          |          |          |          |
     (subsequent request of the session will repeat the process above)
                     |          |          |          |          |
                     |          |          |          |          |
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Example ER Message Flow&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

		
</p>
<a name="RADDiam"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
RADIUS/Diameter Protocol Interactions</h3>

<p>
	No actions need to be taken with regards to RADIUS/Diameter interaction.  
	The routing extension described in this document is transparent to any
translation gateway and relevant only to Diameter routing.
	The assumption is that if there is a RADIUS proxy chain between Diameter
translation agents the route between translation agents remains stable during
the session and does not cause an invalidation of the proxy path stack.
	
</p>
<a name="IANA"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
IANA Considerations</h3>

<p>
	Because this document defines only vendor-specific AVPs and result codes, no
IANA actions are necessary.
	
</p>
<a name="secur"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Security Considerations</h3>

<p>
	The security considerations in <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a> apply to this
extension. In addition, this extension raises questions of authorization and
can potentially allow a new denial of service attack.
	
</p>
<p>
The authorization issue comes about because the proxies that participate in ER
are self-selected. An ER-Proxy is able, through the operation of ER, to
guarantee that it can monitor every message of a session. This is in contrast to
ordinary Diameter routing, where some messages may pass by an alternate route.
The question is whether the originating party is prepared to extend this
additional degree of trust to arbitrary parties along the path. If not, the ER-
Originator requires a mechanism to determine whether an ER-Proxy listed in the
returned Explicit-Path AVP can be trusted. If it has such a mechanism, then an
unwanted ER-Proxy can be deleted from its cache and thus not appear in the ER-
Path AVP in subsequent requests. This specification assumes that the
originating party is either prepared to allow arbitrary Diameter nodes along
the path to attach themselves to the session as ER-Proxies, or else the ER-
Originator maintains a pre-configured list of ER-Proxies in its cache. 

</p>
<p>
The potential denial of service attack is not a serious one because the same
result can be obtained more directly. An attacker with control of a Diameter
node along the path of the original request could insert an Explicit-Path-
Record containing the identity of another node or a non-existent node, rather
than its own identity. Routing subsequent messages of the session through
another node could result in violation of the trust assumptions made upstream.
Routing subsequent messages to a non-existent node causes them to be lost and
terminates the session. It would seem simpler to perpetrate whatever harm the
attacker intends at the subverted Diameter node itself. The advantage of using
ER to accomplish either of the attacks is that it makes it more difficult to
determine which node misbehaved, but the extra effort involved to implement the
attack does not seem to be worth the potential gain. 

</p>
<a name="ack"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Acknowledgements</h3>

<p>   
	The authors gratefully acknowledge the contributions of: Tony Zhang, Fortune
Huang, Rajith R., Victor Fajardo, Jouni Korhonen, Tolga Asveren, Mark Jones, Avi
Lior, Steve Norreys, Lionel Morand, Dave Frascone and
Hannes Tschofenig.
	
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3588">[RFC3588]</a></td>
<td class="author-text">Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;<a href="http://tools.ietf.org/html/rfc3588">Diameter Base Protocol</a>,&rdquo; RFC&nbsp;3588, September&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3588.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5729">[RFC5729]</a></td>
<td class="author-text">Korhonen, J., Jones, M., Morand, L., and T. Tsou, &ldquo;<a href="http://tools.ietf.org/html/rfc5729">Clarifications on the Routing of Diameter Requests Based on the Username and the Realm</a>,&rdquo; RFC&nbsp;5729, December&nbsp;2009 (<a href="http://www.rfc-editor.org/rfc/rfc5729.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="TS23.234">[TS23.234]</a></td>
<td class="author-text">3GPP, &ldquo;3GPP system to Wireless Local Area Network (WLAN) interworking;
System description,&rdquo; TS&nbsp;23.234 Version 7.4.0, 2006.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tina Tsou</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Huawei Technologies</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bantian, Longgang District</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shenzhen  518129</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.R. China</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:tena@huawei.com">tena@huawei.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Glen Zorn</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Network Zen</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1310 East Thomas Street</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">#306</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Seattle, Washington  98102</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 (206) 377-9035</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:gwz@net-zen.net">gwz@net-zen.net</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tom Taylor (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Huawei Technologies</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1852 Lorraine Ave</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ottawa</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:tom111.taylor@bell.net">tom111.taylor@bell.net</a></td></tr>
</table>
</body></html>
