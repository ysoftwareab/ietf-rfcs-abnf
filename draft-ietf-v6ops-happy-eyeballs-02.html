<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Happy Eyeballs: Trending Towards Success with Dual-Stack Hosts</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Notational Conventions">
<link href="#rfc.section.3" rel="Chapter" title="3 Problem Statement">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 URIs and hostnames">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 IPv6 connectivity">
<link href="#rfc.section.4" rel="Chapter" title="4 Client Recommendations">
<link href="#rfc.section.5" rel="Chapter" title="5 Implementation details: A and AAAA">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Description of State Variables">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Initialization, Cache Flush, and Resetting Smoothed P">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 Connecting to a Server">
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 Adjusting Address Family Preferences">
<link href="#rfc.section.5.5" rel="Chapter" title="5.5 Exception Cache">
<link href="#rfc.section.6" rel="Chapter" title="6 Implementation Details: SRV">
<link href="#rfc.section.7" rel="Chapter" title="7 Additional Considerations">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Additional Network and Host Traffic">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Abandon Non-Winning Connections">
<link href="#rfc.section.7.3" rel="Chapter" title="7.3 Determining Address Type">
<link href="#rfc.section.7.4" rel="Chapter" title="7.4 Debugging and Troubleshooting">
<link href="#rfc.section.7.5" rel="Chapter" title="7.5 DNS Behavior">
<link href="#rfc.section.7.6" rel="Chapter" title="7.6 Middlebox Issues">
<link href="#rfc.section.7.7" rel="Chapter" title="7.7 Multiple Interfaces">
<link href="#rfc.section.7.8" rel="Chapter" title="7.8 Interaction with Same Origin Policy">
<link href="#rfc.section.8" rel="Chapter" title="8 Content Provider Recommendations">
<link href="#rfc.section.9" rel="Chapter" title="9 Security Considerations">
<link href="#rfc.section.10" rel="Chapter" title="10 Acknowledgements">
<link href="#rfc.section.11" rel="Chapter" title="11 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="12 References">
<link href="#rfc.references.1" rel="Chapter" title="12.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="12.2 Informational References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Changes">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 changes from -01 to -02">
<link href="#rfc.appendix.Appendix%20A.2" rel="Chapter" title="Appendix A.2 changes from -00 to -01">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document describes an algorithm for a dual-stack client to quickly determine the functioning address family to a dual-stack server, and trend towards using that same address family for subsequent connections. This improves the dual-stack user experience during IPv6 or IPv4 server or network outages." />
  <meta name="description" content="This document describes an algorithm for a dual-stack client to quickly determine the functioning address family to a dual-stack server, and trend towards using that same address family for subsequent connections. This improves the dual-stack user experience during IPv6 or IPv4 server or network outages." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">v6ops</td>
<td class="right">D. Wing</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">A. Yourtchenko</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">Cisco</td>
</tr>
<tr>
<td class="left">Expires: November 26, 2011</td>
<td class="right">May 25, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Happy Eyeballs: Trending Towards Success with Dual-Stack Hosts<br />
  <span class="filename">draft-ietf-v6ops-happy-eyeballs-02</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document describes an algorithm for a dual-stack client to quickly determine the functioning address family to a dual-stack server, and trend towards using that same address family for subsequent connections. This improves the dual-stack user experience during IPv6 or IPv4 server or network outages.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on November 26, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Notational Conventions</a>
</li>
<li>3.   <a href="#rfc.section.3">Problem Statement</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">URIs and hostnames</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">IPv6 connectivity</a>
</li>
<li>4.   <a href="#rfc.section.4">Client Recommendations</a>
</li>
<li>5.   <a href="#rfc.section.5">Implementation details: A and AAAA</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Description of State Variables</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Initialization, Cache Flush, and Resetting Smoothed P</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">Connecting to a Server</a>
</li>
<li>5.4.   <a href="#rfc.section.5.4">Adjusting Address Family Preferences</a>
</li>
<li>5.5.   <a href="#rfc.section.5.5">Exception Cache</a>
</li>
<li>6.   <a href="#rfc.section.6">Implementation Details: SRV</a>
</li>
<li>7.   <a href="#rfc.section.7">Additional Considerations</a>
</li>
<li>7.1.   <a href="#rfc.section.7.1">Additional Network and Host Traffic</a>
</li>
<li>7.2.   <a href="#rfc.section.7.2">Abandon Non-Winning Connections</a>
</li>
<li>7.3.   <a href="#rfc.section.7.3">Determining Address Type</a>
</li>
<li>7.4.   <a href="#rfc.section.7.4">Debugging and Troubleshooting</a>
</li>
<li>7.5.   <a href="#rfc.section.7.5">DNS Behavior</a>
</li>
<li>7.6.   <a href="#rfc.section.7.6">Middlebox Issues</a>
</li>
<li>7.7.   <a href="#rfc.section.7.7">Multiple Interfaces</a>
</li>
<li>7.8.   <a href="#rfc.section.7.8">Interaction with Same Origin Policy</a>
</li>
<li>8.   <a href="#rfc.section.8">Content Provider Recommendations</a>
</li>
<li>9.   <a href="#rfc.section.9">Security Considerations</a>
</li>
<li>10.   <a href="#rfc.section.10">Acknowledgements</a>
</li>
<li>11.   <a href="#rfc.section.11">IANA Considerations</a>
</li>
<li>12.   <a href="#rfc.references">References</a>
</li>
<li>12.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>12.2.   <a href="#rfc.references.2">Informational References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Changes</a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">changes from -01 to -02</a>
</li>
<li>Appendix A.2.   <a href="#rfc.appendix.Appendix%20A.2">changes from -00 to -01</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">In order to use HTTP successfully over IPv6, it is necessary that the user enjoys nearly identical performance as compared to IPv4. A combination of today's applications, IPv6 tunneling and IPv6 service providers, and some of today's content providers all cause the user experience to suffer (<a href="#problem_statement">Section 3</a>). For IPv6, a content provider may ensure a positive user experience by using a DNS white list of IPv6 service providers who peer directly with them, e.g. <a href="#whitelist">[whitelist]</a>. However, this is not scalable to all service providers worldwide, nor is it scalable for other content providers to operate their own DNS white list.</p>
<p id="rfc.section.1.p.2">Instead, this document suggests a mechanism for applications to quickly determine if IPv6 or IPv4 is the most optimal to connect to a server. The suggestions in this document provide a user experience which is superior to connecting to ordered IP addresses which is helpful during the IPv6/IPv4 transition with dual stack hosts.</p>
<p id="rfc.section.1.p.3">This problem is also described in <a href="#RFC1671">[RFC1671]</a>, published in 1994: </p>

<ul class="empty"><li>"The dual-stack code may get two addresses back from DNS; which does it use? During the many years of transition the Internet will contain black holes. For example, somewhere on the way from IPng host A to IPng host B there will sometimes (unpredictably) be IPv4-only routers which discard IPng packets. Also, the state of the DNS does not necessarily correspond to reality. A host for which DNS claims to know an IPng address may in fact not be running IPng at a particular moment; thus an IPng packet to that host will be discarded on delivery. Knowing that a host has both IPv4 and IPng addresses gives no information about black holes. A solution to this must be proposed and it must not depend on manually maintained information. (If this is not solved, the dual stack approach is no better than the packet translation approach.)"</li></ul>
<p id="rfc.section.1.p.4">Even after the transition, the procedure described in this document allows applications to strongly prefer IPv6 -- yet when an IPv6 outage occurs the application will quickly start using IPv4 and continue using IPv4. It will quietly continue trying to use IPv6 until IPv6 becomes available again, and then trend again towards using IPv6.</p>
<p id="rfc.section.1.p.5">Following the procedures in this document, once a certain address family is successful, the application trends towards preferring that address family. Thus, repeated use of the application DOES NOT cause repeated probes over both address families.</p>
<p id="rfc.section.1.p.6">Applications would have to change in order to use the mechanism described in this document, by either implementing the mechanism directly, or by calling APIs made available to them.  To improve IPv6 connectivity experience for legacy applications (e.g., applications which simply rely on the operating system's address preference order), operating systems may use other approaches.  These can include changing address sorting based on configuration received from the network, other configuration, or dynamic detection of the host connectivity to IPv6 and IPV4 destinations.</p>
<p id="rfc.section.1.p.7">While the application recommendations in this document are described in the context of HTTP clients ("web browsers") and SRV clients (e.g., XMPP clients) the procedure is also useful and applicable to other interactive applications.</p>
<p id="rfc.section.1.p.8">Code which implements some of the ideas described in this document has been made available <a href="#Perreault">[Perreault]</a> <a href="#Andrews">[Andrews]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Notational Conventions</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#problem_statement" id="problem_statement">Problem Statement</a>
</h1>
<p id="rfc.section.3.p.1">As discussed in more detail in <a href="#problem_uris">Section 3.1</a>, it is important that the same URI and hostname be used for IPv4 and IPv6. Using separate namespaces causes namespace fragmentation and reduces the ability for users to share URIs and hostnames, and complicates printed material that includes the URI or hostname.</p>
<p id="rfc.section.3.p.2">As discussed in more detail in <a href="#problem_ipv6">Section 3.2</a>, IPv6 connectivity is broken to specific prefixes or specific hosts, or slower than native IPv4 connectivity.</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#problem_uris" id="problem_uris">URIs and hostnames</a>
</h1>
<p id="rfc.section.3.1.p.1">URIs are often used between users to exchange pointers to content -- such as on social networks, email, instant messaging, or other systems. Thus, production URIs and production hostnames containing references to IPv4 or IPv6 will only function if the other party is also using an application, OS, and a network that can access the URI or the hostname.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#problem_ipv6" id="problem_ipv6">IPv6 connectivity</a>
</h1>
<p id="rfc.section.3.2.p.1">When IPv6 connectivity is impaired, today's IPv6-capable web browsers incur many seconds of delay before falling back to IPv4. This harms the user's experience with IPv6, which will slow the acceptance of IPv6, because IPv6 is frequently disabled in its entirety on the end systems to improve the user experience.</p>
<p id="rfc.section.3.2.p.2">Reasons for such failure include no connection to the IPv6 Internet, broken 6to4 or Teredo tunnels, and broken IPv6 peering.</p>
<div id="#rfc.figure.1"></div>
<div id="#diagram_message_flow"></div>
<pre>
   DNS Server                  Client                  Server
       |                          |                       |
 1.    |&lt;--www.example.com A?-----|                       |
 2.    |&lt;--www.example.com AAAA?--|                       |
 3.    |---192.0.2.1-------------&gt;|                       |
 4.    |---2001:db8::1-----------&gt;|                       |
 5.    |                          |                       |
 6.    |                          |--TCP SYN, IPv6---&gt;X   |
 7.    |                          |--TCP SYN, IPv6---&gt;X   |
 8.    |                          |--TCP SYN, IPv6---&gt;X   |
 9.    |                          |                       |
 10.   |                          |--TCP SYN, IPv4-------&gt;|
 11.   |                          |&lt;-TCP SYN+ACK, IPv4----|
 12.   |                          |--TCP ACK, IPv4-------&gt;|
</pre>
<p id="rfc.section.3.2.p.3">The client obtains the IPv4 and IPv6 records for the server (1-4).  The client attempts to connect using IPv6 to the server, but the IPv6 path is broken (6-8), which consumes several seconds of time.  Eventually, the client attempts to connect using IPv4 (10) which succeeds.</p>
<p id="rfc.section.3.2.p.4">Delays experienced by users of various browser and operating system combinations have been studied <a href="#Experiences">[Experiences]</a>.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Client Recommendations</h1>
<p id="rfc.section.4.p.1">Happy Eyeballs does two things:</p>

<ol>
<li>Provides fast connection for users. To provide fast connections for users, clients should make connections quickly over various technologies, automatically tune itself to avoid flooding the network with unnecessary connections (i.e., for technologies that have not made successful connections), and occasionally flush its self-tuning if it trended towards IPv4 <a href="#initialization">Section 5.2</a>.</li>
<li>Avoids thrashing the network. Clients need to avoid flooding the network or servers with excessive connection initiation traffic. One way to accomplish this, without significant impairment to the user experience, is to cache which address family has been unsuccessful and successful, and use that address family for subsequent connections to the same host.</li>
</ol>
<p id="rfc.section.4.p.2">If a TCP client supports IPv6 and IPv4 and is connected to IPv4 and IPv6 networks, it can perform the procedures described in this section.</p>
<div id="#rfc.figure.2"></div>
<div id="#diagram_message_flow_happy_1"></div>
<pre>
   DNS Server                  Client                  Server
       |                          |                       |
 1.    |&lt;--www.example.com A?-----|                       |
 2.    |&lt;--www.example.com AAAA?--|                       |
 3.    |---192.0.2.1-------------&gt;|                       |
 4.    |---2001:db8::1-----------&gt;|                       |
 5.    |                          |                       |
 6.    |                          |==TCP SYN, IPv6===&gt;X   |
 7.    |                          |--TCP SYN, IPv4-------&gt;|
 8.    |                          |&lt;-TCP SYN+ACK, IPv4----|
 9.    |                          |--TCP ACK, IPv4-------&gt;|
10.    |                          |==TCP SYN, IPv6===&gt;X   |
</pre>
<p id="rfc.section.4.p.3">In the diagram above, the client sends two TCP SYNs at the same time over IPv6 (6) and IPv4 (7). In the diagram, the IPv6 path is broken but has little impact to the user because there is no long delay before using IPv4. The IPv6 path is retried until the application gives up (10).</p>
<p id="rfc.section.4.p.4">After performing the above procedure, the client learns if connections to the host's IPv6 or IPv4 address were successful. The client MUST cache that information to avoid thrashing the network with excessive subsequent connection attempts. For example, in the diagram above, the client has noticed that IPv6 to that address failed, and it should provide a greater preference to using IPv4 instead.</p>
<div id="#rfc.figure.3"></div>
<div id="#diagram_message_flow_happy_2"></div>
<pre>
   DNS Server                  Client                  Server
       |                          |                       |
 1.    |&lt;--www.example.com A?-----|                       |
 2.    |&lt;--www.example.com AAAA?--|                       |
 3.    |---192.0.2.1-------------&gt;|                       |
 4.    |---2001:db8::1-----------&gt;|                       |
 5.    |                          |                       |
 6.    |                          |==TCP SYN, IPv6=======&gt;|
 7.    |                          |--TCP SYN, IPv4-------&gt;|
 8.    |                          |&lt;=TCP SYN+ACK, IPv6====|
 9.    |                          |&lt;-TCP SYN+ACK, IPv4----|
10.    |                          |==TCP ACK, IPv6=======&gt;|
11.    |                          |--TCP ACK, IPv4-------&gt;|
12.    |                          |--TCP RST, IPv4-------&gt;|
</pre>
<p id="rfc.section.4.p.5">The diagram above shows a case where both IPv6 and IPv4 are working, and IPv4 is abandoned (12).</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#client_v6_details" id="client_v6_details">Implementation details: A and AAAA</a>
</h1>
<p id="rfc.section.5.p.1">This section details how to provide robust dual stack service for both IPv6 and IPv4, so that the user perceives very fast application response.</p>
<p id="rfc.section.5.p.2">Depending on implementation, the variables and procedures described below might be implemented or maintained within a specific application (e.g., web browser), library, framework, or by the operating system itself. An API call such as "connect_by_name()" is envisioned which would call the Happy Eyeballs routine and implement the functions described in this section.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Description of State Variables</h1>
<p id="rfc.section.5.1.p.1">The system maintains a Smoothed P (which provides the overall preference to IPv6 or IPv4), and an exception cache. Both of these change over time and are described below:</p>

<dl>
<dt>Exception Cache:  </dt>
<dd style="margin-left: 8">This is a cache, indexed by IP prefixes, contains a "P" value for each prefix. Entries are added to this cache if a connection to the expected address family failed and a connection to the other address family succeeded. That is, these are exceptions to the Smoothed P variable. See <a href="#prefix">Section 5.5</a> for description of how these prefixes are defined.<ul class="empty"><li>(Note: In previous versions of this document, this was the "per-destination P (preference) value".)</li></ul>
</dd>
<dt>P:</dt>
<dd style="margin-left: 8">Address family preference.  This is computed for this connection attempt.  A positive value is a preference to start the IPv6 connection first, a negative value to start the IPv4 connection first, and zero indicates both IPv6 and IPv4 connections are started simultaneously. The absolute value is the number of milliseconds between the connection attempts on two address families.</dd>
<dt>Smoothed P:</dt>
<dd style="margin-left: 8">Smoothed address family preference. This is the address family preference for destinations that are not in the exception cache.  This variable can be positive or negative, with values having the same meaning as "P".  In the absence of more specific configuration information, it is RECOMMENDED that implementations enforce a maximum value of 8000 (8 seconds) for this variable.  <ul class="empty"><li>(Note: In previous versions of this document, this was the "application-wide P (preference) value".)</li></ul>
</dd>
</dl>
<p id="rfc.section.5.1.p.2">The following values are configured and constant:</p>

<dl>
<dt>TI:</dt>
<dd style="margin-left: 8">Tolerance Interval, in milliseconds. This is the allowance in the time a connection is expected to complete and its actual completion, and is provided to accommodate slight differences in network and server responsiveness. In the absence of dynamic configuration information from the network (e.g., DHCP) or other configuration information, it is RECOMMENDED to use 20ms.</dd>
<dt>Initial Headstart (IH):</dt>
<dd style="margin-left: 8">The initial headstart ("preference") for IPv6, in milliseconds. This value provides a preference towards IPv6 (if positive) or IPv4 (if negative) when the host joins a new network or otherwise flushes its cached information (see <a href="#initialization">Section 5.2</a>), and the distance to move P away from zero when P was zero. In the absence of dynamic configuration information from the network (e.g., <a href="#I-D.ietf-6man-addr-select-opt">[I-D.ietf-6man-addr-select-opt]</a>) or other configuration information (e.g., the node's address selection policy has been modified to prefer IPv4 over IPv6), the value 100ms is recommended, which causes the initial IPv6 connection to be attempted 100ms before the IPv4 connection.</dd>
<dt>MAXWAIT:</dt>
<dd style="margin-left: 8">Maximum wait time for a connection to complete, before trying additional IP addresses. This is RECOMMENDED to be 10 seconds.</dd>
</dl>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#initialization" id="initialization">Initialization, Cache Flush, and Resetting Smoothed P</a>
</h1>
<p id="rfc.section.5.2.p.1">Because every network has different characteristics (e.g., working or broken IPv6 or IPv4 connectivity) the Smoothed P variable SHOULD be set to its default value (Smoothed P = Initial Headstart) and the exception cache SHOULD be emptied whenever the host is connected to a new network (e.g., <a href="#RFC4436">DNAv4</a> <cite title="NONE">[RFC4436]</cite>, <a href="#RFC6059">DNAv6</a> <cite title="NONE">[RFC6059]</cite>, <a href="#cx-osx">[cx-osx]</a>, <a href="#cx-win">[cx-win]</a>).</p>
<p id="rfc.section.5.2.p.2">If there are IPv6 failures to specific hosts or prefixes, the exception cache will build up exception entries preferring IPv4, and if there are significant IPv6 failures to many hosts or prefixes, Smoothed P will become negative. When this occurs, IPv6 will not be attempted at all. To avoid this problem, it is strongly RECOMMENDED to occasionally flush the exception cache of all entries and reset Smoothed P to Initial Offset. This SHOULD be done every 10 minutes. In so doing, IPv6 and IPv4 are tried again so that if the IPv6 is working again, it will quickly be preferred again.</p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> Connecting to a Server</h1>
<p id="rfc.section.5.3.p.1">The steps when connecting to a server are as follows:</p>
<p></p>

<ol>
<li>query DNS using getaddrinfo(). This will return addresses sorted by the host's <a href="#RFC3484">default address selection ordering</a> <cite title="NONE">[RFC3484]</cite>, its updates, or the address selection as chosen by the network administrator <a href="#I-D.ietf-6man-addr-select-opt">[I-D.ietf-6man-addr-select-opt]</a>.</li>
<li>If this returns both an IPv6 and IPv4 address, continue processing to the next stop. Otherwise, Happy Eyeballs processing stops here.</li>
<li>Of the addresses returned in step (1), look up the first IPv6 address and first IPv4 address in the Happy Eyeballs exception cache.  Matching entries in the exception cache influence the P value for this connection attempt by setting P to the sum of Smoothed_P and of the P values from the matching IPv6 entry (if it exists) and the matching IPv4 entry (if it exists).</li>
<li>If P&gt;=0, initiate a connection attempt using the first IPv6 address returned by step (1). If that connection has not completed after P milliseconds, initiate a connection attempt using IPv4.</li>
<li>If P&lt;=0, initiate a connection attempt using the first IPv4 address returned by getaddrinfo. If that connection has not completed after absolute value(P) milliseconds, initiate a connection attempt using IPv6.</li>
<li>If neither connection has completed after MAXWAIT seconds, repeat the procedure at step (3) until the addresses are exhausted.</li>
</ol>

<p>After performing the above steps, there will be no connection at all or one connection will complete first. If no connection was successful, it should be treated as a failure for both IPv6 and IPv4.</p>
<h1 id="rfc.section.5.4">
<a href="#rfc.section.5.4">5.4.</a> Adjusting Address Family Preferences</h1>
<p id="rfc.section.5.4.p.1">If the preferred address family completed first, Smoothed P is adjusted towards that address family. If the non-preferred address family completed, we wait an additional Tolerance Interval milliseconds for the preferred address family to complete.  If the expected address family succeeded, we increment the absolute value of the Smoothed P; if the expected address family failed - we create an exception entry that will make an adjustment to the future value of P for the attempt on this pair in the direction opposite to the current sign of Smoothed P.</p>
<p id="rfc.section.5.4.p.2">The table below summarizes the adjustments:</p>
<div id="#rfc.figure.4"></div>
<div id="#diagram_p_adjustments"></div>
<pre>         |   Connection completed within Tolerance Interval   |
+--------+--------------|------------------|------------------+
|        | v6 and v4 ok | v6 ok, v4 failed | v6 failed, v4 ok |
+--------+--------------|------------------|------------------+
| P &gt; 0  |  SP=SP+10    |    SP=SP+10      | SP=SP/2 or cache |
| P &lt; 0  |  SP=SP+10    | SP=SP/2 or cache |     SP=SP-10     |
| P = 0  |SP=big(10,IH) |    SP=IH         |     SP=(-IH)     |
|--------+--------------|------------------|------------------+
</pre>
<p id="rfc.section.5.4.p.3">The the above table is described in textual form:</p>

<ul>
<li>If P &gt; 0 (indicating IPv6 is preferred over IPv4): <ul>
<li>and both the IPv6 and IPv4 connection attempts completed within the Tolerance Interval, it means the IPv6 preference was accurate or we should gently prefer IPv6, so Smoothed P is increased by 10 milliseconds (Smoothed P = Smoothed P + 10).</li>
<li>If the IPv6 connection completed but the IPv4 connection failed within the tolerance interval, it means future connections should prefer IPv6, so Smoothed P is increased by 10 milliseconds (Smoothed_P = Smoothed_P + 10).</li>
<li>If the IPv6 connection failed but the IPv4 connection completed within the tolerance interval, it means the IPv6 preference is inaccurate.  If no exception cache entry exists for the IPv6 and IPv4 prefixes, the entries are created and their P value set to to the connection setup time * -1, and Smoothed P is halved and rounded towards zero (Smoothed_P = Smoothed_P * 0.5).  If an exception cache entry already existed, its P value is doubled and Smoothed_P is not adjusted.  </li>
</ul>
</li>
<li>If P &lt; 0 (indicating IPv4 is preferred over IPv6):<ul>
<li>and both the IPv6 and IPv4 connection attempts completed within the tolerance interval, we should gently prefer IPv6, so Smoothed P is increased by 10 milliseconds (Smoothed_P = Smoothed_P + 10).</li>
<li>If the IPv6 connection completed but the IPv4 connection failed within within the tolerance interval, it means the IPv4 preference is inaccurate.  If no exception cache entry exists for the IPv6 and IPv4 prefixes, they are created and their P values set to the connection setup time and Smoothed P is halved and rounded towards 0 (Smoothed_P = Smoothed_P * 0.5).  If an exception cahe entry already existed, its P value is doubled and Smoothed_P is not adjusted.</li>
<li>If the IPv4 connection completed but the IPv6 connection failed within the tolerance interval, it means future connections should prefer IPv4, so Smoothed P is decreased by 10 milliseconds (Smoothed_P = Smoothed_P - 10).</li>
</ul>
</li>
<li>If P = 0 (indicating IPv4 and IPv6 are equally preferred):<ul>
<li>and both the IPv6 and IPv4 connection attempts completed within the tolerance interval, we should prefer IPv6 significantly, so Smoothed P is set to the larger of Initial Headstart or 10 (Smoothed_P = larger(Initial Headstart, 10)).</li>
<li>if the IPv6 connection completed but the IPv4 connection failed within the Tolerance Interval, it means we need to prefer IPv6, so Smoothed P is increased by 10 (Smoothed_P = Smoothed_P + 10).</li>
<li>if the IPv4 connection completed but the IPv6 connection failed within the Tolerance Interval, it means we need to prefer IPv4, so P is decreased by 10 (Smoothed_P = Smoothed_P - 10).</li>
</ul>
</li>
</ul>
<h1 id="rfc.section.5.5">
<a href="#rfc.section.5.5">5.5.</a> <a href="#prefix" id="prefix">Exception Cache</a>
</h1>
<p id="rfc.section.5.5.p.1">An exception cache is maintained of IPv6 prefixes and IPv4 prefixes, which are exceptions to the Smoothed P value at the time a connection was made.  For IPv6 prefixes, the default prefix length is 64. For IPv4, the default prefix length is /32. </p>
<p id="rfc.section.5.5.p.2">The exception cache MAY be a fixed size, removing entires using a least-frequently used algorithm.   This works because the network path is likely to change over time (thus old entries aren't valuable anyway), and if an entry does not exist the Smoothed P value will still provide some avoidance of user-noticable connection setup delay.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#srv_clients" id="srv_clients">Implementation Details: SRV</a>
</h1>
<p></p>

<ul class="empty"><li>[[Editor's Note: SRV processing needs to be incorporated into the above section, rather than described separately. This will be done in a future update to this document.]]</li></ul>
<p id="rfc.section.6.p.2">For the purposes of this section, "client" is defined as the entity initiating the connection.</p>
<p id="rfc.section.6.p.3">For protocols which support DNS SRV <a href="#RFC2782">[RFC2782]</a>, the client performs the IN SRV query (e.g. IN SRV _xmpp-client._tcp.example.com) as normal. The client MUST perform the following steps:</p>
<p></p>

<ol>
<li>Sort all SRV records according to priority (lowest priority first)</li>
<li>Process all of the SRV targets of the same priority with a weight greater than 0: <ol style="list-style-type: lower-alpha">
<li>Perform A/AAAA queries for each SRV target in parallel, as described in the A/AAAA processing section</li>
<li>Connect to the IPv4/IPv6 addresses</li>
<li>If at least one connection succeeds, stop processing SRV records</li>
</ol>
</li>
<li>If there is no connection, process all of the SRV targets of the same priority with a weight of 0, as per steps 2.1 through 2.3 above</li>
<li>Repeat steps 2.1 through 2.3 for the next priority, until a connection is established or all SRV records have been exhausted</li>
<li>If there is still no connection, fallback to using the domain (e.g., example.com), following steps 2.1 through 2.3 above</li>
</ol>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> Additional Considerations</h1>
<p id="rfc.section.7.p.1">This section discusses considerations and requirements that are common to new technology deployment.</p>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> Additional Network and Host Traffic</h1>
<p id="rfc.section.7.1.p.1">Additional network traffic and additional server load is created due to the recommendations in this document. This additional load is mitigated by the P value, especially the exception cache P value.</p>
<p id="rfc.section.7.1.p.2">The procedures described in this document retain a quality user experience while transitioning from IPv4-only to dual stack, while still giving IPv6 a slight preference over IPv4 (in order to remove load from IPv4 networks, most importantly to reduce the load on IPv4 network address translators). The improvement in the user experience benefits the user to only a small detriment of the network, DNS server, and server that are serving the user.</p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> <a href="#abandon" id="abandon">Abandon Non-Winning Connections</a>
</h1>
<p id="rfc.section.7.2.p.1">It is RECOMMENDED that the non-winning connections be abandoned, even though they could -- in some cases -- be put to reasonable use.  To take HTTP as an example, the design of some sites can break because of HTTP cookies that incorporate the client's IP address, require all connections be from the same IP address. If some connections from the same client are arriving from different IP addresses, such applications will break. It is also important to abandon connections to avoid consuming server resources (file descriptors, TCP control blocks) or middlebox resources (e.g., NAPT).  Using the non-winning connection can also interfere with the browser's Same Origin Policy (see <a href="#sec_sop">Section 7.8</a>).</p>
<h1 id="rfc.section.7.3">
<a href="#rfc.section.7.3">7.3.</a> Determining Address Type</h1>
<p id="rfc.section.7.3.p.1">For some transitional technologies such as a dual-stack host, it is easy for the application to recognize the native IPv6 address (learned via a AAAA query) and the native IPv4 address (learned via an A query). While IPv6/IPv4 translation makes that difficult, fortunately IPv6/IPv4 translators are not deployed on networks with dual stack clients, which is the scope of this document.</p>
<h1 id="rfc.section.7.4">
<a href="#rfc.section.7.4">7.4.</a> Debugging and Troubleshooting</h1>
<p id="rfc.section.7.4.p.1">This mechanism is aimed at ensuring a reliable user experience regardless of connectivity problems affecting any single transport.  However, this naturally means that applications employing these techniques are by default less useful for diagnosing issues with any particular transport. To assist in that regard, the applications implementing the proposal in this document SHOULD also provide a mechanism to revert the behavior to that of a default provided by the operating system - the <a href="#RFC3484">[RFC3484]</a>.</p>
<h1 id="rfc.section.7.5">
<a href="#rfc.section.7.5">7.5.</a> <a href="#dns_behavior" id="dns_behavior">DNS Behavior</a>
</h1>
<p id="rfc.section.7.5.p.1">Unique to DNS AAAA queries are the problems described in <a href="#RFC4074">[RFC4074]</a> which, if they still persist, require applications to perform an A query before the AAAA query. </p>

<ul class="empty"><li>[[Editor's Note 03: It is believed these defective DNS servers have long since been upgraded. If so, we can remove this section.]]</li></ul>
<h1 id="rfc.section.7.6">
<a href="#rfc.section.7.6">7.6.</a> Middlebox Issues</h1>
<p id="rfc.section.7.6.p.1">Some devices are known to exhibit what amounts to a bug, when the A and AAAA requests are sent back-to-back over the same 4-tuple, and drop one of the requests or replies <a href="#DNS-middlebox">[DNS-middlebox]</a>. However, in some cases fixing this behaviour may not be possible either due to the architectural limitations or due to the administrative constraints (location of the faulty device is unknown to the end hosts or not controlled by the end hosts). The algorithm described in this draft, in the case of this erroneous behaviour will eventually pace the queries such that this middlebox issue is avoided. The algorithm described in this draft also avoids calling the operating system's getaddrinfo() with "any", which should prevent the operating system from sending the A and AAAA queries from the same port.</p>
<p id="rfc.section.7.6.p.2">For the large part, these issues with simultaneous DNS requests are believed to be fixed.</p>
<h1 id="rfc.section.7.7">
<a href="#rfc.section.7.7">7.7.</a> Multiple Interfaces</h1>
<p id="rfc.section.7.7.p.1">Interaction of the suggestions in this document with multiple interfaces, and interaction with the MIF working group, is for further study (<a href="#I-D.chen-mif-happy-eyeballs-extension">[I-D.chen-mif-happy-eyeballs-extension]</a> is devoted to this).</p>
<h1 id="rfc.section.7.8">
<a href="#rfc.section.7.8">7.8.</a> <a href="#sec_sop" id="sec_sop">Interaction with Same Origin Policy</a>
</h1>
<p id="rfc.section.7.8.p.1">Web browsers implement same origin policy (SOP, <a href="#sop">[sop]</a>, <a href="#I-D.abarth-origin">[I-D.abarth-origin]</a>), which causes subsequent connections to the same hostname to go to the same IPv4 (or IPv6) address as the previous successful connection.  This is done to prevent certain types of attacks.</p>
<p id="rfc.section.7.8.p.2">The same-origin policy harms user-visible responsiveness if a new connection fails (e.g., due to a transient event such as router failure or load balancer failure).  While it is tempting to use Happy Eyeballs to maintain responsiveness, web browsers MUST NOT change their same origin policy because of Happy Eyeballs</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Content Provider Recommendations</h1>
<p id="rfc.section.8.p.1">Content providers SHOULD provide both AAAA and A records for servers using the same DNS name for both IPv4 and IPv6.</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#security_considerations" id="security_considerations">Security Considerations</a>
</h1>
<p id="rfc.section.9.p.1">[[Placeholder.]]</p>
<p id="rfc.section.9.p.2">See <a href="#abandon">Section 7.2</a> and <a href="#sec_sop">Section 7.8</a>.</p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> Acknowledgements</h1>
<p id="rfc.section.10.p.1">The mechanism described in this paper was inspired by Stuart Cheshire's discussion at the IAB Plenary at IETF72, the author's understanding of Safari's operation with SRV records, Interactive Connectivity Establishment (<a href="#RFC5245">ICE</a> <cite title="NONE">[RFC5245]</cite>), and the current IPv4/IPv6 behavior of SMTP mail transfer agents.</p>
<p id="rfc.section.10.p.2">Thanks to Fred Baker, Jeff Kinzli, Christian Kuhtz, and Iljitsch van Beijnum for fostering the creation of this document.</p>
<p id="rfc.section.10.p.3">Thanks to Scott Brim, Rick Jones, Stig Venaas, Erik Kline, Bjoern Zeeb, Matt Miller, Dave Thaler, and Dmitry Anipko for providing feedback on the document.</p>
<p id="rfc.section.10.p.4">Thanks to Javier Ubillos, Simon Perreault and Mark Andrews for the active feedback and the experimental work on the independent practical implementations that they created.</p>
<p id="rfc.section.10.p.5">Also the authors would like to thank the following individuals who participated in various email discussions on this topic: Mohacsi Janos, Pekka Savola, Ted Lemon, Carlos Martinez-Cagnazzo, Simon Perreault, Jack Bates, Jeroen Massar, Fred Baker, Javier Ubillos, Teemu Savolainen, Scott Brim, Erik Kline, Cameron Byrne, Daniel Roesen, Guillaume Leclanche, Mark Smith, Gert Doering, Martin Millnert, Tim Durack, Matthew Palmer.</p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> IANA Considerations</h1>
<p id="rfc.section.11.p.1">This document has no IANA actions.</p>
<h1 id="rfc.references">
<a href="#rfc.references">12.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">12.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3484">[RFC3484]</b></td>
<td class="top">
<a>Draves, R.</a>, "<a href="http://tools.ietf.org/html/rfc3484">Default Address Selection for Internet Protocol version 6 (IPv6)</a>", RFC 3484, February 2003.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2782">[RFC2782]</b></td>
<td class="top">
<a href="mailto:arnt@troll.no" title="Troll Tech">Gulbrandsen, A.</a>, <a title="Internet Software Consortium">Vixie, P.</a> and <a href="mailto:levone@microsoft.com" title="Microsoft Corporation">L. Esibov</a>, "<a href="http://tools.ietf.org/html/rfc2782">A DNS RR for specifying the location of services (DNS SRV)</a>", RFC 2782, February 2000.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">12.2.</a> Informational References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC1671">[RFC1671]</b></td>
<td class="top">
<a href="mailto:brian@dxcoms.cern.ch" title="CERN, Communications Systems, Computing and Networks Division">Carpenter, B.</a>, "<a href="http://tools.ietf.org/html/rfc1671">IPng White Paper on Transition and Other Considerations</a>", RFC 1671, August 1994.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4074">[RFC4074]</b></td>
<td class="top">
<a>Morishita, Y.</a> and <a>T. Jinmei</a>, "<a href="http://tools.ietf.org/html/rfc4074">Common Misbehavior Against DNS Queries for IPv6 Addresses</a>", RFC 4074, May 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5245">[RFC5245]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, "<a href="http://tools.ietf.org/html/rfc5245">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>", RFC 5245, April 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6059">[RFC6059]</b></td>
<td class="top">
<a>Krishnan, S.</a> and <a>G. Daley</a>, "<a href="http://tools.ietf.org/html/rfc6059">Simple Procedures for Detecting Network Attachment in IPv6</a>", RFC 6059, November 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4436">[RFC4436]</b></td>
<td class="top">
<a>Aboba, B.</a>, <a>Carlson, J.</a> and <a>S. Cheshire</a>, "<a href="http://tools.ietf.org/html/rfc4436">Detecting Network Attachment in IPv4 (DNAv4)</a>", RFC 4436, March 2006.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.chen-mif-happy-eyeballs-extension">[I-D.chen-mif-happy-eyeballs-extension]</b></td>
<td class="top">
<a>Chen, G</a>, <a>Williams, C</a>, <a>Wing, D</a> and <a>A Yourtchenko</a>, "<a href="http://tools.ietf.org/html/draft-chen-mif-happy-eyeballs-extension-03">Happy Eyeballs Extension for Multiple Interfaces</a>", Internet-Draft draft-chen-mif-happy-eyeballs-extension-03, October 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-6man-addr-select-opt">[I-D.ietf-6man-addr-select-opt]</b></td>
<td class="top">
<a>Matsumoto, A</a>, <a>Fujisaki, T</a>, <a>Kato, J</a> and <a>T Chown</a>, "<a href="http://tools.ietf.org/html/draft-ietf-6man-addr-select-opt-01">Distributing Address Selection Policy using DHCPv6</a>", Internet-Draft draft-ietf-6man-addr-select-opt-01, June 2011.</td>
</tr>
<tr>
<td class="reference"><b id="whitelist">[whitelist]</b></td>
<td class="top">
<a>Google, </a>, "<a>Google IPv6 DNS Whitelist</a>", January 2009.</td>
</tr>
<tr>
<td class="reference"><b id="DNS-middlebox">[DNS-middlebox]</b></td>
<td class="top">
<a>Various, </a>, "<a>DNS middlebox behavior with multiple queries over same source port</a>", June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="cx-osx">[cx-osx]</b></td>
<td class="top">
<a>Adium, </a>, "<a>AIHostReachabilityMonitor</a>", June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="cx-win">[cx-win]</b></td>
<td class="top">
<a>Microsoft, </a>, "<a>NetworkChange.NetworkAvailabilityChanged Event</a>", June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="Perreault">[Perreault]</b></td>
<td class="top">
<a title="Viagenie">Perreault, S</a>, "<a>Happy Eyeballs in Erlang</a>", February 2011.</td>
</tr>
<tr>
<td class="reference"><b id="Andrews">[Andrews]</b></td>
<td class="top">
<a title="ISC">Andrews, M</a>, "<a>How to connect to a multi-homed server over TCP</a>", January 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.abarth-origin">[I-D.abarth-origin]</b></td>
<td class="top">
<a>Barth, A</a>, "<a href="http://tools.ietf.org/html/draft-abarth-origin-09">The Web Origin Concept</a>", Internet-Draft draft-abarth-origin-09, November 2010.</td>
</tr>
<tr>
<td class="reference"><b id="sop">[sop]</b></td>
<td class="top">
<a>W3C, </a>, "<a>Same Origin Policy</a>", January 2010.</td>
</tr>
<tr>
<td class="reference"><b id="Experiences">[Experiences]</b></td>
<td class="top">
<a>Savolainen, T.</a>, <a>Miettinen, N.</a>, <a>Veikkolainen, S.</a>, <a>Chown, T.</a> and <a>J. Morse</a>, "<a>Experiences of host behavior in broken IPv6 networks</a>", March 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> Changes</h1>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> changes from -01 to -02</h1>
<p></p>

<ul>
<li>Now honors host's address preference (RFC3484 and friends)</li>
<li>No longer requires thread-safe DNS library.  It uses getaddrinfo()</li>
<li>No longer describes threading.</li>
<li>IPv6 is given a 200ms head start (Initial Headstart variable).</li>
<li>If the IPv6 and IPv4 connection attempts were made at nearly the same time, wait Tolerance Interval milliseconds for both to complete before deciding which one wins.</li>
<li>Renamed "global P" to "Smoothed P", and better described how it is calculated.</li>
<li>introduced the exception cache.  This contains the set of networks that only work with IPv4 (or only with IPv6), so that subsequent connection attempts use that address family without them causing serious affect to Smoothed P.</li>
<li>encourages that every 10 minutes the exception cache and Smoothed P be reset.  This allows IPv6 to be attempted again, so we don't get 'stuck' on IPv4.</li>
<li>If we didn't get both A and AAAA, abandon all Happy Eyeballs processing (thanks to Simon Perreault).</li>
<li>added discussion of Same Origin Policy</li>
<li>Removed discussion of NAT-PT and address learning; those are only used with IPv6-only hosts whereas this document is about dual-stack hosts contacting dual-stack servers.</li>
</ul>
<h1 id="rfc.appendix.Appendix A.2">
<a href="#rfc.appendix.Appendix%20A.2">Appendix A.2.</a> changes from -00 to -01</h1>
<p></p>

<ul><li>added SRV section (thanks to Matt Miller)</li></ul>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Dan Wing</span> 
	  <span class="n hidden">
		<span class="family-name">Wing</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>170 West Tasman Drive</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">CA</span> 
		<span class="code">95134</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:dwing@cisco.com">dwing@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Andrew Yourtchenko</span> 
	  <span class="n hidden">
		<span class="family-name">Yourtchenko</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>De Kleetlaan, 7</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">Diegem</span> 
		<span class="code">B-1831</span>
	  </span>
	  <span class="country-name vcardline">Belgium</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ayourtch@cisco.com">ayourtch@cisco.com</a></span>

  </address>
</div>

</body>
</html>