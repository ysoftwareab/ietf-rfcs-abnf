<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Password Authenticated Connection Establishment with IKEv2</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Terminology">
<link href="#rfc.section.2" rel="Chapter" title="2 Overview">
<link href="#rfc.section.3" rel="Chapter" title="3 Protocol Sequence">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 The IKE_SA_INIT Exchange">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 The IKE_AUTH Exchange, Round #1">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 The IKE_AUTH Exchange, Round #2">
<link href="#rfc.section.4" rel="Chapter" title="4 Encrypting and Mapping the Nonce">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Encrypting the Nonce">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Mapping the Nonce">
<link href="#rfc.section.4.2.1" rel="Chapter" title="4.2.1 MODP Diffie-Hellman">
<link href="#rfc.section.4.2.2" rel="Chapter" title="4.2.2 Elliptic Curve Diffie-Hellman">
<link href="#rfc.section.4.2.3" rel="Chapter" title="4.2.3 Validation">
<link href="#rfc.section.5" rel="Chapter" title="5 Protocol Details">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Password Processing">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 The SECURE_PASSWORD_METHODS Notification">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 The GSPM(ENONCE) Payload">
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 The KE (KEi2/KEr2) Payloads in PACE">
<link href="#rfc.section.5.5" rel="Chapter" title="5.5 PACE and Session Resumption">
<link href="#rfc.section.6" rel="Chapter" title="6 Security Considerations">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Credential Security Assumptions">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Vulnerability to Passive and Active Attacks">
<link href="#rfc.section.6.3" rel="Chapter" title="6.3 Perfect Forward Secrecy">
<link href="#rfc.section.6.4" rel="Chapter" title="6.4 Randomness">
<link href="#rfc.section.6.5" rel="Chapter" title="6.5 Identity Protection">
<link href="#rfc.section.6.6" rel="Chapter" title="6.6 Denial of Service">
<link href="#rfc.section.6.7" rel="Chapter" title="6.7 Choice of Encryption Algorithms">
<link href="#rfc.section.6.8" rel="Chapter" title="6.8 Security Model and Security Proof">
<link href="#rfc.section.6.9" rel="Chapter" title="6.9 Long-Term Credential Storage">
<link href="#rfc.section.7" rel="Chapter" title="7 IANA Considerations">
<link href="#rfc.section.8" rel="Chapter" title="8 Acknowledgments">
<link href="#rfc.references" rel="Chapter" title="9 References">
<link href="#rfc.references.1" rel="Chapter" title="9.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="9.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Protocol Selection Criteria">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 Security Criteria">
<link href="#rfc.appendix.Appendix%20A.2" rel="Chapter" title="Appendix A.2 Intellectual Property Criteria">
<link href="#rfc.appendix.Appendix%20A.3" rel="Chapter" title="Appendix A.3 Miscellaneous Criteria">
<link href="#rfc.appendix.Appendix%20B" rel="Chapter" title="Appendix B Password Salting">
<link href="#rfc.appendix.Appendix%20B.1" rel="Chapter" title="Appendix B.1 Solving the Asymmetric Case with Symmetric Cryptography">
<link href="#rfc.appendix.Appendix%20B.2" rel="Chapter" title="Appendix B.2 Solving the Fully Symmetric Case with Asymmetric Cryptography">
<link href="#rfc.appendix.Appendix%20B.3" rel="Chapter" title="Appendix B.3 Generation of a Long Shared Secret">
<link href="#rfc.appendix.Appendix%20C" rel="Chapter" title="Appendix C Change Log">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="IKEv2 does not allow secure peer authentication when using short credential strings, i.e. passwords. Several proposals have been made to integrate password-authentication protocols into IKE.  This document provides an adaptation of PACE (Password Authenticated Connection Establishment) to the setting of IKEv2 and demonstrates the advantages of this integration.  " />
  <meta name="description" content="IKEv2 does not allow secure peer authentication when using short credential strings, i.e. passwords. Several proposals have been made to integrate password-authentication protocols into IKE.  This document provides an adaptation of PACE (Password Authenticated Connection Establishment) to the setting of IKEv2 and demonstrates the advantages of this integration.  " />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">D. Kuegler</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Bundesamt fuer Sicherheit in der Informationstechnik (BSI)</td>
</tr>
<tr>
<td class="left">Intended status: Experimental Protocol</td>
<td class="right">Y. Sheffer</td>
</tr>
<tr>
<td class="left">Expires: February 18, 2012</td>
<td class="right">Porticor</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">August 17, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Password Authenticated Connection Establishment with IKEv2<br />
  <span class="filename">draft-kuegler-ipsecme-pace-ikev2-07</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>IKEv2 does not allow secure peer authentication when using short credential strings, i.e. passwords. Several proposals have been made to integrate password-authentication protocols into IKE.  This document provides an adaptation of PACE (Password Authenticated Connection Establishment) to the setting of IKEv2 and demonstrates the advantages of this integration.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on February 18, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Terminology</a>
</li>
<li>2.   <a href="#rfc.section.2">Overview</a>
</li>
<li>3.   <a href="#rfc.section.3">Protocol Sequence</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">The IKE_SA_INIT Exchange</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">The IKE_AUTH Exchange, Round #1</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">The IKE_AUTH Exchange, Round #2</a>
</li>
<li>4.   <a href="#rfc.section.4">Encrypting and Mapping the Nonce</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Encrypting the Nonce</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Mapping the Nonce</a>
</li>
<li>4.2.1.   <a href="#rfc.section.4.2.1">MODP Diffie-Hellman</a>
</li>
<li>4.2.2.   <a href="#rfc.section.4.2.2">Elliptic Curve Diffie-Hellman</a>
</li>
<li>4.2.3.   <a href="#rfc.section.4.2.3">Validation</a>
</li>
<li>5.   <a href="#rfc.section.5">Protocol Details</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Password Processing</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">The SECURE_PASSWORD_METHODS Notification</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">The GSPM(ENONCE) Payload</a>
</li>
<li>5.4.   <a href="#rfc.section.5.4">The KE (KEi2/KEr2) Payloads in PACE</a>
</li>
<li>5.5.   <a href="#rfc.section.5.5">PACE and Session Resumption</a>
</li>
<li>6.   <a href="#rfc.section.6">Security Considerations</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">Credential Security Assumptions</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">Vulnerability to Passive and Active Attacks</a>
</li>
<li>6.3.   <a href="#rfc.section.6.3">Perfect Forward Secrecy</a>
</li>
<li>6.4.   <a href="#rfc.section.6.4">Randomness</a>
</li>
<li>6.5.   <a href="#rfc.section.6.5">Identity Protection</a>
</li>
<li>6.6.   <a href="#rfc.section.6.6">Denial of Service</a>
</li>
<li>6.7.   <a href="#rfc.section.6.7">Choice of Encryption Algorithms</a>
</li>
<li>6.8.   <a href="#rfc.section.6.8">Security Model and Security Proof</a>
</li>
<li>6.9.   <a href="#rfc.section.6.9">Long-Term Credential Storage</a>
</li>
<li>7.   <a href="#rfc.section.7">IANA Considerations</a>
</li>
<li>8.   <a href="#rfc.section.8">Acknowledgments</a>
</li>
<li>9.   <a href="#rfc.references">References</a>
</li>
<li>9.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>9.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Protocol Selection Criteria</a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">Security Criteria</a>
</li>
<li>Appendix A.2.   <a href="#rfc.appendix.Appendix%20A.2">Intellectual Property Criteria</a>
</li>
<li>Appendix A.3.   <a href="#rfc.appendix.Appendix%20A.3">Miscellaneous Criteria</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.Appendix%20B">Password Salting</a>
</li>
<li>Appendix B.1.   <a href="#rfc.appendix.Appendix%20B.1">Solving the Asymmetric Case with Symmetric Cryptography</a>
</li>
<li>Appendix B.2.   <a href="#rfc.appendix.Appendix%20B.2">Solving the Fully Symmetric Case with Asymmetric Cryptography</a>
</li>
<li>Appendix B.3.   <a href="#rfc.appendix.Appendix%20B.3">Generation of a Long Shared Secret</a>
</li>
<li>Appendix C.   <a href="#rfc.appendix.Appendix%20C">Change Log</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">PACE <a href="#TR03110">[TR03110]</a> is a security protocol that establishes a mutually authenticated (and encrypted) channel between two parties based on weak (short) passwords. PACE provides strong session keys that are independent of the strength of the password.  PACE belongs to a family of protocols often referred to as Zero-Knowledge Password Proof (ZKPP) protocols, all of which amplify weak passwords into strong session keys.  This draft describes the integration of PACE into IKEv2 <a href="#RFC5996">[RFC5996]</a> as a new authentication mode, analogous to the existing certificate and PSK authentication modes.  </p>
<p id="rfc.section.1.p.2">Some of the advantages of our approach, compared to the existing IKEv2, include: <a href="#PACEsec">[PACEsec]</a>. The PACE protocol is currently used in an international standard for digital travel documents <a href="#ICAO">[ICAO]</a>.  </p>

<ul>
<li>The current best practice to implement password authentication in IKE involves certificate-based authentication of the server plus some EAP method to authenticate the client. This involves two non-trivial infrastructure components (PKI and EAP/AAA). Moreover, certificate authentication is hard to get right, and often depends for its security on unreliable user behavior.</li>
<li>Alternatively, native IKEv2 shared secret authentication can be used with passwords. This usage however is insecure, specifically it is vulnerable to active attackers.</li>
<li>Some newer EAP methods can be used for mutual authentication, and combined with <a href="#RFC5998">[RFC5998]</a> can be well integrated into IKEv2.  This is certainly an option in some cases, but the current proposal may be simpler to implement.</li>
</ul>

<p> Compared to other protocols aiming at similar goals, PACE has several advantages. PACE was designed to be free of patents, and to allow for a high level of flexibility with respect to cryptographic algorithms, e.g. it can be implemented based on standard Diffie-Hellman as well as Elliptic Curve Diffie-Hellman without any restrictions on the mathematical group to be used other than the requirement that the group is cryptographically secure. The protocol itself is also proven to be cryptographically secure </p>
<p id="rfc.section.1.p.3">The integration aims at keeping as much as possible of IKEv2 unchanged, e.g. the mechanisms used to establish Child SAs as provided by IKEv2 are maintained with no change.  </p>
<p id="rfc.section.1.p.4">The PAKE Framework document <a href="#I-D.kivinen-ipsecme-secure-password-framework">[I-D.kivinen-ipsecme-secure-password-framework]</a> defines a set of payloads for different types of PAKE methods within IKEv2. This document reuses this framework. Note that the current document is self-contained, i.e. all relevant payloads and semantics are redefined here.</p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> Terminology</h1>
<p id="rfc.section.1.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.  </p>
<div id="#rfc.figure.1"></div>
<pre>
              
E()    Symmetric encryption
D()    Symmetric decryption
KA()   Key agreement
Map()  Mapping function
Pwd    Shared password
SPwd   Stored password
KPwd   Symmetric key derived from a password Pwd
G      Static group generator
GE     Ephemeral group generator
ENONCE Encrypted nonce
PKEi   Ephemeral public key of the initiator
SKEi   Ephemeral secret key of the initiator
PKEr   Ephemeral public key of the responder
SKEr   Ephemeral secret key of the responder
AUTH   Authentication payload

            </pre>
<p id="rfc.section.1.1.p.2">The following notation is used in this draft: </p>
<p id="rfc.section.1.1.p.3">Any other notation used here is defined in <a href="#RFC5996">[RFC5996]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Overview</h1>
<p id="rfc.section.2.p.1">At a high level the following steps are performed by the initiator and the responder.  They result in a two-round IKE_AUTH exchange, described in <a href="#sequence">Section 3</a> below.  </p>

<ol>
<li>The initiator randomly and uniformly chooses a nonce, encrypts the nonce using the password, and sends the ciphertext ENONCE to the responder.  </li>
<li>The responder recovers the plaintext nonce with the help of the shared password Pwd.  </li>
<li>The initiator and the responder perform the following steps: <ol style="list-style-type: lower-alpha">
<li>A mapping function Map() is used to derive an ephemeral generator GE = Map(G,s) from the exchanged nonce s and the generator G of the used group.  </li>
<li>They perform an anonymous Diffie-Hellman key agreement based on the ephemeral generator and compute the shared secret PACESharedSecret.  </li>
<li>They generate, exchange, and verify the authentication token AUTH using the shared secret PACESharedSecret.  </li>
</ol>
<p> </p>
</li>
</ol>

<p> </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#sequence" id="sequence">Protocol Sequence</a>
</h1>
<p id="rfc.section.3.p.1">The protocol consists of three round trips, IKE_SA_INIT, and a 2-round IKE_AUTH exchange, as follows: </p>
<div id="#rfc.figure.2"></div>
<div id="#figure-exchange"></div>
<pre>
              
  Initiator                      Responder
  ---------                      ---------

  IKE_SA_INIT:

  HDR, SAi1, KEi, Ni, N(SECURE_PASSWORD_METHODS)  -&gt;

         &lt;- HDR, SAr1, KEr, Nr, N(SECURE_PASSWORD_METHODS)

  IKE_AUTH round #1:

  HDR, SK{IDi, [IDr,], SAi2, 
          TSi, TSr, GSPM(ENONCE), KEi2} -&gt;

                              &lt;- HDR, SK{IDr, KEr2}

  IKE_AUTH round #2:

  HDR, SK{AUTH} -&gt;

                              &lt;- HDR, SK{AUTH, SAr2, TSi, TSr}

            </pre>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> The IKE_SA_INIT Exchange</h1>
<p id="rfc.section.3.1.p.1">The initiator sends a SECURE_PASSWORD_METHODS notification that indicates its support of this extension, and its wish to authenticate using a password. The following text assumes that the responder sent back a SECURE_PASSWORD_METHODS notification that indicates its preference for PACE.  </p>
<p id="rfc.section.3.1.p.2">If PACE was chosen, the algorithms negotiated in SAi1 and SAr1 are also used for the execution of PACE, i.e. the key agreement protocol (standard Diffie-Hellman or Elliptic Curve Diffie-Hellman), the group to be used, and the encryption algorithm.  </p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> The IKE_AUTH Exchange, Round #1</h1>
<p id="rfc.section.3.2.p.1">This is the first part of the PACE authentication of the peers.  This exchange MUST NOT be used unless both peers indicated support of this protocol.  </p>
<p id="rfc.section.3.2.p.2">The initiator selects a random nonce s and encrypts it to form ENONCE using the password Pwd, as described in <a href="#encryption">Section 4.1</a>. Then the initiator maps the nonce to an ephemeral generator GE of the group as described in <a href="#mapping">Section 4.2</a>, chooses randomly and uniformly an ephemeral key pair (SKEi,PKEi) based on the ephemeral generator and finally generates the payloads GSPM(ENONCE) containing the encrypted nonce and KEi2 containing the ephemeral public key.  </p>
<p id="rfc.section.3.2.p.3">The responder decrypts the received encrypted nonce s = D(KPwd, ENONCE), performs the mapping and randomly and uniformly chooses an ephemeral key pair (SKEr,PKEr) based on the ephemeral generator GE. The responder generates the KEr2 payload containing the ephemeral public key.  </p>
<p id="rfc.section.3.2.p.4">During the Diffie-Hellman key agreement, each party MUST check that the two public keys PKEi and PKEr differ. Otherwise, it MUST abort the protocol.  </p>
<p id="rfc.section.3.2.p.5">The request is equivalent to the IKE_AUTH request in a normal IKEv2 exchange, i.e. any payload which is valid in an IKE_AUTH request is valid (with the same semantics) in this round's request. In particular, certificate-related payloads are allowed, even though their use may not be practical within this mode.</p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> The IKE_AUTH Exchange, Round #2</h1>
<p id="rfc.section.3.3.p.1">This is the second part of the PACE authentication of the peers.</p>
<p id="rfc.section.3.3.p.2">The initiator and the responder calculate the shared secret PACESharedSecret: </p>
<p></p>

<ul class="empty"><li>PACESharedSecret = KA(SKEi, PKEr, GE) = KA(SKEr, PKEi, GE),</li></ul>

<p> </p>
<p id="rfc.section.3.3.p.4">where KA denotes the Diffie-Hellman key agreement, e.g. (for MODP groups) modular exponentiation.  Then they calculate the authentication tokens AUTHi and AUTHr.  </p>
<p id="rfc.section.3.3.p.5">The initiator calculates: </p>
<p></p>

<ul class="empty"><li>AUTHi = prf(prf+(Ni | Nr, PACESharedSecret), &lt;InitiatorSignedOctets&gt; | PKEr) </li></ul>

<p> </p>
<p id="rfc.section.3.3.p.7">See Sec. 2.15 of <a href="#RFC5996">[RFC5996]</a> for the definition of signed octets.  </p>
<p id="rfc.section.3.3.p.8">The responder calculates: </p>
<p></p>

<ul class="empty"><li>AUTHr = prf(prf+(Ni | Nr, PACESharedSecret), &lt;ResponderSignedOctets&gt; | PKEi) </li></ul>

<p> </p>
<p id="rfc.section.3.3.p.10">Both AUTH payloads MUST indicate the Secure Password Authentication Method <a href="#I-D.kivinen-ipsecme-secure-password-framework">[I-D.kivinen-ipsecme-secure-password-framework]</a>, whose value is TBD by IANA.  The authentication tokens are exchanged and each of them MUST be verified by the other party.  The behavior when this verification fails is unchanged from <a href="#RFC5996">[RFC5996]</a>.  </p>
<p id="rfc.section.3.3.p.11">This round's response is equivalent to the IKE_AUTH response in a normal IKEv2 exchange, i.e. any payload which is valid in an IKE_AUTH response is valid (with the same semantics) in the second round's response.</p>
<p id="rfc.section.3.3.p.12">Following authentication, all temporary values MUST be deleted by the peers, including in particular s, the ephemeral generator, the ephemeral key pairs, and PACESharedSecret.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#nonce" id="nonce">Encrypting and Mapping the Nonce</a>
</h1>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#encryption" id="encryption">Encrypting the Nonce</a>
</h1>
<p id="rfc.section.4.1.p.1">The shared password is not used as-is. Instead, it SHOULD be converted into a "stored password" SPwd, so that the plaintext password does not need to be stored for long periods. SPwd is defined as: </p>
<p></p>

<ul class="empty"><li>SPwd = prf("IKE with PACE", Pwd) </li></ul>

<p> </p>
<p id="rfc.section.4.1.p.3">where the literal string consists of ASCII characters with no zero terminator. If the negotiated prf requires a fixed-size key, the literal string is either truncated or padded with zero octets on the right, as needed.  </p>
<p></p>

<ul class="empty"><li>KPwd = prf+(Ni | Nr, SPwd) </li></ul>

<p> </p>
<p id="rfc.section.4.1.p.5">where Ni and Nr are the regular IKE nonces, stripped of any headers.  If the negotiated prf takes a fixed-length key and the lengths of Ni and Nr do not add up to that length, half the bits must come from Ni and half from Nr, taking the first bits of each.  "prf+" is defined in Sec. 2.13 of <a href="#RFC5996">[RFC5996]</a>.  The length of KPwd is determined by the key length of the negotiated encryption algorithm.  </p>
<p id="rfc.section.4.1.p.6">A nonce s is randomly selected by the initiator (see <a href="#randomness">Section 6.4</a> for additional considerations).  The length of s MUST be exactly 32 octets.  </p>
<p id="rfc.section.4.1.p.7">Note: Padding MUST NOT be used when encrypting the nonce. The size of the nonce has been chosen such that it can be encrypted with block ciphers having block sizes of 32, 64, and 128 bit without any padding.  </p>
<p id="rfc.section.4.1.p.8">If an authenticated encryption cipher <a href="#RFC5282">[RFC5282]</a> has been negotiated for the IKE SA, it MUST NOT be used as-is because such use would be vulnerable to dictionary attacks. Instead, the corresponding unauthenticated mode MUST be used. All GCM and all CCM encryption algorithms are mapped to the corresponding counter-mode algorithm. For example, if the negotiated encryption algorithm (Transform Type 1) is "AES-GCM with a 8 octet ICV", then ENCR_AES_CTR (with the same key length) is used to encrypt the nonce. If such a mapping does not exist for a particular cipher, then it MUST NOT be used within the current protocol.  </p>
<p id="rfc.section.4.1.p.9">KPwd is now used with the encryption transform to encrypt the nonce: </p>
<p></p>

<ul class="empty"><li>ENONCE = E(KPwd, s) </li></ul>

<p> </p>
<p id="rfc.section.4.1.p.11">If an Initialization Vector (IV) is required by the cipher, it MUST be included in the GSPM(ENONCE) payload. It is RECOMMENDED to choose the IV randomly and uniformly distributed, even though this condition is not necessary for the cryptographic security of the protocol.  </p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#mapping" id="mapping">Mapping the Nonce</a>
</h1>
<p id="rfc.section.4.2.p.1">The mapping is based on a second anonymous Diffie-Hellman key agreement protocol to create a shared secret which is used together with the exchanged nonce to calculate a common secret generator of the group.  </p>
<p id="rfc.section.4.2.p.2">While in <a href="#TR03110">[TR03110]</a> the generation of the shared secret is part of the mapping, in the setting of IKEv2 a shared secret SASharedSecret has already been generated as part of the IKE_SA_INIT step.  Using the notation of <a href="#RFC5996">[RFC5996]</a>, </p>
<p></p>

<ul class="empty"><li>SASharedSecret = g^ir</li></ul>

<p> </p>
<p id="rfc.section.4.2.p.4">Let G and GE be the generator of the negotiated DH group, and the calculated ephemeral generator, respectively. The following subsections describe the mapping for different Diffie-Hellman variants.  </p>
<h1 id="rfc.section.4.2.1">
<a href="#rfc.section.4.2.1">4.2.1.</a> MODP Diffie-Hellman</h1>
<p id="rfc.section.4.2.1.p.1">The function Map:G-&gt;GE is defined as GE = G^s * SASharedSecret.  </p>
<p id="rfc.section.4.2.1.p.2">Note that the protocol will fail if G^s = 1/SASharedSecret. If s is chosen randomly, this event occurs with negligible probability. In implementations that detect such a failure, the initiator SHOULD choose s again.  </p>
<h1 id="rfc.section.4.2.2">
<a href="#rfc.section.4.2.2">4.2.2.</a> Elliptic Curve Diffie-Hellman</h1>
<p id="rfc.section.4.2.2.p.1">The function Map:G-&gt;GE is defined as GE = s*G + SASharedSecret.  </p>
<p id="rfc.section.4.2.2.p.2">Note that the protocol will fail if s*G = -SharedSecret. If s is chosen randomly, this event occurs with negligible probability. In implementations that detect such a failure, the initiator SHOULD choose s again.  </p>
<h1 id="rfc.section.4.2.3">
<a href="#rfc.section.4.2.3">4.2.3.</a> Validation</h1>
<p id="rfc.section.4.2.3.p.1">Implementations MUST verify that the shared secrets SASharedSecret and PACESharedSecret are elements of the group generated by G to prevent small subgroup attacks.  </p>
<p id="rfc.section.4.2.3.p.2">It is RECOMMENDED to use the public key validation method or the compatible cofactor exponentiation described in Section 3.1 and Section 3.4, respectively, of <a href="#RFC2785">[RFC2785]</a>. The Elliptic Curve equivalents of those methods are described in more detail in <a href="#TR03111">[TR03111]</a>.  </p>
<p id="rfc.section.4.2.3.p.3">Any failure in the validation MUST be interpreted as an attack, and the protocol SHALL be aborted.  </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> Protocol Details</h1>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Password Processing</h1>
<p id="rfc.section.5.1.p.1">The input password string SHOULD be processed according to the rules of the <a href="#RFC4013">[RFC4013]</a> profile of <a href="#RFC3454">[RFC3454]</a>.  A password SHOULD be considered a "stored string" per <a href="#RFC3454">[RFC3454]</a> and unassigned code points are therefore prohibited.  The output is the binary representation of the processed UTF-8 character string.  Prohibited output and unassigned codepoints encountered in SASLprep preprocessing SHOULD cause a preprocessing failure and the output SHOULD NOT be used.  </p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> The SECURE_PASSWORD_METHODS Notification</h1>
<div id="#rfc.figure.3"></div>
<div id="#spm-payload"></div>
<pre>
              
                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Next Payload  |C|  RESERVED   |         Payload Length        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Protocol ID  |   SPI Size    |      Notify Message Type      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                Security Parameter Index (SPI)                 ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Notification Data                       ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       
            </pre>
<p><a href="#I-D.kivinen-ipsecme-secure-password-framework">[I-D.kivinen-ipsecme-secure-password-framework]</a> defines a new type of Notify payload to indicate support for Secure Password Methods (SPM) in the IKE_SA_INIT exchange.  The SPM Notify payload is defined as follows: </p>
<div id="#rfc.figure.4"></div>
<div id="#spm-data"></div>
<pre>
              
                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Secure Password Method #1     | Secure Password Method #2     |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Secure Password Method #3     | ...                           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       
            </pre>
<p id="rfc.section.5.2.p.2">The Notification Data contains the list of the 16-bit secure password method numbers: </p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> The GSPM(ENONCE) Payload</h1>
<p id="rfc.section.5.3.p.1">This protocol defines the ENONCE (encrypted nonce) payload, which reuses the GSPM payload type <a href="#I-D.kivinen-ipsecme-secure-password-framework">[I-D.kivinen-ipsecme-secure-password-framework]</a> (value TBD).  Its format is as follows:</p>
<div id="#rfc.figure.5"></div>
<div id="#enonce-payload"></div>
<pre>
              
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |C|  RESERVED   |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| PACE-RESERVED |     Initialization Vector                     |
+-+-+-+-+-+-+-+-+                                               +
|     (optional, length depends on the encryption algorithm)    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Encrypted Nonce                        ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
~                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       
            </pre>
<p></p>
<p id="rfc.section.5.3.p.3">See <a href="#encryption">Section 4.1</a> for further details about the encrypted nonce. Note that the protocol, and in particular this payload's format, does not support any padding of the encrypted data.</p>
<p id="rfc.section.5.3.p.4">The PACE-RESERVED field must be sent as zero, and must be rejected by the receiver if it is not 0.</p>
<h1 id="rfc.section.5.4">
<a href="#rfc.section.5.4">5.4.</a> The KE (KEi2/KEr2) Payloads in PACE</h1>
<p id="rfc.section.5.4.p.1">PACE reuses the KE payload for its Diffie-Hellman exchange, with the new payloads being sent within the IKE_AUTH exchange.  Since only one Diffie-Hellman group is negotiated, the group denoted by these payloads MUST be identical to the one used in the "regular" KE payloads in IKE_SA_INIT.</p>
<h1 id="rfc.section.5.5">
<a href="#rfc.section.5.5">5.5.</a> PACE and Session Resumption</h1>
<p id="rfc.section.5.5.p.1">A session resumption <a href="#RFC5723">[RFC5723]</a> ticket may be requested during the IKE_AUTH exchange.  The request MUST be sent in the request of the first round, and any response MUST be sent in the response of the second one.</p>
<p id="rfc.section.5.5.p.2">PACE should be considered an "authentication method", in the sense of Sec. 5 of <a href="#RFC5723">[RFC5723]</a>, which means that its use MUST be noted in the protected ticket. The format of the ticket is not standardized, however we RECOMMEND that this indication should distinguish between the different secure password authentication methods defined for IKE.</p>
<p id="rfc.section.5.5.p.3">Note that even if the initial authentication used PACE and its extended IKE_AUTH, session resumption will still include the normal IKE_AUTH exchange.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> Security Considerations</h1>
<p id="rfc.section.6.p.1">A major goal of this protocol has been to maintain the level of security provided by IKEv2. What follows is an analysis of this protocol. The reader is referred to <a href="#RFC5996">[RFC5996]</a> for the generic IKEv2 security considerations.</p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> Credential Security Assumptions</h1>
<p id="rfc.section.6.1.p.1">This protocol makes no assumption on the strength of the shared credential.  Best common practices regarding minimal password length, use of multiple character classes etc. SHOULD be followed.</p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> Vulnerability to Passive and Active Attacks</h1>
<p id="rfc.section.6.2.p.1">The protocol is secure against both passive and active attackers. See <a href="#security-proof">Section 6.8</a> for a security proof.  </p>
<p id="rfc.section.6.2.p.2">While not attacking the cryptography, an attacker can still perform a standard password guessing attack.  To mitigate such attacks, an implementation MUST include standard protections, such as rate limiting the number of allowed password guessing attempts, possibly locking identities out after a certain number of failed attempts etc. Note that the protocol is symmetric and therefore this guidance applies to client-side implementations as well.  </p>
<h1 id="rfc.section.6.3">
<a href="#rfc.section.6.3">6.3.</a> Perfect Forward Secrecy</h1>
<p id="rfc.section.6.3.p.1">The key derivation for the IKE SA and any Child SAs is performed as part of IKEv2 and remains unchanged. It directly follows that perfect forward security is provided independent of the authentication additionally performed by PACE.</p>
<h1 id="rfc.section.6.4">
<a href="#rfc.section.6.4">6.4.</a> <a href="#randomness" id="randomness">Randomness</a>
</h1>
<p id="rfc.section.6.4.p.1">The security of this protocol depends on the quality generation of random quantities, and see Sec. 5 of <a href="#RFC5996">[RFC5996]</a> for more details. Specifically, any deviation from randomness of the nonce s might compromise the password. Therefore, it is strongly RECOMMENDED that the initiator passes the raw random material through a strong prf to ensure the statistical qualities of the nonce.  </p>
<h1 id="rfc.section.6.5">
<a href="#rfc.section.6.5">6.5.</a> Identity Protection</h1>
<p id="rfc.section.6.5.p.1">This protocol is identical to IKEv2 in the quality of identity protection it provides.  Both peers' identities are secure from passive attackers, and both peers' identities are exposed to active, man-in-the-middle attackers.</p>
<h1 id="rfc.section.6.6">
<a href="#rfc.section.6.6">6.6.</a> Denial of Service</h1>
<p id="rfc.section.6.6.p.1">We are not aware of any new denial-of-service attack vector enabled by this protocol. </p>
<h1 id="rfc.section.6.7">
<a href="#rfc.section.6.7">6.7.</a> Choice of Encryption Algorithms</h1>
<p id="rfc.section.6.7.p.1">Any transforms negotiated for IKEv2 may be used by this protocol. Please refer to <a href="#encryption">Section 4.1</a> for the considerations regarding authenticated encryption ("combined mode") algorithms.</p>
<h1 id="rfc.section.6.8">
<a href="#rfc.section.6.8">6.8.</a> <a href="#security-proof" id="security-proof">Security Model and Security Proof</a>
</h1>
<p id="rfc.section.6.8.p.1">PACE is cryptographically proven secure in <a href="#PACEsec">[PACEsec]</a> in the model of Bellare, Pointcheval, and Rogaway <a href="#BPRmodel">[BPRmodel]</a>.  The setting in which PACE is proven secure is however slightly different from the setting used in IKEv2. The differences are described in the following: </p>

<ul>
<li>Part of the mapping is already performed within IKEv2 before PACE is started. This rearrangement does not affect the proof as the resulting PACESharedSecret remains close to uniformly distributed in the group generated by G.</li>
<li>The keys for the IKE SA and any Child SAs are already generated within IKEv2 before PACE is started. While those session keys could also be derived in PACE, only the keys for the authentication token are considered in the proof, which explicitly recommends a separate key for this purpose.</li>
<li>IKEv2 allows the negotiation of a stream cipher for PACE while the proven variant always uses a block cipher. The ideal cipher is replaced in the proof by lazy-sampling technique which is similarly applicable to the stream cipher based construction.</li>
</ul>

<p> The differences in the setting therefore have no impact on the validity of the proof.  </p>
<h1 id="rfc.section.6.9">
<a href="#rfc.section.6.9">6.9.</a> Long-Term Credential Storage</h1>
<p id="rfc.section.6.9.p.1">This protocol does not require peers to store the plaintext password. Instead, the value SPwd SHOULD be stored by both peers.  </p>
<p id="rfc.section.6.9.p.2">It has been suggested to generate a "long" shared secret after the initial authentication, such that the peers can use it later for standard preshared-secret authentication, in lieu of the short password.  This approach is described in more detail in <a href="#long-secret">Appendix Appendix B.3</a>, but it is not clear whether its security benefits justify the added complexity.  </p>
<p id="rfc.section.6.9.p.3">The main usage scenario for the current protocol is for authentication between IKE peers, in a symmetric setting. We believe that IKEv2 with EAP takes care quite well of the asymmetric, remote access case. Each of the peers might need to initiate the IKE SA, which makes traditional password salting less than ideal.</p>
<p id="rfc.section.6.9.p.4">A future version of this protocol might cater to the scenario where one of the peers is more vulnerable than the other to theft of the password database, using a salt exchanged in IKE_SA_INIT.  Alternatively, public key techniques can be used to salt the password differently on each of the peers, however this would introduce additional computational effort into the protocol. See <a href="#salting">Appendix Appendix B</a> for a more detailed discussion of potential solutions.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> IANA Considerations</h1>
<p id="rfc.section.7.p.1">IANA is requested to allocate (has allocated) the following value: </p>

<ul><li>A PACE_AUTH_METHOD value from the "IKEv2 Secure Password Methods" registry <a href="#I-D.kivinen-ipsecme-secure-password-framework">[I-D.kivinen-ipsecme-secure-password-framework]</a>.</li></ul>

<p> This document does not define any new registries.  </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Acknowledgments</h1>
<p id="rfc.section.8.p.1">We would like to thank Dan Harkins for pointing out a security issue with our use of combined-mode algorithms, in a previous version of the protocol. We thank Tero Kivinen for his generic framework document, and for a thorough and fruitful review.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">9.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">9.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2785">[RFC2785]</b></td>
<td class="top">
<a href="mailto:robert.zuccherato@entrust.com" title="Entrust Technologies">Zuccherato, R.</a>, "<a href="http://tools.ietf.org/html/rfc2785">Methods for Avoiding the "Small-Subgroup" Attacks on the Diffie-Hellman Key Agreement Method for S/MIME</a>", RFC 2785, March 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3454">[RFC3454]</b></td>
<td class="top">
<a>Hoffman, P.</a> and <a>M. Blanchet</a>, "<a href="http://tools.ietf.org/html/rfc3454">Preparation of Internationalized Strings ("stringprep")</a>", RFC 3454, December 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4013">[RFC4013]</b></td>
<td class="top">
<a>Zeilenga, K.</a>, "<a href="http://tools.ietf.org/html/rfc4013">SASLprep: Stringprep Profile for User Names and Passwords</a>", RFC 4013, February 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5996">[RFC5996]</b></td>
<td class="top">
<a>Kaufman, C.</a>, <a>Hoffman, P.</a>, <a>Nir, Y.</a> and <a>P. Eronen</a>, "<a href="http://tools.ietf.org/html/rfc5996">Internet Key Exchange Protocol Version 2 (IKEv2)</a>", RFC 5996, September 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">9.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.harkins-ipsecme-pake-criteria">[I-D.harkins-ipsecme-pake-criteria]</b></td>
<td class="top">
<a>Harkins, D</a>, "<a href="http://tools.ietf.org/html/draft-harkins-ipsecme-pake-criteria-01">Password-Based Authentication in IKEv2: Selection Criteria and Considerations</a>", Internet-Draft draft-harkins-ipsecme-pake-criteria-01, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.kivinen-ipsecme-secure-password-framework">[I-D.kivinen-ipsecme-secure-password-framework]</b></td>
<td class="top">
<a>Kivinen, T</a>, "<a href="http://tools.ietf.org/html/draft-kivinen-ipsecme-secure-password-framework-03">Secure Password Framework for IKEv2</a>", Internet-Draft draft-kivinen-ipsecme-secure-password-framework-03, October 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5998">[RFC5998]</b></td>
<td class="top">
<a>Eronen, P.</a>, <a>Tschofenig, H.</a> and <a>Y. Sheffer</a>, "<a href="http://tools.ietf.org/html/rfc5998">An Extension for EAP-Only Authentication in IKEv2</a>", RFC 5998, September 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5282">[RFC5282]</b></td>
<td class="top">
<a>Black, D.</a> and <a>D. McGrew</a>, "<a href="http://tools.ietf.org/html/rfc5282">Using Authenticated Encryption Algorithms with the Encrypted Payload of the Internet Key Exchange version 2 (IKEv2) Protocol</a>", RFC 5282, August 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5723">[RFC5723]</b></td>
<td class="top">
<a>Sheffer, Y.</a> and <a>H. Tschofenig</a>, "<a href="http://tools.ietf.org/html/rfc5723">Internet Key Exchange Protocol Version 2 (IKEv2) Session Resumption</a>", RFC 5723, January 2010.</td>
</tr>
<tr>
<td class="reference"><b id="TR03110">[TR03110]</b></td>
<td class="top">
<a>BSI, </a>, "<a>TR-03110, Advanced Security Mechanisms for Machine Readable Travel Documents - Extended Access Control (EAC), Password Authenticated Connection Establishment (PACE), and Restricted Identification (RI), Version 2.03</a>", 2010.</td>
</tr>
<tr>
<td class="reference"><b id="TR03111">[TR03111]</b></td>
<td class="top">
<a>BSI, </a>, "<a>TR-03111, Elliptic Curve Cryptography, Version 1.11</a>", 2009.</td>
</tr>
<tr>
<td class="reference"><b id="PACEsec">[PACEsec]</b></td>
<td class="top">
<a>Bender, J.</a>, <a>Fischlin, M.</a> and <a>D. Kuegler</a>, "<a>Security Analysis of the PACE Key-Agreement Protocol. The extended abstract appeared in Information Security Conference (ISC) 2009, LNCS 5735, pp. 33-48, Springer-Verlag</a>", 2009.</td>
</tr>
<tr>
<td class="reference"><b id="BPRmodel">[BPRmodel]</b></td>
<td class="top">
<a>Bellare, M.</a>, <a>Pointcheval, D.</a> and <a>P. Rogaway</a>, "<a>Authenticated Key Exchange Secure against Dictionary Attacks, EUROCRYPT 2000, LNCS 1807, pp. 139-155, Springer-Verlag</a>", 2000.</td>
</tr>
<tr>
<td class="reference"><b id="ICAO">[ICAO]</b></td>
<td class="top">
<a>ISO/IEC JTC1 SC17 WG3/TF5 for ICAO, </a>, "<a>Supplemental Access Control for Machine Readable Travel Documents, version 1.00</a>", March 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> Protocol Selection Criteria</h1>
<p id="rfc.section.Appendix A.p.1">To support the selection of a password-based protocol for inclusion in IKEv2, a number of criteria are provided in <a href="#I-D.harkins-ipsecme-pake-criteria">[I-D.harkins-ipsecme-pake-criteria]</a>. In the following sections, those criteria are applied to the PACE protocol.  </p>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> Security Criteria</h1>
<p></p>

<dl>
<dt>SEC1 :</dt>
<dd>PACE is a zero knowledge protocol.  </dd>
<dt>SEC2 :</dt>
<dd>The protocol supports perfect forward secrecy and is resistant to replay attacks.  </dd>
<dt>SEC3 :</dt>
<dd>The identity protection provided by IKEv2 remains unchanged.  </dd>
<dt>SEC4 :</dt>
<dd>Any cryptographically secure Diffie-Hellman group can be used.  </dd>
<dt>SEC5 :</dt>
<dd>The protocol is proven secure in the Bellare-Pointcheval-Rogaway model.  </dd>
<dt>SEC6 :</dt>
<dd>Strong session keys are generated.  </dd>
<dt>SEC7 :</dt>
<dd>A transform of the password can be used instead of the password itself.  </dd>
</dl>

<p> </p>
<h1 id="rfc.appendix.Appendix A.2">
<a href="#rfc.appendix.Appendix%20A.2">Appendix A.2.</a> Intellectual Property Criteria</h1>
<p></p>

<dl>
<dt>IPR1 :</dt>
<dd>The first draft of <a href="#TR03110">[TR03110]</a> was published on May 21, 2007.  </dd>
<dt>IPR2 :</dt>
<dd>BSI has developed PACE aiming to be free of patents. BSI has not applied for a patent on PACE.  </dd>
<dt>IPR3 :</dt>
<dd>The protocol itself is believed to be free of IPR.  </dd>
</dl>

<p> </p>
<h1 id="rfc.appendix.Appendix A.3">
<a href="#rfc.appendix.Appendix%20A.3">Appendix A.3.</a> Miscellaneous Criteria</h1>
<p></p>

<dl>
<dt>MISC1 :</dt>
<dd>One additional exchange is required.  </dd>
<dt>MISC2 :</dt>
<dd>The protocol requires the following operations per entity: <ul>
<li>one key derivation from the password, </li>
<li>one symmetric encryption or decryption, </li>
<li>one multi-exponentiation for the mapping, </li>
<li>one exponentiation for the key pair generation, </li>
<li>one exponentiation for the shared secret calculation, and </li>
<li>two symmetric authentications (generation and verification).  </li>
</ul>
<p> </p>
</dd>
<dt>MISC3 :</dt>
<dd>The performance is independent of the type/size of password.  </dd>
<dt>MISC4 :</dt>
<dd>Internationalization of character-based passwords is supported.  </dd>
<dt>MISC5 :</dt>
<dd>The protocol uses the same group as negotiated for IKEv2.  </dd>
<dt>MISC6 :</dt>
<dd>The protocol fits into the request/response nature of IKE.  </dd>
<dt>MISC7 :</dt>
<dd>The password-based symmetric encryption must be additionally negotiated.  </dd>
<dt>MISC8 :</dt>
<dd>Neither trusted third parties nor clock synchronization are required.  </dd>
<dt>MISC9 :</dt>
<dd>Only general cryptographic primitives are required.  </dd>
<dt>MISC10 :</dt>
<dd>Any secure variant of Diffie-Hellman (e.g. standard or Elliptic Curve) can be used.  </dd>
<dt>MISC11 :</dt>
<dd>The protocol can be implemented easily based on existing cryptographic primitives.  </dd>
</dl>

<p> </p>
<h1 id="rfc.appendix.Appendix B">
<a href="#rfc.appendix.Appendix%20B">Appendix B.</a> <a href="#salting" id="salting">Password Salting</a>
</h1>
<p id="rfc.section.Appendix B.p.1">This protocol requires that passwords should not be stored in plaintext. Instead, we store a hash of the password with a fixed hash. This value is then used in the ZKPP protocol, replacing the original password and acting as a "password equivalent". The main benefit of this solution is that a system administrator or an undetermined attacker does not get immediate access to the passwords.  We believe this is sufficiently secure for the main usage scenario of the protocol.</p>
<p id="rfc.section.Appendix B.p.2">However the common practice of password salting is clearly more powerful, and this appendix presents a few ideas on how password salting can be applied and/or adopted to fit into a symmetric protocol such as IKE. First, let us list the threats that we expect salting to handle, as well as the non-threats: </p>

<ul>
<li>The plain password should not be visible to a casual onlooker, as noted above. It is assumed that very often the same password is used for multiple applications, and so a password exposed allows an attacker a starting point for further attacks.</li>
<li>An attacker must not be able to construct lookup tables (such as the famous "rainbow tables") that enable her to discover the plain password.</li>
<li>IKE is a symmetric protocol, in the sense that any of the peers might initiate an IKE exchange to another peer.  As a result all peers must have stored credentials (passwords or password equivalents) that would enable them to set up an IKE exchange. So an attacker that reaches the credential store would in fact be able to impersonate IKE to another peer. We believe that this reduces, but does not invalidate the importance of salting, because of the other threats that remain.</li>
</ul>

<p> Below we present different scenarios and solutions that support password salting in this setting.  </p>
<p id="rfc.section.Appendix B.p.3">We assume that each credential is used to authenticate exactly two peers to one another, i.e.  (as per the best practice) group credentials are not allowed.</p>
<h1 id="rfc.appendix.Appendix B.1">
<a href="#rfc.appendix.Appendix%20B.1">Appendix B.1.</a> Solving the Asymmetric Case with Symmetric Cryptography</h1>
<p id="rfc.section.Appendix B.1.p.1">Despite the protocol's symmetry, there are use cases that are somewhat asymmetric. Consider the case of an organization that consists of a headquarters and branches, using a hub-and-spoke architecture.  Communication sessions can be initiated by the center or by any of the branches, but only the center holds a large credential database.</p>
<p id="rfc.section.Appendix B.1.p.2">Here it would be possible to use traditional password salting, </p>

<ul class="empty"><li>stored password = hash(salt, password), </li></ul>

<p> where the hash function is a symmetric hash (e.g. HMAC-SHA-256), and the salt is picked at random for each password.  The salt would need to be sent in the first exchange of the protocol, regardless of which side initiates the session. Unlike the normal use of salted passwords, here it is the stored password, rather then the original password, that is used by the follow-on ZKPP protocol.  </p>
<h1 id="rfc.appendix.Appendix B.2">
<a href="#rfc.appendix.Appendix%20B.2">Appendix B.2.</a> Solving the Fully Symmetric Case with Asymmetric Cryptography</h1>
<p id="rfc.section.Appendix B.2.p.1">For the fully symmetric case, we propose a salting method based on a commutative one-way function.  This is essentially a novel variant of the RSA protocol. </p>
<p id="rfc.section.Appendix B.2.p.2">The implementation proposed here requires a composite number n that is common to all peers.  The composite number n can be either generated by a trusted (third) party as n = p * q, where p and q are strong primes (i.e. p = 2 * p' + 1 and q = 2 * q' + 1, where p' and q' are also primes), and the trusted party promises not to retain a copy of the primes. Alternatively, n can be chosen randomly and tested for "small" prime factors. In the latter case it is certainly not guaranteed that n is composed of only two primes.  While this has the advantage that no one knows the factorization of n, the disadvantage is that n is likely to be significantly easier to factor.</p>
<p id="rfc.section.Appendix B.2.p.3">Each peer then chooses a public encrytion key e. In a simple implementation the encryption key is generated randomly by each peer, picking a different value for each of the passwords that it stores. </p>
<p id="rfc.section.Appendix B.2.p.4">Note that although the pair (n,e) is similar to an RSA public key, the usual rules for generating "e" for the RSA protocol do not apply here, and a random "e" is sufficient.  The password is hashed by a symmetric hash function H (e.g. SHA-256). Each peer i stores the two values </p>

<ul class="empty"><li>e_i, H(P)^e_i (mod n)</li></ul>

<p> where P is the original password. The values e_i are exchanged by the peers before the ZKPP protocol commences (in IKEv2-PACE, this would be in IKE_SA_INIT) and the following value is used in the ZKPP protocol run that follows, in lieu of the original password: </p>

<ul class="empty"><li>H(P) ^ (e_i * e_j) (mod n).</li></ul>

<p> This transformation is used as a salting mechanism only and the salted values themselves are never sent on the wire.  </p>
<p id="rfc.section.Appendix B.2.p.5">This scheme can be enhanced by basing the value "e" on each peer's identity (IDi, IDr), e.g. making it a simple hash of the identity. This eliminates the need to send "e" explicitly, and additionally binds the identity of the peer with its secret. </p>
<h1 id="rfc.appendix.Appendix B.3">
<a href="#rfc.appendix.Appendix%20B.3">Appendix B.3.</a> <a href="#long-secret" id="long-secret">Generation of a Long Shared Secret</a>
</h1>
<p id="rfc.section.Appendix B.3.p.1">An alternative to salting is to store the plain passwords, but only for a short while. As soon as the first IKE SA is set up between two peers, the peers exchange nonces and generate a long shared secret, based on IKE's SK_d. They now destroy the short password and replace it with the new secret.</p>
<p id="rfc.section.Appendix B.3.p.2">Such a protocol extension would need to be architected so that a protocol failure does not result in the two peers losing the ability to communicate. Schematically, this could be done as follows:</p>
<div id="#rfc.figure.6"></div>
<div id="#password-expand"></div>
<pre>
              
Initiator                                           Responder
---------                                           ---------
Generates nonce1
			---&gt;  Nonce1
			   
				Generates nonce2
				Computes and stores the shared secret
					
			&lt;---  Nonce2
			   
(The above two messages can be piggybacked onto round #2 of IKE_AUTH)

Computes and stores the shared secret

			---&gt;  Secret_OK
			   
				Deletes the short password
					
			&lt;---  Secret_OK
			   
Deletes the short password

            </pre>
<p></p>
<p id="rfc.section.Appendix B.3.p.4">In the above, it is critical that the responder should only store the shared secret after it has fully authenticated the initiator.  Moreover, this method should be optional, because we do not expect all IKE implementations to have write-access into their credential database.</p>
<h1 id="rfc.appendix.Appendix C">
<a href="#rfc.appendix.Appendix%20C">Appendix C.</a> Change Log</h1>
<p id="rfc.section.Appendix C.p.1">Note to RFC Editor: please remove this appendix before publication.</p>
<h1 id="rfc.appendix.Appendix C.1">
<a href="#rfc.appendix.Appendix%20C.1">Appendix C.1.</a> -07</h1>
<p id="rfc.section.Appendix C.1.p.1">Adopted the framework proposed in <a href="#I-D.kivinen-ipsecme-secure-password-framework">[I-D.kivinen-ipsecme-secure-password-framework]</a>. However this document is self-contained. Changed the PKEi/r payloads to reuse the normal KE payloads; they are disambiguated by the context: which exchange they are used in.  Added an appendix on password salting for symmetric protocols.</p>
<h1 id="rfc.appendix.Appendix C.2">
<a href="#rfc.appendix.Appendix%20C.2">Appendix C.2.</a> -06</h1>
<p id="rfc.section.Appendix C.2.p.1">Defined how authenticated-encryption algorithms can be used. Updated references.</p>
<h1 id="rfc.appendix.Appendix C.3">
<a href="#rfc.appendix.Appendix%20C.3">Appendix C.3.</a> -05</h1>
<p id="rfc.section.Appendix C.3.p.1">Editorial corrections.</p>
<h1 id="rfc.appendix.Appendix C.4">
<a href="#rfc.appendix.Appendix%20C.4">Appendix C.4.</a> -04</h1>
<p id="rfc.section.Appendix C.4.p.1">Editorial corrections.</p>
<h1 id="rfc.appendix.Appendix C.5">
<a href="#rfc.appendix.Appendix%20C.5">Appendix C.5.</a> -03</h1>
<p id="rfc.section.Appendix C.5.p.1">Completed the security considerations (security proof). Reordered some sections for clarity.</p>
<h1 id="rfc.appendix.Appendix C.6">
<a href="#rfc.appendix.Appendix%20C.6">Appendix C.6.</a> -02</h1>
<p id="rfc.section.Appendix C.6.p.1">Added security considerations. Changed encryption of the nonce. Simplified the derivation of the AUTH payloads.</p>
<h1 id="rfc.appendix.Appendix C.7">
<a href="#rfc.appendix.Appendix%20C.7">Appendix C.7.</a> draft-kuegler-ipsecme-pace-ikev2-01</h1>
<p id="rfc.section.Appendix C.7.p.1">Formalized the protocol: added payload formats, error behavior etc.</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Dennis Kuegler</span> 
	  <span class="n hidden">
		<span class="family-name">Kuegler</span>
	  </span>
	</span>
	<span class="org vcardline">Bundesamt fuer Sicherheit in der Informationstechnik (BSI)</span>
	<span class="adr">
	  <span>Postfach 200363</span>

	  <span class="vcardline">
		<span class="locality">Bonn</span>,  
		<span class="region"></span>
		<span class="code">53133</span>
	  </span>
	  <span class="country-name vcardline">Germany</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:dennis.kuegler@bsi.bund.de">dennis.kuegler@bsi.bund.de</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Yaron Sheffer</span> 
	  <span class="n hidden">
		<span class="family-name">Sheffer</span>
	  </span>
	</span>
	<span class="org vcardline">Porticor</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:yaronf.ietf@gmail.com">yaronf.ietf@gmail.com</a></span>

  </address>
</div>

</body>
</html>