<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Obtaining and Using Globally
    Routable User Agent (UA) URIs (GRUU) in the Session Initiation
    Protocol (SIP)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Obtaining and Using Globally
    Routable User Agent (UA) URIs (GRUU) in the Session Initiation
    Protocol (SIP)">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">SIP</td><td class="header">J. Rosenberg</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">October 12, 2007</td></tr>
<tr><td class="header">Expires: April 14, 2008</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Obtaining and Using Globally
    Routable User Agent (UA) URIs (GRUU) in the Session Initiation
    Protocol (SIP)<br />draft-ietf-sip-gruu-15</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on April 14, 2008.</p>

<h3>Abstract</h3>

<p>Several applications of the Session Initiation Protocol
      (SIP) require a user agent (UA) to construct and distribute a URI
      that can be used by anyone on the Internet to route a call to that
      specific UA instance. A URI that routes to a specific UA instance is
      called a Globally Routable UA URI (GRUU). This document describes an
      extension to SIP for obtaining a GRUU from a registrar and for
      communicating a GRUU to a peer within a dialog.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#anchor3">3.</a>&nbsp;
Overview of Operation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-structure">3.1.</a>&nbsp;
Structure of GRUUs<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-pubgruu">3.1.1.</a>&nbsp;
GRUUs Which Expose the Underlying AOR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">3.1.2.</a>&nbsp;
GRUUs Which Hide the Underlying AOR<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">3.2.</a>&nbsp;
Obtaining a GRUU<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">3.3.</a>&nbsp;
Using a GRUU<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">3.4.</a>&nbsp;
Dereferencing a GRUU<br />
<a href="#anchor8">4.</a>&nbsp;
User Agent Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">4.1.</a>&nbsp;
Generating a REGISTER Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">4.2.</a>&nbsp;
Learning GRUUs from REGISTER Responses<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">4.3.</a>&nbsp;
Constructing a Self-Made GRUU<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-sendto">4.4.</a>&nbsp;
Using Ones Own GRUUs<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">4.4.1.</a>&nbsp;
Considerations for Multiple AORs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">4.5.</a>&nbsp;
Dereferencing a GRUU<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">4.6.</a>&nbsp;
Rendering GRUUs on a User Interface<br />
<a href="#anchor15">5.</a>&nbsp;
Registrar Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-regprocess">5.1.</a>&nbsp;
Processing a REGISTER Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">5.2.</a>&nbsp;
Generating a REGISTER Response<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-reg-time">5.3.</a>&nbsp;
Timing Out a Registration<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-creation">5.4.</a>&nbsp;
Creation of a GRUU<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">5.5.</a>&nbsp;
Registration Event Support<br />
<a href="#sec-proxy">6.</a>&nbsp;
Proxy Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-proxy-main">6.1.</a>&nbsp;
Request Targeting<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-rr">6.2.</a>&nbsp;
Record-Routing<br />
<a href="#sec-grammar">7.</a>&nbsp;
Grammar<br />
<a href="#anchor18">8.</a>&nbsp;
Requirements<br />
<a href="#anchor19">9.</a>&nbsp;
Example Call Flow<br />
<a href="#anchor20">10.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">10.1.</a>&nbsp;
Outside Attacks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor22">10.2.</a>&nbsp;
Inside Attacks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-privacy">10.3.</a>&nbsp;
Privacy Considerations<br />
<a href="#anchor23">11.</a>&nbsp;
IANA Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">11.1.</a>&nbsp;
Header Field Parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">11.2.</a>&nbsp;
URI Parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor26">11.3.</a>&nbsp;
SIP Option Tag<br />
<a href="#anchor27">12.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">13.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">13.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">13.2.</a>&nbsp;
Informative References<br />
<a href="#sec-app">Appendix&nbsp;A.</a>&nbsp;
Example GRUU Construction Algorithms<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-cons-public">A.1.</a>&nbsp;
Public GRUU<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor30">A.2.</a>&nbsp;
Temporary GRUU<br />
<a href="#anchor31">Appendix&nbsp;B.</a>&nbsp;
Network Design Considerations<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>In the Session Initiation Protocol (SIP), RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, the basic unit of reference is the
Address-Of-Record (AOR). However, in SIP systems a single user can
have a number of user agents (handsets, softphones, voicemail
accounts, etc.) which are all referenced by the same AOR. There are a
number of contexts in which it is desirable to have an identifier
which addresses a single user agent rather than the group of user
agents indicated by an AOR.

</p>
<p>As an example, consider a blind transfer application (see
draft-ietf-sipping-cc-transfer <a class='info' href='#I-D.ietf-sipping-cc-transfer'>[I&#8209;D.ietf&#8209;sipping&#8209;cc&#8209;transfer]<span> (</span><span class='info'>Sparks, R. and A. Johnston, &ldquo;Session Initiation Protocol Call Control - Transfer,&rdquo; March&nbsp;2009.</span><span>)</span></a>). User A is talking to user
B. User A wants to transfer the call to user C. So, user A sends a
REFER to user C. That REFER looks like, in part:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

    REFER sip:C@example.com SIP/2.0
    From: sip:A@example.com;tag=99asd
    To: sip:C@example.com
    Refer-To: (URI that identifies B's UA)
</pre></div>
<p>The Refer-To header field needs to contain a URI that can be used
by user C to place a call to user B. However, this call needs to route
to the specific UA instance that user B is using to talk to user A.
If it doesn't, the transfer service will not execute properly. For
example, if A provides C with B's AOR, the call might be routed to
B's voice mail rather than B's current handset.

</p>
<p>In order to enable this functionality, User B provides an
instance-specific URI to User A in the Contact header of their SIP
exchange. This URI refers only the user agent B is currently using
and can be provided to user C.  Because user B doesn't know in advance
who user A will transfer the call to, the URI has to be usable by
anyone.

</p>
<p>Many current clients attempt to meet the need for an
instance-specific identifier by using explicit IP addresses in the
values they provide in the Contact header field. However, this interacts
poorly with NATs and firewalls, and as a practical matter these URIs
cannot be used by arbitrary external clients. Similarly, usage of
hostnames has proven problematic for similar reasons. In addition,
many SIP clients do not have or cannot obtain a hostname for
themselves at all. 

</p>
<p>This specification describes a mechanism for providing a unique
user-agent identifier which is still globally routable.  This
identifier is called a Globally Routable User Agent (UA) URI
(GRUU).

</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p> The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in
this document are to be interpreted as described in <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].  
</p>
<p>
This specification defines the following additional terms:

</p>
<p></p>
<blockquote class="text"><dl>
<dt>contact:</dt>
<dd>The term "contact", when used in all
lowercase, refers to a URI that is bound to an AOR and GRUU by
means of a registration. A contact is usually a SIP URI, and
is bound to the AOR and GRUU through a REGISTER request by
appearing as a value of the Contact header field. The contact URI
identifies a specific UA. 

</dd>
<dt>remote target:</dt>
<dd>The term "remote target" refers
to a URI that a user agent uses to identify itself for receipt
of both mid-dialog and out-of-dialog requests. A remote target
is established by placing a URI in the Contact header field of
a dialog-forming request or response and updated by target
refresh requests or responses.  
</dd>
<dt>Contact header field:</dt>
<dd> The term "Contact header
field", with a capitalized C, refers to the header field which
can appear in REGISTER requests and responses, redirects, or
in dialog-creating requests and responses. Depending on the
semantics, the Contact header field sometimes conveys a
contact, and sometimes conveys a remote target.

</dd>
</dl></blockquote>

<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Overview of Operation</h3>

<p>The basic idea behind a GRUU is simple. GRUUs are issued by SIP
domains and always route back to a proxy in that domain. The domain in turn
maintains the binding between the GRUU and the particular UA
instance. When a GRUU is de-referenced when sending a SIP request,
that request arrives at the proxy. It maps the GRUU to the contact for
the particular UA instance, and sends the request there.

</p>
<a name="sec-structure"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Structure of GRUUs</h3>

<p>
A GRUU is a SIP URI that has two properties:

</p>
<p></p>
<ul class="text">
<li>It routes to a specific UA instance.
</li>
<li>It can be successfully de-referenced by any user agent on the
Internet, not just ones in the same domain or IP network as the UA
instance to which the GRUU points. 

</li>
</ul>

<p>In principle, a GRUU can be constructed in any way the domain
chooses, as long as it meets the criteria above. However, all GRUUs
contain the "gr" URI parameter (either with or without a value), so
that a recipient of a GRUU can tell that it has these two properties.

</p>
<p>In practice, there are two different types of GRUUs:

</p>
<ol class="text">
<li>GRUUs which expose the underlying AOR
</li>
<li>GRUUs which hide the underlying AOR
</li>
</ol>
<a name="sec-pubgruu"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.1"></a><h3>3.1.1.&nbsp;
GRUUs Which Expose the Underlying AOR</h3>

<p>In many cases it is desirable to construct the GRUU in such 
a way that the mapping to the AOR is apparent. For example, many user
agents retain call logs, which keep track of incoming and outgoing
call attempts. If the UA had made a call to a GRUU (perhaps as a
consequence of a transfer request), the call log will contain the
GRUU. Since the call log is rendered to the user, it would be useful
to be able to present the user with the AOR instead, since the AOR is
meaningful to users as an identifier. 

</p>
<p>This type of GRUU is called a public GRUU. It is constructed by taking
the AOR, and adding the "gr" URI parameter with a value chosen by the
registrar in the domain. The value of the "gr" URI parameter contains a
representation of the UA instance. For instance, if the AOR was
"sip:alice@example.com", the GRUU might be:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

    sip:alice@example.com;gr=kjh29x97us97d
</pre></div>
<p>
If a UA removes the "gr" URI parameter, the result is the AOR. Since many
systems ignore unknown parameters anyway, a public GRUU will "look"
like the AOR to those systems.

</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.2"></a><h3>3.1.2.&nbsp;
GRUUs Which Hide the Underlying AOR</h3>

<p>
In other cases it is desirable to construct a GRUU that obfuscates the
AOR such that it cannot be extracted by a recipient of the GRUU. 
Such a GRUU is called a temporary GRUU. The most
obvious reason to do this is to protect the 
user's privacy. In such cases, the GRUU can have any content provided
that it meets the requirements in <a class='info' href='#sec-structure'>Section&nbsp;3.1<span> (</span><span class='info'>Structure of GRUUs</span><span>)</span></a> and
<a class='info' href='#sec-creation'>Section&nbsp;5.4<span> (</span><span class='info'>Creation of a GRUU</span><span>)</span></a>, and
the AOR cannot be readily determined from the GRUU. The GRUU will have
the "gr" URI parameter, either with or without a value. In
order to avoid 
creating excessive state in the registrar, it is often desirable to
construct cryptographically protected "stateless" GRUUs using an
algorithm like that described in Appendix A.

</p>
<p>
An example of a temporary GRUU constructed using a stateful algorithm
would be:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

    sip:asd887f9dfkk76690@example.com;gr
</pre></div>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Obtaining a GRUU</h3>

<p>A User Agent can obtain a GRUU in one of several ways:

</p>
<p></p>
<ul class="text">
<li>As part of its REGISTER transaction.
</li>
<li>By constructing one locally, using the IP address or hostname of
the user agent instance as the domain part of the URI. These are
called self-made GRUUs, and are only really GRUUs when constructed by UA
that know they are globally reachable using their IP address or
hostname.

</li>
<li>Via some locally-specified Administrative mechanism.
</li>
</ul>

<p>A UA which wants to obtain a GRUU via its REGISTER request does so
by providing an instance ID in the "+sip.instance" Contact header
field parameter, defined in draft-ietf-sip-outbound  <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>. For 
example: 

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

      Contact: &lt;sip:callee@192.0.2.2&gt;
      ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
</pre></div>
<p>The registrar detects this header field parameter and provides two
GRUUs in the 
REGISTER response. One of these is a temporary GRUU, and the other is
the public GRUU. These two GRUUs are returned in the "temp-gruu" 
and "pub-gruu" Contact header field parameters in the response,
respectively.  For example: 

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Contact: &lt;sip:callee@192.0.2.2&gt;
 ;pub-gruu="sip:callee@example.com;gr=urn:
  uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
 ;temp-gruu="sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr"
 ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
 ;expires=3600
</pre></div>
<p>
When a user agent refreshes this registration prior to its expiration,
the registrar will return back the same public GRUU, but will create a
new temporary GRUU. Despite the fact that each refresh provides the UA
with a new temporary GRUU, all of the temporary GRUUs learned from
previous REGISTER responses during the lifetime of a contact remain
valid as long as (1) that contact remains registered, and (2) the UA
doesn't change the Call-ID in its REGISTER request compared to
previous ones. When the contact expires, either through explicit
de-registration or timeout, all of the temporary GRUUs be
invalidated. Similarly, if a register refresh changes the Call-ID
compared to previous register refreshes, all of the previous temporary
GRUUs are invalidated. When the user agent later creates a new
registration with the same instance ID, the public GRUU is the
same. The temporary GRUU will be new (as it is with refreshes), and it
will be the only valid temporary GRUU for the instance until the next
refresh, at which point a second one becomes valid too. Consequently,
temporary GRUUs "accumulate" during the lifetime of a registration.

</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Using a GRUU</h3>

<p>
Once a user agent obtains GRUUs from the registrar, it uses
them in several ways. First, it uses them as the contents of the
Contact header field in non-REGISTER requests and responses that it
emits (for example, an INVITE request and 200 OK response). According
to RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, the Contact header field is supposed to 
contain a URI that routes to that user agent. Prior to this
specification, there hasn't been a way to really meet that
requirement. The user agent would use one of its temporary GRUUs for
anonymous calls, and use its public GRUU otherwise.

</p>
<p>
Second, the UA can use the GRUU in any other place it needs to
use a URI that resolves to itself, such as a webpage.

</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
Dereferencing a GRUU</h3>

<p>Because a GRUU is simply a URI, a UA dereferences it in exactly
the same way as it would any other URI. However, once the request
has been routed to the appropriate proxy, the behavior is slightly
different. The proxy will map the GRUU to the AOR and determine the
set of contacts that the particular UA instance has registered. The
GRUU is then mapped to those contacts, and the request is routed
towards the UA.

</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
User Agent Behavior</h3>

<p>
This section defines the normative behavior for user agents.

</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Generating a REGISTER Request</h3>

<p>
When a UA compliant to this specification generates a REGISTER request
(initial or refresh), it MUST include the Supported header field in
the request. The value of that header field MUST include "gruu" as one
of the option tags. This alerts the registrar for the domain that the
UA supports the GRUU mechanism.

</p>
<p>Furthermore, for each contact for which the UA desires to obtain a
GRUU, the UA MUST include a "sip.instance" media feature tag (see
draft-ietf-sip-outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>) as a
UA characteristic (see <a class='info' href='#RFC3840'>[RFC3840]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Indicating User Agent Capabilities in the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a>), whose value MUST be
the instance ID that 
identifies the UA instance being registered. Each such Contact header
field SHOULD NOT contain a "pub-gruu" or "temp-gruu" header field. The
contact URI MUST NOT be equivalent, based on the URI equality rules in
RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, to the AOR in the To header field. If the contact URI is a
GRUU, it MUST NOT be a GRUU for the AOR in the To header field.

</p>
<p>
As in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, the Call-ID in a REGISTER
refresh SHOULD be identical 
to the Call-ID used to previously register a contact. With GRUU, an
additional consideration applies. If the Call-ID changes in a register
refresh, the server will invalidate all temp-gruu associated with that
UA instance; the only valid one will be the new one returned in that
REGISTER response. Consequently, if a UA wishes its previously obtained
temporary GRUUs to remain valid, it MUST utilize the same Call-ID in
REGISTER refreshes. However, it MAY change the Call-ID in a refresh if
invalidation is the desired objective.

</p>
<p>Note that, if any dialogs are in progress
that utilize a temporary GRUU as a remote target, and a UA performs a
registration refresh with a change in Call-ID, those temporary GRUU
become invalid, and the UA will not be reachable for subsequent
mid-dialog messages. 

</p>
<p>
If a UA instance is trying to register multiple contacts for the same
instance for the purposes of redundancy, it MUST use the procedures
defined in draft-ietf-sip-outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>.  

</p>
<p></p>
<blockquote class="text">
<p>
A UA utilizing GRUUs can still perform third party registrations and
can include contacts which omit the "+sip.instance" Contact header
field parameter.

</p>
</blockquote>

<p>
If a UA wishes to guarantee that the REGISTER request is not processed unless
the domain supports and uses this extension, it MAY include a Require
header field in the request with a value that contains the "gruu"
option tag. This is in addition to the presence of the Supported
header field also containing the "gruu" option tag. The use of
Proxy-Require is not necessary and is NOT RECOMMENDED.

</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Learning GRUUs from REGISTER Responses</h3>

<p> If the REGISTER response is a 2xx, each Contact header field that
contains the "+sip.instance" Contact header field parameter can also
contain a "pub-gruu" and "temp-gruu" Contact header field
parameter. These header field parameters convey the public and a
temporary GRUU for 
the UA instance, respectively. A UA MUST be prepared for a Contact
header field to contain just a "pub-gruu", just a "temp-gruu",
neither, or both. The temporary GRUU will be valid for the duration of
the registration (that is, through refreshes) , while the public GRUU
persists across registrations. The UA will receive a new temporary
GRUU in each successful REGISTER response, while the public GRUU will
typically be the same. However, a UA MUST be prepared for the public
GRUU to change from a previous one, since the persistence property is
not guaranteed with complete certainty. If a UA changed its Call-ID in
this REGISTER request compared to a previous REGISTER request for the
same contact, the UA MUST discard all temporary GRUU learned through
prior REGISTER responses. A UA MAY retain zero, one, some, or all of
the temporary GRUUs that it is provided during the time over which its
contact remains registered. If a UA stores any temporary GRUUs for use
during its registration, it needs to be certain that the registration
does not accidentally lapse due to clock skew between the UA and
registrar. Consequently, the UA MUST refresh its registration such
that the REGISTER refresh transaction will either complete or timeout
prior to the expiration of the registration. For default transaction
timers, this would be at least 32 seconds prior to expiration, assuming the
registration expiration is larger than 64 seconds. If the registration
expiration is less than 64 seconds, the UA SHOULD refresh its
registration halfway prior to expiration. 

</p>
<p>In cases where registrars forcefully shorten
registration intervals, the registration event package, RFC 3860 <a class='info' href='#RFC3680'>[RFC3680]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a> is used by user agents to learn of these changes. A
user agent implementing both RFC 3680 <a class='info' href='#RFC3680'>[RFC3680]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a> and
GRUU MUST also implement the 
extensions to RFC 3680 <a class='info' href='#RFC3680'>[RFC3680]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a> for conveying
information on GRUU, as defined in draft-ietf-sipping-reg-event <a class='info' href='#I-D.ietf-sipping-gruu-reg-event'>[I&#8209;D.ietf&#8209;sipping&#8209;gruu&#8209;reg&#8209;event]<span> (</span><span class='info'>Kyzivat, P., &ldquo;Registration Event Package Extension for Session Initiation Protocol (SIP)  Globally Routable User Agent URIs (GRUUs),&rdquo; July&nbsp;2007.</span><span>)</span></a>, as these are necessary to
keep the set of temporary GRUU synchronized between the UA and the
registrar. More generally, the utility of temporary GRUU depends on
the UA and registrar being in sync on the set of valid temporary GRUU
at any time. Without support of RFC 3680 <a class='info' href='#RFC3680'>[RFC3680]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a> and
its extension for GRUU, 
the client will remain in sync only as long as it always re-registers
well before the registration expiration. Besides forceful
de-registrations, other events, such as network outages, connection
failures, and short refresh intervals, can lead to potential
inconsistencies about the set of valid temporary GRUU. For this
reason, it is RECOMMENDED that a UA that utilizes temporary GRUU
implement RFC 3680 <a class='info' href='#RFC3680'>[RFC3680]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a> and
draft-ietf-sipping-gruu-reg-event <a class='info' href='#I-D.ietf-sipping-gruu-reg-event'>[I&#8209;D.ietf&#8209;sipping&#8209;gruu&#8209;reg&#8209;event]<span> (</span><span class='info'>Kyzivat, P., &ldquo;Registration Event Package Extension for Session Initiation Protocol (SIP)  Globally Routable User Agent URIs (GRUUs),&rdquo; July&nbsp;2007.</span><span>)</span></a>. 

</p>
<p>
A non-2xx response to the REGISTER request has no impact on any
existing GRUUs previously provided to the UA. Specifically, if a
previously successful REGISTER request provided the UA with a GRUU, a
subsequent failed request does not remove, delete, or otherwise
invalidate the GRUU.

</p>
<p>
The user and host parts of the GRUU learned by the UA in the REGISTER response
MUST be treated opaquely by the UA. That is, the UA MUST NOT modify them
in any way. A UA MUST NOT modify or remove URI parameters it does not
recognize. Furthermore, the UA MUST NOT add, remove or modify URI parameters
relevant for receipt and processing of request at the proxy, including
the transport, lr, maddr, ttl, user, and comp (see RFC 3486 <a class='info' href='#RFC3486'>[RFC3486]<span> (</span><span class='info'>Camarillo, G., &ldquo;Compressing the Session Initiation Protocol (SIP),&rdquo; February&nbsp;2003.</span><span>)</span></a>) 
URI parameters.  The other URI parameter defined in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> - method, would 
not typically be present in a GRUU delivered from a registrar, and a
UA MAY add a method URI parameter to the GRUU before handing it out to
another entity. Similarly, the URI parameters defined in RFC 4240 <a class='info' href='#RFC4240'>[RFC4240]<span> (</span><span class='info'>Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;Basic Network Media Services with SIP,&rdquo; December&nbsp;2005.</span><span>)</span></a> and RFC 4458 <a class='info' href='#RFC4458'>[RFC4458]<span> (</span><span class='info'>Jennings, C., Audet, F., and J. Elwell, &ldquo;Session Initiation Protocol (SIP) URIs for Applications such as Voicemail and Interactive Voice Response (IVR),&rdquo; April&nbsp;2006.</span><span>)</span></a> are meant for
consumption by the UA. These would not be included in the GRUU
returned by a registrar and MAY be added by a UA wishing to provide
services associated with those URI parameters. 

</p>
<p>Note, however, that should
another UA dereference the GRUU, the parameters will be lost at the
proxy when the Request-URI is translated into the registered contact,
unless some other means is provided for the attributes to be delivered
to the UA. Mechanisms for such delivery are currently the subject of
future standardization activity (see
draft-rosenberg-sip-ua-loose-route <a class='info' href='#I-D.rosenberg-sip-ua-loose-route'>[I&#8209;D.rosenberg&#8209;sip&#8209;ua&#8209;loose&#8209;route]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Applying Loose Routing to Session Initiation Protocol (SIP) User Agents  (UA),&rdquo; January&nbsp;2008.</span><span>)</span></a>). 

</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Constructing a Self-Made GRUU</h3>

<p>Many user agents, such as gateways to the Public Switched Telephone
Network (PSTN), conferencing servers and media servers, do not perform
registrations, and cannot obtain GRUUs through that mechanism. These
types of user agents can be publicly reachable. This would mean that
the policy of the domain is that requests can come from anywhere on
the public Internet and be delivered to the user agent without
requiring processing by intervening proxies within the
domain. Furthermore, firewall and NAT policies administered by the
domain would allow such requests into the network. When a user agent
is certain that these conditions are met, a UA MAY construct a
self-made GRUU. Of course, a user agent which does REGISTER, but for
whom these conditions are met regardless, MAY also construct a
self-made GRUU. However, usage of GRUUs obtained by the registrar is
RECOMMENDED instead. 

</p>
<p>
A self-made GRUU is one whose domain part equals the IP address or
hostname of the user agent. The user part of the SIP URI is chosen
arbitrarily by the user agent. Like all other GRUUs, the URI MUST
contain the "gr" URI parameter, with or without a value, indicating it
is a GRUU. 

</p>
<p>
If a user agent does not register, but it is not publicly reachable,
it would need to obtain a GRUU through some other means. Typically,
the UA would be configured with a GRUU, and the GRUU would also be
configured into the proxy which will receive requests targeted to the
GRUU, along with a static mapping to the IP address and port of the
UA.

</p>
<a name="sec-sendto"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Using Ones Own GRUUs</h3>

<p>A UA SHOULD use a GRUU when populating the Contact header field of
dialog-forming and target refresh requests and responses. In other
words, a UA compliant to this specification SHOULD use one of its
GRUUs as its remote target. This includes the INVITE request, its 2xx
response or 18x response with a To tag, the SUBSCRIBE request (see
<a class='info' href='#RFC3265'>[RFC3265]<span> (</span><span class='info'>Roach, A., &ldquo;Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a>), its 2xx response with a To tag, the NOTIFY
request, the REFER request (see <a class='info' href='#RFC3515'>[RFC3515]<span> (</span><span class='info'>Sparks, R., &ldquo;The Session Initiation Protocol (SIP) Refer Method,&rdquo; April&nbsp;2003.</span><span>)</span></a>), its 2xx
response, and the UPDATE request and its 2xx response. The only reason
not to use a GRUU would be privacy considerations; see <a class='info' href='#sec-privacy'>Section&nbsp;10.3<span> (</span><span class='info'>Privacy Considerations</span><span>)</span></a>.

</p>
<p>
When using a GRUU obtained through registrations, a UA MUST have an
active registration prior to using a GRUU, and MUST use a GRUU learned
through that registration. It MUST NOT reuse a GRUU learned through a
previous registration which has lapsed (in other words, one obtained
when registering a contact which has expired). The UA MAY use either
the public or one of its temporary GRUUs provided by its registrar. A
UA MUST NOT use a temporary GRUU learned in a REGISTER response whose
Call-ID differs from the one in the most recent REGISTER request
generated by the UA for the same AOR and instance ID.  When
a UA wishes to construct an anonymous request as described in RFC 3323
<a class='info' href='#RFC3323'>[RFC3323]<span> (</span><span class='info'>Peterson, J., &ldquo;A Privacy Mechanism for the Session Initiation Protocol (SIP),&rdquo; November&nbsp;2002.</span><span>)</span></a>, it SHOULD use a temporary GRUU. See <a class='info' href='#sec-privacy'>Section&nbsp;10.3<span> (</span><span class='info'>Privacy Considerations</span><span>)</span></a> for a more complete discussion on the level of
privacy afforded by temporary GRUUs.

</p>
<p>
As per RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, a UA SHOULD include a
Supported header with the 
option tag "gruu" in requests and responses it generates.

</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4.1"></a><h3>4.4.1.&nbsp;
Considerations for Multiple AORs</h3>

<p>
In some SIP networks, a user agent can have a multiplicity of AOR,
either in different domains, or within the same domain. In such cases,
additional considerations apply.

</p>
<p>
When a UA sends a request, the request will be sent 'using' one of its
AOR. This AOR will typically show up in the From header field of the
request, and credentials unique to that AOR will be used to
authenticate the request. The GRUU placed into the Contact header
field of such a request SHOULD be one that is associated with the AOR
used to send the request. In cases where the UA uses a tel URI (as
defiend in <a class='info' href='#RFC3966'>[RFC3966]<span> (</span><span class='info'>Schulzrinne, H., &ldquo;The tel URI for Telephone Numbers,&rdquo; December&nbsp;2004.</span><span>)</span></a>) to
populate the From header field, the UA typically has a SIP AOR that is
treated as an alias for the tel URI. The GRUU associated with that SIP
AOR SHOULD be  used in the Contact header field.

</p>
<p>
When a UA receives a request, the GRUU placed into the Contact header
field of a 2xx response SHOULD be the one associated with the AOR or
GRUU to which the request was most recently targeted. There are
several ways to determine the AOR or GRUU to which a request was
sent. For example, if a UA registered a different contact to each AOR
(by using a different user part of the URI), the Request-URI (which
contains that contact) will indicate the AOR.

</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Dereferencing a GRUU</h3>

<p>A GRUU is identified by the presence of the "gr" URI parameter, and
this URI parameter might or might not have a value. A
UA that wishes to send a request to a URI that contains a GRUU knows
that the request will be delivered to a specific UA instance without
further action on the part of the requestor.

</p>
<p>Some UAs implement non-standard mechanisms for handling
URIs that compensate for the fact that heretofore many
contact URIs have not been globally routable.  Since
any URI containing the "gr" URI parameter is known to be
globally routable, a UA SHOULD NOT apply such
mechanisms when contact URI contain the "gr" URI parameter. 

</p>
<p></p>
<blockquote class="text">
<p>Because the instance ID is a callee
capabilities parameter, a UA might be tempted to send a request to the
AOR of a user, and include an Accept-Contact header field (defined in
<a class='info' href='#RFC3841'>[RFC3841]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Caller Preferences for the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a>) that indicates a preference for routing the
request to a UA with a specific instance ID. Although this would
appear to have the same effect as sending a request to the GRUU, it
does not. The caller preferences expressed in the Accept-Contact
header field are just preferences. Their efficacy depends on a UA
constructing an Accept-Contact header field that interacts with
domain-processing logic for an AOR, to cause a request to route to a
particular instance. Given the variability in routing logic in a
domain (for example, time-based routing to only selected contacts),
this doesn't work for many domain-routing policies. However, this
specification does not forbid a client from attempting such a request,
as there can be cases where the desired operation truly is a
preferential routing request.  
</p>
</blockquote>

<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
Rendering GRUUs on a User Interface</h3>

<p>
When rendering a GRUU to a user through a user interface, it is
RECOMMENDED that the "gr" URI parameter be removed. For public GRUUs, this
will produce the AOR, as desired. For temporary GRUUs, the resulting
URI will be seemingly random. Future work might provide improved
mechanisms that would allow an automaton to know that a URI is
anonymized and therefore inappropriate to render.

</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Registrar Behavior</h3>

<a name="sec-regprocess"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Processing a REGISTER Request</h3>

<p>
A REGISTER request might contain a Require header field with the
"gruu" option tag; this indicates that the registrar has to
understand this extension in order to process the request. It does not
require the registrar to create GRUUs, however.

</p>
<p> As the registrar is processing the contacts in the REGISTER
request according to the procedures of step 7 in Section 10.3 of RFC
3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, the registrar checks whether each Contact header field in the
REGISTER message contains a "+sip.instance" header field parameter. If
present with a non-zero expiration, the contact is processed further
based on the rules in the remainder of this section. Otherwise, the
contact is processed based on normal RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> rules.

</p>
<p></p>
<blockquote class="text">
<p> Note that handling of a REGISTER request
containing a Contact header field with value "*" and an expiration of
0 still retains the meaning defined in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> -- all contacts, not
just those with a specific instance ID, are deleted. As described in
<a class='info' href='#sec-creation'>Section&nbsp;5.4<span> (</span><span class='info'>Creation of a GRUU</span><span>)</span></a>, this removes the
binding of each contact to the AOR and the binding of each contact to
its GRUUs.

</p>
</blockquote>

<p> If the contact URI is
equivalent (based on URI equivalence in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>) to the AOR, the
registrar MUST reject the request with a 403, since this would cause a
routing loop. If the contact URI is a GRUU for the AOR in the To
header field of the REGISTER request, the registrar MUST reject the
request with a 403, for the same reason. If the contact is not a SIP
URI, the REGISTER request MUST be rejected with a 403.

</p>
<p>Next, the registrar checks if there is already a valid public GRUU
for the AOR (present in the To header field of the REGISTER request)
and the instance ID (present as the content of the "+sip.instance"
Contact header field parameter). If there is no valid public GRUU, the
registrar SHOULD construct a public GRUU at this time according to the
procedures of <a class='info' href='#sec-creation'>Section&nbsp;5.4<span> (</span><span class='info'>Creation of a GRUU</span><span>)</span></a>. The public GRUU MUST be
constructed by adding the "gr" URI parameter, with a value, to the AOR. If the
contact contained a "pub-gruu" Contact header field parameter, the
header field parameter MUST be ignored by the registrar. A UA cannot
suggest or otherwise provide a public GRUU to the registrar.

</p>
<p>
Next, the registrar checks for any existing contacts registered to the
AOR and instance ID. If there is at least one, the registrar finds the
one that was most recently registered, and examines the Call-ID value 
associated with that registered contact. If it differs from the one in
the REGISTER request, the registrar MUST invalidate all previously
generated temporary GRUU for the AOR and instance ID. A consequence of this
invalidation is that requests addressed to those GRUU will be rejected by
the domain with a 404 from this point forward. 

</p>
<p>
Next, the registrar SHOULD create a new temporary GRUU for the AOR and
instance ID with the characteristics described in  <a class='info' href='#sec-creation'>Section&nbsp;5.4<span> (</span><span class='info'>Creation of a GRUU</span><span>)</span></a>. The temporary GRUU construction algorithm
MUST have the following two properties:

</p>
<p></p>
<ol class="text">
<li>The likelihood that the temporary GRUU is equal to another GRUU
which the registrar has created MUST be vanishingly small.

</li>
<li>Given a pair of GRUUs, it MUST be computationally infeasible to determine
whether they were issued for the same AOR or instance ID or
different AORs and instance IDs.

</li>
</ol>

<p>If the contact contained
a "temp-gruu" Contact header field parameter, the header field
parameter MUST be ignored by 
the registrar. A UA cannot suggest or otherwise provide a temporary GRUU
to the registrar. 

</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Generating a REGISTER Response</h3>

<p> When generating the 200 (OK) response to the REGISTER request, the
procedures of step 8 of Section 10.3 of RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> are
followed. Furthermore, for each Contact header field value placed in
the response, if the registrar has stored an instance ID associated
with that contact, that instance ID is returned as a Contact header
field parameter. If the REGISTER request contained a Supported header
field that included the "gruu" option tag, and the registrar has at least
one temporary GRUU assigned to the instance ID and AOR, the registrar
MUST add an 
"temp-gruu" Contact header field parameter to that Contact header
field. The value of the "temp-gruu" parameter is a quoted string, and
MUST contain the mostly recently created temporary GRUU for that AOR
and instance ID. In addition, if the registrar has a
public GRUU assigned to the instance ID and AOR (and the client
supports GRUUs), the registrar MUST add a "pub-gruu" Contact header field
parameter to that Contact header field. The value of the "pub-gruu"
Contact header field parameter is the public GRUU.
</p>
<p>
The registrar SHOULD NOT include the "gruu" option tag in the Require
or Supported header field of the response. 

</p>
<a name="sec-reg-time"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Timing Out a Registration</h3>

<p>
When a registered contact expires (either due to timeout or explicit
de-registration), its binding to the AOR is removed
as usual. In addition, its binding to its GRUUs are removed at the same
time as a consequence of the relationships described in <a class='info' href='#sec-creation'>Section&nbsp;5.4<span> (</span><span class='info'>Creation of a GRUU</span><span>)</span></a> 

</p>
<p>
If, as a consequence of the expiration of the contact, a particular
GRUU no longer has any registered contacts bound to it, and the GRUU is a
temporary GRUU, the GRUU MUST be invalidated. This means that all of the
accumulated temporary GRUUs get invalidated once the last contact for a
given instance ID expires. 

</p>
<p>If, however, the GRUU
was a public GRUU, the registrar SHOULD continue to treat the GRUU as
valid. Consequently, subsequent requests targeted to the GRUU, prior
to re-registration of a contact to the GRUU, SHOULD return a 480
(Temporarily Unavailable) response. In
addition, since the GRUU remains valid, the rules in <a class='info' href='#sec-regprocess'>Section&nbsp;5.1<span> (</span><span class='info'>Processing a REGISTER Request</span><span>)</span></a> will cause it to be retained when a contact
with that instance ID is once again registered to the AOR.

</p>
<p></p>
<blockquote class="text">
<p> These rules give a public GRUU a
semi-permanent property.  The intent is that the registrar make every
attempt to retain validity of the GRUU for as long as the AOR itself
is known within the domain. The requirements for doing so are at
SHOULD strength and not MUST strength because of the difficulty in
meeting a MUST strength requirement; registrar failures could cause the
set of valid GRUUs to be lost and this specification requires the UA to
be robust against such cases. That said, it is possible for a public GRUU to
be constructed such that a registrar does not need to retain any
additional state for it, yet the GRUU still meets the requirements
described here. 

</p>
</blockquote>

<a name="sec-creation"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
Creation of a GRUU</h3>

<p>
This section defines additional behaviors associated with the
construction and maintenance of a GRUU which are specific to a
registrar. These rules do not apply to self-made GRUU or GRUU not
obtained through registrations. 

</p>
<p>
When a registrar creates a GRUU, it is required to maintain certain
information associated with the GRUU, regardless of whether it is a
public or temporary GRUU. Every GRUU is associated with a single AOR
and a single instance ID. A registrar MUST be able to determine the
instance ID and AOR when presented with a GRUU. In addition, the GRUU,
like an AOR, resolves to zero or more contacts. While the AOR resolves
to all registered contacts for an AOR, a GRUU resolves only to those
contacts whose instance ID matches the one associated with the
GRUU. For this reason, a contact with an instance ID is always bound
to both a GRUU and its AOR, never just an AOR or just a GRUU. This is
shown pictorially in <a class='info' href='#fig-gruu-model'>Figure&nbsp;1</a>. The figure shows
three contacts registered to a single AOR. One of the contacts has an
instance ID of 1, and the other two have an instance ID of 2. There
are two GRUUs for this AOR. One is associated with instance ID 1, and
the other with instance ID 2. The first GRUU resolves only to contacts
whose instance ID is one, and the second resolves only to contacts
whose instance ID is two. There will typically be multiple contacts
for a given instance ID if a UA has crashed, rebooted and
re-registered with the same instance ID, or is using the mechanisms of
draft-ietf-sip-outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a> to have multiple registrations
for redundancy. If the contact for instance ID 1 expires, the AOR
would resolve to two contacts, but the GRUU associated 
with instance ID 1 would resolve to zero.

</p><br /><hr class="insert" />
<a name="fig-gruu-model"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>


       +----------+   +----------+  +----------+
       |  GRUU    |   |          |  |  GRUU    |
       |          |   |   AOR    |  |          |
       |Instance:1|   |          |  |Instance:2|
       +----------+   +----------+  +----------+
            |           /  |  \           / |
            |          /   |   \         /  |
            |         /    |    \       /   |
            |        /     |     \     /    |
            |       /      |      \   /     |
            |      /       |       \ /      |
            |     /        |        X       |
            |    /         |       / \      |
            |   /          |      /   \     |
            |  /           |     /     \    |
            V V            V    V       V   V
       +----------+   +----------+  +----------+
       | Contact  |   | Contact  |  | Contact  |
       |          |   |          |  |          |
       |Instance:1|   |Instance:2|  |Instance:2|
       +----------+   +----------+  +----------+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
There can be multiple GRUUs with the same instance ID and
AOR. Indeed, this specification requires registrars to maintain many -
one that is public, and several that are temporary. However, if two GRUUs
are associated with different AOR or different instance IDs or both,
the GRUUs MUST be different based on URI equality comparison. A GRUU in
a domain MUST NOT be equivalent, based on URI comparison, to any AOR
in a domain except for the one associated with the GRUU. 

</p>
<p></p>
<blockquote class="text">
<p>
A public GRUU will always be equivalent to the AOR based on URI
equality rules. The reason is that the rules in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> cause URI
parameters that are in one URI, but not in the other, to be ignored
for equality purposes. Since a public GRUU differs from an AOR only by
the presence of the "gr" URI parameter, the two URI are equivalent
based on those rules.

</p>
</blockquote>

<p>
Once a temporary GRUU is constructed, it MUST be considered valid by
the registrar until invalidated based on the rules described
previously. Once a public GRUU is constructed, it MUST be
considered valid for the duration that the AOR itself is valid. Once
an AOR is no longer valid within a domain, any of its GRUU MUST be
considered invalid as well.

</p>
<p>This specification does not mandate a particular
mechanism for construction of the GRUU. Example algorithms for public
and temporary GRUU that work well are given in <a class='info' href='#sec-app'>Appendix&nbsp;A<span> (</span><span class='info'>Example GRUU Construction Algorithms</span><span>)</span></a>. However, 
in addition to the properties described in <a class='info' href='#sec-structure'>Section&nbsp;3.1<span> (</span><span class='info'>Structure of GRUUs</span><span>)</span></a>, a GRUU constructed by a registrar MUST
exhibit the following properties: 

</p>
<p></p>
<ul class="text">
<li>The domain part of the URI is an IP address present on the public
Internet, or, if it is a host name, the resolution procedures of RFC
3263 <a class='info' href='#RFC3263'>[RFC3263]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a>, once applied, result in an IP address
on the public Internet. 
</li>
<li>When a request is sent to the GRUU, it routes to a
proxy that can access the registration data generated by the
registrar. Such a proxy is called a authoritative proxy, defined in
draft-ietf-sip-outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>.

</li>
</ul>

<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.5"></a><h3>5.5.&nbsp;
Registration Event Support</h3>

<p>
RFC 3680 <a class='info' href='#RFC3680'>[RFC3680]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a> defines an event package that allows
a client to learn about registration events at the registrar. This
package allows registrars to alter registrations forcefully (for
example, shortening them to force a re-registration). If a registrar is
supporting RFC 3680 <a class='info' href='#RFC3680'>[RFC3680]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a> and GRUU, it MUST also
support draft-ietf-sipping-gruu-reg-event <a class='info' href='#I-D.ietf-sipping-gruu-reg-event'>[I&#8209;D.ietf&#8209;sipping&#8209;gruu&#8209;reg&#8209;event]<span> (</span><span class='info'>Kyzivat, P., &ldquo;Registration Event Package Extension for Session Initiation Protocol (SIP)  Globally Routable User Agent URIs (GRUUs),&rdquo; July&nbsp;2007.</span><span>)</span></a>.

</p>
<a name="sec-proxy"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Proxy Behavior</h3>

<p>
Proxy behavior is fully defined in Section 16 of RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. GRUU processing impacts that processing in two
places -- request targeting at the authoritative proxy and record routing.

</p>
<a name="sec-proxy-main"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Request Targeting</h3>

<p> When a proxy receives a request, owns the domain in the
Request-URI, and is supposed to access a Location Service in order to
compute request targets (as specified in Section 16.5 of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [RFC3261]), the proxy examines the
Request-URI. If it contains the "gr" URI parameter but is not
equivalent, based on URI comparison, to a currently valid GRUU within
the domain, it SHOULD be rejected with a 404 (Not Found) response;
this is the same 
behavior a proxy would exhibit for any other URI within the domain
that is not valid.

</p>
<p>
If the Request-URI contains a the "gr" URI parameter and is
equivalent, based on URI comparison, to a GRUU which is currently
valid within the domain, processing proceeds as it would for any other
URI present in the location service, as defined in Section 16.5 of RFC
3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, except that the "gr" URI parameter is
not removed as part of the 
canonicalization process. This is the case for both out-of-dialog
requests targeted to the GRUU, and mid-dialog requests targeted to the
GRUU (in which case the incoming request would have a Route header
field value containing the URI that the proxy Record-Routed
with).
</p>
<p>Note that the "gr" URI parameter is retained just for the purposes
of finding the GRUU in the location service; If a match is found, the
Request-URI will be rewritten with the registered contacts, replacing
the GRUU and its "gr" URI parameter. The "gr" URI parameter is not carried
forward into the rewritten Request-URI.

</p>
<p>
If there are no registered contacts bound to the GRUU, the server MUST
return a 480 (Temporarily Unavailable) response. If there are more
than one, there are two cases:

</p>
<ol class="text">
<li>The client is using draft-ietf-sip-outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a> and registering multiple contacts for
redundancy. In that case, these contacts contain reg-id Contact header
field parameters, and the rules
described in Section 7 of draft-ietf-sip-outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a> for selecting a 
single registered contact apply. 
</li>
<li>The client was not using SIP outbound, in which case there would
only be multiple contacts with the same instance ID if the client had
rebooted, restarted and re-registered. In this case, these contacts
would not contain the reg-id Contact header field parameter. The proxy
MUST select the most recently refreshed contact. As with
draft-ietf-sip-outbound, if a request to this target fails with a 408
(Request Timeout) or 430 (Flow Failed) response, the proxy SHOULD
retry with the next most recently refreshed contact. Furthermore, if
the request fails with any other response, the proxy MUST NOT retry on
any other contacts for this instance.

</li>
</ol><p>
Any caller preferences in the request
(as defined in RFC 3841 <a class='info' href='#RFC3841'>[RFC3841]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Caller Preferences for the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a>) SHOULD be processed
against the contacts bound to the GRUU. 

</p>
<p>
In essence, to select a registered contact, the GRUU is processed just
like it was the AOR, but with only a subset of the contacts bound to
the AOR.
</p>
<p>
Special considerations apply to processing of any Path headers stored
in the registration (see RFC 3327 <a class='info' href='#RFC3327'>[RFC3327]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>). If the
received request has Route header field values beyond the one pointing
to the authoritative proxy itself (this will happen when the request
is a mid-dialog request), the Path URI MUST be discarded. This is
permitted by RFC 3327 <a class='info' href='#RFC3327'>[RFC3327]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a> as a matter of local
policy; usage of GRUUs will 
require this policy in order to avoid call spirals and likely call
failures.

</p>
<p>
A proxy MAY apply other processing to the request, such as execution
of called party features, as it might do for requests targeted to an
AOR. For requests that are outside of a dialog, it is RECOMMENDED to
apply screening types of functions, both automated (such as black and
white list screening) and interactive (such as interactive voice
response (IVR) applications that confer with the user to determine
whether to accept a call). In many cases, the new request is related
to an existing dialog, and might be an attempt to join it (using the
Join header field defined in RFC 3911 <a class='info' href='#RFC3911'>[RFC3911]<span> (</span><span class='info'>Mahy, R. and D. Petrie, &ldquo;The Session Initiation Protocol (SIP) &quot;Join&quot; Header,&rdquo; October&nbsp;2004.</span><span>)</span></a>) or
replace it (using the 
Replaces header field defined in RFC 3891 <a class='info' href='#RFC3891'>[RFC3891]<span> (</span><span class='info'>Mahy, R., Biggs, B., and R. Dean, &ldquo;The Session Initiation Protocol (SIP) &quot;Replaces&quot; Header,&rdquo; September&nbsp;2004.</span><span>)</span></a>). In such cases, the UA 
will typically make its own authorization decisions. In such cases,
bypassing screening services might make sense, but it needs to be
carefully considered by network designers, as it depends on the
specific type of screening service. 

</p>
<p>However, forwarding services, such as call forwarding, SHOULD NOT
be provided for requests sent to a GRUU. The intent of the GRUU is to
target a specific UA instance, and this is incompatible with
forwarding operations.

</p>
<p> If the request is a mid-dialog request, a proxy SHOULD only
apply services that are meaningful for mid-dialog requests, generally
speaking. This excludes screening functions, as well as forwarding
ones. 

</p>
<p>
In addition, a request sent to a GRUU SHOULD NOT be redirected. In
many instances, a GRUU is used by a UA in order to assist in the
traversal of NATs and firewalls, and a redirection might prevent such a
case from working.  
</p>
<a name="sec-rr"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Record-Routing</h3>

<p>
There are two distinct requirements for record-routing
- in the originating domain and in the terminating
domain. These requirements avoid unnecessary and possibly problematic
spirals of requests.

</p>
<p>
If:
</p>
<ul class="text">
<li>an originating authoritative proxy receives a dialog-forming
request,
</li>
<li>AND the Contact header field contains a GRUU in the domain of the
proxy,
</li>
<li>AND that GRUU is a valid one in the domain of the proxy, 
</li>
<li>AND that GRUU is associated with the AOR matching the authenticated
identity of the requestor (assuming such authentication has been
performed),
</li>
<li>AND the request contains Record-Route header fields,
</li>
</ul><p>
then the authoritative proxy MUST record route. If all of these
conditions is true, except that the GRUU is associated with an AOR
which did not match the authenticated identity of the requestor, it is
RECOMMENDED that the proxy reject the request with a 403 (Forbidden)
response.

</p>
<p>
If:
</p>
<ul class="text">
<li>a terminating authoritative proxy receives a dialog-forming
request,
</li>
<li> AND the Request-URI contains a URI in the location service (either a GRUU or
an AOR), 
</li>
<li> AND the contact selected for sending the request has an
instance ID and is bound to a GRUU, 
</li>
<li> AND the registration contain Path URI, 
</li>
</ul><p>then the authoritative proxy MUST record route.

</p>
<p>
If a proxy in either the originating or terminating domains but is
not an authoritative proxy, the proxy MAY record route. 

</p>
<p>If a proxy in the terminating domain requires mid-dialog requests
to pass through it for whatever reason (firewall traversal,
accounting, etc.), the proxy MUST still record route, and MUST NOT
assume that a UA will utilize its GRUU in the Contact header field of
its response (which would cause mid-dialog requests to pass through
the proxy without record-routing).

</p>
<p></p>
<blockquote class="text">
<p>
Implementors should note that, if a UA uses a GRUU in its contact, and
a proxy inserted itself into the Path header field of a
registration, that proxy will be receiving mid-dialog requests
regardless of whether it record routes or not. The only distinction is
what URI the proxy will see in the topmost Route header field of
mid-dialog requests. If the proxy record-routes, it will see that
URI. If it does not, it will see the Path URI it inserted.

</p>
</blockquote>

<a name="sec-grammar"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Grammar</h3>

<p> This specification defines two new Contact header field parameters
("temp-gruu" and "pub-gruu") by extending the grammar for
"contact-params" as defined in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. It also defines a new SIP
URI parameter ("gr") by extending the grammar
for "uri-parameter" as defined in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

contact-params  =/ temp-gruu / pub-gruu
temp-gruu       =  "temp-gruu" EQUAL LDQUOT *(qdtext / quoted-pair )
                   RDQUOT
pub-gruu        =  "pub-gruu" EQUAL LDQUOT *(qdtext / quoted-pair )
                   RDQUOT

uri-parameter   =/ gr-param
gr-param        = "gr" ["=" pvalue]   ; defined in RFC3261
</pre></div>
<p>
The quoted strings for temp-gruu and pub-gruu MUST contain a 
SIP URI. However, they are encoded like all other quoted strings and
can therefore contain quoted-pair escapes when represented this way. 

</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Requirements</h3>

<p>
This specification was created in order to meet the following
requirements:

</p>
<p></p>
<blockquote class="text"><dl>
<dt>REQ 1:</dt>
<dd> When a UA invokes a GRUU, it must cause the
request to be routed to the specific UA instance to which the GRUU
refers.

</dd>
<dt>REQ 2:</dt>
<dd> It must be possible for a GRUU to be invoked from
anywhere on the Internet, and still cause the request to be routed
appropriately. That is, a GRUU must not be restricted to use within a
specific addressing realm. 

</dd>
<dt>REQ 3:</dt>
<dd> It must be possible for a GRUU to be constructed
without requiring the network to store additional state.

</dd>
<dt>REQ 4:</dt>
<dd> It must be possible for a UA to obtain a
multiplicity of GRUUs that each route to that UA
instance.  For example, this is needed to support ad-hoc conferencing
where a UA instance needs a different URI for each conference it is
hosting.  NOTE: This requirement is not met by this specification, and
is being addressed in a separate specification.

</dd>
<dt>REQ 5:</dt>
<dd> When a UA receives a request sent to a GRUU, it
must be possible for the UA to know the GRUU that was used to invoke
the request. This is necessary as a consequence of REQ 4. NOTE: This
requirement is not met by this specification, and is being addressed
in a separate specification. 

</dd>
<dt>REQ 6:</dt>
<dd> It must be possible for a UA to add opaque content
to a GRUU.  This content is not interpreted or altered by the network, and
is used only by the UA instance to whom the GRUU refers. This provides a
basic cookie type of functionality, allowing a UA to build a GRUU with
the state embedded. NOTE: This requirement is not met by this specification, and
is being addressed in a separate specification. 

</dd>
<dt>REQ 7:</dt>
<dd> It must be possible for a proxy to execute
services and features on behalf of a UA instance represented by a
GRUU. As an example, if a user has call blocking features, a proxy might
want to apply those call blocking features to calls made to the GRUU,
in addition to calls made to the user's AOR.

</dd>
<dt>REQ 8:</dt>
<dd> It must be possible for a UA in a dialog to
inform its peer of its GRUU, and for the peer to know that the URI
represents a GRUU. This is needed for the conferencing and dialog
reuse applications of GRUUs, where the URIs are transferred within a
dialog.

</dd>
<dt>REQ 9:</dt>
<dd> When transferring a GRUU per REQ 8, it must be
possible for the UA receiving the GRUU to be assured of its integrity
and authenticity.

</dd>
<dt>REQ 10:</dt>
<dd> It must be possible for a server that is
authoritative for a domain to construct a GRUU which routes to a UA
instance bound to an AOR in that domain. In other words, the proxy can
construct a GRUU, too. This is needed for the presence application.

</dd>
</dl></blockquote>

<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Example Call Flow</h3>

<p>
The following call flow, shown in <a class='info' href='#fig-flowx'>Figure&nbsp;2</a>, shows a
basic registration and call setup, followed by a subscription directed
to the GRUU. It then shows a failure of the callee, followed by a
re-registration. The conventions of RFC 4475 <a class='info' href='#RFC4475'>[RFC4475]<span> (</span><span class='info'>Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg, J., and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP) Torture Test Messages,&rdquo; May&nbsp;2006.</span><span>)</span></a>
are used to describe representation of long message lines.

</p><br /><hr class="insert" />
<a name="fig-flowx"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

    Caller                 Proxy                Callee
    |                     |(1) REGISTER         |
    |                     |&lt;--------------------|
    |                     |(2) 200 OK           |
    |                     |--------------------&gt;|
    |(3) INVITE           |                     |
    |--------------------&gt;|                     |
    |                     |(4) INVITE           |
    |                     |--------------------&gt;|
    |                     |(5) 200 OK           |
    |                     |&lt;--------------------|
    |(6) 200 OK           |                     |
    |&lt;--------------------|                     |
    |(7) ACK              |                     |
    |--------------------&gt;|                     |
    |                     |(8) ACK              |
    |                     |--------------------&gt;|
    |(9) SUBSCRIBE        |                     |
    |--------------------&gt;|                     |
    |                     |(10) SUBSCRIBE       |
    |                     |--------------------&gt;|
    |                     |(11) 200 OK          |
    |                     |&lt;--------------------|
    |(12) 200 OK          |                     |
    |&lt;--------------------|                     |
    |                     |(13) NOTIFY          |
    |                     |&lt;--------------------|
    |(14) NOTIFY          |                     |
    |&lt;--------------------|                     |
    |(15) 200 OK          |                     |
    |--------------------&gt;|                     |
    |                     |(16) 200 OK          |
    |                     |--------------------&gt;|
    |                     |                     |Crashes,
    |                     |(17) REGISTER        | Reboots
    |                     |&lt;--------------------|
    |                     |(18) 200 OK          |
    |                     |--------------------&gt;|

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
The Callee supports the GRUU extension. As such, its REGISTER (1) looks
like:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

   REGISTER sip:example.com SIP/2.0
   Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
   Max-Forwards: 70
   From: Callee &lt;sip:callee@example.com&gt;;tag=a73kszlfl
   Supported: gruu
   To: Callee &lt;sip:callee@example.com&gt;
   Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
   CSeq: 1 REGISTER
   Contact: &lt;sip:callee@192.0.2.1&gt;
    ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
   Content-Length: 0
</pre></div>
<p>
The registrar assigns a temporary and a public GRUU. The REGISTER
response (message 2) would look like: 

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

   SIP/2.0 200 OK
   Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
   From: Callee &lt;sip:callee@example.com&gt;;tag=a73kszlfl
   To: Callee &lt;sip:callee@example.com&gt; ;tag=b88sn
   Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
   CSeq: 1 REGISTER
   &lt;allOneLine&gt;
   Contact: &lt;sip:callee@192.0.2.1&gt;
   ;pub-gruu="sip:callee@example.com
    ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
   ;temp-gruu="sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr"
   ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
   ;expires=3600
   &lt;/allOneLine&gt;
   Content-Length: 0
</pre></div>
<p>
The Contact header field in the REGISTER response contains
the pub-gruu Contact header field parameter with the public GRUU
sip:callee@example.com;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6,
and the 
temp-gruu header field parameter with the temporary GRUU
sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr. Both
are valid GRUUs for the AOR and 
instance ID, and both translate to the contact sip:callee@192.0.2.1. 

</p>
<p> The INVITE from the caller (message 3) is a normal SIP
INVITE. However, the 200 OK generated by the callee (message 5) now
contains a GRUU as the remote target. The UA has chosen to use its
public GRUU.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

   SIP/2.0 200 OK
   Via: SIP/2.0/UDP proxy.example.com;branch=z9hG4bKnaa8
   Via: SIP/2.0/UDP host.example.com;branch=z9hG4bK99a
   From: Caller &lt;sip:caller@example.com&gt;;tag=n88ah
   To: Callee &lt;sip:callee@example.com&gt; ;tag=a0z8
   Call-ID: 1j9FpLxk3uxtma7@host.example.com
   CSeq: 1 INVITE
   Supported: gruu
   Allow: INVITE, OPTIONS, CANCEL, BYE, ACK, SUBSCRIBE
   &lt;allOneLine&gt;
   Contact:
   &lt;sip:callee@example.com
   ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;
   &lt;/allOneLine&gt;
   Content-Length: --
   Content-Type: application/sdp

  [SDP Not shown]
</pre></div>
<p>
At some point later in the call, the caller decides to subscribe to
the dialog event package (defined in <a class='info' href='#RFC4235'>[RFC4235]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and R. Mahy, &ldquo;An INVITE-Initiated Dialog Event Package for the Session Initiation Protocol (SIP),&rdquo; November&nbsp;2005.</span><span>)</span></a>) at that
specific UA. To do that, it generates a SUBSCRIBE request (message 9),
but directs it towards the remote target, which is a GRUU:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  &lt;allOneLine&gt;
   SUBSCRIBE sip:callee@example.com;gr=urn:uuid:f8
   1d4fae-7dec-11d0-a765-00a0c91e6bf6
   SIP/2.0
   &lt;/allOneLine&gt;
   Via: SIP/2.0/UDP host.example.com;branch=z9hG4bK9zz8
   From: Caller &lt;sip:caller@example.com&gt;;tag=kkaz-
   &lt;allOneLine&gt;
   To: &lt;sip:callee@example.com;gr=urn:uuid:f8
   1d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;
   &lt;/allOneLine&gt;
   Call-ID: faif9a@host.example.com
   CSeq: 2 SUBSCRIBE
   Supported: gruu
   Event: dialog
   Allow: INVITE, OPTIONS, CANCEL, BYE, ACK, NOTIFY
   Contact: &lt;sip:caller@example.com;gr=hdg7777ad7aflzig8sf7&gt;
   Content-Length: 0
</pre></div>
<p>
In this example, the caller itself supports the GRUU extension, and is
using its own GRUU to populate its remote target.

</p>
<p>
This request is routed to the proxy, which proceeds to perform a
location lookup on the Request-URI. It is translated into the contact
for that instance, and then proxied to that contact. 

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

    SUBSCRIBE sip:callee@192.0.2.1 SIP/2.0
    Via: SIP/2.0/UDP proxy.example.com;branch=z9hG4bK9555
    Via: SIP/2.0/UDP host.example.com;branch=z9hG4bK9zz8
    From: Caller &lt;sip:caller@example.com&gt;;tag=kkaz-
    &lt;allOneLine&gt;
    To: &lt;sip:callee@example.com;gr=urn:uuid:f8
    1d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;
    &lt;/allOneLine&gt;
    Call-ID: faif9a@host.example.com
    CSeq: 2 SUBSCRIBE
    Supported: gruu
    Event: dialog
    Allow: INVITE, OPTIONS, CANCEL, BYE, ACK, NOTIFY
    Contact: &lt;sip:caller@example.com;gr=hdg7777ad7aflzig8sf7&gt;
    Content-Length: 0
</pre></div>
<p>
The SUBSCRIBE generates a 200 response (message 11), which is followed
by a NOTIFY (message 13 and 14) and its response (message 15 and 16).
At some point after message 16 is received, the callee's machine
crashes and recovers. It obtains a new IP address, 192.0.2.2. Unaware
that it had previously had an active registration, it creates a new
one (message 17 below). Notice how the instance ID remains the same,
as it persists across reboot cycles:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

   REGISTER sip:example.com SIP/2.0
   Via: SIP/2.0/UDP 192.0.2.2;branch=z9hG4bKnasbba
   Max-Forwards: 70
   From: Callee &lt;sip:callee@example.com&gt;;tag=ha8d777f0
   Supported: gruu
   To: Callee &lt;sip:callee@example.com&gt;
   Call-ID: hf8asxzff8s7f@192.0.2.2
   CSeq: 1 REGISTER
   &lt;allOneLine&gt;
   Contact: &lt;sip:callee@192.0.2.2&gt;
   ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
   &lt;/allOneLine&gt;
   Content-Length: 0
</pre></div>
<p> The registrar notices that a different contact,
sip:callee@192.0.2.1, is already associated with the same instance
ID. It registers the new one too and returns both in the REGISTER
response. Both have the same public GRUUs, but the registrar has
generated a second temporary GRUU for this AOR and instance ID
combination. Both contacts are included in the REGISTER response, and
the temporary GRUU for each is the same - the most recently created
one for the instance ID and AOR. The registrar then generates the
following response: 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

   SIP/2.0 200 OK
   Via: SIP/2.0/UDP 192.0.2.2;branch=z9hG4bKnasbba
   From: Callee &lt;sip:callee@example.com&gt;;tag=ha8d777f0
   To: Callee &lt;sip:callee@example.com&gt;;tag=99f8f7
   Call-ID: hf8asxzff8s7f@192.0.2.2
   CSeq: 1 REGISTER
   &lt;allOneLine&gt;
   Contact: &lt;sip:callee@192.0.2.2&gt;
   ;pub-gruu="sip:callee@example.com;gr=urn:
   uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
   ;temp-gruu="sip:tgruu.7hatz6cn-098shfyq193=ajfux8fyg7ajqqe7@example.com;gr"
   ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
   ;expires=3600
   &lt;/allOneLine&gt;
   &lt;allOneLine&gt;
   Contact: &lt;sip:callee@192.0.2.1&gt;
   ;pub-gruu="sip:callee@example.com;gr=urn:
   uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
   ;temp-gruu="sip:tgruu.7hatz6cn-098shfyq193=ajfux8fyg7ajqqe7@example.com;gr"
   ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
   ;expires=400
   &lt;/allOneLine&gt;
   Content-Length: 0
</pre></div>
<p>
There is no need for the UA to remove the stale registered contact;
the request targeting rules in <a class='info' href='#sec-proxy-main'>Section&nbsp;6.1<span> (</span><span class='info'>Request Targeting</span><span>)</span></a>
will cause the request to be delivered to the most recent one.

</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Security Considerations</h3>

<p>
Attacks in SIP networks using GRUUs can be divided into inside attacks
(where the attacker is a valid participant in the system but is
malicious), and outside attacks, where a third party is trying to
attack the system. In addition, there are privacy considerations with
using GRUUs.

</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1"></a><h3>10.1.&nbsp;
Outside Attacks</h3>

<p>
It is important for a UA to be assured of the integrity of a GRUU
given in a REGISTER response. If the GRUU is tampered with 
by an attacker, the result could be denial of service to the UA. As a
result, it is RECOMMENDED that a UA use the SIPS URI scheme in the
Request-URI when registering. Proxies and registrars MUST support the
sips URI and MUST support TLS. This does not represent a
change from the requirements in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. 

</p>
<p>
The example GRUU construction algorithm in <a class='info' href='#sec-cons-public'>Appendix&nbsp;A.1<span> (</span><span class='info'>Public GRUU</span><span>)</span></a> makes no attempt to create a GRUU that 
hides the AOR and instance ID associated with the GRUU. In general,
determination of the AOR associated with a GRUU is considered a good
property, since it allows for easy tracking of the target of a
particular call. Learning the instance ID provides little benefit to
an attacker. To register or otherwise impact registrations for the
user, an attacker would need to obtain the credentials for the
user. Knowing the instance ID is insufficient.

</p>
<p>
The example GRUU construction algorithm in <a class='info' href='#sec-cons-public'>Appendix&nbsp;A.1<span> (</span><span class='info'>Public GRUU</span><span>)</span></a> makes no attempt to create a GRUU that
prevents users from guessing a GRUU based on knowledge of
the AOR and instance ID. A user that is able to do that will be able
to direct a new request at a particular instance. However, this
specification recommends that service treatment (in particular,
screening features) be given to requests
that are sent to a GRUU. That treatment will make sure that the GRUU does not
provide a back door for attackers to contact a user that has tried to
block the attacker. 

</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2"></a><h3>10.2.&nbsp;
Inside Attacks</h3>

<p> As a consequence of this specification, a UA will begin using GRUUs
in the dialog forming and target refresh requests and responses it
emits. These GRUUs will be passed to other UA (called the
correspondent), which then use them in requests that they emit. 

</p>
<p>
If a malicious correspondent removes the "gr" URI parameter, the
request will be routed to the authoritative proxy. If the GRUU had been
temporary, removal of the "gr" URI parameter produces a URI that is not
recognized as a GRUU and not equal to any AOR. The request will be
rejected. If the GRUU had been public, the resulting of removing the
"gr" URI parameter produces the AOR. Therefore, the request is treated
like a call to the AOR. Since it is a desired goal to allow users to
extract the AOR from the GRUU, this is not an attack and the call will
be handled normally.

</p>
<p>
A malicious user in the system might try to use a GRUU for launching a
DoS attack against another SIP UA. To do that, it would wait for a
call from that UA, from it, observe their GRUU. Once obtained, the UA
would launch a SIP request to an entity, such as a presence server,
which will generate many requests back towards the UA. However, the
attacker will use the target's GRUU in the Contact header field of
that SUBSCRIBE request. This will cause the traffic to be directed
towards the target instead. Since the GRUU is globally routable, such
traffic is more likely to be delivered to the target than traffic sent
to its IP address. This specification helps mitigate this attack by
requiring proxies to validate that the GRUU in the Contact of a
request matches the authenticated identity of the sender of the
request. This check requires the use of an outbound proxy. SIP does
not require outbound proxies, and this does leave a potential area of
vulnerability. However, in practice, nearly all deployments of SIP
utilize an outbound proxy, and therefore this vulnerability is not
likely to be a concern.

</p>
<a name="sec-privacy"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.3"></a><h3>10.3.&nbsp;
Privacy Considerations</h3>

<p>
RFC 3323 <a class='info' href='#RFC3323'>[RFC3323]<span> (</span><span class='info'>Peterson, J., &ldquo;A Privacy Mechanism for the Session Initiation Protocol (SIP),&rdquo; November&nbsp;2002.</span><span>)</span></a> defines mechanisms for privacy. It
distinguishes between 
user-provided privacy and network-provided privacy. In the latter, the
user requests privacy services from the network by including a Privacy
header field in the request. In the former, the UA follows a basic set
of guidelines for construction of its request so let a certain level
of privacy is afforded. 

</p>
<p>
The guidelines in Section 4.1 of RFC 3323 <a class='info' href='#RFC3323'>[RFC3323]<span> (</span><span class='info'>Peterson, J., &ldquo;A Privacy Mechanism for the Session Initiation Protocol (SIP),&rdquo; November&nbsp;2002.</span><span>)</span></a> for
user-provided privacy 
request that a UA construct its Contact header field with a URI that
omits a user part, and utilizes the IP address or hostname of the
UA. Such recommendations are in conflict with the rules defined in
this specification, which require the usage of a GRUU in the Contact
header field.

</p>
<p>
However, the temporary GRUUs provided by the registrar can be used in
place of the Contact URI format described in RFC 3323 <a class='info' href='#RFC3323'>[RFC3323]<span> (</span><span class='info'>Peterson, J., &ldquo;A Privacy Mechanism for the Session Initiation Protocol (SIP),&rdquo; November&nbsp;2002.</span><span>)</span></a>. A user agent would
gather the temporary GRUU returned in each REGISTER responses, and keep
a small number of them cached. When it makes or receives a call, a
temporary GRUU is used to populate the Contact header field.

</p>
<p>
A UA can either elect to use the same temporary GRUU in each call, or
it can use a different temporary GRUU in each call. The choice depends
on the level of privacy desired:

</p>
<p></p>
<ul class="text">
<li>A UA utilizing the same temporary URI for each call will allow a
correspondent, based solely on investigation of the Contact header
field, to correlate calls as coming from the same UA. This
is also true for the user provided privacy procedures in RFC 3323
<a class='info' href='#RFC3323'>[RFC3323]<span> (</span><span class='info'>Peterson, J., &ldquo;A Privacy Mechanism for the Session Initiation Protocol (SIP),&rdquo; November&nbsp;2002.</span><span>)</span></a>,
since the IP address or hostname in the Contact URI provides a similar
correlator.  

</li>
<li>
A UA utilizing a different temporary URI for each call will not allow
a correspondent, based solely on investigation of the Contact header
field, to correlate calls as coming from the same UA. 

</li>
<li>
In both cases, absent network-provided privacy, IP address and port
information in the Session Description Protocol (SDP) (defined in <a class='info' href='#RFC4566'>[RFC4566]<span> (</span><span class='info'>Handley, M., Jacobson, V., and C. Perkins, &ldquo;SDP: Session Description Protocol,&rdquo; July&nbsp;2006.</span><span>)</span></a>) will allow a correspondent to correlate calls as
coming from the same UA. 

</li>
<li>
In both cases, if a user makes a call, the correspondent will be able
to call back by directing requests towards the GRUU in the Contact
header field. Similarly, features such as transfer and digit
collection by network application servers (see RFC 4730 <a class='info' href='#RFC4730'>[RFC4730]<span> (</span><span class='info'>Burger, E. and M. Dolly, &ldquo;A Session Initiation Protocol (SIP) Event Package for Key Press Stimulus (KPML),&rdquo; November&nbsp;2006.</span><span>)</span></a>), which depend on a Contact with the
GRUU property, will also be possible. These kinds of inbound requests
will be possible until the registration for that UA lapses. A UA that
wishes to invalidate its previous temporary GRUU in order to limit
reachability MAY do so by generating a REGISTER refresh with a Call-ID
that differs from ones used previously. A UA SHOULD NOT forcefully
expire its registration and then re-register in order to invalidate
a temporary GRUU; this results in a brief period of unreachability and
will often produce excess load on the network. Refreshing with a new
Call-ID is more efficient and is meant as the technique for
coarse-grained control over the validity of temporary GRUU.  A UA
wishing to not be disturbed by a specific call back will need to
implement manual or automated call handling procedures to reject
it. This specification does not provide the UA the ability to manually
invalidate individual temporary GRUU. If a UA insists on not receiving
any such inbound requests (including ones generated by network
applications, such as those used for collecting digits), the UA can
place a non-GRUU into the Contact header field. However, this is NOT
RECOMMENDED. Usage of a GRUU coupled with automated call rejection
features is far superior.

</li>
<li>
As long as a temporary GRUU is used to populate the Contact
header field, a correspondent will not be able to ascertain any
information about the AOR or instance ID of the UA by inspection of
the Contact header field. However, absent a network-provided privacy
service, the IP address in the SDP can be used to determine
information about the UA, such as its geographic location and ISP.

</li>
<li>
In all cases, regardless of whether the UA uses a temporary or
public GRUU in the Contact, regardless of whether it utilizes GRUU at
all, and regardless of whether it invokes a network-provided privacy
service, a correspondent will be able to determine the SIP service
provider of the UA.

</li>
</ul>

<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
IANA Considerations</h3>

<p>
This specification defines two new Contact header field parameters, one SIP
URI parameter, and a SIP option tag. 

</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.1"></a><h3>11.1.&nbsp;
Header Field Parameter</h3>

<p>
This specification defines two new header field parameters, as per the
registry created by RFC 3968 <a class='info' href='#RFC3968'>[RFC3968]<span> (</span><span class='info'>Camarillo, G., &ldquo;The Internet Assigned Number Authority (IANA) Header Field Parameter Registry for the Session Initiation Protocol (SIP),&rdquo; December&nbsp;2004.</span><span>)</span></a>. The required information
is as follows:

</p>
<p></p>
<blockquote class="text"><dl>
<dt>Header field in which the parameter can
appear:</dt>
<dd>Contact
</dd>
<dt>Name of the Parameter:</dt>
<dd>pub-gruu
</dd>
<dt>RFC Reference:</dt>
<dd>RFC XXXX [[NOTE TO IANA: Please replace
XXXX with the RFC number of this specification.]]
</dd>
</dl></blockquote>

<p></p>
<blockquote class="text"><dl>
<dt>Header field in which the parameter can
appear:</dt>
<dd>Contact
</dd>
<dt>Name of the Parameter:</dt>
<dd>temp-gruu
</dd>
<dt>RFC Reference:</dt>
<dd>RFC XXXX [[NOTE TO IANA: Please replace
XXXX with the RFC number of this specification.]]
</dd>
</dl></blockquote>

<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.2"></a><h3>11.2.&nbsp;
URI Parameter</h3>

<p>
This specification defines one new SIP URI parameter, as per the
registry created by RFC 3969 <a class='info' href='#RFC3969'>[RFC3969]<span> (</span><span class='info'>Camarillo, G., &ldquo;The Internet Assigned Number Authority (IANA) Uniform Resource Identifier (URI) Parameter Registry for the Session Initiation Protocol (SIP),&rdquo; December&nbsp;2004.</span><span>)</span></a>.

</p>
<p></p>
<blockquote class="text"><dl>
<dt>Name of the Parameter:</dt>
<dd>gr
</dd>
<dt>Predefined Values:</dt>
<dd>none
</dd>
<dt>RFC Reference:</dt>
<dd>RFC XXXX [[NOTE TO IANA: Please replace
XXXX with the RFC number of this specification.]]
</dd>
</dl></blockquote>

<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.3"></a><h3>11.3.&nbsp;
SIP Option Tag</h3>

<p>
This specification registers a new SIP option tag, as per the
guidelines in Section 27.1 of RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.

</p>
<p></p>
<blockquote class="text"><dl>
<dt>Name:</dt>
<dd> gruu 
</dd>
<dt>Description:</dt>
<dd> This option tag is used to identify the
Globally Routable User Agent URI (GRUU) extension. When used in a
Supported header, it indicates that a User Agent understands the
extension. When used in a Require header field of a REGISTER request,
it indicates that the registrar is not expected to process the registration
unless it supports the GRUU extension.
</dd>
</dl></blockquote>

<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Acknowledgements</h3>

<p>
The author would like to thank Eric Rescorla, Robert Sparks, Rohan
Mahy, Paul Kyzivat, Alan Johnston, Ya-Ching Tan, Dale Worley, Jeroen
van Bemmel, Vijay Gurbani, Andrew Allen, Alan Hawrylyshen, Francois
Audet, Fredrik Thulin, Dean Willis, David Hancock, Keith Drage, and
Cullen Jennings for their comments and contributions to this
work. Eric Rescorla provided the text for the introduction and the
GRUU construction algorithm in the appendix.

</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>13.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3263">[RFC3263]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3263">Session Initiation Protocol (SIP): Locating SIP Servers</a>,&rdquo; RFC&nbsp;3263, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3263.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3327">[RFC3327]</a></td>
<td class="author-text">Willis, D. and B. Hoeneisen, &ldquo;<a href="http://tools.ietf.org/html/rfc3327">Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts</a>,&rdquo; RFC&nbsp;3327, December&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3327.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3265">[RFC3265]</a></td>
<td class="author-text">Roach, A., &ldquo;<a href="http://tools.ietf.org/html/rfc3265">Session Initiation Protocol (SIP)-Specific Event Notification</a>,&rdquo; RFC&nbsp;3265, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3265.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3515">[RFC3515]</a></td>
<td class="author-text">Sparks, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3515">The Session Initiation Protocol (SIP) Refer Method</a>,&rdquo; RFC&nbsp;3515, April&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3515.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3840">[RFC3840]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;<a href="http://tools.ietf.org/html/rfc3840">Indicating User Agent Capabilities in the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3840, August&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3840.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3968">[RFC3968]</a></td>
<td class="author-text">Camarillo, G., &ldquo;<a href="http://tools.ietf.org/html/rfc3968">The Internet Assigned Number Authority (IANA) Header Field Parameter Registry for the Session Initiation Protocol (SIP)</a>,&rdquo; BCP&nbsp;98, RFC&nbsp;3968, December&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3968.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3969">[RFC3969]</a></td>
<td class="author-text">Camarillo, G., &ldquo;<a href="http://tools.ietf.org/html/rfc3969">The Internet Assigned Number Authority (IANA) Uniform Resource Identifier (URI) Parameter Registry for the Session Initiation Protocol (SIP)</a>,&rdquo; BCP&nbsp;99, RFC&nbsp;3969, December&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3969.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4566">[RFC4566]</a></td>
<td class="author-text">Handley, M., Jacobson, V., and C. Perkins, &ldquo;<a href="http://tools.ietf.org/html/rfc4566">SDP: Session Description Protocol</a>,&rdquo; RFC&nbsp;4566, July&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4566.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3966">[RFC3966]</a></td>
<td class="author-text">Schulzrinne, H., &ldquo;<a href="http://tools.ietf.org/html/rfc3966">The tel URI for Telephone Numbers</a>,&rdquo; RFC&nbsp;3966, December&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3966.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3841">[RFC3841]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;<a href="http://tools.ietf.org/html/rfc3841">Caller Preferences for the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3841, August&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3841.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sip-outbound">[I-D.ietf-sip-outbound]</a></td>
<td class="author-text">Jennings, C., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-20.txt">Managing Client Initiated Connections in the Session Initiation Protocol  (SIP)</a>,&rdquo; draft-ietf-sip-outbound-20 (work in progress), June&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-20.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>13.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC3323">[RFC3323]</a></td>
<td class="author-text">Peterson, J., &ldquo;<a href="http://tools.ietf.org/html/rfc3323">A Privacy Mechanism for the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3323, November&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3323.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4235">[RFC4235]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., and R. Mahy, &ldquo;<a href="http://tools.ietf.org/html/rfc4235">An INVITE-Initiated Dialog Event Package for the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;4235, November&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4235.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4475">[RFC4475]</a></td>
<td class="author-text">Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg, J., and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc4475">Session Initiation Protocol (SIP) Torture Test Messages</a>,&rdquo; RFC&nbsp;4475, May&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4475.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3361">[RFC3361]</a></td>
<td class="author-text">Schulzrinne, H., &ldquo;<a href="http://tools.ietf.org/html/rfc3361">Dynamic Host Configuration Protocol (DHCP-for-IPv4) Option for Session Initiation Protocol (SIP) Servers</a>,&rdquo; RFC&nbsp;3361, August&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3361.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sipping-cc-transfer">[I-D.ietf-sipping-cc-transfer]</a></td>
<td class="author-text">Sparks, R. and A. Johnston, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-cc-transfer-12.txt">Session Initiation Protocol Call Control - Transfer</a>,&rdquo; draft-ietf-sipping-cc-transfer-12 (work in progress), March&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-cc-transfer-12.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4730">[RFC4730]</a></td>
<td class="author-text">Burger, E. and M. Dolly, &ldquo;<a href="http://tools.ietf.org/html/rfc4730">A Session Initiation Protocol (SIP) Event Package for Key Press Stimulus (KPML)</a>,&rdquo; RFC&nbsp;4730, November&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4730.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3911">[RFC3911]</a></td>
<td class="author-text">Mahy, R. and D. Petrie, &ldquo;<a href="http://tools.ietf.org/html/rfc3911">The Session Initiation Protocol (SIP) "Join" Header</a>,&rdquo; RFC&nbsp;3911, October&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3911.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3891">[RFC3891]</a></td>
<td class="author-text">Mahy, R., Biggs, B., and R. Dean, &ldquo;<a href="http://tools.ietf.org/html/rfc3891">The Session Initiation Protocol (SIP) "Replaces" Header</a>,&rdquo; RFC&nbsp;3891, September&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3891.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3608">[RFC3608]</a></td>
<td class="author-text">Willis, D. and B. Hoeneisen, &ldquo;<a href="http://tools.ietf.org/html/rfc3608">Session Initiation Protocol (SIP) Extension Header Field for Service Route Discovery During Registration</a>,&rdquo; RFC&nbsp;3608, October&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3608.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3680">[RFC3680]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc3680">A Session Initiation Protocol (SIP) Event Package for Registrations</a>,&rdquo; RFC&nbsp;3680, March&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3680.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3486">[RFC3486]</a></td>
<td class="author-text">Camarillo, G., &ldquo;<a href="http://tools.ietf.org/html/rfc3486">Compressing the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3486, February&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3486.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4240">[RFC4240]</a></td>
<td class="author-text">Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;<a href="http://tools.ietf.org/html/rfc4240">Basic Network Media Services with SIP</a>,&rdquo; RFC&nbsp;4240, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4240.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4458">[RFC4458]</a></td>
<td class="author-text">Jennings, C., Audet, F., and J. Elwell, &ldquo;<a href="http://tools.ietf.org/html/rfc4458">Session Initiation Protocol (SIP) URIs for Applications such as Voicemail and Interactive Voice Response (IVR)</a>,&rdquo; RFC&nbsp;4458, April&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4458.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sipping-gruu-reg-event">[I-D.ietf-sipping-gruu-reg-event]</a></td>
<td class="author-text">Kyzivat, P., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-gruu-reg-event-09.txt">Registration Event Package Extension for Session Initiation Protocol (SIP)  Globally Routable User Agent URIs (GRUUs)</a>,&rdquo; draft-ietf-sipping-gruu-reg-event-09 (work in progress), July&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-gruu-reg-event-09.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.rosenberg-sip-ua-loose-route">[I-D.rosenberg-sip-ua-loose-route]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-sip-ua-loose-route-02.txt">Applying Loose Routing to Session Initiation Protocol (SIP) User Agents  (UA)</a>,&rdquo; draft-rosenberg-sip-ua-loose-route-02 (work in progress), January&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-sip-ua-loose-route-02.txt">TXT</a>).</td></tr>
</table>

<a name="sec-app"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Example GRUU Construction Algorithms</h3>

<p>
The mechanism for constructing a GRUU is not subject to
specification. This appendix provides an example that can be used by a
registrar to construct a public and a temporary GRUU. Of course,
others are permitted, as long as they meet the constraints defined for
a GRUU.

</p>
<a name="sec-cons-public"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
Public GRUU</h3>

<p>
The most basic approach for constructing a public GRUU is to take the
AOR, and place the actual value of the instance ID into the contents
of the "gr" URI parameter.

</p>
<a name="anchor30"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.2"></a><h3>A.2.&nbsp;
Temporary GRUU</h3>

<p>
This specification requires a registrar to create a new temporary GRUU
on each registration refresh. If a registration is very long lived,
this can quickly result in hundreds or even thousands of temporary
GRUUs being created and allocated to a UA. Consequently, it is
important to have an algorithm for constructing temporary GRUUs which
does not require additional storage that grows in size with the number
of temporary GRUUs. The following algorithm meets this goal.

</p>
<p>
The registrar maintains a counter, I. This counter is 48 bits, and is
initialized to zero. The counter is persistently stored, using a
backend database or other similar technique. When the registrar
creates the first temporary GRUU for a particular AOR and instance ID,
the registrar notes the current value of the counter, I_i, and
increments the counter in the database. The registrar then maps I_i to
the AOR and instance ID using the database, a persistent hashmap or
similar technology. If the registration expires such that there are no
longer any contacts with that particular instance ID bound to the
GRUU, the registrar removes the mapping. Similarly, if the temporary
GRUU are invalidated due to a change in Call-ID, the registrar removes
the current mapping from I_i to the AOR and instance ID, notes the
current value of the counter I_j, and stores a mapping from I_j to the
AOR and instance ID. Based on these rules, the hashmap will contain a
single mapping for each AOR and instance ID for which there is a
currently valid registration.

</p>
<p>
The usage of a counter in a 48 bit space with sequential assignment
allows for a compact representation of the hashmap key, which is
important for generating GRUUs of reasonable size. The counter starts
at zero when the system is initialized. Persistent and reliable
storage of the counter is required to avoid misrouting of a GRUU to
the wrong AOR and instance ID. Similarly, persistent storage of the
hashmap is required, even through proxy and registrar restarts. If the
hashmap is reset, all previous temporary GRUU become invalidated. This
might cause dialogs in progress to fail, or future requests towards a
temporary GRUU to fail when they normally would not. The same hashmap
needs to be accessible by all proxies and registrars that can field requests
for a particular AOR and instance ID. 

</p>
<p>
The registrar maintains a pair of local symmetric keys K_e and
K_a. These are re-generated every time the counter is reset. When the
counter rolls over or is reset, the registrar remembers the old values
of K_e and K_a for a time. Like the hashmap itself, these keys need to
be shared across all proxy and registrars that can service requests
for a particular AOR and instance ID.

</p>
<p>
To generate a new temporary GRUU, the registrar generates a random
80-bit distinguisher value D. It then computes:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>


M = D || I_i
E = AES-ECB-Encrypt(K_e, M)
A = HMAC-SHA256-80(K_a, E)

Temp-Gruu-userpart = "tgruu." || base64(E) || base64(A)
</pre></div>
<p>
Where || denotes concatenation, AES-ECB-Encrypt represents AES
encryption in electronic codebook mode. M will be 128 bits long,
producing a value of E that is 128 bits and A that is 80 bits. This
produces a user part which has 42 characters.

</p>
<p>
When a proxy receives a request whose user part begins with "tgruu.",
it extracts the remaining portion, and splits it into 22 characters E' and
the remaining 14 characters A'. It then computes A and E by performing
a base64 decode of A' and E' respectively. Next, it computes:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>


Ac = HMAC-SHA256-80(K_a, E)

</pre></div>
<p>
If the counter has rolled over or reset, this computation is performed
with the current and previous K_a. If the Ac value(s) that are
computed do not match the value of A extracted from the GRUU, the GRUU
is rejected as invalid. Next, the proxy computes:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>


M = AES-ECB-Decrypt(K_e, E)

</pre></div>
<p>
If the counter had rolled over, this computation is done using the
value of K_e that goes with the value of K_a which produced a valid Ac
in the previous HMAC validation. The leading 80 bits (the
distinguisher D) are discarded, leaving an index I_i in the
hashmap. This index is looked up. If it exists, the proxy now has the
AOR and instance ID corresponding to this temporary GRUU. If there is
nothing in the hashmap for the key I_i, the GRUU is no longer valid and the
request is rejected.

</p>
<p>
The usage of a 48 bit counter allows for the registrar to have as many
as a billion AORs, with 10 instances per each AOR, and cycle through
10,000 Call-ID changes for each instance through the duration of a
single registration. These numbers reflect the average; the system
works fine if a particular AOR has more than 10 instances or a
particular instance cycles through more than 10,000 Call-IDs in its
registration, as long as the average meets these
constraints. 

</p>
<a name="anchor31"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
Network Design Considerations</h3>

<p>
The GRUU specification works properly based on logic implemented at
the user agents and in the authoritative proxies on both sides of a
call. Consequently, it is possible to construct network deployments in
which GRUUs will not work properly.

</p>
<p>
One important assumption made by the GRUU mechanism is that, if a
request passes through any proxies in the originating domain prior to
visiting the terminating domain, one of those proxies will be the authoritative
proxy for the UAC. Administrators of SIP networks will need to make
sure that this property is retained. There are several ways it can be
accomplished:

</p>
<p></p>
<ol class="text">
<li>If the user agents support the service route mechanism <a class='info' href='#RFC3608'>[RFC3608]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Service Route Discovery During Registration,&rdquo; October&nbsp;2003.</span><span>)</span></a>, the registrar can implement it and return a
service route that points to the authoritative proxy. This will cause requests
originated by the user agent to pass through the authoritative proxy.

</li>
<li>
The user agents can be configured to never use an outbound proxy, and
send requests directly to the domain of the terminating
party. This configuration is not practical in many use cases but it is
a solution to this requirement.

</li>
<li>
The user agents can be configured with an outbound proxy in the same
domain as the authoritative proxy, and this outbound proxy forwards requests to
the authoritative proxy by default. This works very well in cases where the
clients are not roaming; in such cases the outbound proxy in a visited
network may be discovered dynamically through DHCP <a class='info' href='#RFC3361'>[RFC3361]<span> (</span><span class='info'>Schulzrinne, H., &ldquo;Dynamic Host Configuration Protocol (DHCP-for-IPv4) Option for Session Initiation Protocol (SIP) Servers,&rdquo; August&nbsp;2002.</span><span>)</span></a>.

</li>
<li>
In cases where the client discovers a local outbound proxy via a
mechanism such as DHCP, and is not implementing service route, the UA
can be configured to automatically add an additional Route header
field after the outbound proxy, which points to a proxy in the home
network. This has the same net effect of service route, but is
accomplished through static configuration.

</li>
</ol>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jonathan Rosenberg</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Edison, NJ</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jdrosen@cisco.com">jdrosen@cisco.com</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.jdrosen.net">http://www.jdrosen.net</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2007).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
