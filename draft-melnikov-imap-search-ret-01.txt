Internet Draft                                             A. Melnikov
Document: draft-melnikov-imap-search-ret                     Isode Ltd
Expires: December 2005                                     D. Cridland
                                                 Inventure Systems Ltd
                                                             June 2005

    IMAP4 extension to SEARCH command for controlling what kind of
                        information is returned
                   draft-melnikov-imap-search-ret-01
   
Status of this Memo
   
   By submitting this Internet-Draft, each author represents that any
   applicable patent or other IPR claims of which he or she is aware
   have been or will be disclosed, and any of which he or she becomes
   aware will be disclosed, in accordance with Section 6 of BCP 79.
   
   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF), its areas, and its working groups.  Note that
   other groups may also distribute working documents as Internet-
   Drafts.
   
   Internet-Drafts are draft documents valid for a maximum of six
   months and may be updated, replaced, or obsoleted by other
   documents at any time. It is inappropriate to use Internet-Drafts
   as reference material or to cite them other than as "work in
   progress."
   
   The list of current Internet-Drafts can be accessed at
   http://www.ietf.org/ietf/1id-abstracts.txt
   
   The list of Internet-Draft Shadow Directories can be accessed at
   http://www.ietf.org/shadow.html.
   
   A revised version of this draft document will be submitted to the
   RFC editor as a Standard Track RFC for the Internet Community.
   Discussion and suggestions for improvement are requested, and
   should be sent to ietf-imapext@imc.org and/or lemonade@ietf.org.
   Distribution of this memo is unlimited.
   
   
Abstract
   
   This document extends SEARCH and UID SEARCH commands with result
   specifier, which can control what kind of information is returned.
   Several result specifiers are defined: minimal value, maximal
   value, all found messages and number of found messages. A new
   response ESEARCH is also specified.
   
   
Table of Contents

  1. Conventions Used in this Document                              2
  2. Introduction                                                   3
  3. IMAP Protocol Changes                                          3
     3.1 SEARCH Command                                             3
     3.2 ESEARCH Response                                           4
  4. Formal Syntax                                                  5
  5. Security Considerations                                        6
  6. IANA Considerations                                            6
  7. References                                                     6
     7.1 Normative References                                       6
     7.2 Informative References                                     7
  8. Acknowledgments                                                7
  9. Author's Addresses                                             7
  10. Full Copyright Statement                                      7
  11. Intellectual Property                                         8
  12. Appendix A. Editorial.                                        8
     12.1 Change Log                                                8
     12.2 Open Issues for Discussion                                9
     
   
1.   Conventions Used in this Document
   
   In examples, "C:" and "S:" indicate lines sent by the client and
   server respectively.
   
   The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", and "MAY"
   in this document are to be interpreted as defined in "Key words for
   use in RFCs to Indicate Requirement Levels" [KEYWORDS].

   <<Editorial comments and questions are enclosed like this>>
   
   
2.   Introduction
   
   This document extends SEARCH and UID SEARCH commands with result
   specifier, which can control what kind of information is returned.
   Several result specifiers are defined: minimal value, maximal
   value, all found messages and number of found messages.
   
   A new response ESEARCH is also specified, which replaces the SEARCH
   response.
   
   <<Add several examples showing how this can be used: first unseen
   message, number of deleted messages, etc.>>
   
   
3.   IMAP Protocol Changes

3.1  SEARCH Command
   
   Arguments:  OPTIONAL result specifier
               OPTIONAL [CHARSET] specification
               searching criteria (one or more)
   
   Responses:  REQUIRED untagged response: SEARCH or ESEARCH
   
   Result:     OK - search completed
               NO - search error: can't search that [CHARSET] or
                    criteria
               BAD - command unknown or arguments invalid
   
   
   This section updates definition of the SEARCH command described in
   section 6.4.4 of [IMAP4].
   
   The SEARCH command is extended to allow for result options. This
   document defines 4 search result options:
   
     MIN
        Return the lowest message number/UID that satisfies the
        SEARCH criteria.
        If the SEARCH results in no matches, the server MUST NOT
        include the MIN result option in the ESEARCH response,
        however it still MUST send the ESEARCH response.
     
     MAX
        Return the highest message number/UID that satisfies the
        SEARCH criteria.
        If the SEARCH results in no matches, the server MUST NOT
        include the MAX result option in the ESEARCH response,
        however it still MUST send the ESEARCH response.
        
     ALL
        Return all message numbers/UIDs that satisfy the SEARCH
        criteria. Unlike regular (unextended) SEARCH, the messages
        are always returned using the sequence-set syntax. A sequence-
        set representation may be more compact and can be used as is
        in a subsequent command that accepts sequence-set.
        Note, the client MUST NOT assume that messages/UIDs will be
        listed in any particular order.
        
        If the SEARCH results in no matches, the server MUST NOT
        include the ALL result option in the ESEARCH response,
        however it still MUST send the ESEARCH response.
     
     COUNT
        Return number of the messages that satisfy the SEARCH
        criteria. This result option MUST always be included in the
        ESEARCH response.

   If one or more result option described above is specified, the
   extended SEARCH command MUST return <<one or more?>> ESEARCH
   response, instead of the SEARCH response.
   
   If the list of result options is empty, that requests the server to
   return an ESEARCH response instead of the SEARCH response. This is
   equivalent to "(ALL)".

   
      Example:    C: A282 SEARCH RETURN (MIN COUNT) FLAGGED
                     SINCE 1-Feb-1994 NOT FROM "Smith"
                  S: * ESEARCH (TAG "A282") MIN 2 COUNT 3
                  S: A282 OK SEARCH completed
   
      Example:    C: A283 SEARCH RETURN () FLAGGED
                     SINCE 1-Feb-1994 NOT FROM "Smith"
                  S: * ESEARCH (TAG "A283") ALL 2,10:11
                  S: A283 OK SEARCH completed


3.2  ESEARCH Response
   
   Contents:   one or more search-return-data pairs
   
   The ESEARCH response occurs as a result of an extended SEARCH or
   UID SEARCH command specified in section 3.1.
   
   The ESEARCH response is immediately followed by an optional search
   correlator. If it is missing than the response was not caused by a
   particular IMAP command, if it is present than it contains the tag
   of the command that caused the response to be returned.
   
   The search correlator is followed by an optional UID indicator. If
   this indicator is present, all data in the ESEARCH response is
   referring to UIDs, for example the MIN result specifier will be
   followed by an UID. If the UID indicator is missing, all returned
   data is referring to message numbers.
   An extended UID SEARCH command MUST cause a ESEARCH response with
   the UID indicator present.
   <<Open question: do we want to allow for mixed responses: some data
   items contain UIDs, some contains message numbers?>>
   
   The rest of the ESEARCH response contains one or more search data
   pairs. Each pair starts with unique return item name, followed by a
   space and the corresponding data. Search data pairs may be returned
   in any order.
   
   Example:    S: * ESEARCH UID COUNT 5 ALL 4:19,21,28
   
   Example:    S: * ESEARCH (TAG "a567") UID COUNT 5 ALL 4:19,21,28

   Example:    S: * ESEARCH COUNT 5 ALL 1:17,21


4.   Formal Syntax
   
   The following syntax specification uses the Augmented Backus-Naur
   Form (ABNF) notation as specified in [ABNF].
   
   Non-terminals referenced but not defined below are as defined by
   [IMAP4] or [IMAPABNF].
   
   Except as noted otherwise, all alphabetic characters are case-
   insensitive.  The use of upper or lower case characters to define
   token strings is for editorial clarity only.  Implementations MUST
   accept these strings in a case-insensitive fashion.
   
     
     capability         =/ "X-DRAFT-I01-ESEARCH"

     mailbox-data       =/ "ESEARCH" [search-correlator] [SP "UID"]
                           *(SP search-return-data)
                           ;; Note that SEARCH and ESEARCH responses
                           ;; are mutually exclusive, i.e. only one of
                           ;; them should be returned as a result of a
                           ;; command.

     search-correlator  = SP "(" "TAG" SP tag-string ")"
     
     search-return-data = "MIN" SP nz-number /
                          "MAX" SP nz-number /
                          "ALL" SP sequence-set /
                          "COUNT" SP number
     
     search-return-opt  = "MIN" / "MAX" / "ALL" / "COUNT"
                          ;; conforms to generic search-return-opt
                          ;; syntax defined in [IMAPABNF]
     
     <<extend MIN & MAX to allow for parameters?>>
     
     
     tag-string         = string
                          ;; tag of the command that caused
                          ;; the ESEARCH response, sent as
                          ;; a string.


5.   Security Considerations
   
   <<TBD>>


6.   IANA Considerations

   IMAP4 capabilities are registered by publishing a standards track
   or IESG approved experimental RFC.  The registry is currently
   located at
      <http://www.iana.org/assignments/imap4-capabilities>.
   This document defines the X-DRAFT-I01-ESEARCH <<fix before
   publication>> IMAP capability.  IANA is requested to add this
   capability to the registry.
   

7.   References

7.1  Normative References
   
   [KEYWORDS] Bradner, S., "Key words for use in RFCs to Indicate
   Requirement Levels", RFC 2119, March 1997.
   
   [IMAP4] Crispin, M., "Internet Message Access Protocol - Version
   4rev1", RFC 3501, University of Washington, March 2003.
   
   [ABNF] Crocker, D. (Ed.) and P. Overell , "Augmented BNF for Syntax
   Specifications: ABNF", RFC 2234, November 1997. <<Needs updating>>
   
   [IMAPABNF] Melnikov, A., "Collected extensions to IMAP4 ABNF", work
   in progress, draft-melnikov-imap-ext-abnf-XX.txt.


7.2  Informative References
   
   [TRANS-CAPA] Melnikov, A., "Transitional IMAP capabilities", work
   in progress, draft-melnikov-imap-transitional-capa-XX.txt


8.   Acknowledgments
   
   Thanks to Michael Wener, Arnt Gulbrandsen, Cyrus Daboo, Mark
   Crispin and Pete Maclean for comments and corrections.


9.   Author's Addresses
   
   Alexey Melnikov
   Isode Limited
   5 Castle Business Village
   36 Station Road
   Hampton, Middlesex, TW12 2BX
   UK
   
   Email: Alexey.Melnikov@isode.com
   
   
   Dave A. Cridland
   Inventure Systems Limited
   
   Email: dave.cridland@inventuresystems.co.uk
   URL: http://invsys.co.uk/dave/


10.  Full Copyright Statement
   
   Copyright (C) The Internet Society (2005).
   
   This document is subject to the rights, licenses and restrictions
   contained in BCP 78, and except as set forth therein, the authors
   retain all their rights.
   
   This document and the information contained herein are provided on
   an "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE
   REPRESENTS OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY AND
   THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
   EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
   THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR
   ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A
   PARTICULAR PURPOSE.
   
Acknowledgement
   
   Funding for the RFC Editor function is currently provided by the
   Internet Society.
   
   
11.  Intellectual Property

   The IETF takes no position regarding the validity or scope of any
   Intellectual Property Rights or other rights that might be claimed
   to pertain to the implementation or use of the technology described
   in this document or the extent to which any license under such
   rights might or might not be available; nor does it represent that
   it has made any independent effort to identify any such rights.
   Information on the procedures with respect to rights in RFC
   documents can be found in BCP 78 and BCP 79.
   
   Copies of IPR disclosures made to the IETF Secretariat and any
   assurances of licenses to be made available, or the result of an
   attempt made to obtain a general license or permission for the use
   of such proprietary rights by implementers or users of this
   specification can be obtained from the IETF on-line IPR repository
   at http://www.ietf.org/ipr.
   
   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights that may cover technology that may be required to implement
   this standard.  Please address the information to the IETF at ietf-
   ipr@ietf.org.
   
   
12.  Appendix A. Editorial.
   
   <<Note that this section will be deleted before publication>>

12.1 Change Log

   00   Initial Revision.
   01   Added search correlator. Clarified what should be returned if an
      extended SEARCH produces no matches. Filled in "IANA considerations"
      section. Updated references: updated ABNF and added [IMAPABNF].
      Changed semantics of the empty list of result options (now equivalent
      to "(ALL)").


12.2 Open Issues for Discussion
   
   Should the syntax allow for return option parameters? It might be
   convenient to specify "MIN 10" and get SEARCH paged results.

  
