<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>IPv6-to-IPv6 Network Address Translation (NAT66)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="IPv6-to-IPv6 Network Address Translation (NAT66)">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">BEHAVE WG</td><td class="header">M. Wasserman</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Sandstorm Enterprises</td></tr>
<tr><td class="header">Expires: May 7, 2009</td><td class="header">F. Baker</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Cisco Systems</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">November 03, 2008</td></tr>
</table></td></tr></table>
<h1><br />IPv6-to-IPv6 Network Address Translation (NAT66)<br />draft-mrw-behave-nat66-01.txt</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on May 7, 2009.</p>

<h3>Abstract</h3>

<p>
This document describes a stateless, transport-agnostic IPv6-to-IPv6
Network Address Translation (NAT66) function that provides the address
independence benefit associated with IPv4-to-IPv4 NAT (NAT44) while
minimizing, but not completely eliminating, the problems associated
with NAT44.
      
</p>
<p>
This document also describes an address mapping option for NAT66 that
offers the topology hiding benefit associated with NAT44 at the cost
of additional state in the NAT66 device.
      
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Requirements Terminology<br />
<a href="#anchor2">2.</a>&nbsp;
Introduction<br />
<a href="#anchor3">3.</a>&nbsp;
Motivations<br />
<a href="#anchor4">4.</a>&nbsp;
NAT66 Overview<br />
<a href="#anchor5">5.</a>&nbsp;
NAT66 Address Mapping Mechanisms<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">5.1.</a>&nbsp;
Checksum-Neutral Mapping<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">5.1.1.</a>&nbsp;
Two-Way Algorithmic Address Mapping<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">5.1.2.</a>&nbsp;
Topology Hiding Option<br />
<a href="#anchor9">6.</a>&nbsp;
Prefixes for Internal Addressing<br />
<a href="#anchor10">7.</a>&nbsp;
A Note on Port Mapping<br />
<a href="#anchor11">8.</a>&nbsp;
Security Considerations<br />
<a href="#anchor12">9.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor13">10.</a>&nbsp;
Acknowledgements<br />
<a href="#anchor14">11.</a>&nbsp;
Change Log<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">11.1.</a>&nbsp;
Changes Between -00 and -01<br />
<a href="#rfc.references1">12.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">12.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">12.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Requirements Terminology</h3>

<p>
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in RFC 2119 <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
      
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Introduction</h3>

<p>
This document describes a stateless, transport-agnostic IPv6-to-IPv6
Network Address Translation (NAT66) function that provides the address
independence benefit associated with IPv4-to-IPv4 NAT (NAT44) while
minimizing, but not completely eliminating, the problems associated
with NAT44.
      
</p>
<p>
NAT66 does not include a port mapping function, and both of the defined
address mapping mechanisms use checksum-neutral algorithms. This
avoids the need for a NAT66 device to re-write transport layer
headers, making it feasible to deploy new or improved transport layer
protocols without upgrading NAT66 devices.  Because NAT66 does not
involve re-writing transport-layer headers, NAT66 will not interfere
with encrypting the full IP payload in many cases.
      
</p>
<p>
The default NAT66 address mapping mechanism is purely algorithmic, so
NAT66 devices do not need to maintain per-node or per-connection
state, allowing deployment of more robust and adaptive networks than
can be deployed using NAT44.  Since the default NAT66 mapping can be
performed in either direction, it does not interfere with inbound
connection establishment, thus allowing internal nodes to participate
in direct peer-to-peer applications.
      
</p>
<p>
This document also defines an address mapping option for NAT66 that
offers the topology hiding benefit associated with NAT44.  This
mechanism involves the configuration or dynamic maintenance of some
per-node state in the NAT66 device.  So, when used with this optional
address mapping mechanisms, NAT66 will have greater negative impact on
direct peer-to-peer applications, and on the robustness and
reliability of the network.  These trade-offs are discussed later in
the document.
      
</p>
<p>
Although NAT66 compares favorably to NAT44 in several ways, it does
not eliminate all of the architectural problems associated with IPv4
NAT.  <a class='info' href='#RFC2993'>[RFC2993]<span> (</span><span class='info'>Hain, T., &ldquo;Architectural Implications of NAT,&rdquo; November&nbsp;2000.</span><span>)</span></a>. NAT66 involves modifying IP headers in
transit, so it is not compatible with security mechanisms that involve
end-to-end encryption of the IP header or mechanisms, such as AH, that
provide integrity protection for the IP header. NAT66 may interfere
with the use of application protocols that transmit IP addresses in
the application-specific portion of the IP packet.  These applications
currently require application layer gateways (ALGs) to work correctly
through NAT44 devices, and similar ALGs may be required for these
applications to work through NAT66 devices.  The use of separate
internal and external address prefixes creates complexity for DNS
deployment, due the desire for internal nodes to communicate with
other internal nodes using internal addresses, while external nodes
need to obtain external addresses to communicate with the same nodes.
Typically, this results in the deployment of "split DNS", which has
it's own set of architectural implications [Ref Needed].
      
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Motivations</h3>

<p>
In defining the NAT66 mechanism, it is not our goal to encourage the
implementation or use of NAT66. There are significant technical
problems associated with the deployment of any type of NAT, and the
IETF does not recommend the use of NAT.  We strongly encourage anyone
who is considering the implementation or deployment of NAT66 to read
RFC 4864 <a class='info' href='#RFC4864'>[RFC4864]<span> (</span><span class='info'>Van de Velde, G., Hain, T., Droms, R., Carpenter, B., and E. Klein, &ldquo;Local Network Protection for IPv6,&rdquo; May&nbsp;2007.</span><span>)</span></a>, and to carefully consider the
alternatives described in that document, many of which will cause
fewer problems than NAT66.
      
</p>
<p>
We are documenting NAT66 because we believe that some people will
choose to implement and deploy IPv6 NAT, in spite of our
recommendation not to do so.  Some enterprises may choose to deploy
IPv6 NAT to gain provider independent internal addressing or to
simplify site multihoming.  Others may consider the trade-offs and
choose IPv6 NAT as a topology hiding mechanism.  In other cases,
administrators may choose to deploy IPv6 NAT to parallel their
IPv4 NAT-based network architecture.  Our goal is to define an
IPv6-to-IPv6 NAT mechanism, NAT66, that will minimize the negative
impacts of IPv6 NAT, in the event that some implementers do choose to
implement an IPv6 NAT mechanism, and some network administrators do
choose to deploy it.
      
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
NAT66 Overview</h3>

<p>
NAT66 may be implemented in an IPv6 router to map one IPv6 address
prefix to another IPv6 address prefix as each IPv6 packet transits the
router.  A router that implements a NAT66 function is referred to as a
NAT66 device.
      
</p>
<p>
In its simplest form, a NAT66 device will be attached to two network
links, one of which is an "internal" network link attached to a leaf
network within a single administrative domain, and the other of which
is an "external" network with connectivity to the global Internet.
All of the hosts on the internal network will use addresses from a
single, locally-routed prefix, and those addresses will be translated
to/from addresses in a globally-routable prefix as IP packets transit
the NAT66 device.
      
</p>
<p>
The following picture shows a NAT66 device attached to two networks.
In this example, the internal network uses IPv6 Unique Local
Addresses (ULAs) <a class='info' href='#RFC4193'>[RFC4193]<span> (</span><span class='info'>Hinden, R. and B. Haberman, &ldquo;Unique Local IPv6 Unicast Addresses,&rdquo; October&nbsp;2005.</span><span>)</span></a> to represent the internal
IPv6 nodes, and the external network uses globally routable IPv6
addresses to represent the same nodes.
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>


     External Network:  Prefix = 2001:0DB8:0001:/48
         --------------------------------------
                           |
                           |
                      +---------+
                      |  NAT66  |
                      |  Device |
                      +---------+
                           |
                           |
         --------------------------------------
     Internal Netowrk:  Prefix = FD01:0203:0405:/48


</pre></div>
<p>
When a NAT66 device forwards packets in the "outbound" direction, from
the internal network to the external network, NAT66 overwrites the
IPv6 source address (in the IPv6 header) with a corresponding address
from the external prefix.  When packets are forwarded in the "inbound"
direction, from the external network to the internal network, the IPv6
destination address is overwritten with a corresponding address in the
internal prefix.  Using the prefixes shown in the diagram above, as an
IP packet passes through the NAT66 device in the outbound direction, the
source address prefix (FD01:0203:0405:/48) will be overwritten with
the external address prefix (2001:0DB8:0001:/48).  In an inbound
packet, the destination prefix (2001:0DB8:0001:/48) will be
overwritten with the internal network prefix (FD01:0203:0405:/48).  In
both cases, it is the local IPv6 address that is overwritten; the
remote IPv6 address remains unchanged.  Nodes on the internal network
are said to be "behind" the NAT66 device.
      
</p>
<p>
NAT66 can also be used between two private networks.  In these
cases, both networks may use ULA prefixes, with each subnet in one
network mapped into a corresponding subnet in the other network, and
vice versa.  Or, each network may use ULA prefixes for internal
addressing and global unicast addresses on the other network.  [TBD,
add pictures of these examples].
      
</p>
<p>
In some cases, more than one NAT66 device may be attached to a
network.  In this case, they two NAT66 devices may be configured with
the same internal and external prefixes, or they may be configured
with the same internal prefix and different external prefixes.  [TBD,
add pictures of these examples.]
      
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
NAT66 Address Mapping Mechanisms</h3>

<p>
This document defines two address mapping functions that can be used
in NAT66 devices.  To comply with this specification, NAT66 devices
MUST implement the Two-Way Algorithmic Address Mapping.  NAT66 devices
SHOULD implement the Topology Hiding Option.
      
</p>
<p>
The Two-Way Algorithmic Address Mapping mechanism and the Topology
Hiding Option both use 1:1 (one-to-one) mappings, meaning that a given
internal address is always mapped to the same external address.  
      
</p>
<p>
When the Two-Way Algorithmic mapping is used, no per-node or per-flow
state is maintained in the NAT66 box.  Both inbound and outbound
packets are translated algorithmically, using only information found
in the IPv6 header.  Due to this property, the Two-Way Algorithmic
Address Mapping can support both outbound and inbound connection
establishment without the need for state-priming or rendevous
mechanisms.  This is a significant improvement over NAT44 devices, but
it also has significant security implications which are described in the
Security Considerations section.
      
</p>
<p>
The Topology Hiding Option is intended to obscure the subnet
information found in the internal IPv6 address prefix from external
view, so that an external node cannot determine the structure of the
internal network by looking at traffic outside of the NAT66 device.
This features is called "topology hiding", and it is one of the
benefits associated with NAT44.  Because it is not possible to derive
the full internal address simply by looking at the external address,
the NAT66 device needs to maintain state in order to copy the correct
internal address into inbound packets.  This also means that inbound
connection establishment will not work properly unless special
provisions are made to enable inbound connectivity, such as
configuring static state in the NAT66 device.
      
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Checksum-Neutral Mapping</h3>

<p>
The NAT66 address mapping mechanisms described in this document are
checksum-neutral, which means that they result in IP headers that will
generate the same pseudo-header checksum when the checksum is
calculated using the standard Internet checksum
<a class='info' href='#RFC1071'>[RFC1071]<span> (</span><span class='info'>Braden, R., Borman, D., Partridge, C., and W. Plummer, &ldquo;Computing the Internet checksum,&rdquo; September&nbsp;1988.</span><span>)</span></a>.  Any changes that are made during
translation of the IPv6 prefix are offset by changes to other parts of
the IPv6 address.  This results in the transport layers (such as TCP
and UDP) calculating the same IPv6 pseudo header checksum for both the
internal and external forms of the same packet, which avoids the need
for the NAT66 device to modify the transport layer headers.
	
</p>
<p>
The NAT66 address mapping mechanisms both use the same technique to
ensure that they produce checksum-neutral transformations.  When a
changes is made to one of the fields in the IPv6 pseudo-header
checksum, the checksum field in the transport layer header may become
invalid.  Fortunately, an incremental change in the area covered by
the Internet standard checksum <a class='info' href='#RFC1071'>[RFC1071]<span> (</span><span class='info'>Braden, R., Borman, D., Partridge, C., and W. Plummer, &ldquo;Computing the Internet checksum,&rdquo; September&nbsp;1988.</span><span>)</span></a> will result in
a well-defined change to the checksum value <a class='info' href='#RFC1624'>[RFC1624]<span> (</span><span class='info'>Rijsinghani, A., &ldquo;Computation of the Internet Checksum via Incremental Update,&rdquo; May&nbsp;1994.</span><span>)</span></a>.
So, a checksum change caused by modifying one part of the area covered
by the checksum can be eliminated by making a complementary change to
a different 16-bit field covered by the same checksum.
	
</p>
<p>
To produce a checksum neutral transformation, the NAT66 device
calculates the 16-bit one's complement sum of the internal and
external IPv6 prefixes.  The difference between the original and
mapped prefix checksums is calculated using 16-bit one's complement
arithmetic, and the difference is added to a 16-bit value in another
area of the local IPv6 address, thus resulting in an IPv6 header that
will have the same pseudo-header checksum as the original header.
Although the same mechanism is used to ensure that both of the NAT66
mappings are checksum-neutral, there are differences in which parts of
the IPv6 header are mapped and where the complementary change is made.
	
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1.1"></a><h3>5.1.1.&nbsp;
Two-Way Algorithmic Address Mapping</h3>

<p>
The Two-Way Algorithmic Address Mapping MUST be implemented on all
NAT66 devices.  This mapping consists of mapping an internal IPv6
prefix, typically a ULA, to/from an external prefix, typically a
globally-routable unicast address, and making a complementary
modification to 16 subnet bits in bits 49 through 64 of the local IPv6
addresss.  The same transformation is performed in both the inbound
and outbound directions, so the only state that is needed on the NAT66
box to peform this transformation is knowledge of the internal and
external address prefixes in use.
	
</p>
<p>
For the network shown in the example diagram in the NAT66 Overview
section above, we might have the following example:
	
</p>
<p>
Internal Prefix:  FD01:0203:0405:/48
External Prefix:  2001:0DB8:0001:/48
	
</p>
<p>
If a node with internal address FD01:0203:0405:0001::1234 sends an
outbound packet through the NAT66 device, the resulting external
address will be 2001:0DB8:0001:D550::1234.  The resulting address is
obtained by calculating the checksum of both the internal and external
48-bit prefixes, sutracting the internal prefix from the external
prefix using one's complement arithmetic and adding the result to the
16-bit subnet field (in this case 0x0001).
	
</p>
<p>
To show the work:
	
</p>
<p>
The one's complement checksum of FD01:0203:0405 is 0xFCF5.
The one's complement checksum of 2001:0DB8:0001 is 0xD245.
Using one's complement math, 0xD245 - 0xFCF5 = 0xD54F.
The subnet mask in the original packet is 0x0001.
Using one's complement math, 0x0001 + 0xD54F = 0xD550.
	
</p>
<p>
So, the value 0xD550 is written in the 16-bit subnet mask area,
resulting in a mapped external address of 2001:0DB8:0001:D550::1234.
	
</p>
<p>
When a response packet is received, it will contain the destination address 
2001:0DB8:0001:D550::0001, which will be mapped using the same mapping
algorithm, back to FD01:0203:0405:0001::1234.
	
</p>
<p>
In this case, the difference between the two prefixes will be calculated as
follows:
	
</p>
<p>
Using one's complement math,  0xFCF5 - 0xD245 = 0x2AB0.
The subnet mask in the original packet = 0xD550.
Using one's complement math, 0xD550 + 0x2AB0 = 0x0001.
	
</p>
<p>
So the value 0x0001 is written into the subnet field, and the internal
value of the subnet field is properly restored.
	
</p>
<p>
This mapping results in no modification of the Interface Identifier
(IID), which is held in the lower half of the IPv6 address, so it will
not interfere with future protocols that may use unique IIDs for node
identification.
	
</p>
<p>
Use of this mapping is restricted to cases where both the internal and
external prefixes are 48 bits long (a /48) or shorter, leaving at
least 16 subnet bits that can be modified to ensure checksum
neutrality.  This may not be a significant limitation in practice,
because it is expected that most NAT66 devices will be used to map
between a provider-allocated external prefix of /48 or shorter and a
ULA that uses the same prefix length as the external prefix. In cases
where one or both prefixes are longer than a /48, the Topology Hiding
Option can be used.
	
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1.2"></a><h3>5.1.2.&nbsp;
Topology Hiding Option</h3>

<p>
The topology hiding option SHOULD be implemented on all NAT66 devices.
It is very similar to the Two-Way Algorithmic Address mapping, except
that the subnet bits in the destination address are mapped to zero in
the outbound direction and are restored to their original value in the
inbound direction.  To remove the restriction on prefixes that have at
least 16 bits of subnet space available, the checksum adjustment is
made in the last 16 bits of the IP header, thus modifying the IPv6
Interface Identifier.  Because the Interface Identifier may no longer
be unique, the "u" bit <a class='info' href='#RFC4291'>[RFC4291]<span> (</span><span class='info'>Hinden, R. and S. Deering, &ldquo;IP Version 6 Addressing Architecture,&rdquo; February&nbsp;2006.</span><span>)</span></a> is cleared in the IID.
This changes is also taken into account in the checksum adjustment.
	
</p>
<p>
For the network shown in the example diagram in the NAT66 Overview
section above, we might have the following example:
	
</p>
<p>
Internal Prefix:  FD01:0203:0405:/48
External Prefix:  2001:0DB8:0001:/48
	
</p>
<p>
If a node with internal address FD01:0203:0405:0001::1234 sends an
outbound packet through the NAT66 device, the resulting external
address will be 2001:0DB8:0001:0000:0002::E782.  The resulting
address is obtained by calculating the checksum of both the internal
and external 48-bit prefixes and subtracting the internal prefix
checsum from the external prefix checksum.  If the "u" bit is cleared
in the original address (the IID has universal scope), set the bit in
the mapped address and add 0xFFFD to the checksum difference
calculated above.  Then, add the checksum difference to the value o the last
16 bits of the IPv6 address.
	
</p>
<p>
To show the work:
	
</p>
<p>
The one's complement checksum of FD01:0203:0405:0001 is 0xFCF4.
The one's complement checksum of 2001:0DB8:0001:0000 is 0xD245.
Using one's complement math, 0xD245 - 0xFCF4 = 0xD550.
The original address has the "u" bit clear, so 0xD550 + 0xFFFD = 0xD54E.
The last 16 bits of the original address are 0x1234.
Using one's complement math, 0x1234 + 0xD54E = 0xE782.
	
</p>
<p>
So, when the prefix is mapped, the "u" bit is set in the IID, and the
value 0xE782 is written into the last 16 bits of the address, this results
in a mapped external address of 2001:0DB8:0001:0000:0002::E782.
	
</p>
<p>
When a response packet is received, it will contain the destination address 
2001:0DB8:0001:0000:0002::E782.  Unfortunately that address does not contain
enough information to do an algorithmic reverse transformation, as the subnet
bits were zeroed out when the external address was selected.  Therefore, the
NAT66 will need to consult its internal state to perform the reverse address
mapping.
	
</p>
<p>
The internal state used for this mapping could consist of dynamic
per-node mapping state, as is maintained in most NAT44 devices today,
or it could consist of a static mapping of external addresses to internal
addresses.  If dynamic state is used, inbound connections to
nodes that have not yet communicated externally will fail, because
there will be no state to perform the inbound mapping.  NAT66
implementations SHOULD provide a means for network administrators to
configure static mapping state to allow inbound mapping when the
Topology Hiding Option is in use.
	
</p>
<p>
Note: We could place the checksum adjustment in the 16-bit subnet
field, if the prefixes are /48 or less, thus avoiding the need to
modify the IID in those cases.  Is that worth doing?  We can't blindly
overwrite the 16-bit following prefix no matter where they are,
because of the need to maintain the "u" and "g" bits in the 7th and
8th bits of the IID.
      
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Prefixes for Internal Addressing</h3>

<p>
IPv6 includes a form of local addressing called Unique Local Addresses
(ULAs) <a class='info' href='#RFC4193'>[RFC4193]<span> (</span><span class='info'>Hinden, R. and B. Haberman, &ldquo;Unique Local IPv6 Unicast Addresses,&rdquo; October&nbsp;2005.</span><span>)</span></a>, and it is RECOMMENDED that ULAs be
used to address network nodes that are located on an internal network
serviced by a NAT66 device.
      
</p>
<p>
NAT66 devices MUST support manual configuration of internal and
external address prefixes, and MUST NOT place any restrictions on
those prefixes except that they be valid IPv6 unicast address
prefixes, as described in <a class='info' href='#RFC4291'>[RFC4291]<span> (</span><span class='info'>Hinden, R. and S. Deering, &ldquo;IP Version 6 Addressing Architecture,&rdquo; February&nbsp;2006.</span><span>)</span></a>, and that they
meet the requirements outlined in this document.
      
</p>
<p>
NAT66 devices that do not have a manually configured internal prefix
SHOULD randomly generate a ULA prefix for the internal network and
advertise that prefix in router advertisements.  NAT66 boxes with more
than one internal interface SHOULD assign a subnet number to each
link, and include the subnet number in router advertisements on the
corresponding link.  NAT66 devices that generate a ULA prefix MUST
generate the prefix using a random number as described in RFC4291
<a class='info' href='#RFC4193'>[RFC4193]<span> (</span><span class='info'>Hinden, R. and B. Haberman, &ldquo;Unique Local IPv6 Unicast Addresses,&rdquo; October&nbsp;2005.</span><span>)</span></a>, and SHOULD store the randomly generated
prefix is non-volatile storage for continued use.
      
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
A Note on Port Mapping</h3>

<p>
In addition to overwriting IP addresses when packets are forwarded,
NAT44 devices often overwrite the source port number in outbound
traffic, and the destination port number in inbound traffic.  This
mechanism is called "port mapping".
      
</p>
<p>
The major benefit of port mapping, and perhaps its only significant
benefit, is that it allows multiple computers to share a single IPv4
address. A large number of internal IPv4 addresses (typically from the
10.0.0.0/8 prefix) can be mapped into a single external, globally
routable IPv4 address, with the local port number used to identify
which internal node should receive each inbound packet. This address
amplification feature should not be needed in IPv6, where every
attached network should be assigned at least a /48 prefix, leaving
room for 16 subnet bits and a 64 bit Interface Identifier
<a class='info' href='#RFC3587'>[RFC3587]<span> (</span><span class='info'>Hinden, R., Deering, S., and E. Nordmark, &ldquo;IPv6 Global Unicast Address Format,&rdquo; August&nbsp;2003.</span><span>)</span></a>.
      
</p>
<p>
Since port mapping requires re-writing a portion of the transport
layer header, it requires NAT66 devices to be aware of all of the
transport protocols that they forward, thus stifling the development
of new and improved transport protocols.  Modifying the transport
layer header is incompatible with security mechanisms that encrypt the
full IP payload, and restricts the NAT66 device to forwarding
trasnport layers that use weak checksum algorithms that are easily
recalculated in routers.  Since there is significant detriment caused
by modifying transport layer headers and very little, if any, benefit
to the use of port mapping in IPv6, NAT66 devices that comply with
this specification MUST NOT perform port mapping.
      
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>
When NAT66 is deployed using the two-way, algorithmic address mapping,
it allows direct inbound connections to internal nodes.  While this
can be viewed as a benefit of NAT66 vs. NAT44, it does open internal
nodes to attacks that would not be possible in a NAT44 network.
Although this situation is no worse, from a security standpoint, than
running IPv6 with no NAT, some enterprises may assume that a NAT66
device will offer similar protection to a NAT44 device.  For this
reason, it is RECOMMENDED that NAT66 devices include an IPv6 firewall
function, and the firewall function SHOULD be configured by default to
block all incoming connections.  Administrators could then enable
inbound connectivity for specific ports by reconfiguring the firewall.
      
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
IANA Considerations</h3>

<p>
This document has no IANA considerations.
      
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Acknowledgements</h3>

<p>
The checksum-neutral algorithmic address mapping described in this
document is based on e-mail written by Iljtsch Van Beijnum.  A 
similar mapping mechanism to the one described in this document
was previously described in a document that can be found here:
http://users.piuha.net/chvogt/pub/2008/vogt-2008-six-one-router-design.pdf.
[TBD, move to an informative reference].
      
</p>
<p>
The following people provided advice or review comments that
substantially improved this document: Ed Jankiewicz, .
      
</p>
<p>
This document was written using the xml2rfc tool described in RFC 2629
<a class='info' href='#RFC2629'>[RFC2629]<span> (</span><span class='info'>Rose, M., &ldquo;Writing I-Ds and RFCs using XML,&rdquo; June&nbsp;1999.</span><span>)</span></a>.
      
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Change Log</h3>

<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.1"></a><h3>11.1.&nbsp;
Changes Between -00 and -01</h3>

<p>
There were several minor changes made between the -00 and -01 versions
of this draft:
</p>
<ul class="text">
<li> Added Fred Baker as a co-author.
</li>
<li> Minor mathematical corrections.
</li>
<li> Added AH to paragraph on NAT security issues. 
</li>
<li> Added additional NAT topologies to overview (diagrams TBD). 
</li>
</ul><p>  
	
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC1071">[RFC1071]</a></td>
<td class="author-text">Braden, R., Borman, D., Partridge, C., and W. Plummer, &ldquo;<a href="http://tools.ietf.org/html/rfc1071">Computing the Internet checksum</a>,&rdquo; RFC&nbsp;1071, September&nbsp;1988 (<a href="http://www.rfc-editor.org/rfc/rfc1071.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1624">[RFC1624]</a></td>
<td class="author-text"><a href="mailto:anil@levers.enet.dec.com">Rijsinghani, A.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1624">Computation of the Internet Checksum via Incremental Update</a>,&rdquo; RFC&nbsp;1624, May&nbsp;1994 (<a href="http://www.rfc-editor.org/rfc/rfc1624.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3587">[RFC3587]</a></td>
<td class="author-text">Hinden, R., Deering, S., and E. Nordmark, &ldquo;<a href="http://tools.ietf.org/html/rfc3587">IPv6 Global Unicast Address Format</a>,&rdquo; RFC&nbsp;3587, August&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3587.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4193">[RFC4193]</a></td>
<td class="author-text">Hinden, R. and B. Haberman, &ldquo;<a href="http://tools.ietf.org/html/rfc4193">Unique Local IPv6 Unicast Addresses</a>,&rdquo; RFC&nbsp;4193, October&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4193.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4291">[RFC4291]</a></td>
<td class="author-text">Hinden, R. and S. Deering, &ldquo;<a href="http://tools.ietf.org/html/rfc4291">IP Version 6 Addressing Architecture</a>,&rdquo; RFC&nbsp;4291, February&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4291.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2629">[RFC2629]</a></td>
<td class="author-text"><a href="mailto:mrose@not.invisible.net">Rose, M.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2629">Writing I-Ds and RFCs using XML</a>,&rdquo; RFC&nbsp;2629, June&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2629.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2629.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2629.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2993">[RFC2993]</a></td>
<td class="author-text">Hain, T., &ldquo;<a href="http://tools.ietf.org/html/rfc2993">Architectural Implications of NAT</a>,&rdquo; RFC&nbsp;2993, November&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2993.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4864">[RFC4864]</a></td>
<td class="author-text">Van de Velde, G., Hain, T., Droms, R., Carpenter, B., and E. Klein, &ldquo;<a href="http://tools.ietf.org/html/rfc4864">Local Network Protection for IPv6</a>,&rdquo; RFC&nbsp;4864, May&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4864.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Margaret Wasserman</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Sandstorm Enterprises</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">14 Summer Street</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Malden, MA  02148</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 781 333 3200</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:mrw@lilacglade.org">mrw@lilacglade.org</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.sandstorm.net">http://www.sandstorm.net</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Fred Baker</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Santa Barbara, California  93117</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1-408-526-4257</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:fred@cisco.com">fred@cisco.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
