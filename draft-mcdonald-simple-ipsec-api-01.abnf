s = socket(AF_INET{,6}, SOCK_{DGRAM,STREAM}, 0);
seclevel = <security level>;
error = setsockopt(s, IPPROTO_IP{,V6}, <category>, seclevel,
               sizeof (int));


s = socket(AF_INET6, SOCK_STREAM, 0);   /* IPv6 socket */

level = IPSEC_LEVEL_REQUIRE;
error = setsockopt(s, IPPROTO_IPV6, IPV6_AUTH_LEVEL, (char *)&level,
               sizeof (int));

s = socket(AF_INET, SOCK_DGRAM, 0);    /* IPv4 socket */

level = IPSEC_LEVEL_BYPASS;   /* Did I mention I'm privileged? */
error = setsockopt(s, IPPROTO_IP, IP_AUTH_LEVEL, (char *)&level,
               sizeof (int));
error = setsockopt(s, IPPROTO_IP, IP_ESP_TRANS_LEVEL,
               (char *)&level, sizeof (int));
error = setsockopt(s, IPPROTO_IP, IP_ESP_NETWORK_LEVEL,
               (char *)&level, sizeof (int));
s = socket(AF_INET6, SOCK_STREAM, 0);   /* IPv6 socket */

level = IPSEC_LEVEL_REQUIRE;
error = setsockopt(s, IPPROTO_IPV6, IPV6_AUTH_LEVEL, (char *)&level,
               sizeof (int));
