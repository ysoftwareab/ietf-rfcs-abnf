Network Working Group                                         Enke Chen
Internet Draft                                    Redback Networks, Inc.
Expiration Date: February 2001                            Yakov Rekhter
                                                          Cisco Systems

            Cooperative Route Filtering Capability for BGP-4

                   draft-chen-bgp-route-filter-01.txt


1. Status of this Memo

   This document is an Internet-Draft and is in full conformance with
   all provisions of Section 10 of RFC2026 except that the right to
   produce derivative works is not granted.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF), its areas, and its working groups.  Note that
   other groups may also distribute working documents as Internet-
   Drafts.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as ``work in progress.''

   The list of current Internet-Drafts can be accessed at
   http://www.ietf.org/ietf/1id-abstracts.txt

   The list of Internet-Draft Shadow Directories can be accessed at
   http://www.ietf.org/shadow.html.


2. Abstract

   This document defines a BGP-based mechanism that allows a BGP speaker
   to send to its BGP peer a set of route filters that the peer would
   use to constrain/filter its outbound routing updates to the speaker.













Chen & Rekhter                                                  [Page 1]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


3. Introduction

   Currently it is not uncommon for a BGP speaker to receive, and then
   filter out some unwanted routes from its peers based on its local
   routing policy. Since the generation and transmission of routing
   updates by the sender, as well as the processing of routing updates
   by the receiver consume resources, it may be beneficial if the
   generation of such unwanted routing updates can be avoided in the
   first place.

   This document defines a BGP-based mechanism that allows a BGP speaker
   to send to its BGP peer a set of Outbound Route Filters (ORFs).  The
   peer would then apply these filters, in addition to its locally
   configured outbound filters (if any), to constrain/filter its
   outbound routing updates to the speaker.


4. Outbound Route Filter (ORF)

   Conceptually an ORF entry is a tuple of the form <AFI/SAFI, ORF-Type,
   Action, Match, ORF-value>; an ORF consists of one or more ORF entries
   that have a common AFI/SAFI and ORF-Type. An ORF is identified by
   <AFI/SAFI, ORF-Type>.

   The "AFI/SAFI" component provides a coarse granularity control by
   limiting the ORF to only the routes whose NLRI matches the "AFI/SAFI"
   component of the ORF.

   The "ORF-Type" component determines the content of the ORF-value.

   The "Action" component controls handling of the ORF Request by the
   remote peer.  Action can be one of ADD, REMOVE, REMOVE-ALL. ADD adds
   an ORF entry to the ORF on the remote peer; REMOVE deletes a
   previously installed ORF entry on the remote peer; REMOVE-ALL deletes
   the previously installed entries in the specified ORF on the remote
   peer.

   The "Match" component can be one of PERMIT or DENY. The semantics of
   PERMIT is to ask the peer to pass updates for the set of routes that
   match the ORF entry. The semantics of DENY is to ask the peer not to
   pass updates for the set of routes that match the ORF entry.










Chen & Rekhter                                                  [Page 2]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


4.1. Communities ORF-Type

   The Community ORF-Type allows to express ORFs in terms of BGP
   Communities [BGP-COMMUNITIES]. That is, the Communities ORF-Type
   provides Communities-based route filtering.

   Conceptually the ORF-value of the Communities ORF-Type consists of
   <Scope, Communities>. "Scope" indicates the set of routes that must
   be considered by the remote peer for the given ORF request. Scope can
   be one of the EXACT or NORMAL. EXACT scope indicates that the remote
   peer should consider only those routes whose Communities attribute is
   equal to the Communities list specified in the ORF. NORMAL scope
   indicates that the remote peer should consider only those routes
   whose Communities attribute either is equal to the Communities list
   specified in the ORF, or exhibit a subset relation with the
   Communities list specified in the ORF.

   The Communities list is a list of BGP Communities.


4.2. Extended Communities ORF-Type

   The Extended Community ORF-Type allows to express ORFs in terms of
   BGP Extended Communities [BGP-EXT-COMMUNITIES]. That is, the Extended
   Communities ORF-Type provides Extended Communities-based route
   filtering.

   Conceptually the ORF-value of the Extended Communities ORF-Type
   consists of <Scope, Extended Communities>. "Scope" indicates the set
   of routes that must be considered by the remote peer for the given
   ORF request. Scope can be one of the EXACT or NORMAL. EXACT scope
   indicates that the remote peer should consider only those routes
   whose Extended Communities attribute is equal to the Extended
   Communities list specified in the ORF. NORMAL scope indicates that
   the remote peer should consider only those routes whose Extended
   Communities attribute either is equal to the Extended Communities
   list specified in the ORF, or exhibit a subset relation with the
   Extended Communities list specified in the ORF.

   The Extended Communities list is a list of BGP Extended Communities.











Chen & Rekhter                                                  [Page 3]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


5. Carrying ORF entries in BGP

   ORF entries are carried in the BGP ROUTE-REFRESH message [BGP-RR]. A
   single ROUTE-REFRESH message could carry multiple ORF entries, as
   long as all these entries share the same AFI/SAFI.

   From the encoding point of view each ORF entry consists of a common
   part and type-specific part.

   The common part consists of <AFI/SAFI, ORF-Type, Action, Match>, and
   is encoded as follows:

      The AFI/SAFI component of an ORF entry is encoded in the AFI/SAFI
      field of the ROUTE-REFRESH message.

      Following the AFI/SAFI component is the one-octet When-to-refresh
      field.  The value of this field can be one of IMMEDIATE (0x01) or
      DEFER (0x02). The semantics of IMMEDIATE is to ask the peer to
      refresh the routes for the AFI/SAFI carried in the message
      immediately after processing the message. The semantics of DEFER
      is to ask the peer to defer refreshing of all the routes until it
      receives a subsequent ROUTE-REFRESH message for the same AFI/SAFI
      either without any ORF entries, or with one or more ORF entries
      and When-to-refresh set to IMMEDIATE.

      Following the When-to-refresh field is a collection of one or more
      ORFs, grouped by ORF-Type.

      The ORF-Type component is encoded as a one-octet field. The value
      0 is reserved. The values 1 through 127 are assigned by the IETF
      consensus process and IESG approval. This document reserves values
      128 through 255 for vendor specific applications.

      The Length of ORFs component is a two-octets field that contains
      the length (in octets) of the ORF entries that follows.


            +--------------------------------------------------+
            | Address Family Identifier (2 octets)             |
            +--------------------------------------------------+
            | Reserved (1 octet)                               |
            +--------------------------------------------------+
            | Subsequent Address Family Identifier (1 octet)   |
            +--------------------------------------------------+
            | When-to-refresh (1 octet)                        |
            +--------------------------------------------------+
            | ORF Type (1 octet)                               |
            +--------------------------------------------------+



Chen & Rekhter                                                  [Page 4]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


            | Length of ORFs (2 octets)                        |
            +--------------------------------------------------+
            | First ORF entry (variable)                       |
            +--------------------------------------------------+
            | Second ORF entry (variable)                      |
            +--------------------------------------------------+
            .........
            +--------------------------------------------------+
            | N-th ORF entry (variable)                        |
            +--------------------------------------------------+
            | ORF Type (1 octet)                               |
            +--------------------------------------------------+
            | Length of ORFs (2 octets)                        |
            +--------------------------------------------------+
            | First ORF entry (variable)                       |
            +--------------------------------------------------+
            | Second ORF entry (variable)                      |
            +--------------------------------------------------+
            .........
            +--------------------------------------------------+
            | N-th ORF entry (variable)                        |
            +--------------------------------------------------+
            .........

            Fig 1. Carrying ORF entries in the ROUTE-REFRESH message

   The rest of the components in the common part are encoded in first
   octet of each ORF-entry as follows (from the most significant to the
   least significant bit):

      Action is a two-bit field. The value of this field is 0 for ADD, 1
      for REMOVE, and 2 for REMOVE-ALL.

      Match is a one-bit field. The value of this field is 0 for PERMIT
      and 1 for DENY.

      Reserved is a 5-bit field. It is set to 0 on transmit and ignored
      on receive.


         +---------------------------------+
         |   Action (2 bit)                |
         +---------------------------------+
         |   Match (1 bit)                 |
         +---------------------------------+
         |   Reserved (5 bits)             |
         +---------------------------------+
         |   Type specific part (variable) |



Chen & Rekhter                                                  [Page 5]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


         +---------------------------------+

         Fig 2. ORF entry encoding


      When the Action component of an ORF entry specifies REMOVE-ALL,
      the entry consists of only the common part.


5.1. Type specific encoding (Communities ORF-Type)

   The value of the ORF-Type for the Communities ORF-Type is 2.

   The type-specific part of Communities ORF-Type consists of <Scope,
   Communities>, and is encoded as follows:

      Scope is a one-octet field. The EXACT Scope has the value of 1.
      The NORMAL Scope has the value of 2.

      Communities are encoded as a one octet Number of Communities
      field, followed by one or more Communities, where each Community
      is encoded as a four-octets field.


5.2. Type specific encoding (Extended Communities ORF-Type)

   The value of the ORF-Type for the Extended Communities ORF-Type is 3.

   The type-specific part of Extended Communities ORF-Type consists of
   <Scope, Extended Communities>, and is encoded as follows:

      Scope is a one-octet field. The EXACT Scope has the value of 1.
      The NORMAL Scope has the value of 2.

      Extended Communities are encoded as a one octet Number of Extended
      Communities field, followed by one or more Extended Communities,
      where each Extended Community is encoded as a eight-octets field.














Chen & Rekhter                                                  [Page 6]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


6. Cooperative Route Filtering Capability

   A BGP speaker that is willing to receive ORF entries from its peer,
   or a BGP speaker that would like to send ORF entries to its peer
   advertises this to the peer by using the Cooperative Route Filtering
   Capability, as described below.

   The Cooperative Route Filtering Capability is a new BGP capability
   [BGP-CAP] defined as follows:

      Capability code: TBD

      Capability length: variable

      Capability value: one or more of the following entries:


            +--------------------------------------------------+
            | Address Family Identifier (2 octets)             |
            +--------------------------------------------------+
            | Reserved (1 octet)                               |
            +--------------------------------------------------+
            | Subsequent Address Family Identifier (1 octet)   |
            +--------------------------------------------------+
            | Number of ORFs (1 octet)                         |
            +--------------------------------------------------+
            | ORF Type (1 octet)                               |
            +--------------------------------------------------+
            | Send/Receive (1 octet)                           |
            +--------------------------------------------------+
            | ...                                              |
            +--------------------------------------------------+
            | ORF Type (1 octet)                               |
            +--------------------------------------------------+
            | Send/Receive (1 octet)                           |
            +--------------------------------------------------+

            Fig 4. Capability encoding


   The use and meaning of these fields are as follows:

      Address Family Identifier (AFI):

         This field carries the identity of the Network Layer protocol
         associated with the Network Address that follows. Presently
         defined values for this field are specified in RFC1700 (see the
         Address Family Numbers section).



Chen & Rekhter                                                  [Page 7]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


      Subsequent Address Family Identifier (SAFI):

         This field provides additional information about the type of
         the Network Layer Reachability Information carried in the
         attribute.

      Number of ORF Types:

         This field contains the number of Filter Types to be listed in
         the following fields.

      ORF Type:

         This field contains the value of an ORF Type.

      Send/Receive:

         This field indicates whether the sender is (a) willing to
         receive ORF entries from its peer (value 1), (b) would like to
         send ORF entries to its peer (value 2), or (c) both (value 3)
         for the ORF Type that follows.



7. Operation

   A BGP speaker that is willing to receive ORF entries from its peer,
   or would like to send ORF entries to its peer should advertise the
   Cooperative Route Filtering Capability to the peer using BGP
   Capabilities advertisement [BGP-CAP].

   A BGP speaker that implements the Cooperative Route Filtering
   Capability must support BGP ROUTE-REFRESH message, as defined in
   [BGP-RR]. A BGP speaker that advertises the Cooperative Route
   Filtering Capability to a peer using BGP Capabilities advertisement
   [BGP-CAP] doesn't have to advertise the BGP Route Refresh capability
   to that peer.

   Consider a BGP speaker that advertises the Cooperative Route
   Filtering Capability indicating its willingness to receive a
   particular set of <AFI, SAFI, ORF-Type> from its peer, and that
   receives the Cooperative Route Filtering Capability indicating the
   desire of the peer to send a particular set <AFI, SAFI, ORF-Type> to
   the speaker. If for a given <AFI, SAFI> the intersection between
   these two sets are not-empty, the speaker should not advertise to the
   peer any routes with that <AFI, SAFI> prior to receiving from the
   peer any ROUTE-REFRESH message carrying that <AFI, SAFI>, where the
   message could be either without any ORF entries, or with one or more



Chen & Rekhter                                                  [Page 8]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


   ORF entry and When-to-refresh field set to IMMEDIATE. If, on the
   other hand, for a given <AFI, SAFI> the intersection between these
   two sets is empty, the speaker should follow normal BGP procedures.

   A BGP speaker may send a ROUTE-REFRESH message with one or more ORF
   entries to its peer only if the peer advertises to the speaker the
   Cooperative Route Filtering Capability indicating its willingness to
   receive ORF entries from the speaker, and the speaker advertises to
   the peer the Cooperative Route Filtering Capability indicating its
   desire to send ORF entries to the peer.  The message may contain only
   ORF entries of <AFI, SAFI, ORF-type> that the peer is willing to
   receive, as advertised to the speaker in the Cooperative Route
   Filtering Capability.

   When a BGP speaker receives a ROUTE-REFRESH message with one or more
   ORF entries from its peer, then the speaker performs the following
   actions. If the <AFI, SAFI, ORF-type> carried by the message doesn't
   match <AFI, SAFI, ORF-type> that the speaker is willing to receive
   from the peer (as advertised to the peer in the Cooperative Route
   Filtering Capability), the specified ORF is ignored.  Otherwise, the
   speaker modifies the specified ORF, as specified in the ORF entries
   carried by the message. If any of the fields within an ORF entry
   contain an unrecognized value, the whole specified ORF is removed.

   If the Action component of an ORF entry is REMOVE, but the ORF
   doesn't contain the specified entry, the entry is ignored.

   ORF entries with either REMOVE or REMOVE-ALL can not remove locally
   configured outbound route filters.

   If the When-to-Refresh indicates IMMEDIATE, then after processing all
   the ORF entries carried in the message the speaker should re-
   advertise to the peer routes from the Adj-RIB-Out that have the same
   AFI/SAFI as what is carried in the message, and taking into account
   all the ORF entries received from the peer.

   The set of ORF entries that the speaker sends to the peer expresses
   the speaker's local preference, that the peer may or may not decide
   to honor.

   During a single BGP session the speaker may pass multiple ORF entries
   to the peer.

   The lifetime of an ORF is the duration of the BGP session during
   which the ORF is exchanged.

   An ORF is removed when the last ORF entry is remove (either via
   REMOVE-ALL, or via a sequence of REMOVE).



Chen & Rekhter                                                  [Page 9]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


   If a particular route maintained by a BGP speaker doesn't match any
   of the ORF entries of any of the (non-empty) ORFs associated with a
   particular peer, then this route should not be advertised to the
   peer.

   If a BGP speaker maintains multiple ORFs of different ORF-Types for a
   particular peer, then the decision by the speaker to advertise a
   route to the peer is determined by passing the route through each
   such ORF, and and-ing the results (and-ing of PERMIT and DENY results
   in DENY).


8. Security Considerations

   This extension to BGP does not change the underlying security issues.


9. Acknowledgements

   Some of the material in the document is "borrowed" from a proposal
   for selective updates by Yakov Rekhter, Kannan Varadhan, and Curtis
   Villamizar.


10. References

   [BGP-4] Rekhter, Y., and T. Li, "A Border Gateway Protocol 4 (BGP-
   4)", RFC 1771, March 1995.

   [BGP-MP] Bates, T., Chandra, R., Katz, D., and Rekhter, Y.,
   "Multiprotocol Extensions for BGP-4", draft-ietf-idr-bgp4-
   multiprotocol-v2-01.txt, August 1998.

   [BGP-CAP] Chandra, R., Scudder, J., "Capabilities Negotiation with
   with BGP-4", draft-ietf-idr-bgp-4-cap-neg-02.txt, August 1998.

   [BGP-COMMUNITIES] Chandra, R., Traina, P., and Li, T., "BGP
   Communities Attribute", RFC1997, August 1996.

   [BGP-EXT-COMMUNITIES] Ramachandra, S., Tappan, D., "BGP Extended
   Communities Attribute", draft-ramachandra-bgp-ext-communities-02.txt

   [BGP-RR] Chen, E., "Route Refresh Capability for BGP-4", draft-ietf-
   idr-bgp-route-refresh-00.txt, November 1999.







Chen & Rekhter                                                 [Page 10]





Internet Draft     draft-chen-bgp-route-filter-01.txt        August 2000


11. Author Information


   Enke Chen
   Redback Networks, Inc.
   350 Holger Way
   San Jose, CA 95134
   e-mail: enke@redback.com

   Yakov Rekhter
   Cisco Systems, Inc.
   170 West Tasman Drive
   San Jose, CA 95134
   e-mail: yakov@cisco.com





































Chen & Rekhter                                                 [Page 11]


