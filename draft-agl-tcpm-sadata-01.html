<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Faster application handshakes with SYN/ACK payloads</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Faster application handshakes with SYN/ACK payloads">
<meta name="keywords" content="TCP Options, Cryptography">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">A. Langley</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Google Inc</td></tr>
<tr><td class="header">Expires: February 7, 2009</td><td class="header">August 06, 2008</td></tr>
</table></td></tr></table>
<h1><br />Faster application handshakes with SYN/ACK payloads<br />draft-agl-tcpm-sadata-01</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on February 7, 2009.</p>

<h3>Abstract</h3>

<p>This document advocates the usage of small, mostly constant payloads in the
        SYN+ACK frame of the 3-way <a class='info' href='#RFC0793'>TCP<span> (</span><span class='info'>Postel, J., &ldquo;Transmission Control Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a> [RFC0793] handshake. We
        show how this can have immediate benefits for some protocols. Additionally,
        we describe a new TCP option that enables a wider range of protocols to gain
        from it.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Requirements Notation<br />
<a href="#anchor2">2.</a>&nbsp;
Changes since 00<br />
<a href="#intro">3.</a>&nbsp;
Introduction<br />
<a href="#anchor3">4.</a>&nbsp;
Example One: Opportunistic HTTP encryption<br />
<a href="#anchor4">5.</a>&nbsp;
Example Two: Faster SSH connections<br />
<a href="#anchor5">6.</a>&nbsp;
Example Three: Compressed HTTP headers<br />
<a href="#lo">7.</a>&nbsp;
The SYNACK Payload Processed Option<br />
<a href="#anchor6">8.</a>&nbsp;
Security Considerations<br />
<a href="#anchor7">9.</a>&nbsp;
Comparison to T/TCP<br />
<a href="#anchor8">10.</a>&nbsp;
Middlebox Interactions<br />
<a href="#anchor9">11.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor10">12.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">13.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">13.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">13.2.</a>&nbsp;
Informative References<br />
<a href="#anchor13">Appendix&nbsp;A.</a>&nbsp;
Changes<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Requirements Notation</h3>

<p>
   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL",
   "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY",
   and "OPTIONAL" in this document are to be interpreted as
   described in <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].

</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Changes since 00</h3>

<p>To be removed by the RFC Editor before publication.
</p>
<p>
    </p>
<ul class="text">
<li>Greatly expanded on the introduction
</li>
<li>Fixed the wording around retransmissions which mistakenly suggested that no packets of any type could be transmitted without payloads.
</li>
<li>Renamed the flag to SYNACK Payloads Processed.
</li>
<li>Required that the flag be echoed in resulting SYNACK frames.
</li>
<li>Added discussion of simultaneous open.
</li>
<li>Added discussion of SYNACKs with payloads that are nothing to do with this spec, noting that they are still permitted.
</li>
<li>Changed the option to a standard, 2 byte, flags option.
</li>
</ul><p>
  
</p>
<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Introduction</h3>

<p>At the current time, almost no stacks will send payloads in the SYNACK frame of a TCP handshake even though <a class='info' href='#RFC0793'>RFC 793<span> (</span><span class='info'>Postel, J., &ldquo;Transmission Control Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a> [RFC0793] permits it. This springs from a handful of reasons:
    </p>
<ol class="text">
<li>Processing time for a SYN must be minimal to mitigate the effects of SYN floods. Even waking up an application to process a SYN would greatly increase the costs.
</li>
<li>Replies to SYNs must be small, otherwise it provides a way to amplify a DDoS attacks using false source IP addresses.
</li>
<li>The ubiquitous sockets API doesn't make it easy to do so.
</li>
</ol><p>
  
</p>
<p>This document proposes that a semi-constant payload (a payload such that it's trivial for the kernel to compute) overcomes the first and third reasons. Additionally, limiting that payload to 64-bytes overcomes the second.
</p>
<p> There are protocols that could immediately benefit from a gradual deployment of hosts which supported a <tt>setsockopt</tt> to set a constant payload and hosts that would ACK and enqueue such a payload. SMTP would be one such protocol: clients wait for a 200 code banner from the server before starting their part of the exchange and the banner is small and constant. SMTP is also a protocol which ends up making many, short lived connections.
</p>
<p>Since such behaviour is already permitted by TCP it requires no standards work. It would also be easy to deploy. Active open hosts that don't enqueue payloads in SYNACK frames will ACK only the SYN flag and the passive open host then knows to retransmit the payload immediately after.
</p>
<p>However, this common lack of carrying data in SYNACK frames, and the sockets API which reflects it, has guided the design of many application layer protocols. These protocols are often designed such that:
    </p>
<ol class="text">
<li>The client starts the exchange. For example, the first application layer bytes sent on an HTTP connection are the client's request.
</li>
<li>The exchange is large since there is little space pressure. SSH algorithm agreement uses strings like <tt>"diffie-hellman-group14-sha1"</tt> (28 bytes) because of this.
</li>
</ol><p>
  
</p>
<p>In these cases we suggest that, had a general ability to send payloads in SYNACK frames existed at the time that these protocols were written, they may have ended up differently. However, the ability for a passive open host to send a payload with no latency overhead is of value: we outline three motivating examples in next sections.
</p>
<p>Modifications to take advantage of SYNACK payloads would then require changes to the application level protocol. This could be managed by assigning new ports, trying connections on the new ports first, backing off etc. However, given that SYNACK payloads are partly a latency optimisation, that would utterly negate any gains.
</p>
<p>Because of this, we also describe a TCP option that lets the application layer on both sides know that their respective stacks support at least the limited SYNACK payloads described herein, and also to agree to use an alternative protocol which takes advantage of it.
</p>
<p>Fundamentally, any protocol which used payloads in SYNACK frames could achieve the same effect without them, at the cost of an extra round trip. Thus, this should only be used where latency is important. None the less, the advantage of avoiding a round trip should not be discounted. Round trip times are often in excess of 100ms for distant hosts, or in poorly networked areas of the world.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Example One: Opportunistic HTTP encryption</h3>

<p>Here we assume that both HTTP client and server implement this specification.
</p>
<p>The client, before calling <tt>connect</tt>, calls <tt>setsockopt</tt> to instruct the kernel to include an option to advertise support for this specification. The server has already configured its listening socket to include a Diffie-Hellman public value in the SYNACK payloads elicited from SYN frames carrying this option. Additionally, the server's stack generates an 8-byte random nonce and includes it in the payload.
</p>
<p>The client is aware that the server implements this specification because the advertising option is echoed back in the SYNACK frame. Thus, it expects to read the nonce and public value from the connection. It then sends its own nonce and public value to the server. Both sides can calculate a shared key and use a cipher to encrypt the remaining data in both directions.
</p>
<p>Choosing the correct cryptographic primitives can make this particularly cheap. <a class='info' href='#curve25519'>Curve25519<span> (</span><span class='info'>Bernstein, D., &ldquo;Curve25519: new Diffie-Hellman speed records,&rdquo; .</span><span>)</span></a> [curve25519] is an elliptic curve Diffie-Hellman function that can be calculated in 240 microseconds on a 2.33GHz Intel Core2. <a class='info' href='#salsa20'>Salsa20/8<span> (</span><span class='info'>Bernstein, D., &ldquo;Salsa20/8 and Salsa20/12,&rdquo; .</span><span>)</span></a> [salsa20] is a stream cipher that can encrypt data in 2 cycles/byte on the same hardware.
</p>
<p>The resulting key could also be used to establish integrity using the <a href='http://www.ietf.org/internet-drafts/draft-ietf-tcpm-tcp-auth-opt-01.txt'>forthcoming TCP Auth Option specification</a>.
</p>
<p>This example demonstrates a number of salient features of this specification:
    </p>
<ul class="text">
<li>By using the correct primitive (curve25519), a constant payload can be used to establish cryptographic connections.
</li>
<li>We can add significant extensions to latency sensitive protocols without affecting latency. <a class='info' href='#RFC2817'>Previous attempts<span> (</span><span class='info'>Khare, R. and S. Lawrence, &ldquo;Upgrading to TLS Within HTTP/1.1,&rdquo; May&nbsp;2000.</span><span>)</span></a> [RFC2817] to do the same have required an extra round trip weather the server side supported the protocol or not.
</li>
<li>We can do in a backwards compatible fashion, affording a gradual deployment.
</li>
</ul><p>
  
</p>
<p>The above is cursorary in order not to distract from the topic of this document, however enquiring readers are welcome to continue reading this section if they still have questions.
</p>
<p><strong>Why Elliptic Curves?</strong>: The payload must be short otherwise SYN-floods could use this as an amplification to backscatter DDoS another host. The reduced computation cost (as compared to Diffie-Hellman over a multiplicative finite field) is very nice.
</p>
<p>Most importantly, curve25519 is specifically designed to allow a constant public value to be used for multiple key agreements. If a new public value had to be generated for every SYN, not only would the stack have to be able to perform that operation, a SYN flood would be very effective.
</p>
<p><strong>Can't the client's public value fit in the SYN?</strong>: A SYN generally has twenty bytes of free option space these days. (We can't use the payload space in a SYN). Since we wouldn't want to define the last option ever, we need to leave four bytes spare. Two bytes for the option header means fourteen bytes (or 112 bits) for the public value. The closest prime is then 2^112-75.
</p>
<p>The best, general algorithm currently known for breaking the Diffie-Hellman problem on elliptic curves is Pollard's Rho. The work involved in this attack is sqrt(n), which is 2^56 in this case. Critically, once you have solved a single instance you can precompute tables to speed up breaking more instances. With a petabyte of storage, you could break 112-bit curves in only 2^12 operations.
</p>
<p><strong>Can't a smaller field be used?</strong>: Some speedup could be gained by using an elliptic curve with a field size around 200 bits.  However the effort of defining such a curve is pretty huge. The standard NIST curves around that size are <a href='http://cr.yp.to/ecdh/reports.html'>slower than curve25519</a>.
</p>
<p><strong>What about man-in-the-middle attacks</strong>: All opportunistic schemes are open to man-in-the-middle and downgrade attacks. This is no exception, it's a trade off and for real security, <a class='info' href='#RFC4346'>TLS<span> (</span><span class='info'>Dierks, T. and E. Rescorla, &ldquo;The Transport Layer Security (TLS) Protocol Version 1.1,&rdquo; April&nbsp;2006.</span><span>)</span></a> [RFC4346] should be used. It has been suggested that the HTTP server include a header in replies giving a URL on the same domain, using the <tt>https</tt> scheme, which contains the server's public value and an expiry time.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Example Two: Faster SSH connections</h3>

<p><a class='info' href='#RFC4253'>SSH<span> (</span><span class='info'>Ylonen, T. and C. Lonvick, &ldquo;The Secure Shell (SSH) Transport Layer Protocol,&rdquo; January&nbsp;2006.</span><span>)</span></a> [RFC4253] connection latency is a small, but quotidian frustration for those who use it. Current efforts to address it involve multiplexing interactive sessions over long-term, persistent connections.
</p>
<p>Consider the following, diagrammatic representation of the beginning of an <a class='info' href='#RFC4253'>SSH<span> (</span><span class='info'>Ylonen, T. and C. Lonvick, &ldquo;The Secure Shell (SSH) Transport Layer Protocol,&rdquo; January&nbsp;2006.</span><span>)</span></a> [RFC4253] connection:
</p><br /><hr class="insert" />
<a name="ssh-std"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   0 SYN     ------------&gt;          0.5
   1         &lt;------------ SYNACK   0.5
   1 Ident   ------------&gt;          1.5
   1 NList   ------------&gt;          1.5
   2         &lt;------------ Ident    1.5
   2         &lt;------------ NList    1.5
   2         &lt;------------ KX       1.5
   2 KX      ------------&gt;          2.5

   Key:
     Ident: A string which contains the SSH implementation name
     NList: Name list: the list of supported algorithms
     KX: Key exchange data, usually Diffie-Hellman
</pre></div>
<p>Standard SSH protocol
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Here, arrows from the left to the right are frames from client to server.  Times on the left are the times that the client either transmits or receives a packet (and vice versa). Times are measured in round trip times (RTT), so that it takes 0.5 units for a frame to pass between the hosts.
</p>
<p>The above diagram is for a latency tuned implementation of SSH, specifically, the client doesn't wait for the server's identity string to be received. And yet, in this ideal scenario, the client can only start transmitting useful data after 2 RTT and the server can only start transmitting after 2.5 RTT. As a rule of thumb, the RTT from San Francisco to London is 150ms, so this means a 300ms latency, at least, when setting up this connection.
</p>
<p>(To keep the discussion simple, we assume there is no packet loss, that the path is symmetrical and that the client's ACK of the 3-way handshake carries a data payload.)
</p>
<p>Now, let us consider the situation when SYNACK payloads are available. First we compact the name-list (which is part of the algorithm negotiation) and put it in the SYNACK.
</p><br /><hr class="insert" />
<a name="ssh-opt1"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   0 SYN     ------------&gt;          0.5
   1         &lt;------------ SA+NList 0.5
   1 NList   ------------&gt;          1.5
   1 KX      ------------&gt;          1.5
   2         &lt;------------ KX       1.5
</pre></div>
<p>SSH protocol with a compact name list carried in the SYN+ACK frame
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>In this situation, the client knows the results of the algorithm negotiation as soon as the SYNACK comes back and can include the correct key exchange with the first ACK packet. This reduces the server's latency by a full RTT since it can transmit as soon as the 3-way handshake completes.
</p>
<p>As a final optimisation, we could assume either that the server takes a successful guess at the key exchange algorithm to use, or that the application level protocol specifies a single key exchange algorithm:
</p><br /><hr class="insert" />
<a name="ssh-opt2"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   0 SYN     ------------&gt;          0.5
   1         &lt;------------ SA+KX    0.5
   1 KX      ------------&gt;          1.5
</pre></div>
<p>A protocol which includes key exchange information in the SYN+ACK frame.
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Here the client's latency is 1 RTT and the server's is 1.5 RTT, which is equal to the minimum required by the 3-way handshake, saving a full RTT of latency from the initial diagram.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Example Three: Compressed HTTP headers</h3>

<p>So that all the examples aren't cryptography based, we consider a third example.
</p>
<p>There are many HTTP resources that are very small, or even empty. Consider that clicking on Google results involves requesting a resource from the Google server to redirect to the true result. Or <a class='info' href='#RFC2560'>OCSP<span> (</span><span class='info'>Myers, M., Ankney, R., Malpani, A., Galperin, S., and C. Adams, &ldquo;X.509 Internet Public Key Infrastructure Online Certificate Status Protocol - OCSP,&rdquo; June&nbsp;1999.</span><span>)</span></a> [RFC2560] revocation servers which serve small ASN.1 documents. For these services the size of HTTP headers might dominate the bandwidth requirements: Firefox 3 transmits over 350 bytes to request the shortest URL possible (<tt>/</tt>)
</p>
<p>HTTP headers, however are highly compressible. They are highly structured, and many strings are very common (such as <tt>Keep-Alive</tt>). Careful examination of the current patterns in both client requests and server replies would probably yield a <a class='info' href='#rangecoding'>range coding<span> (</span><span class='info'>Martin, G., &ldquo;Range encoding: an algorithm for removing redundancy from a digitized message,&rdquo; Video and Data Recording Conference, July&nbsp;1979.</span><span>)</span></a> [rangecoding] model that achieved significant savings.
</p>
<p>However, there is no easy method to deploy such a scheme. Obviously the first client request on a connection could not use a scheme. A server could advertise support in its reply headers for subsequent requests on the same connection, although that could only affect requests that haven't already been pipelined.
</p>
<p>A SYNACK payload could serve to advertise support for this, and any other extensions, allowing every request on a connection to use such a scheme when both ends support it.
</p>
<a name="lo"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
The SYNACK Payload Processed Option</h3>

<p>Alternative application protocols that take advantage of data in a SYNACK
  frame necessarily require the application level to know when this
  specification is in effect. To that end, we define an option which signifies
  compliance with this specification to be carried in the SYN and SYNACK
  frames:
</p><br /><hr class="insert" />
<a name="fig-flags"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
+---------------+---------------+
|     Kind =    |  Length = 2   |
| TDB-IANA-KIND1|               |
+---------------+---------------+
</pre></div>
<p>SYNACK Payload Processed Option
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>It is required that both endpoints reach agreement about when this option is
  in effect since it affects the application layer. The next five paragraphs
  deal with this. This specification considers the option to be an optimisation
  however, and a valid agreement might be that the option is not in effect even
  in the case that both endpoints support it. This is to allow implementations
  to back off in the case of possible middleware interactions and overload.
</p>
<p>Hosts MUST NOT include the SYNACK Payload Processed option unless an application
  has requested it for the current socket. If SYNACK Payload Processed is
  requested for a socket, the host SHOULD include the SYNACK Payload Processed
  option.  For example, it may choose not to in the case of having to
  retransmit the SYN frame as middleware may be filtering the extra option.
</p>
<p>Upon receipt of a SYN frame with a SYNACK Payload Processed option, to a valid,
  passive open socket, that socket will have either been configured by an application
  to take advantage of this specification or not. In the case that it has not,
  the host MUST NOT include the SYNACK Payload Processed option in any SYNACK. In
  the case that it has been so configured, the host SHOULD include the
  configured payload in the SYNACK. Iff it chooses to do so, it MUST include the
  SYNACK Payload Processed option.
</p>
<p>For a given connection, for all resulting SYNACK frames, the presence of the
  SYNACK Payload Processed option MUST NOT differ.
</p>
<p>If a host has alternative mechanisms which involve sending payloads in a
  SYNACK frame, they MUST NOT be used concurrently with this specification for
  a given connection. This specification does not prohibit SYNACK frames with
  payloads generated by other means as long as the SYNACK Payload Processed
  option is not included.
</p>
<p>It's expected that a host will make a best effort to include a SYNACK
  payload when the application has set one. It may choose not to for a number
  of reasons including: the SYN frame didn't request it, the host is under
  heavy SYN load, is using SYN cookies or that the host is having to retransmit
  the SYNACK.
</p>
<p>The next four paragraphs seek to establish a minimal basis for application
  protocols to build upon. An implementation may allow applications to set
  arbitrary payloads on a per connection basis, but we expect that most will
  wish to expose a more limited scope. Obviously some of these capabilities,
  such as the inclusion of random bytes, are motivated by the examples above.
</p>
<p>In the case that the SYNACK Payload Processed option is in effect: The data
  payload MUST affect the SEQ/ACK numbers like any other data. Any ACK frame
  resulting from such a SYNACK frame MUST acknowledge the whole SYNACK frame,
  including the SYN flag. If a frame is the final ACK in a 3-way handshake, a
  host MUST reject it unless it acknowledges the whole SYNACK frame.
</p>
<p>A host MUST provide a method for applications to set a SYNACK payload, to
  determine if a passive-open connection sent a SYNACK payload and to determine
  if an active open connection received the SYNACK Payload Processed option in
  the SYNACK frame.
</p>
<p>A host MUST support configuring passive open sockets with at least 64-bytes
  of data. (See "Security Considerations", below).
</p>
<p>A host SHOULD support including at least 8 random bytes in the SYNACK
  payload, at any arbitrary (but within range) byte offset. If it does, the
  random bytes MUST be consistent between retransmissions of the SYNACK frame
  and the host MUST support a method for the application to learn the value of
  the random bytes included in any resulting connection.
</p>
<p>What follows is clarification on some corner cases:
</p>
<p>In the case of a simultaneous open where one or both SYN frames include the
  SYNACK Payload Processed flag, this specification is not in effect. The
  connection continues as usual.
</p>
<p>In the case of a frame carrying the SYNACK Payload Processed option and with
  both SYN and FIN flags set, the host MAY support this specification. In
  practice, many stacks with ignore a FIN flag and any payload in a SYN frame,
  in which case such a packet is no different from any other SYN frame.
</p>
<p>In the case that the MTU makes transmitting the larger SYNACKs problematic,
  the host MAY choose to fragment the packet or it MAY choose not to echo the
  SYNACK Payload Processed option, resulting in a smaller SYNACK frame.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>Any payload in a SYNACK packet must be as frugal as possible since a host
  will be transmitting it to an unconfirmed address. If a 40 byte frame could
  elicit a 1500 byte reply to an attacker controlled address, this would be
  readily used to hide and amplify distributed denial of service attacks.
</p>
<p>Thus we specify a maximum size of 64 bytes for the payload. This is
  sufficient to include a strong elliptic curve key (256 bits), a 64-bit nonce
  and a small amount of overhead (24 bytes).
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Comparison to T/TCP</h3>

<p>The idea of including data in frames which also carry a SYN flag isn't new:
  it was included in the experimental T/TCP RFCs
  <a class='info' href='#RFC1379'>1379<span> (</span><span class='info'>Braden, B., &ldquo;Extending TCP for Transactions -- Concepts,&rdquo; November&nbsp;1992.</span><span>)</span></a> [RFC1379] and
  <a class='info' href='#RFC1644'>1644<span> (</span><span class='info'>Braden, B., &ldquo;T/TCP -- TCP Extensions for Transactions Functional Specification,&rdquo; July&nbsp;1994.</span><span>)</span></a> [RFC1644]. T/TCP suffered because it broke the
  assumption that the source address of a new connection from a passive-open
  socket had been verified by a 3-way handshake. This was a critical security
  issue for applications like RSH which often used source address
  whitelists.
</p>
<p>This draft doesn't break any such assumptions that applications may be
  depending on. Source addresses for new connections are still validated by a
  3-way handshake for passive-open sockets. Additionally, this draft is
  dramatically simpler than T/TCP: it doesn't introduce any additional TCP
  states nor does it deal with the complexity of including payloads in a SYN
  frame. Nor does this draft apply to any application which is unaware of it
  since applications are required to explicitly configure SYNACK payloads
  before they come into effect.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Middlebox Interactions</h3>

<p>

The large number of middleboxes (firewalls, proxies, protocol scrubbers, etc)
currently present in the Internet pose some difficulty for deploying new TCP
options.  Some firewalls may block segments that carry unknown options.  For
instance, if the flags option is not understood by a firewall, incoming SYNs
advertising SYNACK payload support may be dropped, preventing connection
establishment.  This is similar to the ECN blackhole problem, where certain
faulty hosts and routers throw away packets with ECN bits set
<a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a>.  Some recent results indicate that for new TCP
options, this may not be a significant threat, with only 0.2% of web requests
failing when carrying an unknown option <a class='info' href='#transport-middlebox'>[transport&#8209;middlebox]<span> (</span><span class='info'>Medina, A., Allman, M., and S. Floyd, &ldquo;Measuring Interactions Between Transport Protocols and Middleboxes,&rdquo; ACM SIGCOMM/USENIX Internet Measurement Conference, October&nbsp;2004.</span><span>)</span></a>.


</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
IANA Considerations</h3>

<p>This document requires IANA to update values in its registry of TCP options
numbers to assign a new entry, referred herein as
<tt>TBD-IANA-KIND1</tt>.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Acknowledgements</h3>

<p>Wesley Eddy kindly reviewed initial versions of this draft.
</p>
<p>Joe Touch provided many helpful comments.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>13.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC0793">[RFC0793]</a></td>
<td class="author-text">Postel, J., &ldquo;<a href="http://tools.ietf.org/html/rfc793">Transmission Control Protocol</a>,&rdquo; STD&nbsp;7, RFC&nbsp;793, September&nbsp;1981 (<a href="http://www.rfc-editor.org/rfc/rfc793.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>13.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC1379">[RFC1379]</a></td>
<td class="author-text"><a href="mailto:Braden@ISI.EDU">Braden, B.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1379">Extending TCP for Transactions -- Concepts</a>,&rdquo; RFC&nbsp;1379, November&nbsp;1992 (<a href="http://www.rfc-editor.org/rfc/rfc1379.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1644">[RFC1644]</a></td>
<td class="author-text"><a href="mailto:Braden@ISI.EDU">Braden, B.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1644">T/TCP -- TCP Extensions for Transactions Functional Specification</a>,&rdquo; RFC&nbsp;1644, July&nbsp;1994 (<a href="http://www.rfc-editor.org/rfc/rfc1644.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2560">[RFC2560]</a></td>
<td class="author-text"><a href="mailto:mmyers@verisign.com">Myers, M.</a>, <a href="mailto:rankney@erols.com">Ankney, R.</a>, <a href="mailto:ambarish@valicert.com">Malpani, A.</a>, <a href="mailto:galperin@mycfo.com">Galperin, S.</a>, and <a href="mailto:cadams@entrust.com">C. Adams</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2560">X.509 Internet Public Key Infrastructure Online Certificate Status Protocol - OCSP</a>,&rdquo; RFC&nbsp;2560, June&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2560.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2817">[RFC2817]</a></td>
<td class="author-text">Khare, R. and S. Lawrence, &ldquo;<a href="http://tools.ietf.org/html/rfc2817">Upgrading to TLS Within HTTP/1.1</a>,&rdquo; RFC&nbsp;2817, May&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2817.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3168">[RFC3168]</a></td>
<td class="author-text">Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;<a href="http://tools.ietf.org/html/rfc3168">The Addition of Explicit Congestion Notification (ECN) to IP</a>,&rdquo; RFC&nbsp;3168, September&nbsp;2001 (<a href="http://www.rfc-editor.org/rfc/rfc3168.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4253">[RFC4253]</a></td>
<td class="author-text">Ylonen, T. and C. Lonvick, &ldquo;<a href="http://tools.ietf.org/html/rfc4253">The Secure Shell (SSH) Transport Layer Protocol</a>,&rdquo; RFC&nbsp;4253, January&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4253.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4346">[RFC4346]</a></td>
<td class="author-text">Dierks, T. and E. Rescorla, &ldquo;<a href="http://tools.ietf.org/html/rfc4346">The Transport Layer Security (TLS) Protocol Version 1.1</a>,&rdquo; RFC&nbsp;4346, April&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4346.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="curve25519">[curve25519]</a></td>
<td class="author-text">Bernstein, D., &ldquo;<a href="http://cr.yp.to/ecdh/curve25519-20060209.pdf">Curve25519: new Diffie-Hellman speed records</a>.&rdquo;</td></tr>
<tr><td class="author-text" valign="top"><a name="salsa20">[salsa20]</a></td>
<td class="author-text">Bernstein, D., &ldquo;<a href="http://cr.yp.to/snuffle/812.pdf">Salsa20/8 and Salsa20/12</a>.&rdquo;</td></tr>
<tr><td class="author-text" valign="top"><a name="transport-middlebox">[transport-middlebox]</a></td>
<td class="author-text">Medina, A., Allman, M., and S. Floyd, &ldquo;Measuring Interactions Between Transport Protocols and Middleboxes,&rdquo; ACM SIGCOMM/USENIX Internet Measurement Conference, October&nbsp;2004.</td></tr>
<tr><td class="author-text" valign="top"><a name="rangecoding">[rangecoding]</a></td>
<td class="author-text">Martin, G., &ldquo;Range encoding: an algorithm for removing redundancy from a digitized message,&rdquo; Video and Data Recording Conference, July&nbsp;1979.</td></tr>
</table>

<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Changes</h3>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Adam Langley</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Google Inc</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:agl@imperialviolet.org">agl@imperialviolet.org</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
