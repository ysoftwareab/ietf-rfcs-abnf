<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Session Initiation Protocol (SIP) History-Info Header Call Flow Examples </title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Overview">
<link href="#rfc.section.2" rel="Chapter" title="2 Conventions and Terminology">
<link href="#rfc.section.3" rel="Chapter" title="3 Detailed call flows">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Automatic Call Distribution">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Determining the Alias used.">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 PBX Voicemail Example">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Consumer Voicemail Example">
<link href="#rfc.section.3.5" rel="Chapter" title="3.5 GRUU">
<link href="#rfc.section.3.6" rel="Chapter" title="3.6 Limited Use Address">
<link href="#rfc.section.3.7" rel="Chapter" title="3.7 Service Invocation">
<link href="#rfc.section.3.8" rel="Chapter" title="3.8 Toll Free Number">
<link href="#rfc.section.4" rel="Chapter" title="4 Security Considerations">
<link href="#rfc.section.5" rel="Chapter" title="5 IANA Considerations">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="6 References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document describes use cases and documents call flows which require the History-Info header field to capture the Request-URIs as a Session Initiation Protocol (SIP) Request is retargeted.  The use cases are described along with the corresponding call flow diagrams and messaging details.  " />
  <meta name="description" content="This document describes use cases and documents call flows which require the History-Info header field to capture the Request-URIs as a Session Initiation Protocol (SIP) Request is retargeted.  The use cases are described along with the corresponding call flow diagrams and messaging details.  " />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">M. Barnes</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Polycom</td>
</tr>
<tr>
<td class="left">Intended status: Informational</td>
<td class="right">F. Audet</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Skype</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">S.S. Schubert</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">NTT</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">J.F.J. van Elburg</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Detecon International Gmbh</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">C.H. Holmberg</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Ericsson</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Mar 13, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Session Initiation Protocol (SIP) History-Info Header Call Flow Examples <br />
  <span class="filename">draft-barnes-sipcore-rfc4244bis-callflows-01.txt</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document describes use cases and documents call flows which require the History-Info header field to capture the Request-URIs as a Session Initiation Protocol (SIP) Request is retargeted.  The use cases are described along with the corresponding call flow diagrams and messaging details.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Overview</a>
</li>
<li>2.   <a href="#rfc.section.2">Conventions and Terminology</a>
</li>
<li>3.   <a href="#rfc.section.3">Detailed call flows</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Automatic Call Distribution</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Determining the Alias used.</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">PBX Voicemail Example</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Consumer Voicemail Example</a>
</li>
<li>3.5.   <a href="#rfc.section.3.5">GRUU</a>
</li>
<li>3.6.   <a href="#rfc.section.3.6">Limited Use Address</a>
</li>
<li>3.7.   <a href="#rfc.section.3.7">Service Invocation</a>
</li>
<li>3.8.   <a href="#rfc.section.3.8">Toll Free Number</a>
</li>
<li>4.   <a href="#rfc.section.4">Security Considerations</a>
</li>
<li>5.   <a href="#rfc.section.5">IANA Considerations</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Acknowledgements</a>
</li>
<li>6.   <a href="#rfc.references">References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Overview</h1>
<p id="rfc.section.1.p.1">Many services that use SIP require the ability to determine why and how the call arrived at a specific application.  The use cases provided in this document illustrate the use of the History-Info header <a href="#I-D.ietf-sipcore-rfc4244bis">[I-D.ietf-sipcore-rfc4244bis]</a> for example applications and common scenarios.  The optional "rc" and "mp" header field parameters defined in <a href="#I-D.ietf-sipcore-rfc4244bis">[I-D.ietf-sipcore-rfc4244bis]</a> are required for several of the use cases. Descriptions of the example use cases, call flow diagrams and messaging details are provided.  </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Conventions and Terminology</h1>
<p id="rfc.section.2.p.1">The term "retarget" is used as defined in <a href="#I-D.ietf-sipcore-rfc4244bis">[I-D.ietf-sipcore-rfc4244bis]</a>.  The terms "location service", "redirect", "redirect" and "AOR" are used consistent with the terminology in <a href="#RFC3261">[RFC3261]</a>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#callflows" id="callflows">Detailed call flows</a>
</h1>
<p id="rfc.section.3.p.1">The scenarios in this section provide sample use cases for the History-Info header for informational purposes only. They are not intended to be normative.  In many cases, only the relevant messaging details are included in the body of the call flow.</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#acd" id="acd">Automatic Call Distribution</a>
</h1>
<p id="rfc.section.3.1.p.1">This scenario highlights an example of an Automatic Call Distribution service, where the agents are divided into groups based upon the type of customers they handle. In this example, the Gold customers are given higher priority than Silver customers, so a Gold call would get serviced even if all the agents servicing the Gold group were busy, by retargeting the request to the Silver Group for delivery to an agent. Upon receipt of the call at the agent assigned to handle the incoming call, based upon the History-Info header in the message, the application at the agent can provide an indication that this is a Gold call by extracting the hi-entry associated with the incoming request which is determined by locating the hi-entry whose index is reflected in the first hi-entry with an hi-target of "mp".  In the example this would be the hi-entry referenced by the value of the last "mp" header field parameter -i.e., the hi-entry containing an index of "1".  An application can also determine how many groups from which the call may have overflowed before reaching the agent, etc. and present the information to the agent so that the call can be handled appropriately by the agent - i.e., "I'm so sorry for the delay, blah, blah, blah..."</p>
<p id="rfc.section.3.1.p.2">For scenarios whereby calls might overflow from the Silver to the Gold, clearly the alternate group identification, internal routing, or actual agent that handles the call should not be sent to UA1. Thus, for this scenario, one would expect that the Proxy would not support the sending of the History-Info in the response, even if requested by Alice.</p>
<p id="rfc.section.3.1.p.3">As with the other examples, this is not a complete prescription of how one would do this type of service but an example of a subset of processing that might be associated with such a service. In addition, this example is not addressing any aspects of Agent availability resulting in the call being sent to an agent in another group, which might also be done via a SIP interface.</p>
<div id="#rfc.figure.1"></div>
<pre>
Alice       example.com     Gold          Silver       Agent

|              |              |             |            |
| INVITE sip:Gold@example.com |             |            |
|-------------&gt;|              |             |            |
| Supported: histinfo 
|              |              |             |            |
|              |  INVITE sip:Gold@example.com            |
|              |-------------&gt;|             |            |
  History-Info: &lt;sip:Gold@example.com&gt;;index=1
  History-Info: &lt;sip:Gold@gold.example.com&gt;;index=1.1
|              |              |             |            |
|              |  302 Moved Temporarily     |            |
|              |&lt;-------------|             |            |
  History-Info: &lt;sip:Gold@example.com&gt;;index=1
  History-Info: &lt;sip:Gold@gold.example.com&gt;;index=1.1
  Contact: &lt;sip:Silver@example.com&gt;
               |              |             |            |
|              |  INVITE sip:Silver@example.com          |
|              |---------------------------&gt;|            |
  History-Info: &lt;sip:Gold@example.com&gt;;index=1
  History-Info: &lt;sip:Gold@gold.example.com?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1
  History-Info: &lt;sip:Silver@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:Silver@silver.example.com&gt;;index=1.2.1
|              |              |             |            |
|              |              | INVITE sip:Silver@192.0.2.7
|              |              |             |-----------&gt;|
  History-Info: &lt;sip:Gold@example.com&gt;;index=1
  History-Info: &lt;sip:Gold@gold.example.com?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1
  History-Info: &lt;sip:Silver@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:Silver@silver.example.com&gt;;index=1.2.1
  History-Info: &lt;sip:Silver@192.0.2.7&gt;;index=1.2.1.1;rc=1.2.1
|              |              |             |            |
|              |              |             |  200 OK    |
|              |              |             |&lt;-----------|
  History-Info: &lt;sip:Gold@example.com&gt;;index=1
  History-Info: &lt;sip:Gold@gold.example.com?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1
  History-Info: &lt;sip:Silver@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:Silver@silver.example.com&gt;;index=1.2.1
  History-Info: &lt;sip:Silver@192.0.2.7&gt;;index=1.2.1.1;rc=1.2.1
|              |              |             |            |
|              |         200 OK             |            |
|              |&lt;---------------------------|            |
  History-Info: &lt;sip:Gold@example.com&gt;;index=1
  History-Info: &lt;sip:Gold@gold.example.com?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1
  History-Info: &lt;sip:Silver@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:Silver@silver.example.com&gt;;index=1.2.1
  History-Info: &lt;sip:Silver@192.0.2.7&gt;;index=1.2.1.1;rc=1.2.1
|              |              |             |            |
   200 OK      |              |             |            |
|&lt;-------------|              |             |            |
|              |              |             |            |
|    ACK       |              |             |            |
|-------------&gt;|                  ACK                    |
|              |----------------------------------------&gt;|

</pre>
<p id="rfc.section.3.1.p.4">The last hi-entry with the "mp" header field parameter contains a "mp" header field parameter value of 1 which points to the original-target which allows the operator to identify that the call was from the "Gold" customer.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#sec-solvealias" id="sec-solvealias">Determining the Alias used.</a>
</h1>
<p id="rfc.section.3.2.p.1">SIP user agents are associated with an address-of-record (AOR). It is possible for a single UA to actually have multiple AORs associated with it. One common usage for this is aliases. For example, a user might have an AOR of sip:john@example.com but also have the AORs sip:john.smith@example.com and sip:jsmith@example.com. Rather than registering against each of these AORs individually, the user would register against just one of them, and the home proxy would automatically accept incoming calls for any of the aliases, treating them identically and ultimately forwarding them towards the UA. This is common practice in the Internet Multimedia Subsystem (IMS), where it is called implicit registration and each alias is called a public identity.</p>
<p id="rfc.section.3.2.p.2">It is a common requirement for a UAS, on receipt of a call, to know which of its aliases was used to reach it. This knowledge can be used to choose ringtones to play, determine call treatment, and so on. For example, a user might give out one alias to friends and family only, resulting in a special ring that alerts the user to the importance of the call.</p>
<p id="rfc.section.3.2.p.3">The following call-flow and example messages show how History-Info can be used to find out the alias used to reach the callee.  The alias for the call is determined by hi-entry with the index that matches the value of the last hi-entry with a "rc" header field parameter in the Request received.</p>
<div id="#rfc.figure.2"></div>
<div id="#fig-alias"></div>
<pre>
Alice             example.com             Agent1           Agent2
 |                     |                     |               |
 |                     |              REGISTER               |
 |                     |&lt;------------------------------------|
 |                     |                200 OK               |
 |                     |------------------------------------&gt;|
 | INVITE sip:john.smith@example.com         |               |
 |--------------------&gt;|                     |               |
 |                     | INVITE              |               |
 |                     |--------------------&gt;|               |
       History-Info: &lt;sip:john.smith@example.com&gt;;index=1;
       History-Info: &lt;sip:john@192.0.2.1&gt;;index=1.1;rc=1;

 |                     | 180 Ringing         |               |
 |                     |&lt;--------------------|               |
       History-Info: &lt;sip:john.smith@example.com&gt;;index=1;
       History-Info: &lt;sip:john@192.0.2.1&gt;;index=1.1;rc=1;  
 | 180 Ringing         |                     |               |
 |&lt;--------------------|                     |               |
       History-Info: &lt;sip:john.smith@example.com&gt;;index=1;
       History-Info: &lt;sip:john@192.0.2.1&gt;;index=1.1;rc=1;
 |                     | (Time out)          |               | 
 |                     |                 INVITE              | 
 |                     |------------------------------------&gt;|
       History-Info: &lt;sip:john.smith@example.com&gt;;index=1;
       History-Info: &lt;sip:john@192.0.2.1?Reason%3BSIP%3Dcause%3B408&gt;;index=1.1;rc=1;
       History-Info: &lt;sip:john@192.0.2.5&gt;;index=1.2;rc=1;
 |                     |                     |               |
         * Rest of flow not shown *	
                    
</pre>
<p id="rfc.section.3.2.p.4">The last hi-entry with the "rc" header field parameter references the source of retargeting pointing at the alias AoR, which in the example is "john.smith@example.com".  </p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#voicemail" id="voicemail">PBX Voicemail Example</a>
</h1>
<p id="rfc.section.3.3.p.1">A typical use case for voicemail is one whereby the original called party is not reachable and the call arrives at a voicemail system. In some cases multiple alternate destinations may be tried without success. The voicemail system typically requires the original called party information to determine the appropriate mailbox so an appropriate greeting can be provided and the appropriate party notified of the message.  </p>
<p id="rfc.section.3.3.p.2">In this example, Alice calls Bob, whose SIP client is forwarded to Carol. Carol does not answer the call, thus it is forwarded to a VM (voicemail) server (VMS).  In order to determine the appropriate mailbox to use for this call, the VMS needs the original target for the request.  The original target is determined by finding the first hi-entry tagged with "rc" and using the hi-entry referenced by the index of "rc" header field parameter as the target for determining the appropriate mailbox.  This hi-entry is used to populate the "target" URI parameter as defined in <a href="#RFC4458">[RFC4458]</a>.  The reason associated with the first hi-entry tagged with "rc" (i.e., 302) could be used to provide a customized voicemail greeting and is used to populate the "cause" URI parameter as defined in <a href="#RFC4458">[RFC4458]</a>. Note that some VMSs may also (or instead) use the information available in the History-Info headers for custom handling of the VM in terms of how and why the call arrived at the VMS. </p>
<p id="rfc.section.3.3.p.3">Furthermore it is the proxy forwarding the call to VMS that determines the target of the voicemail, it is the proxy that sets the target of voicemail which is also the entity that utilizes RFC4244bis to find the target which is usually based on local policy installed by the user or an administrator.</p>
<div id="#rfc.figure.3"></div>
<pre>
Alice      example.com       Bob          Carol        VM

| INVITE sip:bob@example.com  |             |          |
|-------------&gt;|              |             |          |
|              | INVITE sip:bob@192.0.2.3   |          |
|              |-------------&gt;|             |          |
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3&gt;;index=1.1;rc=1
|              |              |             |          |
|  100 Trying  |              |             |          |
|&lt;-------------| 302 Moved Temporarily      |          |
|              |&lt;-------------|             |          |
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3&gt;; index=1.1;rc=1
  Contact: &lt;sip:carol@example.com&gt;              
|              |              |             |          |
|              | INVITE sip:Carol@192.0.2.4 |          |
|              |---------------------------&gt;|          |
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1;rc=1
  History-Info: &lt;sip:carol@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:carol@192.0.2.4&gt;;index=1.2.1;rc=1.2
|              |              |             |          |
|              |         180 Ringing        |          |
|              |&lt;---------------------------|          |
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1;rc=1
  History-Info: &lt;sip:carol@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:carol@192.0.2.4&gt;;index=1.2.1;rc=1.2
|              |              |             |          |
| 180 Ringing  |              |             |          |
|&lt;-------------|              |             |          |
|              |              |             |          |
|  . . .       |              |             |          |
|              |       (timeout)            |          |
|              |              |             |          |
|              | INVITE sip:vm@192.0.2.5;\             
|              |        target=sip:bob@example.com&gt;;\
|              |        cause=408
|              |--------------------------------------&gt;|
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1;rc=1
  History-Info: &lt;sip:carol@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:carol@192.0.2.4?Reason%3BSIP%3Dcause%3B408&gt;;\
                index=1.2.1;rc=1.2
  History-Info: &lt;sip:vm@example.com;\
                target=sip:bob@example.com;cause=408&gt;\
                index=1.3;mp=1.2
  History-Info: &lt;sip:vm@192.0.2.5;\
                target=sip:bob@example.com;cause=408&gt;\  
                index=1.3.1
|              |              |             |          |
|              |               200 OK                  |
|              |&lt;--------------------------------------|
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1;rc=1
  History-Info: &lt;sip:carol@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:carol@192.0.2.4?Reason%3BSIP%3Dcause%3B408&gt;;\
                index=1.2.1;rc=1.2
  History-Info: &lt;sip:vm@example.com;\
                target=sip:bob@example.com;cause=408&gt;\       
                index=1.3;mp=1.2
  History-Info: &lt;sip:vm@192.0.2.5;\
                target=sip:bob@example.com;cause=408&gt;\
                index=1.3.1
|   200 OK     |              |             |          |
|&lt;-------------|              |             |          |
|              |              |             |          |
|     ACK      |              |             |          |
|-------------&gt;|                    ACK                |
|              |--------------------------------------&gt;|

</pre>
<p id="rfc.section.3.3.p.4">The VMS can look at the last hi-entry and find the target of the mailbox by looking at the URI entry in the "target" URI parameter in the hi-entry.  </p>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> <a href="#voicemailcc" id="voicemailcc">Consumer Voicemail Example</a>
</h1>
<p id="rfc.section.3.4.p.1">In the case of a consumer, when the call is retargeted, it is usually to another administrative domain.  The voicemail system in these environment typically requires the last called party information to determine the appropriate mailbox so an appropriate greeting can be provided and the appropriate party notified of the message.  </p>
<p id="rfc.section.3.4.p.2">In this example, Alice calls the Bob but Bob has temporarily forwarded his phone to Carol because she is his wife.  Carol does not answer the call, thus it is forwarded to a VM (voicemail) server (VMS).  In order to determine the appropriate mailbox to use for this call, the VMS needs the appropriate target for the request.  The last target is determined by finding the hi-entry referenced by the index of last hi-entry tagged with "rc" for determining the appropriate mailbox. This hi-entry is used to populate the "target" URI parameter as defined in <a href="#RFC4458">[RFC4458]</a>.  Note that some VMSs may also (or instead) use the information available in the History-Info headers for custom handling of the VM in terms of how and why the called arrived at the VMS. </p>
<div id="#rfc.figure.4"></div>
<pre>
Alice      example.com       Bob          Carol        VM

| INVITE sip:bob@example.com  |             |          |
|-------------&gt;|              |             |          |
|              | INVITE sip:bob@192.0.2.3   |          |
|              |-------------&gt;|             |          |
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3&gt;;index=1.1;rc=1
|              |              |             |          |
|  100 Trying  |              |             |          |
|&lt;-------------| 302 Moved Temporarily      |          |
|              |&lt;-------------|             |          |
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3&gt;; index=1.1;rc=1
  Contact: &lt;sip:carol@example.com&gt;              
|              |              |             |          |
|              | INVITE sip:Carol@192.0.2.4 |          |
|              |---------------------------&gt;|          |
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1;rc=1
  History-Info: &lt;sip:carol@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:carol@192.0.2.4&gt;;index=1.2.1;rc=1.2
|              |              |             |          |
|              |         180 Ringing        |          |
|              |&lt;---------------------------|          |
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1;rc=1
  History-Info: &lt;sip:carol@example.com&gt;;index=1.2;mp=1
  History-Info: &lt;sip:carol@192.0.2.4&gt;;index=1.2.1;rc=1.2
|              |              |             |          |
| 180 Ringing  |              |             |          |
|&lt;-------------|              |             |          |
|              |              |             |          |
|  . . .       |              |             |          |
|              |       (timeout)            |          |
|              |              |             |          |
|              | INVITE sip:vm@192.0.2.5;\ 
|              |        target=sip:carol@example.com
|              |--------------------------------------&gt;|
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1;rc
  History-Info: &lt;sip:carol@example.com?Reason%3BSIP%3Dcause%3B408&gt;;\
                index=1.2;mp=1
  History-Info: &lt;sip:carol@192.0.2.4&gt;;index=1.2.1;rc=1.2
  History-Info: &lt;sip:vm@example.com;
                 target=sip:carol@example.com&gt;;\
                 index=1.3;mp=1.2              
  History-Info: &lt;sip:vm@192.0.2.5;\
                 target=sip:carol@example.com&gt;;\
                 index=1.3.1
|              |              |             |          |
|              |               200 OK                  |
|              |&lt;--------------------------------------|
  History-Info: &lt;sip:bob@example.com&gt;;index=1
  History-Info: &lt;sip:bob@192.0.2.3?Reason%3BSIP%3Dcause%3B302&gt;;\
                index=1.1;rc
  History-Info: &lt;sip:carol@example.com?Reason%3BSIP%3Dcause%3B408&gt;;\
                index=1.2;mp=1
  History-Info: &lt;sip:carol@192.0.2.4&gt;;index=1.2.1;rc=1.2
  History-Info: &lt;sip:vm@example.com;\
                 target=sip:carol@example.com&gt;;\
                 index=1.3;mp=1.2
  History-Info: &lt;sip:vm@192.0.2.5;\
                 target=sip:carol@example.com&gt;;\
                 index=1.3.1
|   200 OK     |              |             |          |
|&lt;-------------|              |             |          |
|              |              |             |          |
|     ACK      |              |             |          |
|-------------&gt;|                    ACK                |
|              |--------------------------------------&gt;|

</pre>
<p id="rfc.section.3.4.p.3">The VMS can look at the last hi-entry and find the target of the mailbox by looking for the "target" URI parameter in the hi-entry.  </p>
<h1 id="rfc.section.3.5">
<a href="#rfc.section.3.5">3.5.</a> <a href="#sec-solvegruu" id="sec-solvegruu">GRUU</a>
</h1>
<p id="rfc.section.3.5.p.1">A variation on the problem in <a href="#sec-solvealias">Section 3.2</a> occurs with Globally Routable User Agent URI (GRUU) <a href="#RFC5627">[RFC5627]</a>. A GRUU is a URI assigned to a UA instance which has many of the same properties as the AOR, but causes requests to be routed only to that specific instance. It is desirable for a UA to know whether it was reached because a correspondent sent a request to its GRUU or to its AOR. This can be used to drive differing authorization policies on whether the request should be accepted or rejected, for example. However, like the AOR itself, the GRUU is lost in translation at the home proxy. Thus, the UAS cannot know whether it was contacted via the GRUU or its AOR.</p>
<p id="rfc.section.3.5.p.2">Following call-flow and example messages show how History-Info can be used to find out the GRUU used to reach the callee.</p>
<p id="rfc.section.3.5.p.3">While a GRUU is comprised of an AoR with a URI parameter as defined in <a href="#RFC5627">[RFC5627]</a> ,  the GRUU construct itself is not an AoR.  Thus, the retargeting of a request based on a GRUU does not result in the addition of an "rc" header field parameter to the hi-entry containting the GRUU.  The lack of an "rc" header field parameter in the hi-entries can be a hint that the source of retargeting is a GRUU. However, to ensure this is the case, the UAS needs to search for a "gr" parameter in the hi-entry prior to the last hi-entry.  If there is a GRUU, the URI will always be prior to the last hi-entry as GRUU doesn not allow multiple instance to be mapped to a contact address.</p>
<div id="#rfc.figure.5"></div>
<div id="#fig-gruu"></div>
<pre>
       Alice             Example.com             John
       |                     | REGISTER F1         |
       |                     |&lt;--------------------|
       |                     | 200 OK F2           |
       |                     |--------------------&gt;|
       | INVITE F3           |                     |
       |--------------------&gt;|                     |
       |                     | INVITE F4           |
       |                     |--------------------&gt;|
                    * Rest of flow not shown *	

F1 REGISTER John -&gt; Example.com

REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
Max-Forwards: 70
From: John &lt;sip:John@example.com&gt;;tag=a73kszlfl
Supported: gruu
To: John &lt;sip:john@example.com&gt;
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: &lt;sip:john@192.0.2.1&gt;
 ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
Content-Length: 0

F2 200 OK Example.com -&gt; John

SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
From: John &lt;sip:john@example.com&gt;;tag=a73kszlfl
To: John &lt;sip:john@example.com&gt; ;tag=b88sn
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: &lt;sip:john@192.0.2.1&gt;
 ;pub-gruu="sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
 ;temp-gruu=
  "sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr"
 ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
 ;expires=3600
Content-Length: 0

Assuming Alice has a knowledge of a gruu either through 
prior communication or through other means such as presence 
places a call to John's gruu.

F3 INVITE Alice -&gt; Example.com 
 
INVITE sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6 SIP/2.0
Via: SIP/2.0/TCP  192.0.2.3:5060;branch=232sxxeserg
From: Alice &lt;sip:alice@example.com&gt;;tag=kkaz-
To: &lt;sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;
Supported: gruu, histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
History-Info: &lt;sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;;index=1
Contact: Alice &lt;sip:alice@192.0.2.3&gt;
Content-Length: &lt;appropriate value&gt;

F4 INVITE Example.com -&gt; John
  
INVITE sip:john@192.0.2.1 SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060;branch=as2334se
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice &lt;sip:alice@example.com&gt;;tag=kkaz-
To: John &lt;sip:john@example.com&gt;
Supported: gruu, histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: &lt;sip:proxy.example.com;lr&gt;
History-Info: &lt;sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;;index=1
History-Info: &lt;sip:john@192.0.2.1&gt;;index=1.1
Contact: Alice &lt;sip:alice@192.0.2.3&gt;
Content-Type: application/sdp
Content-Length: &lt;appropriate value&gt;
                    
</pre>
<p id="rfc.section.3.5.p.4">The last hi-entry has no "rc" header field parameter which indicates that source of retargeting is likely to be a GRUU. UAS can look for a "gr" URI parameter in the hi-entry prior to the last hi-entry to ensure it is indeed a GRUU.  </p>
<h1 id="rfc.section.3.6">
<a href="#rfc.section.3.6">3.6.</a> <a href="#sec-solvelimit" id="sec-solvelimit">Limited Use Address</a>
</h1>
<p id="rfc.section.3.6.p.1">A limited use address is a SIP URI that is minted on-demand, and passed out to a small number (usually one) remote correspondent.  Incoming calls targeted to that limited use address are accepted as long as the UA still desires communications from the remote target.  Should they no longer wish to be bothered by that remote correspondent, the URI is invalidated so that future requests targeted to it are rejected.</p>
<p id="rfc.section.3.6.p.2">Limited use addresses are used in battling voice spam <a href="#RFC5039">[RFC5039]</a>. The easiest way to provide them would be for a UA to be able to take its AOR, and "mint" a limited use address by appending additional parameters to the URI. It could then give out the URI to a particular correspondent, and remember that URI locally. When an incoming call arrives, the UAS would examine the parameter in the URI and determine whether or not the call should be accepted.  Alternatively, the UA could push authorization rules into the network, so that it need not even see incoming requests that are to be rejected.</p>
<p id="rfc.section.3.6.p.3">This approach, especially when executed on the UA, requires that parameters attached to the AOR, but not used by the home proxy in processing the request, will survive the translation at the home proxy and be presented to the UA. This will not be the case with the logic in RFC 3261, since the Request-URI is replaced by the registered contact, and any such parameters are lost.</p>
<p id="rfc.section.3.6.p.4">Using the history-info John's UA can easily see if the call was addressed to its AoR, GRUU or a temp-gruu and treat the call accordingly by looking for a "gr" tag in the hi-entry prior to the last hi-entry.</p>
<div id="#rfc.figure.6"></div>
<div id="#fig-luae"></div>
<pre>
       Alice             Example.com             John
       |                     | REGISTER F1         |
       |                     |&lt;--------------------|
       |                     | 200 OK F2           |
       |                     |--------------------&gt;|
       | INVITE F3           |                     |
       |--------------------&gt;|                     |
       |                     | INVITE F4           |
       |                     |--------------------&gt;|
                    * Rest of flow not shown *	


F1 REGISTER John -&gt; Example.com

REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
Max-Forwards: 70
From: John &lt;sip:John@example.com&gt;;tag=a73kszlfl
Supported: gruu
To: John &lt;sip:john@example.com&gt;
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: &lt;sip:john@192.0.2.1&gt;
 ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
Content-Length: 0

F2 200 OK Example.com -&gt; John

SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
From: John &lt;sip:john@example.com&gt;;tag=a73kszlfl
To: John &lt;sip:john@example.com&gt; ;tag=b88sn
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: &lt;sip:john@192.0.2.1&gt;
 ;pub-gruu="sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
 ;temp-gruu=
  "sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr"
 ;+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
 ;expires=3600
Content-Length: 0

 Assuming Alice has a knowledge of a temp-gruu, she places a 
 call to the temp-gruu.

F3 INVITE Alice -&gt; Example.com 
 
INVITE sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com
 ;gr SIP/2.0
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice &lt;sip:alice@example.com&gt;;tag=kkaz-
To: &lt;sip:sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com
 ;gr&gt;
Supported: gruu, histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
History-Info: 
 &lt;sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr&gt;
 ;index=1
Contact: Alice &lt;sip:alice@192.0.2.3&gt;
Content-Length: &lt;appropriate value&gt;

F4 INVITE Example.com -&gt; John
 
INVITE sip:john@192.0.2.1 SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060;branch=as2334se
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice &lt;sip:alice@example.com&gt;;tag=kkaz-
To: John &lt;sip:john@example.com&gt;
Supported: gruu, histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: &lt;sip:proxy.example.com;lr&gt;
History-Info: 
 &lt;sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr&gt;
 ;index=1
History-Info: &lt;sip:john@192.0.2.1&gt;;index=1.1
Contact: Alice &lt;sip:alice@192.0.2.3&gt;
Content-Type: application/sdp
Content-Length: &lt;appropriate value&gt;
                    
</pre>
<p id="rfc.section.3.6.p.5">The last hi-entry has no "rc" header field parameter which indicates that source of retargeting is likely to be a GRUU. UAS can look for a "gr" URI parameter in the hi-entry prior to the last hi-entry to ensure it is indeed a GRUU. UAS can further diagnose the URI to see that it's a temp GRUU.  </p>
<h1 id="rfc.section.3.7">
<a href="#rfc.section.3.7">3.7.</a> <a href="#sec-solveservice" id="sec-solveservice">Service Invocation</a>
</h1>
<p id="rfc.section.3.7.p.1">Several SIP specifications have been developed which make use of complex URIs to address services within the network rather than subscribers. The URIs are complex because they contain numerous parameters that control the behavior of the service. Examples of this include the specification which first introduced the concept, <a href="#RFC3087">[RFC3087]</a>, control of network announcements and IVR with SIP URI <a href="#RFC4240">[RFC4240]</a>, and control of voicemail access with SIP URI <a href="#RFC4458">[RFC4458]</a>.</p>
<p id="rfc.section.3.7.p.2">A common problem with all of these mechanisms is that once a proxy has decided to rewrite the Request-URI to point to the service, it cannot be sure that the Request-URI will not be destroyed by a downstream proxy which decides to forward the request in some way, and does so by rewriting the Request-URI.</p>
<p id="rfc.section.3.7.p.3">Section on <a href="#voicemail">voicemail</a> <cite title="NONE">[voicemail]</cite> shows how History-Info can be used to invocate a service.</p>
<h1 id="rfc.section.3.8">
<a href="#rfc.section.3.8">3.8.</a> <a href="#sec-solvetollfree" id="sec-solvetollfree">Toll Free Number</a>
</h1>
<p id="rfc.section.3.8.p.1">Toll free numbers, also known as 800 or 8xx numbers in the United States, are telephone numbers that are free for users to call.</p>
<p id="rfc.section.3.8.p.2">In the telephone network, toll free numbers are just aliases to actual numbers which are used for routing of the call. In order to process the call in the PSTN, a switch will perform a query (using a protocol called TCAP), which will return either a phone number or the identity of a carrier which can handle the call.</p>
<p id="rfc.section.3.8.p.3">There has been recent work on allowing such PSTN translation services to be accessed by SIP proxy servers through IP querying mechanisms. ENUM, for example <a href="#RFC3761">[RFC3761]</a> has already been proposed as a mechanism for performing Local Number Portability (LNP) queries <a href="#RFC4769">[RFC4769]</a>, and recently been proposed for performing calling name queries <a href="#I-D.ietf-enum-cnam">[I-D.ietf-enum-cnam]</a>. Using it for 8xx number translations is a logical next-step.</p>
<p id="rfc.section.3.8.p.4">Once such a translation has been performed, the call needs to be routed towards the target of the request. Normally, this would happen by selecting a PSTN gateway which is a good route towards the translated number. However, one can imagine all-IP systems where the 8xx numbers are SIP endpoints on an IP network, in which case the translation of the 8xx number would actually be a SIP URI and not a phone number. Assuming for the moment it is a PSTN connected entity, the call would be routed towards a PSTN gateway. Proper treatment of the call in the PSTN (and in particular, correct reconciliation of billing records) requires that the call be marked with both the original 8xx number AND the target number for the call. However, in our example here, since the translation was performed by a SIP proxy upstream from the gateway, the original 8xx number would have been lost, and the call will not interwork properly with the PSTN.</p>
<p id="rfc.section.3.8.p.5">Furthermore, even if the translation of the 8xx number was a SIP URI, the enterprise or user who utilize the 8xx service would like to know whether the call came in via 8xx number in order to treat the call differently (for example to play a special announcement..) but if the original R-URI is lost through translation, there is no way to tell if the call came in via 8xx number.</p>
<p id="rfc.section.3.8.p.6">Similar problems arise with other "special" numbers and services used in the PSTN, such as operator services, pay/premium numbers (9xx numbers in the U.S), and short service codes such as 311.</p>
<p id="rfc.section.3.8.p.7">To find the service number, the UAS can extract the hi-entry whose index matches the value of the first hi-entry with an "mp" tag. Technically the call can be forwarded to these "special" numbers from non "special" numbers, however that is uncommon based on the way these services authorize translations.</p>
<div id="#rfc.figure.7"></div>
<div id="#fig-tollfree"></div>
<pre>
      Alice      Toll Free Service   Atlanta.com          John
       |                |              |                   |
       |    INVITE F1   |              |                   |
       |---------------&gt;|   INVITE F2  |                   |
       |                |-------------&gt;|                   |
       |                |              |  INVITE F3        |
       |                |              |------------------&gt;|
     
                    * Rest of flow not shown *	
	
F1: INVITE 192.0.2.1 -&gt; proxy.example.com

INVITE sip:+18005551002@example.com;user=phone  SIP/2.0
Via: SIP/2.0/TCP 192.0.2.1:5060;branch=z9hG4bK-74bf9
From: Alice &lt;sip:+15551001@example.com;user=phone&gt;;tag=9fxced76sl
To: sip:+18005551002@example.com;user=phone
Call-ID: c3x842276298220188511
CSeq: 1 INVITE
Max-Forwards: 70
Supported: histinfo
History-Info: &lt;sip:+18005551002@example.com;user=phone &gt;;index=1 
Contact: &lt;sip:alice@192.0.2.1&gt;
Content-Type: application/sdp
Content-Length: &lt;appropriate value&gt;

[SDP Not Shown]

F2: INVITE proxy.example.com -&gt; atlanta.com

INVITE sip:+15555551002@atlanta.com SIP/2.0
Via: SIP/2.0/TCP 192.0.2.4:5060;branch=z9hG4bK-ik80k7g-1
Via: SIP/2.0/TCP 192.0.2.1:5060;branch=z9hG4bK-74bf9
From: Alice &lt;sip:+15551001@example.com;user=phone&gt;;tag=9fxced76sl
To: sip:+18005551002@example.com;user=phone
Call-ID: c3x842276298220188511
CSeq: 1 INVITE
Max-Forwards: 70
Supported: histinfo
History-Info: &lt;sip:+18005551002@example.com;user=phone &gt;;index=1,
              &lt;sip:+15555551002@atlanta.com&gt;;index=1.1;mp=1
Contact: &lt;sip:alice@192.0.2.1&gt;
Content-Type: application/sdp
Content-Length: &lt;appropriate value&gt;

[SDP Not Shown]

F3: INVITE atlanta.com -&gt; John

INVITE sip:john@198.51.100.2 SIP/2.0
Via: SIP/2.0/TCP 198.51.100.1:5060;branch=z9hG4bK-pxk7g-3
Via: SIP/2.0/TCP 192.0.2.4:5060;branch=z9hG4bK-ik80k7g-1
Via: SIP/2.0/TCP 192.0.2.1:5060;branch=z9hG4bK-74bf9
From: Alice &lt;sip:+15551001@example.com;user=phone&gt;;tag=9fxced76sl
To: sip:+18005551002@example.com;user=phone
Call-ID: c3x842276298220188511
CSeq: 1 INVITE
Max-Forwards: 70
Supported: histinfo
History-Info: &lt;sip:+18005551002@example.com;user=phone &gt;;index=1,
              &lt;sip:+15555551002@atlanta.com&gt;;index=1.1;mp=1,
              &lt;sip:john@atlanta.com&gt;;index=1.1.1,
              &lt;sip:john@198.51.100.2&gt;;index=1.1.2;rc=1.1
Contact: &lt;sip:alice@192.0.2.1&gt;
Content-Type: application/sdp
Content-Length: &lt;appropriate value&gt;

[SDP Not Shown]
                    
</pre>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.4.p.1">The security considerations for the History-Info header field are specified in <a href="#I-D.ietf-sipcore-rfc4244bis">[I-D.ietf-sipcore-rfc4244bis]</a>.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#iana" id="iana">IANA Considerations</a>
</h1>
<p id="rfc.section.5.p.1">This document has no IANA considerations.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Acknowledgements</h1>
<p id="rfc.section.5.1.p.1">Jonathan Rosenberg et al produced the document that provided additional use cases precipitating the requirement for the new "target" parameter in the History-Info header field and the new SIP/SIPS URI parameter. Hadriel Kaplan provided some comments.</p>
<h1 id="rfc.references">
<a href="#rfc.references">6.</a> References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC3261">[RFC3261]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, <a>Schulzrinne, H.</a>, <a>Camarillo, G.</a>, <a>Johnston, A.</a>, <a>Peterson, J.</a>, <a>Sparks, R.</a>, <a>Handley, M.</a> and <a>E. Schooler</a>, "<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>", RFC 3261, June 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3326">[RFC3326]</b></td>
<td class="top">
<a>Schulzrinne, H.</a>, <a>Oran, D.</a> and <a>G. Camarillo</a>, "<a href="http://tools.ietf.org/html/rfc3326">The Reason Header Field for the Session Initiation Protocol (SIP)</a>", RFC 3326, December 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3323">[RFC3323]</b></td>
<td class="top">
<a>Peterson, J.</a>, "<a href="http://tools.ietf.org/html/rfc3323">A Privacy Mechanism for the Session Initiation Protocol (SIP)</a>", RFC 3323, November 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5246">[RFC5246]</b></td>
<td class="top">
<a>Dierks, T.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5246">The Transport Layer Security (TLS) Protocol Version 1.2</a>", RFC 5246, August 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4244">[RFC4244]</b></td>
<td class="top">
<a>Barnes, M.</a>, "<a href="http://tools.ietf.org/html/rfc4244">An Extension to the Session Initiation Protocol (SIP) for Request History Information</a>", RFC 4244, November 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5627">[RFC5627]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, "<a href="http://tools.ietf.org/html/rfc5627">Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP)</a>", RFC 5627, October 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5630">[RFC5630]</b></td>
<td class="top">
<a>Audet, F.</a>, "<a href="http://tools.ietf.org/html/rfc5630">The Use of the SIPS URI Scheme in the Session Initiation Protocol (SIP)</a>", RFC 5630, October 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3087">[RFC3087]</b></td>
<td class="top">
<a>Campbell, B.</a> and <a>R. Sparks</a>, "<a href="http://tools.ietf.org/html/rfc3087">Control of Service Context using SIP Request-URI</a>", RFC 3087, April 2001.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4240">[RFC4240]</b></td>
<td class="top">
<a>Burger, E.</a>, <a>Van Dyke, J.</a> and <a>A. Spitzer</a>, "<a href="http://tools.ietf.org/html/rfc4240">Basic Network Media Services with SIP</a>", RFC 4240, December 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5039">[RFC5039]</b></td>
<td class="top">
<a>Rosenberg, J.</a> and <a>C. Jennings</a>, "<a href="http://tools.ietf.org/html/rfc5039">The Session Initiation Protocol (SIP) and Spam</a>", RFC 5039, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4458">[RFC4458]</b></td>
<td class="top">
<a>Jennings, C.</a>, <a>Audet, F.</a> and <a>J. Elwell</a>, "<a href="http://tools.ietf.org/html/rfc4458">Session Initiation Protocol (SIP) URIs for Applications such as Voicemail and Interactive Voice Response (IVR)</a>", RFC 4458, April 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3761">[RFC3761]</b></td>
<td class="top">
<a>Faltstrom, P.</a> and <a>M. Mealling</a>, "<a href="http://tools.ietf.org/html/rfc3761">The E.164 to Uniform Resource Identifiers (URI) Dynamic Delegation Discovery System (DDDS) Application (ENUM)</a>", RFC 3761, April 2004.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4769">[RFC4769]</b></td>
<td class="top">
<a>Livingood, J.</a> and <a>R. Shockey</a>, "<a href="http://tools.ietf.org/html/rfc4769">IANA Registration for an Enumservice Containing Public Switched Telephone Network (PSTN) Signaling Information</a>", RFC 4769, November 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3969">[RFC3969]</b></td>
<td class="top">
<a>Camarillo, G.</a>, "<a href="http://tools.ietf.org/html/rfc3969">The Internet Assigned Number Authority (IANA) Uniform Resource Identifier (URI) Parameter Registry for the Session Initiation Protocol (SIP)</a>", BCP 99, RFC 3969, December 2004.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-enum-cnam">[I-D.ietf-enum-cnam]</b></td>
<td class="top">
<a>Shockey, R</a>, "<a href="http://tools.ietf.org/html/draft-ietf-enum-cnam-08">IANA Registration for an Enumservice Calling Name Delivery (CNAM) Information and IANA Registration for URI type 'pstndata'</a>", Internet-Draft draft-ietf-enum-cnam-08, September 2008.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-sipcore-rfc4244bis">[I-D.ietf-sipcore-rfc4244bis]</b></td>
<td class="top">
<a>Barnes, M</a>, <a>Audet, F</a>, <a>Schubert, S</a>, <a>Gmbh, D</a> and <a>C Holmberg</a>, "<a href="http://tools.ietf.org/html/draft-ietf-sipcore-rfc4244bis-06">An Extension to the Session Initiation Protocol (SIP) for Request History Information</a>", Internet-Draft draft-ietf-sipcore-rfc4244bis-06, October 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mary Barnes</span> 
	  <span class="n hidden">
		<span class="family-name">Barnes</span>
	  </span>
	</span>
	<span class="org vcardline">Polycom</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region">TX</span> 
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mary.ietf.barnes@gmail.com">mary.ietf.barnes@gmail.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Francois Audet</span> 
	  <span class="n hidden">
		<span class="family-name">Audet</span>
	  </span>
	</span>
	<span class="org vcardline">Skype</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:francois.audet@skype.net">francois.audet@skype.net</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Shida Schubert</span> 
	  <span class="n hidden">
		<span class="family-name">Schubert</span>
	  </span>
	</span>
	<span class="org vcardline">NTT</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region">Tokyo</span> 
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Japan</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:shida@ntt-at.com">shida@ntt-at.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Hans Erik van Elburg</span> 
	  <span class="n hidden">
		<span class="family-name">van Elburg</span>
	  </span>
	</span>
	<span class="org vcardline">Detecon International Gmbh </span>
	<span class="adr">
	  <span>Oberkasseler str. 2 </span>

	  <span class="vcardline">
		<span class="locality">Bonn </span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Germany </span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ietf.hanserik@gmail.com">ietf.hanserik@gmail.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Christer Holmberg</span> 
	  <span class="n hidden">
		<span class="family-name">Holmberg</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality">Hirsalantie 11</span>,  
		<span class="region">Jorvas</span> 
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Finland</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:christer.holmberg@ericsson.com">christer.holmberg@ericsson.com</a></span>

  </address>
</div>

</body>
</html>