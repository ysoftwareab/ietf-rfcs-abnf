<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Content-Type Processing Model</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Content-Type Processing Model">
<meta name="keywords" content="Internet-Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Working Group</td><td class="header">A. Barth</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">U.C. Berkeley</td></tr>
<tr><td class="header">Expires: April 3, 2010</td><td class="header">I. Hickson</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Google, Inc.</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">September 30, 2009</td></tr>
</table></td></tr></table>
<h1><br />Content-Type Processing Model<br />draft-abarth-mime-sniff-03</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on April 3, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>Many web servers supply incorrect Content-Type headers with their
      HTTP responses.  In order to be compatible with these servers, user
      agents consider the content of HTTP responses as well as the
      Content-Type header when determining the effective media type of the
      response.  This document describes an algorithm for determining the
      effective media type of HTTP responses that balances security and
      compatibility considerations.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#intro">1.</a>&nbsp;
Introduction<br />
<a href="#metadata">2.</a>&nbsp;
Metadata<br />
<a href="#web-pages">3.</a>&nbsp;
Web Pages<br />
<a href="#text-or-binary">4.</a>&nbsp;
Text or Binary<br />
<a href="#unknown-type">5.</a>&nbsp;
Unknown Type<br />
<a href="#image">6.</a>&nbsp;
Image<br />
<a href="#feed-or-html">7.</a>&nbsp;
Feed or HTML<br />
<a href="#rfc.references1">8.</a>&nbsp;
References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>The HTTP Content-Type header indicates the media type of an HTTP
      response.  However, many HTTP servers supply a Content-Type that does
      not match the actual contents of the response.  Historically, web
      browsers have been tolerated these servers by examining the content of
      HTTP responses in addition to the Content-Type header to determine the
      effective media type of the response.
</p>
<p>Without a clear specification of how to "sniff" the media type,
      each user agent implementor was forced to reverse engineer the
      behavior of the other user agents and to developed their own
      algorithm.  These divergent algorithms have lead to a lack of
      interoperability between user agents and to security issues when the
      server intends an HTTP response to be interpreted as one media type
      but some user agents interpret the responses as another media
      type.
</p>
<p>These security issues are most severe when an "honest" server lets
      potentially malicious users upload files and then serves the contents
      of those files with a low-privilege media type (such as text/plain or
      image/jpeg).  (Malicious servers, of course, can specify an arbitrary
      media type in the Content-Type header.)  In the absense of mime
      sniffing, this user-generated content would not be interpreted as a
      high-privilege media type, such as text/html.  However, if a user
      agent does interpret a low-privilege media type, such as image/gif, as
      a high-privilege media type, such as text/html, the user agent as
      created a privilege escalation vulnerability in the server.  For
      example, a malicious user might be able to leverage content sniffing
      to mount a cross-site script attack by including JavaScript code in
      the uploaded file that a user agent treats as text/html.
</p>
<p>This document describes a content sniffing algorithm that carefully
      balances the compatibility needs of user agent implementors with the
      security constraints.  The algorithm has been constructed with
      reference to content sniffing algorithms present in popular user
      agents, an extensive database of existing web content, and metrics
      collected from implementations deployed to a sizable number of
      users <a class='info' href='#BarthCaballeroSong2009'>[BarthCaballeroSong2009]<span> (</span><span class='info'>Barth, A., Caballero, J., and D. Song, &ldquo;Secure Content Sniffing for Web Browsers, or How to Stop            Papers from Reviewing Themselves,&rdquo; 2009.</span><span>)</span></a>.
</p>
<p>WARNING!  Whenever possible, user agents should avoid employing a
      content sniffing algorithm.  However, if a user agent does employ a
      content sniffing algorithm, the user agent should use the algorithm in
      this document exactly because using a different content sniffing
      algorithm than servers expect causes security problems.  For example,
      if a server believes that the client will treat a contributed file as
      an image (and thus treat it as benign), but a user agent believes the
      content to be HTML (and thus privileged to execute any scripts
      contained therein), an attacker might be able to steal the user's
      authentication credentials and mount other cross-site scripting
      attacks.
</p>
<a name="metadata"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Metadata</h3>

<p> The explicit Content-Type metadata associated with the resource
      (the resource's type information) depends on the protocol that was
      used to fetch the resource.
</p>
<p>For HTTP resources, only the last Content-Type HTTP header, if
      any, contributes any type information; the official type of the
      resource is then the value of that header, interpreted as described by
      the HTTP specifications.  If the Content-Type HTTP header is present
      but the value of the last such header cannot be interpreted as
      described by the HTTP specifications (e.g. because its value doesn't
      contain a U+002F SOLIDUS ('/') character), then the resource has no
      type information (even if there are multiple Content-Type HTTP headers
      and one of the other ones is syntactically correct).
</p>
<p>For resources fetched from the file system, user agents should use
      platform-specific conventions, e.g. operating system file
      extension/type mappings.
      </p>
<blockquote class="text">
<p>Note: It is essential that file extensions are not used for
        determining the media type for resources fetched over HTTP because
        file extensions can often by supplied by malicious parties.
</p>
</blockquote><p>
      
</p>
<p>For resources fetched over most other protocols, e.g. FTP, there is
      no type information.
</p>
<p>The algorithm for extracting an encoding from a Content-Type, given
      a string s, is as follows. It either returns an encoding or nothing.
      </p>
<ol class="text">
<li>Find the first seven characters in s that are an ASCII
        case-insensitive match for the word "charset". If no such match is
        found, return nothing.
</li>
<li>Skip any U+0009, U+000A, U+000C, U+000D, or U+0020 characters
        that immediately follow the word 'charset' (there might not be
        any).
</li>
<li>If the next character is not a U+003D EQUALS SIGN ('='), return
        nothing.
</li>
<li>Skip any U+0009, U+000A, U+000C, U+000D, or U+0020 characters
        that immediately follow the equals sign (there might not be
        any).
</li>
<li>Process the next character as follows:
        
<ul class="text">
<li>If it is a U+0022 QUOTATION MARK ('"') and there is a later
          U+0022 QUOTATION MARK ('"') in s, or
</li>
<li>If it is a U+0027 APOSTROPHE ("'") and there is a later U+0027
          APOSTROPHE ("'") in s
          
<blockquote class="text">
<p>Return the string between this character and the next
            earliest occurrence of this character.
</p>
</blockquote>
          
</li>
<li>If it is an unmatched U+0022 QUOTATION MARK ('"'),
</li>
<li>If it is an unmatched U+0027 APOSTROPHE ("'"), or
</li>
<li>If there is no next character
          
<blockquote class="text">
<p>Return nothing.
</p>
</blockquote>
          
</li>
<li>Otherwise
          
<blockquote class="text">
<p>Return the string from this character to the first U+0009,
            U+000A, U+000C, U+000D, U+0020, or U+003B character or the end
            of s, whichever comes first.
</p>
</blockquote>
          
</li>
</ul>
        
</li>
</ol><p>
      
</p>
<p>Note: The above algorithm is a willful violation of the HTTP
      specification. [RFC2616]
</p>
<a name="web-pages"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Web Pages</h3>

<p>The /sniffed type/ of a resource is found as follows:
    </p>
<ol class="text">
<li>Let /official type/ be the type given by the Content-Type metadata
      for the resource, ignoring parameters.  Comparisons with this type, as
      defined by MIME specifications, are done in an ASCII case-insensitive
      manner. [RFC2046]
</li>
<li>If the user agent is configured to strictly obey Content-Type
      headers for this resource, then jump to the last step in this set of
      steps.
</li>
<li>If the resource was fetched over an HTTP protocol and there is an
      HTTP Content-Type header and the value of the last such header has
      bytes that exactly match one of the following lines:
        <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    +-------------------------------+--------------------------------+
    | Bytes in Hexadecimal          | Textual Representation         |
    +-------------------------------+--------------------------------+
    | 74 65 78 74 2f 70 6c 61 69 6e | text/plain                     |
    +-------------------------------+--------------------------------+
    | 74 65 78 74 2f 70 6c 61 69 6e | text/plain; charset=ISO-8859-1 |
    | 3b 20 63 68 61 72 73 65 74 3d |                                |
    | 49 53 4f 2d 38 38 35 39 2d 31 |                                |
    +-------------------------------+--------------------------------+
    | 74 65 78 74 2f 70 6c 61 69 6e | text/plain; charset=iso-8859-1 |
    | 3b 20 63 68 61 72 73 65 74 3d |                                |
    | 69 73 6f 2d 38 38 35 39 2d 31 |                                |
    +-------------------------------+--------------------------------+
    | 74 65 78 74 2f 70 6c 61 69 6e | text/plain; charset=UTF-8      |
    | 3b 20 63 68 61 72 73 65 74 3d |                                |
    | 55 54 46 2d 38                |                                |
    +-------------------------------+--------------------------------+
</pre></div>
<p>
            ...then jump to the "text or binary" section below.
          
</p>
      
</li>
<li>If there is no /official type/, jump to the unknown type step
      below.
</li>
<li>If /official type/ is "unknown/unknown", "application/unknown", or
      "*/*", jump to the unknown type step below.
</li>
<li>If /official type/ ends in "+xml", or if it is either "text/xml" or
      "application/xml", then the /sniffed type/ of the resource is
      /official type/; return that and abort these steps.
</li>
<li>If /official type/ is an image type supported by the user agent
      (e.g.  "image/png", "image/gif", "image/jpeg", etc), then jump to the
      "images" section below, passing it the /official type/.
</li>
<li>If /official type/ is "text/html", then jump to the feed or HTML
      section below.
</li>
<li>The /sniffed type/ of the resource is /official type/.
</li>
</ol><p>
    
</p>
<a name="text-or-binary"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Text or Binary</h3>

<p>
      </p>
<ol class="text">
<li>The user agent MAY wait for 512 or more bytes of the resource to
        be available.
</li>
<li>Let n be the smaller of either 512 or the number of bytes already
        available.
</li>
<li>If n is greater than or equal to 3, and the first 2 or 3 bytes of
        the resource match one of the following byte sequences:
          <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                +----------------------+--------------+
                | Bytes in Hexadecimal | Description  |
                +----------------------+--------------+
                | FE FF                | UTF-16BE BOM |
                | FF FE                | UTF-16LE BOM |
                | EF BB BF             | UTF-8 BOM    |
                +----------------------+--------------+
</pre></div>
<p>
              ...then the /sniffed type/ of the resource is "text/plain".
              Abort these steps.
            
</p>
        
</li>
<li>If none of the first n bytes of the resource are binary data
        bytes then the /sniffed type/ of the resource is "text/plain". Abort
        these steps.
          <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                      +-------------------------+
                      | Binary Data Byte Ranges |
                      +-------------------------+
                      | 0x00 -- 0x08            |
                      | 0x0B                    |
                      | 0x0E -- 0x1A            |
                      | 0x1C -- 0x1F            |
                      +-------------------------+
</pre></div>
        
</li>
<li>If the first bytes of the resource match one of the byte
        sequences in the "pattern" column of the table in the unknown type
        section below, ignoring any rows whose cell in the "security" column
        says "scriptable" (or "n/a"), then the /sniffed type/ of the resource
        is the type given in the corresponding cell in the "sniffed type"
        column on that row; abort these steps.
        
<blockquote class="text">
<p>WARNING! It is critical that this step not ever return a
          scriptable type (e.g.  text/html), as otherwise that would allow a
          privilege escalation attack.
</p>
</blockquote>
        
</li>
<li>Otherwise, the /sniffed type/ of the resource is
        "application/octet-stream".
</li>
</ol><p>
      
</p>
<a name="unknown-type"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Unknown Type</h3>

<p>
      </p>
<ol class="text">
<li>The user agent MAY wait for 512 or more bytes of the resource to
        be available.
</li>
<li>Let /stream length/ be the smaller of either 512 or the number of
        bytes already available.
</li>
<li>For each row in the table below:
        
<ul class="text">
<li>If the row has no "WS" bytes:
          
<ol class="text">
<li>Let /pattern length/ be the length of the pattern (number of
            bytes described by the cell in the second column of the
            row).
</li>
<li>If /stream length/ is smaller than /pattern length/ then skip
            this row.
</li>
<li>Apply the "and" operator to the first /pattern length/ bytes of
            the resource and the given mask (the bytes in the cell of first
            column of that row), and let the result be the data.
</li>
<li>If the bytes of the data matches the given pattern bytes
            exactly, then the /sniffed type/ of the resource is the type given
            in the cell of the third column in that row; abort these
            steps.
</li>
</ol>
          
</li>
<li>If the row has a "WS" byte:
          
<ol class="text">
<li>Let /index pattern/ be an index into the mask and pattern
            byte strings of the row.
</li>
<li>Let /index stream/ be an index into the byte stream being
            examined.
</li>
<li>Loop: If /index stream/ points beyond the end of the byte
            stream, then this row doesn't match, skip this row.
</li>
<li>Examine the /index stream/th byte of the byte stream as
            follows:
            
<ul class="text">
<li>If the /index pattern/th byte of the pattern is a normal
              hexadecimal byte and not a "WS" byte:
              
<blockquote class="text">
<p>If the "and" operator, applied to the /index stream/th
                byte of the stream and the /index pattern/th byte of the
                mask, yield a value different that the /index pattern/th
                byte of the pattern, then skip this row.
</p>
<p>Otherwise, increment /index pattern/ to the next byte in
                the mask and pattern and /index stream/ to the next byte in
                the byte stream.
</p>
</blockquote>
              
</li>
<li>Otherwise, if the /index pattern/th byte of the pattern is a
              "WS" byte:
              
<blockquote class="text">
<p>"WS" means "whitespace", and allows insignificant
                whitespace to be skipped when sniffing for a type
                signature.
</p>
<p>If the /index stream/th byte of the stream is one of 0x09
                (ASCII TAB), 0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII
                CR), or 0x20 (ASCII space), then increment only the /index
                stream/ to the next byte in the byte stream.
</p>
<p>Otherwise, increment only the /index pattern/ to the next
                byte in the mask and pattern.
</p>
</blockquote>
              
</li>
</ul>
            
</li>
<li>If /index pattern/ does not point beyond the end of the mask
            and pattern byte strings, then jump back to the loop step in
            this algorithm.
</li>
<li>Otherwise, the /sniffed type/ of the resource is the type given
            in the cell of the third column in that row; abort these
            steps.
</li>
</ol>
          
</li>
</ul>
        
</li>
<li>If none of the first n bytes of the resource are binary data
        bytes then the sniffed type of the resource is "text/plain". Abort
        these steps.
</li>
<li>Otherwise, the sniffed type of the resource is
        "application/octet-stream".
</li>
</ol><p>
      
</p>
<p>The table used by the above algorithm is:
      </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------------------+-------------------+-----------------+------------+
| Mask in Hex       | Pattern in Hex    | Sniffed Type    | Security   |
+-------------------+-------------------+-----------------+------------+
| FF FF FF DF DF DF | WS 3C 21 44 4F 43 | text/html       | Scriptable |
| DF DF DF DF FF DF | 54 59 50 45 20 48 |                 |            |
| DF DF DF          | 54 4D 4C          |                 |            |
| Comment: "&lt;!DOCTYPE HTML", case-insensitive, with leading spaces.    |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 48 54 4D 4C | text/html       | Scriptable |
| Comment: "&lt;HTML", case-insensitive, with leading spaces.             |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 48 45 41 44 | text/html       | Scriptable |
| Comment: "&lt;HEAD", case-insensitive, with leading spaces.             |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 53 43 52 49 | text/html       | Scriptable |
| DF DF             | 50 54             |                 |            |
| Comment: "&lt;SCRIPT", case-insensitive, with leading spaces.           |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 49 46 52 41 | text/html       | Scriptable |
| DF DF             | 4d 45             |                 |            |
| Comment: "&lt;IFRAME", case-insensitive, with leading spaces.           |
+-------------------+-------------------+-----------------+------------+
| FF FF DF FF       | WS 3C 48 31       | text/html       | Scriptable |
| Comment: "&lt;H1", case-insensitive, with leading spaces.               |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF    | WS 3C 44 49 56    | text/html       | Scriptable |
| Comment: "&lt;DIV", case-insensitive, with leading spaces.              |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 46 4f 4e 54 | text/html       | Scriptable |
| Comment: "&lt;FONT", case-insensitive, with leading spaces.             |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 54 41 42 4c | text/html       | Scriptable |
| DF                | 45                |                 |            |
| Comment: "&lt;TABLE", case-insensitive, with leading spaces.            |
+-------------------+-------------------+-----------------+------------+
| FF FF DF          | WS 3C 41          | text/html       | Scriptable |
| Comment: "&lt;A", case-insensitive, with leading spaces.                |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 53 54 59 4c | text/html       | Scriptable |
| DF                | 45                |                 |            |
| Comment: "&lt;STYLE", case-insensitive, with leading spaces.            |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 54 49 54 4c | text/html       | Scriptable |
| DF                | 45                |                 |            |
| Comment: "&lt;TITLE", case-insensitive, with leading spaces.            |
+-------------------+-------------------+-----------------+------------+
| FF FF DF          | WS 3C 42          | text/html       | Scriptable |
| Comment: "&lt;B", case-insensitive, with leading spaces.                |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF DF DF | WS 3C 42 4f 44 59 | text/html       | Scriptable |
| Comment: "&lt;BODY", case-insensitive, with leading spaces.             |
+-------------------+-------------------+-----------------+------------+
| FF FF DF DF       | WS 3C 42 52       | text/html       | Scriptable |
| Comment: "&lt;BR", case-insensitive, with leading spaces.               |
+-------------------+-------------------+-----------------+------------+
| FF FF DF          | WS 3C 50          | text/html       | Scriptable |
| Comment: "&lt;P", case-insensitive, with leading spaces.                |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF FF    | WS 3C 21 2d 2d    | text/html       | Scriptable |
| Comment: The string "&lt;!--", an HTML comment, with leading spaces.    |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF FF FF | WS 3C 3f 78 6d 6c | text/xml        | Scriptable |
| Comment: The string "&lt;?xml", case-sensitive, with leading spaces.    |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF FF    | 25 50 44 46 2D    | application/pdf | Scriptable |
| Comment: The string "%PDF-", the PDF signature.                      |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF FF FF | 25 21 50 53 2D 41 | application/    | Safe       |
| FF FF FF FF FF    | 64 6F 62 65 2D    |      postscript |            |
| Comment: The string "%!PS-Adobe-", the PostScript signature.         |
+-------------------+-------------------+-----------------+------------+
| FF FF 00 00       | FE FF 00 00       | text/plain      | n/a        |
| Comment: UTF-16BE BOM                                                |
+-------------------+-------------------+-----------------+------------+
| FF FF 00 00       | FF FE 00 00       | text/plain      | n/a        |
| Comment: UTF-16LE BOM                                                |
+-------------------+-------------------+-----------------+------------+
| FF FF FF 00       | EF BB BF 00       | text/plain      | n/a        |
| Comment: UTF-8 BOM                                                   |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF FF FF | 47 49 46 38 37 61 | image/gif       | Safe       |
| Comment: The string "GIF87a", a GIF signature.                       |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF FF FF | 47 49 46 38 39 61 | image/gif       | Safe       |
| Comment: The string "GIF89a", a GIF signature.                       |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF FF FF | 89 50 4E 47 0D 0A | image/png       | Safe       |
| FF FF             | 1A 0A             |                 |            |
| Comment: The PNG signature.                                          |
+-------------------+-------------------+-----------------+------------+
| FF FF FF          | FF D8 FF          | image/jpeg      | Safe       |
| Comment: A JPEG SOI marker followed by a byte of another marker.     |
+-------------------+-------------------+-----------------+------------+
| FF FF             | 42 4D             | image/bmp       | Safe       |
| Comment: The string "BM", a BMP signature.                           |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF       | 00 00 01 00       | image/vnd.      | Safe       |
|                   |                   |  microsoft.icon |            |
| Comment: A Windows Icon signature.                                   |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF FF FF | 52 61 72 20 1A 07 | application/    | Safe       |
| FF                | 00                | x-rar-compressed|            |
| Comment: A RAR archive.                                              |
+-------------------+-------------------+-----------------+------------+
| FF FF FF FF       | 50 4B 03 04       | application/zip | Safe       |
| Comment: A ZIP archive.                                              |
+-------------------+-------------------+-----------------+------------+
| FF FF FF          | 1F 8B 08          | application/    | Safe       |
|                   |                   |          x-gzip |            |
| Comment: A GZIP archive.                                             |
+-------------------+-------------------+-----------------+------------+
</pre></div><p>

      
</p>
<p>User agents may support additional types if desired, by implicitly
      adding to the above table.  However, user agents should not use any
      other patterns for types already mentioned in the table above because
      this could then be used for privilege escalation (where, e.g., a server
      uses the above table to determine that content is not HTML and thus
      safe from cross-site scriping attacks, but then a user agent detects
      it as HTML anyway and allows script to execute).
</p>
<p>The column marked "security" is used by the algorithm in the "text
      or binary" section, to avoid sniffing text/plain content as a type
      that can be used for a privilege escalation attack.
</p>
<a name="image"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Image</h3>

<p>If the resource's /official type/ is "image/svg+xml", then the
      /sniffed type/ of the resource is its /official type/ (an XML
      type).
</p>
<p>Otherwise, if the first bytes of the resource match one of the byte
      sequences in the first column of the following table, then the
      /sniffed type/ of the resource is the type given in the corresponding
      cell in the second column on the same row:
      </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  +-------------------------+--------------------------+----------+
  | Bytes in Hexadecimal    | Sniffed Type             | Comment  |
  +-------------------------+--------------------------+----------+
  | 47 49 46 38 37 61       | image/gif                | "GIF87a" |
  | 47 49 46 38 39 61       | image/gif                | "GIF89a" |
  | 89 50 4E 47 0D 0A 1A 0A | image/png                |          |
  | FF D8 FF                | image/jpeg               |          |
  | 42 4D                   | image/bmp                | "BM"     |
  | 00 00 01 00             | image/vnd.microsoft.icon |          |
  +-------------------------+--------------------------+----------+
</pre></div><p>

      
</p>
<p>Otherwise, the /sniffed type/ of the resource is the same as its
      /official type/.
</p>
<a name="feed-or-html"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Feed or HTML</h3>

<p>
      </p>
<ol class="text">
<li>The user agent MAY wait for 512 or more bytes of the resource to
        be available.
</li>
<li>Let s be the stream of bytes, and let s[i] represent the byte in
        s with position i, treating s as zero-indexed (so the first byte is
        at i=0).
</li>
<li>If at any point this algorithm requires the user agent to
        determine the value of a byte in s which is not yet available, or
        which is past the first 512 bytes of the resource, or which is
        beyond the end of the resource, the algorithm stops and the /sniffed
        type/ of the resource is "text/html".
        
<blockquote class="text">
<p>Note: User agents are allowed, by the first step of this
          algorithm, to wait until the first 512 bytes of the resource are
          available.
</p>
</blockquote>
        
</li>
<li>Initialize pos to 0.
</li>
<li>If s[0] equals 0xEF, s[1] equals 0xBB, and s[2] equals 0xBF, then
        set pos to 3. (This skips over a leading UTF-8 BOM, if any.)
</li>
<li>Loop start: Examine s[pos].
        
<ul class="text">
<li>If it equals 0x09 (ASCII tab), 0x20 (ASCII space), 0x0A (ASCII
          LF), or 0x0D (ASCII CR)
          
<blockquote class="text">
<p>Increase pos by 1 and repeat this step.
</p>
</blockquote>
          
</li>
<li>If it equals 0x3C (ASCII "&lt;")
          
<blockquote class="text">
<p>Increase pos by 1 and go to the next step.
</p>
</blockquote>
          
</li>
<li>If it is anything else
          
<blockquote class="text">
<p>The sniffed type of the resource is "text/html". Abort these
            steps.
</p>
</blockquote>
          
</li>
</ul>
        
</li>
<li>If the bytes with positions pos to pos+2 in s are exactly equal
        to 0x21, 0x2D, 0x2D respectively (ASCII for "!--"), then:
        
<ol class="text">
<li>Increase pos by 3.
</li>
<li>If the bytes with positions pos to pos+2 in s are exactly equal
          to 0x2D, 0x2D, 0x3E respectively (ASCII for "--&gt;"), then increase
          pos by 3 and jump back to the previous step (the step labeled loop
          start) in the overall algorithm in this section.
</li>
<li>Otherwise, increase pos by 1.
</li>
<li>Return to step 2 in these substeps.
</li>
</ol>
        
</li>
<li>If s[pos] equals 0x21 (ASCII "!"):
        
<ol class="text">
<li>Increase pos by 1.
</li>
<li>If s[pos] equals 0x3E, then increase pos by 1 and jump back to
          the step labeled loop start in the overall algorithm in this
          section.
</li>
<li>Otherwise, return to step 1 in these substeps.
</li>
</ol>
        
</li>
<li>If s[pos] equals 0x3F (ASCII "?"):
        
<ol class="text">
<li>Increase pos by 1.
</li>
<li>If s[pos] and s[pos+1] equal 0x3F and 0x3E respectively, then
          increase pos by 1 and jump back to the step labeled loop start in
          the overall algorithm in this section.
</li>
<li>Otherwise, return to step 1 in these substeps.
</li>
</ol>
        
</li>
<li>Otherwise, if the bytes in s starting at pos match any of the
        sequences of bytes in the first column of the following table, then
        the user agent must follow the steps given in the corresponding cell
        in the second column of the same row.
        <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+----------------------+------------------------------------+---------+
| Bytes in Hexadecimal | Requirement                        | Comment |
+----------------------+------------------------------------+---------+
| 72 73 73             | The /sniffed type/ of the resource | rss     |
|                      | is "application/rss+xml"; abort    |         |
|                      | these steps.                       |         |
+----------------------+------------------------------------+---------+
| 66 65 65 64          | The /sniffed type/ of the resource | feed    |
|                      | is "application/atom+xml"; abort   |         |
|                      | these steps.                       |         |
+----------------------+------------------------------------+---------+
| 72 64 66 3A 52 44 46 | Continue to the next step in this  | rdf:RDF |
|                      | algorithm.                         |         |
+----------------------+------------------------------------+---------+
</pre></div>
<p>
            If none of the byte sequences above match the bytes in s
            starting at pos, then the /sniffed type/ of the resource is
            "text/html". Abort these steps.
          
</p>
        
</li>
<li>Initialize /RDF flag/ to 0.
</li>
<li>Initialize /RSS flag/ to 0.
</li>
<li>If the bytes with positions pos to pos+23 in s are exactly equal to
        0x68, 0x74, 0x74, 0x70, 0x3A, 0x2F, 0x2F, 0x70, 0x75, 0x72, 0x6C, 0x2E,
        0x6F, 0x72, 0x67, 0x2F, 0x72, 0x73, 0x73, 0x2F, 0x31, 0x2E, 0x30, 0x2F
        respectively (ASCII for "http://purl.org/rss/1.0/"), then:
        
<ol class="text">
<li>Increase pos by 23.
</li>
<li>Set /RSS flag/ to 1.
</li>
</ol>
        
</li>
<li>If the bytes with positions pos to pos+42 in s are exactly equal to
        0x68, 0x74, 0x74, 0x70, 0x3A, 0x2F, 0x2F, 0x77, 0x77, 0x77, 0x2E, 0x77,
        0x33, 0x2E, 0x6F, 0x72, 0x67, 0x2F, 0x31, 0x39, 0x39, 0x39, 0x2F, 0x30,
        0x32, 0x2F, 0x32, 0x32, 0x2D, 0x72, 0x64, 0x66, 0x2D, 0x73, 0x79, 0x6E,
        0x74, 0x61, 0x78, 0x2D, 0x6E, 0x73, 0x23 respectively (ASCII for
        "http://www.w3.org/1999/02/22-rdf-syntax-ns#"), then:
        
<ol class="text">
<li>Increase pos by 42.
</li>
<li>Set /RDF flag/ to 1.
</li>
</ol>
        
</li>
<li>Increase pos by 1.
</li>
<li>If /RDF flag/ is 1 and /RSS flag/ is 1, then the /sniffed type/ of
        the resource is "application/rss+xml". Abort these steps.
</li>
<li>If pos points beyond the end of the byte stream s, then continue to
        step 19 of this algorithm.
</li>
<li>Jump back to step 13 of this algorithm.
</li>
<li>The /sniffed type/ of the resource is "text/html".
</li>
</ol><p>
      
</p>
<p>For efficiency reasons, implementations may wish to implement this
      algorithm and the algorithm for detecting the character encoding of
      HTML documents in parallel.
</p>
<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.&nbsp;References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="BarthCaballeroSong2009">[BarthCaballeroSong2009]</a></td>
<td class="author-text">Barth, A., Caballero, J., and D. Song, &ldquo;<a href="http://www.adambarth.com/papers/2009/barth-caballero-song.pdf">Secure Content Sniffing for Web Browsers, or How to Stop
           Papers from Reviewing Themselves</a>,&rdquo; 2009.</td></tr>
</table>

<p>TODO:
      * Transcribe the tables into C and auto generate the tables.
      * Investigate charset parsing.
    
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Adam Barth</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">University of California, Berkeley</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:abarth@eecs.berkeley.edu">abarth@eecs.berkeley.edu</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.adambarth.com/">http://www.adambarth.com/</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ian Hickson</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Google, Inc.</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ian@hixie.ch">ian@hixie.ch</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://ln.hixie.ch/">http://ln.hixie.ch/</a></td></tr>
</table>
</body></html>
