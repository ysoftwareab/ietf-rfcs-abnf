<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>TLS Encrypted Client Hello</title>
<meta content="Eric Rescorla" name="author">
<meta content="Kazuho Oku" name="author">
<meta content="Nick Sullivan" name="author">
<meta content="Christopher A. Wood" name="author">
<meta content="
       This document describes a mechanism in Transport Layer Security (TLS) for
encrypting a ClientHello message under a server public key. 
    " name="description">
<meta content="xml2rfc 3.5.0" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-ietf-tls-esni-10" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.5.0
    Python 3.6.12
    appdirs 1.4.4
    ConfigArgParse 1.3
    google-i18n-address 2.4.0
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 2.11.3
    kitchen 1.2.6
    lxml 4.6.2
    pycountry 20.7.3
    pyflakes 2.2.0
    PyYAML 5.4.1
    requests 2.25.1
    setuptools 54.0.0
    six 1.15.0
-->
<link href="/tmp/draft-ietf-tls-esni-10-kpdsj_z8.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necssary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: 'Noto Sans', Arial, Helvetica, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre, code {
  background-color: #f9f9f9;
  font-family: 'Roboto Mono', monospace;
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: "Noto Sans",Arial,Helvetica,sans-serif;
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {

    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The follwing is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre, code {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
pre.sourcecode,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact informatio look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background sligthtly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: avoid-page;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottim margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the comact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div:first-child > pre.sourcecode,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<script type="application/javascript">async function addMetadata(){try{const e=document.styleSheets[0].cssRules;for(let t=0;t<e.length;t++)if(/#identifiers/.exec(e[t].selectorText)){const a=e[t].cssText.replace("#identifiers","#external-updates");document.styleSheets[0].insertRule(a,document.styleSheets[0].cssRules.length)}}catch(e){console.log(e)}const e=document.getElementById("external-metadata");if(e)try{var t,a="",o=function(e){const t=document.getElementsByTagName("meta");for(let a=0;a<t.length;a++)if(t[a].getAttribute("name")===e)return t[a].getAttribute("content");return""}("rfc.number");if(o){t="https://www.rfc-editor.org/rfc/rfc"+o+".json";try{const e=await fetch(t);a=await e.json()}catch(e){t=document.URL.indexOf("html")>=0?document.URL.replace(/html$/,"json"):document.URL+".json";const o=await fetch(t);a=await o.json()}}if(!a)return;e.style.display="block";const s="",d="https://datatracker.ietf.org/doc",n="https://datatracker.ietf.org/ipr/search",c="https://www.rfc-editor.org/info",l=a.doc_id.toLowerCase(),i=a.doc_id.slice(0,3).toLowerCase(),f=a.doc_id.slice(3).replace(/^0+/,""),u={status:"Status",obsoletes:"Obsoletes",obsoleted_by:"Obsoleted By",updates:"Updates",updated_by:"Updated By",see_also:"See Also",errata_url:"Errata"};let h="<dl style='overflow:hidden' id='external-updates'>";["status","obsoletes","obsoleted_by","updates","updated_by","see_also","errata_url"].forEach(e=>{if("status"==e){a[e]=a[e].toLowerCase();var t=a[e].split(" "),o=t.length,w="",p=1;for(let e=0;e<o;e++)p<o?w=w+r(t[e])+" ":w+=r(t[e]),p++;a[e]=w}else if("obsoletes"==e||"obsoleted_by"==e||"updates"==e||"updated_by"==e){var g,m="",b=1;g=a[e].length;for(let t=0;t<g;t++)a[e][t]&&(a[e][t]=String(a[e][t]).toLowerCase(),m=b<g?m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>, ":m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>",b++);a[e]=m}else if("see_also"==e){var y,L="",C=1;y=a[e].length;for(let t=0;t<y;t++)if(a[e][t]){a[e][t]=String(a[e][t]);var _=a[e][t].slice(0,3),v=a[e][t].slice(3).replace(/^0+/,"");L=C<y?"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>, ":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>, ":"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>",C++}a[e]=L}else if("errata_url"==e){var R="";R=a[e]?R+"<a href='"+a[e]+"'>Errata exist</a> | <a href='"+d+"/"+l+"'>Datatracker</a>| <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>":"<a href='"+d+"/"+l+"'>Datatracker</a> | <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>",a[e]=R}""!=a[e]?"Errata"==u[e]?h+=`<dt>More info:</dt><dd>${a[e]}</dd>`:h+=`<dt>${u[e]}:</dt><dd>${a[e]}</dd>`:"Errata"==u[e]&&(h+=`<dt>More info:</dt><dd>${a[e]}</dd>`)}),h+="</dl>",e.innerHTML=h}catch(e){console.log(e)}else console.log("Could not locate metadata <div> element");function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}}window.removeEventListener("load",addMetadata),window.addEventListener("load",addMetadata);</script>
</head>
<body>
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">TLS Encrypted Client Hello</td>
<td class="right">March 2021</td>
</tr></thead>
<tfoot><tr>
<td class="left">Rescorla, et al.</td>
<td class="center">Expires 9 September 2021</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">tls</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-tls-esni-10</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2021-03-08" class="published">8 March 2021</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2021-09-09">9 September 2021</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">E. Rescorla</div>
<div class="org">RTFM, Inc.</div>
</div>
<div class="author">
      <div class="author-name">K. Oku</div>
<div class="org">Fastly</div>
</div>
<div class="author">
      <div class="author-name">N. Sullivan</div>
<div class="org">Cloudflare</div>
</div>
<div class="author">
      <div class="author-name">C.A. Wood</div>
<div class="org">Cloudflare</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">TLS Encrypted Client Hello</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes a mechanism in Transport Layer Security (TLS) for
encrypting a ClientHello message under a server public key.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 9 September 2021.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2021 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a><a href="#section-toc.1-1.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="xref">2</a>.  <a href="#name-conventions-and-definitions" class="xref">Conventions and Definitions</a><a href="#section-toc.1-1.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-overview" class="xref">Overview</a><a href="#section-toc.1-1.3.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-topologies" class="xref">Topologies</a><a href="#section-toc.1-1.3.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-encrypted-clienthello-ech" class="xref">Encrypted ClientHello (ECH)</a><a href="#section-toc.1-1.3.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-encrypted-clienthello-confi" class="xref">Encrypted ClientHello Configuration</a><a href="#section-toc.1-1.4.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="xref">4.1</a>.  <a href="#name-configuration-extensions" class="xref">Configuration Extensions</a><a href="#section-toc.1-1.4.2.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-the-encrypted_client_hello-" class="xref">The "encrypted_client_hello" Extension</a><a href="#section-toc.1-1.5.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-encoding-the-clienthelloinn" class="xref">Encoding the ClientHelloInner</a><a href="#section-toc.1-1.5.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-authenticating-the-clienthe" class="xref">Authenticating the ClientHelloOuter</a><a href="#section-toc.1-1.5.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-client-behavior" class="xref">Client Behavior</a><a href="#section-toc.1-1.6.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="xref">6.1</a>.  <a href="#name-offering-ech" class="xref">Offering ECH</a><a href="#section-toc.1-1.6.2.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.6.2.1.2.1">
                    <p id="section-toc.1-1.6.2.1.2.1.1"><a href="#section-6.1.1" class="xref">6.1.1</a>.  <a href="#name-clienthelloinner-indication" class="xref">ClientHelloInner Indication Extension</a><a href="#section-toc.1-1.6.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.6.2.1.2.2">
                    <p id="section-toc.1-1.6.2.1.2.2.1"><a href="#section-6.1.2" class="xref">6.1.2</a>.  <a href="#name-recommended-padding-scheme" class="xref">Recommended Padding Scheme</a><a href="#section-toc.1-1.6.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.6.2.1.2.3">
                    <p id="section-toc.1-1.6.2.1.2.3.1"><a href="#section-6.1.3" class="xref">6.1.3</a>.  <a href="#name-handling-the-server-respons" class="xref">Handling the Server Response</a><a href="#section-toc.1-1.6.2.1.2.3.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.6.2.1.2.4">
                    <p id="section-toc.1-1.6.2.1.2.4.1"><a href="#section-6.1.4" class="xref">6.1.4</a>.  <a href="#name-handling-helloretryrequest" class="xref">Handling HelloRetryRequest</a><a href="#section-toc.1-1.6.2.1.2.4.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="xref">6.2</a>.  <a href="#name-grease-ech" class="xref">GREASE ECH</a><a href="#section-toc.1-1.6.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-server-behavior" class="xref">Server Behavior</a><a href="#section-toc.1-1.7.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="xref">7.1</a>.  <a href="#name-client-facing-server" class="xref">Client-Facing Server</a><a href="#section-toc.1-1.7.2.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.1.2.1">
                    <p id="section-toc.1-1.7.2.1.2.1.1"><a href="#section-7.1.1" class="xref">7.1.1</a>.  <a href="#name-handling-helloretryrequest-2" class="xref">Handling HelloRetryRequest</a><a href="#section-toc.1-1.7.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="xref">7.2</a>.  <a href="#name-backend-server" class="xref">Backend Server</a><a href="#section-toc.1-1.7.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-compatibility-issues" class="xref">Compatibility Issues</a><a href="#section-toc.1-1.8.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="xref">8.1</a>.  <a href="#name-misconfiguration-and-deploy" class="xref">Misconfiguration and Deployment Concerns</a><a href="#section-toc.1-1.8.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="xref">8.2</a>.  <a href="#name-middleboxes" class="xref">Middleboxes</a><a href="#section-toc.1-1.8.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="xref">9</a>.  <a href="#name-compliance-requirements" class="xref">Compliance Requirements</a><a href="#section-toc.1-1.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="xref">10</a>. <a href="#name-security-considerations" class="xref">Security Considerations</a><a href="#section-toc.1-1.10.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="xref">10.1</a>.  <a href="#name-security-and-privacy-goals" class="xref">Security and Privacy Goals</a><a href="#section-toc.1-1.10.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="xref">10.2</a>.  <a href="#name-unauthenticated-and-plainte" class="xref">Unauthenticated and Plaintext DNS</a><a href="#section-toc.1-1.10.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.3">
                <p id="section-toc.1-1.10.2.3.1"><a href="#section-10.3" class="xref">10.3</a>.  <a href="#name-client-tracking" class="xref">Client Tracking</a><a href="#section-toc.1-1.10.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.4">
                <p id="section-toc.1-1.10.2.4.1"><a href="#section-10.4" class="xref">10.4</a>.  <a href="#name-optional-configuration-iden" class="xref">Optional Configuration Identifiers and Trial Decryption</a><a href="#section-toc.1-1.10.2.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5">
                <p id="section-toc.1-1.10.2.5.1"><a href="#section-10.5" class="xref">10.5</a>.  <a href="#name-outer-clienthello" class="xref">Outer ClientHello</a><a href="#section-toc.1-1.10.2.5.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.6">
                <p id="section-toc.1-1.10.2.6.1"><a href="#section-10.6" class="xref">10.6</a>.  <a href="#name-related-privacy-leaks" class="xref">Related Privacy Leaks</a><a href="#section-toc.1-1.10.2.6.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.7">
                <p id="section-toc.1-1.10.2.7.1"><a href="#section-10.7" class="xref">10.7</a>.  <a href="#name-attacks-exploiting-acceptan" class="xref">Attacks Exploiting Acceptance Confirmation</a><a href="#section-toc.1-1.10.2.7.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.8">
                <p id="section-toc.1-1.10.2.8.1"><a href="#section-10.8" class="xref">10.8</a>.  <a href="#name-comparison-against-criteria" class="xref">Comparison Against Criteria</a><a href="#section-toc.1-1.10.2.8.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.8.2.1">
                    <p id="section-toc.1-1.10.2.8.2.1.1"><a href="#section-10.8.1" class="xref">10.8.1</a>.  <a href="#name-mitigate-cut-and-paste-atta" class="xref">Mitigate Cut-and-Paste Attacks</a><a href="#section-toc.1-1.10.2.8.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.8.2.2">
                    <p id="section-toc.1-1.10.2.8.2.2.1"><a href="#section-10.8.2" class="xref">10.8.2</a>.  <a href="#name-avoid-widely-shared-secrets" class="xref">Avoid Widely Shared Secrets</a><a href="#section-toc.1-1.10.2.8.2.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.8.2.3">
                    <p id="section-toc.1-1.10.2.8.2.3.1"><a href="#section-10.8.3" class="xref">10.8.3</a>.  <a href="#name-prevent-sni-based-denial-of" class="xref">Prevent SNI-Based Denial-of-Service Attacks</a><a href="#section-toc.1-1.10.2.8.2.3.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.8.2.4">
                    <p id="section-toc.1-1.10.2.8.2.4.1"><a href="#section-10.8.4" class="xref">10.8.4</a>.  <a href="#name-do-not-stick-out" class="xref">Do Not Stick Out</a><a href="#section-toc.1-1.10.2.8.2.4.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.8.2.5">
                    <p id="section-toc.1-1.10.2.8.2.5.1"><a href="#section-10.8.5" class="xref">10.8.5</a>.  <a href="#name-maintain-forward-secrecy" class="xref">Maintain Forward Secrecy</a><a href="#section-toc.1-1.10.2.8.2.5.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.8.2.6">
                    <p id="section-toc.1-1.10.2.8.2.6.1"><a href="#section-10.8.6" class="xref">10.8.6</a>.  <a href="#name-enable-multi-party-security" class="xref">Enable Multi-party Security Contexts</a><a href="#section-toc.1-1.10.2.8.2.6.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.8.2.7">
                    <p id="section-toc.1-1.10.2.8.2.7.1"><a href="#section-10.8.7" class="xref">10.8.7</a>.  <a href="#name-support-multiple-protocols" class="xref">Support Multiple Protocols</a><a href="#section-toc.1-1.10.2.8.2.7.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.9">
                <p id="section-toc.1-1.10.2.9.1"><a href="#section-10.9" class="xref">10.9</a>.  <a href="#name-padding-policy" class="xref">Padding Policy</a><a href="#section-toc.1-1.10.2.9.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.10">
                <p id="section-toc.1-1.10.2.10.1"><a href="#section-10.10" class="xref">10.10</a>. <a href="#name-active-attack-mitigations" class="xref">Active Attack Mitigations</a><a href="#section-toc.1-1.10.2.10.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.10.2.1">
                    <p id="section-toc.1-1.10.2.10.2.1.1"><a href="#section-10.10.1" class="xref">10.10.1</a>.  <a href="#name-client-reaction-attack-miti" class="xref">Client Reaction Attack Mitigation</a><a href="#section-toc.1-1.10.2.10.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.10.2.2">
                    <p id="section-toc.1-1.10.2.10.2.2.1"><a href="#section-10.10.2" class="xref">10.10.2</a>.  <a href="#name-helloretryrequest-hijack-mi" class="xref">HelloRetryRequest Hijack Mitigation</a><a href="#section-toc.1-1.10.2.10.2.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.10.2.10.2.3">
                    <p id="section-toc.1-1.10.2.10.2.3.1"><a href="#section-10.10.3" class="xref">10.10.3</a>.  <a href="#name-clienthello-malleability-mi" class="xref">ClientHello Malleability Mitigation</a><a href="#section-toc.1-1.10.2.10.2.3.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="xref">11</a>. <a href="#name-iana-considerations" class="xref">IANA Considerations</a><a href="#section-toc.1-1.11.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1" class="xref">11.1</a>.  <a href="#name-update-of-the-tls-extension" class="xref">Update of the TLS ExtensionType Registry</a><a href="#section-toc.1-1.11.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-11.2" class="xref">11.2</a>.  <a href="#name-update-of-the-tls-alert-reg" class="xref">Update of the TLS Alert Registry</a><a href="#section-toc.1-1.11.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="xref">12</a>. <a href="#name-echconfig-extension-guidanc" class="xref">ECHConfig Extension Guidance</a><a href="#section-toc.1-1.12.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="xref">13</a>. <a href="#name-references" class="xref">References</a><a href="#section-toc.1-1.13.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#section-13.1" class="xref">13.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a><a href="#section-toc.1-1.13.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.13.2.2">
                <p id="section-toc.1-1.13.2.2.1"><a href="#section-13.2" class="xref">13.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a><a href="#section-toc.1-1.13.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-appendix.a" class="xref">Appendix A</a>.  <a href="#name-alternative-sni-protection-" class="xref">Alternative SNI Protection Designs</a><a href="#section-toc.1-1.14.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.14.2.1">
                <p id="section-toc.1-1.14.2.1.1"><a href="#section-a.1" class="xref">A.1</a>.  <a href="#name-tls-layer" class="xref">TLS-layer</a><a href="#section-toc.1-1.14.2.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.14.2.1.2.1">
                    <p id="section-toc.1-1.14.2.1.2.1.1"><a href="#section-a.1.1" class="xref">A.1.1</a>.  <a href="#name-tls-in-early-data" class="xref">TLS in Early Data</a><a href="#section-toc.1-1.14.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty toc compact" id="section-toc.1-1.14.2.1.2.2">
                    <p id="section-toc.1-1.14.2.1.2.2.1"><a href="#section-a.1.2" class="xref">A.1.2</a>.  <a href="#name-combined-tickets" class="xref">Combined Tickets</a><a href="#section-toc.1-1.14.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty toc compact" id="section-toc.1-1.14.2.2">
                <p id="section-toc.1-1.14.2.2.1"><a href="#section-a.2" class="xref">A.2</a>.  <a href="#name-application-layer" class="xref">Application-layer</a><a href="#section-toc.1-1.14.2.2.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.14.2.2.2.1">
                    <p id="section-toc.1-1.14.2.2.2.1.1"><a href="#section-a.2.1" class="xref">A.2.1</a>.  <a href="#name-http-2-certificate-frames" class="xref">HTTP/2 CERTIFICATE Frames</a><a href="#section-toc.1-1.14.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-appendix.b" class="xref">Appendix B</a>.  <a href="#name-acknowledgements" class="xref">Acknowledgements</a><a href="#section-toc.1-1.15.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-appendix.c" class="xref">Appendix C</a>.  <a href="#name-change-log" class="xref">Change Log</a><a href="#section-toc.1-1.16.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.16.2.1">
                <p id="section-toc.1-1.16.2.1.1"><a href="#section-c.1" class="xref">C.1</a>.  <a href="#name-since-draft-ietf-tls-esni-0" class="xref">Since draft-ietf-tls-esni-09</a><a href="#section-toc.1-1.16.2.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty toc compact" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#section-appendix.d" class="xref"></a><a href="#name-authors-addresses" class="xref">Authors' Addresses</a><a href="#section-toc.1-1.17.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="intro">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">DISCLAIMER: This draft is work-in-progress and has not yet seen significant (or
really any) security analysis. It should not be used as a basis for building
production systems.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">Although TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span> encrypts most of the handshake, including the
server certificate, there are several ways in which an on-path attacker can
learn private information about the connection. The plaintext Server Name
Indication (SNI) extension in ClientHello messages, which leaks the target
domain for a given connection, is perhaps the most sensitive, unencrypted
information in TLS 1.3.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">The target domain may also be visible through other channels, such as plaintext
client DNS queries, visible server IP addresses (assuming the server does not
use domain-based virtual hosting), or other indirect mechanisms such as traffic
analysis. DoH <span>[<a href="#RFC8484" class="xref">RFC8484</a>]</span> and DPRIVE <span>[<a href="#RFC7858" class="xref">RFC7858</a>]</span>
        <span>[<a href="#RFC8094" class="xref">RFC8094</a>]</span> provide mechanisms for clients to conceal DNS lookups from network
inspection, and many TLS servers host multiple domains on the same IP address.
In such environments, the SNI remains the primary explicit signal used to
determine the server's identity.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">The TLS Working Group has studied the problem of protecting the SNI, but has
been unable to develop a completely generic solution.
<span>[<a href="#RFC8744" class="xref">RFC8744</a>]</span> provides a description of the problem space and
some of the proposed techniques. One of the more difficult problems is "Do not
stick out" (<span>[<a href="#RFC8744" class="xref">RFC8744</a>]</span>, Section 3.4): if only sensitive or
private services use SNI encryption, then SNI encryption is a signal that a
client is going to such a service. For this reason, much recent work has focused
on concealing the fact that the SNI is being protected. Unfortunately, the
result often has undesirable performance consequences, incomplete coverage, or
both.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">The protocol specified by this document takes a different approach. It assumes
that private origins will co-locate with or hide behind a provider (reverse
proxy, application server, etc.) that protects sensitive ClientHello parameters,
including the SNI, for all of the domains it hosts. These co-located servers
form an anonymity set wherein all elements have a consistent configuration,
e.g., the set of supported application protocols, ciphersuites, TLS versions,
and so on. Usage of this mechanism reveals that a client is connecting to a
particular service provider, but does not reveal which server from the anonymity
set terminates the connection. Thus, it leaks no more than what is already
visible from the server IP address.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">This document specifies a new TLS extension, called Encrypted Client Hello
(ECH), that allows clients to encrypt their ClientHello to a supporting server.
This protects the SNI and other potentially sensitive fields, such as the ALPN
list <span>[<a href="#RFC7301" class="xref">RFC7301</a>]</span>. This extension is only supported with (D)TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>
and newer versions of the protocol.<a href="#section-1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
"SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span>
when, and only when, they appear in all capitals, as shown here. All TLS
notation comes from <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 3.<a href="#section-2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="overview">
<section id="section-3">
      <h2 id="name-overview">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-overview" class="section-name selfRef">Overview</a>
      </h2>
<p id="section-3-1">This protocol is designed to operate in one of two topologies illustrated below,
which we call "Shared Mode" and "Split Mode".<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="topologies">
<section id="section-3.1">
        <h3 id="name-topologies">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-topologies" class="section-name selfRef">Topologies</a>
        </h3>
<span id="name-shared-mode-topology"></span><div id="shared-mode">
<figure id="figure-1">
          <div class="artwork art-text alignLeft" id="section-3.1-1.1">
<pre>
                +---------------------+
                |                     |
                |   2001:DB8::1111    |
                |                     |
Client &lt;-----&gt;  | private.example.org |
                |                     |
                | public.example.com  |
                |                     |
                +---------------------+
                        Server
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-shared-mode-topology" class="selfRef">Shared Mode Topology</a>
          </figcaption></figure>
</div>
<p id="section-3.1-2">In Shared Mode, the provider is the origin server for all the domains whose DNS
records point to it. In this mode, the TLS connection is terminated by the
provider.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<span id="name-split-mode-topology"></span><div id="split-mode">
<figure id="figure-2">
          <div class="artwork art-text alignLeft" id="section-3.1-3.1">
<pre>
           +--------------------+     +---------------------+
           |                    |     |                     |
           |   2001:DB8::1111   |     |   2001:DB8::EEEE    |
Client &lt;-----------------------------&gt;|                     |
           | public.example.com |     | private.example.com |
           |                    |     |                     |
           +--------------------+     +---------------------+
            Client-Facing Server            Backend Server
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-split-mode-topology" class="selfRef">Split Mode Topology</a>
          </figcaption></figure>
</div>
<p id="section-3.1-4">In Split Mode, the provider is not the origin server for private domains.
Rather, the DNS records for private domains point to the provider, and the
provider's server relays the connection back to the origin server, who
terminates the TLS connection with the client. Importantly, service provider
does not have access to the plaintext of the connection.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
<p id="section-3.1-5">In the remainder of this document, we will refer to the ECH-service provider as
the "client-facing server" and to the TLS terminator as the "backend server".
These are the same entity in Shared Mode, but in Split Mode, the client-facing
and backend servers are physically separated.<a href="#section-3.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encrypted-clienthello-ech">
<section id="section-3.2">
        <h3 id="name-encrypted-clienthello-ech">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-encrypted-clienthello-ech" class="section-name selfRef">Encrypted ClientHello (ECH)</a>
        </h3>
<p id="section-3.2-1">ECH allows the client to encrypt sensitive ClientHello extensions, e.g., SNI,
ALPN, etc., under the public key of the client-facing server. This requires the
client-facing server to publish the public key and metadata it uses for ECH for
all the domains for which it serves directly or indirectly (via Split Mode).
This document defines the format of the ECH encryption public key and metadata,
referred to as an ECH configuration, and delegates DNS publication details to
<span>[<a href="#HTTPS-RR" class="xref">HTTPS-RR</a>]</span>, though other delivery mechanisms are
possible. In particular, if some of the clients of a private server are
applications rather than Web browsers, those applications might have the public
key and metadata preconfigured.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">When a client wants to establish a TLS session with the backend server, it
constructs its ClientHello as indicated in <a href="#real-ech" class="xref">Section 6.1</a>. We will refer to
this as the ClientHelloInner message. The client encrypts this message using
the public key of the ECH configuration. It then constructs a new ClientHello,
the ClientHelloOuter, with innocuous values for sensitive extensions, e.g., SNI,
ALPN, etc., and with an "encrypted_client_hello" extension, which this document
defines (<a href="#encrypted-client-hello" class="xref">Section 5</a>). The extension's payload carries the
encrypted ClientHelloInner and specifies the ECH configuration used for
encryption. Finally, it sends ClientHelloOuter to the server.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">Upon receiving the ClientHelloOuter, a TLS server takes one of the following
actions:<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3.2-4">
          <li id="section-3.2-4.1">If it does not support ECH, it ignores the "encrypted_client_hello" extension
and proceeds with the handshake as usual, per <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 4.1.2.<a href="#section-3.2-4.1" class="pilcrow">¶</a>
</li>
          <li id="section-3.2-4.2">If it is a client-facing server for the ECH protocol, but cannot decrypt the
extension, then it terminates the handshake using the ClientHelloOuter. This
is referred to as "ECH rejection". When ECH is rejected, the client-facing
server sends an acceptable ECH configuration in its EncryptedExtensions
message.<a href="#section-3.2-4.2" class="pilcrow">¶</a>
</li>
          <li id="section-3.2-4.3">If it supports ECH and decrypts the extension, it forwards the
ClientHelloInner to the backend server, who terminates the connection. This
is referred to as "ECH acceptance".<a href="#section-3.2-4.3" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-3.2-5">Upon receiving the server's response, the client determines whether or not ECH
was accepted and proceeds with the handshake accordingly. (See
<a href="#client-behavior" class="xref">Section 6</a> for details.)<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<p id="section-3.2-6">The primary goal of ECH is to ensure that connections to servers in the same
anonymity set are indistinguishable from one another. Moreover, it should
achieve this goal without affecting any existing security properties of TLS 1.3.
See <a href="#goals" class="xref">Section 10.1</a> for more details about the ECH security and privacy goals.<a href="#section-3.2-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="ech-configuration">
<section id="section-4">
      <h2 id="name-encrypted-clienthello-confi">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-encrypted-clienthello-confi" class="section-name selfRef">Encrypted ClientHello Configuration</a>
      </h2>
<p id="section-4-1">ECH uses draft-08 of HPKE for public key encryption <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span>.
The ECH configuration is defined by the following <code>ECHConfig</code> structure.<a href="#section-4-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-2">
<pre>
    opaque HpkePublicKey&lt;1..2^16-1&gt;;
    uint16 HpkeKemId;  // Defined in I-D.irtf-cfrg-hpke
    uint16 HpkeKdfId;  // Defined in I-D.irtf-cfrg-hpke
    uint16 HpkeAeadId; // Defined in I-D.irtf-cfrg-hpke

    struct {
        HpkeKdfId kdf_id;
        HpkeAeadId aead_id;
    } HpkeSymmetricCipherSuite;

    struct {
        uint8 config_id;
        HpkeKemId kem_id;
        HpkePublicKey public_key;
        HpkeSymmetricCipherSuite cipher_suites&lt;4..2^16-4&gt;;
    } HpkeKeyConfig;

    struct {
        HpkeKeyConfig key_config;
        uint16 maximum_name_length;
        opaque public_name&lt;1..2^16-1&gt;;
        Extension extensions&lt;0..2^16-1&gt;;
    } ECHConfigContents;

    struct {
        uint16 version;
        uint16 length;
        select (ECHConfig.version) {
          case 0xfe0a: ECHConfigContents contents;
        }
    } ECHConfig;
</pre><a href="#section-4-2" class="pilcrow">¶</a>
</div>
<p id="section-4-3">The structure contains the following fields:<a href="#section-4-3" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-4-4">
        <dt id="section-4-4.1">version</dt>
        <dd style="margin-left: 1.5em" id="section-4-4.2">
  The version of ECH for which this configuration is used. Beginning with
draft-08, the version is the same as the code point for the
"encrypted_client_hello" extension. Clients MUST ignore any <code>ECHConfig</code>
structure with a version they do not support.<a href="#section-4-4.2" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-4-4.3">length</dt>
        <dd style="margin-left: 1.5em" id="section-4-4.4">
  The length, in bytes, of the next field.<a href="#section-4-4.4" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-4-4.5">contents</dt>
        <dd style="margin-left: 1.5em" id="section-4-4.6">
  An opaque byte string whose contents depend on the version. For this
specification, the contents are an <code>ECHConfigContents</code> structure.<a href="#section-4-4.6" class="pilcrow">¶</a>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-4-5">The <code>ECHConfigContents</code> structure contains the following fields:<a href="#section-4-5" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-4-6">
        <dt id="section-4-6.1">key_config</dt>
        <dd style="margin-left: 1.5em" id="section-4-6.2">
  A <code>HpkeKeyConfig</code> structure carrying the configuration information associated
with the HPKE public key. Note that this structure contains the <code>config_id</code>
field, which applies to the entire ECHConfigContents. Sites MUST NOT publish
two different <code>ECHConfigContents</code> values with the same <code>HpkeKeyConfig</code> value.
The RECOMMENDED technique for choosing <code>config_id</code> is to choose a random byte.
This process is repeated if this config_id matches that of any valid ECHConfig,
which could include any ECHConfig that has been recently removed from active
use.<a href="#section-4-6.2" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-4-6.3">maximum_name_length</dt>
        <dd style="margin-left: 1.5em" id="section-4-6.4">
  The longest name of a backend server, if known. If this value is not known it
can be set to zero, in which case clients SHOULD use the inner ClientHello
padding scheme described below. That could happen if wildcard names are in use,
or if names can be added or removed from the anonymity set during the lifetime
of a particular ECH configuration.<a href="#section-4-6.4" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-4-6.5">public_name</dt>
        <dd style="margin-left: 1.5em" id="section-4-6.6">
  The non-empty name of the client-facing server, i.e., the entity trusted to
update the ECH configuration. This is used to correct misconfigured clients, as
described in <a href="#handle-server-response" class="xref">Section 6.1.3</a>.<a href="#section-4-6.6" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-4-6.7">extensions</dt>
        <dd style="margin-left: 1.5em" id="section-4-6.8">
  A list of extensions that the client must take into consideration when
generating a ClientHello message. These are described below
(<a href="#config-extensions" class="xref">Section 4.1</a>).<a href="#section-4-6.8" class="pilcrow">¶</a>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-4-7">The <code>HpkeKeyConfig</code> structure contains the following fields:<a href="#section-4-7" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-4-8">
        <dt id="section-4-8.1">config_id</dt>
        <dd style="margin-left: 1.5em" id="section-4-8.2">
  A one-byte identifier for the given HPKE key configuration. This is used by
clients to indicate the key used for ClientHello encryption.<a href="#section-4-8.2" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-4-8.3">kem_id</dt>
        <dd style="margin-left: 1.5em" id="section-4-8.4">
  The HPKE KEM identifier corresponding to <code>public_key</code>. Clients MUST ignore any
<code>ECHConfig</code> structure with a key using a KEM they do not support.<a href="#section-4-8.4" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-4-8.5">public_key</dt>
        <dd style="margin-left: 1.5em" id="section-4-8.6">
  The HPKE public key used by the client to encrypt ClientHelloInner.<a href="#section-4-8.6" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-4-8.7">cipher_suites</dt>
        <dd style="margin-left: 1.5em" id="section-4-8.8">
  The list of HPKE KDF and AEAD identifier pairs clients can use for encrypting
ClientHelloInner.<a href="#section-4-8.8" class="pilcrow">¶</a>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-4-9">The client-facing server advertises a sequence of ECH configurations to clients,
serialized as follows.<a href="#section-4-9" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-10">
<pre>
    ECHConfig ECHConfigList&lt;1..2^16-1&gt;;
</pre><a href="#section-4-10" class="pilcrow">¶</a>
</div>
<p id="section-4-11">The <code>ECHConfigList</code> structure contains one or more <code>ECHConfig</code> structures in
decreasing order of preference. This allows a server to support multiple
versions of ECH and multiple sets of ECH parameters.<a href="#section-4-11" class="pilcrow">¶</a></p>
<div id="config-extensions">
<section id="section-4.1">
        <h3 id="name-configuration-extensions">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-configuration-extensions" class="section-name selfRef">Configuration Extensions</a>
        </h3>
<p id="section-4.1-1">ECH configuration extensions are used to provide room for additional
functionality as needed. See <a href="#config-extensions-guidance" class="xref">Section 12</a> for guidance on
which types of extensions are appropriate for this structure.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2">The format is as defined in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 4.2.
The same interpretation rules apply: extensions MAY appear in any order, but
there MUST NOT be more than one extension of the same type in the extensions
block. An extension can be tagged as mandatory by using an extension type
codepoint with the high order bit set to 1. A client that receives a mandatory
extension they do not understand MUST reject the <code>ECHConfig</code> content.<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1-3">Clients MUST parse the extension list and check for unsupported mandatory
extensions. If an unsupported mandatory extension is present, clients MUST
ignore the <code>ECHConfig</code>.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="encrypted-client-hello">
<section id="section-5">
      <h2 id="name-the-encrypted_client_hello-">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-the-encrypted_client_hello-" class="section-name selfRef">The "encrypted_client_hello" Extension</a>
      </h2>
<p id="section-5-1">The encrypted ClientHelloInner is carried in an "encrypted_client_hello"
extension, defined as follows:<a href="#section-5-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-2">
<pre>
    enum {
       encrypted_client_hello(0xfe0a), (65535)
    } ExtensionType;
</pre><a href="#section-5-2" class="pilcrow">¶</a>
</div>
<p id="section-5-3">When offered by the client, the extension appears only in the ClientHelloOuter.
The payload MUST have the following structure:<a href="#section-5-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-4">
<pre>
    struct {
       HpkeSymmetricCipherSuite cipher_suite;
       uint8 config_id;
       opaque enc&lt;1..2^16-1&gt;;
       opaque payload&lt;1..2^16-1&gt;;
    } ClientECH;
</pre><a href="#section-5-4" class="pilcrow">¶</a>
</div>
<span class="break"></span><dl class="dlParallel" id="section-5-5">
        <dt id="section-5-5.1">config_id</dt>
        <dd style="margin-left: 1.5em" id="section-5-5.2">
  The ECHConfigContents.key_config.config_id for the chosen ECHConfig.<a href="#section-5-5.2" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-5-5.3">cipher_suite</dt>
        <dd style="margin-left: 1.5em" id="section-5-5.4">
  The cipher suite used to encrypt ClientHelloInner. This MUST match a value
provided in the corresponding <code>ECHConfigContents.cipher_suites</code> list.<a href="#section-5-5.4" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-5-5.5">enc</dt>
        <dd style="margin-left: 1.5em" id="section-5-5.6">
  The HPKE encapsulated key, used by servers to decrypt the corresponding
<code>payload</code> field.<a href="#section-5-5.6" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
<dt id="section-5-5.7">payload</dt>
        <dd style="margin-left: 1.5em" id="section-5-5.8">
  The serialized and encrypted ClientHelloInner structure, encrypted using HPKE
as described in <a href="#real-ech" class="xref">Section 6.1</a>.<a href="#section-5-5.8" class="pilcrow">¶</a>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-5-6">When the client offers the "encrypted_client_hello" extension, the server MAY
include an "encrypted_client_hello" extension in its EncryptedExtensions message
with the following payload:<a href="#section-5-6" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-7">
<pre>
    struct {
       ECHConfigList retry_configs;
    } ServerECH;
</pre><a href="#section-5-7" class="pilcrow">¶</a>
</div>
<span class="break"></span><dl class="dlParallel" id="section-5-8">
        <dt id="section-5-8.1">retry_configs</dt>
        <dd style="margin-left: 1.5em" id="section-5-8.2">
  An ECHConfigList structure containing one or more ECHConfig structures, in
decreasing order of preference, to be used by the client in subsequent
connection attempts. These are known as the server's "retry configurations".<a href="#section-5-8.2" class="pilcrow">¶</a>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-5-9">This document also defines the "ech_required" alert, which the client MUST send
when it offered an "encrypted_client_hello" extension that was not accepted by
the server. (See <a href="#alerts" class="xref">Section 11.2</a>.)<a href="#section-5-9" class="pilcrow">¶</a></p>
<div id="encoding-inner">
<section id="section-5.1">
        <h3 id="name-encoding-the-clienthelloinn">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-encoding-the-clienthelloinn" class="section-name selfRef">Encoding the ClientHelloInner</a>
        </h3>
<p id="section-5.1-1">Some TLS 1.3 extensions can be quite large, thus repeating them in the
ClientHelloInner and ClientHelloOuter can lead to an excessive overall size.
One pathological example is "key_share" with post-quantum
algorithms. To reduce the impact of duplicated extensions, the client
may use the "ech_outer_extensions" extension.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.1-2">
<pre>
    enum {
       ech_outer_extensions(0xfd00), (65535)
    } ExtensionType;

    ExtensionType OuterExtensions&lt;2..254&gt;;
</pre><a href="#section-5.1-2" class="pilcrow">¶</a>
</div>
<p id="section-5.1-3">OuterExtensions consists of one or more ExtensionType values, each of which
reference an extension in ClientHelloOuter.<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<p id="section-5.1-4">When sending ClientHello, the client first computes ClientHelloInner, including
any PSK binders. It then computes a new value, the EncodedClientHelloInner, by
first making a copy of ClientHelloInner. It then replaces the
legacy_session_id field with an empty string.<a href="#section-5.1-4" class="pilcrow">¶</a></p>
<p id="section-5.1-5">The client then MAY substitute extensions which it knows will be duplicated in
ClientHelloOuter. To do so, the client removes and replaces extensions from
EncodedClientHelloInner with a single "ech_outer_extensions" extension. Removed
extensions MUST be ordered consecutively in ClientHelloInner. The list of outer
extensions, OuterExtensions, includes those which were removed from
EncodedClientHelloInner, in the order in which they were removed.<a href="#section-5.1-5" class="pilcrow">¶</a></p>
<p id="section-5.1-6">Finally, EncodedClientHelloInner is serialized as a ClientHello structure,
defined in Section 4.1.2 of <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>. Note this does not include the
four-byte header included in the Handshake structure.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<p id="section-5.1-7">The client-facing server computes ClientHelloInner by reversing this process.
First it makes a copy of EncodedClientHelloInner and copies the
legacy_session_id field from ClientHelloOuter. It then looks for an
"ech_outer_extensions" extension. If found, it replaces the extension with the
corresponding sequence of extensions in the ClientHelloOuter. If any referenced
extensions are missing or if "encrypted_client_hello" appears in the list, the
server MUST abort the connection with an "illegal_parameter" alert.<a href="#section-5.1-7" class="pilcrow">¶</a></p>
<p id="section-5.1-8">The "ech_outer_extensions" extension is only used for compressing the
ClientHelloInner. It MUST NOT be sent in either ClientHelloOuter or
ClientHelloInner.<a href="#section-5.1-8" class="pilcrow">¶</a></p>
<p id="section-5.1-9">Note that it is possible to implement decoding of the EncodedClientHelloInner in
a way that creates a denial-of-service vulnerability. Specifically, the server
needs to check that each extension in the OuterExtensions list appears in the
ClientHelloOuter. The naive strategy would require O(N*M) time, where N is the
number of extensions in the ClientHelloOuter and M is the number of extensions
in the OuterExtensions list. Malicious clients could exploit this behavior in
order to cause excessive work for the server, possibly making it unavailable.
This problem can be mitigated by representing OuterExtensions in a way that
allows it to be searched more quickly. For example, the runtime can be improved
to O(N*log(M)) by sorting the OuterExtensions and using binary search to access
it.<a href="#section-5.1-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authenticating-outer">
<section id="section-5.2">
        <h3 id="name-authenticating-the-clienthe">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-authenticating-the-clienthe" class="section-name selfRef">Authenticating the ClientHelloOuter</a>
        </h3>
<p id="section-5.2-1">To prevent a network attacker from modifying the reconstructed ClientHelloInner
(see <a href="#flow-clienthello-malleability" class="xref">Section 10.10.3</a>), ECH authenticates ClientHelloOuter by
computing ClientHelloOuterAAD as described below and passing it in as the
associated data for HPKE sealing and opening operations. ClientHelloOuterAAD has
the following structure:<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5.2-2">
<pre>
   struct {
      HpkeSymmetricCipherSuite cipher_suite;
      uint8 config_id;
      opaque enc&lt;1..2^16-1&gt;;
      opaque outer_hello&lt;1..2^24-1&gt;;
   } ClientHelloOuterAAD;
</pre><a href="#section-5.2-2" class="pilcrow">¶</a>
</div>
<p id="section-5.2-3">The first three parameters are equal to, respectively, the
<code>ClientECH.cipher_suite</code>, <code>ClientECH.config_id</code>, and <code>ClientECH.enc</code> fields of
the payload of the "encrypted_client_hello" extension. The last parameter,
<code>outer_hello</code>, is computed by serializing ClientHelloOuter with the
"encrypted_client_hello" extension removed. Note this does not include the
four-byte header included in the Handshake structure.<a href="#section-5.2-3" class="pilcrow">¶</a></p>
<p id="section-5.2-4">Note the decompression process in <a href="#encoding-inner" class="xref">Section 5.1</a> forbids
"encrypted_client_hello" in OuterExtensions. This ensures the unauthenticated
portion of ClientHelloOuter is not incorporated into ClientHelloInner.<a href="#section-5.2-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="client-behavior">
<section id="section-6">
      <h2 id="name-client-behavior">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-client-behavior" class="section-name selfRef">Client Behavior</a>
      </h2>
<p id="section-6-1">Clients that implement the ECH extension behave in one of two ways: either they
offer a real ECH extension, as described in <a href="#real-ech" class="xref">Section 6.1</a>; or they send a GREASE
ECH extension, as described in <a href="#grease-ech" class="xref">Section 6.2</a>. Clients of the latter type do not
negotiate ECH. Instead, they generate a dummy ECH extension that is ignored by
the server. (See <a href="#dont-stick-out" class="xref">Section 10.8.4</a> for an explanation.) The client offers ECH
if it is in possession of a compatible ECH configuration and sends GREASE ECH
otherwise.<a href="#section-6-1" class="pilcrow">¶</a></p>
<div id="real-ech">
<section id="section-6.1">
        <h3 id="name-offering-ech">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-offering-ech" class="section-name selfRef">Offering ECH</a>
        </h3>
<p id="section-6.1-1">To offer ECH, the client first chooses a suitable ECHConfig from the server's
ECHConfigList. To determine if a given <code>ECHConfig</code> is suitable, it checks that
it supports the KEM algorithm identified by <code>ECHConfig.contents.kem_id</code>, at
least one KDF/AEAD algorithm identified by <code>ECHConfig.contents.cipher_suites</code>,
and the version of ECH indicated by <code>ECHConfig.contents.version</code>. Once a
suitable configuration is found, the client selects the cipher suite it will
use for encryption. It MUST NOT choose a cipher suite or version not advertised
by the configuration. If no compatible configuration is found, then the client
SHOULD proceed as described in <a href="#grease-ech" class="xref">Section 6.2</a>.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<p id="section-6.1-2">Next, the client constructs the ClientHelloInner message just as it does a
standard ClientHello, with the exception of the following rules:<a href="#section-6.1-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1-3">
          <li id="section-6.1-3.1">It MUST NOT offer to negotiate TLS 1.2 or below. This is necessary to ensure
the backend server does not negotiate a TLS version that is incompatible with
ECH.<a href="#section-6.1-3.1" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-3.2">It MUST NOT offer to resume any session for TLS 1.2 and below.<a href="#section-6.1-3.2" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-3.3">It SHOULD contain TLS padding <span>[<a href="#RFC7685" class="xref">RFC7685</a>]</span> as described in <a href="#padding" class="xref">Section 6.1.2</a>.<a href="#section-6.1-3.3" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-3.4">If it intends to compress any extensions (see <a href="#encoding-inner" class="xref">Section 5.1</a>), it MUST
order those extensions consecutively.<a href="#section-6.1-3.4" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-3.5">It MUST include the "ech_is_inner" extension as defined in
<a href="#is-inner" class="xref">Section 6.1.1</a>. (This requirement is not applicable when the
"encrypted_client_hello" extension is generated as described in
<a href="#grease-ech" class="xref">Section 6.2</a>.)<a href="#section-6.1-3.5" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-6.1-4">The client then constructs EncodedClientHelloInner as described in
<a href="#encoding-inner" class="xref">Section 5.1</a>. Finally, it constructs the ClientHelloOuter message just as
it does a standard ClientHello, with the exception of the following rules:<a href="#section-6.1-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1-5">
          <li id="section-6.1-5.1">It MUST offer to negotiate TLS 1.3 or above.<a href="#section-6.1-5.1" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-5.2">If it compressed any extensions in EncodedClientHelloInner, it MUST copy the
corresponding extensions from ClientHelloInner.<a href="#section-6.1-5.2" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-5.3">It MUST ensure that all extensions or parameters in ClientHelloInner that
might change in response to receiving HelloRetryRequest match that in
ClientHelloOuter. See <a href="#client-hrr" class="xref">Section 6.1.4</a> for more information.<a href="#section-6.1-5.3" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-5.4">It MUST copy the legacy_session_id field from ClientHelloInner. This
allows the server to echo the correct session ID for TLS 1.3's compatibility
mode (see Appendix D.4 of <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>) when ECH is negotiated.<a href="#section-6.1-5.4" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-5.5">It MAY copy any other field from the ClientHelloInner except
ClientHelloInner.random. Instead, It MUST generate a fresh
ClientHelloOuter.random using a secure random number generator. (See
<a href="#flow-client-reaction" class="xref">Section 10.10.1</a>.)<a href="#section-6.1-5.5" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-5.6">It MUST include an "encrypted_client_hello" extension with a payload
constructed as described below.<a href="#section-6.1-5.6" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-5.7">The value of <code>ECHConfig.contents.public_name</code> MUST be placed in the
"server_name" extension.<a href="#section-6.1-5.7" class="pilcrow">¶</a>
</li>
          <li id="section-6.1-5.8">It MUST NOT include the "pre_shared_key" extension. (See
<a href="#flow-clienthello-malleability" class="xref">Section 10.10.3</a>.)<a href="#section-6.1-5.8" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-6.1-6">[[OPEN ISSUE: We currently require HRR-sensitive parameters to match in
ClientHelloInner and ClientHelloOuter in order to simplify client-side
logic in the event of HRR. See
https://github.com/tlswg/draft-ietf-tls-esni/pull/316
for more information. We might also solve this by including an explicit
signal in HRR noting ECH acceptance. We need to decide if inner/outer
variance is important for HRR-sensitive parameters, and if so, how to
best deal with it without complicated client logic.]]<a href="#section-6.1-6" class="pilcrow">¶</a></p>
<p id="section-6.1-7">The client might duplicate non-sensitive extensions in both messages. However,
implementations need to take care to ensure that sensitive extensions are not
offered in the ClientHelloOuter. See <a href="#outer-clienthello" class="xref">Section 10.5</a> for additional
guidance.<a href="#section-6.1-7" class="pilcrow">¶</a></p>
<p id="section-6.1-8">To encrypt EncodedClientHelloInner, the client first computes
ClientHelloOuterAAD as described in <a href="#authenticating-outer" class="xref">Section 5.2</a>. Note this
requires the "encrypted_client_hello" be computed after all other extensions.
In particular, this is possible because the "pre_shared_key" extension is
forbidden in ClientHelloOuter.<a href="#section-6.1-8" class="pilcrow">¶</a></p>
<p id="section-6.1-9">The client then generates the HPKE encryption context and computes the
encapsulated key, context, and payload as:<a href="#section-6.1-9" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-6.1-10">
<pre>
    pkR = Deserialize(ECHConfig.contents.public_key)
    enc, context = SetupBaseS(pkR,
                              "tls ech" || 0x00 || ECHConfig)
    payload = context.Seal(ClientHelloOuterAAD,
                           EncodedClientHelloInner)
</pre><a href="#section-6.1-10" class="pilcrow">¶</a>
</div>
<p id="section-6.1-11">Note that the HPKE functions Deserialize and SetupBaseS are those which match
<code>ECHConfig.contents.kem_id</code> and the AEAD/KDF used with <code>context</code> are those which
match the client's chosen preference from <code>ECHConfig.contents.cipher_suites</code>.
The <code>info</code> parameter to SetupBaseS is the concatenation of "tls ech", a zero
byte, and the serialized ECHConfig.<a href="#section-6.1-11" class="pilcrow">¶</a></p>
<p id="section-6.1-12">The value of the "encrypted_client_hello" extension in the ClientHelloOuter is
a <code>ClientECH</code> with the following values:<a href="#section-6.1-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1-13.1">
            <code>config_id</code>, the identifier corresponding to the chosen ECHConfig structure;<a href="#section-6.1-13.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.1-13.2">
            <code>cipher_suite</code>, the client's chosen cipher suite;<a href="#section-6.1-13.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.1-13.3">
            <code>enc</code>, as computed above; and<a href="#section-6.1-13.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.1-13.4">
            <code>payload</code>, as computed above.<a href="#section-6.1-13.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-6.1-14">If optional configuration identifiers (see <a href="#optional-configs" class="xref">Section 10.4</a>)) are used,
<code>config_id</code> SHOULD be set to a randomly generated byte. Unless specified by the
application using (D)TLS or externally configured on both sides,
implementations MUST set the field as specified in
<a href="#encrypted-client-hello" class="xref">Section 5</a>.<a href="#section-6.1-14" class="pilcrow">¶</a></p>
<div id="is-inner">
<section id="section-6.1.1">
          <h4 id="name-clienthelloinner-indication">
<a href="#section-6.1.1" class="section-number selfRef">6.1.1. </a><a href="#name-clienthelloinner-indication" class="section-name selfRef">ClientHelloInner Indication Extension</a>
          </h4>
<p id="section-6.1.1-1">If, in a ClientHello, the "encrypted_client_hello" extension is not present and
an "ech_is_inner" extension is present, the ClientHello is a
ClientHelloInner. This extension MUST only be sent in the ClientHello message.<a href="#section-6.1.1-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-6.1.1-2">
<pre>
    enum {
       ech_is_inner(0xda09), (65535)
    } ExtensionType;
</pre><a href="#section-6.1.1-2" class="pilcrow">¶</a>
</div>
<p id="section-6.1.1-3">The "extension_data" field of the "ech_is_inner" extension is zero
length.<a href="#section-6.1.1-3" class="pilcrow">¶</a></p>
<p id="section-6.1.1-4">Backend servers (as described in <a href="#server-behavior" class="xref">Section 7</a>) MUST support the
"ech_is_inner" extension.<a href="#section-6.1.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="padding">
<section id="section-6.1.2">
          <h4 id="name-recommended-padding-scheme">
<a href="#section-6.1.2" class="section-number selfRef">6.1.2. </a><a href="#name-recommended-padding-scheme" class="section-name selfRef">Recommended Padding Scheme</a>
          </h4>
<p id="section-6.1.2-1">This section describes a deterministic padding mechanism based on the following
observation: individual extensions can reveal sensitive information through
their length. Thus, each extension in the inner ClientHello may require
different amounts of padding. This padding may be fully determined by the
client's configuration or may require server input.<a href="#section-6.1.2-1" class="pilcrow">¶</a></p>
<p id="section-6.1.2-2">By way of example, clients typically support a small number of application
profiles. For instance, a browser might support HTTP with ALPN values
["http/1.1, "h2"] and WebRTC media with ALPNs ["webrtc", "c-webrtc"]. Clients
SHOULD pad this extension by rounding up to the total size of the longest ALPN
extension across all application profiles. The target padding length of most
ClientHello extensions can be computed in this way.<a href="#section-6.1.2-2" class="pilcrow">¶</a></p>
<p id="section-6.1.2-3">In contrast, clients do not know the longest SNI value in the client-facing
server's anonymity set without server input. For the "server_name" extension
with length D, clients SHOULD use the server's length hint L
(ECHConfig.contents.maximum_name_length) when computing the padding as follows:<a href="#section-6.1.2-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1.2-4">
            <li id="section-6.1.2-4.1">If L &gt;= D, add L - D bytes of padding. This rounds to the server's
advertised hint, i.e., ECHConfig.contents.maximum_name_length.<a href="#section-6.1.2-4.1" class="pilcrow">¶</a>
</li>
            <li id="section-6.1.2-4.2">Otherwise, let P = 31 - ((D - 1) % 32), and add P bytes of padding, plus an
additional 32 bytes if D + P &lt; L + 32. This rounds D up to the nearest
multiple of 32 bytes that permits at least 32 bytes of length ambiguity.<a href="#section-6.1.2-4.2" class="pilcrow">¶</a>
</li>
          </ol>
<p id="section-6.1.2-5">In addition to padding ClientHelloInner, clients and servers will also need to
pad all other handshake messages that have sensitive-length fields. For example,
if a client proposes ALPN values in ClientHelloInner, the server-selected value
will be returned in an EncryptedExtension, so that handshake message also needs
to be padded using TLS record layer padding.<a href="#section-6.1.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="handle-server-response">
<section id="section-6.1.3">
          <h4 id="name-handling-the-server-respons">
<a href="#section-6.1.3" class="section-number selfRef">6.1.3. </a><a href="#name-handling-the-server-respons" class="section-name selfRef">Handling the Server Response</a>
          </h4>
<p id="section-6.1.3-1">As described in <a href="#server-behavior" class="xref">Section 7</a>, the server MAY either accept ECH and use
ClientHelloInner or reject it and use ClientHelloOuter. In handling the server's
response, the client's first step is to determine which value was used. The
client presumes acceptance if the last 8 bytes of ServerHello.random are equal
to the first 8 bytes of <code>accept_confirmation</code> as defined in <a href="#backend-server" class="xref">Section 7.2</a>.
Otherwise, it presumes rejection.<a href="#section-6.1.3-1" class="pilcrow">¶</a></p>
<div id="accepted-ech">
<section id="section-6.1.3.1">
            <h5 id="name-accepted-ech">
<a href="#section-6.1.3.1" class="section-number selfRef">6.1.3.1. </a><a href="#name-accepted-ech" class="section-name selfRef">Accepted ECH</a>
            </h5>
<p id="section-6.1.3.1-1">If the server used ClientHelloInner, the client proceeds with the connection as
usual, authenticating the connection for the true server name.<a href="#section-6.1.3.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="rejected-ech">
<section id="section-6.1.3.2">
            <h5 id="name-rejected-ech">
<a href="#section-6.1.3.2" class="section-number selfRef">6.1.3.2. </a><a href="#name-rejected-ech" class="section-name selfRef">Rejected ECH</a>
            </h5>
<p id="section-6.1.3.2-1">If the server used ClientHelloOuter, the client proceeds with the handshake,
authenticating for ECHConfig.contents.public_name as described in
<a href="#auth-public-name" class="xref">Section 6.1.3.3</a>. If authentication or the handshake fails, the client MUST
return a failure to the calling application. It MUST NOT use the retry
configurations.<a href="#section-6.1.3.2-1" class="pilcrow">¶</a></p>
<p id="section-6.1.3.2-2">Otherwise, if both authentication and the handshake complete successfully, the
client MUST abort the connection with an "ech_required" alert. It then
processes the "retry_configs" field from the server's "encrypted_client_hello"
extension.<a href="#section-6.1.3.2-2" class="pilcrow">¶</a></p>
<p id="section-6.1.3.2-3">If at least one of the values contains a version supported by the client, it can
regard the ECH keys as securely replaced by the server. It SHOULD retry the
handshake with a new transport connection, using the retry configurations
supplied by the server. The retry configurations may only be applied to the
retry connection. The client MUST continue to use the previously-advertised
configurations for subsequent connections. This avoids introducing pinning
concerns or a tracking vector, should a malicious server present
client-specific retry configurations in order to identify the client in a
subsequent ECH handshake.<a href="#section-6.1.3.2-3" class="pilcrow">¶</a></p>
<p id="section-6.1.3.2-4">If none of the values provided in "retry_configs" contains a supported version,
the client can regard ECH as securely disabled by the server. As below, it
SHOULD then retry the handshake with a new transport connection and ECH
disabled.<a href="#section-6.1.3.2-4" class="pilcrow">¶</a></p>
<p id="section-6.1.3.2-5">If the field contains any other value, the client MUST abort the connection with
an "illegal_parameter" alert.<a href="#section-6.1.3.2-5" class="pilcrow">¶</a></p>
<p id="section-6.1.3.2-6">If the server negotiates an earlier version of TLS, or if it does not provide an
"encrypted_client_hello" extension in EncryptedExtensions, the client proceeds
with the handshake, authenticating for ECHConfig.contents.public_name as
described in <a href="#auth-public-name" class="xref">Section 6.1.3.3</a>. If an earlier version was negotiated, the
client MUST NOT enable the False Start optimization <span>[<a href="#RFC7918" class="xref">RFC7918</a>]</span> for this
handshake. If authentication or the handshake fails, the client MUST return a
failure to the calling application. It MUST NOT treat this as a secure signal to
disable ECH.<a href="#section-6.1.3.2-6" class="pilcrow">¶</a></p>
<p id="section-6.1.3.2-7">Otherwise, when the handshake completes successfully with the public name
authenticated, the client MUST abort the connection with an "ech_required"
alert. The client can then regard ECH as securely disabled by the server. It
SHOULD retry the handshake with a new transport connection and ECH disabled.<a href="#section-6.1.3.2-7" class="pilcrow">¶</a></p>
<p id="section-6.1.3.2-8">Clients SHOULD implement a limit on retries caused by "ech_retry_request" or
servers which do not acknowledge the "encrypted_client_hello" extension. If the
client does not retry in either scenario, it MUST report an error to the calling
application.<a href="#section-6.1.3.2-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="auth-public-name">
<section id="section-6.1.3.3">
            <h5 id="name-authenticating-for-the-publ">
<a href="#section-6.1.3.3" class="section-number selfRef">6.1.3.3. </a><a href="#name-authenticating-for-the-publ" class="section-name selfRef">Authenticating for the Public Name</a>
            </h5>
<p id="section-6.1.3.3-1">When the server rejects ECH or otherwise ignores "encrypted_client_hello"
extension, it continues with the handshake using the plaintext "server_name"
extension instead (see <a href="#server-behavior" class="xref">Section 7</a>). Clients that offer ECH then
authenticate the connection with the public name, as follows:<a href="#section-6.1.3.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1.3.3-2.1">The client MUST verify that the certificate is valid for
ECHConfig.contents.public_name. If invalid, it MUST abort the connection with
the appropriate alert.<a href="#section-6.1.3.3-2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-6.1.3.3-2.2">If the server requests a client certificate, the client MUST respond with an
empty Certificate message, denoting no client certificate.<a href="#section-6.1.3.3-2.2" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-6.1.3.3-3">Note that authenticating a connection for the public name does not authenticate
it for the origin. The TLS implementation MUST NOT report such connections as
successful to the application. It additionally MUST ignore all session tickets
and session IDs presented by the server. These connections are only used to
trigger retries, as described in <a href="#handle-server-response" class="xref">Section 6.1.3</a>. This may be
implemented, for instance, by reporting a failed connection with a dedicated
error code.<a href="#section-6.1.3.3-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="client-hrr">
<section id="section-6.1.4">
          <h4 id="name-handling-helloretryrequest">
<a href="#section-6.1.4" class="section-number selfRef">6.1.4. </a><a href="#name-handling-helloretryrequest" class="section-name selfRef">Handling HelloRetryRequest</a>
          </h4>
<p id="section-6.1.4-1">As required in <a href="#real-ech" class="xref">Section 6.1</a>, clients offering ECH MUST ensure that all
extensions or parameters that might change in response to receiving a
HelloRetryRequest have the same values in ClientHelloInner and
ClientHelloOuter. That is, if a HelloRetryRequest causes a parameter to be
changed, the same change is applied to both ClientHelloInner and
ClientHelloOuter. Applicable parameters include:<a href="#section-6.1.4-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1.4-2">
            <li id="section-6.1.4-2.1">TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span> ciphersuites in the ClientHello.cipher_suites list.<a href="#section-6.1.4-2.1" class="pilcrow">¶</a>
</li>
            <li id="section-6.1.4-2.2">The "key_share" and "supported_groups" extensions <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>. (These
extensions may be copied from ClientHelloOuter into ClientHelloInner as
described in <a href="#real-ech" class="xref">Section 6.1</a>.)<a href="#section-6.1.4-2.2" class="pilcrow">¶</a>
</li>
            <li id="section-6.1.4-2.3">Versions in the "supported_versions" extension, excluding TLS 1.2 and
earlier. Note the ClientHelloOuter MAY include these older versions, while the
ClientHelloInner MUST omit them.<a href="#section-6.1.4-2.3" class="pilcrow">¶</a>
</li>
          </ol>
<p id="section-6.1.4-3">Future extensions that might change across first and second ClientHello messages
in response to a HelloRetryRequest MUST have the same value.<a href="#section-6.1.4-3" class="pilcrow">¶</a></p>
<p id="section-6.1.4-4">If the server sends a HelloRetryRequest in response to the ClientHello, the
client sends a second updated ClientHello per the rules in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.
However, at this point, the client does not know whether the server processed
ClientHelloOuter or ClientHelloInner, and MUST regenerate both values to be
acceptable. Note: if ClientHelloOuter and ClientHelloInner use different groups
for their key shares or differ in some other way, then the HelloRetryRequest
may actually be invalid for one or the other ClientHello, in which case a fresh
ClientHello MUST be generated, ignoring the instructions in HelloRetryRequest.
Otherwise, the usual rules for HelloRetryRequest processing apply.<a href="#section-6.1.4-4" class="pilcrow">¶</a></p>
<p id="section-6.1.4-5">The client encodes the second ClientHelloInner as in <a href="#encoding-inner" class="xref">Section 5.1</a>, using
the second ClientHelloOuter for any referenced extensions. It then encrypts
the new EncodedClientHelloInner value as a second message with the previous
HPKE context:<a href="#section-6.1.4-5" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-6.1.4-6">
<pre>
    payload = context.Seal(ClientHelloOuterAAD,
                           EncodedClientHelloInner)
</pre><a href="#section-6.1.4-6" class="pilcrow">¶</a>
</div>
<p id="section-6.1.4-7">ClientHelloOuterAAD is computed as described in <a href="#authenticating-outer" class="xref">Section 5.2</a>, but
again using the second ClientHelloOuter. Note that the HPKE context maintains a
sequence number, so this operation internally uses a fresh nonce for each AEAD
operation. Reusing the HPKE context avoids an attack described in
<a href="#flow-hrr-hijack" class="xref">Section 10.10.2</a>.<a href="#section-6.1.4-7" class="pilcrow">¶</a></p>
<p id="section-6.1.4-8">The client then modifies the "encrypted_client_hello" extension in
ClientHelloOuter as follows:<a href="#section-6.1.4-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1.4-9.1">
              <code>config_id</code> is unchanged and contains the <code>config_id</code> corresponding to
the client's chosen ECHConfig.<a href="#section-6.1.4-9.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-6.1.4-9.2">
              <code>cipher_suite</code> is unchanged and contains the client's chosen HPKE cipher
suite.<a href="#section-6.1.4-9.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-6.1.4-9.3">
              <code>enc</code> is replaced with the empty string.<a href="#section-6.1.4-9.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-6.1.4-9.4">
              <code>payload</code> is replaced with the value computed above.<a href="#section-6.1.4-9.4" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-6.1.4-10">If the client offered ECH in the first ClientHello, then it MUST offer ECH in
the second. Likewise, if the client did not offer ECH in the first ClientHello,
then it MUST NOT not offer ECH in the second.<a href="#section-6.1.4-10" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="grease-ech">
<section id="section-6.2">
        <h3 id="name-grease-ech">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-grease-ech" class="section-name selfRef">GREASE ECH</a>
        </h3>
<p id="section-6.2-1">If the client attempts to connect to a server and does not have an ECHConfig
structure available for the server, it SHOULD send a GREASE <span>[<a href="#RFC8701" class="xref">RFC8701</a>]</span>
"encrypted_client_hello" extension in the first ClientHello as follows:<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.2-2.1">Set the <code>config_id</code> field to a random byte.<a href="#section-6.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.2-2.2">Set the <code>cipher_suite</code> field to a supported HpkeSymmetricCipherSuite. The
selection SHOULD vary to exercise all supported configurations, but MAY be
held constant for successive connections to the same server in the same
session.<a href="#section-6.2-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.2-2.3">Set the <code>enc</code> field to a randomly-generated valid encapsulated public key
output by the HPKE KEM.<a href="#section-6.2-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.2-2.4">Set the <code>payload</code> field to a randomly-generated string of L+C bytes, where C
is the ciphertext expansion of the selected AEAD scheme and L is the size of
the EncodedClientHelloInner the client would compute when offering ECH, padded
according to <a href="#padding" class="xref">Section 6.1.2</a>.<a href="#section-6.2-2.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-6.2-3">When sending a second ClientHello in response to a HelloRetryRequest, the
client copies the entire "encrypted_client_hello" extension from the first
ClientHello.<a href="#section-6.2-3" class="pilcrow">¶</a></p>
<p id="section-6.2-4">[[OPEN ISSUE: The above doesn't match HRR handling for either ECH acceptance or
rejection. See issue https://github.com/tlswg/draft-ietf-tls-esni/issues/358.]]<a href="#section-6.2-4" class="pilcrow">¶</a></p>
<p id="section-6.2-5">If the server sends an "encrypted_client_hello" extension, the client MUST check
the extension syntactically and abort the connection with a "decode_error" alert
if it is invalid. It otherwise ignores the extension and MUST NOT use the retry
keys.<a href="#section-6.2-5" class="pilcrow">¶</a></p>
<p id="section-6.2-6">[[OPEN ISSUE: if the client sends a GREASE "encrypted_client_hello" extension,
should it also send a GREASE "pre_shared_key" extension? If not, GREASE+ticket
is a trivial distinguisher.]]<a href="#section-6.2-6" class="pilcrow">¶</a></p>
<p id="section-6.2-7">Offering a GREASE extension is not considered offering an encrypted ClientHello
for purposes of requirements in <a href="#client-behavior" class="xref">Section 6</a>. In particular, the client
MAY offer to resume sessions established without ECH.<a href="#section-6.2-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="server-behavior">
<section id="section-7">
      <h2 id="name-server-behavior">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-server-behavior" class="section-name selfRef">Server Behavior</a>
      </h2>
<p id="section-7-1">Servers that support ECH play one of two roles, depending on which of the
"ech_is_inner" (<a href="#is-inner" class="xref">Section 6.1.1</a>) and "encrypted_client_hello"
(<a href="#encrypted-client-hello" class="xref">Section 5</a>) extensions are present in the ClientHello:<a href="#section-7-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7-2.1">If both the "ech_is_inner" and "encrypted_client_hello" extensions are
present in the ClientHello, the backend server MUST abort with an
"illegal_parameter" alert.<a href="#section-7-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-7-2.2">If only the "encrypted_client_hello" extension is present, the server acts as
a client-facing server and proceeds as described in <a href="#client-facing-server" class="xref">Section 7.1</a>
to extract a ClientHelloInner, if available.<a href="#section-7-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-7-2.3">If only the "ech_is_inner" extension is present and the
"encrypted_client_hello" extension is not present, the server acts as a
backend server and proceeds as described in <a href="#backend-server" class="xref">Section 7.2</a>.<a href="#section-7-2.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-7-2.4">If neither extension is present, the server completes the handshake normally,
as described in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.<a href="#section-7-2.4" class="pilcrow">¶</a>
</li>
      </ul>
<div id="client-facing-server">
<section id="section-7.1">
        <h3 id="name-client-facing-server">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-client-facing-server" class="section-name selfRef">Client-Facing Server</a>
        </h3>
<p id="section-7.1-1">Upon receiving an "encrypted_client_hello" extension in an initial
ClientHello, the client-facing server determines if it will accept ECH, prior
to negotiating any other TLS parameters. Note that successfully decrypting the
extension will result in a new ClientHello to process, so even the client's TLS
version preferences may have changed.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1-2">If the client offers the "ech_is_inner" extension (<a href="#is-inner" class="xref">Section 6.1.1</a>)
in addition to the "encrypted_client_hello" extension, the server MUST abort
with an "illegal_parameter" alert.<a href="#section-7.1-2" class="pilcrow">¶</a></p>
<p id="section-7.1-3">First, the server collects a set of candidate ECHConfig values. This list is
determined by one of the two following methods:<a href="#section-7.1-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-7.1-4">
          <li id="section-7.1-4.1">Compare ClientECH.config_id against identifiers of each known ECHConfig
and select the ones that match, if any, as candidates.<a href="#section-7.1-4.1" class="pilcrow">¶</a>
</li>
          <li id="section-7.1-4.2">Collect all known ECHConfig values as candidates, with trial decryption
below determining the final selection.<a href="#section-7.1-4.2" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-7.1-5">Some uses of ECH, such as local discovery mode, may randomize the
ClientECH.config_id since it can be used as a tracking vector. In such cases,
the second method should be used for matching ClientECH to known ECHConfig. See
<a href="#optional-configs" class="xref">Section 10.4</a>. Unless specified by the application using (D)TLS or
externally configured on both sides, implementations MUST use the first method.<a href="#section-7.1-5" class="pilcrow">¶</a></p>
<p id="section-7.1-6">The server then iterates over the candidate ECHConfig values, attempting to
decrypt the "encrypted_client_hello" extension:<a href="#section-7.1-6" class="pilcrow">¶</a></p>
<p id="section-7.1-7">The server verifies that the ECHConfig supports the cipher suite indicated by
the ClientECH.cipher_suite and that the version of ECH indicated by the client
matches the ECHConfig.version. If not, the server continues to the next
candidate ECHConfig.<a href="#section-7.1-7" class="pilcrow">¶</a></p>
<p id="section-7.1-8">Next, the server decrypts ClientECH.payload, using the private key skR
corresponding to ECHConfig, as follows:<a href="#section-7.1-8" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.1-9">
<pre>
    context = SetupBaseR(ClientECH.enc, skR,
                         "tls ech" || 0x00 || ECHConfig)
    EncodedClientHelloInner = context.Open(ClientHelloOuterAAD,
                                           ClientECH.payload)
</pre><a href="#section-7.1-9" class="pilcrow">¶</a>
</div>
<p id="section-7.1-10">ClientHelloOuterAAD is computed from ClientHelloOuter as described in
<a href="#authenticating-outer" class="xref">Section 5.2</a>. The <code>info</code> parameter to SetupBaseS is the
concatenation "tls ech", a zero byte, and the serialized ECHConfig. If
decryption fails, the server continues to the next candidate ECHConfig.
Otherwise, the server reconstructs ClientHelloInner from
EncodedClientHelloInner, as described in <a href="#encoding-inner" class="xref">Section 5.1</a>. It then stops
iterating over the candidate ECHConfig values.<a href="#section-7.1-10" class="pilcrow">¶</a></p>
<p id="section-7.1-11">Upon determining the ClientHelloInner, the client-facing server then forwards
the ClientHelloInner to the appropriate backend server, which proceeds as in
<a href="#backend-server" class="xref">Section 7.2</a>. If the backend server responds with a HelloRetryRequest,
the client-facing server forwards it, decrypts the client's second
ClientHelloOuter using the procedure in <a href="#server-hrr" class="xref">Section 7.1.1</a>, and forwards the
resulting second ClientHelloInner. The client-facing server forwards all other
TLS messages between the client and backend server unmodified.<a href="#section-7.1-11" class="pilcrow">¶</a></p>
<p id="section-7.1-12">Otherwise, if all candidate ECHConfig values fail to decrypt the extension, the
client-facing server MUST ignore the extension and proceed with the connection
using ClientHelloOuter. This connection proceeds as usual, except the server
MUST include the "encrypted_client_hello" extension in its EncryptedExtensions
with the "retry_configs" field set to one or more ECHConfig structures with
up-to-date keys. Servers MAY supply multiple ECHConfig values of different
versions. This allows a server to support multiple versions at once.<a href="#section-7.1-12" class="pilcrow">¶</a></p>
<p id="section-7.1-13">Note that decryption failure could indicate a GREASE ECH extension (see
<a href="#grease-ech" class="xref">Section 6.2</a>), so it is necessary for servers to proceed with the connection
and rely on the client to abort if ECH was required. In particular, the
unrecognized value alone does not indicate a misconfigured ECH advertisement
(<a href="#misconfiguration" class="xref">Section 8.1</a>). Instead, servers can measure occurrences of the
"ech_required" alert to detect this case.<a href="#section-7.1-13" class="pilcrow">¶</a></p>
<div id="server-hrr">
<section id="section-7.1.1">
          <h4 id="name-handling-helloretryrequest-2">
<a href="#section-7.1.1" class="section-number selfRef">7.1.1. </a><a href="#name-handling-helloretryrequest-2" class="section-name selfRef">Handling HelloRetryRequest</a>
          </h4>
<p id="section-7.1.1-1">After sending or forwarding a HelloRetryRequest, the client-facing server does
not repeat the steps in <a href="#client-facing-server" class="xref">Section 7.1</a> with the second
ClientHelloOuter. Instead, it continues with the ECHConfig selection from the
first ClientHelloOuter as follows:<a href="#section-7.1.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1.1-2">If the client-facing server accepted ECH, it checks the second ClientHelloOuter
also contains the "encrypted_client_hello" extension. If not, it MUST abort the
handshake with a "missing_extension" alert. Otherwise, it checks that
ClientECH.cipher_suite and ClientECH.config_id are unchanged, and that
ClientECH.enc is empty. If not, it MUST abort the handshake with an
"illegal_parameter" alert.<a href="#section-7.1.1-2" class="pilcrow">¶</a></p>
<p id="section-7.1.1-3">Finally, it decrypts the new ClientECH.payload as a second message with the
previous HPKE context:<a href="#section-7.1.1-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.1.1-4">
<pre>
    EncodedClientHelloInner = context.Open(ClientHelloOuterAAD,
                                           ClientECH.payload)
</pre><a href="#section-7.1.1-4" class="pilcrow">¶</a>
</div>
<p id="section-7.1.1-5">ClientHelloOuterAAD is computed as described in <a href="#authenticating-outer" class="xref">Section 5.2</a>, but
using the second ClientHelloOuter. If decryption fails, the client-facing
server MUST abort the handshake with a "decrypt_error" alert. Otherwise, it
reconstructs the second ClientHelloInner from the new EncodedClientHelloInner
as described in <a href="#encoding-inner" class="xref">Section 5.1</a>, using the second ClientHelloOuter for
any referenced extensions.<a href="#section-7.1.1-5" class="pilcrow">¶</a></p>
<p id="section-7.1.1-6">The client-facing server then forwards the resulting ClientHelloInner to the
backend server. It forwards all subsequent TLS messages between the client and
backend server unmodified.<a href="#section-7.1.1-6" class="pilcrow">¶</a></p>
<p id="section-7.1.1-7">If the client-facing server rejected ECH, or if the first ClientHello did not
include an "encrypted_client_hello" extension, the client-facing server
proceeds with the connection as usual. The server does not decrypt the
second ClientHello's ClientECH.payload value, if there is one.<a href="#section-7.1.1-7" class="pilcrow">¶</a></p>
<p id="section-7.1.1-8">[[OPEN ISSUE: If the client-facing server implements stateless HRR, it has no
way to send a cookie, short of as-yet-unspecified integration with the
backend server. Stateful HRR on the client-facing server works fine, however.
See issue https://github.com/tlswg/draft-ietf-tls-esni/issues/333.]]<a href="#section-7.1.1-8" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="backend-server">
<section id="section-7.2">
        <h3 id="name-backend-server">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-backend-server" class="section-name selfRef">Backend Server</a>
        </h3>
<p id="section-7.2-1">Upon receipt of an "ech_is_inner" extension in a ClientHello, if the backend
server negotiates TLS 1.3 or higher, then it MUST confirm ECH acceptance to the
client by computing its ServerHello as described here.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<p id="section-7.2-2">The backend server begins by generating a message ServerHelloECHConf, which is
identical in content to a ServerHello message with the exception that
ServerHelloECHConf.random is equal to 24 random bytes followed by 8 zero bytes.
It then computes a string<a href="#section-7.2-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.2-3">
<pre>
    accept_confirmation =
        Derive-Secret(Handshake Secret,
                      "ech accept confirmation",
                      ClientHelloInner...ServerHelloECHConf)
</pre><a href="#section-7.2-3" class="pilcrow">¶</a>
</div>
<p id="section-7.2-4">where Derive-Secret and Handshake Secret are as specified in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>,
Section 7.1, and ClientHelloInner...ServerHelloECHConf refers to the sequence of
handshake messages beginning with the first ClientHello and ending with
ServerHelloECHConf. Finally, the backend server constructs its ServerHello
message so that it is equal to ServerHelloECHConf but with the last 8 bytes of
ServerHello.random set to the first 8 bytes of accept_confirmation.<a href="#section-7.2-4" class="pilcrow">¶</a></p>
<p id="section-7.2-5">The backend server MUST NOT perform this operation if it negotiated TLS 1.2 or
below. Note that doing so would overwrite the downgrade signal for TLS 1.3 (see
<span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 4.1.3).<a href="#section-7.2-5" class="pilcrow">¶</a></p>
<p id="section-7.2-6">The "ech_is_inner" is expected to have an empty payload. If the payload is
non-empty (i.e., the length of the "extension_data" field is non-zero) then the
backend server MUST abort the handshake with an "illegal_parameter" alert.<a href="#section-7.2-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="compatibility-issues">
<section id="section-8">
      <h2 id="name-compatibility-issues">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-compatibility-issues" class="section-name selfRef">Compatibility Issues</a>
      </h2>
<p id="section-8-1">Unlike most TLS extensions, placing the SNI value in an ECH extension is not
interoperable with existing servers, which expect the value in the existing
plaintext extension. Thus server operators SHOULD ensure servers understand a
given set of ECH keys before advertising them. Additionally, servers SHOULD
retain support for any previously-advertised keys for the duration of their
validity<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">However, in more complex deployment scenarios, this may be difficult to fully
guarantee. Thus this protocol was designed to be robust in case of
inconsistencies between systems that advertise ECH keys and servers, at the cost
of extra round-trips due to a retry. Two specific scenarios are detailed below.<a href="#section-8-2" class="pilcrow">¶</a></p>
<div id="misconfiguration">
<section id="section-8.1">
        <h3 id="name-misconfiguration-and-deploy">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-misconfiguration-and-deploy" class="section-name selfRef">Misconfiguration and Deployment Concerns</a>
        </h3>
<p id="section-8.1-1">It is possible for ECH advertisements and servers to become inconsistent. This
may occur, for instance, from DNS misconfiguration, caching issues, or an
incomplete rollout in a multi-server deployment. This may also occur if a server
loses its ECH keys, or if a deployment of ECH must be rolled back on the server.<a href="#section-8.1-1" class="pilcrow">¶</a></p>
<p id="section-8.1-2">The retry mechanism repairs inconsistencies, provided the server is
authoritative for the public name. If server and advertised keys mismatch, the
server will respond with ech_retry_requested. If the server does not understand
the "encrypted_client_hello" extension at all, it will ignore it as required by
<span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>; Section 4.1.2. Provided the server can present a certificate valid
for the public name, the client can safely retry with updated settings, as
described in <a href="#handle-server-response" class="xref">Section 6.1.3</a>.<a href="#section-8.1-2" class="pilcrow">¶</a></p>
<p id="section-8.1-3">Unless ECH is disabled as a result of successfully establishing a connection to
the public name, the client MUST NOT fall back to using unencrypted
ClientHellos, as this allows a network attacker to disclose the contents of this
ClientHello, including the SNI. It MAY attempt to use another server from the
DNS results, if one is provided.<a href="#section-8.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="middleboxes">
<section id="section-8.2">
        <h3 id="name-middleboxes">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-middleboxes" class="section-name selfRef">Middleboxes</a>
        </h3>
<p id="section-8.2-1">A more serious problem is MITM proxies which do not support this extension.
<span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 9.3 requires that such proxies remove any extensions they
do not understand. The handshake will then present a certificate based on the
public name, without echoing the "encrypted_client_hello" extension to the
client.<a href="#section-8.2-1" class="pilcrow">¶</a></p>
<p id="section-8.2-2">Depending on whether the client is configured to accept the proxy's certificate
as authoritative for the public name, this may trigger the retry logic described
in <a href="#handle-server-response" class="xref">Section 6.1.3</a> or result in a connection failure. A proxy which
is not authoritative for the public name cannot forge a signal to disable ECH.<a href="#section-8.2-2" class="pilcrow">¶</a></p>
<p id="section-8.2-3">A non-conformant MITM proxy which instead forwards the ECH extension,
substituting its own KeyShare value, will result in the client-facing server
recognizing the key, but failing to decrypt the SNI. This causes a hard failure.
Clients SHOULD NOT attempt to repair the connection in this case.<a href="#section-8.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="compliance">
<section id="section-9">
      <h2 id="name-compliance-requirements">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-compliance-requirements" class="section-name selfRef">Compliance Requirements</a>
      </h2>
<p id="section-9-1">In the absence of an application profile standard specifying otherwise,
a compliant ECH application MUST implement the following HPKE cipher suite:<a href="#section-9-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9-2.1">KEM: DHKEM(X25519, HKDF-SHA256) (see <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span>, Section 7.1)<a href="#section-9-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-2.2">KDF: HKDF-SHA256 (see <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span>, Section 7.2)<a href="#section-9-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-2.3">AEAD: AES-128-GCM (see <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span>, Section 7.3)<a href="#section-9-2.3" class="pilcrow">¶</a>
</li>
      </ul>
</section>
</div>
<div id="security-considerations">
<section id="section-10">
      <h2 id="name-security-considerations">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<div id="goals">
<section id="section-10.1">
        <h3 id="name-security-and-privacy-goals">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-security-and-privacy-goals" class="section-name selfRef">Security and Privacy Goals</a>
        </h3>
<p id="section-10.1-1">ECH considers two types of attackers: passive and active. Passive attackers can
read packets from the network. They cannot perform any sort of active behavior
such as probing servers or querying DNS. A middlebox that filters based on
plaintext packet contents is one example of a passive attacker. In contrast,
active attackers can write packets into the network for malicious purposes, such
as interfering with existing connections, probing servers, and querying DNS. In
short, an active attacker corresponds to the conventional threat model for
TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.<a href="#section-10.1-1" class="pilcrow">¶</a></p>
<p id="section-10.1-2">Given these types of attackers, the primary goals of ECH are as follows.<a href="#section-10.1-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10.1-3">
          <li id="section-10.1-3.1">Use of ECH does not weaken the security properties of TLS without ECH.<a href="#section-10.1-3.1" class="pilcrow">¶</a>
</li>
          <li id="section-10.1-3.2">TLS connection establishment to a host with a specific ECHConfig and TLS
configuration is indistinguishable from a connection to any other host with
the same ECHConfig and TLS configuration. (The set of hosts which share the
same ECHConfig and TLS configuration is referred to as the anonymity set.)<a href="#section-10.1-3.2" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-10.1-4">Client-facing server configuration determines the size of the anonymity set. For
example, if a client-facing server uses distinct ECHConfig values for each host,
then each anonymity set has size k = 1. Client-facing servers SHOULD deploy ECH
in such a way so as to maximize the size of the anonymity set where possible.
This means client-facing servers should use the same ECHConfig for as many hosts
as possible. An attacker can distinguish two hosts that have different ECHConfig
values based on the ClientECH.config_id value. This also means public
information in a TLS handshake is also consistent across hosts. For example, if
a client-facing server services many backend origin hosts, only one of which
supports some cipher suite, it may be possible to identify that host based on
the contents of unencrypted handshake messages.<a href="#section-10.1-4" class="pilcrow">¶</a></p>
<p id="section-10.1-5">Beyond these primary security and privacy goals, ECH also aims to hide, to some
extent, (a) whether or not a specific server supports ECH and (b) whether or
not ECH was accepted for a particular connection. ECH aims to achieve both
properties, assuming the attacker is passive and does not know the set of ECH
configurations offered by the client-facing server. It does not achieve these
properties for active attackers. More specifically:<a href="#section-10.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.1-6.1">Passive attackers with a known ECH configuration can distinguish between a
connection that negotiates ECH with that configuration and one which does not,
because the latter used a GREASE "encrypted_client_hello" extension (as
specified in <a href="#grease-ech" class="xref">Section 6.2</a>) or a different ECH configuration.<a href="#section-10.1-6.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-6.2">Passive attackers without the ECH configuration cannot distinguish between a
connection that negotiates ECH and one which uses a GREASE
"encrypted_client_hello" extension.<a href="#section-10.1-6.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-6.3">Active attackers can distinguish between a connection that negotiates ECH and
one which uses a GREASE "encrypted_client_hello" extension.<a href="#section-10.1-6.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-10.1-7">See <a href="#dont-stick-out" class="xref">Section 10.8.4</a> for more discussion about the "do not stick out"
criteria from <span>[<a href="#RFC8744" class="xref">RFC8744</a>]</span>.<a href="#section-10.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="plaintext-dns">
<section id="section-10.2">
        <h3 id="name-unauthenticated-and-plainte">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-unauthenticated-and-plainte" class="section-name selfRef">Unauthenticated and Plaintext DNS</a>
        </h3>
<p id="section-10.2-1">In comparison to <span>[<a href="#I-D.kazuho-protected-sni" class="xref">I-D.kazuho-protected-sni</a>]</span>, wherein DNS Resource Records are
signed via a server private key, ECH records have no authenticity or provenance
information. This means that any attacker which can inject DNS responses or
poison DNS caches, which is a common scenario in client access networks, can
supply clients with fake ECH records (so that the client encrypts data to them)
or strip the ECH record from the response. However, in the face of an attacker
that controls DNS, no encryption scheme can work because the attacker can
replace the IP address, thus blocking client connections, or substituting a
unique IP address which is 1:1 with the DNS name that was looked up (modulo DNS
wildcards). Thus, allowing the ECH records in the clear does not make the
situation significantly worse.<a href="#section-10.2-1" class="pilcrow">¶</a></p>
<p id="section-10.2-2">Clearly, DNSSEC (if the client validates and hard fails) is a defense against
this form of attack, but DoH/DPRIVE are also defenses against DNS attacks by
attackers on the local network, which is a common case where ClientHello and SNI
encryption are desired. Moreover, as noted in the introduction, SNI encryption
is less useful without encryption of DNS queries in transit via DoH or DPRIVE
mechanisms.<a href="#section-10.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="client-tracking">
<section id="section-10.3">
        <h3 id="name-client-tracking">
<a href="#section-10.3" class="section-number selfRef">10.3. </a><a href="#name-client-tracking" class="section-name selfRef">Client Tracking</a>
        </h3>
<p id="section-10.3-1">A malicious client-facing server could distribute unique, per-client ECHConfig
structures as a way of tracking clients across subsequent connections. On-path
adversaries which know about these unique keys could also track clients in this
way by observing TLS connection attempts.<a href="#section-10.3-1" class="pilcrow">¶</a></p>
<p id="section-10.3-2">The cost of this type of attack scales linearly with the desired number of
target clients. Moreover, DNS caching behavior makes targeting individual users
for extended periods of time, e.g., using per-client ECHConfig structures
delivered via HTTPS RRs with high TTLs, challenging. Clients can help mitigate
this problem by flushing any DNS or ECHConfig state upon changing networks.<a href="#section-10.3-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="optional-configs">
<section id="section-10.4">
        <h3 id="name-optional-configuration-iden">
<a href="#section-10.4" class="section-number selfRef">10.4. </a><a href="#name-optional-configuration-iden" class="section-name selfRef">Optional Configuration Identifiers and Trial Decryption</a>
        </h3>
<p id="section-10.4-1">Optional configuration identifiers may be useful in scenarios where clients and
client-facing servers do not want to reveal information about the client-facing
server in the "encrypted_client_hello" extension. In such settings, clients
send a randomly generated config_id in the ClientECH. Servers in these settings
must perform trial decryption since they cannot identify the client's chosen
ECH key using the config_id value. As a result, support for optional
configuration identifiers may exacerbate DoS attacks. Specifically, an
adversary may send malicious ClientHello messages, i.e., those which will not
decrypt with any known ECH key, in order to force wasteful decryption. Servers
that support this feature should, for example, implement some form of rate
limiting mechanism to limit the damage caused by such attacks.<a href="#section-10.4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="outer-clienthello">
<section id="section-10.5">
        <h3 id="name-outer-clienthello">
<a href="#section-10.5" class="section-number selfRef">10.5. </a><a href="#name-outer-clienthello" class="section-name selfRef">Outer ClientHello</a>
        </h3>
<p id="section-10.5-1">Any information that the client includes in the ClientHelloOuter is visible to
passive observers. The client SHOULD NOT send values in the ClientHelloOuter
which would reveal a sensitive ClientHelloInner property, such as the true
server name. It MAY send values associated with the public name in the
ClientHelloOuter.<a href="#section-10.5-1" class="pilcrow">¶</a></p>
<p id="section-10.5-2">In particular, some extensions require the client send a server-name-specific
value in the ClientHello. These values may reveal information about the
true server name. For example, the "cached_info" ClientHello extension
<span>[<a href="#RFC7924" class="xref">RFC7924</a>]</span> can contain the hash of a previously observed server certificate.
The client SHOULD NOT send values associated with the true server name in the
ClientHelloOuter. It MAY send such values in the ClientHelloInner.<a href="#section-10.5-2" class="pilcrow">¶</a></p>
<p id="section-10.5-3">A client may also use different preferences in different contexts. For example,
it may send a different ALPN lists to different servers or in different
application contexts. A client that treats this context as sensitive SHOULD NOT
send context-specific values in ClientHelloOuter.<a href="#section-10.5-3" class="pilcrow">¶</a></p>
<p id="section-10.5-4">Values which are independent of the true server name, or other information the
client wishes to protect, MAY be included in ClientHelloOuter. If they match
the corresponding ClientHelloInner, they MAY be compressed as described in
<a href="#encoding-inner" class="xref">Section 5.1</a>. However, note the payload length reveals information about
which extensions are compressed, so inner extensions which only sometimes match
the corresponding outer extension SHOULD NOT be compressed.<a href="#section-10.5-4" class="pilcrow">¶</a></p>
<p id="section-10.5-5">Clients MAY include additional extensions in ClientHelloOuter to avoid
signaling unusual behavior to passive observers, provided the choice of value
and value itself are not sensitive. See <a href="#dont-stick-out" class="xref">Section 10.8.4</a>.<a href="#section-10.5-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="related-privacy-leaks">
<section id="section-10.6">
        <h3 id="name-related-privacy-leaks">
<a href="#section-10.6" class="section-number selfRef">10.6. </a><a href="#name-related-privacy-leaks" class="section-name selfRef">Related Privacy Leaks</a>
        </h3>
<p id="section-10.6-1">ECH requires encrypted DNS to be an effective privacy protection mechanism.
However, verifying the server's identity from the Certificate message,
particularly when using the X509 CertificateType, may result in additional
network traffic that may reveal the server identity. Examples of this traffic
may include requests for revocation information, such as OCSP or CRL traffic, or
requests for repository information, such as authorityInformationAccess. It may
also include implementation-specific traffic for additional information sources
as part of verification.<a href="#section-10.6-1" class="pilcrow">¶</a></p>
<p id="section-10.6-2">Implementations SHOULD avoid leaking information that may identify the server.
Even when sent over an encrypted transport, such requests may result in indirect
exposure of the server's identity, such as indicating a specific CA or service
being used. To mitigate this risk, servers SHOULD deliver such information
in-band when possible, such as through the use of OCSP stapling, and clients
SHOULD take steps to minimize or protect such requests during certificate
validation.<a href="#section-10.6-2" class="pilcrow">¶</a></p>
<p id="section-10.6-3">Attacks that rely on non-ECH traffic to infer server identity in an ECH
connection are out of scope for this document. For example, a client that
connects to a particular host prior to ECH deployment may later resume a
connection to that same host after ECH deployment. An adversary that observes
this can deduce that the ECH-enabled connection was made to a host that the
client previously connected to and which is within the same anonymity set.<a href="#section-10.6-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="attacks-exploiting-acceptance-confirmation">
<section id="section-10.7">
        <h3 id="name-attacks-exploiting-acceptan">
<a href="#section-10.7" class="section-number selfRef">10.7. </a><a href="#name-attacks-exploiting-acceptan" class="section-name selfRef">Attacks Exploiting Acceptance Confirmation</a>
        </h3>
<p id="section-10.7-1">To signal acceptance, the backend server overwrites 8 bytes of its
ServerHello.random with a value derived from the ClientHelloInner.random. (See
<a href="#backend-server" class="xref">Section 7.2</a> for details.) This behavior increases the likelihood of the
ServerHello.random colliding with the ServerHello.random of a previous session,
potentially reducing the overall security of the protocol. However, the
remaining 24 bytes provide enough entropy to ensure this is not a practical
avenue of attack.<a href="#section-10.7-1" class="pilcrow">¶</a></p>
<p id="section-10.7-2">On the other hand, the probability that two 8-byte strings are the same is
non-negligible. This poses a modest operational risk. Suppose the client-facing
server terminates the connection (i.e., ECH is rejected or bypassed): if the
last 8 bytes of its ServerHello.random coincide with the confirmation signal,
then the client will incorrectly presume acceptance and proceed as if the
backend server terminated the connection. However, the probability of a false
positive occurring for a given connection is only 1 in 2^64. This value is
smaller than the probability of network connection failures in practice.<a href="#section-10.7-2" class="pilcrow">¶</a></p>
<p id="section-10.7-3">Note that the same bytes of the ServerHello.random are used to implement
downgrade protection for TLS 1.3 (see <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 4.1.3). These
mechanisms do not interfere because the backend server only signals ECH
acceptance in TLS 1.3 or higher.<a href="#section-10.7-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="comparison-against-criteria">
<section id="section-10.8">
        <h3 id="name-comparison-against-criteria">
<a href="#section-10.8" class="section-number selfRef">10.8. </a><a href="#name-comparison-against-criteria" class="section-name selfRef">Comparison Against Criteria</a>
        </h3>
<p id="section-10.8-1"><span>[<a href="#RFC8744" class="xref">RFC8744</a>]</span> lists several requirements for SNI encryption.
In this section, we re-iterate these requirements and assess the ECH design
against them.<a href="#section-10.8-1" class="pilcrow">¶</a></p>
<div id="mitigate-cut-and-paste-attacks">
<section id="section-10.8.1">
          <h4 id="name-mitigate-cut-and-paste-atta">
<a href="#section-10.8.1" class="section-number selfRef">10.8.1. </a><a href="#name-mitigate-cut-and-paste-atta" class="section-name selfRef">Mitigate Cut-and-Paste Attacks</a>
          </h4>
<p id="section-10.8.1-1">Since servers process either ClientHelloInner or ClientHelloOuter, and because
ClientHelloInner.random is encrypted, it is not possible for an attacker to "cut
and paste" the ECH value in a different Client Hello and learn information from
ClientHelloInner.<a href="#section-10.8.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="avoid-widely-shared-secrets">
<section id="section-10.8.2">
          <h4 id="name-avoid-widely-shared-secrets">
<a href="#section-10.8.2" class="section-number selfRef">10.8.2. </a><a href="#name-avoid-widely-shared-secrets" class="section-name selfRef">Avoid Widely Shared Secrets</a>
          </h4>
<p id="section-10.8.2-1">This design depends upon DNS as a vehicle for semi-static public key
distribution. Server operators may partition their private keys however they
see fit provided each server behind an IP address has the corresponding private
key to decrypt a key. Thus, when one ECH key is provided, sharing is optimally
bound by the number of hosts that share an IP address. Server operators may
further limit sharing by publishing different DNS records containing ECHConfig
values with different keys using a short TTL.<a href="#section-10.8.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="prevent-sni-based-denial-of-service-attacks">
<section id="section-10.8.3">
          <h4 id="name-prevent-sni-based-denial-of">
<a href="#section-10.8.3" class="section-number selfRef">10.8.3. </a><a href="#name-prevent-sni-based-denial-of" class="section-name selfRef">Prevent SNI-Based Denial-of-Service Attacks</a>
          </h4>
<p id="section-10.8.3-1">This design requires servers to decrypt ClientHello messages with ClientECH
extensions carrying valid digests. Thus, it is possible for an attacker to force
decryption operations on the server. This attack is bound by the number of valid
TCP connections an attacker can open.<a href="#section-10.8.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="dont-stick-out">
<section id="section-10.8.4">
          <h4 id="name-do-not-stick-out">
<a href="#section-10.8.4" class="section-number selfRef">10.8.4. </a><a href="#name-do-not-stick-out" class="section-name selfRef">Do Not Stick Out</a>
          </h4>
<p id="section-10.8.4-1">The only explicit signal indicating possible use of ECH is the ClientHello
"encrypted_client_hello" extension. Server handshake messages do not contain any
signal indicating use or negotiation of ECH. Clients MAY GREASE the
"encrypted_client_hello" extension, as described in <a href="#grease-ech" class="xref">Section 6.2</a>, which helps
ensure the ecosystem handles ECH correctly. Moreover, as more clients enable ECH
support, e.g., as normal part of Web browser functionality, with keys supplied
by shared hosting providers, the presence of ECH extensions becomes less unusual
and part of typical client behavior. In other words, if all Web browsers start
using ECH, the presence of this value will not signal unusual behavior to
passive eavesdroppers.<a href="#section-10.8.4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="maintain-forward-secrecy">
<section id="section-10.8.5">
          <h4 id="name-maintain-forward-secrecy">
<a href="#section-10.8.5" class="section-number selfRef">10.8.5. </a><a href="#name-maintain-forward-secrecy" class="section-name selfRef">Maintain Forward Secrecy</a>
          </h4>
<p id="section-10.8.5-1">This design is not forward secret because the server's ECH key is static.
However, the window of exposure is bound by the key lifetime. It is RECOMMENDED
that servers rotate keys frequently.<a href="#section-10.8.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="enable-multi-party-security-contexts">
<section id="section-10.8.6">
          <h4 id="name-enable-multi-party-security">
<a href="#section-10.8.6" class="section-number selfRef">10.8.6. </a><a href="#name-enable-multi-party-security" class="section-name selfRef">Enable Multi-party Security Contexts</a>
          </h4>
<p id="section-10.8.6-1">This design permits servers operating in Split Mode to forward connections
directly to backend origin servers. The client authenticates the identity of
the backend origin server, thereby avoiding unnecessary MiTM attacks.<a href="#section-10.8.6-1" class="pilcrow">¶</a></p>
<p id="section-10.8.6-2">Conversely, assuming ECH records retrieved from DNS are authenticated, e.g.,
via DNSSEC or fetched from a trusted Recursive Resolver, spoofing a
client-facing server operating in Split Mode is not possible. See
<a href="#plaintext-dns" class="xref">Section 10.2</a> for more details regarding plaintext DNS.<a href="#section-10.8.6-2" class="pilcrow">¶</a></p>
<p id="section-10.8.6-3">Authenticating the ECHConfig structure naturally authenticates the included
public name. This also authenticates any retry signals from the client-facing
server because the client validates the server certificate against the public
name before retrying.<a href="#section-10.8.6-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="support-multiple-protocols">
<section id="section-10.8.7">
          <h4 id="name-support-multiple-protocols">
<a href="#section-10.8.7" class="section-number selfRef">10.8.7. </a><a href="#name-support-multiple-protocols" class="section-name selfRef">Support Multiple Protocols</a>
          </h4>
<p id="section-10.8.7-1">This design has no impact on application layer protocol negotiation. It may
affect connection routing, server certificate selection, and client certificate
verification. Thus, it is compatible with multiple application and transport
protocols. By encrypting the entire ClientHello, this design additionally
supports encrypting the ALPN extension.<a href="#section-10.8.7-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="padding-policy">
<section id="section-10.9">
        <h3 id="name-padding-policy">
<a href="#section-10.9" class="section-number selfRef">10.9. </a><a href="#name-padding-policy" class="section-name selfRef">Padding Policy</a>
        </h3>
<p id="section-10.9-1">Variations in the length of the ClientHelloInner ciphertext could leak
information about the corresponding plaintext. <a href="#padding" class="xref">Section 6.1.2</a> describes a
RECOMMENDED padding mechanism for clients aimed at reducing potential
information leakage.<a href="#section-10.9-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="active-attack-mitigations">
<section id="section-10.10">
        <h3 id="name-active-attack-mitigations">
<a href="#section-10.10" class="section-number selfRef">10.10. </a><a href="#name-active-attack-mitigations" class="section-name selfRef">Active Attack Mitigations</a>
        </h3>
<p id="section-10.10-1">This section describes the rationale for ECH properties and mechanics as
defenses against active attacks. In all the attacks below, the attacker is
on-path between the target client and server. The goal of the attacker is to
learn private information about the inner ClientHello, such as the true SNI
value.<a href="#section-10.10-1" class="pilcrow">¶</a></p>
<div id="flow-client-reaction">
<section id="section-10.10.1">
          <h4 id="name-client-reaction-attack-miti">
<a href="#section-10.10.1" class="section-number selfRef">10.10.1. </a><a href="#name-client-reaction-attack-miti" class="section-name selfRef">Client Reaction Attack Mitigation</a>
          </h4>
<p id="section-10.10.1-1">This attack uses the client's reaction to an incorrect certificate as an oracle.
The attacker intercepts a legitimate ClientHello and replies with a ServerHello,
Certificate, CertificateVerify, and Finished messages, wherein the Certificate
message contains a "test" certificate for the domain name it wishes to query. If
the client decrypted the Certificate and failed verification (or leaked
information about its verification process by a timing side channel), the
attacker learns that its test certificate name was incorrect. As an example,
suppose the client's SNI value in its inner ClientHello is "example.com," and
the attacker replied with a Certificate for "test.com". If the client produces a
verification failure alert because of the mismatch faster than it would due to
the Certificate signature validation, information about the name leaks. Note
that the attacker can also withhold the CertificateVerify message. In that
scenario, a client which first verifies the Certificate would then respond
similarly and leak the same information.<a href="#section-10.10.1-1" class="pilcrow">¶</a></p>
<span id="name-client-reaction-attack"></span><div id="flow-diagram-client-reaction">
<figure id="figure-3">
            <div class="artwork art-text alignLeft" id="section-10.10.1-2.1">
<pre>
 Client                         Attacker               Server
   ClientHello
   + key_share
   + ech         ------&gt;      (intercept)     -----&gt; X (drop)

                             ServerHello
                             + key_share
                   {EncryptedExtensions}
                   {CertificateRequest*}
                          {Certificate*}
                    {CertificateVerify*}
                 &lt;------
   Alert
                 ------&gt;
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-client-reaction-attack" class="selfRef">Client reaction attack</a>
            </figcaption></figure>
</div>
<p id="section-10.10.1-3">ClientHelloInner.random prevents this attack. In particular, since the attacker
does not have access to this value, it cannot produce the right transcript and
handshake keys needed for encrypting the Certificate message. Thus, the client
will fail to decrypt the Certificate and abort the connection.<a href="#section-10.10.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="flow-hrr-hijack">
<section id="section-10.10.2">
          <h4 id="name-helloretryrequest-hijack-mi">
<a href="#section-10.10.2" class="section-number selfRef">10.10.2. </a><a href="#name-helloretryrequest-hijack-mi" class="section-name selfRef">HelloRetryRequest Hijack Mitigation</a>
          </h4>
<p id="section-10.10.2-1">This attack aims to exploit server HRR state management to recover information
about a legitimate ClientHello using its own attacker-controlled ClientHello.
To begin, the attacker intercepts and forwards a legitimate ClientHello with an
"encrypted_client_hello" (ech) extension to the server, which triggers a
legitimate HelloRetryRequest in return. Rather than forward the retry to the
client, the attacker, attempts to generate its own ClientHello in response based
on the contents of the first ClientHello and HelloRetryRequest exchange with the
result that the server encrypts the Certificate to the attacker. If the server
used the SNI from the first ClientHello and the key share from the second
(attacker-controlled) ClientHello, the Certificate produced would leak the
client's chosen SNI to the attacker.<a href="#section-10.10.2-1" class="pilcrow">¶</a></p>
<span id="name-helloretryrequest-hijack-at"></span><div id="flow-diagram-hrr-hijack">
<figure id="figure-4">
            <div class="artwork art-text alignLeft" id="section-10.10.2-2.1">
<pre>
 Client                         Attacker                   Server
   ClientHello
   + key_share
   + ech         ------&gt;       (forward)        -------&gt;
                                              HelloRetryRequest
                                                    + key_share
                              (intercept)       &lt;-------

                              ClientHello
                              + key_share'
                              + ech'           -------&gt;
                                                    ServerHello
                                                    + key_share
                                          {EncryptedExtensions}
                                          {CertificateRequest*}
                                                 {Certificate*}
                                           {CertificateVerify*}
                                                     {Finished}
                                                &lt;-------
                         (process server flight)
</pre>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-helloretryrequest-hijack-at" class="selfRef">HelloRetryRequest hijack attack</a>
            </figcaption></figure>
</div>
<p id="section-10.10.2-3">This attack is mitigated by using the same HPKE context for both ClientHello
messages. The attacker does not possess the context's keys, so it cannot
generate a valid encryption of the second inner ClientHello.<a href="#section-10.10.2-3" class="pilcrow">¶</a></p>
<p id="section-10.10.2-4">If the attacker could manipulate the second ClientHello, it might be possible
for the server to act as an oracle if it required parameters from the first
ClientHello to match that of the second ClientHello. For example, imagine the
client's original SNI value in the inner ClientHello is "example.com", and the
attacker's hijacked SNI value in its inner ClientHello is "test.com". A server
which checks these for equality and changes behavior based on the result can be
used as an oracle to learn the client's SNI.<a href="#section-10.10.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="flow-clienthello-malleability">
<section id="section-10.10.3">
          <h4 id="name-clienthello-malleability-mi">
<a href="#section-10.10.3" class="section-number selfRef">10.10.3. </a><a href="#name-clienthello-malleability-mi" class="section-name selfRef">ClientHello Malleability Mitigation</a>
          </h4>
<p id="section-10.10.3-1">This attack aims to leak information about secret parts of the encrypted
ClientHello by adding attacker-controlled parameters and observing the server's
response. In particular, the compression mechanism described in
<a href="#encoding-inner" class="xref">Section 5.1</a> references parts of a potentially attacker-controlled
ClientHelloOuter to construct ClientHelloInner, or a buggy server may
incorrectly apply parameters from ClientHelloOuter to the handshake.<a href="#section-10.10.3-1" class="pilcrow">¶</a></p>
<p id="section-10.10.3-2">To begin, the attacker first interacts with a server to obtain a resumption
ticket for a given test domain, such as "example.com". Later, upon receipt of a
ClientHelloOuter, it modifies it such that the server will process the
resumption ticket with ClientHelloInner. If the server only accepts resumption
PSKs that match the server name, it will fail the PSK binder check with an
alert when ClientHelloInner is for "example.com" but silently ignore the PSK
and continue when ClientHelloInner is for any other name. This introduces an
oracle for testing encrypted SNI values.<a href="#section-10.10.3-2" class="pilcrow">¶</a></p>
<span id="name-message-flow-for-malleable-"></span><div id="tls-clienthello-malleability">
<figure id="figure-5">
            <div class="artwork art-text alignLeft" id="section-10.10.3-3.1">
<pre>
      Client              Attacker                       Server

                                    handshake and ticket
                                       for "example.com"
                                       &lt;--------&gt;

      ClientHello
      + key_share
      + ech
      + ech_outer_extensions(pre_shared_key)
      + pre_shared_key
                  --------&gt;
                        (intercept)
                        ClientHello
                        + key_share
                        + ech
                           + ech_outer_extensions(pre_shared_key)
                        + pre_shared_key'
                                          --------&gt;
                                                         Alert
                                                         -or-
                                                   ServerHello
                                                            ...
                                                      Finished
                                          &lt;--------
</pre>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-message-flow-for-malleable-" class="selfRef">Message flow for malleable ClientHello</a>
            </figcaption></figure>
</div>
<p id="section-10.10.3-4">This attack may be generalized to any parameter which the server varies by
server name, such as ALPN preferences.<a href="#section-10.10.3-4" class="pilcrow">¶</a></p>
<p id="section-10.10.3-5">ECH mitigates this attack by only negotiating TLS parameters from
ClientHelloInner and authenticating all inputs to the ClientHelloInner
(EncodedClientHelloInner and ClientHelloOuter) with the HPKE AEAD. See
<a href="#authenticating-outer" class="xref">Section 5.2</a>. An earlier iteration of this specification only
encrypted and authenticated the "server_name" extension, which left the overall
ClientHello vulnerable to an analogue of this attack.<a href="#section-10.10.3-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-11">
      <h2 id="name-iana-considerations">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<div id="update-of-the-tls-extensiontype-registry">
<section id="section-11.1">
        <h3 id="name-update-of-the-tls-extension">
<a href="#section-11.1" class="section-number selfRef">11.1. </a><a href="#name-update-of-the-tls-extension" class="section-name selfRef">Update of the TLS ExtensionType Registry</a>
        </h3>
<p id="section-11.1-1">IANA is requested to create the following three entries in the existing registry
for ExtensionType (defined in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>):<a href="#section-11.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-11.1-2">
          <li id="section-11.1-2.1">encrypted_client_hello(0xfe0a), with "TLS 1.3" column values set to
"CH, EE", and "Recommended" column set to "Yes".<a href="#section-11.1-2.1" class="pilcrow">¶</a>
</li>
          <li id="section-11.1-2.2">ech_is_inner (0xda09), with "TLS 1.3" column values set to
"CH", and "Recommended" column set to "Yes".<a href="#section-11.1-2.2" class="pilcrow">¶</a>
</li>
          <li id="section-11.1-2.3">ech_outer_extensions(0xfd00), with the "TLS 1.3" column values set to "",
and "Recommended" column set to "Yes".<a href="#section-11.1-2.3" class="pilcrow">¶</a>
</li>
        </ol>
</section>
</div>
<div id="alerts">
<section id="section-11.2">
        <h3 id="name-update-of-the-tls-alert-reg">
<a href="#section-11.2" class="section-number selfRef">11.2. </a><a href="#name-update-of-the-tls-alert-reg" class="section-name selfRef">Update of the TLS Alert Registry</a>
        </h3>
<p id="section-11.2-1">IANA is requested to create an entry, ech_required(121) in the existing registry
for Alerts (defined in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>), with the "DTLS-OK" column set to
"Y".<a href="#section-11.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="config-extensions-guidance">
<section id="section-12">
      <h2 id="name-echconfig-extension-guidanc">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-echconfig-extension-guidanc" class="section-name selfRef">ECHConfig Extension Guidance</a>
      </h2>
<p id="section-12-1">Any future information or hints that influence ClientHelloOuter SHOULD be
specified as ECHConfig extensions. This is primarily because the outer
ClientHello exists only in support of ECH. Namely, it is both an envelope for
the encrypted inner ClientHello and enabler for authenticated key mismatch
signals (see <a href="#server-behavior" class="xref">Section 7</a>). In contrast, the inner ClientHello is the
true ClientHello used upon ECH negotiation.<a href="#section-12-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-13">
      <h2 id="name-references">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-13.1">
        <h3 id="name-normative-references">
<a href="#section-13.1" class="section-number selfRef">13.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="HTTPS-RR">[HTTPS-RR]</dt>
        <dd>
<span class="refAuthor">Schwartz, B.</span><span class="refAuthor">, Bishop, M.</span><span class="refAuthor">, and E. Nygren</span>, <span class="refTitle">"Service binding and parameter specification via the DNS (DNS SVCB and HTTPS RRs)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-dnsop-svcb-https-02</span>, <time datetime="2020-11-02" class="refDate">2 November 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-dnsop-svcb-https-02.txt">http://www.ietf.org/internet-drafts/draft-ietf-dnsop-svcb-https-02.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-tls-exported-authenticator">[I-D.ietf-tls-exported-authenticator]</dt>
        <dd>
<span class="refAuthor">Sullivan, N.</span>, <span class="refTitle">"Exported Authenticators in TLS"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-tls-exported-authenticator-14</span>, <time datetime="2021-01-25" class="refDate">25 January 2021</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tls-exported-authenticator-14.txt">http://www.ietf.org/internet-drafts/draft-ietf-tls-exported-authenticator-14.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.irtf-cfrg-hpke">[I-D.irtf-cfrg-hpke]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span><span class="refAuthor">, Bhargavan, K.</span><span class="refAuthor">, Lipp, B.</span><span class="refAuthor">, and C. Wood</span>, <span class="refTitle">"Hybrid Public Key Encryption"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-hpke-07</span>, <time datetime="2020-12-16" class="refDate">16 December 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-irtf-cfrg-hpke-07.txt">http://www.ietf.org/internet-drafts/draft-irtf-cfrg-hpke-07.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7685">[RFC7685]</dt>
        <dd>
<span class="refAuthor">Langley, A.</span>, <span class="refTitle">"A Transport Layer Security (TLS) ClientHello Padding Extension"</span>, <span class="seriesInfo">RFC 7685</span>, <span class="seriesInfo">DOI 10.17487/RFC7685</span>, <time datetime="2015-10" class="refDate">October 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7685">https://www.rfc-editor.org/info/rfc7685</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7918">[RFC7918]</dt>
        <dd>
<span class="refAuthor">Langley, A.</span><span class="refAuthor">, Modadugu, N.</span><span class="refAuthor">, and B. Moeller</span>, <span class="refTitle">"Transport Layer Security (TLS) False Start"</span>, <span class="seriesInfo">RFC 7918</span>, <span class="seriesInfo">DOI 10.17487/RFC7918</span>, <time datetime="2016-08" class="refDate">August 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7918">https://www.rfc-editor.org/info/rfc7918</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
      <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8446">https://www.rfc-editor.org/info/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-13.2">
        <h3 id="name-informative-references">
<a href="#section-13.2" class="section-number selfRef">13.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.kazuho-protected-sni">[I-D.kazuho-protected-sni]</dt>
        <dd>
<span class="refAuthor">Oku, K.</span>, <span class="refTitle">"TLS Extensions for Protecting SNI"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-kazuho-protected-sni-00</span>, <time datetime="2017-07-18" class="refDate">18 July 2017</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-kazuho-protected-sni-00.txt">http://www.ietf.org/internet-drafts/draft-kazuho-protected-sni-00.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7301">[RFC7301]</dt>
        <dd>
<span class="refAuthor">Friedl, S.</span><span class="refAuthor">, Popov, A.</span><span class="refAuthor">, Langley, A.</span><span class="refAuthor">, and E. Stephan</span>, <span class="refTitle">"Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension"</span>, <span class="seriesInfo">RFC 7301</span>, <span class="seriesInfo">DOI 10.17487/RFC7301</span>, <time datetime="2014-07" class="refDate">July 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7301">https://www.rfc-editor.org/info/rfc7301</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7858">[RFC7858]</dt>
        <dd>
<span class="refAuthor">Hu, Z.</span><span class="refAuthor">, Zhu, L.</span><span class="refAuthor">, Heidemann, J.</span><span class="refAuthor">, Mankin, A.</span><span class="refAuthor">, Wessels, D.</span><span class="refAuthor">, and P. Hoffman</span>, <span class="refTitle">"Specification for DNS over Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 7858</span>, <span class="seriesInfo">DOI 10.17487/RFC7858</span>, <time datetime="2016-05" class="refDate">May 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7858">https://www.rfc-editor.org/info/rfc7858</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7924">[RFC7924]</dt>
        <dd>
<span class="refAuthor">Santesson, S.</span><span class="refAuthor"> and H. Tschofenig</span>, <span class="refTitle">"Transport Layer Security (TLS) Cached Information Extension"</span>, <span class="seriesInfo">RFC 7924</span>, <span class="seriesInfo">DOI 10.17487/RFC7924</span>, <time datetime="2016-07" class="refDate">July 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7924">https://www.rfc-editor.org/info/rfc7924</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8094">[RFC8094]</dt>
        <dd>
<span class="refAuthor">Reddy, T.</span><span class="refAuthor">, Wing, D.</span><span class="refAuthor">, and P. Patil</span>, <span class="refTitle">"DNS over Datagram Transport Layer Security (DTLS)"</span>, <span class="seriesInfo">RFC 8094</span>, <span class="seriesInfo">DOI 10.17487/RFC8094</span>, <time datetime="2017-02" class="refDate">February 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8094">https://www.rfc-editor.org/info/rfc8094</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8484">[RFC8484]</dt>
        <dd>
<span class="refAuthor">Hoffman, P.</span><span class="refAuthor"> and P. McManus</span>, <span class="refTitle">"DNS Queries over HTTPS (DoH)"</span>, <span class="seriesInfo">RFC 8484</span>, <span class="seriesInfo">DOI 10.17487/RFC8484</span>, <time datetime="2018-10" class="refDate">October 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8484">https://www.rfc-editor.org/info/rfc8484</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8701">[RFC8701]</dt>
        <dd>
<span class="refAuthor">Benjamin, D.</span>, <span class="refTitle">"Applying Generate Random Extensions And Sustain Extensibility (GREASE) to TLS Extensibility"</span>, <span class="seriesInfo">RFC 8701</span>, <span class="seriesInfo">DOI 10.17487/RFC8701</span>, <time datetime="2020-01" class="refDate">January 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8701">https://www.rfc-editor.org/info/rfc8701</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8744">[RFC8744]</dt>
      <dd>
<span class="refAuthor">Huitema, C.</span>, <span class="refTitle">"Issues and Requirements for Server Name Identification (SNI) Encryption in TLS"</span>, <span class="seriesInfo">RFC 8744</span>, <span class="seriesInfo">DOI 10.17487/RFC8744</span>, <time datetime="2020-07" class="refDate">July 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8744">https://www.rfc-editor.org/info/rfc8744</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="alternative-sni-protection-designs">
<section id="section-appendix.a">
      <h2 id="name-alternative-sni-protection-">
<a href="#section-appendix.a" class="section-number selfRef">Appendix A. </a><a href="#name-alternative-sni-protection-" class="section-name selfRef">Alternative SNI Protection Designs</a>
      </h2>
<p id="section-appendix.a-1">Alternative approaches to encrypted SNI may be implemented at the TLS or
application layer. In this section we describe several alternatives and discuss
drawbacks in comparison to the design in this document.<a href="#section-appendix.a-1" class="pilcrow">¶</a></p>
<div id="tls-layer">
<section id="section-a.1">
        <h2 id="name-tls-layer">
<a href="#section-a.1" class="section-number selfRef">A.1. </a><a href="#name-tls-layer" class="section-name selfRef">TLS-layer</a>
        </h2>
<div id="tls-in-early-data">
<section id="section-a.1.1">
          <h3 id="name-tls-in-early-data">
<a href="#section-a.1.1" class="section-number selfRef">A.1.1. </a><a href="#name-tls-in-early-data" class="section-name selfRef">TLS in Early Data</a>
          </h3>
<p id="section-a.1.1-1">In this variant, TLS Client Hellos are tunneled within early data payloads
belonging to outer TLS connections established with the client-facing server.
This requires clients to have established a previous session --- and obtained
PSKs --- with the server. The client-facing server decrypts early data payloads
to uncover Client Hellos destined for the backend server, and forwards them
onwards as necessary. Afterwards, all records to and from backend servers are
forwarded by the client-facing server - unmodified. This avoids double
encryption of TLS records.<a href="#section-a.1.1-1" class="pilcrow">¶</a></p>
<p id="section-a.1.1-2">Problems with this approach are: (1) servers may not always be able to
distinguish inner Client Hellos from legitimate application data, (2) nested
0-RTT data may not function correctly, (3) 0-RTT data may not be supported -
especially under DoS - leading to availability concerns, and (4) clients must
bootstrap tunnels (sessions), costing an additional round trip and potentially
revealing the SNI during the initial connection. In contrast, encrypted SNI
protects the SNI in a distinct Client Hello extension and neither abuses early
data nor requires a bootstrapping connection.<a href="#section-a.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="combined-tickets">
<section id="section-a.1.2">
          <h3 id="name-combined-tickets">
<a href="#section-a.1.2" class="section-number selfRef">A.1.2. </a><a href="#name-combined-tickets" class="section-name selfRef">Combined Tickets</a>
          </h3>
<p id="section-a.1.2-1">In this variant, client-facing and backend servers coordinate to produce
"combined tickets" that are consumable by both. Clients offer combined tickets
to client-facing servers. The latter parse them to determine the correct backend
server to which the Client Hello should be forwarded. This approach is
problematic due to non-trivial coordination between client-facing and backend
servers for ticket construction and consumption. Moreover, it requires a
bootstrapping step similar to that of the previous variant. In contrast,
encrypted SNI requires no such coordination.<a href="#section-a.1.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="application-layer">
<section id="section-a.2">
        <h2 id="name-application-layer">
<a href="#section-a.2" class="section-number selfRef">A.2. </a><a href="#name-application-layer" class="section-name selfRef">Application-layer</a>
        </h2>
<div id="http2-certificate-frames">
<section id="section-a.2.1">
          <h3 id="name-http-2-certificate-frames">
<a href="#section-a.2.1" class="section-number selfRef">A.2.1. </a><a href="#name-http-2-certificate-frames" class="section-name selfRef">HTTP/2 CERTIFICATE Frames</a>
          </h3>
<p id="section-a.2.1-1">In this variant, clients request secondary certificates with CERTIFICATE_REQUEST
HTTP/2 frames after TLS connection completion. In response, servers supply
certificates via TLS exported authenticators
<span>[<a href="#I-D.ietf-tls-exported-authenticator" class="xref">I-D.ietf-tls-exported-authenticator</a>]</span> in CERTIFICATE frames. Clients use a
generic SNI for the underlying client-facing server TLS connection. Problems
with this approach include: (1) one additional round trip before peer
authentication, (2) non-trivial application-layer dependencies and interaction,
and (3) obtaining the generic SNI to bootstrap the connection. In contrast,
encrypted SNI induces no additional round trip and operates below the
application layer.<a href="#section-a.2.1-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="acknowledgements">
<section id="section-appendix.b">
      <h2 id="name-acknowledgements">
<a href="#section-appendix.b" class="section-number selfRef">Appendix B. </a><a href="#name-acknowledgements" class="section-name selfRef">Acknowledgements</a>
      </h2>
<p id="section-appendix.b-1">This document draws extensively from ideas in <span>[<a href="#I-D.kazuho-protected-sni" class="xref">I-D.kazuho-protected-sni</a>]</span>, but
is a much more limited mechanism because it depends on the DNS for the
protection of the ECH key. Richard Barnes, Christian Huitema, Patrick McManus,
Matthew Prince, Nick Sullivan, Martin Thomson, and David Benjamin also provided
important ideas and contributions.<a href="#section-appendix.b-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="change-log">
<section id="section-appendix.c">
      <h2 id="name-change-log">
<a href="#section-appendix.c" class="section-number selfRef">Appendix C. </a><a href="#name-change-log" class="section-name selfRef">Change Log</a>
      </h2>
<ul class="ulEmpty normal">
<li class="ulEmpty normal" id="section-appendix.c-1.1">
          <strong>RFC Editor's Note:</strong> Please remove this section prior to publication of a
final version of this document.<a href="#section-appendix.c-1.1" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-appendix.c-2">Issue and pull request numbers are listed with a leading octothorp.<a href="#section-appendix.c-2" class="pilcrow">¶</a></p>
<div id="since-draft-ietf-tls-esni-09">
<section id="section-c.1">
        <h2 id="name-since-draft-ietf-tls-esni-0">
<a href="#section-c.1" class="section-number selfRef">C.1. </a><a href="#name-since-draft-ietf-tls-esni-0" class="section-name selfRef">Since draft-ietf-tls-esni-09</a>
        </h2>
<ul class="normal">
<li class="normal" id="section-c.1-1.1">Finalize HPKE dependency (#390)<a href="#section-c.1-1.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-c.1-1.2">Move from client-computed to server-chosen, one-byte config
identifier (#376, #381)<a href="#section-c.1-1.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-c.1-1.3">Rename ECHConfigs to ECHConfigList (#391)<a href="#section-c.1-1.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-c.1-1.4">Clarify some security and privacy properties (#385, #383)<a href="#section-c.1-1.4" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="authors-addresses">
<section id="section-appendix.d">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Eric Rescorla</span></div>
<div dir="auto" class="left"><span class="org">RTFM, Inc.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ekr@rtfm.com" class="email">ekr@rtfm.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Kazuho Oku</span></div>
<div dir="auto" class="left"><span class="org">Fastly</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:kazuhooku@gmail.com" class="email">kazuhooku@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Nick Sullivan</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:nick@cloudflare.com" class="email">nick@cloudflare.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christopher A. Wood</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:caw@heapingbits.net" class="email">caw@heapingbits.net</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
