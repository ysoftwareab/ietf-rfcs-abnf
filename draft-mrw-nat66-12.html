<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>IPv6-to-IPv6 Network Prefix Translation</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 What is Address Independence?">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 NPTv6 Applicability">
<link href="#rfc.section.2" rel="Chapter" title="2 NPTv6 Overview">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 NPTv6: the simplest case">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 NPTv6 between peer networks">
<link href="#rfc.section.2.3" rel="Chapter" title="2.3 NPTv6 redundancy and load-sharing">
<link href="#rfc.section.2.4" rel="Chapter" title="2.4 NPTv6 multihoming">
<link href="#rfc.section.2.5" rel="Chapter" title="2.5 Mapping with No Per-Flow State">
<link href="#rfc.section.2.6" rel="Chapter" title="2.6 Checksum-Neutral Mapping">
<link href="#rfc.section.3" rel="Chapter" title="3 NPTv6 Algorithmic Specification">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 NPTv6 configuration calculations">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 NPTv6 translation, internal network to external network">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 NPTv6 translation, external network to internal network">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 NPTv6 with a /48 or shorter prefix">
<link href="#rfc.section.3.5" rel="Chapter" title="3.5 NPTv6 with a /49 or longer prefix">
<link href="#rfc.section.3.6" rel="Chapter" title="3.6 /48 Prefix Mapping Example">
<link href="#rfc.section.3.7" rel="Chapter" title="3.7 Address Mapping for Longer Prefixes">
<link href="#rfc.section.4" rel="Chapter" title="4 Implications of Network Address Translator Behavioral Requirements">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Prefix configuration and generation">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Subnet numbering">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 NAT Behavioral Requirements">
<link href="#rfc.section.5" rel="Chapter" title="5 Implications for Applications">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Recommendation for network planners considering use of NPTv6 Translation">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Recommendations for application writers">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 Recommendation for future work">
<link href="#rfc.section.6" rel="Chapter" title="6 A Note on Port Mapping">
<link href="#rfc.section.7" rel="Chapter" title="7 Security Considerations">
<link href="#rfc.section.8" rel="Chapter" title="8 IANA Considerations">
<link href="#rfc.section.9" rel="Chapter" title="9 Acknowledgements">
<link href="#rfc.section.10" rel="Chapter" title="10 Change Log">
<link href="#rfc.section.10.1" rel="Chapter" title="10.1 Changes Between draft-mrw-behave-nat66-00 and -01">
<link href="#rfc.section.10.2" rel="Chapter" title="10.2 Changes between *behave-nat66-01 and -02">
<link href="#rfc.section.10.3" rel="Chapter" title="10.3 Changes between *nat66-00 and *nat66-01">
<link href="#rfc.section.10.4" rel="Chapter" title="10.4 Changes between *nat66-01 and *nat66-02">
<link href="#rfc.section.10.5" rel="Chapter" title="10.5 Changes between *nat66-02 and *nat66-03">
<link href="#rfc.section.10.6" rel="Chapter" title="10.6 Changes between *nat66-03 and *nat66-04">
<link href="#rfc.section.10.7" rel="Chapter" title="10.7 Changes between *nat66-04 and *nat66-05">
<link href="#rfc.section.10.8" rel="Chapter" title="10.8 Changes between *nat66-05 and *nat66-06">
<link href="#rfc.section.10.9" rel="Chapter" title="10.9 Changes between *nat66-06 and *nat66-07">
<link href="#rfc.section.10.10" rel="Chapter" title="10.10 Changes between *nat66-07 and *nat66-08">
<link href="#rfc.section.10.11" rel="Chapter" title="10.11 Changes up to *nat66-10">
<link href="#rfc.section.10.12" rel="Chapter" title="10.12 Changes up to *nat66-11 and -12">
<link href="#rfc.references" rel="Chapter" title="11 References">
<link href="#rfc.references.1" rel="Chapter" title="11.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="11.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Why GSE?">
<link href="#rfc.appendix.Appendix%20B" rel="Chapter" title="Appendix B Verification code">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document describes a stateless, transport-agnostic IPv6-to-IPv6 Network Prefix Translation (NPTv6) function that provides the address independence benefit associated with IPv4-to-IPv4 NAT (NAPT44), and in addition provides a 1:1 relationship between addresses in the "inside" and "outside" prefixes, preserving end to end reachability at the network layer." />
  <meta name="description" content="This document describes a stateless, transport-agnostic IPv6-to-IPv6 Network Prefix Translation (NPTv6) function that provides the address independence benefit associated with IPv4-to-IPv4 NAT (NAPT44), and in addition provides a 1:1 relationship between addresses in the "inside" and "outside" prefixes, preserving end to end reachability at the network layer." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">M. Wasserman</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Painless Security</td>
</tr>
<tr>
<td class="left">Intended status: Experimental Protocol</td>
<td class="right">F.J. Baker</td>
</tr>
<tr>
<td class="left">Expires: September 15, 2011</td>
<td class="right">Cisco Systems</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">March 14, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">IPv6-to-IPv6 Network Prefix Translation<br />
  <span class="filename">draft-mrw-nat66-12</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document describes a stateless, transport-agnostic IPv6-to-IPv6 Network Prefix Translation (NPTv6) function that provides the address independence benefit associated with IPv4-to-IPv4 NAT (NAPT44), and in addition provides a 1:1 relationship between addresses in the "inside" and "outside" prefixes, preserving end to end reachability at the network layer.</p>
<h1><a>Requirements Terminology</a></h1>
<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">RFC 2119</a> <cite title="NONE">[RFC2119]</cite>.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on September 15, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">What is Address Independence?</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">NPTv6 Applicability</a>
</li>
<li>2.   <a href="#rfc.section.2">NPTv6 Overview</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">NPTv6: the simplest case</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">NPTv6 between peer networks</a>
</li>
<li>2.3.   <a href="#rfc.section.2.3">NPTv6 redundancy and load-sharing</a>
</li>
<li>2.4.   <a href="#rfc.section.2.4">NPTv6 multihoming</a>
</li>
<li>2.5.   <a href="#rfc.section.2.5">Mapping with No Per-Flow State</a>
</li>
<li>2.6.   <a href="#rfc.section.2.6">Checksum-Neutral Mapping</a>
</li>
<li>3.   <a href="#rfc.section.3">NPTv6 Algorithmic Specification</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">NPTv6 configuration calculations</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">NPTv6 translation, internal network to external network</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">NPTv6 translation, external network to internal network</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">NPTv6 with a /48 or shorter prefix</a>
</li>
<li>3.5.   <a href="#rfc.section.3.5">NPTv6 with a /49 or longer prefix</a>
</li>
<li>3.6.   <a href="#rfc.section.3.6">/48 Prefix Mapping Example</a>
</li>
<li>3.7.   <a href="#rfc.section.3.7">Address Mapping for Longer Prefixes</a>
</li>
<li>4.   <a href="#rfc.section.4">Implications of Network Address Translator Behavioral Requirements</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Prefix configuration and generation</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Subnet numbering</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">NAT Behavioral Requirements</a>
</li>
<li>5.   <a href="#rfc.section.5">Implications for Applications</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Recommendation for network planners considering use of NPTv6 Translation</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Recommendations for application writers</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">Recommendation for future work</a>
</li>
<li>6.   <a href="#rfc.section.6">A Note on Port Mapping</a>
</li>
<li>7.   <a href="#rfc.section.7">Security Considerations</a>
</li>
<li>8.   <a href="#rfc.section.8">IANA Considerations</a>
</li>
<li>9.   <a href="#rfc.section.9">Acknowledgements</a>
</li>
<li>10.   <a href="#rfc.section.10">Change Log</a>
</li>
<li>10.1.   <a href="#rfc.section.10.1">Changes Between draft-mrw-behave-nat66-00 and -01</a>
</li>
<li>10.2.   <a href="#rfc.section.10.2">Changes between *behave-nat66-01 and -02</a>
</li>
<li>10.3.   <a href="#rfc.section.10.3">Changes between *nat66-00 and *nat66-01</a>
</li>
<li>10.4.   <a href="#rfc.section.10.4">Changes between *nat66-01 and *nat66-02</a>
</li>
<li>10.5.   <a href="#rfc.section.10.5">Changes between *nat66-02 and *nat66-03</a>
</li>
<li>10.6.   <a href="#rfc.section.10.6">Changes between *nat66-03 and *nat66-04</a>
</li>
<li>10.7.   <a href="#rfc.section.10.7">Changes between *nat66-04 and *nat66-05</a>
</li>
<li>10.8.   <a href="#rfc.section.10.8">Changes between *nat66-05 and *nat66-06</a>
</li>
<li>10.9.   <a href="#rfc.section.10.9">Changes between *nat66-06 and *nat66-07</a>
</li>
<li>10.10.   <a href="#rfc.section.10.10">Changes between *nat66-07 and *nat66-08</a>
</li>
<li>10.11.   <a href="#rfc.section.10.11">Changes up to *nat66-10</a>
</li>
<li>10.12.   <a href="#rfc.section.10.12">Changes up to *nat66-11 and -12</a>
</li>
<li>11.   <a href="#rfc.references">References</a>
</li>
<li>11.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>11.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Why GSE?</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.Appendix%20B">Verification code</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">This document describes a stateless IPv6-to-IPv6 Network Prefix Translation (NPTv6) function, designed to provide address independence to the edge network. It is transport-agnostic with respect to transports that don't checksum the IP header, such as SCTP, and to transports that use the TCP/UDP/DCCP pseudo-header and <a href="#RFC1071">checksum</a> <cite title="NONE">[RFC1071]</cite>.</p>
<p id="rfc.section.1.p.2">This has several ramifications: </p>

<ul>
<li>Any security benefit that NAPT44 might offer is not present in NPTv6, necessitating the use of a firewall to obtain those benefits if desired. An example of such a firewall is described in <a href="#RFC6092">[RFC6092]</a>.</li>
<li>End to end reachability is preserved, although the address used "inside" the edge network differs from the address used "outside" the edge network. This has implications for application referrals and other uses of Internet layer addresses.</li>
<li>If there are multiple identically-configured prefix translators between two networks, there is no need for them to exchange dynamic state, as there is no dynamic state - the algorithmic translation will be identical across each of them. The network can therefore asymmetrically route, load-share, and fail-over among them without issue.</li>
<li>Since translation is 1:1 at the network layer, there is no need to modify port numbers or other transport parameters.</li>
<li>TCP sessions that authenticate peers using the <a href="#RFC5925">TCP Authentication Option</a> <cite title="NONE">[RFC5925]</cite> cannot have their addresses translated, as the addresses are used in the calculation of the Message Authentication Code. This consideration applies in general to any <a href="#RFC3424">UNilateral Self-Address Fixing (UNSAF)</a> <cite title="NONE">[RFC3424]</cite> Protocol, which the IAB recommends against the deployment of in an environment that changes Internet addresses.</li>
<li>Applications using the <a href="#RFC5996">Internet Key Exchange Protocol Version 2 (IKEv2)</a> <cite title="NONE">[RFC5996]</cite> should, at least in theory, detect the presence of the translator; while no NAT traversal solution is required, <a href="#RFC5996">[RFC5996]</a> would require such sessions to use UDP.</li>
</ul>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> What is Address Independence?</h1>
<p id="rfc.section.1.1.p.1">For the purposes of this document, IPv6 Address Independence consists of the following set of properties: </p>

<dl>
<dt>From the perspective of the edge network:</dt>
<dd style="margin-left: 8"><ul>
<li>The IPv6 addresses used inside the local network (for interfaces, access lists, and logs) do not need to be renumbered if the global prefix(es) assigned for use by the edge network are changed.</li>
<li>The IPv6 addresses used inside the edge network (for interfaces, access lists, and logs) or within other upstream networks (such as when multihoming) do not need to be renumbered when a site adds, drops, or changes upstream networks.</li>
<li>It is not necessary for an administration to convince an upstream network to route its internal IPv6 prefixes, or for it to advertise prefixes derived from other upstream networks into it.</li>
<li>Unless it wants to optimize routing between multiple upstream networks in the process of multihoming, there is therefore no need for a BGP exchange with the upstream network.</li>
</ul></dd>
<dt>From the perspective of the upstream network:</dt>
<dd style="margin-left: 8"><ul><li>IPv6 addresses used by the edge network are guaranteed to have a provider-allocated prefix, eliminating the need and concern for <a href="#RFC2827">BCP 38</a> <cite title="NONE">[RFC2827]</cite> ingress filtering and the advertisement of customer-specific prefixes.</li></ul></dd>
</dl>
<p id="rfc.section.1.1.p.2">Thus, address independence has ramifications for the edge network, networks it directly connects with (especially its upstream networks), and for the Internet as a whole. The desire for address independence has been a primary driver for IPv4 NAT deployment in medium to large-sized enterprise networks, including NAT deployments in enterprises that have plenty of IPv4 provider independent address space (from IPv4 "swamp space"). It has also been a driver for edge networks to become members of Regional Internet Registry (RIR) communities, seeking to obtain BGP Autonomous System Numbers and provider independent prefixes, and as a result has been one of the drivers of the explosion of the IPv4 route table. Service providers have stated that the lack of address independence from their customers has been a negative incentive to deployment, due to the impact of customer routing expected in their networks.</p>
<p id="rfc.section.1.1.p.3">The <a href="#RFC4864">Local Network Protection</a> <cite title="NONE">[RFC4864]</cite> document discusses a related concept called "Address Autonomy" as a benefit of NAPT44. <a href="#RFC4864">[RFC4864]</a> indicates that address autonomy can be achieved by the simultaneous use of global addresses on all nodes within a site that need external connectivity, and Unique Local Addresses (ULAs) <a href="#RFC4193">[RFC4193]</a> for all internal communication. However, this solution fails to meet the requirement for address independence, because if an ISP renumbering event occurs, all of the hosts, routers, DHCP servers, ACLs, firewalls and other internal systems that are configured with global addresses from the ISP will need to be renumbered before global connectivity is fully restored.</p>
<p id="rfc.section.1.1.p.4">The use of IPv6 Provider Independent (PI) addresses has also been suggested as a means to fulfill the address independence requirement.  However, this solution requires that an enterprise qualify to receive a PI assignment and persuade their ISP to install specific routes for the enterprise's PI addresses. There are a number of practical issues with this approach, especially if there is a desire to route to a number of geographically and topologically diverse set of sites, which can sometimes involve coordinating with several ISPs to route portions of a single PI prefix. These problems have caused numerous enterprises with plenty of IPv4 swamp space to choose to use IPv4 NAT for part, or substantially all, of their internal network instead of using their provider independent address space.</p>
<h1 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> NPTv6 Applicability</h1>
<p id="rfc.section.1.2.p.1">NPTv6 provides a simple and compelling solution to meet the Address Independence requirement in IPv6. The address independence benefit stems directly from the translation function of the network prefix translator. To avoid as many of the issues associated with NAPT44 as possible, NPTv6 is defined to include a two-way, checksum-neutral, algorithmic translation function, and nothing else.</p>
<p id="rfc.section.1.2.p.2">The fact that NPTv6 does not map ports and is checksum-neutral avoids the need for an NPTv6 Translator to re-write transport layer headers. This makes it feasible to deploy new or improved transport layer protocols without upgrading NPTv6 Translators. Similarly, since NPTv6 does not re-write transport layer headers, NPTv6 will not interfere with encryption of the full IP payload in many cases.</p>
<p id="rfc.section.1.2.p.3">The default NPTv6 address mapping mechanism is purely algorithmic, so NPTv6 translators do not need to maintain per-node or per-connection state, allowing deployment of more robust and adaptive networks than can be deployed using NAPT44. Since the default NPTv6 mapping can be performed in either direction, it does not interfere with inbound connection establishment, thus allowing internal nodes to participate in direct Peer-to-Peer applications without the application layer overhead one finds in many IPv4 Peer-to-Peer applications.</p>
<p id="rfc.section.1.2.p.4">Although NPTv6 compares favorably to NAPT44 in several ways, it does not eliminate all of the architectural problems associated with IPv4 NAT, as described in <a href="#RFC2993">[RFC2993]</a>. NPTv6 involves modifying IP headers in transit, so it is not compatible with security mechanisms, such as the IPsec Authentication Header, that provide integrity protection for the IP header. NPTv6 may interfere with the use of application protocols that transmit IP addresses in the application-specific portion of the IP packet. These applications currently require application layer gateways (ALGs) to work correctly through NAPT44 devices, and similar ALGs may be required for these applications to work through NPTv6 Translators. The use of separate internal and external prefixes creates complexity for DNS deployment, due to the desire for internal nodes to communicate with other internal nodes using internal addresses, while external nodes need to obtain external addresses to communicate with the same nodes. This frequently results in the deployment of "split DNS", which may add complexity to network configuration.</p>
<p id="rfc.section.1.2.p.5">The choice of address within the edge network bears consideration.  One could use a ULA, which maximizes address independence. That could also be considered a misuse of the ULA; if the expectation is that a ULA prevents access to a system from outside the range of the ULA, NPTv6 overrides that. On the other hand, the administration is aware that it has made that choice, and could if it desired deploy a second ULA for the purpose of privacy; the only prefix that will be translated is one that has an NPTv6 Translator configured to translate to or from it. Also, using any other global scope address format makes one either obtain a PI prefix or be at the mercy of the agency from which it was allocated.</p>
<p id="rfc.section.1.2.p.6">There are significant technical impacts associated with the deployment of any prefix translation mechanism, including NPTv6, and we strongly encourage anyone who is considering the implementation or deployment of NPTv6 to read <a href="#RFC4864">[RFC4864]</a> and <a href="#RFC5902">[RFC5902]</a>, and to carefully consider the alternatives described in that document, some of which may cause fewer problems than NPTv6.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> NPTv6 Overview</h1>
<p id="rfc.section.2.p.1">NPTv6 may be implemented in an IPv6 router to map one IPv6 address prefix to another IPv6 prefix as each IPv6 packet transits the router. A router that implements an NPTv6 prefix translation function is referred to as an NPTv6 Translator.</p>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> NPTv6: the simplest case</h1>
<p id="rfc.section.2.1.p.1">In its simplest form, an NPTv6 Translator interconnects two network links, one of which is an "internal" network link attached to a leaf network within a single administrative domain, and the other of which is an "external" network with connectivity to the global Internet. All of the hosts on the internal network will use addresses from a single, locally-routed prefix, and those addresses will be translated to/from addresses in a globally-routable prefix as IP packets transit the NPTv6 Translator. The lengths of these two prefixes will be functionally the same; if they differ, the longer of the two will limit the ability to use subnets in the shorter.</p>
<div id="#rfc.figure.1"></div>
<div id="#simpleNPTv6"></div>
<pre> 
External Network:  Prefix = 2001:0DB8:0001:/48 
    --------------------------------------
                      |
                      |
               +-------------+
               |     NPTv6   |
               |  Translator |
               +-------------+
                      |
                      |
    --------------------------------------
Internal Network:  Prefix = FD01:0203:0405:/48
</pre>
<p><a href="#simpleNPTv6">Figure 1</a> shows an NPTv6 Translator attached to two networks. In this example, the internal network uses <a href="#RFC4193">IPv6 Unique Local Addresses (ULAs)</a> <cite title="NONE">[RFC4193]</cite> to represent the internal IPv6 nodes, and the external network uses globally routable IPv6 addresses to represent the same nodes.</p>
<p id="rfc.section.2.1.p.3">When an NPTv6 Translator forwards packets in the "outbound" direction, from the internal network to the external network, NPTv6 overwrites the IPv6 source prefix (in the IPv6 header) with a corresponding external prefix. When packets are forwarded in the "inbound" direction, from the external network to the internal network, the IPv6 destination prefix is overwritten with a corresponding internal prefix. Using the prefixes shown in the diagram above, as an IP packet passes through the NPTv6 Translator in the outbound direction, the source prefix (FD01:0203:0405:/48) will be overwritten with the external prefix (2001:0DB8:0001:/48). In an inbound packet, the destination prefix (2001:0DB8:0001:/48) will be overwritten with the internal prefix (FD01:0203:0405:/48). In both cases, it is the local IPv6 prefix that is overwritten; the remote IPv6 prefix remains unchanged. Nodes on the internal network are said to be "behind" the NPTv6 Translator.</p>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> NPTv6 between peer networks</h1>
<p id="rfc.section.2.2.p.1">NPTv6 can also be used between two private networks. In these cases, both networks may use ULA prefixes, with each subnet in one network mapped into a corresponding subnet in the other network, and vice versa. Or, each network may use ULA prefixes for internal addressing, and global unicast addresses on the other network.</p>
<div id="#rfc.figure.2"></div>
<div id="#flow"></div>
<pre> 
    Internal Prefix = FD01:4444:5555:/48
    --------------------------------------
         V            |      External Prefix
         V            |      2001:0DB8:6666:/48
         V        +---------+      ^
         V        |  NPTv6  |      ^
         V        |  Device |      ^
         V        +---------+      ^
External Prefix       |            ^
2001:0DB8:0001:/48    |            ^
    --------------------------------------
    Internal Prefix = FD01:0203:0405:/48
</pre>
<h1 id="rfc.section.2.3">
<a href="#rfc.section.2.3">2.3.</a> NPTv6 redundancy and load-sharing</h1>
<p id="rfc.section.2.3.p.1">In some cases, more than one NPTv6 Translator may be attached to a network, as shown in <a href="#parallel">Figure 3</a>. In such cases, NPTv6 Translators are configured with the same internal and external prefixes. Since there is only one translation, even though there are multiple translators, they map only one external address (prefix and IID) to the internal address.</p>
<div id="#rfc.figure.3"></div>
<div id="#parallel"></div>
<pre> 
External Network:  Prefix = 2001:0DB8:0001:/48 
    --------------------------------------
           |                      |
           |                      |
    +-------------+        +-------------+
    |  NPTv6      |        |  NPTv6      |
    |  Translator |        |  Translator |
    |   #1        |        |   #2        |
    +-------------+        +-------------+
           |                      |
           |                      |
    --------------------------------------
Internal Network:  Prefix = FD01:0203:0405:/48
</pre>
<h1 id="rfc.section.2.4">
<a href="#rfc.section.2.4">2.4.</a> NPTv6 multihoming</h1>
<div id="#rfc.figure.4"></div>
<div id="#distinct"></div>
<pre> 
   External Network #1:          External Network #2:
Prefix = 2001:0DB8:0001:/48    Prefix = 2001:0DB8:5555:/48
---------------------------    --------------------------
                |                      |
                |                      |
         +-------------+        +-------------+
         |  NPTv6      |        |  NPTv6      |
         |  Translator |        |  Translator |
         |   #1        |        |   #2        |
         +-------------+        +-------------+
                |                      |
                |                      |
         --------------------------------------
     Internal Network:  Prefix = FD01:0203:0405:/48
</pre>
<p id="rfc.section.2.4.p.1">When multihoming, NPTv6 Translators are attached to an internal network, as shown in <a href="#distinct">Figure 4</a>, but connected to different external networks. In such cases, NPTv6 Translators are configured with the same internal prefix, but different external prefixes. Since there are multiple translations, they map multiple external addresses (prefix and IID) to the common internal address. A system within the edge network is unable to determine which external address it is using apart from services such as STUN.</p>
<p id="rfc.section.2.4.p.2">Multihoming in this sense has one negative feature as compared with multihoming with a provider independent address; when routes change between NPTv6 Translators, since the upstream network changes, the translated prefix can change. This would cause sessions and referrals dependent on it to fail as well. This is not expected to be a major issue, however, in networks where routing is generally stable.</p>
<h1 id="rfc.section.2.5">
<a href="#rfc.section.2.5">2.5.</a> Mapping with No Per-Flow State</h1>
<p id="rfc.section.2.5.p.1">When NPTv6 is used as described in this document, no per-node or per-flow state is maintained in the NPTv6 Translator. Both inbound and outbound packets are translated algorithmically, using only information found in the IPv6 header. Due to this property, NPTv6's two-way, algorithmic address mapping can support both outbound and inbound connection establishment without the need for state-priming or rendezvous mechanisms, or the maintenance of mapping state. This is a significant improvement over NAPT44 devices, but it also has significant security implications which are described in <a href="#security">Section 7</a>.</p>
<h1 id="rfc.section.2.6">
<a href="#rfc.section.2.6">2.6.</a> Checksum-Neutral Mapping</h1>
<p id="rfc.section.2.6.p.1">When a change is made to one of the IP header fields in the IPv6 pseudo-header checksum (such as one of the IP addresses), the checksum field in the transport layer header may become invalid. Fortunately, an incremental change in the area covered by the Internet standard checksum <a href="#RFC1071">[RFC1071]</a> will result in a well-defined change to the checksum value <a href="#RFC1624">[RFC1624]</a>. So, a checksum change caused by modifying part of the area covered by the checksum can be corrected by making a complementary change to a different 16-bit field covered by the same checksum.</p>
<p id="rfc.section.2.6.p.2">The NPTv6 mapping mechanisms described in this document are checksum-neutral, which means that they result in IP headers that will generate the same IPv6 pseudo-header checksum when the checksum is calculated using the standard Internet checksum algorithm <a href="#RFC1071">[RFC1071]</a>. Any changes that are made during translation of the IPv6 prefix are offset by changes to other parts of the IPv6 address. This results in transport layers that use the Internet checksum (such as TCP and UDP) calculating the same IPv6 pseudo header checksum for both the internal and external forms of the same packet, which avoids the need for the NPTv6 Translator to modify those transport layer headers to correct the checksum value.</p>
<p id="rfc.section.2.6.p.3">As noted in <a href="#FFFF">Section 4.2</a>, this mapping results in an edge network using a /48 external prefix to be unable to use subnet 0xFFFF.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> NPTv6 Algorithmic Specification</h1>
<p id="rfc.section.3.p.1">The <a href="#RFC4291">[RFC4291]</a> IPv6 Address is reproduced for clarity in <a href="#address">Figure 5</a>.</p>
<div id="#rfc.figure.5"></div>
<div id="#address"></div>
<pre> 
 0    15 16   31 32   47 48   63 64   79 80   95 96  111 112  127
+-------+-------+-------+-------+-------+-------+-------+-------+
|     Routing Prefix    | Subnet|   Interface Identifier (IID)  |
+-------+-------+-------+-------+-------+-------+-------+-------+
</pre>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#configuration" id="configuration">NPTv6 configuration calculations</a>
</h1>
<p id="rfc.section.3.1.p.1">When an NPTv6 Translation function is configured, it is configured with </p>

<ul>
<li>one or more "internal" interfaces with their "internal" routing domain prefixes, and</li>
<li>one or more "external" interfaces with their "external" routing domain prefixes.</li>
</ul>
<p id="rfc.section.3.1.p.2">In the simple case, there is one of each. If a single router provides NPTv6 translation services between a multiplicity of domains (as might be true when multihoming), each internal/external pair must be thought of as a separate NPTv6 Translator from the perspective of this specification.</p>
<p id="rfc.section.3.1.p.3">When an NPTv6 Translator is configured, the translation function first ensures that the internal and external prefixes are the same length, if necessary by extending the shorter of the two with zeroes.  These two prefixes will be used in the prefix translation function described in <a href="#leaving">Section 3.2</a> and <a href="#returning">Section 3.3</a>.</p>
<p id="rfc.section.3.1.p.4">They are then zero-extended to /64, for the purposes of a calculation. The translation function calculates the ones-complement sum of the 16 bit words of the /64 external prefix and the /64 internal prefix. It then calculates the difference between these values: internal minus external. This value, called the "adjustment", is effectively constant for the lifetime of the NPTv6 Translator configuration, and used in per-packet processing.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#leaving" id="leaving">NPTv6 translation, internal network to external network</a>
</h1>
<p id="rfc.section.3.2.p.1">When a datagram passes through the NPTv6 Translator from an internal to an external network, its IPv6 Source Address is changed in two ways: </p>

<ul>
<li>If the internal subnet number has no mapping, such as being 0xFFFF or simply not mapped, discard the datagram. This SHOULD result in an ICMP Destination Unreachable.</li>
<li>The internal prefix is overwritten with the external prefix, in effect subtracting the difference between the two checksums (the adjustment) from the pseudo-header's checksum, and</li>
<li>A 16-bit word of the address has the adjustment added to it using one's complement arithmetic. If the result is 0xFFFF, it is overwritten as zero. The choice of word is as specified in <a href="#slash48">Section 3.4</a> or <a href="#slash56">Section 3.5</a> as appropriate.</li>
</ul>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#returning" id="returning">NPTv6 translation, external network to internal network</a>
</h1>
<p id="rfc.section.3.3.p.1">When a datagram passes through the NPTv6 Translator from an external to an internal network, its IPv6 Destination Address is changed in two ways: </p>

<ul>
<li>The external prefix is overwritten with the internal prefix, in effect adding the difference between the two checksums (the adjustment) to the pseudoheader's checksum, and</li>
<li>A 16-bit word of the address has the adjustment subtracted from it (bitwise inverted and added to it) it using one's complement arithmetic. If the result is 0xFFFF, it is overwritten as zero.  The choice of word is as specified in <a href="#slash48">Section 3.4</a> or <a href="#slash56">Section 3.5</a> as appropriate.</li>
</ul>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> <a href="#slash48" id="slash48">NPTv6 with a /48 or shorter prefix</a>
</h1>
<p id="rfc.section.3.4.p.1">When an NPTv6 Translator is configured with internal and external prefixes that are 48 bits in length (a /48) or shorter, the adjustment MUST be added to or subtracted from bits 48..63 of the address.</p>
<p id="rfc.section.3.4.p.2">This mapping results in no modification of the Interface Identifier (IID), which is held in the lower half of the IPv6 address, so it will not interfere with future protocols that may use unique IIDs for node identification.</p>
<p id="rfc.section.3.4.p.3">NPTv6 Translator implementations MUST implement the /48 mapping.</p>
<h1 id="rfc.section.3.5">
<a href="#rfc.section.3.5">3.5.</a> <a href="#slash56" id="slash56">NPTv6 with a /49 or longer prefix</a>
</h1>
<p id="rfc.section.3.5.p.1">When an NPTv6 Translator is configured with internal and external prefixes that are longer than 48 bits in length (such as a /52, /56, or /60), the adjustment must be added to or subtracted from one of the words in bits 64..79, 80..95, 96..111, or 112..127 of the address.  While the choice of word is immaterial as long as it is consistent, for consistency's sake, these words MUST be inspected in that sequence, and the first that is not initially 0xFFFF chosen.</p>
<p id="rfc.section.3.5.p.2">NPTv6 Translator implementations SHOULD implement the mapping for longer prefixes.</p>
<h1 id="rfc.section.3.6">
<a href="#rfc.section.3.6">3.6.</a> <a href="#example48" id="example48">/48 Prefix Mapping Example</a>
</h1>
<p id="rfc.section.3.6.p.1">For the network shown in <a href="#simpleNPTv6">Figure 1</a>, the Internal Prefix is FD01:0203:0405:/48, and the External Prefix is 2001:0DB8:0001:/48.</p>
<p id="rfc.section.3.6.p.2">If a node with internal address FD01:0203:0405:0001::1234 sends an outbound packet through the NPTv6 Translator, the resulting external address will be 2001:0DB8:0001:D550::1234. The resulting address is obtained by calculating the checksum of both the internal and external 48-bit prefixes, subtracting the internal prefix from the external prefix using one's complement arithmetic to calculate the "adjustment", and adding the adjustment to the 16-bit subnet field (in this case 0x0001).</p>
<p id="rfc.section.3.6.p.3">To show the work:</p>
<p id="rfc.section.3.6.p.4">The one's complement checksum of FD01:0203:0405 is 0xFCF5. The one's complement checksum of 2001:0DB8:0001 is 0xD245. Using one's complement arithmetic, 0xD245 - 0xFCF5 = 0xD54F. The subnet in the original packet is 0x0001. Using one's complement arithmetic, 0x0001 + 0xD54F = 0xD550. Since 0xD550 != 0xFFFF, it is not changed to 0x0000.</p>
<p id="rfc.section.3.6.p.5">So, the value 0xD550 is written in the 16-bit subnet area, resulting in a mapped external address of 2001:0DB8:0001:D550::1234.</p>
<p id="rfc.section.3.6.p.6">When a response packet is received, it will contain the destination address 2001:0DB8:0001:D550::0001, which will be mapped using the inverse mapping algorithm, back to FD01:0203:0405:0001::1234.</p>
<p id="rfc.section.3.6.p.7">In this case, the difference between the two prefixes will be calculated as follows:</p>
<p id="rfc.section.3.6.p.8">Using one's complement arithmetic, 0xFCF5 - 0xD245 = 0x2AB0. The subnet in the original packet = 0xD550. Using one's complement arithmetic, 0xD550 + 0x2AB0 = 0x0001. Since 0x0001 != 0xFFFF, it is not changed to 0x0000.</p>
<p id="rfc.section.3.6.p.9">So the value 0x0001 is written into the subnet field, and the internal value of the subnet field is properly restored.</p>
<h1 id="rfc.section.3.7">
<a href="#rfc.section.3.7">3.7.</a> Address Mapping for Longer Prefixes</h1>
<p id="rfc.section.3.7.p.1">If the prefix being mapped is longer than 48 bits, the algorithm is slightly more complex. A common case will be that the internal and external prefixes are of different length. In such a case, the shorter prefix is zero-extended to the length of the longer as described in <a href="#configuration">Section 3.1</a> for the purposes of overwriting the prefix. Then, they are both zero-extended to 64 bits to facilitate one's complement arithmetic. The "adjustment" is calculated using those 64 bit prefixes.</p>
<p id="rfc.section.3.7.p.2">For example if the internal prefix is a /48 ULA and the external prefix is a /56 provider-allocated prefix, the ULA becomes a /56 with zeros in bits 48..55. For purposes of one's complement arithmetic, they are then both zero-extended to 64 bits. A side-effect of this is that a subset of the subnets possible in the shorter prefix are untranslatable. While the security value of this is debatable, the administration may choose to use them for subnets that it knows need no external accessibility.</p>
<p id="rfc.section.3.7.p.3">We then find the first word in the IID that does not have the value 0xFFFF, trying bits 64..79, and then 80..95, 96..111, and finally 112..127. We perform the same calculation (with the same proof of correctness) as in <a href="#example48">Section 3.6</a>, but applying it to that word.</p>
<p id="rfc.section.3.7.p.4">Although any 16-bit portion of an IPv6 IID could contain 0xFFFF, an IID of all-ones is a reserved anycast identifier that should not be used on the network <a href="#RFC2526">[RFC2526]</a>. If an NPTv6 Translator discovers a packet with an IID of all-zeros while performing address mapping, that packet MUST be dropped, and an ICMPv6 Parameter Problem error SHOULD be generated <a href="#RFC4443">[RFC4443]</a>.</p>
<p id="rfc.section.3.7.p.5">Note: this mechanism does involve modification of the IID; it may not be compatible with future mechanisms that use unique IIDs for node identification.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Implications of Network Address Translator Behavioral Requirements</h1>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> Prefix configuration and generation</h1>
<p id="rfc.section.4.1.p.1">NPTv6 Translators MUST support manual configuration of internal and external prefixes, and MUST NOT place any restrictions on those prefixes except that they be valid IPv6 unicast prefixes as described in <a href="#RFC4291">[RFC4291]</a>. They MAY also support random generation of ULA addresses on command. Since the most common place anticipated for the implementation of an NPTv6 Translator is a CPE router, the reader is urged to consider the requirements of <a href="#I-D.ietf-v6ops-ipv6-cpe-router">[I-D.ietf-v6ops-ipv6-cpe-router]</a>.</p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#FFFF" id="FFFF">Subnet numbering</a>
</h1>
<p id="rfc.section.4.2.p.1">For reasons detailed in <a href="#math">Appendix Appendix B</a>, a network using NPTv6 Translation and a /48 external prefix MUST NOT use the value 0xFFFF to designate a subnet that it expects to be translated.</p>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#requirements" id="requirements">NAT Behavioral Requirements</a>
</h1>
<p id="rfc.section.4.3.p.1">NPTv6 Translators MUST support hairpinning behavior, as defined in the NAT Behavioral Requirements for UDP document <a href="#RFC4787">[RFC4787]</a>. This means that when an NPTv6 Translator receives a packet on the internal interface that has a destination address that matches the site's external prefix, it will translate the packet and forward it internally. This allows internal nodes to reach other internal nodes using their external, global addresses when necessary.</p>
<p id="rfc.section.4.3.p.2">Conceptually, the datagram leaves the domain (is translated as described in <a href="#leaving">Section 3.2</a>), and returns (is again translated as described in <a href="#returning">Section 3.3</a>). As a result, the datagram exchange will be through the NPTv6 Translator in both directions for the lifetime of the session. The alternative would be to require the NPTv6 Translator to drop the datagram, forcing the sender to use the correct internal prefix for its peer. Performing only the external-to-internal translation results in the datagram being sent from the untranslated internal address of the source to the translated and therefore internal address of its peer, which would enable the session to bypass the NPTv6 Translator for future datagrams. It would also mean that the original sender would be unlikely to recognize the response when it arrived.</p>
<p id="rfc.section.4.3.p.3">Because NPTv6 does not perform port mapping and uses a one-to-one, reversible mapping algorithm, none of the other NAT behavioral requirements apply to NPTv6.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> Implications for Applications</h1>
<p id="rfc.section.5.p.1">NPTv6 Translation does not create several of the problems known to exist with other kinds of NATs and discussed in <a href="#RFC2993">[RFC2993]</a>. In particular: NPTv6 Translation is stateless, so a "reset" or brief outage of an NPTv6 Translator does not break connections that traverse the translation function, and if multiple NPTv6 Translators exist between the same two networks, load can shift or be dynamically load-shared among them. Also, an NPTv6 Translator does not aggregate traffic for several hosts/interfaces behind a lesser number of external addresses, so there is no inherent expectation for an NPTv6 Translator to block new inbound flows from external hosts, and no issue with a filter or blacklist associated with one prefix within the domain affecting another. A firewall can of course be used in conjunction with NPTv6 Translator; this would allow the network administrator more flexibility to specify security policy than would be possible with a traditional NAT.</p>
<p id="rfc.section.5.p.2">However, NPTv6 Translation does create difficulties for some kinds of applications. Some examples include: </p>

<ul>
<li>An application instance "behind" an NPTv6 Translator will see a different address for its connections than its peers "outside" the NPTv6 Translator.</li>
<li>An application instance "outside" an NPTv6 Translator will see a different address for its connections than any peer "inside" an NPTv6 Translator.</li>
<li>An application instance wishing to establish communication with a peer "behind" an NPTv6 Translator may need to use a different address to reach that peer depending on whether the instance is behind the same NPTv6 Translator or external to it. Since an NPTv6 Translator implements <a href="#requirements">hairpinning</a> <cite title="NONE">[requirements]</cite>, it suffices for applications to always use their external addresses. However, this creates inefficiencies in the local network and may also complicate implementation of the NPTv6 Translator. <a href="#RFC3484">[RFC3484]</a> also would prefer the private address in such a case in order to reduce those inefficiencies.</li>
<li>An application instance which moves from a realm "behind" an NPTv6 Translator to a realm that is "outside" the network, or vice versa, may find that it is no longer able to reach its peers at the same addresses it was previously able to use.</li>
<li>An application instance which is intermittently communicating with a peer that moves from behind an NPTv6 Translator to "outside" of it, or vice versa, may find that it is no longer able to reach that peer at the same address that it had previously used.</li>
</ul>
<p id="rfc.section.5.p.3">Many, but not all, of the applications which are adversely affected by NPTv6 Translation are those that do "referrals" - where an application instance passes its own addresses, and/or addresses of its peers, to other peers. (Some believe referrals are inherently undesirable; others believe that they are necessary in some circumstances. A discussion of the merits of referrals, or lack thereof, is beyond the scope of this document.)</p>
<p id="rfc.section.5.p.4">To some extent, the incidence of these difficulties can be reduced by DNS hacks that attempt to expose addresses "behind" an NPTv6 Translator only to hosts which are also behind the same NPTv6 Translator; and perhaps also, to expose only the "internal" addresses of hosts behind the NPTv6 Translator to other hosts behind the same NPTv6 Translator.  However, this cannot be a complete solution. A full discussion of these issues is out of scope for this document, but briefly: (a) reliance on DNS to solve this problem depends on hosts always making queries from DNS servers in the same realm as they are (or on DNS interception proxies, which create their own problems), and on mobile hosts/applications not caching those results; (b) reliance on DNS to solve this problem depends on network administrators on all networks using such applications to reliably and accurately maintain current DNS entries for every host using those applications; and (c) reliance on DNS to solve this problem depends on applications always using DNS names, even though they often must run in environments where DNS names are not reliably maintained for every host. Other issues are that there is often no single distinguished name for a host, no reliable way for a host to determine what DNS names are associated with it, and which names are appropriate to use in which contexts.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Recommendation for network planners considering use of NPTv6 Translation</h1>
<p id="rfc.section.5.1.p.1">In light of the above, network planners considering the use of NPTv6 translation should carefully consider the kinds of applications that they will need to run in the future, and determine whether the address stability and provider independence benefits are consistent with their application requirements.</p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> Recommendations for application writers</h1>
<p id="rfc.section.5.2.p.1">Several mechanisms (e.g. STUN, TURN, ICE) have been used with traditional IPv4 NAT to circumvent some of the limitations of such devices. Similar mechanisms could also be applied to circumvent some of the issues with NPTv6 Translator. However, all of these require the assistance of an external server or a function co-located with the translator that can tell an "internal" host what its "external" addresses are.</p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> Recommendation for future work</h1>
<p id="rfc.section.5.3.p.1">It might be desirable to define a general mechanism which would allow hosts within a translation domain to determine their external addresses and/or request that inbound traffic be permitted. If such a mechanism were to be defined, it would ideally be general enough to also accommodate other types of NAT likely to be encountered by IPV6 applications - in particular, <a href="#I-D.ietf-behave-v6v4-framework">IPv4/IPv6 Translation</a> <cite title="NONE">[I-D.ietf-behave-v6v4-framework]</cite> <a href="#I-D.ietf-behave-dns64">[I-D.ietf-behave-dns64]</a> <a href="#I-D.ietf-behave-v6v4-xlate">[I-D.ietf-behave-v6v4-xlate]</a> <a href="#I-D.ietf-behave-v6v4-xlate-stateful">[I-D.ietf-behave-v6v4-xlate-stateful]</a> <a href="#RFC6052">[RFC6052]</a>. For this and other reasons, such a mechanism is beyond the scope of this document.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> A Note on Port Mapping</h1>
<p id="rfc.section.6.p.1">In addition to overwriting IP addresses when packets are forwarded, NAPT44 devices overwrite the source port number in outbound traffic, and the destination port number in inbound traffic. This mechanism is called "port mapping".</p>
<p id="rfc.section.6.p.2">The major benefit of port mapping is that it allows multiple computers to share a single IPv4 address. A large number of internal IPv4 addresses (typically from one of the <a href="#RFC1918">[RFC1918]</a> private address spaces) can be mapped into a single external, globally routable IPv4 address, with the local port number used to identify which internal node should receive each inbound packet. This address amplification feature is not generally foreseen as a necessity at this time.</p>
<p id="rfc.section.6.p.3">Since port mapping requires re-writing a portion of the transport layer header, it requires NAPT44 devices to be aware of all of the transport protocols that they forward, thus stifling the development of new and improved transport protocols and preventing the use of IPsec encryption. Modifying the transport layer header is incompatible with security mechanisms that encrypt the full IP payload, and restricts the NAPT44 to forwarding transport layers that use weak checksum algorithms that are easily recalculated in routers.</p>
<p id="rfc.section.6.p.4">Since there is significant detriment caused by modifying transport layer headers and very little, if any, benefit to the use of port mapping in IPv6, NPTv6 Translators that comply with this specification MUST NOT perform port mapping.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.7.p.1">When NPTv6 is deployed using either of the two-way, algorithmic mappings defined in the document, it allows direct inbound connections to internal nodes. While this can be viewed as a benefit of NPTv6 vs.  NAPT44, it does open internal nodes to attacks that would be more difficult in a NAPT44 network. Although this situation is not substantially worse, from a security standpoint, than running IPv6 with no NAT, some enterprises may assume that an NPTv6 Translator will offer similar protection to a NAPT44 device.</p>
<p id="rfc.section.7.p.2">The port mapping mechanism in NAPT44 implementations requires that state be created in both directions. This has lead to an industry-wide perception that NAT functionality is the same as a stateful firewall. It is not. The translation function of the NAT only creates dynamic state in one direction and has no policy. For this reason, it is RECOMMENDED that NPTv6 Translators also implement firewall functionality such as described in <a href="#RFC6092">[RFC6092]</a>, with appropriate configuration options including turning it on or off.</p>
<p id="rfc.section.7.p.3">When <a href="#RFC4864">[RFC4864]</a> talks about randomizing the subnet identifier, the idea is to make it harder for worms to guess a valid subnet identifier at an advertised network prefix. This should not be interpreted as endorsing concealing the subnet identifier behind the obfuscating function of a translator such as NPTv6. <a href="#RFC4864">[RFC4864]</a> specifically talks about how to obtain the desired properties of concealment without using a translator. Topology hiding when using NAT is often ineffective in environments where the topology is visible in application layer messaging protocols such as DNS, SIP, SMTP, etc. If the information were not available through the application layer, <a href="#RFC2993">[RFC2993]</a> would not be valid.</p>
<p id="rfc.section.7.p.4">Due to the potential interactions with IKEv2/IPsec NAT traversal, it would be valuable to test interactions of NPTv6 with various aspects of current-day IKEv2/IPsec NAT traversal.</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> IANA Considerations</h1>
<p id="rfc.section.8.p.1">This document has no IANA considerations.</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> Acknowledgements</h1>
<p id="rfc.section.9.p.1">The checksum-neutral algorithmic address mapping described in this document is based on e-mail written by Iljtsch van Beijnum.</p>
<p id="rfc.section.9.p.2">The following people provided advice or review comments that substantially improved this document: Allison Mankin, Christian Huitema, Dave Thaler, Ed Jankiewicz, Eric Kline, Iljtsch van Beijnum, Jari Arkko, Keith Moore, Mark Townsley, Merike Kaeo, Ralph Droms, Remi Depres, Steve Blake, and Tony Hain.</p>
<p id="rfc.section.9.p.3">This document was written using the xml2rfc tool described in RFC 2629 <a href="#RFC2629">[RFC2629]</a>.</p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> Change Log</h1>
<p id="rfc.section.10.p.1">This section should be removed by the RFC Editor.</p>
<h1 id="rfc.section.10.1">
<a href="#rfc.section.10.1">10.1.</a> Changes Between draft-mrw-behave-nat66-00 and -01</h1>
<p id="rfc.section.10.1.p.1">There were several minor changes made between the *behave-nat66-00 and -01 versions of this draft: </p>

<ul>
<li>Added Fred Baker as a co-author.</li>
<li>Minor arithmetic corrections.</li>
<li>Added AH to paragraph on NAT security issues.</li>
<li>Added additional NAT topologies to overview (diagrams TBD).</li>
</ul>
<h1 id="rfc.section.10.2">
<a href="#rfc.section.10.2">10.2.</a> Changes between *behave-nat66-01 and -02</h1>
<p id="rfc.section.10.2.p.1">There were further changes made between *behave-nat66-01 and -02: </p>

<ul>
<li>Removed topology hiding mechanism.</li>
<li>Added diagrams.</li>
<li>Made minor updates based on mailing list feedback.</li>
<li>Added discussion of IPv6 SAF document.</li>
<li>Added applicability section.</li>
<li>Added discussion of Address Independence requirement.</li>
<li>Added hairpinning requirement and discussion of applicability of other NAT behavioral requirements.</li>
</ul>
<h1 id="rfc.section.10.3">
<a href="#rfc.section.10.3">10.3.</a> Changes between *nat66-00 and *nat66-01</h1>
<p id="rfc.section.10.3.p.1">There were further changes made between nat66-01 and nat66-02: </p>

<ul>
<li>Added mapping for prefixes longer than /48.</li>
<li>Change draft name to remove reference to the behave WG.</li>
<li>Resolved various open issues and fixed typos.</li>
</ul>
<h1 id="rfc.section.10.4">
<a href="#rfc.section.10.4">10.4.</a> Changes between *nat66-01 and *nat66-02</h1>
<p></p>

<ul>
<li>Change the acronym "NAT66" to "NPTv6", so people don't read "NAT" and MEGO.</li>
<li>Change the term used to refer to the function from "NAT66 device" to "NPTv6 Translator". It's not a "device" function, it's a function that is applied between two interfaces. Consider a router with two upstreams and two legs in the local network; it will not translate between the local legs, but will translate to and from each upstream, and be configured differently for each of the two ISPs.</li>
<li>Comment specifically on the security aspects.</li>
<li>Comment specifically on the application issues raised on this list.</li>
<li>Comment specifically on multihoming, load-sharing, and asymmetric routing.</li>
<li>Spell out the hairpinning requirement and its implications.</li>
<li>Spell out the service provider side of Address Independence.</li>
<li>00 focuses on the edge's view</li>
<li>Detail the algorithm in a manner clearer to the implementor (I think)</li>
<li>Spell out the case for GSE-style DMZs between the edge and the transit network, which is about the implications for the global routing table.</li>
<li>Refer to <a href="#RFC6092">[RFC6092]</a> as a CPE firewall description.</li>
</ul>
<h1 id="rfc.section.10.5">
<a href="#rfc.section.10.5">10.5.</a> Changes between *nat66-02 and *nat66-03</h1>
<p></p>

<ul>
<li>Added an appendix on Verification code</li>
<li>Various minor markups in response to Ralph Droms</li>
</ul>
<h1 id="rfc.section.10.6">
<a href="#rfc.section.10.6">10.6.</a> Changes between *nat66-03 and *nat66-04</h1>
<p></p>

<ul>
<li>Markups in response to Christian Huitema, mostly surrounding the issue of subnet 0xFFFF.</li>
<li>Refer to <a href="#I-D.ietf-v6ops-ipv6-cpe-router">[I-D.ietf-v6ops-ipv6-cpe-router]</a> for CPE router requirements.</li>
</ul>
<h1 id="rfc.section.10.7">
<a href="#rfc.section.10.7">10.7.</a> Changes between *nat66-04 and *nat66-05</h1>
<p></p>

<ul>
<li>Update statistics in appendix A per BGP report of 17 December 2010</li>
<li>Update security considerations using text supplied by Merike Kaeo.</li>
</ul>
<h1 id="rfc.section.10.8">
<a href="#rfc.section.10.8">10.8.</a> Changes between *nat66-05 and *nat66-06</h1>
<p></p>

<ul><li>restore a code snippet inadvertently removed in version -05</li></ul>
<h1 id="rfc.section.10.9">
<a href="#rfc.section.10.9">10.9.</a> Changes between *nat66-06 and *nat66-07</h1>
<p></p>

<ul>
<li>Changed requested status to experimental</li>
<li>Incorporated comments from Eric Kline</li>
</ul>
<h1 id="rfc.section.10.10">
<a href="#rfc.section.10.10">10.10.</a> Changes between *nat66-07 and *nat66-08</h1>
<p id="rfc.section.10.10.p.1">The section on Application Considerations was expanded after discussion with Keith Moore.</p>
<h1 id="rfc.section.10.11">
<a href="#rfc.section.10.11">10.11.</a> Changes up to *nat66-10</h1>
<p id="rfc.section.10.11.p.1">Address review comments during IETF Last Call and the Transport Directorate Review.</p>
<h1 id="rfc.section.10.12">
<a href="#rfc.section.10.12">10.12.</a> Changes up to *nat66-11 and -12</h1>
<p id="rfc.section.10.12.p.1">Address Dave Thaler's comments, mostly editorial, bit also addressing UNSAF protocols like the TCP Authentication Option.</p>
<h1 id="rfc.references">
<a href="#rfc.references">11.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">11.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2526">[RFC2526]</b></td>
<td class="top">
<a href="mailto:dbj@cs.cmu.edu" title="Carnegie Mellon University">Johnson, D.</a> and <a href="mailto:deering@cisco.com" title="Cisco Systems, Inc.">S. Deering</a>, "<a href="http://tools.ietf.org/html/rfc2526">Reserved IPv6 Subnet Anycast Addresses</a>", RFC 2526, March 1999.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4193">[RFC4193]</b></td>
<td class="top">
<a>Hinden, R.</a> and <a>B. Haberman</a>, "<a href="http://tools.ietf.org/html/rfc4193">Unique Local IPv6 Unicast Addresses</a>", RFC 4193, October 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4291">[RFC4291]</b></td>
<td class="top">
<a>Hinden, R.</a> and <a>S. Deering</a>, "<a href="http://tools.ietf.org/html/rfc4291">IP Version 6 Addressing Architecture</a>", RFC 4291, February 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4443">[RFC4443]</b></td>
<td class="top">
<a>Conta, A.</a>, <a>Deering, S.</a> and <a>M. Gupta</a>, "<a href="http://tools.ietf.org/html/rfc4443">Internet Control Message Protocol (ICMPv6) for the Internet Protocol Version 6 (IPv6) Specification</a>", RFC 4443, March 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4787">[RFC4787]</b></td>
<td class="top">
<a>Audet, F.</a> and <a>C. Jennings</a>, "<a href="http://tools.ietf.org/html/rfc4787">Network Address Translation (NAT) Behavioral Requirements for Unicast UDP</a>", BCP 127, RFC 4787, January 2007.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">11.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.ietf-v6ops-ipv6-cpe-router">[I-D.ietf-v6ops-ipv6-cpe-router]</b></td>
<td class="top">
<a>Singh, H</a>, <a>Beebee, W</a>, <a>Donley, C</a>, <a>Stark, B</a> and <a>O Troan</a>, "<a href="http://tools.ietf.org/html/draft-ietf-v6ops-ipv6-cpe-router-09">Basic Requirements for IPv6 Customer Edge Routers</a>", Internet-Draft draft-ietf-v6ops-ipv6-cpe-router-09, December 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC1071">[RFC1071]</b></td>
<td class="top">
<a title="USC/Information Sciences Institute">Braden, R.</a>, <a title="Cray Research">Borman, D.</a>, <a title="Bolt Baranek and Newman (BBN) Laboratories">Partridge, C.</a> and <a title="Bolt Beranek and Newman, Inc. (BBN)">W. Plummer</a>, "<a href="http://tools.ietf.org/html/rfc1071">Computing the Internet checksum</a>", RFC 1071, September 1988.</td>
</tr>
<tr>
<td class="reference"><b id="RFC1624">[RFC1624]</b></td>
<td class="top">
<a href="mailto:anil@levers.enet.dec.com" title="Digital Equipment Corporation">Rijsinghani, A.</a>, "<a href="http://tools.ietf.org/html/rfc1624">Computation of the Internet Checksum via Incremental Update</a>", RFC 1624, May 1994.</td>
</tr>
<tr>
<td class="reference"><b id="RFC1918">[RFC1918]</b></td>
<td class="top">
<a href="mailto:yakov@cisco.com" title="Cisco systems">Rekhter, Y.</a>, <a href="mailto:rgm3@is.chrysler.com" title="Chrysler Corporation">Moskowitz, R.</a>, <a href="mailto:Daniel.Karrenberg@ripe.net" title="RIPE Network Coordination Centre">Karrenberg, D.</a>, <a href="mailto:GeertJan.deGroot@ripe.net" title="RIPE Network Coordination Centre">Groot, G.</a> and <a href="mailto:lear@sgi.com" title="Silicon Graphics, Inc.">E. Lear</a>, "<a href="http://tools.ietf.org/html/rfc1918">Address Allocation for Private Internets</a>", BCP 5, RFC 1918, February 1996.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2629">[RFC2629]</b></td>
<td class="top">
<a href="mailto:mrose@not.invisible.net" title="Invisible Worlds, Inc.">Rose, M.T.</a>, "<a href="http://tools.ietf.org/html/rfc2629">Writing I-Ds and RFCs using XML</a>", RFC 2629, June 1999.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2827">[RFC2827]</b></td>
<td class="top">
<a>Ferguson, P.</a> and <a>D. Senie</a>, "<a href="http://tools.ietf.org/html/rfc2827">Network Ingress Filtering: Defeating Denial of Service Attacks which employ IP Source Address Spoofing</a>", BCP 38, RFC 2827, May 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2993">[RFC2993]</b></td>
<td class="top">
<a>Hain, T.</a>, "<a href="http://tools.ietf.org/html/rfc2993">Architectural Implications of NAT</a>", RFC 2993, November 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3424">[RFC3424]</b></td>
<td class="top">
<a>Daigle, L.</a>, <a>IAB</a>, "<a href="http://tools.ietf.org/html/rfc3424">IAB Considerations for UNilateral Self-Address Fixing (UNSAF) Across Network Address Translation</a>", RFC 3424, November 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3484">[RFC3484]</b></td>
<td class="top">
<a>Draves, R.</a>, "<a href="http://tools.ietf.org/html/rfc3484">Default Address Selection for Internet Protocol version 6 (IPv6)</a>", RFC 3484, February 2003.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4864">[RFC4864]</b></td>
<td class="top">
<a>Van de Velde, G.</a>, <a>Hain, T.</a>, <a>Droms, R.</a>, <a>Carpenter, B.</a> and <a>E. Klein</a>, "<a href="http://tools.ietf.org/html/rfc4864">Local Network Protection for IPv6</a>", RFC 4864, May 2007.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5902">[RFC5902]</b></td>
<td class="top">
<a>Thaler, D.</a>, <a>Zhang, L.</a> and <a>G. Lebovitz</a>, "<a href="http://tools.ietf.org/html/rfc5902">IAB Thoughts on IPv6 Network Address Translation</a>", RFC 5902, July 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5925">[RFC5925]</b></td>
<td class="top">
<a>Touch, J.</a>, <a>Mankin, A.</a> and <a>R. Bonica</a>, "<a href="http://tools.ietf.org/html/rfc5925">The TCP Authentication Option</a>", RFC 5925, June 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5996">[RFC5996]</b></td>
<td class="top">
<a>Kaufman, C.</a>, <a>Hoffman, P.</a>, <a>Nir, Y.</a> and <a>P. Eronen</a>, "<a href="http://tools.ietf.org/html/rfc5996">Internet Key Exchange Protocol Version 2 (IKEv2)</a>", RFC 5996, September 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6092">[RFC6092]</b></td>
<td class="top">
<a>Woodyatt, J.</a>, "<a href="http://tools.ietf.org/html/rfc6092">Recommended Simple Security Capabilities in Customer Premises Equipment (CPE) for Providing Residential IPv6 Internet Service</a>", RFC 6092, January 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-behave-dns64">[I-D.ietf-behave-dns64]</b></td>
<td class="top">
<a>Bagnulo, M</a>, <a>Sullivan, A</a>, <a>Matthews, P</a> and <a>I Beijnum</a>, "<a href="http://tools.ietf.org/html/draft-ietf-behave-dns64-11">DNS64: DNS extensions for Network Address Translation from IPv6 Clients to IPv4 Servers</a>", Internet-Draft draft-ietf-behave-dns64-11, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-behave-v6v4-framework">[I-D.ietf-behave-v6v4-framework]</b></td>
<td class="top">
<a>Baker, F</a>, <a>Li, X</a>, <a>Bao, C</a> and <a>K Yin</a>, "<a href="http://tools.ietf.org/html/draft-ietf-behave-v6v4-framework-10">Framework for IPv4/IPv6 Translation</a>", Internet-Draft draft-ietf-behave-v6v4-framework-10, August 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-behave-v6v4-xlate">[I-D.ietf-behave-v6v4-xlate]</b></td>
<td class="top">
<a>Li, X</a>, <a>Bao, C</a> and <a>F Baker</a>, "<a href="http://tools.ietf.org/html/draft-ietf-behave-v6v4-xlate-23">IP/ICMP Translation Algorithm</a>", Internet-Draft draft-ietf-behave-v6v4-xlate-23, September 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-behave-v6v4-xlate-stateful">[I-D.ietf-behave-v6v4-xlate-stateful]</b></td>
<td class="top">
<a>Bagnulo, M</a>, <a>Matthews, P</a> and <a>I Beijnum</a>, "<a href="http://tools.ietf.org/html/draft-ietf-behave-v6v4-xlate-stateful-12">Stateful NAT64: Network Address and Protocol Translation from IPv6 Clients to IPv4 Servers</a>", Internet-Draft draft-ietf-behave-v6v4-xlate-stateful-12, July 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6052">[RFC6052]</b></td>
<td class="top">
<a>Bao, C.</a>, <a>Huitema, C.</a>, <a>Bagnulo, M.</a>, <a>Boucadair, M.</a> and <a>X. Li</a>, "<a href="http://tools.ietf.org/html/rfc6052">IPv6 Addressing of IPv4/IPv6 Translators</a>", RFC 6052, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="NIST">[NIST]</b></td>
<td class="top">
<a title="NIST">NIST, </a>, "<a>Draft NIST Framework and Roadmap for Smart Grid Interoperability, Release 1.0</a>", September 2009.</td>
</tr>
<tr>
<td class="reference"><b id="GSE">[GSE]</b></td>
<td class="top">
<a title="UUNET Technologies">O'Dell, M.</a>, "<a>GSE - An Alternate Addressing Architecture for IPv6</a>", February 1997.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> <a href="#appendix1" id="appendix1">Why GSE?</a>
</h1>
<p id="rfc.section.Appendix A.p.1">For the purpose of this discussion, let us over-simplify the Internet's structure by distinguishing between two broad classes of networks: transit and edge. A "transit network", in this context, is a network that provides connectivity services to other networks. Its AS number may show up in a non-final position in BGP AS paths, or in the case of mobile and residential broadband networks, it may offer network services to smaller networks that can't justify RIR membership. An "edge network", in contrast, is any network that is not a transit network; it is the ultimate customer, and while it provides internal connectivity for its own use, it is in other respects a consumer of transit services.  In terms of routing, a network in the transit domain generally needs some way to make choices about how it routes to other networks; an edge network is generally quite satisfied with a simple default route.</p>
<p id="rfc.section.Appendix A.p.2">The <a href="#GSE">[GSE]</a> proposal, and as a result this proposal (which is similar to GSE in most respects and inspired by it), responds directly to current concerns in the RIR communities. Edge networks are used to an environment in IPv4 in which their addressing is disjoint from that of their upstream transit networks; it is either provider independent, or a network prefix translator makes their external address distinct from their internal address, and they like the distinction. In IPv6, there is a mantra that edge network addresses should be derived from their upstream, and if they have multiple upstreams, edge networks are expected to design their networks to use all of those prefixes equivalently. They see this as unnecessary and unwanted operational complexity, and are as a result pushing very hard in the RIR communities for provider independent addressing.</p>
<p id="rfc.section.Appendix A.p.3">Widespread use of provider independent addressing has a natural and perhaps unavoidable side-effect that is likely to be very expensive in the long term. It means that the routing table will enumerate the networks at the edge of the transit domain, the edge networks, rather than enumerating the transit domain. Per the BGP Update Report of 17 December 2010, there are currently over 36,000 Autonomous Systems being advertised in BGP, of which over 15,000 advertise only one prefix. There are in the neighborhood of 5000 AS's that show up in a non-final position in AS paths, and perhaps another 5000 networks whose AS numbers are terminal in more than one AS path. In other words, we have prefixes for some 36,000 transit and edge networks in the route table now, many of which arguably need an Autonomous System number only for multihoming.  Current estimates suggest that we could easily see that be on the order of 10,000,000 within fifteen years. However, the vast majority of networks (2/3) having the tools necessary to multihome are not visibly doing so, and would be well served by any solution that gives them address independence without the overhead of RIR membership and BGP routing.</p>
<p id="rfc.section.Appendix A.p.4">Current growth estimates suggest that we could easily see that be on the order of 10,000,000 within fifteen years. Tens of thousands of entries in the route table is very survivable; while our protocols and computers will likely do quite well with tens of millions of routes, the heat produced and power consumed by those routers, and the inevitable impact on the cost of those routers, is not a good outcome. To avoid having a massive and unscalable route table, we need to find a way that is politically acceptable and returns us to enumerating the transit domain, not the edge.</p>
<p id="rfc.section.Appendix A.p.5">There have been a number of proposals. As described, shim6 moves the complexity to the edge, and the edge is rebelling. Geographic addressing in essence forces ISPs to "own" geographic territory from a routing perspective, as otherwise there is no clue in the address as to what network a datagram should be delivered to in order to reach it.  Metropolitan Addressing can imply regulatory authority, and even if it is implemented using internet exchange consortia, visits a great deal of complexity on the transit networks that directly serve the edge. The one that is likely to be most acceptable is any proposal that enables an edge network to be operationally independent of its upstreams, with no obligation to renumber when it adds, drops, or changes ISPs, and with no additional burden placed either on the ISP or the edge network as a result. From an application perspective, an additional operational requirement in the words of <a href="#NIST">Roadmap for the Smart Grid</a> <cite title="NONE">[NIST]</cite>, is that </p>

<ul class="empty"><li>"...the Network should enable an application in a particular domain to communicate with an application in any other domain in the information network, with proper management control over who and where applications can be interconnected."</li></ul>
<p id="rfc.section.Appendix A.p.6">In other words, the structure of the network should allow for and enable appropriate access control, but the structure of the network should not inherently limit access.</p>
<p id="rfc.section.Appendix A.p.7">The GSE model, by statelessly translating the prefix between an edge network and its upstream transit network, accomplishes that with a minimum of fuss and bother. Stated in the simplest terms, it enables the edge network to behave as if it has a provider independent prefix from a multihoming and renumbering perspective without the overhead of RIR membership or maintaining BGP connectivity, and it enables the transit networks to aggressively aggregate what are from their perspective provider-allocated customer prefixes, to maintain a rational-sized routing table.</p>
<h1 id="rfc.appendix.Appendix B">
<a href="#rfc.appendix.Appendix%20B">Appendix B.</a> <a href="#math" id="math">Verification code</a>
</h1>
<p id="rfc.section.Appendix B.p.1">This non-normative appendix is presented as a proof of concept. It is in no sense optimized; for example, one's complement arithmetic is implemented in portable subroutines, where operational implementations might use one's complement arithmetic instructions through a pragma; such implementations probably need to explicitly force 0xFFFF to 0x0000, as the instruction will not. The original purpose of the code was to verify whether or not it was necessary to suppress 0xFFFF by overwriting with zero, and whether predicted issues with subnet numbering were real.</p>
<p id="rfc.section.Appendix B.p.2">The point is to</p>

<ul>
<li>demonstrate that if one or the other representation of zero is not used in the word the checksum is updated in, the program maps inner and outer addresses in a manner that is, mathematically, 1:1 and onto (each inner address maps to a unique outer address, and that outer address maps back to exactly the same inner address), and</li>
<li>give guidance on the suppression of 0xFFFF checksums.</li>
</ul>
<p id="rfc.section.Appendix B.p.3">In short, in one's complement arithmetic, x-x=0, but will take the negative representation of zero. If 0xFFFF results are forced to the value 0x0000, as is recommended in <a href="#RFC1071">[RFC1071]</a>, the word the checksum is adjusted in cannot be initially 0xFFFF, as on the return it will be forced to 0. If 0xFFFF results are not forced to the value 0x0000 as is recommended in <a href="#RFC1071">[RFC1071]</a>, the word the checksum is adjusted in cannot be initially 0, as on the return it will be calculated as 0+(~0) = 0xFFFF. We chose to follow <a href="#RFC1071">[RFC1071]</a>'s recommendations, which implies a requirement to not use 0xFFFF as a subnet number in networks with a /48 external prefix.</p>
<div id="#rfc.figure.6"></div>
<pre>
/*
 * Copyright (c) 2010 IETF Trust and the persons identified as
 * authors of the code.  All rights reserved.  Redistribution
 * and use in source and binary forms, with or without
 * modification, are permitted provided that the following
 * conditions are met:
 *
 * o  Redistributions of source code must retain the above
 *    copyright notice, this list of conditions and the
 *    following disclaimer.
 *
 * o  Redistributions in binary form must reproduce the above
 *    copyright notice, this list of conditions and the
 *    following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * o  Neither the name of Internet Society, IETF or IETF Trust,
 *    nor the names of specific contributors, may be used to
 *    endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
 * CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,
 * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
#include "stdio.h"
#include "assert.h"
/*
 * program to verify the NPTv6 algorithm
 *
 * argument:
 *     perform negative zero suppression: boolean
 *
 * method:
 *    We specify an internal and an external prefix. The prefix
 *    length is presumed to be the common length of both, and for
 *    this is a /48. We perform the three algorithms specified.
 *    the "packet" address is in effect the source address
 *    internal-&gt;external and the destination address
 *    external-&gt;internal.
 */
unsigned short  inner_init[] = {
    0xFD01, 0x0203, 0x0405, 1, 2, 3, 4, 5};
unsigned short  outer_init[] = {
    0x2001, 0x0db8, 0x0001, 1, 2, 3, 4, 5};
unsigned short  inner[8];
unsigned short  packet[8];
unsigned char   checksum[65536] = {0};
unsigned short  outer[8];
unsigned short  adjustment;
unsigned short  suppress;
/*
 * One's complement sum.
 * return number1 + number2
 */
unsigned short
add1(number1, number2)
    unsigned short  number1;
    unsigned short  number2;
{
    unsigned int    result;

    result = number1;
    result += number2;
    if (suppress) {
        while (0xFFFF &lt;= result) {
            result = result + 1 - 0x10000;
        }
    } else {
        while (0xFFFF &lt; result) {
            result = result + 1 - 0x10000;
        }
    }
    return result;
}

/*
 * One's complement difference
 * return number1 - number2
 */
unsigned short
sub1(number1, number2)
    unsigned short  number1;
    unsigned short  number2;
{
    return add1(number1, ~number2);
}

/*
 * return one's complement sum of an array of numbers
 */
unsigned short
sum1(numbers, count)
    unsigned short *numbers;
    int             count;
{
    unsigned int    result;

    result = *numbers++;
    while (--count &gt; 0) {
        result += *numbers++;
    }

    if (suppress) {
        while (0xFFFF &lt;= result) {
            result = result + 1 - 0x10000;
        }
    } else {
        while (0xFFFF &lt; result) {
            result = result + 1 - 0x10000;
        }
    }
    return result;
}

/*
 * NPTv6 initialization: section 3.1 assuming section 3.4
 *
 * create the /48, a source address in internal format, and a
 * source address in external format. calculate the adjustment
 * if one /48 is overwritten with the other.
 */
void
nptv6_initialization(subnet)
    unsigned short  subnet;
{
    int             i;
    unsigned short  inner48;
    unsigned short  outer48;

    /* initialize the internal and external prefixes. */
    for (i = 0; i &lt; 8; i++) {
        inner[i] = inner_init[i];
        outer[i] = outer_init[i];
    }
    inner[3] = subnet;
    outer[3] = subnet;
    /* calculate the checksum adjustment */
    inner48 = sum1(inner, 3);
    outer48 = sum1(outer, 3);
    adjustment = sub1(inner48, outer48);
}

/*
 * NPTv6 packet from edge to transit: section 3.2 assuming
 * section 3.4
 *
 * overwrite the prefix in the source address with the outer
 * prefix, and adjust the checksum
 */
void
nptv6_inner_to_outer()
{
    int             i;

    /* let's get the source address into the packet */
    for (i = 0; i &lt; 8; i++) {
        packet[i] = inner[i];
    }

    /* overwrite the prefix with the outer prefix */
    for (i = 0; i &lt; 3; i++) {
        packet[i] = outer[i];
    }

    /* adjust the checksum */
    packet[3] = add1(packet[3], adjustment);
}

/*
 * NPTv6 packet from transit to edge:: section 3.3 assuming
 * section 3.4
 *
 * overwrite the prefix in the destination address with the
 * inner prefix, and adjust the checksum
 */
void
nptv6_outer_to_inner()
{
    int             i;

    /* overwrite the prefix with the outer prefix */
    for (i = 0; i &lt; 3; i++) {
        packet[i] = inner[i];
    }

    /* adjust the checksum */
    packet[3] = sub1(packet[3], adjustment);
}

/*
 * main program
 */
main(argc, argv)
    int             argc;
    char          **argv;
{
    unsigned        subnet;
    int             i;

    if (argc &lt; 2) {
           fprintf(stderr, "usage: nptv6 supression\n");	 		
           assert(0);	 		
       }	 		
       suppress = atoi(argv[1]);	 		
       assert(suppress &lt;= 1);	 		
 		
       for (subnet = 0; subnet &lt; 0x10000; subnet++) {	 		
           /* section 3.1: initialize the system */	 		
           nptv6_initialization(subnet);	 		
 		
           /* section 3.2: take a packet from inside to outside */	 		
           nptv6_inner_to_outer();	 		

           /* the resulting checksum value should be unique */	 		
           if (checksum[subnet]) {
                printf("inner-&gt;outer duplicated checksum: "
                       "inner: %x:%x:%x:%x:%x:%x:%x:%x(%x) "
                       "calculated: %x:%x:%x:%x:%x:%x:%x:%x(%x)\n",
                       inner[0], inner[1], inner[2], inner[3],
                       inner[4], inner[5], inner[6], inner[7],
                       sum1(inner, 8),
                       packet[0], packet[1], packet[2], packet[3],
                       packet[4], packet[5], packet[6], packet[7],
                       sum1(packet, 8));
        }

        checksum[subnet] = 1;

        /*
         * the resulting checksum should be the same as the inner
         * address's checksum
         */
        if (sum1(packet, 8) != sum1(inner, 8)) {
            printf("inner-&gt;outer incorrect: "
                   "inner: %x:%x:%x:%x:%x:%x:%x:%x(%x) "
                   "calculated: %x:%x:%x:%x:%x:%x:%x:%x(%x)\n",
                   inner[0], inner[1], inner[2], inner[3],
                   inner[4], inner[5], inner[6], inner[7],
                   sum1(inner, 8),
                   packet[0], packet[1], packet[2], packet[3],
                   packet[4], packet[5], packet[6], packet[7],
                   sum1(packet, 8));
        }

        /* section 3.3: take a packet from outside to inside */
        nptv6_outer_to_inner();

        /*
         * the returning packet should have the same checksum it
         * left with
         */
        if (sum1(packet, 8) != sum1(inner, 8)) {
            printf("outer-&gt;inner checksum incorrect: "
                   "calculated: %x:%x:%x:%x:%x:%x:%x:%x(%x) "
                   "inner: %x:%x:%x:%x:%x:%x:%x:%x(%x)\n",
                   packet[0], packet[1], packet[2], packet[3],
                   packet[4], packet[5], packet[6], packet[7],
                sum1(packet, 8), inner[0], inner[1], inner[2],
                   inner[3], inner[4], inner[5], inner[6],
                   inner[7], sum1(inner, 8));
        }

        /*
         * and every octet should calculate back to the same inner
         * value
         */
        for (i = 0; i &lt; 8; i++) {
            if (inner[i] != packet[i]) {
                printf("outer-&gt;inner different: "
                       "calculated: %x:%x:%x:%x:%x:%x:%x:%x "
                       "inner: %x:%x:%x:%x:%x:%x:%x:%x\n",
                   packet[0], packet[1], packet[2], packet[3],
                   packet[4], packet[5], packet[6], packet[7],
                       inner[0], inner[1], inner[2], inner[3],
                       inner[4], inner[5], inner[6], inner[7]);
                break;
            }
        }
    }
}
</pre>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Margaret Wasserman</span> 
	  <span class="n hidden">
		<span class="family-name">Wasserman</span>
	  </span>
	</span>
	<span class="org vcardline">Painless Security</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality">North Andover</span>,  
		<span class="region">MA</span> 
		<span class="code">01845</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">Phone: +1 781 405 7464</span>

<span class="vcardline">EMail: <a href="mailto:mrw@painless-security.com">mrw@painless-security.com</a></span>

<span class="vcardline">URI: <a href="http://www.painless-security.com">http://www.painless-security.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Fred Baker</span> 
	  <span class="n hidden">
		<span class="family-name">Baker</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality">Santa Barbara</span>,  
		<span class="region">California</span> 
		<span class="code">93117</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">Phone: +1-408-526-4257</span>

<span class="vcardline">EMail: <a href="mailto:fred@cisco.com">fred@cisco.com</a></span>

  </address>
</div>

</body>
</html>