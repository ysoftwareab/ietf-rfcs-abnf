<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Update to the IPv6 flow label specification</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Update to the IPv6 flow label specification">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">6MAN</td><td class="header">S. Amante</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Level 3</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">B. Carpenter</td></tr>
<tr><td class="header">Expires: March 20, 2011</td><td class="header">Univ. of Auckland</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">S. Jiang</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Huawei Technologies Co., Ltd</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">September 16, 2010</td></tr>
</table></td></tr></table>
<h1><br />Update to the IPv6 flow label specification<br />draft-carpenter-6man-flow-update-04</h1>

<h3>Abstract</h3>

<p>Various published proposals for use of the IPv6 flow label are incompatible with 
its existing specification in RFC 3697. Furthermore, very little practical use is
made of the flow label, partly due to some uncertainties about the 
correct interpretation of the specification.
This document proposes changes to the specification in order to clarify it, making
it clear what types of usage are possible, and to introduce some additional
flexibility.

</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on March 20, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#intro">1.</a>&nbsp;
Introduction<br />
<a href="#impact">2.</a>&nbsp;
Impact of current specification<br />
<a href="#anchor1">3.</a>&nbsp;
Normative Notation<br />
<a href="#spec">4.</a>&nbsp;
Proposed changes to specification<br />
<a href="#disc">5.</a>&nbsp;
Discussion<br />
<a href="#security">6.</a>&nbsp;
Security Considerations<br />
<a href="#iana">7.</a>&nbsp;
IANA Considerations<br />
<a href="#ack">8.</a>&nbsp;
Acknowledgements<br />
<a href="#changes">9.</a>&nbsp;
Change log<br />
<a href="#rfc.references1">10.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">10.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">10.2.</a>&nbsp;
Informative References<br />
<a href="#Appendix1">Appendix&nbsp;A.</a>&nbsp;
Alternative Approaches<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>The flow label field in the IPv6 header was reserved but left experimental by <a class='info' href='#RFC2460'>[RFC2460]<span> (</span><span class='info'>Deering, S. and R. Hinden, &ldquo;Internet Protocol, Version 6 (IPv6) Specification,&rdquo; December&nbsp;1998.</span><span>)</span></a>,
which mandates only that "Hosts or routers
   that do not support the functions of the Flow Label field are
   required to set the field to zero when originating a packet, pass the
   field on unchanged when forwarding a packet, and ignore the field
   when receiving a packet." 
</p>
<p>The flow label field
was normatively specified by <a class='info' href='#RFC3697'>[RFC3697]<span> (</span><span class='info'>Rajahalme, J., Conta, A., Carpenter, B., and S. Deering, &ldquo;IPv6 Flow Label Specification,&rdquo; March&nbsp;2004.</span><span>)</span></a>. In particular, we quote three rules
from that RFC:
</p>
<blockquote class="text"><dl>
<dt>a.</dt>
<dd>"The Flow Label value set by the source MUST be delivered unchanged to
   the destination node(s)."
</dd>
<dt>b.</dt>
<dd>"IPv6 nodes MUST NOT assume any mathematical or other properties
of the Flow Label values assigned by source nodes." 
</dd>
<dt>c.</dt>
<dd>"Router performance SHOULD NOT be dependent on the distribution of the Flow Label
values. Especially, the Flow Label bits alone make poor material for a hash key." 
</dd>
</dl></blockquote>
<p>Additionally, RFC 3697 leaves it undefined what method a host should adopt by default
to choose the value of the flow label, if no specific method is in use. It was expected that
various signalling methods might be defined for agreeing on values of the flow label, but
no such methods have been standardised. 
</p>
<p>The flow label is hardly used in practice in existing IPv6 implementations. To some extent
this is due to the main focus being on basic deployment of IPv6, but the absence of a default
method of choosing the flow label value means that most host implementations simply set it to zero. 
There is also anecdotal evidence that the rules quoted above have led to uncertainty about exactly 
what is possible. Furthermore, various use cases have been
proposed that infringe one or another of the rules. None of these proposals
has been accepted as a standard and in practice there is no significant deployment
of any mechanism to set the flow label. 
</p>
<p>
The intention of this document is to explain this
in more detail and to propose changes to RFC 3697 intended to remove the uncertainties and encourage
active usage of the flow label. 
</p>
<a name="impact"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Impact of current specification</h3>

<p>Rule (a) makes it impossible for the routing system to use the flow label as any form
of dynamic routing tag. This was a conscious choice in the early design of IPv6 and there
appears to be no practical possibility of revisiting this choice at this stage in the
deployment of IPv6, which uses conventional routing mechanisms like those used for IPv4. 
However, this rule also makes
it impossible to make any use at all of the flow label unless hosts choose to set it. It also
forbids clearing the flow label for security reasons. 
</p>
<p>This last point highlights the security properties, or rather the lack of them,
of the flow label. The flow label field is always unprotected as it travels
through the network, because there is no IPv6 header
checksum, and the flow label is not included in transport pseudo-header checksums, nor in
IPsec checksums. As a result, intentional and malicious changes
to its value cannot be detected. Also, it could be used as a
covert data channel, since apparently pseudo-random flow label values could in fact
consist of encrypted data.  If the flow label were to carry quality of service
semantics, then like the diffserv code point <a class='info' href='#RFC2474'>[RFC2474]<span> (</span><span class='info'>Nichols, K., Blake, S., Baker, F., and D. Black, &ldquo;Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers,&rdquo; December&nbsp;1998.</span><span>)</span></a>, it would not be
intrinsically trustworthy across domain boundaries. As a result, some security
specialists believe that flow labels should be cleared for safety. These points must
be considered when discussing the immutability of the flow label across domain
boundaries. 
</p>
<p>Rule (b) appears to forbid any usage in which the bits of the flow label are encoded
with a specific semantic meaning. If the word "alone" is overlooked, rule (c) has sometimes
been interpreted to forbid the use of the flow label as part of a hash used by load balancing mechanisms. 
</p>
<p>Both before and after these rules were laid down, a considerable number
of proposals for use of the flow label were published that seem incompatible with
them. Numerous examples and an analysis are presented in <a class='info' href='#I-D.hu-flow-label-cases'>[I&#8209;D.hu&#8209;flow&#8209;label&#8209;cases]<span> (</span><span class='info'>Hu, Q. and B. Carpenter, &ldquo;Survey of proposed use cases for the IPv6 flow label,&rdquo; August&nbsp;2010.</span><span>)</span></a>.
Those examples propose use cases in which some or all of the following
apply:
</p>
<ul class="text">
<li>The flow label may be changed by intermediate systems. 
</li>
<li>It doesn't matter if the flow label is changed, because the receiver doesn't use it. 
</li>
<li>Some or all bits of the flow label are encoded: they have specific meanings
 understood by routers and switches along the path. 
</li>
<li>The encoding is related to the required quality of service, as well as identifying a flow. 
</li>
<li>The flow label is used to control forwarding or switching in some way. 
</li>
</ul>
<p>These proposals all require either some form of encoding of semantics
in the bits of the flow label, or the ability for routers to modify
the flow label, or both. Thus they appear to infringe the rules from RFC 3697 
quoted above. 
</p>
<p>We can conclude that a considerable number of researchers and designers have been
stymied by RFC 3697. On the other hand, some other proposals discussed in
<a class='info' href='#I-D.hu-flow-label-cases'>[I&#8209;D.hu&#8209;flow&#8209;label&#8209;cases]<span> (</span><span class='info'>Hu, Q. and B. Carpenter, &ldquo;Survey of proposed use cases for the IPv6 flow label,&rdquo; August&nbsp;2010.</span><span>)</span></a> appear to be compatible with RFC 3697.
Several are based on the originator of a packet choosing a pseudo-random flow label for 
each flow, which is one option suggested in RFC 3697. Thus, we can also conclude that there is a useful
role for this approach.  
</p>
<p>If our goal is for the flow label to be used in practice, the conflict between
the various approaches creates a dilemma. There appear to be two major options: 
</p>
<ol class="text">
<li>Discourage locally defined use of the flow label. 
Strengthen RFC 3697 to say that hosts SHOULD set
a pseudo-random label value, which would clarify and limit its possible uses.
In particular, its use for load balancing would be encouraged. 
</li>
<li>Relax the rules to encourage locally defined use of the flow label. This approach would make the flow
label completely mutable and would exclude use cases depending on strict end-to-end immutability. It
would encourage applications of a pseudo-random flow label, such as load balancing,
on a local basis, but it would exclude end-to-end applications such as 
<a class='info' href='#I-D.blake-ipv6-flow-label-nonce'>[I&#8209;D.blake&#8209;ipv6&#8209;flow&#8209;label&#8209;nonce]<span> (</span><span class='info'>Blake, S., &ldquo;Use of the IPv6 Flow Label as a Transport-Layer Nonce to Defend Against Off-Path Spoofing Attacks,&rdquo; October&nbsp;2009.</span><span>)</span></a>. 
</li>
</ol>
<p>During 2010 there has been considerable debate about these options and variants
of them, with a variety of proposals in previous versions of this document and in
mailing list discussions. After these discussions, there appears to be
a view that simplicity should prevail, and that complicated proposals such as
defining quality of service semantics in the flow label, or sub-dividing the flow label
field into smaller sub-fields, will not prove efficient
or deployable, especially in high speed routers. There is also a clearly expressed view 
that using the flow label for various forms of stateless load balancing is the best simple 
application for it. At the same time, it is necessary to recognize that the strict
immutability rule has drawbacks as noted above. 
</p>
<p>Even under the rules of RFC 3697, the flow label is intrinsically untrustworthy,
because modifcations en route cannot be detected. For this reason, even with
the current strict immutability rule, downstream nodes cannot rely on the value being unchanged.
In this sense, any use of the flow label must be viewed as an optimisation on a best
effort basis; a packet with a changed (or zero) flow label value should never cause
a hard failure. 
</p>
<p>The remainder of this document is in the form of a set of proposed modifications to the standard, 
consistent with the points above and written in normative form. It is suggested that
if the proposal is generally accepted, a revised version of RFC 3697 should be produced
including these changes. 
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Normative Notation</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="spec"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Proposed changes to specification</h3>

<p>Although RFC 3697 requires the flow label to be delivered
unchanged, as noted above, it is not included in any transport layer pseudo-header checksums
nor in IPsec authentication <a class='info' href='#RFC4302'>[RFC4302]<span> (</span><span class='info'>Kent, S., &ldquo;IP Authentication Header,&rdquo; December&nbsp;2005.</span><span>)</span></a>.  
Both RFC 2460 and RFC 3697 define the default flow label to be zero. 
At the time of writing, this is the observed value in an
overwhelming proportion of IPv6 packets; neither operating systems nor
applications currently set it, and routers do not rely on it. Thus there is no reason
to expect operational difficulties if a careful change is made to the rules of RFC 3697. 
</p>
<p>In particular, the facts that the label is not checksummed and rarely used mean
that the current strict immutability of the label can be moderated without operational
consequences. 
</p>
<p>The purposes of the proposed changes are to remove the uncertainties left
by RFC 3697, in order to encourage setting of the flow label by default, and
to enable its generic use. The proposed generic use is to
encourage pseudo-random flow labels that can be used to assist load balancing.
There should be no impact on existing IETF specifications other than RFC 3697 and no impact on currently
operational software and hardware. 
</p>
<p>A secondary purpose is to modify the immutability of the flow label in a limited
way, to allow hosts that do not set the flow label to benefit from it
nevertheless. 
</p>
<p>The fact that the flow label may in practice be changed en route is also reflected
in the reformulation of the rules. 
</p>
<p>A description of the changes follows. They are written in normative language
to avoid ambiguity. They are mainly not written as specific
text changes to RFC 3697, and significant rewriting of the latter is needed to
incorporate these changes. 
</p>
<p>The definition of a flow is subtly changed from RFC 3697 as follows:
</p><br />
<br />

<blockquote class="text">
<p>A flow is a sequence of packets sent from a particular source to a
   particular unicast, anycast, or multicast destination that a node
   desires to label as a flow.  A flow could consist of all packets in a
   specific transport connection or a media stream.  However, a flow is
   not necessarily 1:1 mapped to a transport connection.
</p>
</blockquote>
<p>The change is that the words 'the source' have been replaced by 'a node'.
Nodes that do not support the flow label remain subject to RFC 2460.
The intention is to enable the following new specifications:
</p><br />
<br />

<ol class="text">
<li> 
It is RECOMMENDED that source hosts support the flow label by setting the flow label field 
for all packets of a flow to the same pseudo-random value. 

</li>
<ul class="text">
<li>This rule updates the less precise recommendation made in Section 3
of RFC 3697. Both stateful and stateless methods of assigning a pseudo-random value could be used,
but it is outside the scope of this specification to mandate an algorithm.  
</li>
<li>An OPTIONAL algorithm for generating such a pseudo-random value is
proposed in <a class='info' href='#I-D.gont-6man-flowlabel-security'>[I&#8209;D.gont&#8209;6man&#8209;flowlabel&#8209;security]<span> (</span><span class='info'>Gont, F., &ldquo;Security Assessment of the IPv6 Flow Label,&rdquo; August&nbsp;2010.</span><span>)</span></a>. 
</li>
<li>Section 3 of RFC 3697 also allows nodes to participate in an unspecified
method of flow state establishment. The changes do not remove that option. 
</li>
</ul><br />
<br />

<li>A node that forwards a flow whose flow label value in arriving packets is zero
MAY set the flow label value. In that case, it is RECOMMENDED 
that the forwarding node sets the flow label field for a flow to a pseudo-random value. 
</li>
<ul class="text">
<li>The same considerations apply as to the first recommendation. 
</li>
<li>This option, if implemented, would presumably be used by ingress routers. It would place a
 considerable per-packet processing load on them, even if they adopted a stateless method of 
 flow identification and label assignment. This is why the principal recommendation is that 
 the source host should set the label.
 
</li>
</ul><br />
<br />

<li>In general, a forwarding node MUST NOT change the flow label value in an arriving packet if
it is non-zero. However, there are two qualifications to this rule: 

 
 
<ol class="text">
<li>A forwarding node acting as a domain border device MAY be configured to set 
 the flow label value in incoming packets to the default value of zero.
 [[Note in draft - this is contentious, but it's going to happen anyway.]]
</li>
<li>A network domain MUST NOT forward packets outside the domain whose flow label values
 are other than zero or pseudo-random.  
</li>
</ol>
 

<br />
<br />


Note that the new rules above, taken together, allow a given network domain to
include routers that set flow labels on behalf of hosts that do not do so,
and to be protected at its border (if desired) by clearing flow labels
deemed to be untrustworthy. They also require that flow labels exported
to the Internet must always be either zero or pseudo-random. These changes replace rule (a) 
quoted in <a class='info' href='#intro'>Section&nbsp;1<span> (</span><span class='info'>Introduction</span><span>)</span></a>. 
They therefore exclude Internet-wide mechanisms that depend rigidly on immutable
flow labels. Given the
intrinsic forgeability of the flow label, this seems unavoidable. 
</li><br />
<br />

<li>IPv6 nodes MUST NOT assume that the Flow Label value in a incoming packet
is identical to the value set by the source node. 
</li>
<ul class="text">
<li>This replaces rule (b) quoted in <a class='info' href='#intro'>Section&nbsp;1<span> (</span><span class='info'>Introduction</span><span>)</span></a>. 
</li>
<li>Even though the flow label is in general immutable, 
this is not guaranteed in real life, hence this rule. See further discussion below. 
</li>
</ul><br />
<br />

<li>Forwarding nodes such as routers and load balancers MUST NOT depend only on Flow Label
values being randomly distributed. In any usage such as a hash key for load balancing,
the Flow Label bits MUST be combined with bits from other sources within the packet,
so as to produce a suitable distribution of hash values. 
</li>
<ul class="text">
<li>This replaces rule (c) quoted in <a class='info' href='#intro'>Section&nbsp;1<span> (</span><span class='info'>Introduction</span><span>)</span></a>. Although a pseudo-random flow
label is recommended, and will always be helpful for load balancing, it is unsafe to assume
its presence in the general case, and the use case needs to work even if the flow label
value is zero. 
</li>
</ul>
</ol>
<a name="disc"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Discussion</h3>

<p>The following are the consequences of the above changes, taken together with the unaffected
parts of RFC 3697:
</p>
<ul class="text">
<li>Sending hosts that are not updated will in practice continue to send all-zero labels. If there
is no label-setting router along the path taken by a packet, the label
will be delivered as zero. 
</li>
<li>Sending hosts conforming to this specification will by default choose pseudo-random 
labels between 1 and 0xFFFFF. 
</li>
<li>Sending hosts may continue to send all-zero labels, in which case an ingress router may set pseudo-random 
labels between 1 and 0xFFFFF. 
</li>
<li>Border security devices may clear untrustworthy flow labels. 
</li>
<li>The flow label is no longer asserted to be strictly immutable. In some circumstances
this will break end-to-end usage such as proposed
in <a class='info' href='#I-D.blake-ipv6-flow-label-nonce'>[I&#8209;D.blake&#8209;ipv6&#8209;flow&#8209;label&#8209;nonce]<span> (</span><span class='info'>Blake, S., &ldquo;Use of the IPv6 Flow Label as a Transport-Layer Nonce to Defend Against Off-Path Spoofing Attacks,&rdquo; October&nbsp;2009.</span><span>)</span></a>. 
</li>
<li>The expected default usage of the flow label is some form of
load balancing, such as the ECMP/LAG usage defined in <a class='info' href='#I-D.carpenter-flow-ecmp'>[I&#8209;D.carpenter&#8209;flow&#8209;ecmp]<span> (</span><span class='info'>Carpenter, B. and S. Amante, &ldquo;Using the IPv6 flow label for equal cost multipath routing and link aggregation in tunnels,&rdquo; April&nbsp;2010.</span><span>)</span></a>. 
</li>
<li>If the rules in <a class='info' href='#spec'>Section&nbsp;4<span> (</span><span class='info'>Proposed changes to specification</span><span>)</span></a> are followed, especially rule 3.2,
all IPv6 traffic flows on the Internet will have zero or pseudo-random
flow label values. 
</li>
</ul>
<p>From an operational viewpoint, existing IPv6 hosts that set a default (zero) flow label value
and ignore the flow label on receipt will be unaffected 
by implementations of this specification. In general, it is assumed that hosts will ignore the
value of the flow label on receipt; it cannot be relied on as an end-to-end 
signal of any kind. 
</p>
<p>Similarly, routers that ignore
the flow label will be unaffected by implementations of this specification. 
</p>
<p>Hosts that set a default (zero) flow label and are in a domain where routers
adopt the recommended pseudo-random mechanism in <a class='info' href='#spec'>Section&nbsp;4<span> (</span><span class='info'>Proposed changes to specification</span><span>)</span></a>
will benefit from whatever flow label handling is used in the local domain. 

</p>
<p>Hosts and routers that adopt the recommended pseudo-random mechanism
will enhance the performance of any load balancing devices that include the flow label
in the hash used to select a particular path or server, even when
packets leave the local domain. 
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>The flow label is not protected in any way and can be forged by an on-path
attacker.  On the other hand, a pseudo-random flow label cannot be readily
guessed by an off-path attacker. See RFC 3697 
and <a class='info' href='#I-D.gont-6man-flowlabel-security'>[I&#8209;D.gont&#8209;6man&#8209;flowlabel&#8209;security]<span> (</span><span class='info'>Gont, F., &ldquo;Security Assessment of the IPv6 Flow Label,&rdquo; August&nbsp;2010.</span><span>)</span></a> for further discussion. 
</p>
<p>This proposal recognises that security devices might clear flow label values, 
if local policy so requires. 
</p>
<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA Considerations</h3>

<p>This document requests no action by IANA. 
</p>
<a name="ack"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Acknowledgements</h3>

<p>The authors are grateful to Qinwen Hu for general
discussion about the flow label and for his work in searching the literature.
Valuable comments and contributions were made by
Fred Baker,
Steve Blake,
Remi Despres,
Fernando Gont,
Brian Haberman,
Joel Halpern,
Chris Morrow,
Thomas Narten,
Mark Smith,
Pascal Thubert,
Iljitsch van Beijnum,
and other participants in the 6man working group.
</p>
<p>This document was produced using the xml2rfc tool
<a class='info' href='#RFC2629'>[RFC2629]<span> (</span><span class='info'>Rose, M., &ldquo;Writing I-Ds and RFCs using XML,&rdquo; June&nbsp;1999.</span><span>)</span></a>.
</p>
<a name="changes"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Change log</h3>

<p>draft-carpenter-6man-flow-update-04: even more simplified according to WG discussion, 2010-09-16
</p>
<p>draft-carpenter-6man-flow-update-03: futher simplified according to WG discussion, 2010-05-07
</p>
<p>draft-carpenter-6man-flow-update-02: revised and simplified according to WG discussion, 2010-04-13
</p>
<p>draft-carpenter-6man-flow-update-01: revised according to mail list discussion, 2010-03-05
</p>
<p>draft-carpenter-6man-flow-update-00: original version, 2010-02-18
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2460">[RFC2460]</a></td>
<td class="author-text"><a href="mailto:deering@cisco.com">Deering, S.</a> and <a href="mailto:hinden@iprg.nokia.com">R. Hinden</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2460">Internet Protocol, Version 6 (IPv6) Specification</a>,&rdquo; RFC&nbsp;2460, December&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2460.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2460.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2460.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3697">[RFC3697]</a></td>
<td class="author-text">Rajahalme, J., Conta, A., Carpenter, B., and S. Deering, &ldquo;<a href="http://tools.ietf.org/html/rfc3697">IPv6 Flow Label Specification</a>,&rdquo; RFC&nbsp;3697, March&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3697.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.blake-ipv6-flow-label-nonce">[I-D.blake-ipv6-flow-label-nonce]</a></td>
<td class="author-text">Blake, S., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-blake-ipv6-flow-label-nonce-02.txt">Use of the IPv6 Flow Label as a Transport-Layer Nonce to Defend Against Off-Path Spoofing Attacks</a>,&rdquo; draft-blake-ipv6-flow-label-nonce-02 (work in progress), October&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-blake-ipv6-flow-label-nonce-02.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.carpenter-flow-ecmp">[I-D.carpenter-flow-ecmp]</a></td>
<td class="author-text">Carpenter, B. and S. Amante, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-carpenter-flow-ecmp-02.txt">Using the IPv6 flow label for equal cost multipath routing and link aggregation in tunnels</a>,&rdquo; draft-carpenter-flow-ecmp-02 (work in progress), April&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-carpenter-flow-ecmp-02.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.gont-6man-flowlabel-security">[I-D.gont-6man-flowlabel-security]</a></td>
<td class="author-text">Gont, F., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-gont-6man-flowlabel-security-00.txt">Security Assessment of the IPv6 Flow Label</a>,&rdquo; draft-gont-6man-flowlabel-security-00 (work in progress), August&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-gont-6man-flowlabel-security-00.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.hu-flow-label-cases">[I-D.hu-flow-label-cases]</a></td>
<td class="author-text">Hu, Q. and B. Carpenter, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-hu-flow-label-cases-01.txt">Survey of proposed use cases for the IPv6 flow label</a>,&rdquo; draft-hu-flow-label-cases-01 (work in progress), August&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-hu-flow-label-cases-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.martinbeckman-ietf-ipv6-fls-ipv6flowswitching">[I-D.martinbeckman-ietf-ipv6-fls-ipv6flowswitching]</a></td>
<td class="author-text">Beckman, M., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-martinbeckman-ietf-ipv6-fls-ipv6flowswitching-03.txt">IPv6 Dynamic Flow Label Switching (FLS)</a>,&rdquo; draft-martinbeckman-ietf-ipv6-fls-ipv6flowswitching-03 (work in progress), March&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-martinbeckman-ietf-ipv6-fls-ipv6flowswitching-03.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2474">[RFC2474]</a></td>
<td class="author-text"><a href="mailto:kmn@cisco.com">Nichols, K.</a>, <a href="mailto:slblake@torrentnet.com">Blake, S.</a>, <a href="mailto:fred@cisco.com">Baker, F.</a>, and <a href="mailto:black_david@emc.com">D. Black</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2474">Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers</a>,&rdquo; RFC&nbsp;2474, December&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2474.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2474.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2474.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2629">[RFC2629]</a></td>
<td class="author-text"><a href="mailto:mrose@not.invisible.net">Rose, M.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2629">Writing I-Ds and RFCs using XML</a>,&rdquo; RFC&nbsp;2629, June&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2629.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2629.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2629.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4302">[RFC4302]</a></td>
<td class="author-text">Kent, S., &ldquo;<a href="http://tools.ietf.org/html/rfc4302">IP Authentication Header</a>,&rdquo; RFC&nbsp;4302, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4302.txt">TXT</a>).</td></tr>
</table>

<a name="Appendix1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Alternative Approaches</h3>

<p>A model was discussed in an earlier version of this document which defined a notion
of 'flow label domain' analogous to a differentiated
services domain <a class='info' href='#RFC2474'>[RFC2474]<span> (</span><span class='info'>Nichols, K., Blake, S., Baker, F., and D. Black, &ldquo;Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers,&rdquo; December&nbsp;1998.</span><span>)</span></a>. This model would have encouraged
local usage of the flow label as an alternative to any form of generic use,
but it required complex rules for the behaviour of domain boundary routers, and proved
controversial in discussion. 
</p>
<p>Two even more complex alternative approaches were also considered and rejected. 
</p>
<p>The first was to distinguish locally significant flow labels from those
conforming to RFC 3697 by setting or clearing the most significant bit (MSB)
of the flow label. This led to quite complicated rules, seems impossible
to make fully self-consistent, and was not considered practical. 
</p>
<p>The second was to use  a specific differentiated
services code point (DSCP)<a class='info' href='#RFC2474'>[RFC2474]<span> (</span><span class='info'>Nichols, K., Blake, S., Baker, F., and D. Black, &ldquo;Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers,&rdquo; December&nbsp;1998.</span><span>)</span></a> in the Traffic Class octet 
instead of the MSB of the flow label itself, to flag a locally defined behaviour.
A more elaborate version of this was proposed
in <a class='info' href='#I-D.martinbeckman-ietf-ipv6-fls-ipv6flowswitching'>[I&#8209;D.martinbeckman&#8209;ietf&#8209;ipv6&#8209;fls&#8209;ipv6flowswitching]<span> (</span><span class='info'>Beckman, M., &ldquo;IPv6 Dynamic Flow Label Switching (FLS),&rdquo; March&nbsp;2007.</span><span>)</span></a>.
There are two issues with this approach. One is that DSCP values
are themselves only locally significant, inconsistent with the end-to-end nature
of the original flow label definition. Secondly, it seems unwise to meld the
semantics of differentiated services, which are currently deployed,
with the unknown future semantics of flow label usage. However, this approach,
while not recommended, does not appear to violate any basic principles if applied
strictly within a single differentiated services domain. 
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shane Amante</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Level 3 Communications, LLC</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1025 Eldorado Blvd</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Broomfield, CO  80021</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:shane@level3.net">shane@level3.net</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Brian Carpenter</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Department of Computer Science</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">University of Auckland</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">PB 92019</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Auckland,   1142</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">New Zealand</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:brian.e.carpenter@gmail.com">brian.e.carpenter@gmail.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Sheng Jiang</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Huawei Technologies Co., Ltd</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">KuiKe Building, No.9 Xinxi Rd.,</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shang-Di Information Industry Base, Hai-Dian District, Beijing</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.R. China</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:shengjiang@huawei.com">shengjiang@huawei.com</a></td></tr>
</table>
</body></html>
