<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>An FTP ALG for IPv6-to-IPv4 translation</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Notational Conventions">
<link href="#rfc.section.3" rel="Chapter" title="3 Terminology">
<link href="#rfc.section.4" rel="Chapter" title="4 ALG overview">
<link href="#rfc.section.5" rel="Chapter" title="5 Control channel translation">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Language negotiation">
<link href="#rfc.section.6" rel="Chapter" title="6 EPSV to PASV translation">
<link href="#rfc.section.7" rel="Chapter" title="7 EPRT to PORT translation">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Stateless EPRT translation">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Stateful EPRT translation">
<link href="#rfc.section.8" rel="Chapter" title="8 Default port 20 translation">
<link href="#rfc.section.9" rel="Chapter" title="9 Both PORT and PASV">
<link href="#rfc.section.10" rel="Chapter" title="10 Default behavior">
<link href="#rfc.section.11" rel="Chapter" title="11 The ALGS command">
<link href="#rfc.section.12" rel="Chapter" title="12 Timeouts and translating to NOOP">
<link href="#rfc.section.13" rel="Chapter" title="13 IANA considerations">
<link href="#rfc.section.14" rel="Chapter" title="14 Security considerations">
<link href="#rfc.section.15" rel="Chapter" title="15 Contributors">
<link href="#rfc.section.16" rel="Chapter" title="16 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="17 References">
<link href="#rfc.references.1" rel="Chapter" title="17.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="17.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="The File Transfer Protocol (FTP) has a very long history, and despite the fact that today, other options exist to perform file transfers, FTP is still in common use. As such, it is important that in the situation where some client computers only have IPv6 connectivity while many servers are still IPv4-only and IPv6-to-IPv4 translators are used to bridge that gap, FTP is made to work through these translators as best it can.  " />
  <meta name="description" content="The File Transfer Protocol (FTP) has a very long history, and despite the fact that today, other options exist to perform file transfers, FTP is still in common use. As such, it is important that in the situation where some client computers only have IPv6 connectivity while many servers are still IPv4-only and IPv6-to-IPv4 translators are used to bridge that gap, FTP is made to work through these translators as best it can.  " />
  <meta name="keywords" content="Internet-Draft, FTP, SIIT, NAT64" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Behavior Engineering for Hindrance Avoidance</td>
<td class="right">I. van Beijnum</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Institute IMDEA Networks</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">May 02, 2011</td>
</tr>
<tr>
<td class="left">Expires: November 03, 2011</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">An FTP ALG for IPv6-to-IPv4 translation<br />
  <span class="filename">draft-ietf-behave-ftp64-09</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>The File Transfer Protocol (FTP) has a very long history, and despite the fact that today, other options exist to perform file transfers, FTP is still in common use. As such, it is important that in the situation where some client computers only have IPv6 connectivity while many servers are still IPv4-only and IPv6-to-IPv4 translators are used to bridge that gap, FTP is made to work through these translators as best it can.  </p>
<p>FTP has an active and a passive mode, both as original commands that are IPv4-specific, and as extended, IP version agnostic commands. The only FTP mode that works without changes through an IPv6-to-IPv4 translator is extended passive. However, many existing FTP servers do not support this mode, and some clients do not ask for it. This document specifies a middlebox that may solve this mismatch.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on November 03, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Notational Conventions</a>
</li>
<li>3.   <a href="#rfc.section.3">Terminology</a>
</li>
<li>4.   <a href="#rfc.section.4">ALG overview</a>
</li>
<li>5.   <a href="#rfc.section.5">Control channel translation</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Language negotiation</a>
</li>
<li>6.   <a href="#rfc.section.6">EPSV to PASV translation</a>
</li>
<li>7.   <a href="#rfc.section.7">EPRT to PORT translation</a>
</li>
<li>7.1.   <a href="#rfc.section.7.1">Stateless EPRT translation</a>
</li>
<li>7.2.   <a href="#rfc.section.7.2">Stateful EPRT translation</a>
</li>
<li>8.   <a href="#rfc.section.8">Default port 20 translation</a>
</li>
<li>9.   <a href="#rfc.section.9">Both PORT and PASV</a>
</li>
<li>10.   <a href="#rfc.section.10">Default behavior</a>
</li>
<li>11.   <a href="#rfc.section.11">The ALGS command</a>
</li>
<li>12.   <a href="#rfc.section.12">Timeouts and translating to NOOP</a>
</li>
<li>13.   <a href="#rfc.section.13">IANA considerations</a>
</li>
<li>14.   <a href="#rfc.section.14">Security considerations</a>
</li>
<li>15.   <a href="#rfc.section.15">Contributors</a>
</li>
<li>16.   <a href="#rfc.section.16">Acknowledgements</a>
</li>
<li>17.   <a href="#rfc.references">References</a>
</li>
<li>17.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>17.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#intro" id="intro">Introduction</a>
</h1>
<p><a href="#RFC0959">[RFC0959]</a> specifies two modes of operation for FTP: active mode, in which the server connects back to the client and passive mode, where the server opens a port for the client to connect to. Without additional measures, active mode with a client-supplied port does not work through NATs or firewalls. With active mode, the PORT command has an IPv4 address as its argument, and in passive mode, the server responds to the PASV command with an IPv4 address. This makes both the passive and active modes as originally specified in <a href="#RFC0959">[RFC0959]</a> incompatible with IPv6. These issues were solved in <a href="#RFC2428">[RFC2428]</a>, which introduces the EPSV (extended passive) command, where the server only responds with a port number, and the EPRT (extended port) command, which allows the client to supply either an IPv4 or an IPv6 address (and a port) to the server.  </p>
<p id="rfc.section.1.p.2">A survey done in April of 2009 of 25 randomly picked and/or well-known FTP sites reachable over IPv4 showed that only 12 of them supported EPSV over IPv4. Additionally, only 2 of those 12 indicated that they supported EPSV in response to the FEAT command introduced in <a href="#RFC2389">[RFC2389]</a> that asks the server to list its supported features. One supported EPSV but not FEAT. In 5 cases, issuing the EPSV command to the server led to a significant delay, in 3 cases followed by a control channel reset. All 25 servers were able to successfully complete a transfer in traditional PASV passive mode as required by <a href="#RFC1123">[RFC1123]</a>. More testing showed that the use of an address family argument with the EPSV command is widely mis- or unimplemented in servers. The additional tests with more servers showed that approximately 65% of FTP servers support EPSV successfully and around 96% support PASV successfully. Clients were not extensively tested, but previous experience from the author suggests that most clients support PASV, with the notable exception of the command line client included with Windows, which only supports active mode. This FTP client uses the original PORT command when running over IPv4 and EPRT when running over IPv6.  </p>
<p id="rfc.section.1.p.3">Although these issues can and should be addressed by modifying clients and servers to support EPSV successfully (see <a href="#I-D.liu-ftp64-extension">[I-D.liu-ftp64-extension]</a>), such modifications may not appear widely in a timely fashion. Also, network operators who may want to deploy IPv6-to-IPv4 translation generally don't have control over client or server implementations. As such, this document standardizes an FTP Application Layer Gateway (ALG) that will allow unmodified IPv6 FTP clients to interact with unmodified IPv4 FTP servers successfully when using FTP for simple file transfers between a single client and a single server.  </p>
<p id="rfc.section.1.p.4">Clients that want to engage in more complex behavior, such as server-to-server transfers, may make an FTP application layer gateway (ALG) go into transparent mode by issuing AUTH or ALGS commands as explained in <a href="#controlchanneltranslation">Section 5</a>.  </p>
<p id="rfc.section.1.p.5">The recommendations and specifications in this document apply to all forms of IPv6-to-IPv4 translation, including stateless translation such as <a href="#RFC6145">[RFC6145]</a> as well as stateful translation such as <a href="#RFC6146">[RFC6146]</a>.  </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Notational Conventions</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Terminology</h1>
<p id="rfc.section.3.p.1">Within the context of this document, the words "client" and "server" refer to FTP client and server implementations, respectively. An FTP server is understood to be an implementation of the FTP protocol running on a server system with a stable address, waiting for clients to connect and issue commands that eventually start data transfers. Clients interact with servers using the FTP protocol, and store (upload) files to, and retrieve (download) files from one or more servers. This either happens interactively under control of a user, or is done as an unattended background process. Most operating systems provide a web browser that implements a basic FTP client, as well as a command line client. Third-party FTP clients are also widely available.  </p>
<p id="rfc.section.3.p.2">Other terminology is derived from the documents listed in the references section. Note that this document cannot be fully understood on its own; it depends on background and terminology outlined in the references.  </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> ALG overview</h1>
<p id="rfc.section.4.p.1">The most robust way to solve an IP version mismatch between FTP clients and FTP servers would be by changing clients and servers rather than using an IPv6-to-IPv4 translator for the data channel and using an application layer gateway on the control channel.  As such, it is recommended to update FTP clients and servers as required for IPv6-to-IPv4 translation support where possible, to allow proper operation of the FTP protocol without the need for ALGs.  </p>
<p id="rfc.section.4.p.2">On the other hand, network operators or even network administrators within an organization often have little influence over the FTP client and server implementations used over the network. For those operators and administrators, deploying an ALG may be the only way to provide a satisfactory customer experience. So, even though not the preferred solution, this document standardizes the functionality of such an ALG in order to promote consistent behavior between ALGs in an effort to minimize their harmful effects.  </p>
<p id="rfc.section.4.p.3">Operators and administrators are encouraged to only deploy an FTP ALG for IPv6-to-IPv4 translation when the FTP ALG is clearly needed. In the presence of the ALG, EPSV commands that could be handled directly by conforming servers are translated into PASV commands, introducing additional complexity and reducing robustness. As such a "set and forget" policy on ALGs is not recommended.  </p>
<p id="rfc.section.4.p.4">Note that the translation of EPSV through all translators and EPRT through a stateless translator is relatively simple but supporting translation of EPRT through a stateful translator is relatively difficult, because in the latter case a translation mapping must be set up for each data transfer using parameters that must be learned from the client/server interaction over the control channel. This needs to happen before the EPRT command can be translated into a PORT command and passed on to the server. As such, an ALG used with a stateful translator MUST support EPSV and MAY support EPRT. However, an ALG used with a stateless translator SHOULD also support EPRT.  </p>
<p id="rfc.section.4.p.5">The ALG functionality is described as a function separate from the IPv6-to-IPv4 translation function. However, in the case of EPRT translation, the ALG and translator functions need to be tightly coupled, so if EPRT translation is supported, it is assumed that the ALG and IPv6-to-IPv4 translation functions are integrated within a single device.  </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#controlchanneltranslation" id="controlchanneltranslation">Control channel translation</a>
</h1>
<p id="rfc.section.5.p.1">The IPv6-to-IPv4 FTP ALG intercepts all TCP sessions towards port 21 for IPv6 destination addresses that map to IPv4 destinations reachable through an IPv6-to-IPv4 translator. The FTP ALG implements the Telnet protocol (<a href="#RFC0854">[RFC0854]</a>) used for control channel interactions to the degree necessary to interpret commands and responses and re-issue those commands and responses, modifying them as outlined below. Telnet option negotiation attempts by either the client or the server, except for those allowed by <a href="#RFC1123">[RFC1123]</a>, MUST be rejected by the FTP ALG without relaying those attempts. This avoids the situation where the client and the server negotiate Telnet options that are unimplemented by the FTP ALG.  </p>
<p id="rfc.section.5.p.2">There are two ways to implement the control channel ALG: </p>
<p id="rfc.section.5.p.3">As they ultimately provide the same result, either implementation strategy, or any other that is functionally equivalent, can be used.  </p>
<p id="rfc.section.5.p.4">In the second case, an implementation MUST have the ability to track and update TCP sequence numbers when translating packets as well as the ability to break up packets into smaller packets after translation, as the control channel translation could modify the length of the payload portion of the packets in question. Also, FTP commands/responses or Telnet negotiations could straddle packet boundaries, so in order to be able to perform the ALG function, it can prove necessary to reconstitute Telnet negotiations and FTP commands and responses from multiple packets.  </p>
<p id="rfc.section.5.p.5">If the client issues the AUTH command, then the client is attempting to negotiate <a href="#RFC2228">[RFC2228]</a> security mechanisms which are likely to be incompatible with the FTP ALG function. In this situation, the FTP ALG MUST switch to transparently forwarding all data on the control channel in both directions until the end of the control channel session. This requirement applies regardless of the response from the server. In other words, it is the fact that the client attempts the AUTH negotiation that requires the ALG to become transparent, whether or not the attempt is successful. The transparency requirement applies to the commands and responses flowing between the client and the server. It is possible that commands or responses that were sent through the ALG before the AUTH command was issued were changed in length so TCP sequence numbers in packets entering the ALG and packets exiting the ALG no longer match. In transparent mode, the ALG MUST continue to adjust sequence numbers if it was doing so before entering transparent mode as the result of the AUTH command. The ALGS command (<a href="#algs">Section 11</a>) can also be used to disable the ALG functionality, but the control channel MUST then still be monitored for subsequent ALGS commands that re-enable the ALG functionality.  </p>
<p id="rfc.section.5.p.6">There have been FTP ALGs for the purpose of making active FTP work through IPv4 NATs for a long time. Another type of ALG would be one that imposes restrictions required by security policies. Multiple ALGs of different types can be implemented as a single entity. If such a multi-purpose ALG forbids the use of the AUTH command for policy reasons, the side effect of making the ALG stop performing the translations described here, as well as other possible interventions related to IPv6-to-IPv4 translation, MUST be retained even if the ALG responds to the AUTH command with an error and does not propagate the command to the server. This way, any time a client issues the AUTH command, it knows that an ALG will be in transparent mode afterwards. Implementers are further advised that unlike hosts behind an IPv4 NAT, IPv6 hosts using an IPv6-to-IPv4 translator will normally have the ability to execute FTP over IPv6 without interference from the IPv6-to-IPv4 translator or the ALG, so an IPv6-to-IPv4 translation FTP ALG is not the best place to implement security policies.  </p>
<p id="rfc.section.5.p.7">In the sections that follow, a number of well-known response numbers are shown, along with the descriptive text that is associated with that response number. However, this text is not part of the specification of the response. As such, implementations MAY use the response text shown or they MAY show a different response text for a given response number. Requirements language only applies to the response number.  </p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#lang" id="lang">Language negotiation</a>
</h1>
<p><a href="#RFC2640">[RFC2640]</a> specifies the ability for clients and servers to negotiate the language used between the two of them in the descriptive text that accompanies server response codes. Ideally, IPv6-to-IPv4 FTP ALGs would support this feature, so that if a non-default language is negotiated by a client and a server, the ALG also transmits its text messages for translated responses in the negotiated language. However, even if the ALG supports negotiation of the feature, there is no way to make sure that the ALG has text strings for all possible languages. So the situation where the client and server try to negotiate a language that the ALG doesn't support can't be avoided. The proper behavior for an FTP ALG in this situation may be addressed in a future specification, as the same issue is present in IPv4-to-IPv4 FTP ALGs.  For the time being, ALG implementations may employ one of the following strategies regarding LANG negotiation: </p>
<p id="rfc.section.5.1.p.2">In the first two cases, if a language is negotiated, text transmitted by the client or the server MUST be assumed to be encoded in UTF-8 rather than be limited to 7-bit ASCII. An ALG that implements the first or second option MUST translate and/or forward commands and responses containing UTF-8 encoded text when those occur. The ALG itself MUST NOT generate characters outside the 7-bit ASCII range unless it implements the first option and a language was negotiated.  </p>
<p id="rfc.section.5.1.p.3">Note that <a href="#RFC2640">[RFC2640]</a> section 3.1 specifies new handling for spaces and the CR character in path names. ALGs that don't block LANG negotiation SHOULD comply with the specified rules for path handling. Implementers should especially note that the NUL (%x00) character is used as an escape whenever a CR character occurs in a pathname.  </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#epsv2pasv" id="epsv2pasv">EPSV to PASV translation</a>
</h1>
<p id="rfc.section.6.p.1">Although many IPv4 FTP servers support the EPSV command, some servers react adversely to this command (see <a href="#intro">Section 1</a> for examples), and there is no reliable way to detect in advance that this will happen. As such, an FTP ALG SHOULD translate all occurrences of the EPSV command issued by the client to the PASV command, and reformat a 227 response as a corresponding 229 response. However, an ALG MAY forego EPSV to PASV translation if it has positive knowledge, either through administrative configuration or learned dynamically, that EPSV will be successful without translation to PASV.  </p>
<p id="rfc.section.6.p.2">For instance, if the client issues EPSV (or EPSV 2 to indicate IPv6 as the network protocol), this is translated to the PASV command. If the server with address 192.0.2.31 then responds with: </p>
<p id="rfc.section.6.p.3">The FTP ALG reformats this as: </p>
<p id="rfc.section.6.p.4">The ALG SHOULD ignore the IPv4 address in the server's 227 response. This is the behavior that is exhibited by most clients and is needed to work with servers that include <a href="#RFC1918">[RFC1918]</a> addresses in their 227 responses. However, if the 227 response contains an IPv4 address that does not match the destination of the control channel, the FTP ALG MAY send a 425 response to the client instead of the 229 response, e.g.: </p>
<p id="rfc.section.6.p.5">It is important that the response is in the 4xx range to indicate a temporary condition.  </p>
<p id="rfc.section.6.p.6">If the client issues an EPSV command with a numeric argument other than 2, the ALG MUST NOT pass the command on to the server, but rather respond with a 522 error, e.g.: </p>
<p id="rfc.section.6.p.7">If the client issues EPSV ALL, the FTP ALG MUST NOT pass this command to the server, but respond with a 504 error, e.g.: </p>
<p id="rfc.section.6.p.8">This avoids the situation where an FTP server reacts adversely to receiving a PASV command after the client used the EPSV ALL command to indicate that it will only use EPSV during this session.  </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> EPRT to PORT translation</h1>
<p id="rfc.section.7.p.1">Should the IPv6 client issue an EPRT command, the FTP ALG MAY translate this EPRT command to a PORT command. The translation is different depending on whether the translator is a stateless one-to-one translator or a stateful one-to-many translator.  </p>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> Stateless EPRT translation</h1>
<p id="rfc.section.7.1.p.1">If the address specified in the EPRT command is the IPv6 address used by the client for the control channel session, then the FTP ALG reformats the EPRT command into a PORT command with the IPv4 address that maps to the client's IPv6 address. The port number MUST be preserved for compatibility with stateless translators. For instance, if the client with IPv6 address 2001:db8:2::31 issues the following EPRT command: </p>
<p id="rfc.section.7.1.p.2">Assuming the IPv4 address that goes with 2001:db8:2::31 is 192.0.2.31, the FTP ALG reformats this as: </p>
<p id="rfc.section.7.1.p.3">If the address specified in the EPRT command is an IPv4 address or an IPv6 address that is not the IPv6 address used by the client for the control session, the ALG SHOULD NOT attempt any translation, but pass along the command unchanged.  </p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> Stateful EPRT translation</h1>
<p id="rfc.section.7.2.p.1">If the address in the EPRT command is the IPv6 address used by the client for the control channel, the stateful translator selects an unused port number in combination with the IPv4 address used for the control channel towards the FTP server, and sets up a mapping from that transport address to the one specified by the client in the EPRT command. The PORT command with the IPv4 address and port used on the IPv4 side of the mapping is only issued towards the server once the mapping is created. Initially, the mapping is such that either any transport address or the FTP server's IPv4 address with any port number is accepted as a source, but once the three-way handshake is complete, the mapping SHOULD be narrowed to only match the negotiated TCP session.  </p>
<p id="rfc.section.7.2.p.2">If the address specified in the EPRT command is an IPv4 address or an IPv6 address that is not the IPv6 address used by the client for the control session, the ALG SHOULD NOT attempt any translation, but pass along the command unchanged.  </p>
<p id="rfc.section.7.2.p.3">If the client with IPv6 address 2001:db8:2::31 issues the EPRT command: </p>
<p id="rfc.section.7.2.p.4">And the stateful translator uses the address 192.0.2.31 on its IPv4 interface, a mapping with destination address 192.0.2.31 and destination port 60192 towards 2001:db8:2::31 port 5282 may be created, after which the FTP ALG reformats the EPRT command as: </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Default port 20 translation</h1>
<p id="rfc.section.8.p.1">If the client does not issue an EPSV/PASV or EPRT/PORT command prior to initiating a file transfer, it is invoking the default active FTP behavior where the server sets up a TCP session towards the client. In this situation, the source port number is the default FTP data port (port 20) and the destination port is the port the client uses as the source port for the control channel session.  </p>
<p id="rfc.section.8.p.2">In the case of a stateless translator, this does not pose any problems. In the case of a stateful translator, the translator MAY accept incoming connection requests from the server on the IPv4 side if the transport addresses match that of an existing FTP control channel session, with the exception that the control channel session uses port 21 and the new session port 20. In this case, a mapping is set up towards the same transport address on the IPv6 side that is used for the matching FTP control channel session.  </p>
<p id="rfc.section.8.p.3">An ALG/translator MAY monitor the progress of FTP control channels and only attempt to perform a mapping when an FTP client has started a file transfer without issuing the EPSV, PASV, EPRT or PORT commands.  </p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> Both PORT and PASV</h1>
<p><a href="#RFC0959">[RFC0959]</a> allows a client to issue both PORT and PASV to use non-default ports on both sides of the connection. However, this is incompatible with the notion that with PASV, the data connection is made from the client to the server, while PORT reaffirms the default behavior where the server connects to the client. As such, the behavior of an ALG is undefined when a client issues both PASV and PORT. Implementations SHOULD NOT try to detect the situation where both PASV and PORT commands are issued prior to a command that initiates a transfer, but rather, apply the same translation they would have if there had not been a PASV command prior to a PORT command or a PORT command prior to a PASV command.  </p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> Default behavior</h1>
<p id="rfc.section.10.p.1">Whenever the client issues a command which the ALG is not set up to translate, either because the command is not specified in this document, the command is not part of any FTP specification, the ALG functionality is disabled administratively for the command in question, or translation does not apply for any other reason, the command MUST be passed on to the server without modification, and the server response MUST be passed on to the client without modification. For example, if the client issues the PASV command, this command is passed on to the server transparently, and the server's response to the client.  </p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> <a href="#algs" id="algs">The ALGS command</a>
</h1>
<p id="rfc.section.11.p.1">ALGs MUST support the new ALGS (ALG status) command that allows clients to query and set the ALG's status.  FTP servers (as opposed to ALGs) MUST NOT perform any actions upon receiving the ALGS command. FTP servers MUST still send a response, however.  If FTP servers recognize the ALGS command, the best course of action would be to return a 202 response: </p>
<p id="rfc.section.11.p.2">However, there is no reason for FTP servers to specifically recognize this command; returning any 50x response that is normally returned when commands are not recognized is appropriate.  </p>
<p id="rfc.section.11.p.3">A client can use the ALGS command to request the ALG's status and to enable and disable EPSV to PASV and, if implemented, EPRT to PORT translation.  There are three possible arguments to the ALGS command: </p>
<p id="rfc.section.11.p.4">The ALG MUST enable or disable EPSV to PASV translation as requested.  If EPRT to PORT translation is supported, ALGS ENABLE64 SHOULD enable it and ALGS DISABLE64 SHOULD disable it along with enabling or disabling EPSV to PASV translation, respectively.  If EPRT to PORT translation is not supported, ALGS ENABLE64 only enables EPSV to PASV translation. After an ALGS command with any of the three supported arguments, the ALG MUST return a 216 response indicating the type of translation that will be performed.  </p>
<p id="rfc.section.11.p.5">The translation type MAY be followed by a space and additional descriptive text until end-of-line.  If the ALG is unable to set the requested translation mode, for instance, because of lack of certain resources, this is not considered an error condition. In those cases, the ALG responds with a 216 response followed by the keyword that indicates the current translation status of the ALG.  </p>
<p id="rfc.section.11.p.6">If there is no argument to the ALGS command, or the argument is not one of STATUS64, ENABLE64 or DISABLE64 (or an argument specified by a supported newer document), a 504 or 502 error SHOULD be returned.  </p>
<p id="rfc.section.11.p.7">The Augmented Backus-Naur Form (ABNF) notation (see <a href="#RFC5234">[RFC5234]</a>) of the ALGS command and its response are as follows: </p>
<div id="#rfc.figure.1"></div>
<pre>
algs-command      = "ALGS" SP algs-token CRLF
algs-token        = "STATUS64" / "ENABLE64" / "DISABLE64" 

algs-response     = (ok-response / error-response) CRLF
ok-response       = "216" SP response-token [ freetext ]
response-token    = "NONE" / "EPSV" / "EPRT" / "EPSVEPRT"
error-response    = not-implemented / invalid-parameter
not-implemented   = "502" [ freetext ]
invalid-parameter = "504" [ freetext ]
freetext          = (SP *VCHAR)
</pre>
<h1 id="rfc.section.12">
<a href="#rfc.section.12">12.</a> Timeouts and translating to NOOP</h1>
<p id="rfc.section.12.p.1">Wherever possible, control channels SHOULD NOT time out while there is an active data channel. A timeout of at least 30 seconds is RECOMMENDED for data channel mappings created by the FTP ALG that are waiting for initial packets.  </p>
<p id="rfc.section.12.p.2">Whenever a command from the client is not propagated to the server, the FTP ALG instead issues a NOOP command in order to keep the keepalive state between the client and the server synchronized. The response to the NOOP command MUST NOT be relayed back to the client. An implementation MAY wait for the server to return the 200 response to the NOOP command and translate that 200 response into the response the ALG is required to return to the client. This way, the ALG never has to create new packets to send to the client, but it can limit itself to modifying packets transmitted by the server.  If the server responds with something other than 200 to the NOOP command, the ALG SHOULD tear down the control channel session and log an error.  </p>
<h1 id="rfc.section.13">
<a href="#rfc.section.13">13.</a> IANA considerations</h1>
<p id="rfc.section.13.p.1">IANA is requested to add to the FTP Commands and Extensions registry the following entry: </p>
<p id="rfc.section.13.p.2">[TO BE REMOVED: This registration should take place at the following location: http://www.iana.org/assignments/ftp-commands-extensions/ftp-commands-extensions.xhtml] </p>
<h1 id="rfc.section.14">
<a href="#rfc.section.14">14.</a> Security considerations</h1>
<p id="rfc.section.14.p.1">In the majority of cases, FTP is used without further security mechanisms. This allows an attacker with passive interception capabilities to obtain the login credentials, and an attacker that can modify packets to change the data transferred. However, FTP can be used with TLS in order to solve these issues. IPv6-to-IPv4 translation and the FTP ALG do not impact the security issues in the former case nor the use of TLS in the latter case. However, if FTP is used with TLS as per <a href="#RFC4217">[RFC4217]</a>, or another authentication mechanism that the ALG is aware of, the ALG function is not performed so only passive transfers from a server that implements EPSV or a client that supports PASV will succeed.  </p>
<p id="rfc.section.14.p.2">For general FTP security considerations, see <a href="#RFC2577">[RFC2577]</a>.  </p>
<h1 id="rfc.section.15">
<a href="#rfc.section.15">15.</a> Contributors</h1>
<p id="rfc.section.15.p.1">Dan Wing, Kentaro Ebisawa, Remi Denis-Courmont, Mayuresh Bakshi, Sarat Kamisetty, Reinaldo Penno, Alun Jones, Dave Thaler, Mohammed Boucadair, Mikael Abrahamsson, Dapeng Liu, Michael Liu, Andrew Sullivan, Anthony Bryan and Ed Jankiewicz contributed ideas and comments.  Dan Wing ran experiments with a large number of FTP servers that were very illuminating; many of the choices underlying this document are based on his results.  </p>
<h1 id="rfc.section.16">
<a href="#rfc.section.16">16.</a> Acknowledgements</h1>
<p id="rfc.section.16.p.1">Iljitsch van Beijnum is partly funded by Trilogy, a research project supported by the European Commission under its Seventh Framework Program.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">17.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">17.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC0854">[RFC0854]</b></td>
<td class="top">
<a title="University of Southern California (USC)/Information Sciences Institute">Postel, J.</a> and <a title="University of Southern California (USC)/Information Sciences Institute">J. Reynolds</a>, "<a href="http://tools.ietf.org/html/rfc854">Telnet Protocol Specification</a>", STD 8, RFC 854, May 1983.</td>
</tr>
<tr>
<td class="reference"><b id="RFC0959">[RFC0959]</b></td>
<td class="top">
<a title="Information Sciences Institute (ISI)">Postel, J.</a> and <a>J. Reynolds</a>, "<a href="http://tools.ietf.org/html/rfc959">File Transfer Protocol</a>", STD 9, RFC 959, October 1985.</td>
</tr>
<tr>
<td class="reference"><b id="RFC1123">[RFC1123]</b></td>
<td class="top">
<a href="mailto:Braden@ISI.EDU" title="University of Southern California (USC), Information Sciences Institute">Braden, R.</a>, "<a href="http://tools.ietf.org/html/rfc1123">Requirements for Internet Hosts - Application and Support</a>", STD 3, RFC 1123, October 1989.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2228">[RFC2228]</b></td>
<td class="top">
<a href="mailto:marc@cygnus.com" title="Cygnus Solutions">Horowitz, M.</a>, "<a href="http://tools.ietf.org/html/rfc2228">FTP Security Extensions</a>", RFC 2228, October 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2428">[RFC2428]</b></td>
<td class="top">
<a href="mailto:mallman@lerc.nasa.gov" title="NASA Lewis Research Center/Sterling Software">Allman, M.</a>, <a href="mailto:ostermann@cs.ohiou.edu" title="School of Electrical Engineering and Computer Science">Ostermann, S.</a> and <a href="mailto:cmetz@inner.net" title="The Inner Net">C. Metz</a>, "<a href="http://tools.ietf.org/html/rfc2428">FTP Extensions for IPv6 and NATs</a>", RFC 2428, September 1998.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5234">[RFC5234]</b></td>
<td class="top">
<a>Crocker, D.</a> and <a>P. Overell</a>, "<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>", STD 68, RFC 5234, January 2008.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">17.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC1918">[RFC1918]</b></td>
<td class="top">
<a href="mailto:yakov@cisco.com" title="Cisco systems">Rekhter, Y.</a>, <a href="mailto:rgm3@is.chrysler.com" title="Chrysler Corporation">Moskowitz, R.</a>, <a href="mailto:Daniel.Karrenberg@ripe.net" title="RIPE Network Coordination Centre">Karrenberg, D.</a>, <a href="mailto:GeertJan.deGroot@ripe.net" title="RIPE Network Coordination Centre">Groot, G.</a> and <a href="mailto:lear@sgi.com" title="Silicon Graphics, Inc.">E. Lear</a>, "<a href="http://tools.ietf.org/html/rfc1918">Address Allocation for Private Internets</a>", BCP 5, RFC 1918, February 1996.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2389">[RFC2389]</b></td>
<td class="top">
<a href="mailto:phethmon@hethmon.com" title="Hethmon Brothers">Hethmon, P.</a> and <a href="mailto:kre@munnari.OZ.AU" title="University of Melbourne">R. Elz</a>, "<a href="http://tools.ietf.org/html/rfc2389">Feature negotiation mechanism for the File Transfer Protocol</a>", RFC 2389, August 1998.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2577">[RFC2577]</b></td>
<td class="top">
<a href="mailto:mallman@grc.nasa.gov" title="NASA Glenn Research Center/Sterling Software">Allman, M.</a> and <a href="mailto:ostermann@cs.ohiou.edu" title="Ohio University, School of Electrical Engineering and Computer Science">S. Ostermann</a>, "<a href="http://tools.ietf.org/html/rfc2577">FTP Security Considerations</a>", RFC 2577, May 1999.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2640">[RFC2640]</b></td>
<td class="top">
<a href="mailto:curtinw@ftm.disa.mil" title="JIEO">Curtin, B.</a>, "<a href="http://tools.ietf.org/html/rfc2640">Internationalization of the File Transfer Protocol</a>", RFC 2640, July 1999.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4217">[RFC4217]</b></td>
<td class="top">
<a>Ford-Hutchinson, P.</a>, "<a href="http://tools.ietf.org/html/rfc4217">Securing FTP with TLS</a>", RFC 4217, October 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6145">[RFC6145]</b></td>
<td class="top">
<a>Li, X.</a>, <a>Bao, C.</a> and <a>F. Baker</a>, "<a href="http://tools.ietf.org/html/rfc6145">IP/ICMP Translation Algorithm</a>", RFC 6145, April 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6146">[RFC6146]</b></td>
<td class="top">
<a>Bagnulo, M.</a>, <a>Matthews, P.</a> and <a>I. van Beijnum</a>, "<a href="http://tools.ietf.org/html/rfc6146">Stateful NAT64: Network Address and Protocol Translation from IPv6 Clients to IPv4 Servers</a>", RFC 6146, April 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.liu-ftp64-extension">[I-D.liu-ftp64-extension]</b></td>
<td class="top">
<a>Liu, D</a>, <a>Beijnum, I</a> and <a>Z Cao</a>, "<a href="http://tools.ietf.org/html/draft-liu-ftp64-extension-00">FTP extension for IPv4/IPv6 transition</a>", Internet-Draft draft-liu-ftp64-extension-00, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="Bernstein">[Bernstein]</b></td>
<td class="top">
<a>Bernstein, D. J.</a>, "<a>PASV security and PORT security</a>", 2000.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Iljitsch van Beijnum</span> 
	  <span class="n hidden">
		<span class="family-name">van Beijnum</span>
	  </span>
	</span>
	<span class="org vcardline">Institute IMDEA Networks</span>
	<span class="adr">
	  <span>Avda. del Mar Mediterraneo, 22</span>

	  <span class="vcardline">
		<span class="locality">Leganes</span>,  
		<span class="region">Madrid</span> 
		<span class="code">28918</span>
	  </span>
	  <span class="country-name vcardline">Spain</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:iljitsch@muada.com">iljitsch@muada.com</a></span>

  </address>
</div>

</body>
</html>