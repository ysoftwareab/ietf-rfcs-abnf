<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Reverse Routing Header</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Reverse Routing Header">
<meta name="keywords" content="Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">6MAN</td><td class="header">P. Thubert, Ed.</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco Systems</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">December 10, 2010</td></tr>
<tr><td class="header">Expires: June 13, 2011</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Reverse Routing Header<br />draft-thubert-6man-reverse-routing-header-01</h1>

<h3>Abstract</h3>

<p>For new classes of devices such as highly constrained nodes, 
		forward and return Record Route capabilities are required to enable
		basic forwarding operations. This memo defines
	  a such a technique for IPv6.
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on June 13, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#sec_introduction">1.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#recu">1.1.</a>&nbsp;
Motivations<br />
<a href="#sec_terminology">2.</a>&nbsp;
Terminology<br />
<a href="#sec_example">3.</a>&nbsp;
Examples<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_example_flood">3.1.</a>&nbsp;
Flooding downwards<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_example_uni">3.2.</a>&nbsp;
Following an implicit upwards path<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_example_rec">3.3.</a>&nbsp;
Recording a forward path<br />
<a href="#sec_rh_types">4.</a>&nbsp;
New Routing Headers<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_rh_type_2">4.1.</a>&nbsp;
FRRH and RRH formats<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_icmp">4.2.</a>&nbsp;
Optimum number of slots<br />
<a href="#sec_SRN_operation">5.</a>&nbsp;
Source Routing Node Operation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_rh_icmp_64_processing">5.1.</a>&nbsp;
Processing of ICMP "RRH Warning"<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_rh_icmp_processing">5.2.</a>&nbsp;
Processing of ICMP error<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_rrh_full">5.3.</a>&nbsp;
Processing of RRH Packets<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec_frrh_full">5.4.</a>&nbsp;
Processing of FRRH Packets<br />
<a href="#sec_security">6.</a>&nbsp;
Security Considerations<br />
<a href="#anchor1">7.</a>&nbsp;
IANA considerations<br />
<a href="#sec_const">8.</a>&nbsp;
Protocol Constants<br />
<a href="#sec_acknowledgements">9.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">10.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">10.1.</a>&nbsp;
informative reference<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">10.2.</a>&nbsp;
normative reference<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="sec_introduction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>This document assumes that the reader is familiar with the
IPv6 RH0 operation as specified in <a class='info' href='#RFC2460'>[RFC2460]<span> (</span><span class='info'>Deering, S. and R. Hinden, &ldquo;Internet Protocol, Version 6 (IPv6) Specification,&rdquo; December&nbsp;1998.</span><span>)</span></a> and the RH2
as previously defined in  <a class='info' href='#RFC3775'>[RFC3775]<span> (</span><span class='info'>Johnson, D., Perkins, C., and J. Arkko, &ldquo;Mobility Support in IPv6,&rdquo; June&nbsp;2004.</span><span>)</span></a> and the RH4 defined
for <a class='info' href='#I-D.ietf-roll-rpl'>RPL<span> (</span><span class='info'>Winter, T., Thubert, P., Brandt, A., Clausen, T., Hui, J., Kelsey, R., Levis, P., Pister, K., Struik, R., and J. Vasseur, &ldquo;RPL: IPv6 Routing Protocol for Low power and Lossy Networks,&rdquo; December&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;roll&#8209;rpl] in 
<a class='info' href='#I-D.ietf-6man-rpl-routing-header'>[I&#8209;D.ietf&#8209;6man&#8209;rpl&#8209;routing&#8209;header]<span> (</span><span class='info'>Hui, J., Vasseur, J., Culler, D., and V. Manral, &ldquo;An IPv6 Routing Header for Source Routes with RPL,&rdquo; October&nbsp;2010.</span><span>)</span></a>. It is more specifically
targetted to address the needs of the RPL extensions defined in 
<a class='info' href='#I-D.ietf-roll-p2p-rpl'>Reactive Discovery of Point-to-Point Routes<span> (</span><span class='info'>Goyal, M. and E. Baccelli, &ldquo;Reactive Discovery of Point-to-Point Routes in Low Power and Lossy Networks,&rdquo; October&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;roll&#8209;p2p&#8209;rpl].
</p>
<p>This specification defines a Forward Record Routing Header (FRRH), that 
is a controlled variant of the Loose Source and Record Route (LSRR)
defined for IPv4 in <a class='info' href='#RFC0791'>[RFC0791]<span> (</span><span class='info'>Postel, J., &ldquo;Internet Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a>  and hereby adapted for IPv6. 
FRRH records the path of a packet within a closed Source Routing Domain (SRD) such
as a RPL network. 

</p>
<p>This specification also introduces a new Routing Header, called the Reverse
Routing Header (RRH), to perform source routing within the RPL network 
along the way back. As opposed to the FRRH that records a forward path,
RRH stacks the route bottom up and can be trivially 
converted into a RH4 to force packets to follow an
identical reverse path within the same RPL network.
</p>
<p>The FRRH and the RRH are designed to be trivially
converted into a RH4 to force further packets to follow an
identical path within the same RPL network, so the rules that govern the
construction of a Routing Header type 4 in 
<a class='info' href='#I-D.ietf-6man-rpl-routing-header'>[I&#8209;D.ietf&#8209;6man&#8209;rpl&#8209;routing&#8209;header]<span> (</span><span class='info'>Hui, J., Vasseur, J., Culler, D., and V. Manral, &ldquo;An IPv6 Routing Header for Source Routes with RPL,&rdquo; October&nbsp;2010.</span><span>)</span></a> also
apply similarily to FRRH and RRH.

</p>
<a name="recu"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
Motivations</h3>

<p> A Low Power Lossy Network (LLN) often forms a dynamic NBMA Subnetwork of devices 
that might be so constrained in memory that they cannot 
hold all the states that would be required to route within their own
Subnetwork. In some instances, default routes to some border routers can
be maintained, but the way back to specific destination cannot. In other 
instances, even the route to the border router will be lost rapidly.

</p>
<p><a class='info' href='#I-D.ietf-roll-rpl'>RPL<span> (</span><span class='info'>Winter, T., Thubert, P., Brandt, A., Clausen, T., Hui, J., Kelsey, R., Levis, P., Pister, K., Struik, R., and J. Vasseur, &ldquo;RPL: IPv6 Routing Protocol for Low power and Lossy Networks,&rdquo; December&nbsp;2010.</span><span>)</span></a> [I&#8209;D.ietf&#8209;roll&#8209;rpl] is a Subnetwork Gateway Protocol
(SGP), that is a routing protocol that can build and maintain a routing topology
within a subnet as well as distribute some subnet information. RPL is optimized for Point 
to Multipoint (P2MP) from a root and Multipoint to Point (MP2P) to a root
of the LLN, but allows a stretch for any to any communication.
<a class='info' href='#I-D.ietf-roll-p2p-rpl'>[I&#8209;D.ietf&#8209;roll&#8209;p2p&#8209;rpl]<span> (</span><span class='info'>Goyal, M. and E. Baccelli, &ldquo;Reactive Discovery of Point-to-Point Routes in Low Power and Lossy Networks,&rdquo; October&nbsp;2010.</span><span>)</span></a> extends RPL to establish on-demand
an arbitrary Point to Point (P2P) path with lesser stretch and lower set up and repair latency than
the base protocol. This specification allows to locate the additional
states at the end-points so as to avoid extra in the intermediate nodes. 

</p>
<p>With strict source routing, the intermediate nodes find the next hop
for a given packet in a routing header that is set by the source as
specified for instance in
<a class='info' href='#I-D.ietf-6man-rpl-routing-header'>[I&#8209;D.ietf&#8209;6man&#8209;rpl&#8209;routing&#8209;header]<span> (</span><span class='info'>Hui, J., Vasseur, J., Culler, D., and V. Manral, &ldquo;An IPv6 Routing Header for Source Routes with RPL,&rdquo; October&nbsp;2010.</span><span>)</span></a> that defines the RH type 4
for IPv6.  
With this specification, the path information in the RH4 is maintained
with consistent snapshots of the full path across the Source Route Domain
that is recorded in-band with selected packets.

</p>
<a name="sec_terminology"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>This document assumes that the reader is familiar with ROLL terminology defined in
 <a class='info' href='#I-D.ietf-roll-terminology'>[I&#8209;D.ietf&#8209;roll&#8209;terminology]<span> (</span><span class='info'>Vasseur, J., &ldquo;Terminology in Low power And Lossy Networks,&rdquo; September&nbsp;2010.</span><span>)</span></a>.

</p>
<p> Additional terms are defined hereafter:
 </p>
<blockquote class="text"><dl>
<dt>DAG</dt>
<dd> Directed Acyclic Graph.
</dd>
<dt>SRN</dt>
<dd>
     Source Routing Node. A host or a router with the capability to support
	 this specification and make use of RRH within its NBMA Subnetwork .
</dd>
<dt>SRD</dt>
<dd>
     Source Routing Domain. A domain in which the Source Route operation is
     accepted. All intermediate addresses within the same RH 
	 must belong to the same SRD.
	 A domain can be:
	
<ul class="text">
<li> A node or a contiguous set of nodes such as a dominating set
</li>
<li> A Subnetwork such as a RPL Network 
</li>
<li> A network serving the same Unique Local Aggregation.
</li>
</ul>
	
</dd>
<dt>SRA:</dt>
<dd>
    Source Routable Address. An address that can be inserted in a RH/RRH.
    An SRA is an Ipv6 address that belongs to the SR domain with a 
	scope that is valid across the SR domain.
</dd>
<dt>TA:</dt>
<dd>
    Target Address. The last Address in the Routing Header identifying
	the target. There is no constraint on that address.
</dd>
<dt>CRH:</dt>
<dd>
    Constrained Routing Header. A constrained routing header is a routing header
	that can be forwarded only within an SRD. It is formed of a list of SRA, followed
	by at most one TA.
</dd>
<dt>FRRH:</dt>
<dd>
    Forward Record Routing Header, defined in this specification; 
	a variable size record route header used to learn a path
	hop-by-hop. It is preferably formed of addresses that are located
	on the ingress interface of the packets.
</dd>
<dt>RRH:</dt>
<dd>
    Reverse Routing Header, defined in this specification; 
	a variable size reverse route header used to learn a path back
	hop-by-hop. It is formed of addresses that are located
	on the egress interface of the packets.
</dd>
<dt>NULL RH:</dt>
<dd>
    An FRRH or an RRH with a zero "Segments Used".
</dd>
</dl></blockquote><p>

</p>
<a name="sec_example"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Examples</h3>

<p>For the sake of the example, the RPL Network in the following 
figure assumes the logical shape of a tree towards a border router.
This abstraction is chosen because it is simpler to represent than 
the actual Directed Acyclic Graph shape that most RPL Networks
will form.
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                    +---------------------+
                    |     Internet        |---CN
                    +---------------|-----+
                            Border Router
                              |
                           ======?======
                                SRN1
                                 |
                   ====?=============?==============?===
                      SRN5          SRN2           SRN6
                       |             |              |
                 ===========   ===?=========   =============
                                 SRN3
                                  |
                         ===========?==
    RPL Network                    SRN4
                                    |
                                =========


</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp; A tree shaped RPL network&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>This example focuses on a SRD node at depth 3 identified as 
Source Routing Node 3 (SRN3). The path to the border router and then the Internet is
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     SRN3 -&gt; SRN2 -&gt; SRN1 -&gt; Border Router -&gt;Internet
</pre></div><p>

In one example, the Border Routers first initiates a multicast flooding to build
a Reverse Routing Header that records
the source route path from each node towards itself. In another example, a node 
that wishes to be reachable starts a record route towards the border router.
 
</p>
<p>A node that wishes to be reachable
inserts a reverse routing header with a number of N
pre-allocated slots that derive from its estimation of its depth. 

</p>
<a name="sec_example_flood"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Flooding downwards</h3>

<p>In this example, no preexisting routing structure exists and the
routing header is being assembled by a flooding mechanism from the
Border Router (BR) downwards.
</p>
<p>The packet has source an IPv6 address of the Border Router Address, BR_Add, and
destination a multicast link scope address that is used for the flooding:

</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----+-------++-------+--------+--------+ +---
| SRC   | DST   |:    :|    | slotN || slot2 | slot1  | source | |
| BR    |all XXX|: EXT:|RRH |       ||       | BR     | BR     | | NH
| Add   |L scope|:    :|    |       ||       | SRA    | TA     | |
+-------+-------++ -- ++----+-------++-------+--------+--------+ +---
</pre></div><p>

The BR-SRA acts as locator and it is possible that this address has a limited reach
such as ULA. The BR-TA is a global identifier for the BR. It might be omitted when
the source of the RRH is only used as an intermediate router and not as a destination.
</p>
<p>
It must be noted that BR-SRA is preferably an address on the BR interface towards SRN1, 
that is directly visible from SRN1, in case there is no routing between BR and SRN1.
</p>
<p>
BR-SRA is also preferably an address that has a scope as large as the Source Route Domain, 
enabling the hop-by-hop recording process to possibly omit tracing some intermediate 
hops and thus form a loose source route header.

</p>
<p>The routers one hop away figure the best message they receive and propagate it,
including the augmented RRH. 
</p>
<p>For SRN1, this gives:

</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----+-------++-------+--------+--------+ +---
| SRC   | DST   |:    :|    | slotN || slot2 | slot1  | source | |
| SRN1  |all XXX|: EXT:| RRH|       || SRN1  | BR     | BR     | | NH
| Add   |L scope|:    :|    |       || SRA   | SRA    | TA     | |
+-------+-------++ -- ++----+-------++-------+--------+--------+ +---
</pre></div><p>



</p>
<p>When SRN3 gets the packet, it receives:

</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----++-------+-------+--------+--------+ +---
| SRC   | DST   |:    :|    || slot3 | slot2 | slot1  | source | |
|SRN2   |all XXX|: EXT:| RRH|| SRN2  | SRN1  | BR     | BR     | | NH
|Add    |L scope|:    :|    || SRA   | SRA   | SRA    | TA     | |
+-------+-------++ -- ++----++-------+-------+--------+--------+ +---
</pre></div><p>



</p>
<p>The RH4 is trivially built by picking the tail of the incoming RRH, to be inserted
when sending a packet to the border router. Additionally, the node might create a tunnel
interface towards the border and install a default route there.

</p>
<p> So an arbitrary destination
in the Internet can replace the BR TA and will cause a packet flow like this:

</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
transport mode (1 slot consumed if SRN3 TA is included)):
+-------+-------+----+-------+-------+-------+---------++ -- + +---
| SRC   | DST   | RH | slot3 | slot2 | slot1 | destin. |:    : |
|SRN3   |SRN2   |type| SRN3  | SRN1  | BR    | arbitr. |: EXT: | NH
|SRA    |SRA    | 4  | TA    | SRA   | SRA   | destin. |:    : |
+-------+-------+----+-------+-------+-------+---------++ -- + +---

tunnel mode (nothing consumed):
+-------+-------+----+-------+-------+ +-------+-------++ -- + +---
|oSRC   |oDST   | RH | slot1 | slot0 | |iSRC   |iDST   |:    : |
|SRN3   |SRN2   |type| SRN1  | BR    | |SRN3   |arbitr.|: EXT: | NH
|SRA    |SRA    | 4  | SRA   | SRA   | |TA     |destin.|:    : |
+-------+-------++--++-------+-------+ +-------+-------++ -- + +---
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Message going out of SRN3 to the BR&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>That reaches the Border Router as this:
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
transport mode (consumed up to slot 1):
+-------+-------+----+-------+-------+-------+---------++ -- + +---
| SRC   | DST   | RH | slot3 | slot2 | slot1 | destin. |:    : |
|SRN3   |BR     |type| SRN3  | SRN2  | SRN1  | arbitr. |: EXT: | NH
|TA     |SRA    | 4  | SRA   | SRA   | SRA   | destin. |:    : |
+-------+-------+----+-------+-------+-------+---------++ -- + +---

tunnel mode (all consumed):
+-------+-------+----+-------+-------+ +-------+-------++ -- + +---
|oSRC   |oDST   | RH | slot1 | slot0 | |iSRC   |iDST   |:    : |
|SRN3   |BR     |type| SRN2  | SRN1  | |SRN3   |arbitr.|: EXT: | NH
|SRA    |SRA    | 4  | SRA   | SRA   | |TA     |destin.|:    : |
+-------+-------++--++------+-------+ +-------+-------++ -- + +---

Message going out of BR:
+-------+-------++ -- + +---
| SRC   | DST   |:    : |
|SRN3   |arbitr.|: EXT: | NH
|TA     |destin.|:    : |
+-------+-------++ -- + +---
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Message coming in the border router from SRN3&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
Upon decapsulation, it is up to the border router to decide by policy whether it should
route the packet or not. In particular in Transport mode, security reasons might dictate
to drop the packet.

</p>
<a name="sec_example_uni"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Following an implicit upwards path</h3>

<p>In this example, a preexisting routing structure exists that leads
to a well-known border router. The RRH is assembled along that path.
</p>
<p>
The last (bottom) slot contains a global identifier for the SRN, SRN3 TA.
there is no constraint with regard to the type of IPv6 address
used there. 
It might be omitted if SRN3 uses its SRA to terminate its connections.
Then SRN3 inserts its SRA in the slot directly above. 
</p>
<p>The IPv6 header in the packet has source SRN3's Address, SRN3_Add, and
destination SRN3's next hop Add, SRN2_Add, on the link between SRN2 and SRN3:

</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----+-------++-------+-------+---------+ +---
| SRC   | DST   |:    :|    | slotN || slot2 | slot1 | source  | |
|SRN3   |SRN2   |: EXT:| RRH|       ||       | SRN3  | SRN3    | | NH
|Add    |Add    |:    :|    |       ||       | SRA   | TA      | |
+-------+-------++ -- ++----+-------++-------+-------+---------+ +---

</pre></div><p>




</p>
<p>The second router on the path, SRN2, receives that the packet.
If it is not the border router, then it might wish to propagate
the protocol payload towards the border router that is the implicit
termination of the propagation as dictated by the protocol operation.
</p>
<p>The outer packet now has source SRN2 Add and destination SRN1 Add; the
RRH from top to bottom is: empty_slots | SRN2_SRA | SRN3_SRA | SRN3_TA:
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----+-------++-------+-------+---------+ +---
| SRC   | DST   |:    :|    | slotN || slot2 | slot1 | source  | |
|SRN2   |SRN1   |: EXT:| RRH|       || SRN2  | SRN3  | SRN3    | | NH
|Add    |Add    |:    :|    |       || SRA   | SRA   | TA      | |
+-------+-------++ -- ++----+-------++-------+-------+---------+ +---

</pre></div><p>


</p>
<p>In general the process followed by the second router is repeated by
all the routers on the path, till the border router that receives and absorbs:

</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----++-------+-------+-------+---------+ +---
| SRC   | DST   |:    :|    || slot3 | slot2 | slot1 | source  | |
|SRN1   |BR     |: EXT:| RRH|| SRN1  | SRN2  | SRN3  | SRN3    | | NH
|Add    |Add    |:    :|    || SRA   | SRA   | SRA   | TA      | |
+-------+-------++ -- ++----++-------+-------+-------+---------+ +---

</pre></div><p>


</p>
<p>When the border router, receives the packet, it MAY store the information in RRH 
to build an RH4 back to SRN3 TA (or SRN3 SRA if the TA is omitted)
</p>
<p>Again, the RH is trivially built by picking the trail of the previous RRH, to be inserted
by the border router into any packet flowing down to SRN3:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Message coming in the border router from the infrastructure behind:

+-------+-------++ -- + +---
| SRC   | DST   |:    : |
|arbitr.|SRN3   |: EXT: | NH
|source |TA     |:    : |
+-------+-------++ -- + +---

Message going out the border router:

transport mode:
+-------+-------+----+-------+-------+---------++ -- + +---
| SRC   | DST   | RH | slot2 | slot1 | destin  |:    : |
|arbitr.|SRN1   |type| SRN2  | SRN3  | SRN3    |: EXT: | NH
|source |SRA    | 4  | SRA   | SRA   | TA      |:    : |
+-------+-------+----+-------+-------+---------++ -- + +---

Tunnel mode:
+-------+-------++----+-------+--------+ +-------+-------++ -- + +---
|oSRC   |oDST   || RH | slot2 | slot1  | |iSRC   |iDST   |:    : |
|SRN3   |SRN1   ||type| SRN2  | SRN3   | |arbitr.|SRN3   |: EXT: | NH
|SRA    |SRA    || 4  | SRA   | SRA    | |source |TA     |:    : |
+-------+-------++----+-------+--------+ +-------+-------++ -- + +---
</pre></div>
<p>The RH type 4 is consumed along the source route path to SRN3 as a 
deprecated <a class='info' href='#RFC2460'>[RFC2460]<span> (</span><span class='info'>Deering, S. and R. Hinden, &ldquo;Internet Protocol, Version 6 (IPv6) Specification,&rdquo; December&nbsp;1998.</span><span>)</span></a> RH type 0 would, and the last hop 
(SRN3 SRA to SRN3 TA) is consumed internally in SRN3, if it was present
in the first place, like a RH type 2 would be in the case of  
<a class='info' href='#RFC3775'>Mobile IPv6<span> (</span><span class='info'>Johnson, D., Perkins, C., and J. Arkko, &ldquo;Mobility Support in IPv6,&rdquo; June&nbsp;2004.</span><span>)</span></a> [RFC3775].

</p>
<a name="sec_example_rec"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Recording a forward path</h3>

<p>In this example, a Forward Record RH is filled as the protocol information 
is propagated along the same upwards path.
</p>
<p>
The FRRH is initially empty. The source SRN3 might virtually start from SRN3-TA in
which case that address is added to the FRRH. Then, as any node along the path, 
SRN3 adds it SRA and passes the packet long.
</p>
<p>The IPv6 header in the packet has source SRN3's Address, SRN3_Add, and
destination SRN3's next hop Add, SRN2_Add, on the link between SRN2 and SRN3:

</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----+-------++-------+-------+-------+ +---
| SRC   | DST   |:    :|    | slot0 ||slotn-2|slotN-1| slotN | |
|SRN3   |SRN2   |: EXT:|FRRH| SRN3  ||       |       |       | | NH
|Add    |Add    |:    :|    | SRA   ||       |       |       | |
+-------+-------++ -- ++----+-------++-------+-------+-------+ +---

</pre></div><p>


</p>
<p>The second router on the path, SRN2, receives that the packet.
Again, it might wish to propagate protocol payload towards 
the border router that is the implicit termination of the propagation.
</p>
<p>The outer packet now has source SRN2 Add and destination SRN1 Add; the
FRRH from top to bottom is SRN3_SRA | SRN2_SRA | empty_slots :

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----+-------+-------++-------+-------+ +---
| SRC   | DST   |:    :|    | slot0 | slot1 ||slotN-1| slotN | |
|SRN2   |SRN1   |: EXT:|FRRH| SRN3  | SRN2  ||       |       | | NH
|Add    |Add    |:    :|    | SRA   | SRA   ||       |       | |
+-------+-------++ -- ++----+-------+-------++-------+-------+ +---

</pre></div>
<p>
It must be noted that SRN2-SRA is preferably an address on the SRN2 ingress interface from SRN3, 
that is directly visible from SRN3, in case there is no routing between SRN3 and SRN.
</p>
<p>In general the process followed by the second router is repeated by
all the routers on the path, till the border router that receives:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----+-------+-------+-------++-------+ +---
| SRC   | DST   |:    :|    | slot0 | slot1 | slot2 || slotN | |
|SRN1   |BR     |: EXT:|FRRH| SRN3  | SRN2  | SRN1  ||       | | NH
|Add    |Add    |:    :|    | SRA   | SRA   | SRA   ||       | |
+-------+-------++ -- ++----+-------+-------+-------++-------+ +---

</pre></div>
<p>The BR also adds its own information for the internal hop to BR_TA:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+-------+-------++ -- ++----+-------+-------+-------+-------++ +---
| SRC   | DST   |:    :|    | slot0 | slot1 | slot2 | slot3 || |
|SRN1   |BR     |: EXT:|FRRH| SRN3  | SRN2  | SRN1  | BR    || | NH
|Add    |Add    |:    :|    | SRA   | SRA   | SRA   | SRA   || |
+-------+-------++ -- ++----+-------+-------+-------+-------++ +---

</pre></div>
<p>At this point, the BR possesses a source route path that is usable from any address
along that path back to the BR. It may trivially transform the FRRH into a completed RRH
and pass it back to SRN3. SRN3 may then transform the RRH into a RH type 4
and send further packets along the same path.
</p>
<a name="sec_rh_types"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
New Routing Headers</h3>

<p>This draft introduces new loose source and record Constrained Route Headers
for IPv6. The headers have the same format decribed below and only differ
from the Routing type.
</p>
<a name="sec_rh_type_2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
FRRH and RRH formats</h3>

<p>The FRRH and the RRH share the same overall format as the RH4
as defined in <a class='info' href='#I-D.ietf-6man-rpl-routing-header'>[I&#8209;D.ietf&#8209;6man&#8209;rpl&#8209;routing&#8209;header]<span> (</span><span class='info'>Hui, J., Vasseur, J., Culler, D., and V. Manral, &ldquo;An IPv6 Routing Header for Source Routes with RPL,&rdquo; October&nbsp;2010.</span><span>)</span></a>, 
with the same contraints:

</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  Next Header  |  Hdr Ext Len  | Routing Type  | Segments Left |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | CmprI | CmprE |  Pad  |              Reserved                 |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 .                                                               .
 .                        Addresses[1..n]                        .
 .                                                               .
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><p>


</p>
<blockquote class="text"><dl>
<dt>Next Header</dt>
<dd>
    <br />

    8-bit selector.  Identifies the type of header immediately
    following the Routing header.  Uses the same values as the IPv4
    Protocol field <a class='info' href='#RFC3232'>[RFC3232]<span> (</span><span class='info'>Reynolds, J., &ldquo;Assigned Numbers: RFC 1700 is Replaced by an On-line Database,&rdquo; January&nbsp;2002.</span><span>)</span></a>.
</dd>
<dt>Hdr Ext Len</dt>
<dd>
    <br />

                       8-bit unsigned integer.  Length of the Routing
                       header in 8-octet units, not including the first
                       8 octets.  Hdr Ext Len MUST NOT exceed
                       RH4_MAX_SIZE / 8.  Note that when Addresses[1..n]
                       are compressed (i.e. value of CmprI or CmprE is
                       not 0), Hdr Ext Len does not equal twice the
                       number of Addresses.
</dd>
<dt>Routing Type</dt>
<dd>
    <br />

    8-bit unsigned integer. Set (tentatively) to 3 for FRRH and 5 for RRH.
</dd>
<dt>Segments Left</dt>
<dd>
    <br />

    8-bit unsigned integer.  Number of route segments remaining.
</dd>
<dt>CmprI </dt>
<dd>
    <br />

               4-bit unsigned integer.  Number of prefix octets
                       from each segment, except than the last segment,
                       that are elided.  For example, a (F)RRH
                       header carrying full IPv6 addresses in
                       Addresses[1..n-1] sets CmprI to 0.
</dd>
<dt>CmprE</dt>
<dd>
    <br />

           4-bit unsigned integer.  Number of prefix octets
                       from the segment that are elided.  For example, 
                       (F)RRH carrying a full IPv6
                       address in Addresses[n] sets CmprE to 0.
</dd>
<dt>Pad</dt>
<dd>
    <br />

                  4-bit unsigned integer.  Number of octets that
                       are used to for padding after Address[n] and the
                       end of the (F)RRH. 
</dd>
<dt>Reserved</dt>
<dd>
    <br />

    32-bit reserved field.  Initialized to zero for transmission;
    ignored on reception.
</dd>
<dt>Address slot []</dt>
<dd>
    <br />

    Vector of 128-bit addresses, numbered 0 to N in LRRH and N to 0 in RRH.
</dd>
</dl></blockquote>
<a name="sec_icmp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Optimum number of slots</h3>

<p>A SRN always initializes the number
of slots in the F/RRH to the maximum of DEF_RRH_SLOTS and its estimation of its depth,
if the latter is known from a reliable hint such as a routing protocol.
The message may have a number of unused (NULL) slots,
when it is received by the Border Router.
The receiver end point crops out the extra entries in order to generates a RH.

</p>
<blockquote class="text">
<p> 
From a RRH, the receiver generates a RH type 4 that it can use for 
a response back.
</p>
<p> 
From a FRRH, the receiver generates a RRH that is
fully consumed, and send that back to the sender which in turn will generate
a RH type 4. None of those operations need to change the order of the 
slots in the header and are mostly plain copies.

</p>
</blockquote>
<p>
The RH type 4 contains the number of
required slots that the SRN now uses until it gets a hint that the
topology changes or until the next route recording.


</p>
<p>When a node adds its address either to an FRRH or an RRH, it MUST ensure
that it owns none of the addresses that are already present in the packet.
If it does, then the packet is following a loop. The node drop the packet, 
or alternatively it may strip the loop from the RH and keep forwarding via
an alternate next hop. In that case, it will decrement the Hop limit as usual,
to ensure that a loop is ultimately terminated.

</p>
<p>The number of slots in the RRH MUST NOT be larger than
MAX_RRH_SLOTS. If a SRN is deeper than MAX_RRH_SLOTS, it is
expected that the rest of the way is already known ot the endpoint.

</p>
<p>In runtime, it may happen that the RRH has fewer slots than
required for the number of SRNs in the path
because either the NBMA Subnetwork topology is changing too
quickly,
or the SRN that inserted the RRH had a wrong representation of the
topology.
</p>
<p>To solve this problem a new ICMP message is introduced, "RRH
Warning", type (proposed) 64. A SRN on the upwards path that gets a packet
without a free slot in the F/RRH MAY send that ICMP "RRH warning"
back to the SRN that inserted the RRH in the first place.
</p>
<p>This message allows a SRN on the path to propose a larger number of
slots to the SRN that creates the RRH. The Proposed Size
MUST NOT be larger than MAX_RRH_SLOTS.
The originating SRN must rate-limit the ICMP messages to avoid
excessive ICMP traffic in the case of the source failing to operate as
requested.
</p>
<p>The originating SRN must insert an RH type 4 based on the F/RRH in the
associated IP header, in order to route the ICMP message back to the
source of the reverse tunnel. A SRN that receives this ICMP message is
the actual destination and it MUST NOT forward it to the source
of the packet if the tunnel mode is being used.
</p>
<p>The "RRH Warning" ICMP has the following format:
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Type = 64   |    Code       |           Checksum            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Current Size  | Proposed Size |          Reserved             |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                    As much of invoking packet headers         |
 +               as will fit without the ICMPv6 packet           +
 |               exceeding the minimum IPv6 MTU                  |
 .                                                               .
 .                                                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><p>


</p>
<p>
</p>
<blockquote class="text"><dl>
<dt>Type</dt>
<dd>
    <br />

    64 [To Be Assigned]
</dd>
<dt>Code</dt>
<dd> 1: RRH too small; 2: Loop detected.
    <br />

    The originating SRN requires the source to set the RRH size to a
    larger value. The packet that triggered the ICMP will still be
    forwarded by the SRN, but the path cannot be totally optimized (see
    <a class='info' href='#sec_rrh_full'>Section&nbsp;5.3<span> (</span><span class='info'>Processing of RRH Packets</span><span>)</span></a>).
</dd>
<dt>Checksum</dt>
<dd>
    <br />

    The ICMP checksum <a class='info' href='#RFC2463'>[RFC2463]<span> (</span><span class='info'>Conta, A. and S. Deering, &ldquo;Internet Control Message Protocol (ICMPv6) for the Internet Protocol Version 6 (IPv6) Specification,&rdquo; December&nbsp;1998.</span><span>)</span></a>.
</dd>
<dt>Current Size</dt>
<dd>
    <br />

    RRH size of the invoking packet, as a reference.
</dd>
<dt>Proposed Size</dt>
<dd>
    <br />

    The new value, expressed as a number of IPv6 addresses that can fit
    in the RRH.
</dd>
<dt>Reserved</dt>
<dd>
    <br />

    16-bit reserved field.  Initialized to zero for transmission;
    ignored on reception.
</dd>
</dl></blockquote><p>

</p>
<a name="sec_SRN_operation"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Source Routing Node Operation</h3>

<p>
</p>
<a name="sec_rh_icmp_64_processing"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Processing of ICMP "RRH Warning"</h3>

<p>The New ICMP message "RRH Warning" is presented in <a class='info' href='#sec_icmp'>Section&nbsp;4.2<span> (</span><span class='info'>Optimum number of slots</span><span>)</span></a>. This message is addressed to the SRN which
performs the tunnel encapsulation and generates the RRH.
</p>
<p>Hence, a SRN that receives the ICMP "RRH Warning" MUST NOT
propagate it to the originating SRN or inner tunnel source, but MUST
process it for itself.
</p>
<p>If the Current Size in the ICMP messages matches the actual current
number of slots in RRH, and if the ICMP passes some safety checks as
described in <a class='info' href='#sec_icmp'>Section&nbsp;4.2<span> (</span><span class='info'>Optimum number of slots</span><span>)</span></a>, then the SRN MAY adapt the number of
slots to the Proposed Size.
</p>
<a name="sec_rh_icmp_processing"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Processing of ICMP error</h3>

<p>
When the SRN receives an ICMP error message, it checks whether it is
the final destination of the packet by looking at the included
packet. If the included packet has an RRH, then the SRN should 
transform it in a RH type 4 to forward the ICMP to the original source 
of the packet. If the included packet has an FRRH, then the SRN may
reverse it into a RH type 4 to forward the ICMP to the original source 
of the packet. 

</p>
<a name="sec_rrh_full"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Processing of RRH Packets</h3>

<p>A router that receives a RRH is a link scoped protocol packet may save
that RRH and associate it with the propagation of the protocol information.
the router performs ULP checksum validation and security header checks 
including the RRH as received

</p>
<p>

When the router sends the propagated protocol information over an interface,
the router adds one of its addresses from that interface at the head of the 
RRH, and then computes upper layer checksums and IPSec/AH signatures as 
required. 

</p>
<p>It is preferred that the address as a scope that is as large
as the Source Route Domain, in order to enable a loose operation.
In particular, if the router has consistent states to
route to the seconds most recent entry via the source address of the
packet, then it can overwrite the most recent entry with its own.

</p>
<p>
The node at the end of the propagation and any node on the way may 
decide to keep a source route state towards the address located in slot 0
using a source route path that is directly inferred from the RRH.

</p>
<a name="sec_frrh_full"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
Processing of FRRH Packets</h3>

<p>A router that receives a FRRH is a link scoped protocol packet may save
that RRH and associate it with the propagation of the protocol information.
the router performs ULP checksum validation and security header checks 
including the FRRH as received. 

</p>
<p>
Then the router adds an address from the ingress interface at the end of the
FRRH, which is now ready to be associated to the propagation of the
protocol.
When the router sends the propagated protocol information over an interface,
it adds the FRRH as and computes upper layer checksums and IPSec/AH signatures as 
required. 

</p>
<p>
The node at the end of the propagation and any node on the way may 
decide to reverse the FRRH into a RRH and send it back to the source
located in slot 0 for the FRRH, 
which in turn can reverse it again, this time into a RH type 4.

</p>
<a name="sec_security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>The FRRH and the RRH are propagated as part of a higher hop-by-hop protocol operation,
so it is not mutable. Each hop adds its info, then computes the checksum and IPSec headers and
then it transmits with a link scope to the next node(s) on the way of the upper layer 
protocol operation.
</p>
<p>This section is not complete; further work is needed to analyze
and solve the security problems of record and source route.
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA considerations</h3>

<p>This document requires IANA to define 2 new IPv6 Routing Header types
   for Forward Record Routing Header and Reverse Routing Header.
   The allocation is governed by 
   <a class='info' href='#I-D.ietf-6man-iana-routing-header'>[I&#8209;D.ietf&#8209;6man&#8209;iana&#8209;routing&#8209;header]<span> (</span><span class='info'>Arkko, J. and S. Bradner, &ldquo;IANA Allocation Guidelines for the IPv6 Routing Header,&rdquo; October&nbsp;2009.</span><span>)</span></a>
   The desired values would be 3 for FRRH and 5 for RRH.
</p>
<p>This document also requires the allocation of a new ICMP error type "RRH
	Warning" with a proposed value of 64. 
</p>
<a name="sec_const"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Protocol Constants</h3>

<p>
</p>
<blockquote class="text"><dl>
<dt></dt>
<dd> DEF_RRH_SLOTS:           7
</dd>
<dt></dt>
<dd> MAX_RRH_SLOTS:           10
</dd>
</dl></blockquote><p>

</p>
<a name="sec_acknowledgements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Acknowledgements</h3>

<p> The author wishes to thank Mukul Goyal and Emmanuel Baccelli for their
contributions and reviews. Also Jonathan Hui, JP Vasseur, Dave Culler and
Vishwas Manral for their work on RH 4 from which this works inherits.

</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.1.&nbsp;informative reference</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-6man-iana-routing-header">[I-D.ietf-6man-iana-routing-header]</a></td>
<td class="author-text">Arkko, J. and S. Bradner, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-6man-iana-routing-header-00.txt">IANA Allocation Guidelines for the IPv6 Routing Header</a>,&rdquo; draft-ietf-6man-iana-routing-header-00 (work in progress), October&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-6man-iana-routing-header-00.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-6man-rpl-routing-header">[I-D.ietf-6man-rpl-routing-header]</a></td>
<td class="author-text">Hui, J., Vasseur, J., Culler, D., and V. Manral, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-6man-rpl-routing-header-01.txt">An IPv6 Routing Header for Source Routes with RPL</a>,&rdquo; draft-ietf-6man-rpl-routing-header-01 (work in progress), October&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-6man-rpl-routing-header-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-roll-p2p-rpl">[I-D.ietf-roll-p2p-rpl]</a></td>
<td class="author-text">Goyal, M. and E. Baccelli, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-roll-p2p-rpl-01.txt">Reactive Discovery of Point-to-Point Routes in Low Power and Lossy Networks</a>,&rdquo; draft-ietf-roll-p2p-rpl-01 (work in progress), October&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-roll-p2p-rpl-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-roll-rpl">[I-D.ietf-roll-rpl]</a></td>
<td class="author-text">Winter, T., Thubert, P., Brandt, A., Clausen, T., Hui, J., Kelsey, R., Levis, P., Pister, K., Struik, R., and J. Vasseur, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-roll-rpl-16.txt">RPL: IPv6 Routing Protocol for Low power and Lossy Networks</a>,&rdquo; draft-ietf-roll-rpl-16 (work in progress), December&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-roll-rpl-16.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-roll-terminology">[I-D.ietf-roll-terminology]</a></td>
<td class="author-text">Vasseur, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-roll-terminology-04.txt">Terminology in Low power And Lossy Networks</a>,&rdquo; draft-ietf-roll-terminology-04 (work in progress), September&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-roll-terminology-04.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.2.&nbsp;normative reference</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC0791">[RFC0791]</a></td>
<td class="author-text">Postel, J., &ldquo;<a href="http://tools.ietf.org/html/rfc791">Internet Protocol</a>,&rdquo; STD&nbsp;5, RFC&nbsp;791, September&nbsp;1981 (<a href="http://www.rfc-editor.org/rfc/rfc791.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2401">[RFC2401]</a></td>
<td class="author-text"><a href="mailto:kent@bbn.com">Kent, S.</a> and <a href="mailto:rja@corp.home.net">R. Atkinson</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2401">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;2401, November&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2401.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2401.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2401.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2402">[RFC2402]</a></td>
<td class="author-text"><a href="mailto:kent@bbn.com">Kent, S.</a> and <a href="mailto:rja@corp.home.net">R. Atkinson</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2402">IP Authentication Header</a>,&rdquo; RFC&nbsp;2402, November&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2402.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2402.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2402.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2406">[RFC2406]</a></td>
<td class="author-text"><a href="mailto:kent@bbn.com">Kent, S.</a> and <a href="mailto:rja@corp.home.net">R. Atkinson</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2406">IP Encapsulating Security Payload (ESP)</a>,&rdquo; RFC&nbsp;2406, November&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2406.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2406.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2406.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2460">[RFC2460]</a></td>
<td class="author-text"><a href="mailto:deering@cisco.com">Deering, S.</a> and <a href="mailto:hinden@iprg.nokia.com">R. Hinden</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2460">Internet Protocol, Version 6 (IPv6) Specification</a>,&rdquo; RFC&nbsp;2460, December&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2460.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2460.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2460.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2463">[RFC2463]</a></td>
<td class="author-text"><a href="mailto:aconta@lucent.com">Conta, A.</a> and <a href="mailto:deering@cisco.com">S. Deering</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2463">Internet Control Message Protocol (ICMPv6) for the Internet Protocol Version 6 (IPv6) Specification</a>,&rdquo; RFC&nbsp;2463, December&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2463.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2463.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2463.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3232">[RFC3232]</a></td>
<td class="author-text">Reynolds, J., &ldquo;<a href="http://tools.ietf.org/html/rfc3232">Assigned Numbers: RFC 1700 is Replaced by an On-line Database</a>,&rdquo; RFC&nbsp;3232, January&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3232.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3775">[RFC3775]</a></td>
<td class="author-text">Johnson, D., Perkins, C., and J. Arkko, &ldquo;<a href="http://tools.ietf.org/html/rfc3775">Mobility Support in IPv6</a>,&rdquo; RFC&nbsp;3775, June&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3775.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3971">[RFC3971]</a></td>
<td class="author-text">Arkko, J., Kempf, J., Zill, B., and P. Nikander, &ldquo;<a href="http://tools.ietf.org/html/rfc3971">SEcure Neighbor Discovery (SEND)</a>,&rdquo; RFC&nbsp;3971, March&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc3971.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Pascal Thubert (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">ViAddge d'Entreprises Green Side</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">400, Avenue de Roumanille</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Batiment T3</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Biot - Sophia Antipolis  06410</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FRANCE</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+33 497 23 26 34</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:pthubert@cisco.com">pthubert@cisco.com</a></td></tr>
</table>
</body></html>
