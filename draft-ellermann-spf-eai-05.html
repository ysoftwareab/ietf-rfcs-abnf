<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Sender Policy Framework: Email Address Internationalization </title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Imported terms">
<link href="#rfc.section.2" rel="Chapter" title="2 Background">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 SPF HELO identity">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 EAI MAIL FROM identity">
<link href="#rfc.section.2.3" rel="Chapter" title="2.3 Local parts">
<link href="#rfc.section.3" rel="Chapter" title="3 Details">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Considerations for SPF publishers">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Received-SPF">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Internationalization of explanations">
<link href="#rfc.section.4" rel="Chapter" title="4 Acknowledgements">
<link href="#rfc.section.5" rel="Chapter" title="5 Security Considerations">
<link href="#rfc.section.6" rel="Chapter" title="6 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="7 References">
<link href="#rfc.references.1" rel="Chapter" title="7.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="7.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Document History">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="UTF8SMTP is an extension of SMTP (Simple Mail Transfer Protocol) allowing the use of UTF-8 in the SMTP envelope for EAI (Email Address Internationalization) and message headers. This memo discusses the consequences for SPF (Sender Policy Framework).  " />
  <meta name="description" content="UTF8SMTP is an extension of SMTP (Simple Mail Transfer Protocol) allowing the use of UTF-8 in the SMTP envelope for EAI (Email Address Internationalization) and message headers. This memo discusses the consequences for SPF (Sender Policy Framework).  " />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">F. Ellermann</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">xyzzy</td>
</tr>
<tr>
<td class="left">Intended status: Experimental Protocol</td>
<td class="right">October 31, 2011</td>
</tr>
<tr>
<td class="left">Expires: May 03, 2012</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Sender Policy Framework: Email Address Internationalization <br />
  <span class="filename">draft-ellermann-spf-eai-05</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>UTF8SMTP is an extension of SMTP (Simple Mail Transfer Protocol) allowing the use of UTF-8 in the SMTP envelope for EAI (Email Address Internationalization) and message headers. This memo discusses the consequences for SPF (Sender Policy Framework).  </p>
<h1><a>Editorial note</a></h1>
<p>This note, the <a href="#iana">IANA considerations</a> <cite title="NONE">[iana]</cite>, and the <a href="#history">document history</a> <cite title="NONE">[history]</cite> should be removed before publication. For some imported terms in <a href="#terms">Section 1.1</a> the sources have to be fixed when the RFCs got their numbers. The draft can be discussed on the SPF-Discuss mailing list.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on May 03, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>
<p>This document may contain material from IETF Documents or IETF Contributions published or made publicly available before November 10, 2008.  The person(s) controlling the copyright in some of this material may not have granted the IETF Trust the right to allow modifications of such material outside the IETF Standards Process. Without obtaining an adequate license from the person(s) controlling the copyright in such materials, this document may not be modified outside the IETF Standards Process, and derivative works of it may not be created outside the IETF Standards Process, except to format it for publication as an RFC or to translate it into languages other than English.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Imported terms</a>
</li>
<li>2.   <a href="#rfc.section.2">Background</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">SPF HELO identity</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">EAI MAIL FROM identity</a>
</li>
<li>2.3.   <a href="#rfc.section.2.3">Local parts</a>
</li>
<li>3.   <a href="#rfc.section.3">Details</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Considerations for SPF publishers</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Received-SPF</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Internationalization of explanations</a>
</li>
<li>4.   <a href="#rfc.section.4">Acknowledgements</a>
</li>
<li>5.   <a href="#rfc.section.5">Security Considerations</a>
</li>
<li>6.   <a href="#rfc.section.6">IANA Considerations</a>
</li>
<li>7.   <a href="#rfc.references">References</a>
</li>
<li>7.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>7.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Document History</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">Readers should be familiar with SMTP as specified in <a href="#RFC5321">[RFC5321]</a> and the SPF terminology in <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a>.  </p>
<p id="rfc.section.1.p.2">The keywords "MUST NOT" and "SHOULD" in this memo are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.  </p>
<p id="rfc.section.1.p.3">For an EAI (Email Address Internationalization) overview see <a href="#RFC4952">[RFC4952]</a>. UTF-8 is specified in <a href="#RFC3629">[RFC3629]</a>.  An MTA is a Mail Transfer Agent, e.g., an SMTP relay.  </p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#terms" id="terms">Imported terms</a>
</h1>
<p id="rfc.section.1.1.p.1">Some <a href="#RFC5234">[RFC5234]</a> ABNF terms used in this memo are specified in other sources: </p>
<div id="#rfc.figure.1"></div>
<pre>
        &lt;domain-spec&gt;    = &lt;see 4408bis section 8.1&gt;
        &lt;target-name&gt;    = &lt;see 4408bis section 4.8&gt;
        &lt;explanation&gt;    = &lt;see 4408bis section 6.2&gt;
        &lt;textstring&gt;     = &lt;see RFC5321 section 4.2&gt;
        &lt;Dot-string&gt;     = &lt;see RFC5321 section 4.1.2&gt;
        &lt;Quoted-string&gt;  = &lt;see RFC5321 section 4.1.2&gt;
        &lt;Atom&gt;           = &lt;see RFC5321 section 4.1.2&gt;
        &lt;atext&gt;          = &lt;see RFC5322 section 3.2.3&gt;
        &lt;UTF8-non-ascii&gt; = &lt;see RFC5336 section 2.3&gt;
        &lt;uMailbox&gt;       = &lt;see RFC5336 section 2.3&gt;
</pre>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Background</h1>
<p id="rfc.section.2.p.1">SMTP as specified in <a href="#RFC5321">[RFC5321]</a> supports only ASCII addresses and LDH (letter, digit, hyphen) domain labels. The letters are ASCII letters; certain LDH-labels are also known as A-labels in the context of IDN (Internationalization of Domain Names) and <a href="#RFC5890">[RFC5890]</a>.  </p>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> SPF HELO identity</h1>
<p id="rfc.section.2.1.p.1">In SMTP sessions after an SMTP EHLO command from the client the server response can indicate supported SMTP extensions.  <a href="#RFC5336">[RFC5336]</a> specifies the UTF8SMTP extension.  </p>
<p id="rfc.section.2.1.p.2">The SMTP client can accept an offered UTF8SMTP extension by using one of the specified features, notably by the use of UTF-8 in mailbox addresses of SMTP commands, by the use of alternative ASCII addresses in these commands, or by the use of UTF-8 in the message header for addresses and other purposes, i.e. by sending a "message/global" instead of a "message/rfc822" as specified in <a href="#RFC5335">[RFC5335]</a>.  </p>
<p id="rfc.section.2.1.p.3">Because UTF8SMTP support is indicated in the response to an EHLO command it cannot be used after HELO, and the SPF HELO identity is not affected by EAI:  The domain in a HELO or EHLO command consists of ordinary LDH-labels, or it is a domain literal.  For an empty reverse path, as it is used in non-delivery reports and other auto-replies, SPF fabricates a MAIL FROM identity based on the HELO identity with a case insensitive local part "postmaster"; this scenario is also not affected by EAI.  </p>
<p id="rfc.section.2.1.p.4">A domain consisting of LDH-labels including IDN A-labels beginning with "xn--" is an ordinary LDH-domain as far as DNS (Domain Name System), SPF, and UTF8SMTP are concerned.  Apart from HELO and EHLO the only relevant SMTP command for SPF is the MAIL FROM command with the reverse path containing the envelope sender address (if it is not empty, see above).  When the derived MAIL FROM identity is an ordinary address SPF can handle it as specified in <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a>.  </p>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> EAI MAIL FROM identity</h1>
<p id="rfc.section.2.2.p.1">The interesting UTF8SMTP cases for SPF contain non-ASCII UTF-8 characters in the local part (left hand side) or the domain part (right hand side) of the MAIL FROM identity.  Domain labels containing non-ASCII UTF-8 characters are also known as U-labels in IDN.  </p>
<p id="rfc.section.2.2.p.2">SPF checks typically make only sense at the "border MTA", and this is normally an MX (Mail eXchanger) of the receiver talking with a sender.  An MTA wishing to check the SPF sender policy against the IP of the sender fetches the sender policy for the domain in the HELO or MAIL FROM identity as DNS client of a server for the alleged sender. The SPF terminology might be confusing:  The border MTA is the SMTP server, but for the purpose of checking a sender policy it is the SPF (or rather DNS) client of a name server for the alleged sender with a given HELO or MAIL FROM identity.  </p>
<p id="rfc.section.2.2.p.3">An MTA could "downgrade" EAI MAIL FROM addresses using an optional alternative address given as UTF8SMTP MAIL-parameter.  Where that happens the resulting new MAIL FROM address is an ordinary <a href="#RFC5321">[RFC5321]</a> reverse path and can be handled as usual.  </p>
<p id="rfc.section.2.2.p.4">Skipping all ordinary cases as noted above the SPF client confronted with an EAI address in the MAIL FROM identity is generally an MTA supporting UTF8SMTP, and supposed to know how to transform U-labels into corresponding A-labels, e.g., because it might need to send a non-delivey report to the envelope sender address later; see <a href="#RFC5337">[RFC5337]</a>.  </p>
<p id="rfc.section.2.2.p.5">For agents trying post-SMTP SPF-checks this might be not the case, and unsurprisingly attempts to fetch the sender policy of a domain with U-labels "as is" will fail with SPF result NONE.  Arguably this is a broken setup, the border MTA should not offer and accept UTF8SMTP mails if critical parts behind it - not limited to the mailbox of the receiver - don't support EAI.  </p>
<h1 id="rfc.section.2.3">
<a href="#rfc.section.2.3">2.3.</a> <a href="#havoc" id="havoc">Local parts</a>
</h1>
<p id="rfc.section.2.3.p.1">Top down at this point the remaining SPF clients are supposed to know how to transform U-labels into A-labels, and fetch the SPF policy of the alleged sender.  SPF implementors and publishers of SPF sender policies should note that only the domain part of the MAIL FROM identity is transformed from U-labels into A-labels.  The local part MUST NOT be transformed, it is used "as is" in the construction of a &lt;target&#8209;name&gt; by SPF macro expansion involving local part macros.  </p>
<p id="rfc.section.2.3.p.2">SPF allows all octets in labels of a &lt;target&#8209;name&gt; excluding dots, which are supposed to separate labels.  Sender policies can directly talk about any &lt;domain&#8209;spec&gt; with labels separated by dots, where each label consists of 1 to 63 visible ASCII characters except "%" introducing macros.  The macros "%%" and "%_" in a &lt;domain&#8209;spec&gt; expand into "%" or space in the &lt;target&#8209;name&gt;, respectively.  </p>
<p id="rfc.section.2.3.p.3">Normally sender policies do not use such slightly odd labels, and the most extravagant case is "_" (underscore) in a label that is intentionally no LDH-label.  Nevertheless implementations have to support such oddities, because they are needed in the case of a &lt;target&#8209;name&gt; derived from a &lt;domain&#8209;spec&gt; using the local part macro.  </p>
<p id="rfc.section.2.3.p.4">SMTP local parts can have two forms, &lt;Dot&#8209;string&gt; or &lt;Quoted&#8209;string&gt;.  A &lt;Dot&#8209;string&gt; consists of dot separated &lt;Atom&gt;s, each &lt;Atom&gt; consists of one or more &lt;atext&gt; characters.  Please note that an &lt;Atom&gt; is not the same as an LDH-label, it is also not the same as a domain label, e.g., &lt;Atom&gt;s can be longer than 63 octets.  </p>
<p id="rfc.section.2.3.p.5">By definition there are no leading, trailing, or adjacent dots in a &lt;Dot&#8209;string&gt;. <a href="#RFC5321">[RFC5321]</a> and its predecessor recommend to avoid the &lt;Quoted&#8209;string&gt; form of a local part.  Current SPF implementations are known to strip the quotes from a &lt;Quoted&#8209;string&gt; for the purpose of determining a &lt;target&#8209;name&gt; derived from a &lt;domain&#8209;spec&gt; using the local part macro. This can result in an invalid &lt;target&#8209;name&gt; with leading, trailing, or adjacent dots, e.g., for a mail address "do..ts"@example.org.  </p>
<p id="rfc.section.2.3.p.6">Publishers of sender policies using the local part macro SHOULD make sure that the used pieces of valid local parts in their domain can be parsed into non-empty domain labels; one way to achieve this is to avoid &lt;Quoted&#8209;string&gt;.  The effect of a &lt;Quoted&#8209;string&gt; local part is not clearly specified in <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a>.  In theory DNS supports any octet, even "embedded" dots within a label.  In practice current SPF implementations cannot handle embedded dots, and it is far from clear that quoted pairs introduced by a "\" (backslash) in a &lt;Quoted&#8209;string&gt; are interpreted as specified in <a href="#RFC5321">[RFC5321]</a> section 4.1.2.  </p>
<p id="rfc.section.2.3.p.7">Publishers of sender policies using the local part macro SHOULD make sure that the used pieces of valid local parts in their domain result in 1 to 63 octets per dot separated domain label as mentioned in <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a> section 8.1.  Please note that the truncation of longer labels after macro expansion is not clearly specified:  SPF implementations could truncate longer labels left to right or right to left, they could also ignore affected directives, or treat this case as error.  </p>
<p id="rfc.section.2.3.p.8">Publishers of sender policies using the local part macro need to be aware that ASCII letters in the used pieces of valid local parts in their domain are in essence treated as case-insensitive by DNS as explained in <a href="#RFC4343">[RFC4343]</a>.  </p>
<p id="rfc.section.2.3.p.9">UTF8SMTP extends &lt;atext&gt; by &lt;UTF8-non-ascii&gt;, and it also permits &lt;UTF8-non-ascii&gt; in quoted strings.  As far as SPF is concerned &lt;UTF8-non-ascii&gt; can result in non-ASCII octets in a &lt;target&#8209;name&gt;, working "as is" in DNS labels with similar caveats as noted above with respect to the length of labels, case sensitivity, and normalization.  </p>
<p><a href="#RFC5335">[RFC5335]</a> suggests to restrict the use of UTF-8 in EAI addresses to Normalization Form C (NFC) as recommended in <a href="#RFC5198">[RFC5198]</a>.  Publishers of sender policies using the local part macro need to be aware that SPF implementations treat local parts "as is".  Mapping different forms of an EAI local part to one mailbox at their border MTAs has no effect on different forms of EAI local parts in DNS queries.  A straight forward strategy to avoid potential issues with respect to SPF is to use local part macros only in non-critical explanations and maybe for logging, if at all.  </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Details</h1>
<p id="rfc.section.3.p.1">For historical reasons technical SPF <a href="#Errata">[Errata]</a> have been "outsourced".  SPF implementors are hopefully also interested in the SPF test suite on the same site.  </p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#spf" id="spf">Considerations for SPF publishers</a>
</h1>
<p id="rfc.section.3.1.p.1">Policy publishers should know that this memo does not update <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a>, in theory EAI is compatible with SPF.  It is not possible to use U-labels in sender policies directly, they have to be transformed into the corresponding A-labels.  Likewise U-labels in UTF8SMTP MAIL FROM addresses are transformed into A-labels for the purposes of SPF by implementations supporting EAI.  </p>
<p id="rfc.section.3.1.p.2">SPF implementations not supporting U-labels in MAIL FROM identities will return NONE instead of the intended result, e.g., PASS or FAIL.  UTF8SMTP senders wishing to avoid this problem could transform MAIL FROM U-labels into A-labels on their side.  They could also hope that spammers forging MAIL FROM identities will not abuse IDN U-labels in the near future, and that most SPF implementations will be updated before this changes.  Unfortunately experience has shown that spammers learn faster than lazy users.  </p>
<p id="rfc.section.3.1.p.3">MAIL FROM identities using only A-labels, with or without UTF-8 in the local part, work "as is" for the purposes of SPF.  HELO identities consist either of A-labels, are domain literals and irrelevant for SPF, or are syntactically malformed as far as UTF8SMTP and SPF are concerned.  SPF does not specify how receivers should handle SMTP syntax errors.  </p>
<p id="rfc.section.3.1.p.4">UTF8SMTP allows to specify an optional alternative address in the traditional syntax.  Receivers are free to check SPF also or only based on the alternative address.  Obviously a sender policy for the alternative address should permit the same sending IPs as the sender policy for the EAI address, and one simple way to achieve this is to use corresponding A-labels in an alternative address yielding one SPF sender policy for both addresses.  Please note that this is not required by UTF8SMTP, it permits to use unrelated domains with different policies.  Clearly if some IPs permitted for one address fail for the other address, or vice versa, the sender will have problems, if the affected IPs are actually used to send mails.  </p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> Received-SPF</h1>
<p id="rfc.section.3.2.p.1">The Received-SPF header field specified in <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a> section 7 is a "message/rfc822" trace header field.  </p>
<p id="rfc.section.3.2.p.2">UTF8SMTP transports a "message/global" as specified in <a href="#RFC5335">[RFC5335]</a> permitting the use of UTF-8 in header fields.  For Received-SPF this is necessary to record an UTF8SMTP "envelope-from" &lt;uMailbox&gt; address.  </p>
<p id="rfc.section.3.2.p.3">UTF-8 might be also needed in comments and other parts of this header field in conjunction with UTF8SMTP.  See <a href="#RFC5335">[RFC5335]</a> for the corresponding syntax modifications.  </p>
<p id="rfc.section.3.2.p.4">SPF implementations could check the EAI MAIL FROM <strong>and</strong> an alternative address (if given).  In this case SPF implementations SHOULD record both results.  An exception could be to omit a "less interesting" (e.g., equivalent, NONE, or NEUTRAL) result.  Receivers could also adopt the strategy to check the second of two addresses only if the result of their first check is "not helpful" (e.g., NONE or NEUTRAL).  </p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#i18n" id="i18n">Internationalization of explanations</a>
</h1>
<p id="rfc.section.3.3.p.1">SMTP replies consist of a reply code and optionally a &lt;textstring&gt; as explanation. This is the vehicle used by SMTP servers if they reject a mail after an SPF FAIL, optionally adding an explanation given in the SPF policy as &lt;explanation&gt;.  </p>
<p id="rfc.section.3.3.p.2">The &lt;textstring&gt; is limited to ASCII and hopefully integrated in some way in any resulting non-delivery report (bounce) created by the SMTP client. UTF8SMTP does <strong>not</strong> modify this restriction to ASCII &lt;textstring&gt;s in contexts relevant for SPF.  </p>
<p id="rfc.section.3.3.p.3">The optional SPF &lt;explanation&gt; is in essence a pointer to a domain with a TXT record. The macro-expanded content of this TXT record can be used in the SMTP reply.  </p>
<p id="rfc.section.3.3.p.4">The resulting explanation can contain a URL of a Web page with internationalized explanations including data based on the sending IP, sender address, and other details given as SPF macros in the TXT record.  </p>
<p id="rfc.section.3.3.p.5">The upper-case forms of SPF macros trigger URL-encoding for this purpose. SPF macro expansion does not involve to parse textual explanations for potential URLs, it percent-encodes any "reserved" input character. For EAI these characters can be UTF-8 and have to be percent-encoded as specified in <a href="#RFC3987">[RFC3987]</a>. This boils down to "take octets as is, if not unreserved percent-encode".  </p>
<p id="rfc.section.3.3.p.6">The procedure outlined above clearly cannot guarantee to produce valid URLs in an explanation.  In fact any use of lower-case macros could result in non-ASCII explanations, and in that case the SMTP server cannot use the result in the &lt;textstring&gt;s of its reply after an SPF FAIL.  </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Acknowledgements</h1>
<p id="rfc.section.4.p.1">Various folks on the SPF discuss and devel mailing lists worked on the SPF <a href="#Errata">[Errata]</a> and test suite.  All obscure issues with local parts discussed in this memo are based on their prior work and indirectly related discussions on the EAI and SMTP mailing lists.  </p>
<p id="rfc.section.4.p.2">Thanks to Abel&#160;Yang, Alessandro&#160;Vesely, Boyd&#160;Lynn&#160;Gerber, Doug&#160;Otis, Harald&#160;T.&#160;Alvestrand, John&#160;C.&#160;Klensin, Julian&#160;Mehnle, Kari&#160;Hurtta, Kazunori&#160;Fujiwara, Scott&#160;Kitterman, Stuart&#160;D.&#160;Gathman, and Wayne&#160;Schlitt for their encouragement, feedback, or critique.  </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.5.p.1">When UTF8SMTP senders use a different domain in the optional alternative MAIL FROM address, and the corresponding sender policy is also different, it is hard to predict which policy will be checked, if any, depending on the route to the receiver and other factors.  Different results can be hard to diagnose, e.g., if a mail from the same sender to the same receiver sometimes results in PASS and at other times in FAIL.  One proposal to mitigate this problem is discussed in <a href="#spf">Section 3.1</a>.  </p>
<p id="rfc.section.5.p.2">Not all SPF implementations will already support U-labels as explained in this memo.  Senders could transform U-labels in MAIL FROM commands to A-labels on their side where this is a problem.  </p>
<p id="rfc.section.5.p.3">Using the SPF local part macro in conjunction with EAI is not intuitive, local parts are not transformed to A-labels.  This is not new, but in conjunction with EAI very likely. Various details with respect to label lengths, quoted strings, adjacent dots, and quoted pairs are explained in <a href="#havoc">Section 2.3</a>.  Not using &lt;Quoted&#8209;string&gt;s as local parts and not using case-sensitive local parts is recommended in <a href="#RFC5321">[RFC5321]</a> section 4.1.2; this also covers quoted pairs and adjacent dots.  </p>
<p id="rfc.section.5.p.4">A new UTF8SMTP problem is the use of local part macros for the construction of "per user" policies, when different variations of an UTF-8 local part correspond to one user mailbox. While the use of normalized UTF-8 strings is recommended in <a href="#RFC5335">[RFC5335]</a> section 4.1 this does not help with case-sensitive &lt;UTF8-non-ascii&gt; variations.  One way to address this problem is to avoid critical uses of the local part macro as discussed in <a href="#havoc">Section 2.3</a>.  </p>
<p id="rfc.section.5.p.5">UTF8SMTP servers can be forced to send non-delivery reports to forged envelope sender addresses, if some receiver mailboxes can handle EAI mails, while others can't, and the server has no way to "downgrade" mails to traditional receivers.  Hopefully a future SMTP extension will allow a kind of "selective reject" mechanism.  Publishing SPF PASS or FAIL policies, and rejecting FAIL at the border MTA, would eliminate this problem.  Similarly non-delivery reports after a PASS cannot hit innocent bystanders.  </p>
<p id="rfc.section.5.p.6">Evaluating PRA (Purported Responsible Address) policies as specified in <a href="#RFC4406">[RFC4406]</a> with SPF or vice versa can cause havoc, as the algorithms are semantically different even when the policies are otherwise syntactically identical.  This known problem is discussed in <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a>.  </p>
<p id="rfc.section.5.p.7">SPF local part macros in a &lt;domain-spec&gt; could be abused in an attack scenario to avoid DNS caching. Compare the SPF processing limits in <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a> section 10.1.  </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#iana" id="iana">IANA Considerations</a>
</h1>
<p id="rfc.section.6.p.1">Keep up the good work, nothing to do here.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">7.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">7.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3629">[RFC3629]</b></td>
<td class="top">
<a>Yergeau, F.</a>, "<a href="http://tools.ietf.org/html/rfc3629">UTF-8, a transformation format of ISO 10646</a>", STD 63, RFC 3629, November 2003.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3987">[RFC3987]</b></td>
<td class="top">
<a>Duerst, M.</a> and <a>M. Suignard</a>, "<a href="http://tools.ietf.org/html/rfc3987">Internationalized Resource Identifiers (IRIs)</a>", RFC 3987, January 2005.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</b></td>
<td class="top">
<a>Kitterman, D</a> and <a>W Schlitt</a>, "<a href="http://tools.ietf.org/html/draft-kitterman-4408bis-00">Sender Policy Framework (SPF) for Authorizing Use of Domains in E-Mail, Version 1</a>", Internet-Draft draft-kitterman-4408bis-00, October 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5321">[RFC5321]</b></td>
<td class="top">
<a>Klensin, J.</a>, "<a href="http://tools.ietf.org/html/rfc5321">Simple Mail Transfer Protocol</a>", RFC 5321, October 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5322">[RFC5322]</b></td>
<td class="top">
<a href="mailto:presnick@qualcomm.com" title="Qualcomm Incorporated">Resnick, P.</a>, "<a href="http://tools.ietf.org/html/rfc5322">Internet Message Format</a>", RFC 5322, October 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5335">[RFC5335]</b></td>
<td class="top">
<a>Abel, Y.</a>, "<a href="http://tools.ietf.org/html/rfc5335">Internationalized Email Headers</a>", RFC 5335, September 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5336">[RFC5336]</b></td>
<td class="top">
<a>Yao, J.</a> and <a>W. Mao</a>, "<a href="http://tools.ietf.org/html/rfc5336">SMTP Extension for Internationalized Email Addresses</a>", RFC 5336, September 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5890">[RFC5890]</b></td>
<td class="top">
<a>Klensin, J.</a>, "<a href="http://tools.ietf.org/html/rfc5890">Internationalized Domain Names for Applications (IDNA): Definitions and Document Framework</a>", RFC 5890, August 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">7.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC4343">[RFC4343]</b></td>
<td class="top">
<a>Eastlake, D.</a>, "<a href="http://tools.ietf.org/html/rfc4343">Domain Name System (DNS) Case Insensitivity Clarification</a>", RFC 4343, January 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4406">[RFC4406]</b></td>
<td class="top">
<a>Lyon, J.</a> and <a>M. Wong</a>, "<a href="http://tools.ietf.org/html/rfc4406">Sender ID: Authenticating E-Mail</a>", RFC 4406, April 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4952">[RFC4952]</b></td>
<td class="top">
<a>Klensin, J.</a> and <a>Y. Ko</a>, "<a href="http://tools.ietf.org/html/rfc4952">Overview and Framework for Internationalized Email</a>", RFC 4952, July 2007.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5198">[RFC5198]</b></td>
<td class="top">
<a>Klensin, J.</a> and <a>M. Padlipsky</a>, "<a href="http://tools.ietf.org/html/rfc5198">Unicode Format for Network Interchange</a>", RFC 5198, March 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5234">[RFC5234]</b></td>
<td class="top">
<a>Crocker, D.</a> and <a>P. Overell</a>, "<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>", STD 68, RFC 5234, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5337">[RFC5337]</b></td>
<td class="top">
<a>Newman, C.</a> and <a>A. Melnikov</a>, "<a href="http://tools.ietf.org/html/rfc5337">Internationalized Delivery Status and Disposition Notifications</a>", RFC 5337, September 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5451">[RFC5451]</b></td>
<td class="top">
<a>Kucherawy, M.</a>, "<a href="http://tools.ietf.org/html/rfc5451">Message Header Field for Indicating Message Authentication Status</a>", RFC 5451, April 2009.</td>
</tr>
<tr>
<td class="reference"><b id="Errata">[Errata]</b></td>
<td class="top">
<a>OpenSPF </a>, "<a>RFC 4408 errata</a>", 2008.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> <a href="#history" id="history">Document History</a>
</h1>
<p id="rfc.section.Appendix A.p.1">Changes in version 05: </p>
<p></p>

<ul>
<li>Update for UTF8SMTP while UTF8SMTPBIS is not yet approved.  Only the references and boilerplate texts were updated; otherwise the content is as it was in 2008.  </li>
<li>The IESG put the "outsourced" <a href="#Errata">[Errata]</a> on hold for an SPF document update; the errata are covered by <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a>.  </li>
<li>Meanwhile <a href="#RFC5321">[RFC5321]</a>, <a href="#RFC5322">[RFC5322]</a>, <a href="#RFC5451">[RFC5451]</a>, <a href="#RFC5890">[RFC5890]</a>, and <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a> exist.  </li>
</ul>

<p> </p>
<p id="rfc.section.Appendix A.p.3">Changes in version 04 (2008): </p>
<p></p>

<ul><li>Fixed two typos and the references for the published EAI RFCs.  </li></ul>

<p> </p>
<p id="rfc.section.Appendix A.p.5">Changes in version 03: </p>
<p></p>

<ul>
<li>Added a terminology <a href="#terms">Section 1.1</a>. Apart from the added <a href="#RFC5322">[RFC5322]</a> defining &lt;atext&gt; all referenced drafts are now approved RFCs.  </li>
<li>Clarified that case-insensitive uses of &lt;UTF8-non-ascii&gt; can cause havoc in conjunction with local part macros.  This is not mitigated by the recommended normalization.  </li>
<li>Added a pointer to the <a href="#I-D.kitterman-4408bis">[I-D.kitterman-4408bis]</a> security considerations in <a href="#security">Section 5</a>.  Mentioned the role of local part macros in an attack scenario with credits to Doug Otis.  </li>
<li>Added the missing credits for the SPF discussions on the EAI list back in 2006 and 2007.  </li>
<li>Added a link to the "outsourced" <a href="#Errata">[Errata]</a> mentioning the SPF test suite.  Errata and test suite cover some &lt;target-name&gt; issues discussed in this memo, notably "adjacent dots".  </li>
<li>Added a long <a href="#i18n">Section 3.3</a> about the wonders of SPF explanations with the rather trivial conclusion that <a href="#RFC3987">[RFC3987]</a> percent-encoding works as expected.  </li>
</ul>

<p> </p>
<p id="rfc.section.Appendix A.p.7">Changes in version 02: </p>
<p></p>

<ul>
<li>This memo is about EAI, not wildcard issues elsewhere; replaced 4592 by <a href="#RFC4952">[RFC4952]</a>.  </li>
<li>Noted that only certain LDH-labels are or might be A-labels.  The details are specified in <a href="#RFC5890">[RFC5890]</a>.  </li>
<li>
<a href="#RFC5451">[RFC5451]</a> not yet added, extending the Authentication-Results header field to allow UTF-8 values for EAI should be straight forward.  </li>
</ul>

<p> </p>
<p id="rfc.section.Appendix A.p.9">Changes in version 01: </p>
<p></p>

<ul>
<li>Extended the local part discussion in <a href="#havoc">Section 2.3</a> significantly to cover known gaps in the SPF specification.  Added potential issues with non-normalized local parts.  </li>
<li>Added a Received-SPF section using the now "Last Called" <a href="#RFC5335">[RFC5335]</a>.  Added references to <a href="#RFC4343">[RFC4343]</a>, <a href="#RFC4952">[RFC4952]</a>, <a href="#RFC5198">[RFC5198]</a>, and the approved <a href="#RFC5337">[RFC5337]</a>.  </li>
<li>Removed the discussion of two vs. five SPF "subtypes", this belongs into another draft.  Kept the caveat about using an algorithm designed for subtype x on a policy with subtype y (or v.v.), as this could cause hard to debug mail losses.  </li>
</ul>

<p> </p>
<p id="rfc.section.Appendix A.p.11">Initial version: </p>
<p></p>

<ul><li>In a short discussion on the EAI list Harald Alvestrand and John Klensin encouraged to collect SPF EAI considerations in a separate memo.  </li></ul>

<p> </p>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Frank Ellermann</span> 
	  <span class="n hidden">
		<span class="family-name">Ellermann</span>
	  </span>
	</span>
	<span class="org vcardline">xyzzy</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality">Hamburg</span>,  
		<span class="region">Germany</span> 
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:hmdmhdfmhdjmzdtjmzdtzktdkztdjz@gmail.com">hmdmhdfmhdjmzdtjmzdtzktdkztdjz@gmail.com</a></span>

<span class="vcardline">URI: <a href="http://purl.net/xyzzy/">http://purl.net/xyzzy/</a></span>

  </address>
</div>

</body>
</html>