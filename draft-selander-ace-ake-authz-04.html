<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Lightweight Authorization for Authenticated Key Exchange.</title>
<meta content="Göran Selander" name="author">
<meta content="John Preuß Mattsson" name="author">
<meta content="Mališa Vučinić" name="author">
<meta content="Michael Richardson" name="author">
<meta content="Aurelio Schellenbaum" name="author">
<meta content="
       This document describes a procedure for augmenting the lightweight authenticated Diffie-Hellman key exchange protocol EDHOC with third party assisted authorization, targeting constrained IoT deployments (RFC 7228). 
    " name="description">
<meta content="xml2rfc 3.10.0" name="generator">
<meta content="draft-selander-ace-ake-authz-04" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.10.0
    Python 3.6.12
    appdirs 1.4.4
    ConfigArgParse 1.5.3
    google-i18n-address 2.5.0
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 2.11.3
    kitchen 1.2.6
    lxml 4.6.3
    pycountry 20.7.3
    pyflakes 2.4.0
    PyYAML 5.4.1
    requests 2.26.0
    setuptools 58.2.0
    six 1.16.0
-->
<link href="/tmp/draft-selander-ace-ake-authz-04-c9wjnxjq.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necssary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: 'Noto Sans', Arial, Helvetica, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre, code {
  background-color: #f9f9f9;
  font-family: 'Roboto Mono', monospace;
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    float: none;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: "Noto Sans",Arial,Helvetica,sans-serif;
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {

    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The follwing is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre, code {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
pre.sourcecode,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact informatio look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background sligthtly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottim margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the comact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div:first-child > pre.sourcecode,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<script type="application/javascript">async function addMetadata(){try{const e=document.styleSheets[0].cssRules;for(let t=0;t<e.length;t++)if(/#identifiers/.exec(e[t].selectorText)){const a=e[t].cssText.replace("#identifiers","#external-updates");document.styleSheets[0].insertRule(a,document.styleSheets[0].cssRules.length)}}catch(e){console.log(e)}const e=document.getElementById("external-metadata");if(e)try{var t,a="",o=function(e){const t=document.getElementsByTagName("meta");for(let a=0;a<t.length;a++)if(t[a].getAttribute("name")===e)return t[a].getAttribute("content");return""}("rfc.number");if(o){t="https://www.rfc-editor.org/rfc/rfc"+o+".json";try{const e=await fetch(t);a=await e.json()}catch(e){t=document.URL.indexOf("html")>=0?document.URL.replace(/html$/,"json"):document.URL+".json";const o=await fetch(t);a=await o.json()}}if(!a)return;e.style.display="block";const s="",d="https://datatracker.ietf.org/doc",n="https://datatracker.ietf.org/ipr/search",c="https://www.rfc-editor.org/info",l=a.doc_id.toLowerCase(),i=a.doc_id.slice(0,3).toLowerCase(),f=a.doc_id.slice(3).replace(/^0+/,""),u={status:"Status",obsoletes:"Obsoletes",obsoleted_by:"Obsoleted By",updates:"Updates",updated_by:"Updated By",see_also:"See Also",errata_url:"Errata"};let h="<dl style='overflow:hidden' id='external-updates'>";["status","obsoletes","obsoleted_by","updates","updated_by","see_also","errata_url"].forEach(e=>{if("status"==e){a[e]=a[e].toLowerCase();var t=a[e].split(" "),o=t.length,w="",p=1;for(let e=0;e<o;e++)p<o?w=w+r(t[e])+" ":w+=r(t[e]),p++;a[e]=w}else if("obsoletes"==e||"obsoleted_by"==e||"updates"==e||"updated_by"==e){var g,m="",b=1;g=a[e].length;for(let t=0;t<g;t++)a[e][t]&&(a[e][t]=String(a[e][t]).toLowerCase(),m=b<g?m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>, ":m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>",b++);a[e]=m}else if("see_also"==e){var y,L="",C=1;y=a[e].length;for(let t=0;t<y;t++)if(a[e][t]){a[e][t]=String(a[e][t]);var _=a[e][t].slice(0,3),v=a[e][t].slice(3).replace(/^0+/,"");L=C<y?"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>, ":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>, ":"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>",C++}a[e]=L}else if("errata_url"==e){var R="";R=a[e]?R+"<a href='"+a[e]+"'>Errata exist</a> | <a href='"+d+"/"+l+"'>Datatracker</a>| <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>":"<a href='"+d+"/"+l+"'>Datatracker</a> | <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>",a[e]=R}""!=a[e]?"Errata"==u[e]?h+=`<dt>More info:</dt><dd>${a[e]}</dd>`:h+=`<dt>${u[e]}:</dt><dd>${a[e]}</dd>`:"Errata"==u[e]&&(h+=`<dt>More info:</dt><dd>${a[e]}</dd>`)}),h+="</dl>",e.innerHTML=h}catch(e){console.log(e)}else console.log("Could not locate metadata <div> element");function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}}window.removeEventListener("load",addMetadata),window.addEventListener("load",addMetadata);</script>
</head>
<body>
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">Lightweight Authorization for AKE.</td>
<td class="right">October 2021</td>
</tr></thead>
<tfoot><tr>
<td class="left">Selander, et al.</td>
<td class="center">Expires 25 April 2022</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-selander-ace-ake-authz-04</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2021-10-22" class="published">22 October 2021</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2022-04-25">25 April 2022</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">G. Selander</div>
<div class="org">Ericsson AB</div>
</div>
<div class="author">
      <div class="author-name">J. Preuß Mattsson</div>
<div class="org">Ericsson AB</div>
</div>
<div class="author">
      <div class="author-name">M. Vučinić</div>
<div class="org">INRIA</div>
</div>
<div class="author">
      <div class="author-name">M. Richardson</div>
<div class="org">Sandelman Software Works</div>
</div>
<div class="author">
      <div class="author-name">A. Schellenbaum</div>
<div class="org">ZHAW</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Lightweight Authorization for Authenticated Key Exchange.</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes a procedure for augmenting the lightweight authenticated Diffie-Hellman key exchange protocol EDHOC with third party assisted authorization, targeting constrained IoT deployments (RFC 7228).<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 25 April 2022.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2021 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="xref">1.1</a>.  <a href="#name-terminology" class="xref">Terminology</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="xref">2</a>.  <a href="#name-problem-description" class="xref">Problem Description</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-assumptions" class="xref">Assumptions</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-device" class="xref">Device</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-domain-authenticator" class="xref">Domain Authenticator</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="xref">3.3</a>.  <a href="#name-authorization-server" class="xref">Authorization Server</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-the-protocol" class="xref">The Protocol</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="xref">4.1</a>.  <a href="#name-overview" class="xref">Overview</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="xref">4.2</a>.  <a href="#name-reuse-of-edhoc" class="xref">Reuse of EDHOC</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="xref">4.3</a>.  <a href="#name-device-authorization-server" class="xref">Device &lt;-&gt; Authorization Server</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a href="#section-4.4" class="xref">4.4</a>.  <a href="#name-device-authenticator" class="xref">Device &lt;-&gt; Authenticator</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5">
                <p id="section-toc.1-1.4.2.5.1"><a href="#section-4.5" class="xref">4.5</a>.  <a href="#name-authenticator-authorization" class="xref">Authenticator &lt;-&gt; Authorization Server</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-ace-profile" class="xref">ACE Profile</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-protocol-overview" class="xref">Protocol Overview</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-as-request-creation-hints" class="xref">AS Request Creation Hints</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="xref">5.3</a>.  <a href="#name-client-to-as-request" class="xref">Client-to-AS Request</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.4">
                <p id="section-toc.1-1.5.2.4.1"><a href="#section-5.4" class="xref">5.4</a>.  <a href="#name-as-to-client-response" class="xref">AS-to-Client Response</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-security-considerations" class="xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-iana-considerations" class="xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-informative-references" class="xref">Informative References</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#appendix-A" class="xref"></a><a href="#name-authors-addresses" class="xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="intro">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">For constrained IoT deployments <span>[<a href="#RFC7228" class="xref">RFC7228</a>]</span> the overhead and processing contributed by security protocols may be significant which motivates the specification of lightweight protocols that are optimizing, in particular, message overhead (see <span>[<a href="#I-D.ietf-lake-reqs" class="xref">I-D.ietf-lake-reqs</a>]</span>).
This document describes a procedure for augmenting the lightweight authenticated Diffie-Hellman key exchange EDHOC <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span> with third party-assisted authorization.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">The procedure involves a device, a domain authenticator and an authorization server.
The device and authenticator perform mutual authentication and authorization, assisted by the authorization server which provides relevant authorization information to the device (a "voucher") and to the authenticator.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">The protocol assumes that authentication between device and authenticator is performed with EDHOC, and defines the integration of a lightweight authorization procedure using the External Authorization Data (EAD) field defined in EDHOC.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">In this document we consider the target interaction for which authorization is needed to be "enrollment", for example joining a network for the first time (e.g. <span>[<a href="#RFC9031" class="xref">RFC9031</a>]</span>), or certificate enrollment (such as <span>[<a href="#I-D.selander-ace-coap-est-oscore" class="xref">I-D.selander-ace-coap-est-oscore</a>]</span>), but it can be applied to authorize other target interactions.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">The protocol enables a low message count by performing authorization and enrollment in parallel with authentication, instead of in sequence which is common for network access.
It further reuses protocol elements from EDHOC leading to reduced message sizes on constrained links.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">This protocol is applicable to a wide variety of settings, and can be mapped to different authorization architectures.
This document specifies a profile of the ACE framework <span>[<a href="#I-D.ietf-ace-oauth-authz" class="xref">I-D.ietf-ace-oauth-authz</a>]</span>.
Other settings such as EAP <span>[<a href="#RFC3748" class="xref">RFC3748</a>]</span> are out of scope for this specification.<a href="#section-1-6" class="pilcrow">¶</a></p>
<div id="terminology">
<section id="section-1.1">
        <h3 id="name-terminology">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
        </h3>
<p id="section-1.1-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span> when, and only when, they appear in all capitals, as shown here.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">Readers are expected to have some understanding of CBOR <span>[<a href="#RFC8949" class="xref">RFC8949</a>]</span> and EDHOC <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>.
Appendix C.1 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span> contains some basic info about CBOR.<a href="#section-1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="prob-desc">
<section id="section-2">
      <h2 id="name-problem-description">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-problem-description" class="section-name selfRef">Problem Description</a>
      </h2>
<p id="section-2-1">The (potentially constrained) device wants to enroll into a domain over a constrained link.
The device authenticates and enforces authorization of the (non-constrained) domain authenticator with the help of a voucher, and makes the enrollment request.
The domain authenticator authenticates the device and authorizes its enrollment.
Authentication between device and domain authenticator is made with the lightweight authenticated Diffie-Hellman key exchange protocol EDHOC <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>.
The procedure is assisted by a (non-constrained) authorization server located in a non-constrained network behind the domain authenticator providing information to the device and to the domain authenticator as part of the protocol.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">The objective of this document is to specify such a protocol which is lightweight over the constrained link and reuses elements of EDHOC.
See illustration in <a href="#fig-overview" class="xref">Figure 1</a>.<a href="#section-2-2" class="pilcrow">¶</a></p>
<span id="name-overview-of-message-flow-li"></span><div id="fig-overview">
<figure id="figure-1">
        <div class="alignCenter art-text artwork" id="section-2-3.1">
<pre>
                  Voucher
            EDHOC Info
+----------+  |    |   +---------------+  Voucher  +---------------+
|          |  |    |   |               |  Request  |               |
|  Device  |--|----o--&gt;|    Domain     |----------&gt;| Authorization |
|          |&lt;-|---o----| Authenticator |&lt;----------|     Server    |
|    (U)   |--|---|---&gt;|      (V)      |  Voucher  |       (W)     |
|          |      |    |               |  Response |               |
+----------+      |    +---------------+           +---------------+
                  Voucher

</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-overview-of-message-flow-li" class="selfRef">Overview of message flow. Link between U anv V is constrained but link between V and W is not. Voucher Info and Voucher are sent in EDHOC External Authorization Data.</a>
        </figcaption></figure>
</div>
</section>
</div>
<div id="assumptions">
<section id="section-3">
      <h2 id="name-assumptions">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-assumptions" class="section-name selfRef">Assumptions</a>
      </h2>
<div id="device">
<section id="section-3.1">
        <h3 id="name-device">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-device" class="section-name selfRef">Device</a>
        </h3>
<p id="section-3.1-1">The device is pre-provisioned with an identity ID_U and asymmetric key credentials: a private key, a public key (PK_U), and optionally a public key certificate (Cert_PK_U), issued by a trusted third party such as e.g. the device manufacturer, used to authenticate to the domain authenticator.
ID_U may be a reference or pointer to the certificate.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">The device is also provisioned with information about its authorization server:<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-3.1">At least one static public DH key of the authorization server (G_W) used to ensure secure communication with the device (see <a href="#U-W" class="xref">Section 4.3</a>).<a href="#section-3.1-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.1-3.2">Location information about the authorization server (LOC_W), e.g. its domain name. This information may be available in the device certificate Cert_PK_U.<a href="#section-3.1-3.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="domain-auth">
<section id="section-3.2">
        <h3 id="name-domain-authenticator">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-domain-authenticator" class="section-name selfRef">Domain Authenticator</a>
        </h3>
<p id="section-3.2-1">The domain authenticator has a private key and a corresponding public key PK_V used to authenticate to the device.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">The domain authenticator needs to be able to locate the authorization server of the device for which LOC_W is expected to be sufficient.
The communication between domain authenticator and authorization server is assumed to be mutually authenticated and protected; authentication credentials and communication security is out of scope, except for as specified below in this section.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">The domain authenticator may in principle use differents credentials for authenticating to the authorization server and to the device, for which PK_V is used.
However, the domain authenticator MUST prove possession of private key of PK_V to the authorization server since the authorization server is asserting (by means of the voucher to the device) that this credential belongs to the domain authenticator.<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<p id="section-3.2-4">In this version of the draft it is assumed that the domain authenticator authenticates to the authorization server with PK_V using some authentication protocol providing proof of possession of the private key, for example TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.
A future version of this draft may specify explicit proof of possession of the private key of PK_V in the voucher request, e.g., by including a signature of the voucher request with the private key corresponding to PK_V.<a href="#section-3.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authorization-server">
<section id="section-3.3">
        <h3 id="name-authorization-server">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-authorization-server" class="section-name selfRef">Authorization Server</a>
        </h3>
<p id="section-3.3-1">The authorization server has the private DH key corresponding to G_W, which is used to secure the communication with the device (see <a href="#U-W" class="xref">Section 4.3</a>).<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<p id="section-3.3-2">Authentication credentials and communication security used with the domain authenticator is out of scope, except for the need to verify the possession of the private key of PK_V as specified in <a href="#domain-auth" class="xref">Section 3.2</a>.<a href="#section-3.3-2" class="pilcrow">¶</a></p>
<p id="section-3.3-3">The authorization server provides to the device the authorization decision for enrollment with the domain authenticator in the form of a voucher.
The authorization server provides information to the domain authenticator about the device, such as the device's certificate Cert_PK_U.<a href="#section-3.3-3" class="pilcrow">¶</a></p>
<p id="section-3.3-4">The authorization server needs to be available during the execution of the protocol.<a href="#section-3.3-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="the-protocol">
<section id="section-4">
      <h2 id="name-the-protocol">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-the-protocol" class="section-name selfRef">The Protocol</a>
      </h2>
<div id="overview">
<section id="section-4.1">
        <h3 id="name-overview">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-overview" class="section-name selfRef">Overview</a>
        </h3>
<p id="section-4.1-1">Three security sessions are going on in parallel:<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.1-2">
<li id="section-4.1-2.1">EDHOC <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span> between device (U) and (domain) authenticator (V)<a href="#section-4.1-2.1" class="pilcrow">¶</a>
</li>
          <li id="section-4.1-2.2">Voucher Request/Response between authenticator (V) and authorization server (W)<a href="#section-4.1-2.2" class="pilcrow">¶</a>
</li>
          <li id="section-4.1-2.3">An exchange of voucher-related information, including the voucher itself, between device (U) and authorization server (W), mediated by the authenticator.<a href="#section-4.1-2.3" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-4.1-3"><a href="#fig-protocol" class="xref">Figure 2</a> provides an overview of the message flow detailed in this section. Only selected message fields of EDHOC are shown, for more details see Section 3.1 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
<span id="name-w-assisted-authorization-of"></span><div id="fig-protocol">
<figure id="figure-2">
          <div class="alignCenter art-text artwork" id="section-4.1-4.1">
<pre>
U                                    V                              W
|                                    |                              |
|        SUITES_I, G_X, EAD_1        |                              |
+-----------------------------------&gt;|                              |
|          EDHOC message_1           |   SS, G_X, ENC_ID, ?PoP_V    |
|                                    +-----------------------------&gt;|
|                                    |    Voucher Request (VREQ)    |
|                                    |                              |
|                                    |    G_X, CERT_PK_U, Voucher   |
|                                    |&lt;-----------------------------+
|                                    |    Voucher Response (VRES)   |
|   ID_CRED_R, Sig_or_MAC_2, EAD_2   |                              |
|&lt;-----------------------------------+                              |
|          EDHOC message_2           |                              |
|                                    |                              |
|       ID_CRED_I, Sig_or_MAC_3      |                              |
+-----------------------------------&gt;|                              |
|          EDHOC message_3           |                              |

where
EAD_1 = (L, Voucher_Info)
Voucher_Info = [LOC_W, ENC_ID]
EAD_2 = (L, Voucher)
Voucher = MAC(V_TYPE, SS, G_X, ID_U, PK_V)

</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-w-assisted-authorization-of" class="selfRef">W-assisted authorization of AKE between U and V: EDHOC between U and V (only selected message fields shown), and Voucher Request/Response between V and W.</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="reuse">
<section id="section-4.2">
        <h3 id="name-reuse-of-edhoc">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-reuse-of-edhoc" class="section-name selfRef">Reuse of EDHOC</a>
        </h3>
<p id="section-4.2-1">The protocol illustrated in <a href="#fig-protocol" class="xref">Figure 2</a> reuses several components of EDHOC:<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-2.1">G_X, the 'x' parameter of the ephemeral public Diffie-Hellman key of party U, is also used in the protocol between U and W, as ephemeral key and nonce.<a href="#section-4.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.2-2.2">
            <p id="section-4.2-2.2.1">SUITES_I, the cipher suites relevant to U, which includes the selected cipher suite - here denoted SS, also defines the algorithms used between U and W. In particular SS contains information about (see Section 3.6 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>):<a href="#section-4.2-2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-2.2.2.1">EDHOC AEAD algorithm: used to encrypt the identity of U<a href="#section-4.2-2.2.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.2-2.2.2.2">EDHOC hash algorithm: used for key derivation and to calculate the voucher<a href="#section-4.2-2.2.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.2-2.2.2.3">EDHOC MAC length in bytes: length of the voucher<a href="#section-4.2-2.2.2.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.2-2.2.2.4">EDHOC key exchange algorithm: used to calculate the shared secret between U and W<a href="#section-4.2-2.2.2.4" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-4.2-2.3">EAD_1, EAD_2 are the External Authorization Data of message_1 and message_2, respectively, for which dedicated content is defined in this document.<a href="#section-4.2-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.2-2.4">ID_CRED_I and ID_CRED_R are used to identify the public authentication keys of U and V. In this protocol ID_CRED_I can be empty since V obtains the certificate of U from W, whereas ID_CRED_R contains the public authentication key of V.<a href="#section-4.2-2.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.2-2.5">Signature_or_MAC_2 and Signature_or_MAC_3 (abbreviated in <a href="#fig-protocol" class="xref">Figure 2</a>), containing data generated using the private key of V and U, respectively, are shown here just to be able to reason about the use of credentials.<a href="#section-4.2-2.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-4.2-3">The protocol also reuses the Extract and Expand key derivation from EDHOC (Section 4 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>).<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-4.1">
            <p id="section-4.2-4.1.1">The intermediate pseudo-random key PRK is derived using Extract():<a href="#section-4.2-4.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-4.1.2.1">
                <p id="section-4.2-4.1.2.1.1">PRK = Extract(salt, IKM)<a href="#section-4.2-4.1.2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-4.1.2.1.2.1">where salt = 0x (the zero-length byte string)<a href="#section-4.2-4.1.2.1.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-4.2-4.1.2.1.2.2">IKM is the ECDH shared secret G_XW (calculated from G_X and W or G_W and X) as defined in Section 6.3.1 of [I-D.ietf-cose-rfc8152bis-algs].<a href="#section-4.2-4.1.2.1.2.2" class="pilcrow">¶</a>
</li>
                </ul>
</li>
            </ul>
</li>
        </ul>
<p id="section-4.2-5">The shared secret is derived using Expand() which is defined in terms of the EDHOC hash algorithm of the selected cipher suite, see Section 4.2. of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>:<a href="#section-4.2-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-6.1">
            <p id="section-4.2-6.1.1">shared secret = Expand(PRK, info, length)<a href="#section-4.2-6.1.1" class="pilcrow">¶</a></p>
<p id="section-4.2-6.1.2">
where<a href="#section-4.2-6.1.2" class="pilcrow">¶</a></p>
</li>
        </ul>
<div class="alignLeft art-text artwork" id="section-4.2-7">
<pre>
info = (
   transcript_hash : bstr,
   label : tstr,
   context : bstr,
   length : uint,
)
</pre><a href="#section-4.2-7" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="U-W">
<section id="section-4.3">
        <h3 id="name-device-authorization-server">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-device-authorization-server" class="section-name selfRef">Device &lt;-&gt; Authorization Server</a>
        </h3>
<p id="section-4.3-1">The protocol between device and authorization server (U and W in <a href="#fig-protocol" class="xref">Figure 2</a>) is carried out via the authenticator (V) with certain data protected between the endpoints using the equivalent of a hybrid encryption scheme (see, e.g., <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span>).
The device uses the public DH key of the authorization server G_W together with the private DH key corresponding to ephemeral key G_X in EDHOC message_1, and vice versa for the authorization server.
The endpoints calculate a shared secret G_XW (see <a href="#reuse" class="xref">Section 4.2</a>), which is used to derive secret keys to protect data between U and W, as detailed in this section.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.3-2">The data exchanged betweeen U and W is carried between U and V in EAD_1 and EAD_2 (<a href="#U-V" class="xref">Section 4.4</a>), and between V and W in Voucher Request/Response (<a href="#V-W" class="xref">Section 4.5</a>).<a href="#section-4.3-2" class="pilcrow">¶</a></p>
<div id="voucher-info">
<section id="section-4.3.1">
          <h4 id="name-voucher-info">
<a href="#section-4.3.1" class="section-number selfRef">4.3.1. </a><a href="#name-voucher-info" class="section-name selfRef">Voucher Info</a>
          </h4>
<p id="section-4.3.1-1">The external authorization data EAD_1 of EDHOC message_1 includes Voucher Info, which is the following CBOR sequence:<a href="#section-4.3.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.3.1-2">
<pre>
Voucher_Info = (
    LOC_W:      tstr,
    ENC_ID:     bstr
)
</pre><a href="#section-4.3.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.3.1-3">where<a href="#section-4.3.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3.1-4.1">LOC_W is location information about the authorization server, used by the authenticator<a href="#section-4.3.1-4.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-4.2">ENC_ID is the encrypted blob carrying the identity of the device and an optional identity of the authenticator, passed on from the authenticator to the authorization server, calculated as follows:<a href="#section-4.3.1-4.2" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-4.3.1-5">ENC_ID is 'ciphertext' of COSE_Encrypt0 (Section 5.2-5.3 of <span>[<a href="#RFC8152" class="xref">RFC8152</a>]</span>) computed from the following:<a href="#section-4.3.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3.1-6.1">The encryption key K_1 and nonce IV_1 are derived as specified below.<a href="#section-4.3.1-6.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-6.2">'protected' is a byte string of size 0<a href="#section-4.3.1-6.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-6.3">'plaintext and 'external_aad' as below:<a href="#section-4.3.1-6.3" class="pilcrow">¶</a>
</li>
          </ul>
<div class="alignLeft art-text artwork" id="section-4.3.1-7">
<pre>
plaintext = (
    ID_U:            bstr,
  ? ID_V:            bstr,
 )
</pre><a href="#section-4.3.1-7" class="pilcrow">¶</a>
</div>
<div class="alignLeft art-text artwork" id="section-4.3.1-8">
<pre>
external_aad = (
    SS:              int,
 )
</pre><a href="#section-4.3.1-8" class="pilcrow">¶</a>
</div>
<p id="section-4.3.1-9">where<a href="#section-4.3.1-9" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3.1-10.1">ID_U is the identity of the device, for example a reference or pointer to the device certificate<a href="#section-4.3.1-10.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-10.2">ID_V is the identity of the authenticator as presented to the authorization server. This may be a name in a name space agreed out-of-band and managed by a party trusted by the authorization server, for example a common name of an X.509 certificate signed by a CA trusted by the authorization server. The value may be obtained by the device through out-of-band means, possibly through secure network discovery.<a href="#section-4.3.1-10.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-10.3">SS is the selected cipher suite in SUITES_I.<a href="#section-4.3.1-10.3" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-4.3.1-11">The derivation of K_1 = Expand(PRK, info, length) uses the following input to the info struct (<a href="#reuse" class="xref">Section 4.2</a>):<a href="#section-4.3.1-11" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3.1-12.1">transcript_hash = h''<a href="#section-4.3.1-12.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-12.2">label is "EDHOC_ACE_AKE_AUTHZ_K_1"<a href="#section-4.3.1-12.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-12.3">context  = h''<a href="#section-4.3.1-12.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-12.4">length is length of key of the EDHOC AEAD algorithm<a href="#section-4.3.1-12.4" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-4.3.1-13">The derivation of IV_1 = Expand(PRK, info, length) uses the following input to the info struct (<a href="#reuse" class="xref">Section 4.2</a>):<a href="#section-4.3.1-13" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3.1-14.1">transcript_hash = h''<a href="#section-4.3.1-14.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-14.2">label is "EDHOC_ACE_AKE_AUTHZ_IV_1"<a href="#section-4.3.1-14.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-14.3">context = h''<a href="#section-4.3.1-14.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.1-14.4">length is length of nonce of the EDHOC AEAD algorithm<a href="#section-4.3.1-14.4" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="voucher">
<section id="section-4.3.2">
          <h4 id="name-voucher">
<a href="#section-4.3.2" class="section-number selfRef">4.3.2. </a><a href="#name-voucher" class="section-name selfRef">Voucher</a>
          </h4>
<p id="section-4.3.2-1">The voucher is an assertion by the authorization server to the device that the authorization server has performed the relevant verifications and that the device is authorized to continue the protocol with the authenticator. The Voucher is essentially a message authentication code which binds the identity of the authenticator to message_1 of EDHOC, integrity protected with the shared secret context between U and W.<a href="#section-4.3.2-1" class="pilcrow">¶</a></p>
<p id="section-4.3.2-2">The calculation of Voucher = Expand(PRK, info, length) uses the following input to the info struct (<a href="#reuse" class="xref">Section 4.2</a>):<a href="#section-4.3.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3.2-3.1">transcript_hash = h''<a href="#section-4.3.2-3.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.2-3.2">label is "EDHOC_ACE_AKE_AUTHZ_MAC"<a href="#section-4.3.2-3.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.2-3.3">context  = bstr .cbor voucher_input<a href="#section-4.3.2-3.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.2-3.4">length is EDHOC MAC length in bytes<a href="#section-4.3.2-3.4" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-4.3.2-4">where context is a CBOR bstr wrapping of voucher_input:<a href="#section-4.3.2-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.3.2-5">
<pre>
voucher_input = (
    V_TYPE:        int,
    SS:            int,
    G_X:           bstr,
    ID_U:          bstr,
    PK_V:          bstr,
)
</pre><a href="#section-4.3.2-5" class="pilcrow">¶</a>
</div>
<p id="section-4.3.2-6">where<a href="#section-4.3.2-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3.2-7.1">V_TYPE indicates the type of voucher used (TBD)<a href="#section-4.3.2-7.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.2-7.2">SS is the selected cipher suite of the EDHOC protocol, see <a href="#reuse" class="xref">Section 4.2</a><a href="#section-4.3.2-7.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.2-7.3">PK_V is a CWT Claims Set (CCS, <span>[<a href="#RFC8392" class="xref">RFC8392</a>]</span>) containing the public authentication key of the authenticator encoded as a COSE_Key in the 'cnf' claim, see Section 3.5.3 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>.<a href="#section-4.3.2-7.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.2-7.4">G_X is encoded as in EDHOC message_1, see Section 3.7 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span><a href="#section-4.3.2-7.4" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.3.2-7.5">ID_U is defined in <a href="#U-W" class="xref">Section 4.3</a><a href="#section-4.3.2-7.5" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-4.3.2-8">Editor's note: With the current definition of EAD as (ead_label, ead_value), do we need to redefine the voucher to be a CBOR map? Do we even need the V_TYPE?<a href="#section-4.3.2-8" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="U-V">
<section id="section-4.4">
        <h3 id="name-device-authenticator">
<a href="#section-4.4" class="section-number selfRef">4.4. </a><a href="#name-device-authenticator" class="section-name selfRef">Device &lt;-&gt; Authenticator</a>
        </h3>
<p id="section-4.4-1">The device and authenticator run the EDHOC protocol authenticated with their public keys (PK_U and PK_V), see <a href="#fig-protocol" class="xref">Figure 2</a>. Normal EDHOC processing is omitted here.<a href="#section-4.4-1" class="pilcrow">¶</a></p>
<div id="message-1">
<section id="section-4.4.1">
          <h4 id="name-message-1">
<a href="#section-4.4.1" class="section-number selfRef">4.4.1. </a><a href="#name-message-1" class="section-name selfRef">Message 1</a>
          </h4>
<div id="device-processing">
<section id="section-4.4.1.1">
            <h5 id="name-device-processing">
<a href="#section-4.4.1.1" class="section-number selfRef">4.4.1.1. </a><a href="#name-device-processing" class="section-name selfRef">Device processing</a>
            </h5>
<p id="section-4.4.1.1-1">The device composes EDHOC message_1 using authentication method, identifiers, etc. according to the applicability statement, see Section 3.9 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>. The selected cipher suite SS applies also to the interaction with the authorization server as detailed in <a href="#reuse" class="xref">Section 4.2</a>, in particular, the key agreement algorithm which is used with the static public DH key G_W of the authorization server. As part of the normal EDHOC processing, the device generates the ephemeral public key G_X which is reused in the interaction with the authorization server, see <a href="#U-W" class="xref">Section 4.3</a>.<a href="#section-4.4.1.1-1" class="pilcrow">¶</a></p>
<p id="section-4.4.1.1-2">The device sends EDHOC message_1 with EAD_1 = (L, Voucher_Info) where L is the External Auxiliary Data Label for this protocol (IANA registry created in Section 9.5 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>), and Voucher_Info is specified in <a href="#U-W" class="xref">Section 4.3</a>.<a href="#section-4.4.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authenticator-processing">
<section id="section-4.4.1.2">
            <h5 id="name-authenticator-processing">
<a href="#section-4.4.1.2" class="section-number selfRef">4.4.1.2. </a><a href="#name-authenticator-processing" class="section-name selfRef">Authenticator processing</a>
            </h5>
<p id="section-4.4.1.2-1">The authenticator receives EDHOC message_1 from the device and processes as specified in Section 5.2.3 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>, with the additional step that the presence of EAD with label L triggers the voucher request to the authorization server as described in <a href="#V-W" class="xref">Section 4.5</a>. The exchange with V needs to be completed successfully for the EDHOC exchange to be continued.<a href="#section-4.4.1.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="message-2">
<section id="section-4.4.2">
          <h4 id="name-message-2">
<a href="#section-4.4.2" class="section-number selfRef">4.4.2. </a><a href="#name-message-2" class="section-name selfRef">Message 2</a>
          </h4>
<div id="authenticator-processing-1">
<section id="section-4.4.2.1">
            <h5 id="name-authenticator-processing-2">
<a href="#section-4.4.2.1" class="section-number selfRef">4.4.2.1. </a><a href="#name-authenticator-processing-2" class="section-name selfRef">Authenticator processing</a>
            </h5>
<p id="section-4.4.2.1-1">The authenticator receives the voucher response from the authorization server as described in <a href="#V-W" class="xref">Section 4.5</a>.<a href="#section-4.4.2.1-1" class="pilcrow">¶</a></p>
<p id="section-4.4.2.1-2">The authenticator sends EDHOC message_2 to the device with EAD_2 = (L, Voucher) where L is the External Auxiliary Data Label for this protocol (IANA registry created in Section 9.5 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>) and the Voucher is specified in <a href="#U-W" class="xref">Section 4.3</a>.<a href="#section-4.4.2.1-2" class="pilcrow">¶</a></p>
<p id="section-4.4.2.1-3">CRED_R is a CWT Claims Set (CCS, <span>[<a href="#RFC8392" class="xref">RFC8392</a>]</span>) containing the public authentication key of the authenticator PK_V encoded as a COSE_Key in the 'cnf' claim, see Section 3.5.3 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>.<a href="#section-4.4.2.1-3" class="pilcrow">¶</a></p>
<p id="section-4.4.2.1-4">ID_CRED_R contains the CCS with 'kccs' as COSE header_map, see Section 9.6 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span>. The Sig_or_MAC_2 field calculated using the private key corresponding to PK_V is either signature or MAC depending on EDHOC method.<a href="#section-4.4.2.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="device-processing-1">
<section id="section-4.4.2.2">
            <h5 id="name-device-processing-2">
<a href="#section-4.4.2.2" class="section-number selfRef">4.4.2.2. </a><a href="#name-device-processing-2" class="section-name selfRef">Device processing</a>
            </h5>
<p id="section-4.4.2.2-1">In addition to normal EDHOC verifications, the device MUST verify the Voucher by performing the same calculation as in <a href="#voucher" class="xref">Section 4.3.2</a> using the SS, G_X and ID_U carried in message_1 and PK_V received in message_2. If the voucher calculated in this way is not identical to what was received in message_2, then the device MUST discontinue the protocol.<a href="#section-4.4.2.2-1" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-2">Editor's note: Consider replace SS, G_X, ID_U in Voucher with H(message_1), since that is already required by EDHOC to be cached by the initiator. H(message_1) needs to be added to VREQ message in that case.<a href="#section-4.4.2.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="message-3">
<section id="section-4.4.3">
          <h4 id="name-message-3">
<a href="#section-4.4.3" class="section-number selfRef">4.4.3. </a><a href="#name-message-3" class="section-name selfRef">Message 3</a>
          </h4>
<div id="device-processing-2">
<section id="section-4.4.3.1">
            <h5 id="name-device-processing-3">
<a href="#section-4.4.3.1" class="section-number selfRef">4.4.3.1. </a><a href="#name-device-processing-3" class="section-name selfRef">Device processing</a>
            </h5>
<p id="section-4.4.3.1-1">If all verifications are passed, then the device sends EDHOC message_3.<a href="#section-4.4.3.1-1" class="pilcrow">¶</a></p>
<p id="section-4.4.3.1-2">The message field ID_CRED_I contains data enabling the authenticator to retrieve the public key of the device, PK_U. Since the authenticator before sending message_2 received a certificate of PK_U from the authorization server (see <a href="#V-W" class="xref">Section 4.5</a>), ID_CRED_I SHALL be a COSE header_map of type 'kid' with the empty byte string as value:<a href="#section-4.4.3.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.4.3.1-3">
<pre>
ID_CRED_I =
{
  4 : h''
}
</pre><a href="#section-4.4.3.1-3" class="pilcrow">¶</a>
</div>
<p id="section-4.4.3.1-4">The Sig_or_MAC_3 field calculated using the private key corresponding to PK_U is either signature or MAC depending on EDHOC method.<a href="#section-4.4.3.1-4" class="pilcrow">¶</a></p>
<p id="section-4.4.3.1-5">EAD_3 MAY contain an enrolment request, see e.g. CSR specified in <span>[<a href="#I-D.mattsson-cose-cbor-cert-compress" class="xref">I-D.mattsson-cose-cbor-cert-compress</a>]</span>, or other request which the device is now authorized to make.<a href="#section-4.4.3.1-5" class="pilcrow">¶</a></p>
<p id="section-4.4.3.1-6">EDHOC message_3 may be combined with an OSCORE request, see <span>[<a href="#I-D.palombini-core-oscore-edhoc" class="xref">I-D.palombini-core-oscore-edhoc</a>]</span>.<a href="#section-4.4.3.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authenticator-processing-2">
<section id="section-4.4.3.2">
            <h5 id="name-authenticator-processing-3">
<a href="#section-4.4.3.2" class="section-number selfRef">4.4.3.2. </a><a href="#name-authenticator-processing-3" class="section-name selfRef">Authenticator processing</a>
            </h5>
<p id="section-4.4.3.2-1">The authenticator performs the normal EDHOC verifications of message_3, with the exception that the Sig_or_MAC_3 field MUST be verified using the public key included in Cert_PK_U (see <a href="#voucher_response" class="xref">Section 4.5.2</a>) received from the authorization server. The authenticator MUST ignore any key related information obtained in ID_CRED_I.<a href="#section-4.4.3.2-1" class="pilcrow">¶</a></p>
<p id="section-4.4.3.2-2">This enables the authenticator to verify that message_3 was generated by the device authorized by the authorization server as part of the associated Voucher Request/Response procedure (see <a href="#V-W" class="xref">Section 4.5</a>).<a href="#section-4.4.3.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="V-W">
<section id="section-4.5">
        <h3 id="name-authenticator-authorization">
<a href="#section-4.5" class="section-number selfRef">4.5. </a><a href="#name-authenticator-authorization" class="section-name selfRef">Authenticator &lt;-&gt; Authorization Server</a>
        </h3>
<p id="section-4.5-1">The authenticator and authorization server are assumed to have, or to be able to, set up a secure connection, for example TLS 1.3 authenticated with certificates. The authenticator is assumed to authenticate with the public key PK_V, see <a href="#domain-auth" class="xref">Section 3.2</a>.<a href="#section-4.5-1" class="pilcrow">¶</a></p>
<p id="section-4.5-2">This secure connection protects the Voucher Request/Response Protocol (see protocol between V and W in <a href="#fig-protocol" class="xref">Figure 2</a>).<a href="#section-4.5-2" class="pilcrow">¶</a></p>
<p id="section-4.5-3">The ephemeral public key G_X sent in EDHOC message_1 from device to authenticator serves as challenge/response nonce for the Voucher Request/Response Protocol, and binds together instances of the two protocols.<a href="#section-4.5-3" class="pilcrow">¶</a></p>
<div id="voucher-request">
<section id="section-4.5.1">
          <h4 id="name-voucher-request">
<a href="#section-4.5.1" class="section-number selfRef">4.5.1. </a><a href="#name-voucher-request" class="section-name selfRef">Voucher Request</a>
          </h4>
<div id="authenticator-processing-3">
<section id="section-4.5.1.1">
            <h5 id="name-authenticator-processing-4">
<a href="#section-4.5.1.1" class="section-number selfRef">4.5.1.1. </a><a href="#name-authenticator-processing-4" class="section-name selfRef">Authenticator processing</a>
            </h5>
<p id="section-4.5.1.1-1">Unless already in place, the authenticator and the authorization server establish a secure connection. The autenticator uses G_X received from the device as a nonce associated to this connection with the authorization server. If the same value of the nonce G_X is already used for a connection with this or other authorization server, the protocol SHALL be discontinued.<a href="#section-4.5.1.1-1" class="pilcrow">¶</a></p>
<p id="section-4.5.1.1-2">The authenticator sends the voucher request to the authorization server. The Voucher Request SHALL be a CBOR array as defined below:<a href="#section-4.5.1.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.5.1.1-3">
<pre>
Voucher_Request = [
    SS:              int,
    G_X:             bstr,
    ENC_ID:          bstr,
  ? PoP_V:           bstr,
]
</pre><a href="#section-4.5.1.1-3" class="pilcrow">¶</a>
</div>
<p id="section-4.5.1.1-4">where all parameters are defined in <a href="#U-W" class="xref">Section 4.3</a>, except<a href="#section-4.5.1.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.1.1-5.1">PoP_V is a proof-of-possession of public key PK_V using the corresponding private key<a href="#section-4.5.1.1-5.1" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-4.5.1.1-6">Editor's note: Define PoP_V (include G_X, ENC_ID in the calculation for binding to this EDHOC session). One case to study is when V authenticates to U with static DH and to W with signature.<a href="#section-4.5.1.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authorization-server-processing">
<section id="section-4.5.1.2">
            <h5 id="name-authorization-server-proces">
<a href="#section-4.5.1.2" class="section-number selfRef">4.5.1.2. </a><a href="#name-authorization-server-proces" class="section-name selfRef">Authorization Server processing</a>
            </h5>
<p id="section-4.5.1.2-1">The authorization server receives the voucher request, verifies and decrypts the identity ID_U of the device, and associates the nonce G_X to ID_U.
If G_X is not unique among nonces associated to this identity, the protocol SHALL be discontinued.
If ENC_ID also included the identity of V, ID_V, then the authorization server performs an additional check to verify that the identity of the authenticator who sent the voucher request over a secure session between V-W matches the identity of the authenticator as observed by U.
If the identities of V as observed by U, and as observed by W, do not match, the protocol SHALL be discontinued.<a href="#section-4.5.1.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="voucher_response">
<section id="section-4.5.2">
          <h4 id="name-voucher-response">
<a href="#section-4.5.2" class="section-number selfRef">4.5.2. </a><a href="#name-voucher-response" class="section-name selfRef">Voucher Response</a>
          </h4>
<div id="authorization-server-processing-1">
<section id="section-4.5.2.1">
            <h5 id="name-authorization-server-process">
<a href="#section-4.5.2.1" class="section-number selfRef">4.5.2.1. </a><a href="#name-authorization-server-process" class="section-name selfRef">Authorization Server processing</a>
            </h5>
<p id="section-4.5.2.1-1">The authorization server uses the identity of the device, ID_U, to look up the device certificate, Cert_PK_U.<a href="#section-4.5.2.1-1" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-2">The authorization server retrieves the public key of V used to authenticate the secure connection with the authenticator, and constructs the CWT Claims Set and the Voucher as defined in <a href="#voucher" class="xref">Section 4.3.2</a>.<a href="#section-4.5.2.1-2" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-3">The authorization server generates the voucher response and sends it to the authenticator over the secure connection. The Voucher_Response SHALL be a CBOR array as defined below:<a href="#section-4.5.2.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.5.2.1-4">
<pre>
Voucher_Response = [
    G_X:            bstr,
    CERT_PK_U:      bstr,
    Voucher:        bstr
]
</pre><a href="#section-4.5.2.1-4" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2.1-5">where<a href="#section-4.5.2.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.2.1-6.1">G_X is copied from the associated voucher request.<a href="#section-4.5.2.1-6.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.5.2.1-6.2">CERT_PK_U is the device certificate of the public key PK_U, issued by a trusted third party. The format of this certificate is out of scope.<a href="#section-4.5.2.1-6.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-4.5.2.1-6.3">The Voucher is defined in <a href="#voucher" class="xref">Section 4.3.2</a>.<a href="#section-4.5.2.1-6.3" class="pilcrow">¶</a>
</li>
            </ul>
</section>
</div>
<div id="authenticator-processing-4">
<section id="section-4.5.2.2">
            <h5 id="name-authenticator-processing-5">
<a href="#section-4.5.2.2" class="section-number selfRef">4.5.2.2. </a><a href="#name-authenticator-processing-5" class="section-name selfRef">Authenticator processing</a>
            </h5>
<p id="section-4.5.2.2-1">The authenticator receives the voucher response from the authorization server over the secure connection. If the received G_X does not match the value of the nonce associated to the secure connection, the protocol SHALL be discontinued.<a href="#section-4.5.2.2-1" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-2">The authenticator verifies the certificate CERT_PK_U and that U is an admissible device, or else discontinues the protocol.<a href="#section-4.5.2.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="ace-profile">
<section id="section-5">
      <h2 id="name-ace-profile">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-ace-profile" class="section-name selfRef">ACE Profile</a>
      </h2>
<p id="section-5-1">The messages specified in this document may be carried between the endpoints in various protocols. This section defines an embedding as a profile of the ACE framework (see Appendix C of <span>[<a href="#I-D.ietf-ace-oauth-authz" class="xref">I-D.ietf-ace-oauth-authz</a>]</span>).<a href="#section-5-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5-2.1">U plays the role of the ACE Resource Server (RS).<a href="#section-5-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-2.2">V plays the role of the ACE Client (C).<a href="#section-5-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-2.3">W plays the role of the ACE Authorization Server (AS).<a href="#section-5-2.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-5-3">Many readers who are used to the diagram having the Client on the left may be surprised at the cast of characters.
The "resource" which C (V) is trying to access is the "ownership" of U.
The AS (W) is the manufacturer (or previous owner) of RS (U), and is therefore in a position to grant C (V) ownership of RS (U).<a href="#section-5-3" class="pilcrow">¶</a></p>
<p id="section-5-4">C and RS use EDHOC's EAD to communicate.
C and RS use the EDHOC protocol to protect their communication.
EDHOC also provides mutual authentication of C and RS, assisted by the AS.<a href="#section-5-4" class="pilcrow">¶</a></p>
<div id="protocol-overview">
<section id="section-5.1">
        <h3 id="name-protocol-overview">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-protocol-overview" class="section-name selfRef">Protocol Overview</a>
        </h3>
<span id="name-overview-of-the-protocol-ma"></span><div id="fig-mapping-ace">
<figure id="figure-3">
          <div class="alignCenter art-text artwork" id="section-5.1-1.1">
<pre>
  RS (U)                             C (V)                 AS (W)
   |          EDHOC message_1        |                     |
   |  AD1=AS Request Creation Hints  |                     |
   |--------------------------------&gt;|     POST /token     |
   |                                 |--------------------&gt;|
   |                                 |                     |
   |                                 | Access Token +      |
   |          EDHOC message_2        |  Access Information |
   |          AD2=Access Token       |&lt;--------------------|
   |&lt;--------------------------------|                     |
   |          EDHOC message_3        |                     |
   |--------------------------------&gt;|                     |

</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-overview-of-the-protocol-ma" class="selfRef">Overview of the protocol mapping to ACE</a>
          </figcaption></figure>
</div>
<ol start="1" type="1" class="normal type-1" id="section-5.1-2">
<li id="section-5.1-2.1">RS proactively sends the AS Request Creation Hints message to C to signal the information on
where C can reach the AS.<a href="#section-5.1-2.1" class="pilcrow">¶</a>
</li>
          <li id="section-5.1-2.2">RS piggybacks the AS Request Creation Hints message using Auxiliary Data of EDHOC message_1.<a href="#section-5.1-2.2" class="pilcrow">¶</a>
</li>
          <li id="section-5.1-2.3">Before continuing the EDHOC exchange, based on the AS Request Creation Hints information, C sends a POST request to the token endpoint at the AS requesting the access token.<a href="#section-5.1-2.3" class="pilcrow">¶</a>
</li>
          <li id="section-5.1-2.4">The AS issues an assertion to C that is cryptographically protected based on the secret shared between the AS and RS. In this profile, the assertion is encoded as a Bearer Token.<a href="#section-5.1-2.4" class="pilcrow">¶</a>
</li>
          <li id="section-5.1-2.5">C presents this token to RS in EAD_2.<a href="#section-5.1-2.5" class="pilcrow">¶</a>
</li>
          <li id="section-5.1-2.6">RS verifies the token based on the possession of the shared secret with the AS and authenticates C.<a href="#section-5.1-2.6" class="pilcrow">¶</a>
</li>
        </ol>
</section>
</div>
<div id="as-request-creation-hints">
<section id="section-5.2">
        <h3 id="name-as-request-creation-hints">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-as-request-creation-hints" class="section-name selfRef">AS Request Creation Hints</a>
        </h3>
<p id="section-5.2-1">Parameters that can appear in the AS Request Creation Hints message are specified in Section 5.3 of <span>[<a href="#I-D.ietf-ace-oauth-authz" class="xref">I-D.ietf-ace-oauth-authz</a>]</span>.
RS MUST use the "AS" parameter to transport LOC_W, i.e. an absolute URI where C can reach the AS.
RS MUST use the "audience" parameter to transport the CBOR sequence consisting of two elements: SS, the selected cipher suite; ENC_ID, the AEAD encrypted blob containing identities.
The "cnonce" parameter MUST be implied to G_X, i.e. the ephemeral public key of the RS in the underlying EDHOC exchange.
The "cnonce" parameter is not carried in the AS Request Creation Hints message for byte saving reasons.
AS Request Creation Hints MUST be carried within EAD_1.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2-2">An example EAD_1 value in CBOR diagnostic notation is shown below:<a href="#section-5.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2-3">
<pre>
EAD_1:
{
    "AS" : "coaps://as.example.com/token",
    "audience": &lt;&lt; h'73',h'737570657273...' &gt;&gt;
}
</pre><a href="#section-5.2-3" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="client-to-as-request">
<section id="section-5.3">
        <h3 id="name-client-to-as-request">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-client-to-as-request" class="section-name selfRef">Client-to-AS Request</a>
        </h3>
<p id="section-5.3-1">The protocol that provides the secure connection between C and the AS is out-of-scope.
This can, for example, be TLS 1.3.
What is important is that the two peers are mutually authenticated, and that the secure connection provides message integrity, confidentiality and freshness.
It is also necessary for the AS to be able to extract the public key of C used in the underlying security handshake.<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<p id="section-5.3-2">C sends the POST request to the token endpoint at the AS following Section 5.8.1. of <span>[<a href="#I-D.ietf-ace-oauth-authz" class="xref">I-D.ietf-ace-oauth-authz</a>]</span>.
C MUST set the "audience" parameter to the value received in AS Request Creation Hints.
C MUST set the "cnonce" parameter to G_X, the ephemeral public key of RS in the EDHOC exchange.<a href="#section-5.3-2" class="pilcrow">¶</a></p>
<p id="section-5.3-3">An example exchange using CoAP and CBOR diagnostic notation is shown below:<a href="#section-5.3-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.3-4">
<pre>
    Header: POST (Code=0.02)
    Uri-Host: "as.example.com"
    Uri-Path: "token"
    Content-Format: "application/ace+cbor"
    Payload:
    {
        "audience" : &lt;&lt; h'73',h'737570657273...' &gt;&gt;
        "cnonce" : h'756E73686172...'
    }
</pre><a href="#section-5.3-4" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="as-to-client-response">
<section id="section-5.4">
        <h3 id="name-as-to-client-response">
<a href="#section-5.4" class="section-number selfRef">5.4. </a><a href="#name-as-to-client-response" class="section-name selfRef">AS-to-Client Response</a>
        </h3>
<p id="section-5.4-1">Given successful authorization of C at the AS, the AS responds by issuing a Bearer token and retrieves the certificate of RS on behalf of C.
The access token and the certificate are passed back to C, who uses it to complete the EDHOC exchange.
This document extends the ACE framework by registering a new Access Information parameter:<a href="#section-5.4-1" class="pilcrow">¶</a></p>
<p id="section-5.4-2">rsp_ad:
     OPTIONAL. Carries additional information from the AS to C associated with the access token.<a href="#section-5.4-2" class="pilcrow">¶</a></p>
<p id="section-5.4-3">The AS-to-Client responsE MUST contain:<a href="#section-5.4-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.4-4.1">ace_profileparameter set to "edhoc-authz"<a href="#section-5.4-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.4-4.2">token_type parameter set to "Bearer"<a href="#section-5.4-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.4-4.3">access_token as specified in <a href="#voucher" class="xref">Section 4.3.2</a><a href="#section-5.4-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.4-4.4">rsp_ad = bstr .cbor cert_gx<a href="#section-5.4-4.4" class="pilcrow">¶</a>
</li>
        </ul>
<div class="alignLeft art-text artwork" id="section-5.4-5">
<pre>
cert_gx = (
    CERT_PK_U:        bstr,
    G_X:              bstr
)
</pre><a href="#section-5.4-5" class="pilcrow">¶</a>
</div>
<p id="section-5.4-6">where:<a href="#section-5.4-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.4-7.1">CERT_PK_U is the RS's certificate, as discussed in <a href="#voucher_response" class="xref">Section 4.5.2</a>. To be able to retrieve this certificate, the AS first needs to decrypt the audience value and obtain the RS's identity.<a href="#section-5.4-7.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.4-7.2">G_X is the ephemeral key generated by RS in EDHOC message_1.<a href="#section-5.4-7.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.4-8">An example AS response to C is shown below:<a href="#section-5.4-8" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.4-9">
<pre>
    2.01 Created
    Content-Format: application/ace+cbor
    Max-Age: 3600
    Payload:
    {
        "ace_profile" : "edhoc-authz",
        "token_type" : "Bearer",
        "access_token" : h'666F726571756172746572...',
        "rsp_ad" : h'61726973746F64656D6F637261746963616C...'
    }
</pre><a href="#section-5.4-9" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="sec-cons">
<section id="section-6">
      <h2 id="name-security-considerations">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-6-1">This specification builds on and reuses many of the security constructions of EDHOC, e.g. shared secret calculation and key derivation. The security considerations of EDHOC <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span> apply with modifications discussed here.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">EDHOC provides identity protection of the Initiator, disclosed to the Responder in message_3. The sending of the certificate of U in the Voucher Response provides information about the identity of the device already before message_2, which changes the identity protection properties and thus needs to be validated against a given use case. The authorization server authenticates the authenticator, receives the Voucher Request, and can perform potential other verifications before sending the Voucher Response. This allows the authorization server to restrict information about the identity of the device to parties which are authorized to have that. However, if there are multiple authorized authenticators, the authorization server may not be able to distinguish between  authenticator V which the device is connecting to and a misbehaving but authorized authenticator V' constructing a Voucher Request built from an eavesdropped message_1.
A mitigation for this kind of misbehaving authenticator is that the device discovers the identity of the authenticator through out-of-bands means before attempting to enroll, and include the optional ID_V in the ENC_ID encrypted blob. For example, the network's discovery mechanism can carry asserted information on the associated identity of the authenticator. The use of ID_V also changes the identity protection assumptions since it requires U to know the identity of V before the protocol starts. The identity of V is still protected against passive adversaries, unless disclosed by the out-of-band mechanism by which U acquires information about the identity of V. The privacy considerations whether the identity of the device or of the authenticator is more sensitive need to be studied depending on a specific use case.<a href="#section-6-2" class="pilcrow">¶</a></p>
<p id="section-6-3">For use cases where neither the early disclosure of the device nor of the authenticator identities are deemed acceptable, the device certificate must not be sent in the Voucher Response, and the identity of V must be omitted. Instead, the device certificate could be retrieved from the authorization server or other certificate repository after message_3 is received by the authenticator, using the device identifier provided in ID_CRED_I as lookup. This would require the device identity to be transported in both message_1 (in EAD_1) and message_3 but would make the protocol comply with the default identity protection provided by EDHOC.<a href="#section-6-3" class="pilcrow">¶</a></p>
<p id="section-6-4">The encryption of the device identity in the first message should consider potential information leaking from the length of the identifier ID_U, either by making all identifiers having the same length or the use of a padding scheme.<a href="#section-6-4" class="pilcrow">¶</a></p>
<p id="section-6-5">As noted Section 8.2 of <span>[<a href="#I-D.ietf-lake-edhoc" class="xref">I-D.ietf-lake-edhoc</a>]</span> an ephemeral key may be used to calculate several ECDH shared secrets. In this specification the ephemeral key G_X is also used to calculate G_XW, the shared secret with the authorization server.<a href="#section-6-5" class="pilcrow">¶</a></p>
<p id="section-6-6">The private ephemeral key is thus used in the device for calculations of key material relating to both the authenticator and the authorization server. There are different options for where to implement these calculations, one option is as an addition to EDHOC, i.e., to extend the EDHOC API in the device with input of public key of W (G_W) and identifier of U (ID_U), and produce the encryption of ID_U which is included in the external authorization data EAD_1.<a href="#section-6-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana">
<section id="section-7">
      <h2 id="name-iana-considerations">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-7-1">TODO: register rsp_ad ACE parameter<a href="#section-7-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-8">
      <h2 id="name-informative-references">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
      </h2>
<dl class="references">
<dt id="I-D.ietf-ace-oauth-authz">[I-D.ietf-ace-oauth-authz]</dt>
      <dd>
<span class="refAuthor">Seitz, L.</span>, <span class="refAuthor">Selander, G.</span>, <span class="refAuthor">Wahlstroem, E.</span>, <span class="refAuthor">Erdtman, S.</span>, and <span class="refAuthor">H. Tschofenig</span>, <span class="refTitle">"Authentication and Authorization for Constrained Environments (ACE) using the OAuth 2.0 Framework (ACE-OAuth)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-ace-oauth-authz-45</span>, <time datetime="2021-08-29" class="refDate">29 August 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-ace-oauth-authz-45.txt">https://www.ietf.org/archive/id/draft-ietf-ace-oauth-authz-45.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-lake-edhoc">[I-D.ietf-lake-edhoc]</dt>
      <dd>
<span class="refAuthor">Selander, G.</span>, <span class="refAuthor">Mattsson, J. P.</span>, and <span class="refAuthor">F. Palombini</span>, <span class="refTitle">"Ephemeral Diffie-Hellman Over COSE (EDHOC)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-lake-edhoc-12</span>, <time datetime="2021-10-20" class="refDate">20 October 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-lake-edhoc-12.txt">https://www.ietf.org/archive/id/draft-ietf-lake-edhoc-12.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-lake-reqs">[I-D.ietf-lake-reqs]</dt>
      <dd>
<span class="refAuthor">Vucinic, M.</span>, <span class="refAuthor">Selander, G.</span>, <span class="refAuthor">Mattsson, J. P.</span>, and <span class="refAuthor">D. Garcia-Carrillo</span>, <span class="refTitle">"Requirements for a Lightweight AKE for OSCORE"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-lake-reqs-04</span>, <time datetime="2020-06-08" class="refDate">8 June 2020</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-ietf-lake-reqs-04.txt">https://www.ietf.org/archive/id/draft-ietf-lake-reqs-04.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.irtf-cfrg-hpke">[I-D.irtf-cfrg-hpke]</dt>
      <dd>
<span class="refAuthor">Barnes, R. L.</span>, <span class="refAuthor">Bhargavan, K.</span>, <span class="refAuthor">Lipp, B.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Hybrid Public Key Encryption"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-hpke-12</span>, <time datetime="2021-09-02" class="refDate">2 September 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-hpke-12.txt">https://www.ietf.org/archive/id/draft-irtf-cfrg-hpke-12.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mattsson-cose-cbor-cert-compress">[I-D.mattsson-cose-cbor-cert-compress]</dt>
      <dd>
<span class="refAuthor">Raza, S.</span>, <span class="refAuthor">Höglund, J.</span>, <span class="refAuthor">Selander, G.</span>, <span class="refAuthor">Mattsson, J. P.</span>, and <span class="refAuthor">M. Furuhed</span>, <span class="refTitle">"CBOR Encoded X.509 Certificates (C509 Certificates)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mattsson-cose-cbor-cert-compress-08</span>, <time datetime="2021-02-22" class="refDate">22 February 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-mattsson-cose-cbor-cert-compress-08.txt">https://www.ietf.org/archive/id/draft-mattsson-cose-cbor-cert-compress-08.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.palombini-core-oscore-edhoc">[I-D.palombini-core-oscore-edhoc]</dt>
      <dd>
<span class="refAuthor">Palombini, F.</span>, <span class="refAuthor">Tiloca, M.</span>, <span class="refAuthor">Hoeglund, R.</span>, <span class="refAuthor">Hristozov, S.</span>, and <span class="refAuthor">G. Selander</span>, <span class="refTitle">"Combining EDHOC and OSCORE"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-palombini-core-oscore-edhoc-02</span>, <time datetime="2021-02-19" class="refDate">19 February 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-palombini-core-oscore-edhoc-02.txt">https://www.ietf.org/archive/id/draft-palombini-core-oscore-edhoc-02.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.selander-ace-coap-est-oscore">[I-D.selander-ace-coap-est-oscore]</dt>
      <dd>
<span class="refAuthor">Selander, G.</span>, <span class="refAuthor">Raza, S.</span>, <span class="refAuthor">Furuhed, M.</span>, <span class="refAuthor">Vucinic, M.</span>, and <span class="refAuthor">T. Claeys</span>, <span class="refTitle">"Protecting EST Payloads with OSCORE"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-selander-ace-coap-est-oscore-05</span>, <time datetime="2021-05-05" class="refDate">5 May 2021</time>, <span>&lt;<a href="https://www.ietf.org/archive/id/draft-selander-ace-coap-est-oscore-05.txt">https://www.ietf.org/archive/id/draft-selander-ace-coap-est-oscore-05.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
      <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3748">[RFC3748]</dt>
      <dd>
<span class="refAuthor">Aboba, B.</span>, <span class="refAuthor">Blunk, L.</span>, <span class="refAuthor">Vollbrecht, J.</span>, <span class="refAuthor">Carlson, J.</span>, and <span class="refAuthor">H. Levkowetz, Ed.</span>, <span class="refTitle">"Extensible Authentication Protocol (EAP)"</span>, <span class="seriesInfo">RFC 3748</span>, <span class="seriesInfo">DOI 10.17487/RFC3748</span>, <time datetime="2004-06" class="refDate">June 2004</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3748">https://www.rfc-editor.org/info/rfc3748</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7228">[RFC7228]</dt>
      <dd>
<span class="refAuthor">Bormann, C.</span>, <span class="refAuthor">Ersue, M.</span>, and <span class="refAuthor">A. Keranen</span>, <span class="refTitle">"Terminology for Constrained-Node Networks"</span>, <span class="seriesInfo">RFC 7228</span>, <span class="seriesInfo">DOI 10.17487/RFC7228</span>, <time datetime="2014-05" class="refDate">May 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7228">https://www.rfc-editor.org/info/rfc7228</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8152">[RFC8152]</dt>
      <dd>
<span class="refAuthor">Schaad, J.</span>, <span class="refTitle">"CBOR Object Signing and Encryption (COSE)"</span>, <span class="seriesInfo">RFC 8152</span>, <span class="seriesInfo">DOI 10.17487/RFC8152</span>, <time datetime="2017-07" class="refDate">July 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8152">https://www.rfc-editor.org/info/rfc8152</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
      <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8392">[RFC8392]</dt>
      <dd>
<span class="refAuthor">Jones, M.</span>, <span class="refAuthor">Wahlstroem, E.</span>, <span class="refAuthor">Erdtman, S.</span>, and <span class="refAuthor">H. Tschofenig</span>, <span class="refTitle">"CBOR Web Token (CWT)"</span>, <span class="seriesInfo">RFC 8392</span>, <span class="seriesInfo">DOI 10.17487/RFC8392</span>, <time datetime="2018-05" class="refDate">May 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8392">https://www.rfc-editor.org/info/rfc8392</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
      <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8446">https://www.rfc-editor.org/info/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8949">[RFC8949]</dt>
      <dd>
<span class="refAuthor">Bormann, C.</span> and <span class="refAuthor">P. Hoffman</span>, <span class="refTitle">"Concise Binary Object Representation (CBOR)"</span>, <span class="seriesInfo">STD 94</span>, <span class="seriesInfo">RFC 8949</span>, <span class="seriesInfo">DOI 10.17487/RFC8949</span>, <time datetime="2020-12" class="refDate">December 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8949">https://www.rfc-editor.org/info/rfc8949</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9031">[RFC9031]</dt>
    <dd>
<span class="refAuthor">Vučinić, M., Ed.</span>, <span class="refAuthor">Simon, J.</span>, <span class="refAuthor">Pister, K.</span>, and <span class="refAuthor">M. Richardson</span>, <span class="refTitle">"Constrained Join Protocol (CoJP) for 6TiSCH"</span>, <span class="seriesInfo">RFC 9031</span>, <span class="seriesInfo">DOI 10.17487/RFC9031</span>, <time datetime="2021-05" class="refDate">May 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9031">https://www.rfc-editor.org/info/rfc9031</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<div id="authors-addresses">
<section id="appendix-A">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Göran Selander</span></div>
<div dir="auto" class="left"><span class="org">Ericsson AB</span></div>
<div dir="auto" class="left"><span class="country-name">Sweden</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:goran.selander@ericsson.com" class="email">goran.selander@ericsson.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">John Preuß Mattsson</span></div>
<div dir="auto" class="left"><span class="org">Ericsson AB</span></div>
<div dir="auto" class="left"><span class="country-name">Sweden</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:john.mattsson@ericsson.com" class="email">john.mattsson@ericsson.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Mališa Vučinić</span></div>
<div dir="auto" class="left"><span class="org">INRIA</span></div>
<div dir="auto" class="left"><span class="country-name">France</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:malisa.vucinic@inria.fr" class="email">malisa.vucinic@inria.fr</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Michael Richardson</span></div>
<div dir="auto" class="left"><span class="org">Sandelman Software Works</span></div>
<div dir="auto" class="left"><span class="country-name">Canada</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:mcr+ietf@sandelman.ca" class="email">mcr+ietf@sandelman.ca</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Aurelio Schellenbaum</span></div>
<div dir="auto" class="left"><span class="org">Institute of Embedded Systems, ZHAW</span></div>
<div dir="auto" class="left"><span class="country-name">Switzerland</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:aureliorubendario.schellenbaum@zhaw.ch" class="email">aureliorubendario.schellenbaum@zhaw.ch</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
