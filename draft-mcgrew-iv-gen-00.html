<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Generation of Deterministic Initialization Vectors (IVs) and Nonces </title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Conventions Used In This Document">
<link href="#rfc.section.2" rel="Chapter" title="2 Deterministic IVs in Algorithms">
<link href="#rfc.section.3" rel="Chapter" title="3 Deterministic IVs in Protocols">
<link href="#rfc.section.4" rel="Chapter" title="4 Deterministic IVs in Standards">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Recommended IV/Nonce Format">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Partially Implicit IV/Nonce Format">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Unpredictable IV/Nonce Format">
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 ESP">
<link href="#rfc.section.4.5" rel="Chapter" title="4.5 IKE">
<link href="#rfc.section.4.6" rel="Chapter" title="4.6 TLS">
<link href="#rfc.section.4.7" rel="Chapter" title="4.7 SSH">
<link href="#rfc.section.4.8" rel="Chapter" title="4.8 SRTP">
<link href="#rfc.section.4.9" rel="Chapter" title="4.9 Summary">
<link href="#rfc.section.5" rel="Chapter" title="5 Imlementation">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 IV Verification">
<link href="#rfc.section.6" rel="Chapter" title="6 Testing">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Internal IV Generator">
<link href="#rfc.section.7" rel="Chapter" title="7 Issues">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Choice of Fixed-Distinct Field">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Size of the Fixed-Distinct Field">
<link href="#rfc.section.7.3" rel="Chapter" title="7.3 Security">
<link href="#rfc.section.8" rel="Chapter" title="8 Security Considerations">
<link href="#rfc.references" rel="Chapter" title="9 References">
<link href="#rfc.references.1" rel="Chapter" title="9.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="9.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="Many cryptographic algorithms use deterministic IVs, including CTR, GCM, CCM, GMAC.  This type of IV is also called a (deterministic) nonce.  Deterministic IVs must be distinct, for each fixed key, to guarantee the security of the algorithm.  This note describes best practices for the generation of such IVs, and summarizes how they are generated and used in different protocols.  Some problem areas are highlighted, and test considerations are outlined.  This note will be useful to implementers of algorithms using deterministic IVs, and to protocol or system designers using them.  " />
  <meta name="description" content="Many cryptographic algorithms use deterministic IVs, including CTR, GCM, CCM, GMAC.  This type of IV is also called a (deterministic) nonce.  Deterministic IVs must be distinct, for each fixed key, to guarantee the security of the algorithm.  This note describes best practices for the generation of such IVs, and summarizes how they are generated and used in different protocols.  Some problem areas are highlighted, and test considerations are outlined.  This note will be useful to implementers of algorithms using deterministic IVs, and to protocol or system designers using them.  " />
  <meta name="keywords" content="Encryption, Authentication" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">D.A.M. McGrew</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Cisco Systems, Inc.</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">July 04, 2011</td>
</tr>
<tr>
<td class="left">Expires: January 05, 2012</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Generation of Deterministic Initialization Vectors (IVs) and Nonces <br />
  <span class="filename">draft-mcgrew-iv-gen-00.txt</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>Many cryptographic algorithms use deterministic IVs, including CTR, GCM, CCM, GMAC.  This type of IV is also called a (deterministic) nonce.  Deterministic IVs must be distinct, for each fixed key, to guarantee the security of the algorithm.  This note describes best practices for the generation of such IVs, and summarizes how they are generated and used in different protocols.  Some problem areas are highlighted, and test considerations are outlined.  This note will be useful to implementers of algorithms using deterministic IVs, and to protocol or system designers using them.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on January 05, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Conventions Used In This Document</a>
</li>
<li>2.   <a href="#rfc.section.2">Deterministic IVs in Algorithms</a>
</li>
<li>3.   <a href="#rfc.section.3">Deterministic IVs in Protocols</a>
</li>
<li>4.   <a href="#rfc.section.4">Deterministic IVs in Standards</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Recommended IV/Nonce Format</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Partially Implicit IV/Nonce Format</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Unpredictable IV/Nonce Format</a>
</li>
<li>4.4.   <a href="#rfc.section.4.4">ESP</a>
</li>
<li>4.5.   <a href="#rfc.section.4.5">IKE</a>
</li>
<li>4.6.   <a href="#rfc.section.4.6">TLS</a>
</li>
<li>4.7.   <a href="#rfc.section.4.7">SSH</a>
</li>
<li>4.8.   <a href="#rfc.section.4.8">SRTP</a>
</li>
<li>4.9.   <a href="#rfc.section.4.9">Summary</a>
</li>
<li>5.   <a href="#rfc.section.5">Imlementation</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">IV Verification</a>
</li>
<li>6.   <a href="#rfc.section.6">Testing</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">Internal IV Generator</a>
</li>
<li>7.   <a href="#rfc.section.7">Issues</a>
</li>
<li>7.1.   <a href="#rfc.section.7.1">Choice of Fixed-Distinct Field</a>
</li>
<li>7.2.   <a href="#rfc.section.7.2">Size of the Fixed-Distinct Field</a>
</li>
<li>7.3.   <a href="#rfc.section.7.3">Security</a>
</li>
<li>8.   <a href="#rfc.section.8">Security Considerations</a>
</li>
<li>9.   <a href="#rfc.references">References</a>
</li>
<li>9.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>9.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">This note describes deterministic IVs and nonces and how they are used in cryptographic algorithms (<a href="#algos">Section 2</a>), then describes their use in protocols (<a href="#protos">Section 3</a>), and then their use in standards (<a href="#stds">Section 4</a>).  Considerations for implementation (<a href="#impl">Section 5</a>) and testing (<a href="#test">Section 6</a>) are presented.  Issues and potential problems are discussed (<a href="#issues">Section 7</a>).  The focus is on network security protocols, rather than on the security of data at rest, though many of the same considerations apply in both areas.  </p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> Conventions Used In This Document</h1>
<p id="rfc.section.1.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.  </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#algos" id="algos">Deterministic IVs in Algorithms</a>
</h1>
<p id="rfc.section.2.p.1">Many cryptographic algorithms use Initialization Vectors, or IVs.  An IV is provided to an algorithm along with a message to be processed; the IV initializes the algorithm to process the message.  Typically, there will be many IVs that are used with a single key.  Some algorithms, such as the Cipher Block Chaining (CBC) encryption mode, require that the IVs that it uses are completely unpredictable.  Such IVs are typically called random IVs, and they must be generated by a cryptographically strong random or pseudorandom process <a href="#RFC4086">[RFC4086]</a>.  </p>
<p id="rfc.section.2.p.2">Another type of IVs are deterministic IVs.  These IVs are generated by a deterministic process.  The classic example of an algorithm that uses a deterministic IV is counter (CTR) mode encryption <a href="#CTR">[CTR]</a>. An algorithm that uses deterministic IVs requires that each IV provided as input to the algorithm be distinct, for a fixed key.  </p>
<p id="rfc.section.2.p.3">A deterministic IV is sometimes called a nonce, or a deterministic nonce.  In cryptography, a nonce is a value that is used only once.  Many cryptographic protocols include a nonce in a message to enable its receiver to recognize whether or not the message has been previously received and processed.  From the point of view of a cryptographic algorithm that uses deterministic IVs, calling the IV a nonce emphasizes the role of the IV in the overall system.  Calling that value a deterministic IV emphasizes its role in initializing the algorithm to process a new message.  Nonetheless, these are different monikers for the same thing.  </p>
<p id="rfc.section.2.p.4">Authenticated Encryption is a symmetric encryption method that provides for the authenticity and integrity of the data that it protects, as well as its confidentiality <a href="#BN00">[BN00]</a> <a href="#R02">[R02]</a>.  An authenticated encryption method that uses deterministic IVs will need to make sure that the IVs used for encryption are distinct.  However, when performing the decryption operation, there is no need to ensure that the IVs are distinct; the authenticated decryption operation does not impose that requirement.  The Authenticated Encryption methods used in standards include Galois Counter Mode <a href="#GCM">[GCM]</a> and Counter and CBC MAC mode <a href="#CCM">[CCM]</a>.  </p>
<p id="rfc.section.2.p.5">Some Message Authentication Code (MACs) use deterministic IVs, including GMAC <a href="#GCM">[GCM]</a> and UMAC <a href="#RFC4118">[RFC4118]</a>.  The considerations for Authenticated Encryption also apply to these MAC algorithms: the IVs used in the generation of an authentication tag must be distinct, but there is no need to verify the distinctness of an IV prior to inputting that IV to a tag verification algorithm.  </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#protos" id="protos">Deterministic IVs in Protocols</a>
</h1>
<p id="rfc.section.3.p.1">The simplest way to implement a deterministic IV or nonce is to use a counter: initialize an integer variable to zero, then each time that an IV is needed, output the integer value, then store the incremented value after checking to make sure that no integer overflow occurred, so that no counter value is used twice.  The simplicity of this method has made it popular in practice, and recommended by standards.  </p>
<p id="rfc.section.3.p.2">The straightforward method of using a counter is not sufficient when there are multiple encryption engines that are using the same encryption key.  This can be the case when encryption is distributed across multiple processors, or across multiple software threads, processes, or virtual machines.  It can also happen in cases where a protocol allows group keys.  In these cases, some mechanism is needed that ensures that IVs are distinct across all encryption engines that use the same key.  This is easily accomplished by including a fixed field in the IV that is distinct for each distinct encrypter.  (This is detailed in <a href="#rec">Section 4.1</a>.) </p>
<p id="rfc.section.3.p.3">When a deterministic IV is used to encrypt and/or authenticate a message, the receiver(s) of that message needs to know that IV in order to decrypt it and/or verify its authenticity.  A deterministic IV can be sent along with a message, which makes it plain to the receiver(s), or it can be left out of a message if the receiver(s) have enough information to reconstruct it.  Leaving the IV out of the message reduces the amount of data that must be communicated, which is advantageous.  On the other hand, if the IV is included in the message, the receiver(s) need not be aware of the method by which the sender has chosen the IVs.  </p>
<p id="rfc.section.3.p.4">In practice, some protocols have split the difference between the implicit method (in which the IV is absent and a receiver infers its value) and the explicit method (in which the entire IV is included with the message).  The IV is constructed out of two fields: an explicit field, which is conveyed along with the message, and an implicit field, which is coordinated between the encrypter and the decrypter using an "out of band" method.  (This is detailed in <a href="#implicit">Section 4.2</a>.)  In most cases, the key management protocol that establishes the encryption key can also establish the implicit field.  </p>
<p id="rfc.section.3.p.5">In a block cipher mode of operation that use deterministic IVs, the inputs to each of the block cipher invocations during the encryption process are determined by the IV provided to that process.  It is desirable to make the inputs to the block cipher unpredictable to an attacker, to the extent that is possible, to make cryptanalytic attacks more difficult and costly to attackers.  This is true for several types of attacks, including time-memory tradeoff attacks and key collision attacks <a href="#MF00">[MF00]</a>, which are generic attacks that can reduce the cost of attacking any cipher, and cipher-specific attacks such as integral cryptanalysis <a href="#KW02">[KW02]</a>.  (It is worth noting that counter mode gives an attacker exactly what they want for integral cryptanalysis: a complete set of block cipher inputs that differ only in some bit positions.)  The cost of these attacks can be significantly increased by making the deterministic IV unpredictable to potential attackers.  This security benefit is one motivation for why the implicit field of the deterministic IV is kept secret in some protocols.  </p>
<p id="rfc.section.3.p.6">It is not hard to adapt the simple methods for constructing deterministic IVs so that they produce IVs that are unpredictable.  An easy way to do that is to have a secret value that is bitwise exclusive-ored into the IV after all of the other processing is done.  (This is detailed in <a href="#unpredict">Section 4.3</a>.)  This secret value must be known to all encrypters and decrypters, and be established via some "out of band" mechanism.  In practice, it is typically established by the key management system.  </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#stds" id="stds">Deterministic IVs in Standards</a>
</h1>
<p id="rfc.section.4.p.1">Many different protocols use deterministic IVs, including ESP <a href="#RFC4106">[RFC4106]</a>, TLS <a href="#RFC5288">[RFC5288]</a>, SSH <a href="#RFC5647">[RFC5647]</a>, and SRTP .  The way that these protocols define their IVs is outlined in this section and is summarized in <a href="#iv_use">Table 1</a>.  </p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#rec" id="rec">Recommended IV/Nonce Format</a>
</h1>
<p id="rfc.section.4.1.p.1">RFC 5116 defines the interface for Authenticated Encryption, which is the most common use of deterministic IVs at present.  That RFC recommends an IV format, which is used by ESP, IKE, TLS, and SSH.  The recommended format has a total length of 12 octets, and consists of a Fixed Field and a Counter field, and is structured as in <a href="#nonceformat">Figure 1</a>.  (See Section 3.2 of <a href="#RFC5116">[RFC5116]</a> for the precise normative description.) </p>
<div id="#rfc.figure.1"></div>
<div id="#nonceformat"></div>
<pre> 
   +-------------------------------+------------------------+
   |             Fixed             |         Counter        |
   +-------------------------------+------------------------+   
</pre>
<div id="#rfc.figure.2"></div>
<div id="#nonceformatX"></div>
<pre> 
                     Fixed      Counter
                    &lt;------&gt;&lt;--------------&gt;
          1st       5DAD87F80000000000000001
          2nd       5DAD87F80000000000000002
          3rd       5DAD87F80000000000000003
          4th       5DAD87F80000000000000004
          5th       5DAD87F80000000000000005
          ...                  ...
</pre>
<p id="rfc.section.4.1.p.2">The Fixed field remains constant for all nonces that are generated for a given encryption device. If different devices are performing encryption with a single key, then each distinct device MUST use a distinct Fixed field, to ensure the uniqueness of the nonces.  </p>
<p id="rfc.section.4.1.p.3">This format is suggested, but not required, by <a href="#CTR">[CTR]</a>.  </p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#implicit" id="implicit">Partially Implicit IV/Nonce Format</a>
</h1>
<p id="rfc.section.4.2.p.1">The case in which the recommended format is used with Partially Implicit Nonces is further detailed.  In that case, the IV is structured as in <a href="#nonceexplicit">Figure 3</a>.  </p>
<div id="#rfc.figure.3"></div>
<div id="#nonceexplicit"></div>
<pre> 
   +--------------+----------------+------------------------+
   | Fixed-Common | Fixed-Distinct |         Counter        |
   +--------------+----------------+------------------------+
    &lt;- implicit -&gt; &lt;--------------- explicit --------------&gt;
</pre>
<div id="#rfc.figure.4"></div>
<div id="#partimplicitX"></div>
<pre> 
                   Fixed  Fixed       
                   Common Distinct  Counter
                   &lt;------&gt;&lt;--&gt;&lt;----------&gt;
         1st       5DAD87F81E0E000000000001
         2nd       5DAD87F81E0E000000000002
         3rd       5DAD87F81E0E000000000003
         4th       5DAD87F81E0E000000000004
         5th       5DAD87F81E0E000000000005
         ...                 ...
</pre>
<p id="rfc.section.4.2.p.2">The portion of the IV that is stored or sent with the ciphertext is the explicit part.  The portion of the IV that is not sent with the ciphertext is the implicit part.  </p>
<p id="rfc.section.4.2.p.3">The Fixed field is divided into two sub-fields: a Fixed-Common field and a Fixed-Distinct field.  </p>
<p id="rfc.section.4.2.p.4">If different devices are performing encryption with a single key, then each distinct device MUST use a distinct Fixed-Distinct field.  The Fixed-Common field is common to all IVs.  The Fixed-Distinct field and the Counter field MUST be in the explicit part of the IV.  The Fixed-Common field MAY be in the implicit part of the IV.  </p>
<p id="rfc.section.4.2.p.5">ESP, IKE, TLS, and SSH conform to the RFC 5116 Partially Implicit Nonces format, though they do not require that the "Counter" field actually be an integer counter (instead, "anything that guarantees uniqueness can be used").  </p>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#unpredict" id="unpredict">Unpredictable IV/Nonce Format</a>
</h1>
<p id="rfc.section.4.3.p.1">This method is shown in <a href="#unpred">Figure 5</a>, in which the symbol (+) denotes the bitwise exclusive-or operation.  (Here the Fixed field consists of the Fixed-Common field followed by the Fixed-Distinct field.)  This format uses a Randomizer, which is an octet string that is combined with the other fields to make the IVs unpredictable.  The length of the Randomizer must be no greater than the sum of the lengths of the Fixed and Counter fields.  </p>
<p id="rfc.section.4.3.p.2">The next IV in sequence is computed as follows. The Fixed field and the Counter field are concatenated.  If the length of the Randomizer is less than the combined length of the Fixed and Counter fields, then the Randomizer is padded on the right with enough zeros so that the padded value has a length that exactly matches that of the Fixed and Counter fields together.  The concatenated Fixed and Counter field is bitwise exclusive-ored with the padded Randomizer, and the resulting value is the IV.  The Counter is incremented, treating it as an unsigned integer with the most significant byte on the left, and the stored Counter field is set to the incremented value.  Then the IV is returned.  This is the method used by SRTP <a href="#RFC3711">[RFC3711]</a>, wherein the Randomizer field is called "Salt".  (We do not use the term Salt in this note because some other specifications use that term differently, such as <a href="#RFC4309">[RFC4309]</a>.) </p>
<div id="#rfc.figure.5"></div>
<div id="#unpred"></div>
<pre>
              +-----------------+-----------------+
              |     Fixed       |      Counter    |---+
              +-----------------+-----------------+   |
                                                      |
              +-----------------------------------+   v
              |             Randomizer                |-&gt;(+)
              +-----------------------------------+   |
                                                      |
              +-----------------------------------+   |
              |       Initialization Vector       |&lt;--+
              +-----------------------------------+
  
</pre>
<div id="#rfc.figure.6"></div>
<div id="#unpredX"></div>
<pre> 
             Fixed  Fixed                                 
             Common Distinct   Counter            IV         
              &lt;--&gt;&lt;------&gt;&lt;----------&gt;  &lt;----------------------&gt; 
    1st       000097B4AE8F000000000001  0C81C77A5DDB678EE16FA2D0
    2nd       000097B4AE8F000000000002  0C81C77A5DDB678EE16FA2D3
    3rd       000097B4AE8F000000000003  0C81C77A5DDB678EE16FA2D2
    4th       000097B4AE8F000000000004  0C81C77A5DDB678EE16FA2D5
    5th       000097B4AE8F000000000005  0C81C77A5DDB678EE16FA2D4
    ...                     ...
</pre>
<h1 id="rfc.section.4.4">
<a href="#rfc.section.4.4">4.4.</a> ESP</h1>
<p id="rfc.section.4.4.p.1">In the IP Encapsulating Security Payload (ESP) <a href="#RFC3686">[RFC3686]</a><a href="#RFC4106">[RFC4106]</a><a href="#RFC4309">[RFC4309]</a> the implicit and explicit parts are four and eight bytes long, respectively.  The exception is <a href="#RFC4309">[RFC4309]</a>, for which the implicit part is three bytes in length.  The Fixed-Common field is four bytes, and its value is set by the Internet Key Exchange (IKE).  (This field is named inconsistently, being called Nonce in <a href="#RFC3686">[RFC3686]</a>, and Salt in <a href="#RFC4106">[RFC4106]</a> and <a href="#RFC4309">[RFC4309]</a>.)  When ESP is used with IKE, there is exactly one entity performing encryption, and the Fixed-Distinct part is usually not present (or equivalently, is has a length of zero bytes).  When ESP is used with a group key management protocol such as GDOI, the Fixed-Distinct field may be two or four bytes in length, and the value of the Fixed-Distinct field to be used by an encrypter is established by the group key management protocol <a href="#RFC6054">[RFC6054]</a>.  The case in which IKE is used with ESP and there are multiple encryption engines is not specifically addressed by the standards, but it can be handled by the use of a nonzero Fixed-Distinct field.  </p>
<h1 id="rfc.section.4.5">
<a href="#rfc.section.4.5">4.5.</a> IKE</h1>
<p id="rfc.section.4.5.p.1">The Internet Key Exchange (IKE) <a href="#RFC5282">[RFC5282]</a> uses the recommended IV/nonce format.  The Fixed-Common field is four bytes in length, and its value is set from the IKE Keying Material.  The Fixed-Distinct part is usually zero bytes, but it may be any number of bytes if there are multiple encrypters in use.  </p>
<h1 id="rfc.section.4.6">
<a href="#rfc.section.4.6">4.6.</a> TLS</h1>
<p id="rfc.section.4.6.p.1">In Transport Layer Security (TLS) <a href="#RFC5288">[RFC5288]</a>, the Fixed-Common field is four bytes in length, and the Fixed-Distinct part is usually zero bytes, but it may be any number of bytes when there are multiple encrypters in use.  Section 6.2 of <a href="#RFC5288">[RFC5288]</a> gives an example of TLS deterministic IV formation.  </p>
<h1 id="rfc.section.4.7">
<a href="#rfc.section.4.7">4.7.</a> SSH</h1>
<p id="rfc.section.4.7.p.1">In the Secure Shell (SSH) protocol <a href="#RFC5647">[RFC5647]</a> the Fixed-Common field is not present, the Fixed-Distinct field is four bytes long, and the Counter field is eight bytes in length.  The implicit part is not present, and the explicit part contains the entire 12 byte IV.  </p>
<h1 id="rfc.section.4.8">
<a href="#rfc.section.4.8">4.8.</a> SRTP</h1>
<p id="rfc.section.4.8.p.1">In the Secure Real-time Transport Protocol (SRTP) <a href="#RFC3711">[RFC3711]</a> and draft-ietf-avt-srtp-aes-gcm-01 the IV formation is a bit more complex than RFC 5116.  It is essentially RFC 5116 format with the additional step of performing a bitwise exclusive-or operation with a Randomizer value.  (This step provides additional strength against cryptographic attacks that rely on predicting all or most of the IV.)  draft-ietf-avt-srtp-aes-gcm-01 uses a 12-byte IV, though RFC 3711 uses a 14-byte IV.  </p>
<h1 id="rfc.section.4.9">
<a href="#rfc.section.4.9">4.9.</a> Summary</h1>
<p id="rfc.section.4.9.p.1">The following table gives a synopsis of how standard protocols use deterministic IVs.  </p>
<div id="#rfc.table.1"></div>
<div id="#iv_use"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<caption>Fields in Deterministic IVs, by Protocol.</caption>
<thead><tr>
<th class="center">Protocol</th>
<th class="center">IV (bytes)</th>
<th class="center">Fixed-Common (bytes)</th>
<th class="center">Fixed-Distinct (bytes)</th>
<th class="center">Counter (bytes)</th>
</tr></thead>
<tbody>
<tr>
<td class="center">ESP</td>
<td class="center">12 </td>
<td class="center">4  </td>
<td class="center">0,1,2,[4]</td>
<td class="center">8,7,6,[4]</td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Not on wire</td>
<td class="center">On wire</td>
<td class="center">On wire </td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Set by IKE </td>
<td class="center"></td>
<td class="center"></td>
</tr>
<tr>
<td class="center">ESP</td>
<td class="center">11 </td>
<td class="center">3  </td>
<td class="center">0,1,2,[4]</td>
<td class="center">8,7,6,[4]</td>
</tr>
<tr>
<td class="center">
<a href="#RFC4309">[RFC4309]</a> </td>
<td class="center"></td>
<td class="center">Not on wire</td>
<td class="center">On wire</td>
<td class="center">On wire </td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Set by IKE </td>
<td class="center"></td>
<td class="center"></td>
</tr>
<tr>
<td class="center">IKE</td>
<td class="center">12 </td>
<td class="center">4  </td>
<td class="center">Unspecified </td>
<td class="center">Unspecified </td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Not on wire</td>
<td class="center">On wire</td>
<td class="center">On wire </td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Set from KM </td>
<td class="center"></td>
<td class="center"></td>
</tr>
<tr>
<td class="center">TLS</td>
<td class="center">12 </td>
<td class="center">4  </td>
<td class="center">0-8</td>
<td class="center">8-0</td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Not on wire</td>
<td class="center">On wire</td>
<td class="center">On wire </td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Set by TLS </td>
<td class="center"></td>
<td class="center"></td>
</tr>
<tr>
<td class="center">SSH</td>
<td class="center">12 </td>
<td class="center">0  </td>
<td class="center">4</td>
<td class="center">8</td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center"></td>
<td class="center">On wire</td>
<td class="center">On wire </td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center"></td>
<td class="center">Unspecified </td>
<td class="center"></td>
</tr>
<tr>
<td class="center">SRTP-CTR </td>
<td class="center">14 </td>
<td class="center">4  </td>
<td class="center">4 </td>
<td class="center">6</td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Not on wire </td>
<td class="center">Not on wire</td>
<td class="center">Not on wire </td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Set by KM </td>
<td class="center"></td>
<td class="center"></td>
</tr>
<tr>
<td class="center">SRTP-GCM</td>
<td class="center">12 </td>
<td class="center">2  </td>
<td class="center">4</td>
<td class="center">6</td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Not on wire</td>
<td class="center">Not on wire </td>
<td class="center">Not on wire </td>
</tr>
<tr>
<td class="center"></td>
<td class="center"></td>
<td class="center">Set by KM </td>
<td class="center"></td>
<td class="center"></td>
</tr>
</tbody>
</table>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#impl" id="impl">Imlementation</a>
</h1>
<p id="rfc.section.5.p.1">A cryptographic implementation typically consists of a self-contained and testable module that implements all of the essential functionality that it needs.  This functionality should include the generation of deterministic IVs.  </p>
<p id="rfc.section.5.p.2">Because of the variety of ways in which IVs are formed in different protocols, implementers may be tempted to put the generation of the IV under the control of the protocol implementation.  That is, from the point of view of the application making use of the encryption algorithm, the IV is an input to that algorithm, as shown in <a href="#archbad">Figure 7</a>.  Regardless, it is not good for security to have the IV be generated outside the crypto module.  It is possible to implement an IV Generator that can be used with all of the protocols outlined above and use it inside of a cryptographic module.  In the following we outline how that can be done.  </p>
<div id="#rfc.figure.7"></div>
<div id="#archbad"></div>
<pre>
        +----------------------+
        |  +--------------+    |      IV       +-------------+
        |  |              |&lt;-------------------|             |
        |  |  Encryption  |    |   Plaintext   |             |
        |  |  Algorithm   |&lt;-------------------| Application |
        |  |              |    |   Ciphertext  |             |
        |  |              |-------------------&gt;|             |
        |  +--------------+    |               +-------------+
        |                      |
        | Cryptographic Module |
        +----------------------+  
</pre>
<p id="rfc.section.5.p.3">The internal IV generator architecture is illustrated in <a href="#archgood">Figure 8</a>.  The cryptographic module contains an IV Generator sub-module that understands the IV formats outlined in <a href="#protos">Section 3</a>.  To initialize the IV generator, the application inputs the parameter values to be used.  Once initialized, the IV generator will produce successive IVs on request, and send these values to the algorithm and to the calling application.  The encryption algorithm will need the entire IV, but if the partially implicit IV format is in use, only the explicit part of the IV needs to be provided to the application.   The IV generator is responsible for ensuring the distinctness of all of the IVs that it generates.  </p>
<div id="#rfc.figure.8"></div>
<div id="#archgood"></div>
<pre>
        +----------------------+
        |  +--------------+    |
        |  | IV Generator |-----------+
        |  +--------------+    |      | IV (explicit part)
        |         | IV         |      | 
        |         v            |      |
        |  +--------------+    |      |        +-------------+
        |  |              |           +-------&gt;|             |
        |  |  Encryption  |    |   Plaintext   |             |
        |  |  Algorithm   |&lt;-------------------| Application |
        |  |              |    |   Ciphertext  |             |
        |  |              |-------------------&gt;|             |
        |  +--------------+    |               +-------------+
        |                      |
        | Cryptographic Module |
        +----------------------+  
</pre>
<p id="rfc.section.5.p.4">More formally, an IV generator supports the operations of Initialize and Output Next IV.  The Initialize operation prepares an IV Generator for use with a particular set of parameters.  It takes the following inputs: </p>

<ul class="empty">
<li>A nonnegative integer indicating the number of bytes in the IV to be generated.  All of the IVs output from the Generator will have the same length.  </li>
<li>An octet string indicating the Fixed part of the IV; this value will be used as the initial part in each IV that is generated.  </li>
<li>A nonnegative integer indicating the number of bytes in the Fixed part of the IV.  This value must be no greater than the number of bytes in the IV.  </li>
<li>An octet string indicating the salt value to be exclusive-ored with the other fields of the IV.  If no salt is to be used when Generating IVs, then this parameter must not be present.  </li>
<li>A nonnegative integer indicating the number of bytes in the salt value.  If no salt value is used, this parameter must be zero.  If a salt value is used, this parameter must be no greater than the number of bytes in the IV.  </li>
</ul>

<p> The Fixed field consists of the Fixed-Common field, followed by the Fixed-Distinct field.  The Fixed field and Salt field are stored when the IV generator is initialized; at that time, the Counter field is initialized to zero.  The length of the Counter field is equal to the length of the IV less the length of the Fixed field.  If the Salt field is shorter than the IV, then it is padded on the right with zeroes.  If no Salt is to be used, this is conceptually equivalent to having a Salt value that is the all-zero value.  </p>
<p id="rfc.section.5.p.5">The Output Next IV operation returns the next IV in sequence, or it returns an indication that there are no more IVs that are available.  During that operation, the IV is computed as follows.  First, the Fixed field and the Counter field are concatenated, then they are bitwise exclusive-ored with the Salt field, and the resulting value is the IV.  The Counter is incremented, treating it as an unsigned integer with the most significant byte on the left, and the stored Counter field is set to the incremented value.  Then the IV is returned.  </p>
<p id="rfc.section.5.p.6">The IV generator should also be able to output the length of the explicit field, so that an algorithm can output only the explicit part, when that is appropriate.  </p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> IV Verification</h1>
<p id="rfc.section.5.1.p.1">In some protocols, the IV is constructed out of fields in the protocol in such a way that it is difficult to have the IVs generated inside of the cryptographic module, without requiring that module to contain protocol-specific logic.  In this case, assurance of the uniqueness of IVs can be provided by having the IVs be generated by the protocol, but checked by the cryptographic module.  </p>
<p id="rfc.section.5.1.p.2">This approach is taken by many implementations of Secure RTP <a href="#RFC3711">[RFC3711]</a>.  The IV in that protocol is constructued in a way that incorporates a sender identifier (the SSRC field) and the protocol's sequence number.  To check the sequence number for uniqueness, an implementation can make use of the anti-replay checking that the protocol uses to check inbound packet.  An encrypter can use this approach as well, to make sure that the sequence number used to construct the IV is unique.  (Of course, it is necessary to have an IV construction method such that the uniqueness of the sequence number ensures the uniqueness of the IV.)  Since many cryptographic protocols contain a function to perform anti-replay check based on a sequence number, this is a convenient strategy.  </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#test" id="test">Testing</a>
</h1>
<p id="rfc.section.6.p.1">The testing of a cryptographic module is an important step in assessing the assurance of that module.  The IV Generator defined in <a href="#impl">Section 5</a> can be tested by an external system to verify that it is operating correctly.  </p>
<p id="rfc.section.6.p.2">The recommended IV format can be tested by verifying that all of the IVs are distinct.   There are many ways that this can be done; for instance, the command "sort | uniq -d" on POSIX systems can be used to detect repeated lines in a file.  </p>
<p id="rfc.section.6.p.3">An important aspect of an IV generator is that, when it has an N byte Counter field, it should not generate more than (256)^N IVs.  This property should be tested for small values of N (at least 1, 2, and 3), by calling the Output Next IV operation M times, for some M &gt; (256)^N.  Note that some implementations may produce fewer than (256)^N IVs, e.g. due to their handling of the all-zero IV.  That would not affect security.  </p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> Internal IV Generator</h1>
<p id="rfc.section.6.1.p.1">When a cryptographic module uses an internal IV generator, only the explicit part of the IV needs to be output from the module.  It is possible to test this use of the IV generator by interacting with an encryption algorithm that uses it (or an Authenticated Encryption algorithm, or a MAC).  </p>
<p id="rfc.section.6.1.p.2">The encryption operation takes as input a plaintext, and returns a ciphertext and the explicit part of the IV.  To test that the IV generator is working properly, call the encryption operation repeatedly, each time with the same plaintext value, and verify that 1) all of the ciphertexts returned are distinct, and 2) all of the explicit parts that are returned are distinct.  The plaintext must be at least 32 bytes long, in order to avoid false positives.  </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#issues" id="issues">Issues</a>
</h1>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> Choice of Fixed-Distinct Field</h1>
<p id="rfc.section.7.1.p.1">When considering what data should go into a Fixed-Distinct field, it is tempting to use system values such as network addresses because they appear to meet the criteria of uniqueness.  However, there are several significant problems with this idea.  System values that are taken from outside the cryptographic module may not actually be distinct, especially if an attacker can influence the system.  System values can also change over time; even if they are actually distinct, they may not be fixed.  Lastly, the cryptographic system should have the freedom to put distinct data into the Fixed-Distinct fields, so that it can accommodate multiple encryption engines when they occur.  </p>
<p id="rfc.section.7.1.p.2">Internet Protocol (IP) version four addresses are four bytes in length, and thus can fit into the Fixed-Distinct field of a 12-byte IV.  However, an IP address is highly unsuitable for this purpose.  Most networked devices use dynamically assigned IP addresses, with address assignment via an automatic configuration protocol such as the Dynamic Host Configuration Protocol (DHCP).  The addresses are determined by an external system and are communicated over an insecure protocol; furthermore, a DHCP address is only valid for a particular period of time, and may change after that lease has expired.  Even when an automatic configuration protocol is not in use, IP addresses are determined by the networking subsystem, and are not under the control of the cryptographic module.  Network Address Translation (NAT, <a href="#RFC1361">[RFC1361]</a>) is commonly used to modify the IP addresses of packets as they traverse a network boundary, for instance between a private address space <a href="#RFC1918">[RFC1918]</a> and the Internet.  Because of NAT, the IP address associated with a particular device will not be consistent throughout the network.  Multiple devices can use the same addresses; this technique is utilized in order to provide redundancy or load sharing (see the Virtual Router Redundancy Protocol <a href="#RFC3768">[RFC3768]</a> for instance).  Lastly, IPv4 is currently being replaced by version six of that protocol.  IPv6 addresses are sixteen bytes long; this is too long for inclusion in an IV, and the coexistence of both versions on the Internet is likely to increase the use of NAT for protocol translation <a href="#RFC6146">[RFC6146]</a>.  In summary, IP addresses are neither fixed nor distinct, and should not be used in a Fixed-Distinct field.  </p>
<p id="rfc.section.7.1.p.3">Similar considerations hold for link layer addresses, Domain Name System (DNS) names, and TCP, UDP, and SCTP ports.  </p>
<p id="rfc.section.7.1.p.4">A much better solution is to have the Fixed-Distinct field be assigned by the security system.  For instance, if a cryptographic module has multiple encrypters, it can assign that field appropriately for each encrypter.  </p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> Size of the Fixed-Distinct Field</h1>
<p id="rfc.section.7.2.p.1">Deterministic IVs typically have an explicit part that is eight bytes in length.  (This size is natural to use with a block cipher that has a 16 byte block width, because no more than (256)^8 packets can be encrypted under a single key without encountering security degradation due to the birthday paradox.)  Because the Fixed-Distinct field must appear in the explicit part, larger Fixed-Distinct fields will reduce the number of IVs that can be generated.  This can be problematic, especially for high throughput situations.  For instance, the ESP protocol allows for up to 2^64 packets to be encrypted under a single key, so it is desirable to use a Counter field that is close to eight bytes in length; this is why <a href="#RFC6054">[RFC6054]</a> encourages the use of short values in the Fixed-Distinct field.  <a href="#times">Table 2</a> presents the lifetimes of a single key that can encrypt 2^32 packets, i.e.  a key being used with a four-byte Counter field.  At high data rates, keys must be replaced quickly.  </p>
<p></p>
<div id="#rfc.table.2"></div>
<div id="#times"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<caption>Key Lifetimes with a four-byte Counter field</caption>
<thead><tr>
<th class="center"></th>
<th class="center">Best Case </th>
<th class="center">Typical Case </th>
<th class="center">Worst Case </th>
</tr></thead>
<tbody>
<tr>
<td class="center"></td>
<td class="center">9000 byte packets </td>
<td class="center">850 byte packets  </td>
<td class="center">64 byte packets   </td>
</tr>
<tr>
<td class="center">1 Gbps	       </td>
<td class="center">3 days	       </td>
<td class="center">8.6 hours	       </td>
<td class="center">66 minutes	       </td>
</tr>
<tr>
<td class="center">10 Gbps	       </td>
<td class="center">8.6 hours	       </td>
<td class="center">52 minutes	       </td>
<td class="center">6.6 minutes       </td>
</tr>
<tr>
<td class="center">40 Gbps	       </td>
<td class="center">22 minutes	       </td>
<td class="center">13 minutes	       </td>
<td class="center">1.6 minutes       </td>
</tr>
<tr>
<td class="center">100 Gbps	       </td>
<td class="center">8.9 minutes       </td>
<td class="center">5.2 minutes       </td>
<td class="center">0.7 minutes       </td>
</tr>
</tbody>
</table>
<h1 id="rfc.section.7.3">
<a href="#rfc.section.7.3">7.3.</a> Security</h1>
<p id="rfc.section.7.3.p.1">As long as each deterministic IV is distinct, for each key, then security is assured.  However, when deterministic IVs are not distinct, security suffers.  </p>
<p id="rfc.section.7.3.p.2">The number of deterministic IVs is limited, regardless of how those IVs are generated.  What does an encrypter do when no more IVs are available?  It should retire the key that it is currently using, and establish another one.  This is the reason that the IETF Guidelines for Cryptographic Key Management <a href="#RFC4107">[RFC4107]</a> require that automated key management be used for algorithms with deterministic IVs.  For network security protocols, this has proven to be an effective strategy.  </p>
<p id="rfc.section.7.3.p.3">Particular care must be taken in Virtual Machine (VM) environments, because the VM cloning and rollback processes can cause inadvertent re-use of deterministic IVs.  This is just one of many security problems that can result from uncritical application of VM mechanisms when cryptography is in use <a href="#GR05">[GR05]</a>.  </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Security Considerations</h1>
<p id="rfc.section.8.p.1">Cryptographic algorithms that rely on deterministic IVs or nonces must ensure the uniqueness of those values.  The recommendations in this note aim to help implementers achieve that goal.  </p>
<p id="rfc.section.8.p.2">Implementations should use the nonce formats described in <a href="#protos">Section 3</a>.  The way in which these formats are used in standards is summarized in <a href="#iv_use">Table 1</a>.  </p>
<p id="rfc.section.8.p.3">Implementations should use the internal IV generator described in <a href="#impl">Section 5</a>.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">9.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">9.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC1361">[RFC1361]</b></td>
<td class="top">
<a href="mailto:mills@udel.edu" title="University of Delaware, Electrical Engineering Department">Mills, D.L.</a>, "<a href="http://tools.ietf.org/html/rfc1361">Simple Network Time Protocol (SNTP)</a>", RFC 1361, August 1992.</td>
</tr>
<tr>
<td class="reference"><b id="RFC1918">[RFC1918]</b></td>
<td class="top">
<a href="mailto:yakov@cisco.com" title="Cisco systems">Rekhter, Y.</a>, <a href="mailto:rgm3@is.chrysler.com" title="Chrysler Corporation">Moskowitz, R.</a>, <a href="mailto:Daniel.Karrenberg@ripe.net" title="RIPE Network Coordination Centre">Karrenberg, D.</a>, <a href="mailto:GeertJan.deGroot@ripe.net" title="RIPE Network Coordination Centre">Groot, G.</a> and <a href="mailto:lear@sgi.com" title="Silicon Graphics, Inc.">E. Lear</a>, "<a href="http://tools.ietf.org/html/rfc1918">Address Allocation for Private Internets</a>", BCP 5, RFC 1918, February 1996.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3768">[RFC3768]</b></td>
<td class="top">
<a>Hinden, R.</a>, "<a href="http://tools.ietf.org/html/rfc3768">Virtual Router Redundancy Protocol (VRRP)</a>", RFC 3768, April 2004.</td>
</tr>
<tr>
<td class="reference"><b id="GCM">[GCM]</b></td>
<td class="top">
<a title="U. S. National Institute of Standards and Technology (NIST)">Dworkin, M.</a>, "<a>NIST Special Publication 800-38D: Recommendation for Block Cipher Modes of Operation: Galois/Counter Mode (GCM) and GMAC. </a>", U.S. National Institute of Standards and Technology http://csrc.nist.gov/publications/nistpubs/800-38D/SP800-38D.pdf, .</td>
</tr>
<tr>
<td class="reference"><b id="MF00">[MF00]</b></td>
<td class="top">
<a>McGrew, D.</a> and <a>S. Fluhrer</a>, "<a>Attacks on Additive Encryption of Redundant Plaintext and Implications on Internet Security </a>", Proceedings of the Seventh Annual Workshop               on Selected Areas in Cryptography (SAC 2000) Spinger-Verlag, .</td>
</tr>
<tr>
<td class="reference"><b id="CCM">[CCM]</b></td>
<td class="top">
<a title="U. S. National Institute of Standards and Technology (NIST)">Dworkin, M.</a>, "<a>NIST Special Publication 800-38C: The CCM Mode for Authentication and Confidentiality</a>", U.S. National Institute of Standards and Technology http://csrc.nist.gov/publications/nistpubs/800-38C/SP800-38C.pdf, .</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">9.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="BN00">[BN00]</b></td>
<td class="top">
<a>Bellare, M.</a> and <a>C. Namprempre</a>, "<a>Authenticated encryption: Relations among notions and analysis of the generic composition paradigm</a>", Proceedings of ASIACRYPT 2000, Springer-Verlag, LNCS 1976, pp. 531-545 http://www-cse.ucsd.edu/users/mihir/papers/oem.html, .</td>
</tr>
<tr>
<td class="reference"><b id="R02">[R02]</b></td>
<td class="top">
<a>Rogaway, P.</a>, "<a>Authenticated encryption with Associated-Data</a>", ACM Conference on Computer and Communication Security (CCS'02), pp. 98-107, ACM Press, 2002. http://www.cs.ucdavis.edu/~rogaway/papers/ad.html, .</td>
</tr>
<tr>
<td class="reference"><b id="GR05">[GR05]</b></td>
<td class="top">
<a>Garfinkel, T.</a> and <a>M. Rosenblum</a>, "<a>When Virtual is Harder than Real: Security Challenges in Virtual Machine Based Computing Environments </a>", Proceedings of the 10th Workshop on Hot Topics in Operating Systems http://www.stanford.edu/~talg/papers/HOTOS05/virtual-harder-hotos05.pdf, .</td>
</tr>
<tr>
<td class="reference"><b id="RFC3711">[RFC3711]</b></td>
<td class="top">
<a>Baugher, M.</a>, <a>McGrew, D.</a>, <a>Naslund, M.</a>, <a>Carrara, E.</a> and <a>K. Norrman</a>, "<a href="http://tools.ietf.org/html/rfc3711">The Secure Real-time Transport Protocol (SRTP)</a>", RFC 3711, March 2004.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4106">[RFC4106]</b></td>
<td class="top">
<a>Viega, J.</a> and <a>D. McGrew</a>, "<a href="http://tools.ietf.org/html/rfc4106">The Use of Galois/Counter Mode (GCM) in IPsec Encapsulating Security Payload (ESP)</a>", RFC 4106, June 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4309">[RFC4309]</b></td>
<td class="top">
<a>Housley, R.</a>, "<a href="http://tools.ietf.org/html/rfc4309">Using Advanced Encryption Standard (AES) CCM Mode with IPsec Encapsulating Security Payload (ESP)</a>", RFC 4309, December 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5116">[RFC5116]</b></td>
<td class="top">
<a>McGrew, D.</a>, "<a href="http://tools.ietf.org/html/rfc5116">An Interface and Algorithms for Authenticated Encryption</a>", RFC 5116, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5282">[RFC5282]</b></td>
<td class="top">
<a>Black, D.</a> and <a>D. McGrew</a>, "<a href="http://tools.ietf.org/html/rfc5282">Using Authenticated Encryption Algorithms with the Encrypted Payload of the Internet Key Exchange version 2 (IKEv2) Protocol</a>", RFC 5282, August 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5288">[RFC5288]</b></td>
<td class="top">
<a>Salowey, J.</a>, <a>Choudhury, A.</a> and <a>D. McGrew</a>, "<a href="http://tools.ietf.org/html/rfc5288">AES Galois Counter Mode (GCM) Cipher Suites for TLS</a>", RFC 5288, August 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5647">[RFC5647]</b></td>
<td class="top">
<a>Igoe, K.</a> and <a>J. Solinas</a>, "<a href="http://tools.ietf.org/html/rfc5647">AES Galois Counter Mode for the Secure Shell Transport Layer Protocol</a>", RFC 5647, August 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6054">[RFC6054]</b></td>
<td class="top">
<a>McGrew, D.</a> and <a>B. Weis</a>, "<a href="http://tools.ietf.org/html/rfc6054">Using Counter Modes with Encapsulating Security Payload (ESP) and Authentication Header (AH) to Protect Group Traffic</a>", RFC 6054, November 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6146">[RFC6146]</b></td>
<td class="top">
<a>Bagnulo, M.</a>, <a>Matthews, P.</a> and <a>I. van Beijnum</a>, "<a href="http://tools.ietf.org/html/rfc6146">Stateful NAT64: Network Address and Protocol Translation from IPv6 Clients to IPv4 Servers</a>", RFC 6146, April 2011.</td>
</tr>
<tr>
<td class="reference"><b id="KW02">[KW02]</b></td>
<td class="top">
<a>Knudsen, L.</a> and <a>D. Wagner</a>, "<a>Integral Cryptanalysis </a>", 9th International Workshop on Fast Software Encryption (FSE '02) http://eprint.iacr.org/2004/193, December 2001.</td>
</tr>
<tr>
<td class="reference"><b id="CTR">[CTR]</b></td>
<td class="top">
<a>Dworkin, M.</a>, "<a>NIST Special Publication 800-38: Recommendation for Block Cipher Modes of Operation </a>", U.S. National Institute of Standards and Technology http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf, .</td>
</tr>
<tr>
<td class="reference"><b id="RFC4086">[RFC4086]</b></td>
<td class="top">
<a>Eastlake, D.</a>, <a>Schiller, J.</a> and <a>S. Crocker</a>, "<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>", BCP 106, RFC 4086, June 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4118">[RFC4118]</b></td>
<td class="top">
<a>Yang, L.</a>, <a>Zerfos, P.</a> and <a>E. Sadot</a>, "<a href="http://tools.ietf.org/html/rfc4118">Architecture Taxonomy for Control and Provisioning of Wireless Access Points (CAPWAP)</a>", RFC 4118, June 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3686">[RFC3686]</b></td>
<td class="top">
<a>Housley, R.</a>, "<a href="http://tools.ietf.org/html/rfc3686">Using Advanced Encryption Standard (AES) Counter Mode With IPsec Encapsulating Security Payload (ESP)</a>", RFC 3686, January 2004.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4107">[RFC4107]</b></td>
<td class="top">
<a>Bellovin, S.</a> and <a>R. Housley</a>, "<a href="http://tools.ietf.org/html/rfc4107">Guidelines for Cryptographic Key Management</a>", BCP 107, RFC 4107, June 2005.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">David A. McGrew</span> 
	  <span class="n hidden">
		<span class="family-name">McGrew</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>510 McCarthy Blvd.</span>

	  <span class="vcardline">
		<span class="locality">Milpitas</span>,  
		<span class="region">CA</span> 
		<span class="code">95035</span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">Phone: (408) 525 8651</span>

<span class="vcardline">EMail: <a href="mailto:mcgrew@cisco.com">mcgrew@cisco.com</a></span>

<span class="vcardline">URI: <a href="http://www.mindspring.com/~dmcgrew/dam.htm">http://www.mindspring.com/~dmcgrew/dam.htm</a></span>

  </address>
</div>

</body>
</html>