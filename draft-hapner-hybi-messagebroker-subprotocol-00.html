<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>The MessageBroker WebSocket Subprotocol</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 MBWS Functionality">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Connection Recovery">
<link href="#rfc.section.2.1.1" rel="Chapter" title="2.1.1 MBWS Connections">
<link href="#rfc.section.2.1.2" rel="Chapter" title="2.1.2 New MBWS Control Frames">
<link href="#rfc.section.2.1.3" rel="Chapter" title="2.1.3 Connection Name and Connection Recovery">
<link href="#rfc.section.2.1.4" rel="Chapter" title="2.1.4 Message Synchronization of a Recovered MBWS Connection">
<link href="#rfc.section.2.1.4.1" rel="Chapter" title="2.1.4.1 Server-message-delivery-resync">
<link href="#rfc.section.2.1.4.2" rel="Chapter" title="2.1.4.2 Client-message-delivery-resync">
<link href="#rfc.section.2.1.5" rel="Chapter" title="2.1.5 Message Metadata">
<link href="#rfc.section.2.1.5.1" rel="Chapter" title="2.1.5.1 Address">
<link href="#rfc.section.2.1.5.1.1" rel="Chapter" title="2.1.5.1.1 Undeliverable Messages">
<link href="#rfc.section.2.1.5.2" rel="Chapter" title="2.1.5.2 Content-Type">
<link href="#rfc.section.2.1.5.3" rel="Chapter" title="2.1.5.3 Property List">
<link href="#rfc.section.3" rel="Chapter" title="3 Additional Issues">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Message Content and Message Fragmentation">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 REST Prior to Session Upgrade">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Sec-WebSocket-Protocol Field">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Client Identity">
<link href="#rfc.section.3.5" rel="Chapter" title="3.5 Message Security">
<link href="#rfc.section.4" rel="Chapter" title="4 Scenarios">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 MBWS Connection Recovery Scenario">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 MBLWS Session Scenario">
<link href="#rfc.section.5" rel="Chapter" title="5 Issues Outside the Scope of this Document">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Messaging Scope">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Message Acknowledgement Interval">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 Synchronous Messaging">
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 End-to-End Reliability">
<link href="#rfc.references" rel="Chapter" title="6 References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="The WebSocket protocol " />
  <meta name="description" content="The WebSocket protocol " />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">M.W. Hapner, Ed.</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Huawei</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">C. Suconic</td>
</tr>
<tr>
<td class="left">Expires: March 04, 2012</td>
<td class="right">redhat</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">September 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">The MessageBroker WebSocket Subprotocol<br />
  <span class="filename">draft-hapner-hybi-messagebroker-subprotocol-00</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>The WebSocket protocol <a href="#I-D.ietf-hybi-thewebsocketprotocol">[I-D.ietf-hybi-thewebsocketprotocol]</a> provides a subprotocol extension facility. The MessageBroker WebSocket Subprotocol (MBWS) is a WebSocket Subprotocol used by messaging clients to send messages to, and receive messages from an internet message broker (herein called a message broker). A message broker is a messaging intermediary that queues messages sent by its clients for asynchronous delivery to its clients. </p>
<p>Messages are addressed to message-broker-specific address names. Clients send messages to addresses and consume messages from addresses. Clients do not send messages directly to other clients. </p>
<p>Message brokers provide a range of functionality that is outside the scope of MBWS.  Typically an internet message broker provides a REST API for working with this functionality; such as configuring client credentials; setting client access controls; configuring address routing; etc. </p>
<p>MBWS limits its scope to the definition of a WebSocket subprotocol that provides a full duplex, reliable message transport protocol between message brokers and their clients; and, between message brokers. </p>
<p>Since reliable message transport is often independent of a broker's particular features, MBWS can be used as the message transport protocol for a wide range of message brokers. MBWS utilizes two elements of WebSocket extensibility - opcodes and extension data. </p>
<p>The IETF has been notified of intellectual property rights claimed in regard to some or all of the specification contained in this document.  For more information consult the online list of claimed rights.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on March 04, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">MBWS Functionality</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">Connection Recovery</a>
</li>
<li>2.1.1.   <a href="#rfc.section.2.1.1">MBWS Connections</a>
</li>
<li>2.1.2.   <a href="#rfc.section.2.1.2">New MBWS Control Frames</a>
</li>
<li>2.1.3.   <a href="#rfc.section.2.1.3">Connection Name and Connection Recovery</a>
</li>
<li>2.1.4.   <a href="#rfc.section.2.1.4">Message Synchronization of a Recovered MBWS Connection</a>
</li>
<li>2.1.4.1.   <a href="#rfc.section.2.1.4.1">Server-message-delivery-resync</a>
</li>
<li>2.1.4.2.   <a href="#rfc.section.2.1.4.2">Client-message-delivery-resync</a>
</li>
<li>2.1.5.   <a href="#rfc.section.2.1.5">Message Metadata</a>
</li>
<li>2.1.5.1.   <a href="#rfc.section.2.1.5.1">Address</a>
</li>
<li>2.1.5.1.1.   <a href="#rfc.section.2.1.5.1.1">Undeliverable Messages</a>
</li>
<li>2.1.5.2.   <a href="#rfc.section.2.1.5.2">Content-Type</a>
</li>
<li>2.1.5.3.   <a href="#rfc.section.2.1.5.3">Property List</a>
</li>
<li>3.   <a href="#rfc.section.3">Additional Issues</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Message Content and Message Fragmentation</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">REST Prior to Session Upgrade</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Sec-WebSocket-Protocol Field</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Client Identity</a>
</li>
<li>3.5.   <a href="#rfc.section.3.5">Message Security</a>
</li>
<li>4.   <a href="#rfc.section.4">Scenarios</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">MBWS Connection Recovery Scenario</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">MBLWS Session Scenario</a>
</li>
<li>5.   <a href="#rfc.section.5">Issues Outside the Scope of this Document</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Messaging Scope</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Message Acknowledgement Interval</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">Synchronous Messaging</a>
</li>
<li>5.4.   <a href="#rfc.section.5.4">End-to-End Reliability</a>
</li>
<li>6.   <a href="#rfc.references">References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">The WebSocket protocol <a href="#I-D.ietf-hybi-thewebsocketprotocol">[I-D.ietf-hybi-thewebsocketprotocol]</a> provides a subprotocol extension facility. The MessageBroker WebSocket Subprotocol (MBWS) is a WebSocket Subprotocol used by messaging clients to send messages to, and receive messages from an internet message broker (herein called a message broker). A message broker is a messaging intermediary that queues messages sent by its clients for asynchronous delivery to its clients. </p>
<p id="rfc.section.1.p.2">Messages are addressed to message-broker-specific address names. Clients send messages to addresses and consume messages from addresses. Clients do not send messages directly to other clients. </p>
<p id="rfc.section.1.p.3">Message brokers provide a range of functionality that is outside the scope of MBWS.  Typically an internet message broker provides a REST API for working with this functionality; such as configuring client credentials; setting client access controls; configuring address routing; etc. MBWS limits its scope to the definition of a WebSocket subprotocol that provides a full duplex, reliable message transport protocol between message brokers and their clients; and, between message brokers.</p>
<p id="rfc.section.1.p.4">Since reliable message transport is usually independent of a broker's particular features, MBWS can be used as the message transport protocol for a wide range of message brokers. MBWS utilizes two elements of WebSocket subprotocol extensibility - opcodes and extension data. </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> MBWS Functionality</h1>
<p id="rfc.section.2.p.1">MBWS extends WebSocket with two capabilities: </p>

<ul>
<li>Connection Recovery - the ability to support a logical, reliable connection that spans a sequence of WebSocket sessions (herein, such a connection is called a 'connection')</li>
<li>Message Metadata - the ability to annotate a WebSocket message with metadata to support the functionality of a message broker</li>
</ul>

<p> </p>
<p id="rfc.section.2.p.2">This document defines two subprotocols - MessageBroker WebSocket Subprotocol (MBWS) and MessageBrokerLight WebSocket Subprotocol (MBLWS). MBWS supports both Connection Recovery and Message Metadata. MBLWS supports only Message Metadata. </p>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> Connection Recovery</h1>
<p id="rfc.section.2.1.p.1">When a WebSocket is normally closed, both client and server can assume the messages they sent/delivered have been received by the other party. </p>
<p id="rfc.section.2.1.p.2">The reliability of the WebSocket's underlying TCP connection, combined with the WebSocket close protocol, insures that both parties have implicitly acknowledged the receipt of the all messages they have been sent. </p>
<p id="rfc.section.2.1.p.3">If a WebSocket session fails, the protocol does not define how the parties resolve what messages have been received and what messages have been lost. In many cases, this is not an issue; however, message brokers typically provide once-and-only-once QoS and WebSocket alone is not sufficient to support this.  While message brokers could layer protocol over WebSocket to resolve this issue, this adds complexity and overhead. Instead, MBWS extends WebSocket with an efficient reliable messaging protocol that resolves this issue. </p>
<h1 id="rfc.section.2.1.1">
<a href="#rfc.section.2.1.1">2.1.1.</a> MBWS Connections</h1>
<p id="rfc.section.2.1.1.p.1">MBWS defines a connection that spans a sequence of one or more sessions.  During the time period between the failure of one of its sessions and the creation of its next session, its parties must maintain the state required to recover the connection. Since messages may be lost when a session fails, this state must contain a window of recently sent messages. MBWS provides support for identifying connections; maintaining recently sent message windows; recovering a connection on a new session; and, resynchronizing a recovered connection's message transport. </p>
<h1 id="rfc.section.2.1.2">
<a href="#rfc.section.2.1.2">2.1.2.</a> New MBWS Control Frames</h1>
<div id="#rfc.table.1"></div>
<p>New MBWS Control Frames</p>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="center">Opcode Name</th>
<th class="center">Opcode Value</th>
<th class="center">Opcode Extension Data</th>
</tr></thead>
<tbody>
<tr>
<td class="center">Connect</td>
<td class="center">%xB</td>
<td class="center">Optional Connection Name</td>
</tr>
<tr>
<td class="center">Acknowledge</td>
<td class="center">%xC</td>
<td class="center">base 128 varint sequence number</td>
</tr>
</tbody>
</table>
<p>varint is an integer encoding defined by Google Protocol Buffers<a href="#GPBE">[GPBE]</a></p>
<div id="#rfc.table.2"></div>
<p>Connection Name Extension Data</p>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="center">Length</th>
<th class="center">Value</th>
</tr></thead>
<tbody><tr>
<td class="center">base 128 varint</td>
<td class="center">UTF-8 String</td>
</tr></tbody>
</table>
<h1 id="rfc.section.2.1.3">
<a href="#rfc.section.2.1.3">2.1.3.</a> Connection Name and Connection Recovery</h1>
<p id="rfc.section.2.1.3.p.1">When a client requests a new connection it sends a Connect frame with no extension data. The server must respond with a Connect frame containing the name of a new connection. This is the connection name that an MBWS client uses if the current session fails and the client recovers the connection via the connection recovery protocol. If a session is closed, as defined by the WebSocket close protocol, it also terminates the connection it carried. It is recommended but not required that connection name be a URN. </p>
<p id="rfc.section.2.1.3.p.2">When a client requests the recovery of a connection, it sends a Connect frame containing the name of the connection to be recovered. The message broker must then respond with a Connect frame containing a connection name.  If this connection name matches the value sent by the client, the server has accepted the recovery request. If the name does not match, the server has rejected the recovery request and has created a new connection. </p>
<p id="rfc.section.2.1.3.p.3">Connection's are identified by a combination of client origin and connection name. Only the client origin that created the connection can recover the connection.</p>
<p id="rfc.section.2.1.3.p.4">A connection may be carried over a sequence of sessions during its lifetime.  </p>
<h1 id="rfc.section.2.1.4">
<a href="#rfc.section.2.1.4">2.1.4.</a> Message Synchronization of a Recovered MBWS Connection</h1>
<p id="rfc.section.2.1.4.p.1">MBWS requires clients and message brokers to use an implicit sequence numbering protocol for the messages transported by a connection. Each direction of transport defines a separate sequence. The first message sent by each party is sequence number 1, the next is 2, etc. Since both parties are guaranteed to see the messages in the order sent, no explicit exchange of sequence numbers is required. </p>
<p id="rfc.section.2.1.4.p.2">Both parties must acknowledge receipt of messages they receive. This is done by sending an Acknowledge frame with extension data set to the sequence number of the last message number reliably received. When a sending party receives an Acknowledge frame from its receiving party, the sending party can delete from its message recovery window all messages with sequence numbers less than or equal to the Acknowledge sequence number. </p>
<p id="rfc.section.2.1.4.p.3">A multi-fragment message is assigned one sequence number. Control frames are not assigned sequence numbers. </p>
<p id="rfc.section.2.1.4.p.4">If a session abnormally terminates and a message broker accepts a client's request to recover the connection, both client and message broker must verify that they can resume sending messages with the message sequence number required by each. This is a two phase process. First, the client provides the message broker with the information required to restart message delivery. This phase is called server-message-delivery-resync. Second, the message broker provides the client with information required to restart message delivery. This phase is called client-message-delivery-resync. </p>
<p id="rfc.section.2.1.4.p.5">If both server-message-delivery-resync and client-message-delivery-resync succeed, the connection has been recovered. If either fails, a new connection is created. </p>
<h1 id="rfc.section.2.1.4.1">
<a href="#rfc.section.2.1.4.1">2.1.4.1.</a> Server-message-delivery-resync</h1>
<p id="rfc.section.2.1.4.1.p.1">The client sends an Acknowledge frame containing the sequence number of the last message it has received. The message broker then validates it can resume sending with the next message in sequence. If so, it must reply with a Connect frame containing the connection name being recovered. </p>
<p id="rfc.section.2.1.4.1.p.2">If so, the client must reply with a Connect frame containing the connection name being recovered. Connection recovery then proceeds with the client-message-deliveryresync phase.</p>
<p id="rfc.section.2.1.4.1.p.3">If the client cannot restart with this message, it must reply with a Connect frame containing a new connection name. Message transport then begins on this new connection.</p>
<h1 id="rfc.section.2.1.4.2">
<a href="#rfc.section.2.1.4.2">2.1.4.2.</a> Client-message-delivery-resync</h1>
<p id="rfc.section.2.1.4.2.p.1">The message broker sends the client an Acknowledge frame containing the sequence number of the last message it has received. The client then validates it can resume sending with the next message in sequence. </p>
<p id="rfc.section.2.1.4.2.p.2">If so, the message broker must reply with a Connect frame containing the connection name being recovered. This completes a successful connection recovery and normal message transport resumes with the expected sequence numbered messages. </p>
<p id="rfc.section.2.1.4.2.p.3">If the message broker cannot restart with this message, it must reply with a Connect frame without a connection name. The message broker must then respond with a Connect frame containing a new connection name.  Message transport then begins on this new connection.</p>
<h1 id="rfc.section.2.1.5">
<a href="#rfc.section.2.1.5">2.1.5.</a> Message Metadata</h1>
<div id="#rfc.table.3"></div>
<p>Message Extension Data Fields</p>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="center">Field Name</th>
<th class="center">Field Length in Bytes</th>
<th class="center">Field Value</th>
</tr></thead>
<tbody>
<tr>
<td class="center">Address</td>
<td class="center">base 128 varint</td>
<td class="center">UTF-8 character string</td>
</tr>
<tr>
<td class="center">Content-Type</td>
<td class="center">base 128 varint</td>
<td class="center">UTF-8 character string</td>
</tr>
<tr>
<td class="center">Property List</td>
<td class="center">base 128 varint</td>
<td class="center">Sequence of Property Entries</td>
</tr>
</tbody>
</table>
<div id="#rfc.table.4"></div>
<p>Property Entry</p>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="center">Attribute Name</th>
<th class="center">Attribute Length in Bytes</th>
<th class="center">Attribute Value</th>
</tr></thead>
<tbody>
<tr>
<td class="center">Name</td>
<td class="center">base 128 varint</td>
<td class="center">UTF-8 character string</td>
</tr>
<tr>
<td class="center">Value</td>
<td class="center">base 128 varint</td>
<td class="center">UTF-8 character string</td>
</tr>
</tbody>
</table>
<p id="rfc.section.2.1.5.p.1">MBWS defines three optional message extension data Fields - Address, Content-Type and Property List - that hold per-message metadata. Message metadata should only be added to the initial frame of a message: no extension data is defined for message continuation frames. The order of message extension data must be Address, Content-Type and Property List. Each starts with a length in bytes of the value to follow. </p>
<p id="rfc.section.2.1.5.p.2">Empty fields are represented with a zero length. The extension data for a message with no metadata contains three length values set to zero.</p>
<h1 id="rfc.section.2.1.5.1">
<a href="#rfc.section.2.1.5.1">2.1.5.1.</a> Address</h1>
<p id="rfc.section.2.1.5.1.p.1">For messages sent by a client to a broker, Address specifies the address name to which a message is addressed. Address will be used by the message broker to route the message. MBWS does not specify how this routing is to be done. For messages delivered by a message broker to a client, Address specifies a source address name. MBWS does not specify how this value is assigned. </p>
<p id="rfc.section.2.1.5.1.p.2">It is recommended but not required that address name be a URN. </p>
<p id="rfc.section.2.1.5.1.p.3">If a client sends several messages in series to the same Address, only the first message must provide an address value, subsequent messages may omit the value and the broker will assume the value is the last specified value. The previously sent address is not maintained across connection recovery. It must be reestablished with the first message sent. This same optimization can be used for messages sent by a broker to a client. </p>
<p id="rfc.section.2.1.5.1.p.4">The format and semantics of Address is message broker dependent and is outside the scope of MBWS. For instance, some brokers may treat Address as a strictly local name; other brokers may support a more global form of addressing. </p>
<h1 id="rfc.section.2.1.5.1.1">
<a href="#rfc.section.2.1.5.1.1">2.1.5.1.1.</a> Undeliverable Messages</h1>
<p id="rfc.section.2.1.5.1.1.p.1">An address name may not be known to a broker. MBWS does not define how such dead-letters are handled once they are received by a message broker. MBWS requires a message broker to acknowledge every message sent to it, whether or not it can deliver it. </p>
<h1 id="rfc.section.2.1.5.2">
<a href="#rfc.section.2.1.5.2">2.1.5.2.</a> Content-Type</h1>
<p id="rfc.section.2.1.5.2.p.1">Immediately following Address, a message may contain an optional Content-Type. Its value is the MIME discrete type <a href="#RFC2045">[RFC2045]</a> that describes the message's content. </p>
<h1 id="rfc.section.2.1.5.3">
<a href="#rfc.section.2.1.5.3">2.1.5.3.</a> Property List</h1>
<p id="rfc.section.2.1.5.3.p.1">Immediately following Content-Type, a message may contain an optional Property List. This list contains zero or more Properties. Each property is has a Name attribute followed by a Value attribute. Property Names must not be empty. An empty Property Value is represented with a zero length. </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Additional Issues</h1>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> Message Content and Message Fragmentation</h1>
<p id="rfc.section.3.1.p.1">MBWS provides the same message content and fragmentation support as WebSocket. </p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> REST Prior to Session Upgrade</h1>
<p id="rfc.section.3.2.p.1">A client may use an HTTP session to first interact with a message broker's REST API and then upgrade the connection to MBWS or MBLWS for message transport. </p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> Sec-WebSocket-Protocol Field</h1>
<div id="#rfc.table.5"></div>
<p>Sec-WebSocket-Protocol Field Values</p>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr><th class="center">Value</th></tr></thead>
<tbody>
<tr><td class="center">MBWS.huawei.com</td></tr>
<tr><td class="center">MBLWS.huawei.com</td></tr>
</tbody>
</table>
<p id="rfc.section.3.3.p.1">WebSocket defines the subprotocol negotiation process. This starts with a client including the Sec-WebSocket-Protocol Field with one or more subprotocol names in its WebSocket upgrade request. The table above specifies the values for the two subprotocols defined in this document.</p>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> Client Identity</h1>
<p id="rfc.section.3.4.p.1">WebSocket uses the HTTP origin model to identify clients. MBWS uses the same client identity model. </p>
<h1 id="rfc.section.3.5">
<a href="#rfc.section.3.5">3.5.</a> Message Security</h1>
<p id="rfc.section.3.5.p.1">WebSocket supports TLS and MBWS recommends, but does not require, its use. In addition to providing better security the use of TLS and port 443 insures that MBWS connections avoid the overhead and latency of having to traverse web proxies. </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Scenarios</h1>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> MBWS Connection Recovery Scenario</h1>
<p></p>

<ol>
<li>Broker provides 'ws:' and/or 'wss:' URIs for accepting MBWS connections. </li>
<li>Client establishes an HTTP session with Broker; identifies itself using HTTP client origin; and, authenticates itself using HTTP authentication. </li>
<li>If successful, Client may use session as a normal HTTP session to invoke Broker's REST API.</li>
<li>Client requests session upgrade to MBWS Subprotocol. </li>
<li>If upgrade successful, Client sends Connect frame with empty connection name. </li>
<li>Broker responds with Connect frame containing a new connection name. </li>
<li>Broker starts streaming available messages to client; and, Client starts streaming messages to Broker. </li>
<li>Client and Broker periodically acknowledge receipt of each other's messages using Acknowledge frames. </li>
<li>Client or Broker may initiate/respond to Ping/Pong during session as defined by WebSocket. </li>
<li>Client or Broker may initiate session close as defined by WebSocket. </li>
<li>If session abnormally terminates, client recovers connection by executing (1) through (4) and then continues with (12) </li>
<li>Client sends Connect frame containing connection name it wishes to recover</li>
<li>Broker responds with Connect frame. If Connect frame contains a new connection name, broker has rejected recovery and created a new connection, processing continues with (7). If Connect frame contains recovery connection name, broker has accepted recovery.</li>
<li>Client sends Acknowledge frame containing the sequence number of the last message it has received. </li>
<li>Broker responds with Connect frame. If Connect frame contains a new connection name, broker has rejected recovery and created a new connection, processing continues with (7). If Connect frame contains recovery connection name, broker has accepted recovery. </li>
<li>Broker sends Acknowledge frame containing the sequence number of the last message it has received. </li>
<li>Client responds with Connect frame. If Connect frame contains an empty connection name, client has rejected recovery and processing continues with (6). If the connection name is the recovery connection name, processing continues at (7) </li>
</ol>

<p> </p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> MBLWS Session Scenario</h1>
<p></p>

<ol>
<li>Broker provides 'ws:' and/or 'wss:' URIs for accepting MBLWS sessions. </li>
<li>Client establishes an HTTP session with Broker; identifies itself using HTTP client origin; and, authenticates itself using HTTP authentication. </li>
<li>If successful, Client may use session as a normal HTTP session to invoke Broker's REST API.</li>
<li>Broker starts streaming available messages to client; and, Client starts streaming messages to Broker. </li>
<li>Client or Broker may initiate/respond to Ping/Pong during session as defined by WebSocket. </li>
<li>Client or Broker may initiate session close as defined by WebSocket. </li>
</ol>

<p> </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> Issues Outside the Scope of this Document</h1>
<p id="rfc.section.5.p.1">_This section is non-normative._ </p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Messaging Scope</h1>
<p id="rfc.section.5.1.p.1">Message brokers provide message-broker-specific functionality for routing, queueing, forwarding, filtering, transporting, etc. messages. This results in the broker delivering specific messages to specific clients. This document defines how a message broker uses the WebSocket subprotocols defined here to transport messages to/from a client. All other message broker functionality is outside the scope of this document.</p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> Message Acknowledgement Interval</h1>
<p id="rfc.section.5.2.p.1">The parties of an MBWS connection decide when to send Acknowledge frames.  Typically these are sent after some number of messages have been received or some time interval has elapsed within which at least one message has been received. The choice of acknowledgement interval is outside the scope of this document. </p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> Synchronous Messaging</h1>
<p id="rfc.section.5.3.p.1">Message brokers have a history of supporting synchronous messaging where clients make blocking calls to send and to receive messages. WebSocket and MBWS are natively asynchronous messaging protocols. MBWS is optimized for asynchronous, full duplex message transport. It has not been designed for synchronous messaging. </p>
<h1 id="rfc.section.5.4">
<a href="#rfc.section.5.4">5.4.</a> End-to-End Reliability</h1>
<p id="rfc.section.5.4.p.1">The responsibility for reliable message delivery over a MBWS connection is not the responsibility of the message broker alone - it is only achieved when both clients and brokers implement recovery of connections. The degree to which clients and message brokers are able to recover from failure is outside the scope of this document. </p>
<h1 id="rfc.references">
<a href="#rfc.references">6.</a> References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.ietf-hybi-thewebsocketprotocol">[I-D.ietf-hybi-thewebsocketprotocol]</b></td>
<td class="top">
<a>Fette, I</a> and <a>A Melnikov</a>, "<a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-17">The WebSocket protocol</a>", Internet-Draft draft-ietf-hybi-thewebsocketprotocol-17, September 2011.</td>
</tr>
<tr>
<td class="reference"><b id="GPBE">[GPBE]</b></td>
<td class="top">
<a>Google Protocol Buffers Encoding &lt;http://code.google.com/apis/protocolbuffers/docs/encoding.html&gt;</a>", .</td>, "</tr>
<tr>
<td class="reference"><b id="RFC2045">[RFC2045]</b></td>
<td class="top">
<a>Freed, N</a>, <a>Borenstein, N</a>, "<a>Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies &lt;http://code.google.com/apis/protocolbuffers/docs/encoding.html&gt;</a>", November 1966.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mark Hapner</span> editor
	  <span class="n hidden">
		<span class="family-name">Hapner</span>
	  </span>
	</span>
	<span class="org vcardline">Huawei</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mhapner@huawei.com">mhapner@huawei.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Clebert Suconic</span> 
	  <span class="n hidden">
		<span class="family-name">Suconic</span>
	  </span>
	</span>
	<span class="org vcardline">redhat</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:csuconic@redhat.com">csuconic@redhat.com</a></span>

  </address>
</div>

</body>
</html>