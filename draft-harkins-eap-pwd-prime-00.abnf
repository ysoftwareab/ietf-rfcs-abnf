pwd-seed = HKDF(0^n, password,
                       "EAP-pwd' Hash to Element P1", olen(p))
u = (pwd-seed modulo (p - 2)) + 2

t = inverse(z^2 * u^4 + z * u^2)
x1 = (-b/a) * (1 + t)
gx1 = x1^3 + a * x1 + b
x2 = z * u^2 * x1
gx2 = x2^3 + a * x2 + b

l = gx1 is a quadratic residue modulo p
v = CSEL(l, gx1, gx2)
x = CSEL(l, x1, x2)
y = sqrt(v)

l = CEQ(LSB(u), LSB(y))
P1 = CSEL(l, (x,y), (x, p-y))


pwd-seed = HKDF(0^n, password,
                       "EAP-pwd' Hash to Element P2", olen(p))
u = (pwd-seed modulo (p - 2)) + 2

t = inverse(z^2 * u^4 + z * u^2)
x1 = (-b/a) * (1 + t)
gx1 = x1^3 + a * x1 + b
x2 = z * u^2 * x1
gx2 = x2^3 + a * x2 + b

l = gx1 is a quadratic residue modulo p
v = CSEL(l, gx1, gx2)
x = CSEL(l, x1, x2)
y = sqrt(v)

l = CEQ(LSB(u), LSB(y))
P2 = CSEL(l, (x,y), (x, p-y))

S = P1 + P2

pwd-value = HKDF(0^n, password,
                        "EAP-pwd' Hash To Element",
                        olen(p))
pwd-value = (pwd-value modulo (p - 2)) + 2

s = pwd-value^((p-1)/q) modulo p

val = HKDF(peer-ID | server-ID, token, "Fixing PWE", olen(p))
val = val modulo (q - 1) + 1

PWE = val * S
val = HKDF(peer-ID | server-ID, token, "Fixing pwe", olen(p))
val = val modulo (q - 1) + 1

pwe = s^val modulo p
