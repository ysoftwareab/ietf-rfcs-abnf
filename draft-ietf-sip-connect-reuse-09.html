<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Connection Reuse in the Session Initiation Protocol (SIP)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Connection Reuse in the Session Initiation Protocol (SIP)">
<meta name="keywords" content="I-D, Internet-Draft, connection reuse">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">SIP WG</td><td class="header">R. Mahy</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Plantronics</td></tr>
<tr><td class="header">Updates: <a href='http://tools.ietf.org/html/rfc3261'>3261</a> (if&nbsp;approved)</td><td class="header">V. Gurbani, Ed.</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">Bell Laboratories, Alcatel-Lucent</td></tr>
<tr><td class="header">Expires: August 11, 2008</td><td class="header">B. Tate</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">BroadSoft</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">February 08, 2008</td></tr>
</table></td></tr></table>
<h1><br />Connection Reuse in the Session Initiation Protocol (SIP)<br />DOCNAME</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on August 11, 2008.</p>

<h3>Abstract</h3>

<p>This document enables a pair of communicating proxies to reuse a 
congestion-controlled connection between themselves for sending requests 
in the forward and backwards direction.  Because the connection is 
essentially aliased for requests going in the backwards direction, reuse 
should be predicated upon both the communicating endpoints authenticating 
themselves using X.509 certificates through TLS.  For this reason, we 
only consider connection reuse for TLS over TCP and TLS over SCTP.  A 
single connection cannot be reused for the TCP or SCTP transport between 
two peers, and this document provides insight into why this is the case.  
As a remedy, it suggests using two TCP connections (or two SCTP associations),
each opened pro-actively towards the recipient by the sender.  Finally, 
this document also provides guidelines on connection reuse and 
virtual SIP servers and the interaction of connection reuse and 
DNS SRV lookups in SIP.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#terminology">1.</a>&nbsp;
Terminology<br />
<a href="#anchor1">2.</a>&nbsp;
Applicability Statement<br />
<a href="#anchor2">3.</a>&nbsp;
Introduction<br />
<a href="#anchor3">4.</a>&nbsp;
Benefits of TLS Connection Reuse<br />
<a href="#overview">5.</a>&nbsp;
Overview of Operation<br />
<a href="#anchor4">6.</a>&nbsp;
Requirements<br />
<a href="#anchor5">7.</a>&nbsp;
Formal Syntax<br />
<a href="#anchor6">8.</a>&nbsp;
Normative Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">8.1.</a>&nbsp;
Client Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">8.2.</a>&nbsp;
Server Behavior<br />
<a href="#auth">9.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#auth-tls-client">9.1.</a>&nbsp;
Authenticating TLS Connections: Client View<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#auth-tls-server">9.2.</a>&nbsp;
Authenticating TLS Connections: Server View<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#auth-tcp">9.3.</a>&nbsp;
Security Considerations for TCP and SCTP Transports<br />
<a href="#virt-server">10.</a>&nbsp;
Connection reuse and Virtual servers<br />
<a href="#anchor9">11.</a>&nbsp;
Connection Reuse and SRV Interaction<br />
<a href="#anchor10">12.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor11">13.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">14.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">14.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">14.2.</a>&nbsp;
Informational References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="terminology"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", 
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document 
are to be interpreted as described in 
<a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].
</p>
<p>Additional terminology used in this document:
</p>
<p>
 </p>
<blockquote class="text"><dl>
<dt>Advertised address:</dt>
<dd>The address that occurs in the 
  Via sent-by production rule, including the port number and transport.
</dd>
<dt>Alias:</dt>
<dd>Re-using an existing connection for sending 
  requests in the backwards direction; i.e., A opens a connection to B 
  to send a request, and B uses that connection to send requests in 
  the backwards direction to A.
</dd>
<dt>Connection reuse:</dt>
<dd>See "Alias".
</dd>
<dt>Persistent connection:</dt>
<dd>The process of sending multiple,
  possibly unrelated requests on the same connection, and receiving 
  responses on that connection as well.  More succinctly, A opens 
  a connection to B to send a request, and later reuses the same 
  connection to send other requests, possibly unrelated to the dialog 
  established by the first request.  Responses will arrive over 
  the same connection.  Persistent connection behavior is is specified 
  in Section 18 of RFC3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.  Persistent 
  connections do not imply connection reuse.
</dd>
<dt>Resolved address:</dt>
<dd> The network identifiers (IP address, 
  port, transport) associated with a user agent as a result of 
  executing RFC3263 <a class='info' href='#RFC3263'>[RFC3263]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a> on a Uniform Resource 
  Identifier (URI).
</dd>
<dt>Shared connection:</dt>
<dd>See "Persistent connection."
</dd>
</dl></blockquote><p>

</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Applicability Statement</h3>

<p>The applicability of the mechanism described in this document is for
two adjacent SIP entities to reuse connections when they are agnostic about
the direction of the connection, i.e., either end can initiate the connection.
SIP entities that can only open a connection in a specific direction -- perhaps
because of Network Address Translation (NAT) and firewalls -- reuse
their connections using the mechanism described in
<a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C. and R. Mahy, &ldquo;Managing Client Initiated Connections in the Session Initiation           Protocol (SIP),&rdquo; November&nbsp;2007.</span><span>)</span></a>.
</p>
<p>This memo concerns connection reuse, not persistent connections
(see definitions of these in <a class='info' href='#terminology'>Section&nbsp;1<span> (</span><span class='info'>Terminology</span><span>)</span></a>).  Behavior 
for persistent connections is specified in Section 18 of RFC3261 
<a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> and is not altered by this memo.
</p>
<p>This memo RECOMMENDS that only those connections be reused where the
identity of the sender can be verified by the receiver.  Thus, TLS
connections (over any connection-oriented transport) formed by 
exchanging X.509 certificates can be reused because they authoritatively 
establish identities of the communicating parties (see 
<a class='info' href='#overview'>Section&nbsp;5<span> (</span><span class='info'>Overview of Operation</span><span>)</span></a>).  For reasons discussed in 
<a class='info' href='#auth-tcp'>Section&nbsp;9.3<span> (</span><span class='info'>Security Considerations for TCP and SCTP Transports</span><span>)</span></a>, connection reuse over other connection-oriented 
transport (TCP, <a class='info' href='#RFC2960'>SCTP<span> (</span><span class='info'>Stewart, R., Xie, Q., Morneault, K., Sharp, C., Schwarzbauer, H., Taylor, T., Rytina, I., Kalla, M., Zhang, L., and V. Paxson, &ldquo;The Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; October&nbsp;2000.</span><span>)</span></a> [RFC2960]) is NOT RECOMMENDED.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Introduction</h3>

<p><a class='info' href='#RFC3261'>SIP<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [RFC3261] entities can communicate using either 
unreliable/connectionless (e.g., UDP) or reliable/connection-oriented 
(e.g., TCP, <a class='info' href='#RFC2960'>SCTP<span> (</span><span class='info'>Stewart, R., Xie, Q., Morneault, K., Sharp, C., Schwarzbauer, H., Taylor, T., Rytina, I., Kalla, M., Zhang, L., and V. Paxson, &ldquo;The Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; October&nbsp;2000.</span><span>)</span></a> [RFC2960]) transport protocols.  
When SIP entities use a connection-oriented protocol (such as TCP or 
SCTP) to send a request, they typically originate their connections from an 
ephemeral port.
</p>
<p>In the following example, A listens for SIP requests over 
<a class='info' href='#RFC2246'>TLS<span> (</span><span class='info'>Dierks, T. and C. Allen, &ldquo;The TLS Protocol Version 1.0,&rdquo; January&nbsp;1999.</span><span>)</span></a> [RFC2246] on TCP port 5061 (the default port for 
SIP over TLS over TCP), but uses an ephemeral port (port 8293) for a 
new connection to B.  These entities could be SIP User Agents or 
SIP Proxy Servers.
</p><br /><hr class="insert" />
<a name="uni-dir"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
       +-----------+ 8293 (UAC)      5061 (UAS) +-----------+
       |           |---------------------------&gt;|           |
       |  Entity   |                            |  Entity   |
       |     A     |                            |     B     |
       |           | 5061 (UAS)                 |           |
       +-----------+                            +-----------+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Uni-directional connection for requests from A to B&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The SIP protocol includes the notion of a persistent connection,
which is a mechanisms to insure that responses to a request reuse the 
existing connection that is typically still available, as well as
reusing the existing connections for other requests sent by the originator 
of the connection.  However, new requests sent in the backwards 
direction -- in the example above, requests from B destined to A -- are 
unlikely to reuse the existing connection.  This frequently causes a pair 
of SIP entities to use one connection for requests sent in each direction, 
as shown below.
</p><br /><hr class="insert" />
<a name="two-conns"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
       +-----------+ 8293              5061 +-----------+
       |           |.......................&gt;|           |
       |  Entity   |                        |  Entity   |
       |     A     | 5061              9741 |     B     |
       |           |&lt;-----------------------|           |
       +-----------+                        +-----------+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Two connections for requests between A and B.&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>While this is adequate for TCP, TLS connections can be reused 
to send requests in the backwards direction since each end can be 
authenticated when the connection is initially set up.  Once 
the authentication step has been performed, the situation can thought 
to resemble the picture in <a class='info' href='#uni-dir'>Figure&nbsp;1<span> (</span><span class='info'>Uni-directional connection for requests from A to B</span><span>)</span></a> except that the 
connection opened from A to B is shared:  when A wants to send a request 
to B, it will reuse this connection, and when B wants to send a request 
to A, it will reuse the same connection.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Benefits of TLS Connection Reuse</h3>

<p>Opening an extra connection where an existing one is sufficient can 
result in potential scaling and performance problems.  Each new connection 
using TLS requires a TCP 3-way handshake, a handful of round-trips to 
establish TLS, typically expensive asymmetric authentication and key 
generation algorithms, and certificate verification.  This may lead to 
a build up of considerable queues as the server CPU saturates by the 
TLS handshakes it is already performing (Section 6.19 of
<a class='info' href='#Book-Rescorla-TLS'>[Book&#8209;Rescorla&#8209;TLS]<span> (</span><span class='info'>Rescorla, E., &ldquo;SSL and TLS: Designing and Building Secure Systems,&rdquo; 2001.</span><span>)</span></a>).
</p>
<p>Consider the call flow shown below where Proxy A and Proxy B use the 
Record-Route mechanism to stay involved in a dialog.  Proxy B will 
establish a new TLS connection just to send a BYE request.
</p><br /><hr class="insert" />
<a name="fig-mult-conns"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                   Proxy A    Proxy B
                      |          |
  Create connection 1 +---INV---&gt;|
                      |          |
                      |&lt;---200---+ Response over connection 1
                      |          |
  Re-use connection 1 +---ACK---&gt;|
                      |          |
                      =          =
                      |          |
                      |&lt;---BYE---+ Create connection 2
                      |          |
       Response over  +---200---&gt;|
       connection 2

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Multiple connections for requests&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Setting up a second connection (from B to A above) for subsequent 
requests, even requests in the context of an existing dialog (e.g., 
re-INVITE or BYE after an initial INVITE, or a NOTIFY after a SUBSCRIBE 
<a class='info' href='#RFC3265'>[RFC3265]<span> (</span><span class='info'>Roach, A., &ldquo;The Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a> or a REFER <a class='info' href='#RFC3515'>[RFC3515]<span> (</span><span class='info'>Sparks, R., &ldquo;The Session Initiation Protocol (SIP) Refer Method,&rdquo; April&nbsp;2003.</span><span>)</span></a>), can also 
cause excessive delay (especially in networks with long round-trip times).
Thus, it is advantageous to reuse connections whenever possible.
</p>
<p>From the user expectation point of view, it is advantageous if the
re-INVITEs or <a class='info' href='#RFC3311'>UPDATE<span> (</span><span class='info'>Rosenberg, J., &ldquo;The Session Initiation Protocol (SIP) UPDATE Method,&rdquo; September&nbsp;2002.</span><span>)</span></a> [RFC3311] requests are handled 
automatically and rapidly in order to avoid media and session state from 
being out of step.  If a re-INVITE requires a new TLS connection, 
the reINVITE could be delayed by several extra round-trip times.  Depending 
on the round-trip time, this combined delay could be perceptible or even 
annoying to a human user.  This is especially problematic for some common 
SIP call flows (for example, the recommended example flow in figure number 4 
in <a class='info' href='#RFC3725'>RFC3725<span> (</span><span class='info'>Rosenberg, J., Peterson, J., Schulzrinne, H., and H. Camarillo, &ldquo;Best Current Practices for Third Party Call Control (3pcc) in the          Session Initiation Protocol (SIP),&rdquo; April&nbsp;2004.</span><span>)</span></a> [RFC3725] use many reINVITEs).
</p>
<p>The mechanism described in this document can mitigate the delays 
associated with subsequent requests.
</p>
<a name="overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Overview of Operation</h3>

<p>This section is tutorial in nature, and does not specify any normative
behavior.
</p>
<p>We now explain this working in more detail in the context of 
communication between two adjacent proxies.  Without any loss of generality, 
it should be clear that the same technique can be used for connection reuse 
between a UAC and an edge proxy, or between an edge proxy and a UAS, or 
between an UAC and an UAS.
</p>
<p>P1 and P2 are proxies responsible for routing SIP requests to
user agents that use them as edge proxies 
(see <a class='info' href='#fig-proxy-setup'>Figure&nbsp;4<span> (</span><span class='info'>Proxy setup</span><span>)</span></a>).
</p><br /><hr class="insert" />
<a name="fig-proxy-setup"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                P1 &lt;===================&gt; P2
           p1.example.com          p2.example.net
            (192.0.2.1)              (192.0.2.128)

     +---+                                    +---+
     |   |   0---0                   0---0    |   |
     |___|    /-\                     /-\     |___|
    /    /   +---+                   +---+   /    /
   +----+                                   +----+
   User Agents                       User Agents
   example.com domain                example.net domain

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: Proxy setup&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>For illustration purpose the discussion below uses TCP as a transport 
for TLS operations.  Another streaming transport -- such as SCTP 
<a class='info' href='#RFC2960'>[RFC2960]<span> (</span><span class='info'>Stewart, R., Xie, Q., Morneault, K., Sharp, C., Schwarzbauer, H., Taylor, T., Rytina, I., Kalla, M., Zhang, L., and V. Paxson, &ldquo;The Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; October&nbsp;2000.</span><span>)</span></a> -- can be used as well.
</p>
<p>The act of reusing a connection is initiated by P1 when it adds 
an "alias" parameter (defined later) to the Via header.  When P2 receives 
the request, it examines the topmost Via header.  If the header 
contained an "alias" parameter, P2 establishes a binding such that 
subsequent requests going to P1 will reuse the connection; i.e., 
requests are sent over the established connection.
</p>
<p>With reference to <a class='info' href='#fig-proxy-setup'>Figure&nbsp;4<span> (</span><span class='info'>Proxy setup</span><span>)</span></a>, in order for 
P2 to reuse a connection for requests in the backwards direction, it is 
important to note that the validation model for requests sent in 
this direction (i.e., P2 to P1) should be equivalent to the normal 
"connection in each direction" model, wherein P2 acting as client would 
open up a new connection in the backwards direction and validate the 
connection by examining the X.509 certificate presented.  The act of 
reusing a connection must have the desired property that requests get 
delivered in the backwards direction only if they would have been 
delivered to the same destination had connection reuse not been 
employed.  To guarantee this property, the X.509 certificate presented 
by P1 to P2 when a TLS connection is first authenticated must be 
cached for later use.
</p>
<p>To aid the discussion of connection reuse, this document defines
a data structure called the connection alias table (or simply, alias table),
which is used to store aliased addresses and is used by user agents to
search for an existing connection before a new one is opened up to a
destination.  It is not the intent of this memo to standardize the 
implementation of an alias table; rather we use it as a convenience to 
aid subsequent discussions.
</p>
<p>P1 gets a request from one of its upstream user agents, and after 
performing RFC3263 server selection, arrives at a resolved address of 
P2.  P1 maintains an alias table, and it populates the alias table with the 
IP address, port number, and transport of P2 as determined through 
RFC3263 server selection.  P1 adds an "alias" parameter to the topmost 
Via header (inserted by it) before sending the request to P2.  The 
value in the sent-by production rule of the Via header (including the 
port number), and the transport over which the request was sent becomes 
the advertised address of P1:
</p>
<p>Via: SIP/2.0/TLS p1.example.com;branch=z9hG4bKa7c8dze;alias
</p>
<p>Assuming that P1 does not already have an existing aliased connection 
with P2, P1 now opens a connection with P2. P2 presents its X.509 
certificate to P1 for validation (see <a class='info' href='#auth-tls-client'>Section&nbsp;9.1<span> (</span><span class='info'>Authenticating TLS Connections: Client View</span><span>)</span></a>).  
Upon connection authentication and acceptance, P1 adds P2 to its 
alias table.  P1's alias table now looks like:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Destination  Destination  Destination  Destination      Alias
IP Address   Port         Transport    Identity         Descriptor
...
192.0.2.128  5061         TLS          sip:example.net     25
                                       sip:p2.example.net

</pre></div>
<p>Subsequent requests that traverse from P1 to P2 will reuse this 
connection; i.e., the requests will be sent over the descriptor 25.
</p>
<p>The following columns in the alias table created at the client
warrant an explanation:
</p>
<ol class="text">
<li>The IP address, port and transport are a result of executing
 RFC3263 server resolution process on a next hop URI.
</li>
<li>The entries in the fourth column consists of the identities of
 the server as asserted in the X.509 certificate presented by the
 server.  These identities are cached by the client after the
 server has been duly authenticated 
 (see <a class='info' href='#auth-tls-client'>Section&nbsp;9.1<span> (</span><span class='info'>Authenticating TLS Connections: Client View</span><span>)</span></a>).
</li>
<li>The entry in the last column is the socket descriptor over which
 P1, acting as a client, actively opened a TLS connection.  At some
 later time, when P1 gets a request from one of the user agents in its
 domain, it will reuse the aliased connection accessible through
 socket descriptor 25 if and only if all of the following conditions 
 hold:
</li>
<blockquote class="text"><dl>
<dt>A.</dt>
<dd>P1 determines through RFC3263 server resolution process that the
  {transport, IP-address, port} tuple of P2 to be {TLS, 192.0.2.128, 5061},
  and 
</dd>
<dt>B.</dt>
<dd>The URI used for RFC3263 server resolution matches one of the
  identities stored in the cached certificate (fourth column).
</dd>
</dl></blockquote>
</ol>
<p>When P2 receives the request it examines the topmost Via 
to determine whether P1 is willing to use this connection as an aliased
connection (i.e., accept requests from P2 towards P1.)  The Via at P2 now
looks like the following (the "received" parameter is added by P2):
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Via: SIP/2.0/TLS p1.example.com;branch=z9hG4bKa7c8dze;alias;
  received=192.0.2.1
</pre></div>
<p>The presence of the "alias" parameter indicates that P1 supports 
aliasing on this connection.  P2 now authenticates the connection 
(see <a class='info' href='#auth-tls-server'>Section&nbsp;9.2<span> (</span><span class='info'>Authenticating TLS Connections: Server View</span><span>)</span></a>) and if the authentication was 
successful, P2 creates an alias to P1 using the advertised address in 
the topmost Via.  P2's alias table looks like the following:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Destination  Destination  Destination  Destination     Alias
IP Address   Port         Transport    Identity        Descriptor
...
192.0.2.1    5061             TLS      sip:example.com     18
                                       sip:p1.example.com
</pre></div>
<p>There are a few items of interest here:
</p>
<ol class="text">
<li>The IP address field is populated with the source address of
 the client.
</li>
<li>The port field is populated from the advertised address (topmost
 Via header), if a port is present in it, or 5061 if it is not.
</li>
<li>The transport field is populated from the advertised address (topmost
 Via header).
</li>
<li>The entries in the fourth column consist of the identities of
 the client as asserted in the X.509 certificate presented by the
 client.  These identities are cached by the server after the client
 has been duly authenticated (see <a class='info' href='#auth-tls-server'>Section&nbsp;9.2<span> (</span><span class='info'>Authenticating TLS Connections: Server View</span><span>)</span></a>).
</li>
<li>The entry in the last column is the socket descriptor over which
 the connection was passively accepted.  At some later time, when
 P2 gets a request from one of the user agents in its domain, it will
 reuse the aliased connection accessible through socket descriptor
 18 if and only if all of the following conditions hold:
</li>
<blockquote class="text"><dl>
<dt>A.</dt>
<dd>P2 determines through RFC3263 server resolution process that the
  {transport, IP-address, port} tuple of P1 to be {TLS, 192.0.2.1, 5061},
  and 
</dd>
<dt>B.</dt>
<dd>The URI used for RFC3263 server resolution matches one of the
  identities stored in the cached certificate (fourth column).
</dd>
</dl></blockquote>
<li>The network address inserted in the "Destination IP Address" column should
 be the source address as seen by P2 (i.e., the "received" parameter).  It
 could be the case that the host name of P1 resolves to different IP 
 addresses due to round-robin DNS.  However, the aliased connection is to be 
 established with the original sender of the request.
</li>
</ol>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Requirements</h3>

<p>The following are the requirements that motivated this specification:
</p>
<p></p>
<ol class="text">
<li>A connection sharing mechanism SHOULD allow SIP entities to reuse existing
connections for requests and responses originated from either peer in the
connection.
</li>
<li>A connection sharing mechanism MUST NOT require clients to send 
all traffic from well-know SIP ports.
</li>
<li>A connection sharing mechanism MUST NOT require configuring ephemeral port 
numbers in DNS.
</li>
<li>A connection sharing mechanism MUST prevent unauthorized hijacking of 
other connections.
</li>
<li>Connection sharing SHOULD persist across SIP transactions and dialogs.
</li>
<li>Connection sharing MUST work across name-based virtual SIP servers.
</li>
<li>There is no requirement to share a complete path for ordinary connection 
reuse.  Hop-by-hop connection sharing is more appropriate.
</li>
</ol><p>

</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Formal Syntax</h3>

<p>The following syntax specification uses the augmented Backus-Naur Form (BNF)
as described in <a class='info' href='#RFC5234'>RFC 5234<span> (</span><span class='info'>Crocker, D. and P. Overell, &ldquo;Augmented BNF for Syntax Specifications: ABNF,&rdquo; January&nbsp;2008.</span><span>)</span></a> [RFC5234].  This document 
extends the via-params to include a new via-alias defined below.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   via-params =/ via-alias
   via-alias  =  "alias"
</pre></div>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Normative Behavior</h3>

<p>This document specifies how to reuse connections.  It is 
RECOMMENDED that servers keep connections up unless they need to reclaim 
resources, and that clients keep connections up as long as they are needed.  
Connection reuse works best when the client and the server maintain their 
connections for long periods of time.  SIP entities therefore SHOULD NOT 
automatically drop connections on completion of a transaction or 
termination of a dialog.
</p>
<p>Clients must be prepared for the case that the connection no longer 
exists when they are ready to send a subsequent request over it.  In 
such a case, a new connection must be opened to the resolved address and 
the alias table updated accordingly.
</p>
<p></p>
<blockquote class="text">
<p>Note that this behavior has an adverse side effect when a CANCEL
 request or an ACK request for a non-2xx response is sent downstream.
 Normally, these would be sent over the same connection that the 
 INVITE request was sent over.  However, if between the sending of
 the INVITE and subsequent sending of the CANCEL or ACK to a non-2xx
 response, the connection was reclaimed, then the client SHOULD open
 a new connection to the resolved address and send the CANCEL or ACK
 there instead.  The newly opened connection MAY be inserted into the
 alias table.
</p>
</blockquote>

<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.1"></a><h3>8.1.&nbsp;
Client Behavior</h3>

<p>For TLS transports, the proposed mechanism uses a new Via header 
field parameter.  The "alias" parameter is included in a Via header field 
value to indicate that the client wants to create a transport layer alias.  
The client places its advertised address in the Via header field value 
(in the "sent-by" production).


<p></p>
<blockquote class="text">
<p>For TCP and SCTP transports, the client MUST NOT insert the "alias"
 parameter in the topmost Via header.
</p>
</blockquote>



<p>If the client places an "alias" parameter in the topmost Via header
of the request, the client MUST keep the connection open for as long as
the resources on the host operating system allow it to, and that it
MUST accept requests over this connection -- in addition to the default
listening port -- from its downstream peer.  And furthermore, it SHOULD
reuse the connection when subsequent requests in the same or different 
transactions are destined to the same resolved address.
</p>
<p></p>
<blockquote class="text">
<p>Note that RFC3261 states that a response should arrive over the same 
 connection that was opened for a request.
</p>
</blockquote>

<p>Whether or not to allow an aliased connection ultimately depends on
the recipient of the request; i.e., the client does not get any confirmation
that its downstream peer created the alias, or indeed that it even supports
this specification.  Thus, clients MUST NOT assume that the acceptance of 
a request by a server automatically enables connection aliasing.  They 
MUST continue receiving requests on their default port.
</p>
<p>For TLS connections, clients MUST authenticate the connection before 
forming an alias; <a class='info' href='#auth-tls-client'>Section&nbsp;9.1<span> (</span><span class='info'>Authenticating TLS Connections: Client View</span><span>)</span></a> discusses the 
authentication steps in more detail.  Once the server has been 
authenticated, the client MUST cache, in the alias table, the identity 
(or identities) of the server as they appear in the X.509 certificate 
subjectAlternativeName extension field.  The client must also populate 
the destination IP address, port, and transport of the server in the 
alias table; these fields are retrieved from executing RFC3263 server
resolution process on the next hop URI.  And finally, the client must 
populate the alias descriptor field with the socket descriptor used 
to connect to the server.
</p>
<p>Once the alias table has been updated with a resolved address,
and the client wants to send a new request in the direction of the server, 
it should reuse the connection only if all of the following conditions
hold:
</p>
<ol class="text">
<li>The client uses the RFC3263 resolution on a URI and arrives at a
 resolved address contained in the alias table, and
</li>
<li>The URI used for RFC3263 server resolution matches one of the
 identities stored in the alias table row corresponding to that resolved
 address.
</li>
</ol>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.2"></a><h3>8.2.&nbsp;
Server Behavior</h3>

<p>A TCP connection, or a SCTP association accepted at the server is 
used by the server to only send responses upstream.  It SHOULD NOT be used 
to send requests.  Furthermore, if the topmost Via header of a request
received over TCP or SCTP had an "alias" parameter in it, the server 
MUST NOT accord any semantics to this parameter and must behave as 
if the parameter was not present.
</p>
<p>The rest of the discussion below applies to only the TLS transport.
</p>
<p>When a server receives a request over TLS whose topmost Via header 
contains an "alias" parameter, it signifies that the upstream client will 
leave the connection open beyond the transaction and dialog lifetime, and 
that subsequent transactions and dialogs that are destined to a resolved 
address that matches the identifiers in the advertised address in the 
topmost Via header can reuse this connection. 
</p>
<p>Whether or not to use in the reverse direction a connection marked with
"alias" ultimately depends on the policies of the server.  It may choose 
to honor it, and thereby send subsequent requests over the aliased 
connection.  If the server chooses not to honor an aliased connection, it 
MUST allow the request to proceed as though the "alias" parameter was 
not present in the topmost Via header.
</p>
<p></p>
<blockquote class="text">
<p>This assures interoperability with RFC3261 server behavior.  Clients
 should feel comfortable including the "alias" parameter without
 fear that the server will reject the SIP request because of its
 presence.
</p>
</blockquote>

<p>Servers MUST be prepared to deal with the case that the aliased 
connection no longer exist when they are ready to send a subsequent
request over it.  This may happen if the peer ran out of operating system
resources and had to close the connection.  In such a case, a new connection
MUST be opened to the resolved address and the alias table updated 
accordingly.
</p>
<p>If the Via sent-by contains a port, it MUST be used as a destination 
port.  Otherwise the default port is the destination port.
</p>
<p>Servers must authenticate the connection before forming an alias.  
<a class='info' href='#auth-tls-server'>Section&nbsp;9.2<span> (</span><span class='info'>Authenticating TLS Connections: Server View</span><span>)</span></a> discusses the authentication steps
in more detail. 
</p>
<p>The server, if it decides to reuse the connection, MUST cache
in the alias table the identity (or identities) of the client as they
appear in the X.509 certificate subjectAlternativeName extension field.  
The server must also populate the destination IP address, port and 
transport in the alias table from the topmost Via header (using the 
";received" parameter for the destination IP address).  If the port 
number is omitted, a default port number of 5061 is to be used.  And 
finally, the server must populate the alias descriptor field with the 
socket descriptor used to accept the connection from the client (see 
<a class='info' href='#overview'>Section&nbsp;5<span> (</span><span class='info'>Overview of Operation</span><span>)</span></a> for the contents of the alias table.)
</p>
<p>Once the alias table has been updated, and the server wants to
send a request in the direction of the client, it should reuse
the connection only if all of the following conditions hold:
</p>
<ol class="text">
<li>The server, which acts as a client for this transaction, 
  uses the RFC3263 resolution process on a URI and arrives at a 
  resolved address contained in the alias table, and
</li>
<li>The URI used for RFC3263 server resolution matches one of the
  identities stored in the alias table row corresponding to that
  resolved address.
</li>
</ol>
<a name="auth"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Security Considerations</h3>

<p>This document presents requirements and a mechanism for reusing existing 
connections easily.  Unauthenticated connection reuse would present many 
opportunities for rampant abuse and hijacking.  Authenticating connection 
aliases is essential to prevent connection hijacking.  For example, a program 
run by a malicious user of a multiuser system could attempt to hijack 
SIP requests destined for the well-known SIP port from a large relay 
proxy.
</p>
<a name="auth-tls-client"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.1"></a><h3>9.1.&nbsp;
Authenticating TLS Connections: Client View</h3>

<p>When a TLS client establishes a connection with a server, it is
presented with the server's X.509 certificate.  Authentication proceeds
as described in Section 5 of <a class='info' href='#I-D.domain-certs'>[I&#8209;D.domain&#8209;certs]<span> (</span><span class='info'>Gurbani, V., Lawrence, S., and A. Jeffrey, &ldquo;Domain Certificates in the Session Initiation Protocol (SIP),&rdquo; July&nbsp;2007.</span><span>)</span></a>.
</p>
<a name="auth-tls-server"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.2"></a><h3>9.2.&nbsp;
Authenticating TLS Connections: Server View</h3>

<p>A TLS server conformant to this specification MUST ask for a client
certificate; if the client possesses a certificate, it will be presented
to the server for mutual authentication, and authentication proceeds
as described in Section 6 of <a class='info' href='#I-D.domain-certs'>[I&#8209;D.domain&#8209;certs]<span> (</span><span class='info'>Gurbani, V., Lawrence, S., and A. Jeffrey, &ldquo;Domain Certificates in the Session Initiation Protocol (SIP),&rdquo; July&nbsp;2007.</span><span>)</span></a>.
</p>
<p>If the client does not present a certificate, the server MUST
proceed as if the "alias" parameter was not present in the topmost
Via.  In this case, the alias table MUST NOT be updated.
</p>
<a name="auth-tcp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.3"></a><h3>9.3.&nbsp;
Security Considerations for TCP and SCTP Transports</h3>

<p>The mechanism for reusing TLS connections SHOULD NOT be used to
reuse TCP connections or SCTP associations because there isn't any way 
to perform the authentication step.
</p>
<p>Connection reuse over TCP or SCTP is inherently insecure.  Without
the X.509 certificate-based proof of identity when using TLS between
communicating peers, the mechanisms defined in this memo may enable
a rogue host to represent a legitimate domain's proxy simply by populating 
the topmost Via sent-by production rule with a legitimate domain name.
As an example, consider a proxy that receives a request with the following
topmost Via header (the "received" parameter is added by the proxy after 
getting the request):
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Via: SIP/2.0/TCP p1.example.com;branch=z9hG4bKa7c8dze;
   received=192.0.4.33
</pre></div>
<p>The proxy has no authoritative means of asserting that the sender of 
this request can indeed be trusted to belong to the example.com
domain; all it has is the information in the advertised address.  If it 
attempts to reuse this connection, requests that would normally go to 
the example.com domain would now instead be destined to 192.0.4.33, 
which may in fact be a rogue host that has no affiliation with the 
example.com domain.
</p>
<p>For this reason, connection reuse over TCP and SCTP is NOT RECOMMENDED 
unless the server-end of the connection has some way of verifying the 
identity of the client-end of the connection to the same level of 
assurance as it would have by doing a DNS lookup and establishing 
a connection in the backwards direction.  For example, if a DNS lookup 
resolved to the same address and port as the source address and 
source port of the inbound connection, then this level of assurance may 
be acceptable.
</p>
<p>If the server-end of the connection does not have any manner of
verifying the identity of the client-end, then it should actively
open up a connection in the direction of its peer using RFC3263
server selection process.  This connection can be used as a 
persistent connection for requests going in the backwards direction.
Thus the two peers will open and maintain a connection in the direction
of the other (as depicted in <a class='info' href='#two-conns'>Figure&nbsp;2<span> (</span><span class='info'>Two connections for requests between A and B.</span><span>)</span></a>).  This manner 
of opening connections, while still not secure, is at least more secure 
than using the connection reuse mechanism over TCP or SCTP in an 
unauthenticated fashion.
</p>
<a name="virt-server"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Connection reuse and Virtual servers</h3>

<p>Virtual servers present special considerations for connection 
reuse.  Under the name-based virtual server scheme, one SIP proxy 
may host many virtual domains using one IP address and port number.  
If adequate defenses are not put in place, a connection opened to 
a downstream server on behalf of one domain may be reused to send
requests in the backwards direction to a different domain.  The 
Destination Identity column in the alias table has been added to 
aid in such defenses.
</p>
<p>Connection reuse in a virtual server MUST only be done for
TLS connections, all other connection-oriented transports MUST NOT
reuse connections.  To understand why this is the case, note that
the alias table must cache not only which connections go to which
destination addresses, but also which connections have authenticated
themselves as responsible for which domains.  If a message is to be
sent in the backwards direction to a new SIP domain that resolves
to an address with a cached connection, the cached connection cannot
be used because it is not authenticated for the new domain.
</p>
<p>As an example, consider a proxy P1 that hosts two virtual 
domains -- example.com and example.net -- on the same IP address
and port.  RFC3263 server resolution is set up such that a DNS lookup
of example.com and example.net both resolve to an  {IP-address, port,
transport} tuple of {192.0.2.1, 5061, TLS}.  A user agent in the 
example.com domain sends a request to P1 causing it to make a 
downstream connection to its peering proxy, P2, and authenticating itself
as a proxy in the example.com domain by sending it a X.509 certificate
asserting such an identity.  P2's alias table now looks like the
following:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Destination  Destination  Destination  Destination     Alias
IP Address   Port         Transport    Identity        Descriptor
...
192.0.2.1    5061             TLS      sip:example.com     18
</pre></div>
<p>At some later point in time, a user agent in P2's domain wants to
send a request to a user agent in the example.net domain.  P2 performs 
a RFC3263 server resolution process on sips:example.net to derive a
resolved address tuple {192.0.2.1, 5061, TLS}.  It appears that a 
connection to this network address is already cached in the alias table, 
however, note that P2 cannot reuse this connection because the destination 
identity (sip:example.com) does not match the server identity used for 
RFC3261 resolution (sips:example.net).  Hence, P2 will open up a new 
connection to the example.net virtual domain hosted on P1.  P2's alias 
table will now look like:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Destination  Destination  Destination  Destination     Alias
IP Address   Port         Transport    Identity        Descriptor
...
192.0.2.1    5061             TLS      sip:example.com     18
192.0.2.1    5061             TLS      sip:example.net     54

</pre></div>
<p>The identities conveyed in an X.509 certificate are associated with
a specific TLS connection.  Absent such a guarantee of an identity tied
to a specific connection, a normal TCP or SCTP connection cannot be 
used to send requests in the backwards direction without a significant 
risk of inadvertent (or otherwise) connection hijacking.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Connection Reuse and SRV Interaction</h3>

<p>Connection reuse has an interaction with the DNS SRV load balancing
mechanism.  To understand the interaction, consider the following figure:
</p><br /><hr class="insert" />
<a name="fig-load-balancing"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

          /+---- S1
+-------+/
| Proxy |------- S2
+-------+\
          \+---- S3

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: Load balancing&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Here, the proxy uses DNS SRV to load balance across the three servers,
S1, S2, and S3.  Using the connect reuse mechanism specified in this
document, over time the proxy will maintain a distinct aliased connection to 
each of the servers.  However, once this is done, subsequent traffic is load 
balanced across the three downstream servers in the normal manner.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
IANA Considerations</h3>

<p>This specification defines a new Via header field parameter called
"alias" in the "Header Field Parameters and Parameter Values"
sub-registry as per the registry created by <a class='info' href='#RFC3968'>[RFC3968]<span> (</span><span class='info'>Camarillo, G., &ldquo;The Internet Assigned Numbers Authority (IANA) Header     Field Paramater Registry for the Session Initiation Protocol (SIP),&rdquo; December&nbsp;2004.</span><span>)</span></a>.
The required information is:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Header Field  Parameter Name  Predefined Values  Reference
___________________________________________________________________
Via           alias                 No           RFCXXXX

RFC XXXX [NOTE TO RFC-EDITOR: Please replace with final RFC number of
this specification.]
</pre></div>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
Acknowledgments</h3>

<p>Thanks to Jon Peterson for helpful answers about certificate behavior with 
SIP, Jonathan Rosenberg for his initial support of this concept, and 
Cullen Jennings for providing a sounding board for this idea.  Other
members of the SIP WG that contributed to this document include
Jeroen van Bemmel, Keith Drage, Matthew Gardiner, Rajnish Jain, Benny
Prijono, and Rocky Wang.
</p>
<p>Dale Worley and Hadriel Kaplan graciously performed a WGLC review of
the draft.  The resulting revision has benefited tremendously from
their feedback.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>14.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.ietf.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text">Bradner, S., &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.ietf.org/rfc/rfc2119.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2246">[RFC2246]</a></td>
<td class="author-text">Dierks, T. and C. Allen, &ldquo;<a href="http://tools.ietf.org/html/rfc2246">The TLS Protocol Version 1.0</a>,&rdquo; RFC&nbsp;2246, January&nbsp;1999 (<a href="http://www.ietf.org/rfc/rfc2246.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3263">[RFC3263]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3263">Session Initiation Protocol (SIP): Locating SIP Servers</a>,&rdquo; RFC&nbsp;3263, June&nbsp;2002 (<a href="http://www.ietf.org/rfc/rfc3263.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5234">[RFC5234]</a></td>
<td class="author-text">Crocker, D. and P. Overell, &ldquo;<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>,&rdquo; RFC&nbsp;5234, January&nbsp;2008 (<a href="http://www.ietf.org/rfc/rfc5234.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3968">[RFC3968]</a></td>
<td class="author-text">Camarillo, G., &ldquo;<a href="http://tools.ietf.org/html/rfc3968">The Internet Assigned Numbers Authority (IANA) Header 
   Field Paramater Registry for the Session Initiation Protocol (SIP)</a>,&rdquo; BCP&nbsp;98, RFC&nbsp;3968, December&nbsp;2004 (<a href="http://www.ietf.org/rfc/rfc3968.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.domain-certs">[I-D.domain-certs]</a></td>
<td class="author-text">Gurbani, V., Lawrence, S., and A. Jeffrey, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-domain-certs-00.txt">Domain Certificates in the Session Initiation Protocol (SIP)</a>,&rdquo; draft-ietf-sip-domain-certs-00 (work in progress), July&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-domain-certs-06.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>14.2.&nbsp;Informational References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sip-outbound">[I-D.ietf-sip-outbound]</a></td>
<td class="author-text">Jennings, C. and R. Mahy, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-11.txt.txt">Managing Client Initiated Connections in the Session Initiation 
         Protocol (SIP)</a>,&rdquo; draft-ietf-sip-outbound-11.txt (work in progress), November&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-11.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="Book-Rescorla-TLS">[Book-Rescorla-TLS]</a></td>
<td class="author-text">Rescorla, E., &ldquo;SSL and TLS: Designing and Building Secure Systems,&rdquo; Addison-Wesley Publishing&nbsp;, 2001.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3311">[RFC3311]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc3311">The Session Initiation Protocol (SIP) UPDATE Method</a>,&rdquo; RFC&nbsp;3311, September&nbsp;2002 (<a href="http://www.ietf.org/rfc/rfc3311.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3725">[RFC3725]</a></td>
<td class="author-text">Rosenberg, J., Peterson, J., Schulzrinne, H., and H. Camarillo, &ldquo;<a href="http://tools.ietf.org/html/rfc3725">Best Current Practices for Third Party Call Control (3pcc) in the
         Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3725, April&nbsp;2004 (<a href="http://www.ietf.org/rfc/rfc3725.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3515">[RFC3515]</a></td>
<td class="author-text">Sparks, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3515">The Session Initiation Protocol (SIP) Refer Method</a>,&rdquo; RFC&nbsp;3515, April&nbsp;2003 (<a href="http://www.ietf.org/rfc/rfc3515.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3265">[RFC3265]</a></td>
<td class="author-text">Roach, A., &ldquo;<a href="http://tools.ietf.org/html/rfc3265">The Session Initiation Protocol (SIP)-Specific Event Notification</a>,&rdquo; RFC&nbsp;3265, June&nbsp;2002 (<a href="http://www.ietf.org/rfc/rfc3265.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2960">[RFC2960]</a></td>
<td class="author-text">Stewart, R., Xie, Q., Morneault, K., Sharp, C., Schwarzbauer, H., Taylor, T., Rytina, I., Kalla, M., Zhang, L., and V. Paxson, &ldquo;<a href="http://tools.ietf.org/html/rfc2960">The Session Initiation Protocol (SIP)-Specific Event Notification</a>,&rdquo; RFC&nbsp;2960, October&nbsp;2000 (<a href="http://www.ietf.org/rfc/rfc2960.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Rohan Mahy</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Plantronics</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:rohan@ekabal.com">rohan@ekabal.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Vijay K. Gurbani (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bell Laboratories, Alcatel-Lucent</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:vkg@alcatel-lucent.com">vkg@alcatel-lucent.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Brett Tate</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">BroadSoft</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:brett@broadsoft.com">brett@broadsoft.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
