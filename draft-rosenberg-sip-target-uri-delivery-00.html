<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Delivery of Request-URI Targets to User Agents</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Delivery of Request-URI Targets to User Agents">
<meta name="keywords" content="SIP, IMS">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">SIPPING</td><td class="header">J. Rosenberg</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">October 27, 2008</td></tr>
<tr><td class="header">Expires: April 30, 2009</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Delivery of Request-URI Targets to User Agents<br />draft-rosenberg-sip-target-uri-delivery-00</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on April 30, 2009.</p>

<h3>Abstract</h3>

<p>When a Session Initiation Protocol (SIP) proxy receives
            a request targeted at a URI identifying a user or resource it
            is responsible for, the proxy translates the URI to a
            registered contact URI of an agent representing that user
            or resource. In the process, the original URI is removed
            from the request. Numerous use cases have arisen which
            require this information to be delivered to the user
            agent. This document describes these use cases and defines
            an extension to the History-Info header field which allows
            it to be used to support those cases.
	    
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#sec-problems">2.</a>&nbsp;
Problem Statement<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-alias">2.1.</a>&nbsp;
Unknown Aliases<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">2.2.</a>&nbsp;
Unknown GRUU<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">2.3.</a>&nbsp;
Limited Use Addresses<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">2.4.</a>&nbsp;
Sub-Addressing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">2.5.</a>&nbsp;
Service Invocation<br />
<a href="#sec-arch">3.</a>&nbsp;
Architectural Roots of the Problem<br />
<a href="#sec-solution">4.</a>&nbsp;
Solution Overview<br />
<a href="#sec-details">5.</a>&nbsp;
Detailed Semantics<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">5.1.</a>&nbsp;
Proxy Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">5.2.</a>&nbsp;
UA Behavior<br />
<a href="#anchor8">6.</a>&nbsp;
Syntax<br />
<a href="#anchor9">7.</a>&nbsp;
Security Considerations<br />
<a href="#rfc.references1">8.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">8.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">8.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>
A key part of the behavior of proxy servers and B2BUA in the Session
Initiation Protocol (SIP) <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> is that they
rewrite the Request-URI of requests as the request moves from the User
Agent Client (UAC) to the User Agent Server (UAS). This is
particularly true for requests outside of a dialog; requests within a
dialog have their path dictated primarily by the Route header fields
established by the Record-Routes when the dialog was initiated.

</p>
<p>
The most basic instance of this behavior is the processing executed by
the "home proxy" within a domain. The home proxy is the proxy server
within a domain which accesses the location information generated by
REGISTER messages, and uses it to forward a request towards a
UAC. Based on the rules in RFC 3261, when a home proxy receives a SIP
request, it looks up the Request-URI in the location database, and
translates it to the contact(s) that were registered by the UA. This
new contact URI replaces the existing Request URI, and causes the
request to be forwarded towards the target UA. Consequently, the
original contents of the Request URI are lost.

</p>
<p>
Over the years, this practice of rewriting the Request-URI has proven
problematic. <a class='info' href='#sec-problems'>Section&nbsp;2<span> (</span><span class='info'>Problem Statement</span><span>)</span></a> describes the problems with
this mechanism. <a class='info' href='#sec-arch'>Section&nbsp;3<span> (</span><span class='info'>Architectural Roots of the Problem</span><span>)</span></a> analyzes the
architectural issues which drive these problems. <a class='info' href='#sec-solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Overview</span><span>)</span></a> overviews a mechanism to solve this problem by
extending the History-Info header field. <a class='info' href='#sec-details'>Section&nbsp;5<span> (</span><span class='info'>Detailed Semantics</span><span>)</span></a>
describes detailed procedures for user agents and proxies.

</p>
<a name="sec-problems"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Problem Statement</h3>

<p>
Several problems arise from the practice of rewriting the request URI.

</p>
<a name="sec-alias"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
Unknown Aliases</h3>

<p>
SIP user agents are associated with an address-of-record (AOR). It is
possible for a single UA to actually have multiple AOR associated with
it. One common usage for this is aliases. For example, a user might
have an AOR of sip:john@example.com but also have the AORs
sip:john.smith@example.com and sip:jsmith@example.com. Rather than
registering against each of these AORs individually, the user would
register against just one of them, and the home proxy would
automatically accept incoming calls for any of the aliases, treating
them identically and ultimately forwarding them towards the UA. This
is common practice in the Internet Multimedia Subsystem (IMS), where
it is called implicit registrations and each alias is called a public
identity.

</p>
<p>
It is a common requirement for a UAS, on receipt of a call, 
to know which of its aliases was used to reach it. This knowledge can
be used to choose ringtones to play, determine call treatment, and so
on. For example, a user might give out one alias to friends and family
only, resulting in a special ring that alerts the user to the
importance of the call. 

</p>
<p>
However, based on the procedures in RFC 3261, when an incoming call
hits the home proxy, the request URI (which contains the alias) is
rewritten to the registered contact(s). Consequently, the alias that
was used is lost, and cannot be known to the UAS. 

</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Unknown GRUU</h3>

<p>
A variation on the problem in <a class='info' href='#sec-alias'>Section&nbsp;2.1<span> (</span><span class='info'>Unknown Aliases</span><span>)</span></a> occurs with
Globally Routable User Agent URI (GRUU) <a class='info' href='#I-D.ietf-sip-gruu'>[I&#8209;D.ietf&#8209;sip&#8209;gruu]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the  Session Initiation Protocol (SIP),&rdquo; October&nbsp;2007.</span><span>)</span></a>. A GRUU is a URI assigned to a UA
instance which has many of the same properties as the AOR, but causes
requests to be routed only to that specific instance. It is desirable
for a UA to know whether it was reached because a correspondent sent a
request to its GRUU or to its AOR. This can be used to drive differing
authorization policies on whether the request should be accepted or
rejected, for example. However, like the AOR itself, the GRUU is lost
in translation at the home proxy. Thus, the UAS cannot know whether it
was contacted via the GRUU or its AOR.

</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
Limited Use Addresses</h3>

<p>
A limited use address is an SIP URI that is minted on-demand, and
passed out to a small number (usually one) remote
correspondent. Incoming calls targeted to that limited use address are
accepted as long as the UA still desires communications from the
remote target. Should they no longer wish to be bothered by that
remote correspondent, the URI is invalidated so that future requests
targeted to it are rejected.

</p>
<p>
Limited use addresses are used in battling voice spam <a class='info' href='#RFC5039'>[RFC5039]<span> (</span><span class='info'>Rosenberg, J. and C. Jennings, &ldquo;The Session Initiation Protocol (SIP) and Spam,&rdquo; January&nbsp;2008.</span><span>)</span></a>. The easiest way to provide them
would be for a UA to be able to take its AOR, and "mint" a limited use
address by appending additional parameters to the URI. It could then
give out the URI to a particular correspondent, and remember that URI
locally. When an incoming call arrives, the UAS would examine the
parameter in the URI and determine whether or not the call should be
accepted. Alternatively, the UA could push authorization rules into
the network, so that it need not even see incoming requests that are
to be rejected.

</p>
<p>
This approach, especially when executed on the UA, requires that
parameters attached to the AOR, but not used by the home proxy in
processing the request, will survive the translation at the home proxy
and be presented to the UA. This will not be the case with the logic
in RFC 3261, since the Request-URI is replaced by the registered
contact, and any such parameters are lost.

</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.4"></a><h3>2.4.&nbsp;
Sub-Addressing</h3>

<p>
Sub-Addressing is very similar to limited use addresses. Sub-addresses
are addresses within a subdomain that are multiplexed into a single
address within a parent domain. The concept is best illustrated by
example. Consider a VoIP service provided to consumers. A
consumer obtains a single address from its provider, say
sip:family@example.com. However, Joe is the patriarch of a family with
four members, and would like to be able to have a separate identifier
for each member of his family. One way to do that, without requiring
Joe to purchase new addresses for each member from the provider, is
for Joe to mint additional URI by adding a parameter to the AOR. For
example, his wife Judy with have the URI
sip:family@example.com;member=judy, and Joe himself would have the URI
sip:family@example.com;member=joe. The SIP server provider would
receive requests to these URI, and ignoring the unknown parameters (as
required by RFC 3261) route the request to the registered contact,
which corresponds to a SIP server in Joes home. That server, in turn,
can examine the URI parameters and determine which phone in the home
to route the call to.

</p>
<p>
This feature is not specific to VoIP, and has existing in Integrated
Services Digital Networking (ISDN) for some time. It is particularly
useful for small enterprises, in addition to families. It is also
similar in spirit (though not mechanism) to the ubiquitous home
routers used by consumers, which allow multiple computers in the home
to "hide" behind the single IP address provided by the service
provider, by using the TCP and UDP port as a sub-address. 

</p>
<p>
The sub-addressing feature is not currently feasible in SIP because of
the fact that any SIP URI parameter used to convey the sub-address
would be lost at the home proxy, due to the fact that the Request-URI
is rewritten there.

</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.5"></a><h3>2.5.&nbsp;
Service Invocation</h3>

<p>
Several SIP specifications have been developed which make use of
complex URIs to address services within the network rather than
subscribers. The URIs are complex because they contain numerous
parameters that control the behavior of the service. Examples of this
include the specification which first introduced the concept, RFC 3087
<a class='info' href='#RFC3087'>[RFC3087]<span> (</span><span class='info'>Campbell, B. and R. Sparks, &ldquo;Control of Service Context using SIP Request-URI,&rdquo; April&nbsp;2001.</span><span>)</span></a>, control of network announcements and IVR
with SIP URI <a class='info' href='#RFC4240'>[RFC4240]<span> (</span><span class='info'>Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;Basic Network Media Services with SIP,&rdquo; December&nbsp;2005.</span><span>)</span></a>, and control of voicemail access
with SIP URI <a class='info' href='#RFC4458'>[RFC4458]<span> (</span><span class='info'>Jennings, C., Audet, F., and J. Elwell, &ldquo;Session Initiation Protocol (SIP) URIs for Applications such as Voicemail and Interactive Voice Response (IVR),&rdquo; April&nbsp;2006.</span><span>)</span></a>. 

</p>
<p>
A common problem with all of these mechanisms is that once a proxy has
decided to rewrite the Request-URI to point to the service, it cannot
be sure that the Request-URI will not be destroyed by a downstream
proxy which decides to forward the request in some way, and does so by
rewriting the Request-URI.

</p>
<a name="sec-arch"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Architectural Roots of the Problem</h3>

<p>
There is a common theme across all of the problems in <a class='info' href='#sec-problems'>Section&nbsp;2<span> (</span><span class='info'>Problem Statement</span><span>)</span></a>, and this theme is the confounding of names,
routes, and addresses.

</p>
<p>
A name is a moniker for an entity which refers to it in a way which
reveals nothing about where it is in a network. On the Internet, names
are ideally provided through Universal Resource Names (URNs). An
address is an identifier for an entity which describes it by 
its location on the network. In SIP, the SIP URI itself is a form of
address because the host part of the URI, the only mandatory part of
the URI besides the scheme itself, indicates the location of a SIP
server that can be used to handle the request. Finally, a route is a
sequence of SIP entities (including the UA itself!) which are
traversed in order to forward a request to an address or name.

</p>
<p>
SIP, unfortunately, uses the Request-URI as a mechanism for routing of
the request in addition to using it as the mechanism for identifying
the name or address to which the request was targeted. A home proxy
rewrites the Request-URI because that rewriting is the vehicle by
which the request is forwarded to the target of the request. However,
this rewritten URI (the contact from the register), is not in any way
a meaningful name or address for the UA. Indeed, with specifications
like SIP outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>, even the IP
address within the registered contact is meaningless since the flow on
which the REGISTER is sent is used rather than the IP
address. Consequently, the home proxy is fundamentally replacing the
*address* in the Request-URI with a *route* to reach that UA. This
architectural mistake is the cause of the problems described above.

</p>
<p>
Interestingly, this same mistake was present in RFC 2543 <a class='info' href='#RFC2543'>[RFC2543]<span> (</span><span class='info'>Handley, M., Schulzrinne, H., Schooler, E., and J. Rosenberg, &ldquo;SIP: Session Initiation Protocol,&rdquo; March&nbsp;1999.</span><span>)</span></a> for the handling of mid-dialog requests. It was
fixed through the loose routing mechanism in RFC 3261, which used
Route header fields to identify each hop to visit for a mid-dialog
request, and separated this from the Request-URI, which identified the
ultimate target of the request (the remote UA), and remained
unmodified in the processing of the request. 

</p>
<p>
Unfortunately, application of this same technique to address the
problem at hand cannot be done in a backwards compatible
manner. Consequently, some other means is needed to clearly identify
which URIs are addresses, and which are routes. To avoid confusion, we
refer to a SIP URI that is an address for a user or resource as a
"target" and a SIP URI that is a hop for reaching that user as a
"hop".

</p>
<a name="sec-solution"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Solution Overview</h3>

<p>
The History-Info header field, defined in <a class='info' href='#RFC4244'>[RFC4244]<span> (</span><span class='info'>Barnes, M., &ldquo;An Extension to the Session Initiation Protocol (SIP) for Request History Information,&rdquo; November&nbsp;2005.</span><span>)</span></a>,
defines a mechanism by which an enumeration of the URIs traversed can
be passed to both the UAC and UAS. History-Info was designed to
provide a general purpose mechanism which can support the needs of
many applications, including diagnostics and traditional telephony
features like voicemail. Were a home proxy to implement History-Info,
it would provide a means for that proxy to deliver the target URI to
the UAS. 

</p>
<p>
Unfortunately, History-Info makes no distinction between URIs that are
targets and URIs that are hops. Consequently, if there were additional
proxies downstream of the home proxy which modified the Request-URI in
any way, the UA would have no way to know which URI in the list of
History-Info values was actually the target. To remedy that, this
document defines an extension to the History-Info header field which
indicates whether the URI is a target or not.

</p>
<p>
When a home proxy receives a request for a user or resource for which
it has a registration, the proxy adds two History-Info header field
values. The first is the incoming request URI. Since the
Request-URI identifies a user or resource for which it has a
registration, the Request-URI is an AOR and thus an address for the
user. The proxy adds a History-Info header field parameter, "target",
which indicates this. Next, the proxy inserts the contact URI it used
in the outgoing Request-URI. No target parameter is included in this
History-Info value. 

</p>
<p>
For a UA to determine the URI target, it need only walk backwards
through the list of HI values, and take the first one containing the
"target" parameter. 

</p>
<p>
For example, consider the architecture in
<a class='info' href='#fig-turi'>Figure&nbsp;1<span> (</span><span class='info'>Target URI Example</span><span>)</span></a>. In the example user A calls user B. User B
is in example.com. The call from A to B passes through A's outbound
proxy, their home proxy, B's home proxy, and B's outbound proxy, prior
to reaching B. B's home proxy, H-B, performs the translation of the
R-URI to the registered contact based on the registration
database. Consequently, it adds two History-Info header fields, the
first of which represents the incoming R-URI and includes the "target"
parameter. 

</p><br /><hr class="insert" />
<a name="fig-turi"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>


              +-------+    +-------+   +-------+   +-------+
   //--\\     |       |    |       |   |       |   |       |   //--\\
  |  A   |--- | OB-A  |----|  H-A  |---| H-B   |---| OB-B  |--|  B   |
  |      |    |       |    |       |   |       |   |       |  |      |
   \\--//     +-------+    +-------+   +-------+   +-------+   \\--//

       INVITE
       sip:B@example.com
      ------------&gt;
                  INVITE
                  sip:B@example.com
                 ------------&gt;
                              INVITE
                              sip:B@example.com
                             ------------&gt;

                                          INVITE
                                          sip:B@example.com
                               HI: &lt;sip:B@example.com&gt;index=1;target,
                                   &lt;sip:B@1.2.3.4&gt;;index=1.1

                                         ------------&gt;
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Target URI Example&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="sec-details"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Detailed Semantics</h3>

<p>
The "target" parameter in the History-Info header field indicates that
the URI that it parameterizes was subject to a lookup in a location
service created through the registration process of the
UA. Furthermore, if that URI had an 'index' of N, the URIs with
indices N.M for all M, are the registered contacts to that URI. 

</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Proxy Behavior</h3>

<p>
A proxy compliant to this specification SHOULD add a History-Info
header field value to a request under the following conditions:

</p>
<ul class="text">
<li>
The proxy is responsible for the domain in AOR in the Request-URI
</li>
<li>The proxy will be translating the contents of the Request-URI to
  one or more registered contacts based on a location database
  populated through REGISTER requests from user agents.

</li>
<li>The R-URI exists in the location database.
</li>
</ul>
<p>
The proxy SHOULD populate the History-Info header field regardless of
whether there is a Supported header field with value 'histinfo'. If
the incoming request already contains a History-Info header field, and
the last value of that header field is identical to the Request-URI of
the received request, the proxy MUST add a "target" attribute to that
History-Info value. If the request did not contain a History-Info
header field, or if it did, but the last value is not identical to the
Request-URI of the received request, the proxy MUST add another
History-Info header field value. The URI MUST be equal to the incoming
Request-URI, and MUST contain a "target" attribute. The index is set
as defined in RFC 4244.

</p>
<p>
Once the proxy has translated the Request-URI into a registered
contact, it MUST add an additional History-Info header field value
containing the Contact URI for each request to be forwarded. The
"target" attribute MUST NOT be present. The index is set
as defined in RFC 4244.

</p>
<p>
Since the principal purpose of the "target" parameter is to indicate,
to a UAS, the target URI by which it was reached, there is no need for
the History-Info header field values to be passed outside of the
domain which inserted them. There may be other applications of
History-Info which require it, however.

</p>
<p>
If the proxy is actually redirecting and not forwarding the request,
it SHOULD include a History-Info URI in the response for the
target. That URI, if present, MUST contain the 'target' attribute. It
SHOULD NOT add a History-Info URI for the registered contact; the
previous hop proxy will do that. Note that, this rule violates a
SHOULD-strength rule in Section 4.3.4 of RFC 4244. That section
indicates that redirections "SHOULD NOT" contain any new History-Info
header fields, as those will be added by the upstream server. For this
application however, only the downstream server knows that the R-URI
was a target, and thus the History-Info header field and the "target"
attribute must be added by the downstream server.

</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
UA Behavior</h3>

<p>
A UAS receiving a request, and wishing to determine the original
target dialog, takes the values in the History-Info header field, and
traverses through them in reverse order. Note that, the value of the
"index" attribute is not relevant; the traversal is in order of the
header fields values themselves. The UAS finds the first header field
value containing the "target" parameter. If such a value does not
exist, the target URI cannot be reliably determined. If it does exist,
the URI is examined. If the domain of the URI matches the domain of
the UA, based on the UA's configured awareness of its own domain, that
URI is the target URI. If the domains do not match, the target URI
cannot be reliably determined. This domain check is present to handle
cases where a request is forwarded through two separate domains, and
the domain of the actual UAS didn't support this specification, but
the previous domain did.

</p>
<p>
Beyond this, there is no special UA processing associated with the
"target" parameter.

</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Syntax</h3>

<p>
This specification extends the syntax of hi-param in Section 4.1 of
RFC 4244:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

hi-param = hi-index / hi-target / hi-extension

hi-target = "target"
</pre></div>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Security Considerations</h3>

<p>
The "target" parameter indicates that a URI was subject to translation
by a home proxy, and consequently, acts as an explicit indicator that
a particular URI was an AOR for a user. This might be useful for
attackers wishing to farm requests for targettable URIs for purposes
of spamming. Of course, such attackers can utilize URIs in
History-Info even if they lack the "target" attribute, so "target"
does not really exacerbate this. Nonetheless, since the princpal
application of the "target" parameter is delivery of a URI to a UAS
within the same domain, History-Info values inserted solely for this
purpose SHOULD be removed at the domain boundary.

</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4244">[RFC4244]</a></td>
<td class="author-text">Barnes, M., &ldquo;<a href="http://tools.ietf.org/html/rfc4244">An Extension to the Session Initiation Protocol (SIP) for Request History Information</a>,&rdquo; RFC&nbsp;4244, November&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4244.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sip-gruu">[I-D.ietf-sip-gruu]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-gruu-15.txt">Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the  Session Initiation Protocol (SIP)</a>,&rdquo; draft-ietf-sip-gruu-15 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-gruu-15.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5039">[RFC5039]</a></td>
<td class="author-text">Rosenberg, J. and C. Jennings, &ldquo;<a href="http://tools.ietf.org/html/rfc5039">The Session Initiation Protocol (SIP) and Spam</a>,&rdquo; RFC&nbsp;5039, January&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5039.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3087">[RFC3087]</a></td>
<td class="author-text">Campbell, B. and R. Sparks, &ldquo;<a href="http://tools.ietf.org/html/rfc3087">Control of Service Context using SIP Request-URI</a>,&rdquo; RFC&nbsp;3087, April&nbsp;2001 (<a href="http://www.rfc-editor.org/rfc/rfc3087.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4240">[RFC4240]</a></td>
<td class="author-text">Burger, E., Van Dyke, J., and A. Spitzer, &ldquo;<a href="http://tools.ietf.org/html/rfc4240">Basic Network Media Services with SIP</a>,&rdquo; RFC&nbsp;4240, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4240.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4458">[RFC4458]</a></td>
<td class="author-text">Jennings, C., Audet, F., and J. Elwell, &ldquo;<a href="http://tools.ietf.org/html/rfc4458">Session Initiation Protocol (SIP) URIs for Applications such as Voicemail and Interactive Voice Response (IVR)</a>,&rdquo; RFC&nbsp;4458, April&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4458.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sip-outbound">[I-D.ietf-sip-outbound]</a></td>
<td class="author-text">Jennings, C., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-20.txt">Managing Client Initiated Connections in the Session Initiation Protocol  (SIP)</a>,&rdquo; draft-ietf-sip-outbound-20 (work in progress), June&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-20.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2543">[RFC2543]</a></td>
<td class="author-text"><a href="mailto:mjh@aciri.org">Handley, M.</a>, <a href="mailto:schulzrinne@cs.columbia.edu">Schulzrinne, H.</a>, <a href="mailto:schooler@cs.caltech.edu">Schooler, E.</a>, and <a href="mailto:jdrosen@bell-labs.com">J. Rosenberg</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2543">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;2543, March&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2543.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jonathan Rosenberg</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Edison, NJ</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jdrosen@cisco.com">jdrosen@cisco.com</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.jdrosen.net">http://www.jdrosen.net</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
