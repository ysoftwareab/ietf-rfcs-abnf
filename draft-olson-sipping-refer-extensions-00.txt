

SIPPING                                                         S. Olson
Internet-Draft                                                 Microsoft
Expires: December 19, 2003                                 June 20, 2003


     Extensions to the REFER mechanism for Third Party Call Control
                draft-olson-sipping-refer-extensions-00

Status of this Memo

   This document is an Internet-Draft and is in full conformance with
   all provisions of Section 10 of RFC2026.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF), its areas, and its working groups. Note that other
   groups may also distribute working documents as Internet-Drafts.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time. It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   The list of current Internet-Drafts can be accessed at http://
   www.ietf.org/ietf/1id-abstracts.txt.

   The list of Internet-Draft Shadow Directories can be accessed at
   http://www.ietf.org/shadow.html.

   This Internet-Draft will expire on December 19, 2003.

Copyright Notice

   Copyright (C) The Internet Society (2003). All Rights Reserved.

Abstract

   This document proposes a number of extensions to the REFER method
   used by the Session Initiation Protocol (SIP) for the purpose of
   third party call control.













Olson                  Expires December 19, 2003                [Page 1]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


Table of Contents

   1.  Terminology  . . . . . . . . . . . . . . . . . . . . . . . . .  3
   2.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  4
   3.  Requirements . . . . . . . . . . . . . . . . . . . . . . . . .  5
   4.  Use of the application/dialog-info+xml MIME type with REFER  .  6
   5.  Extending REFER to SIP response codes  . . . . . . . . . . . . 11
   6.  Supressing forking of REFER requests . . . . . . . . . . . . . 18
   7.  Supressing the NOTIFY associated with a REFER  . . . . . . . . 19
   8.  Replacing complex Refer-To URIs with a MIME body . . . . . . . 21
   9.  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . 24
   9.1 norefersub option tag registration . . . . . . . . . . . . . . 24
   9.2 refer-response option tag registration . . . . . . . . . . . . 24
   10. Security Considerations  . . . . . . . . . . . . . . . . . . . 25
   11. Acknowledgements . . . . . . . . . . . . . . . . . . . . . . . 26
       References . . . . . . . . . . . . . . . . . . . . . . . . . . 27
       Author's Address . . . . . . . . . . . . . . . . . . . . . . . 27
       Intellectual Property and Copyright Statements . . . . . . . . 28

































Olson                  Expires December 19, 2003                [Page 2]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


1. Terminology

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in RFC 2119 [1].

   To simplify discussions of the REFER method and its extensions, three
   new terms will be defined:

      REFER-Issuer: the UA issuing the REFER request

      REFER-Recipient: the UA receiving the REFER request

      REFER-Target: the UA designated in the Refer-To URI





































Olson                  Expires December 19, 2003                [Page 3]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


2. Introduction

   The REFER [3] extension to SIP [2] defines a basis for third party
   call control that is useful for implementing features such as call
   transfer. REFER has a few limitations with respect to implementing
   more advanced features in conjunction with the dialog info event
   package [7]. These limitations derive in part from the limited
   information available in the message/sipfrag [4] content of the
   associated NOTIFY. Another limiting factor is the requirement to
   compress the semantics of the referred request in the Refer-To URI by
   encoding the desired headers as parameters of that URI. Finally,
   there are situations where the party issuing the REFER request does
   not need the NOTIFY associated with the REFER, perhaps because that
   agent is already subscribed to the appropriate dialog package outside
   of the REFER request. This represents additional unnecessary traffic
   and state in the REFER-Issuer and REFER-recipient.



































Olson                  Expires December 19, 2003                [Page 4]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


3. Requirements

   Requirement 1: Allow the REFER-Issuer to watch the progress of a
      REFER beyond the end of the INVITE transaction and for the
      duration of the dialog

   Requirement 2: Expose the dialog information of the dialog
      established at the REFER-Recipient as a result of the REFER

   Requirement 3: Allow specification of much richer detail of the
      request that is generated at the REFER-Recipient as a result of
      the REFER beyond just the method and Request-URI. Examples include
      caller preferences, portions of the SDP, and user defined headers.

   Requirement 4: Allow one user agent to specify that another user
      agent answer an incoming call

   Requirement 5: Prevent forking of a REFER request and allow targeting
      of that REFER request to a specific device or class of device.

   Requirement 6: Reduce the number of messages exchanged to perform a
      REFER when the REFER-Issuer and REFER-Recipient support richer
      call control primitives such as the dialog and conference event
      packages.



























Olson                  Expires December 19, 2003                [Page 5]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


4. Use of the application/dialog-info+xml MIME type with REFER

   The REFER specification [3] mandates the use of the message/sipfrag
   [4] MIME type for NOTIFYs of the refer event package. These NOTIFYs
   are sent as part of the implicit subscription created by the REFER.
   The purpose of the NOTIFY is to communicate the state of the
   transaction between the REFER-Recipient and the REFER-Target that is
   created as a result of the REFER

   Where the purpose of sending the REFER is actually to establish a
   dialog, for example through an INVITE in the Refer-To, the derivative
   state of interest is actually the dialog state. While this may be
   inferred from the contents of the message/sipfrag body it is a bit
   clumsy and in many cases the REFER-Recipient will omit important
   details of the dialog in the message/sipfrag body. Two things that
   are generally lacking from the message/sipfrag content are the dialog
   identifier (Call-ID plus local and remote tags) and the state of the
   dialog. Not coincidentally, this is the same information available in
   the application/dialog-info+xml MIME type [7] used for the dialog
   event package.

   To address this shortcoming, it is proposed to extend REFER to allow
   the (optional) use of the application/dialog-info+xml MIME type in
   place of message/sipfrag. The REFER-Issuer specifies support for this
   by including this MIME type in an Accept header. The REFER-Issuer
   MUST also support message/sipfrag for compatibility with strictly
   RFC3515 compliant implementations. If the REFER-Recipient supports
   this extension, it may choose to honor the request or default to
   using message/sipfrag dependent on local policy. It is OPTIONAL for
   the REFER-Recipient to maintain the subscription for the duration of
   the resultant (INVITE) dialog and RECOMMENDED that the subscription
   be maintained at least until the dialog is in "confirmed" state.

   Figure 1: Example of using application/dialog-info+xml


   		   REFER-Issuer               REFER-Recipient           REFER-Target
   		        |                            |                        |
   			|  M1  REFER (INVITE)        |                        |
   			|--------------------------->|                        |
   			|      M2 202 Accepted       |                        |
   			|<---------------------------|                        |
   			|      M3 NOTIFY             |                        |
   			|<---------------------------|                        |
   		        |      M4 200 OK             |                        |
   			|--------------------------->|                        |
   			|                            |  M5  INVITE            |
   			|                            |----------------------->|



Olson                  Expires December 19, 2003                [Page 6]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   			|      M6 NOTIFY             |                        |
   			|<---------------------------|                        |
   		        |      M7 200 OK             |                        |
   			|--------------------------->|                        |
   			|                            |      M8 180 Ringing    |
   			|                            |<-----------------------|
   			|      M9 NOTIFY             |                        |
   			|<---------------------------|                        |
   		        |      M10 200 OK            |                        |
   			|--------------------------->|                        |
   			|                            |      M11 200 OK        |
   			|                            |<-----------------------|
   			|      M12 NOTIFY            |                        |
   			|<---------------------------|                        |
   			|      M13 200 OK            |                        |
   			|--------------------------->|      M14 ACK           |
   			|                            |----------------------->|


   Message flow:

   M1: The REFER-Issuer creates a REFER, specifying a preference for the
      application/dialog-info+xml MIME type.




   REFER sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP issuer.tradewind.com;branch=z9hG4bK-a-1
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>
   Call-ID: 1@issuer.tradewind.com
   CSeq: 234234 REFER
   Max-Forwards: 70
   Refer-To: sip:c@tradewind.com;method=INVITE
   Accept: application/dialog-info+xml;q=0.5, message/sipfrag;q=0.1
   Contact: sip:a@issuer.tradewind.com
   Content-Length: 0


   M5: The REFER-Recipient creates an appropriate INVITE based on the
      REFER and sends it to the REFER-Target.




   INVITE sip:c@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP recipient.tradewind.com;branch=z9hG4bK-b-1



Olson                  Expires December 19, 2003                [Page 7]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   From: <sip:b@tradewind.com>;tag=1bc
   To: <sip:c@tradewind.com>
   Call-ID: 1@recipient.tradewind.com
   CSeq: 1234567 INVITE
   Max-Forwards: 70
   Contact: sip:b@recipient.tradewind.com
   Content-Length: ...

   <SDP for audio call>


   M6: The REFER-Recipient sends a NOTIFY triggered by the INVITE being
      sent to the REFER-Target. The body of the NOTIFY contains the
      dialog identifier and current state ("trying").




   NOTIFY sip:a@issuer.tradewind.com SIP/2.0
   Via: SIP/2.0/TCP recipient.tradewind.com;branch=z9hG4bK-b-2
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>;tag=1ba
   Call-ID: 1@issuer.tradewind.com
   CSeq: 1278784 NOTIFY
   Max-Forwards: 70
   Event: refer;id=234234
   Subscription-State: active;expires=3600
   Contact: sip:b@recipient.tradewind.com
   Content-Type: application/dialog-info+xml
   Content-Length: ...

   <?xml version="1.0" ?>
   <dialog-info xmlns="urn:ietf:params:xml:ns:dialog-info"
                version="1"
                state="partial"
   	     entity="sip:b@tradewind.com">
       <dialog id="2" call-id="1@recipient.tradewind.com"
   	    local-tag="1bc"
   	    direction="initiator">
   	    <state>trying</state>
       </dialog>
   </dialog-info>


   M9: The REFER-Recipient sends a NOTIFY triggered by the 180 Ringing
      received from the REFER-Target. The body of the NOTIFY contains
      the dialog identifier and current state ("early").




Olson                  Expires December 19, 2003                [Page 8]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003





   NOTIFY sip:a@issuer.tradewind.com SIP/2.0
   Via: SIP/2.0/TCP recipient.tradewind.com;branch=z9hG4bK-b-3
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>;tag=1ba
   Call-ID: 1@issuer.tradewind.com
   CSeq: 1278785 NOTIFY
   Max-Forwards: 70
   Event: refer;id=234234
   Subscription-State: active;expires=3600
   Contact: sip:b@recipient.tradewind.com
   Content-Type: application/dialog-info+xml
   Content-Length: ...

   <?xml version="1.0" ?>
   <dialog-info xmlns="urn:ietf:params:xml:ns:dialog-info"
                version="2"
                state="partial"
   	     entity="sip:b@tradewind.com">
       <dialog id="2" call-id="1@recipient.tradewind.com"
   	    local-tag="1bc" remote-tag="1cb"
   	    direction="initiator">
   	    <state>early</state>
       </dialog>
   </dialog-info>


   M12: The REFER-Recipient sends a NOTIFY triggered by the 200 OK
      received from the REFER-Target. The body of the NOTIFY contains
      the dialog identifier and current state ("confirmed").




   NOTIFY sip:a@issuer.tradewind.com SIP/2.0
   Via: SIP/2.0/TCP recipient.tradewind.com;branch=z9hG4bK-b-4
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>;tag=1ba
   Call-ID: 1@issuer.tradewind.com
   CSeq: 1278786 NOTIFY
   Max-Forwards: 70
   Event: refer;id=234234
   Subscription-State: active;expires=3600
   Contact: sip:b@recipient.tradewind.com
   Content-Type: application/dialog-info+xml
   Content-Length: ...



Olson                  Expires December 19, 2003                [Page 9]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   <?xml version="1.0" ?>
   <dialog-info xmlns="urn:ietf:params:xml:ns:dialog-info"
                version="3"
                state="partial"
   	     entity="sip:b@tradewind.com">
       <dialog id="2" call-id="1@recipient.tradewind.com"
   	    local-tag="1bc" remote-tag="1cb"
   	    direction="initiator">
   	    <state>confirmed</state>
       </dialog>
   </dialog-info>








































Olson                  Expires December 19, 2003               [Page 10]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


5. Extending REFER to SIP response codes

   REFER is currently defined to trigger the sending of a request from
   the REFER-Recipient to the REFER-Target. The intention is most often
   to initiate a dialog from the REFER-Recipient to the REFER-Target.
   This is an excellent way to generate an action at the REFER-Recipient
   based on an event or action that takes places at the REFER-Issuer.
   The classic example is call transfer as a result of a user at the
   REFER-Issuer taking some action.

   With the use of the dialog event package, it is possible for one UA
   to monitor events at another UA related to a dialog, such as the
   receipt of an INVITE to establish a new dialog. What is lacking is a
   way for the watcher to indicate what should be the response to such
   an INVITE request. For example, the dialog watcher would like the
   recipient of the session initiation request to accept the initiation
   (send a 200 OK response to the INVITE request). One motivating
   scenario for this is a set of co-operating User Agents (devices) that
   belong to the same user. The user, while using one SIP device, wishes
   to answer a call that is being received on another of that user's SIP
   devices. This gives the user a single UI focus for control while
   allowing multiple devices with differing capabilities.

   To enable such a scenario, this document proposes an extension to the
   SIP(S) URI syntax as defined in SIP [2] The extension is analogous to
   the "method" uri-parameter that currently exists to communicate a
   method for use in the Refer-To header. A new uri-parameter,
   "response", is proposed that is used in conjunction with the "method"
   uri-parameter and associated call-id, local tag, and remote tag to
   request that the REFER-Recipient send a response within the
   identified SIP transaction to the REFER-Target.

   The REFER-Issuer MUST specify a "method" parameter in addition to the
   "response" parameter. The REFER-Issuer MUST also include the
   appropriate local-uri, local-tag, remote-uri, and remote-tag encoded
   as From and To headers in the Refer-To URI (or using a message/
   sipfrag body as defined later in this document). Note that in order
   to satisfy this requirement, the REFER-Issuer must have access to
   this information. In particular, it is assumed that the REFER-Issuer
   receives the local-uri and remote-uri in the NOTIFY for the dialog
   event package from the REFER-Recipient. These elements are optional
   in the XML schema. It is anticipated that User Agents that support
   these REFER extensions will also include these optional elements in
   the application/dialog-info+xml payload (as privacy concerns allow).

   To ensure the REFER-Recipient conformant with RFC3515 does not
   misintepret this as a REFER to send a request of the specified
   method, the REFER-Issuer MUST also include a Require: refer-response



Olson                  Expires December 19, 2003               [Page 11]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   header in the REFER request. REFER-Recipients which do not understand
   this extension will return a 420 response. The REFER-Target does not
   need to understand this extension for this to work. Support for this
   extension can be queried in advance using a standard OPTIONS request.

   The REFER-Issuer MUST request the use of the application/
   dialog-info+xml MIME type in NOTIFYs associated with a REFER request
   which uses this "response" extension.

   The proposed syntax modification follows



   uri-parameters    =  *( ";" uri-parameter)
   uri-parameter     =  transport-param / user-param / method-param
       / ttl-param / maddr-param / lr-param / response-param / other-param
   response-param    = "response=" 1*3DIGIT


   An example call flow follows:

   Figure 2: Example of using the "response" uri-parameter in the
   Refer-To header


   		   REFER-Issuer               REFER-Recipient           REFER-Target
   		        |                            |                        |
   			|  N1  SUBSCRIBE (dialog)    |                        |
   			|--------------------------->|                        |
   			|      N2 202 Accepted       |                        |
   			|<---------------------------|                        |
   			|      N3 NOTIFY             |                        |
   			|<---------------------------|                        |
   		        |      N4 200 OK             |                        |
   			|--------------------------->|                        |
   			|                            |   N5 INVITE            |
   			|                            |<-----------------------|
   			|      N6 NOTIFY             |                        |
   			|<---------------------------|                        |
   		        |      N7 200 OK             |                        |
   			|--------------------------->|                        |
   			|                            |   N8 180 Trying        |
   			|                            |----------------------->|
   			|      N9 NOTIFY             |                        |
   			|<---------------------------|                        |
   		        |      N10 200 OK            |                        |
   			|--------------------------->|                        |
   			|                            |                        |



Olson                  Expires December 19, 2003               [Page 12]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   			|      N11 REFER (200)       |                        |
   			|--------------------------->|                        |
   			|      N12 200 OK            |                        |
   			|<---------------------------|      N13 200           |
   			|                            |----------------------->|
   			|      N14 NOTIFY            |                        |
   			|<---------------------------|                        |
   		        |      N15 200 OK            |                        |
   			|--------------------------->|                        |


   Message flow:

   N1: The REFER-Issuer subscribes to the dialog event package at the
      REFER-Recipient.




   SUBSCRIBE sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP issuer.tradewind.com;branch=z9hG4bK-a-1
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>
   Call-ID: 1@issuer.tradewind.com
   CSeq: 234234 SUBSCRIBE
   Max-Forwards: 70
   Event: dialog
   Accept: application/dialog-info+xml
   Contact: sip:a@issuer.tradewind.com
   Content-Length: 0


   N5: The REFER-Recipient receives an INVITE from the REFER-Target to
      start a new call.




   INVITE sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP target.tradewind.com;branch=z9hG4bK-c-1
   From: <sip:c@tradewind.com>;tag=1cb
   To: <sip:b@tradewind.com>
   Call-ID: 1@target.tradewind.com
   CSeq: 1234567 INVITE
   Max-Forwards: 70
   Contact: sip:c@target.tradewind.com
   Content-Length: ...




Olson                  Expires December 19, 2003               [Page 13]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   <SDP for an audio call>


   N6: The REFER-Recipient sends a NOTIFY triggered by the INVITE
      received from the REFER-Target. The body of the NOTIFY contains
      the dialog identifier and current state ("trying").




   NOTIFY sip:a@issuer.tradewind.com SIP/2.0
   Via: SIP/2.0/TCP recipient.tradewind.com;branch=z9hG4bK-b-2
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>;tag=1ba
   Call-ID: 1@issuer.tradewind.com
   CSeq: 454545 NOTIFY
   Max-Forwards: 70
   Event: dialog;id=234234
   Subscription-State: active;expires=3600
   Contact: sip:b@recipient.tradewind.com
   Content-Type: application/dialog-info+xml
   Content-Length: ...

   <?xml version="1.0" ?>
   <dialog-info xmlns="urn:ietf:params:xml:ns:dialog-info"
                version="1"
                state="partial"
   	     entity="sip:b@tradewind.com">
       <dialog id="2" call-id="1@target.tradewind.com"
   	    remote-tag="1cb"
   	    direction="recipient">
   	    <local-uri>b@tradewind.com</local-uri>
   	    <remote-uri>c@tradewind.com</remote-uri>
   	    <state>trying</state>
       </dialog>
   </dialog-info>


   N8: The REFER-Recipient sends a 180 Ringing response to the
      REFER-Target.




   SIP/2.0 180 Ringing
   Via: SIP/2.0/TCP target.tradewind.com;branch=z9hG4bK-b-3
   From: <sip:c@tradewind.com>;tag=1cb
   To: <sip:b@tradewind.com>;tag=1bc



Olson                  Expires December 19, 2003               [Page 14]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   Call-ID: 1@target.tradewind.com
   CSeq: 1234567 INVITE
   Contact: sip:b@recipient.tradewind.com
   Content-Length: 0


   N9: The REFER-Recipient sends a NOTIFY triggered by the 180 Ringing
      sent to the REFER-Target. The body of the NOTIFY contains the
      dialog identifier and current state ("early").




   NOTIFY sip:a@issuer.tradewind.com SIP/2.0
   Via: SIP/2.0/TCP recipient.tradewind.com;branch=z9hG4bK-b-4
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>;tag=1ba
   Call-ID: 1@issuer.tradewind.com
   CSeq: 454546 NOTIFY
   Max-Forwards: 70
   Event: dialog;id=234234
   Subscription-State: active;expires=3600
   Contact: sip:b@recipient.tradewind.com
   Content-Type: application/dialog-info+xml
   Content-Length: ...

   <?xml version="1.0" ?>
   <dialog-info xmlns="urn:ietf:params:xml:ns:dialog-info"
                version="2"
                state="partial"
   	     entity="sip:b@tradewind.com">
       <dialog id="2" call-id="1@target.tradewind.com"
   	    local-tag="1bc" remote-tag="1cb"
   	    direction="recipient">
   	    <local-uri>b@tradewind.com</local-uri>
   	    <remote-uri>c@tradewind.com</remote-uri>
   	    <state event="1xx-tag">early</state>
       </dialog>
   </dialog-info>


   N11: The REFER-Issuer creates a REFER, specifying that the
      REFER-Recipient should send a 200 OK to accept the session
      invitation. The From and To headers of the 200 OK are encoded in
      the Refer-To URI. The local and remote tags for this are
      determined from the information provided in the NOTIFY for the
      dialog package. This allows the REFER-Issuer to specify a
      particular dialog. Combined with the "method" parameter, this



Olson                  Expires December 19, 2003               [Page 15]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


      identifies a specific transaction within the dialog.




   REFER sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP issuer.tradewind.com;branch=z9hG4bK-a-2
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>
   Call-ID: 2@issuer.tradewind.com
   CSeq: 818181 REFER
   Max-Forwards: 70
   Accept: application/dialog-info+xml;q=0.5, message/sipfrag;q=0.1
   Require: refer-response
   Refer-To: sip:c@tradewind.com;method=INVITE;response=200?Call-ID=1%40target.tradewind.com&
     To=b%40tradewind.com;tag=1bc&From=c%40tradewind.com;tag=1cb
   Contact: sip:a@issuer.tradewind.com
   Content-Length: 0


   N13: The REFER-Recipient sends a 200 OK to the REFER-Target
      constructed using the information in the Refer-To header.




   SIP/2.0 200 OK
   Via: SIP/2.0/TCP target.tradewind.com;branch=z9hG4bK-c-1
   From: <sip:c@tradewind.com>;tag=1cb
   To: <sip:b@tradewind.com>;tag=1bc
   Call-ID: 1@target.tradewind.com
   Supported: refer-response
   CSeq: 1234567 INVITE
   Contact: sip:b@recipient.tradewind.com
   Content-Length: 0


   N14: The REFER-Recipient sends a NOTIFY triggered by the 200 OK sent
      to the REFER-Target. The body of the NOTIFY contains the dialog
      identifier and current state ("confirmed").




   NOTIFY sip:a@issuer.tradewind.com SIP/2.0
   Via: SIP/2.0/TCP recipient.tradewind.com;branch=z9hG4bK-b-4
   From: <sip:a@tradewind.com>;tag=1ab
   To: <sip:b@tradewind.com>;tag=1ba



Olson                  Expires December 19, 2003               [Page 16]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   Call-ID: 1@issuer.tradewind.com
   CSeq: 454547 NOTIFY
   Max-Forwards: 70
   Event: dialog;id=234234
   Subscription-State: active;expires=3600
   Contact: sip:b@recipient.tradewind.com
   Content-Type: application/dialog-info+xml
   Content-Length: ...

   <?xml version="1.0" ?>
   <dialog-info xmlns="urn:ietf:params:xml:ns:dialog-info"
                version="3"
                state="partial"
   	     entity="sip:b@tradewind.com">
       <dialog id="2" call-id="1@target.tradewind.com"
   	    local-tag="1bc" remote-tag="1cb"
   	    direction="recipient">
   	    <local-uri>b@tradewind.com</local-uri>
   	    <remote-uri>c@tradewind.com</remote-uri>
   	    <state event="2xx">confirmed</state>
       </dialog>
   </dialog-info>





























Olson                  Expires December 19, 2003               [Page 17]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


6. Supressing forking of REFER requests

   The REFER specification allows for the possibility of forking a REFER
   request which is sent outside of an existing dialog. In some
   situations forking a REFER may result in absolutely incorrect
   behavior. This is especially true when the REFER is intended to
   target a specific device, perhaps with specific capabilities.
   Fortunately, there is already a mechanism which can address the need
   to indicate that a REFER should NOT be forked. The caller preferences
   extension [8] defines both a way to indicate a request not be forked
   and a means to target a specific device with the desired
   capabilities. No further extension is required. An example of the
   usage of caller preferences in conjunction with REFER is shown below.

   Example of REFER using Caller Preferences extension




   REFER sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP issuer.tradewind.com;branch=z9hG4bK-a-1
   From: <sip:a@tradewind.com>;tag=1a
   To: <sip:b@tradewind.com>
   Call-ID: 1@issuer.tradewind.com
   CSeq: 234234 REFER
   Max-Forwards: 70
   Refer-To: sip:c@tradewind.com;method=INVITE
   Require: pref
   Request-Dispostion: no-fork
   Accept-Contact: *;audio;require
   Reject-Contact: *;video
   Contact: sip:a@issuer.tradewind.com
   Content-Length: 0


















Olson                  Expires December 19, 2003               [Page 18]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


7. Supressing the NOTIFY associated with a REFER

   The REFER specification mandates that every REFER create an implicit
   subscription between the REFER-Issuer and the REFER-Recipient. This
   subscription results in at least one NOTIFY being sent from the
   REFER-Recipient to the REFER-Issuer. The REFER-Recipient may choose
   to cancel the implicit subscription with this NOTIFY. The
   REFER-Issuer may choose to cancel this implicit subscription with an
   explicit SUBSCRIBE (Expires: 0) after receipt of the initial NOTIFY
   or by sending a 481 response to this initial NOTIFY request.

   The purpose of requiring the implicit subcription and initial NOTIFY
   is to allow for the situation where the REFER request gets forked and
   the REFER-Issuer needs a way to see the multiple dialogs that may be
   established as a result of the forked REFER. This is the same
   approach used to handle forking of SUBSCRIBE [5] requests. Where the
   REFER-Issuer explicitly specifies that forking not occur via caller
   preferences, or implicitly does not allow for forking by sending the
   REFER within an existing dialog, the requirement that an implicit
   subscription be established is unnecessary.

   Another purpose of the NOTIFY is to inform the REFER-Issuer of the
   progress of the SIP transaction that results from the REFER at the
   REFER-Recipient. In the case where the REFER-Issuer is already aware
   of the progress of the SIP transaction, such as when the REFER-Issuer
   has an explicit subscription to the dialog event package at the
   REFER-Recipient, the implicit subscription and resultant NOTIFY
   traffic related to the REFER is superfluous and unnecessary network
   overhead.

   To avoid this unnecessary overhead, it is proposed that the
   REFER-Issuer insert a Supported: norefersub header in the REFER
   request to indicate to the REFER-Recipient that no implicit
   subscription or NOTIFY is needed with respect to this REFER request.
   This MUST be used by the REFER-Issuer only when the REFER-Issuer can
   be certain that the REFER request will not be forked. The
   REFER-Recipient MUST signal support for this extension by inserting a
   Supported: norefersub header in the 2xx response to the REFER
   request.

   Example of REFER which supresses the implicit subscription




   REFER sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP issuer.tradewind.com;branch=z9hG4bK-a-1
   From: <sip:a@tradewind.com>;tag=1a



Olson                  Expires December 19, 2003               [Page 19]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   To: <sip:b@tradewind.com>
   Call-ID: 1@issuer.tradewind.com
   CSeq: 234234 REFER
   Max-Forwards: 70
   Refer-To: sip:c@tradewind.com;method=INVITE
   Request-Dispostion: no-fork
   Accept-Contact: *;audio;require
   Supported: norefersub
   Contact: sip:a@issuer.tradewind.com
   Content-Length: 0









































Olson                  Expires December 19, 2003               [Page 20]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


8. Replacing complex Refer-To URIs with a MIME body

   Much of the semantics of the REFER request is encapsulated in the
   Refer-To URI. This URI will commonly encode the method, From, To,
   Call-ID, Accept-Disposition, Accept-Contact [8], and other headers
   all in a properly escaped URI.  Such a URI can become long, difficult
   to debug, and prone to URI escaping errors in SIP implementations.
   The situation becomes more complex if the method is itself a REFER
   complete with a Refer-To which must contain URI-escaped characters.
   This double escaping obfuscates things even more and increases the
   chances of improperly escaping/unescaping of the Refer-To URI.

   The alternative that is proposed is to make use of the currently
   unused REFER body to encapsulate all the information that is
   potentially escaped in the Refer-To URI. The possible information
   includes the method, headers, and body of the request which is
   desired to be created by the REFER-Recipient. The ideal candidate for
   this is the message/sipfrag MIME type. This MIME type can express all
   of these: the method, Request-URI, headers, and body. This applies to
   requests as well as responses (as an extension).

   There are two possibilities: use a cid URI [6] in the Refer-To header
   to reference the message/sipfrag content in the body of the REFER or
   continue to place the URI of the REFER-Target in the Refer-To header
   and place all other facets of the request in the message/sipfrag body
   with the understanding that the presence of the body implies its
   usage for this purpose. A few examples should illuminate things.

   Before




   REFER sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP issuer.tradewind.com;branch=z9hG4bK-a-1
   From: <sip:a@tradewind.com>;tag=1a
   To: <sip:b@tradewind.com>
   Call-ID: 1@issuer.tradewind.com
   CSeq: 234234 REFER
   Max-Forwards: 70
   Refer-To: sip:c@tradewind.com;method=INVITE;response=200?Call-ID=1%40target.tradewind.com&
      From=b%40tradewind.com;tag=2b&To=c%40tradewind.com;tag=1c
   Accept: application/dialog-info+xml;q=0.5, message/sipfrag;q=0.1
   Require: refer-response
   Contact: sip:a@issuer.tradewind.com
   Content-Length: 0





Olson                  Expires December 19, 2003               [Page 21]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   After (placing the REFER-Target in the Refer-To)




   REFER sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP issuer.tradewind.com;branch=z9hG4bK-a-1
   From: <sip:a@tradewind.com>;tag=1a
   To: <sip:b@tradewind.com>
   Call-ID: 1@issuer.tradewind.com
   CSeq: 234234 REFER
   Max-Forwards: 70
   Refer-To: sip:c@tradewind.com;method=INVITE
   Accept: application/dialog-info+xml;q=0.5, message/sipfrag;q=0.1
   Require: refer-response
   Contact: sip:a@issuer.tradewind.com
   Content-Type: message/sipfrag
   Content-Length: ...

   SIP/2.0 200 OK
   Call-ID: 1@target.tradewind.com
   From: b@tradewind.com;tag=2b
   To: c@tradewind.com;tag=1c


   After (using a cid URI)




   REFER sip:b@tradewind.com SIP/2.0
   Via: SIP/2.0/TCP issuer.tradewind.com;branch=z9hG4bK-a-1
   From: <sip:a@tradewind.com>;tag=1a
   To: <sip:b@tradewind.com>
   Call-ID: 1@issuer.tradewind.com
   CSeq: 234234 REFER
   Max-Forwards: 70
   Refer-To: cid:1239103912039@issuer.tradewind.com
   Accept: application/dialog-info+xml;q=0.5, message/sipfrag;q=0.1
   Require: refer-response
   Contact: sip:a@issuer.tradewind.com
   Content-Type: message/sipfrag
   Content-Id: <1239103912039@issuer.tradewind.com>
   Content-Length: ...

   SIP/2.0 200 OK
   Call-ID: 1@target.tradewind.com
   From: b@tradewind.com;tag=2b



Olson                  Expires December 19, 2003               [Page 22]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   To: c@tradewind.com;tag=1c


   Note that the target URI and method are still included in the
   Refer-To header.

   If the REFER-Recipient does not understand this extension, it MUST
   return a 4xx response to the REFER request. The REFER-Issuer SHOULD
   re-issue the REFER request using URI escaping and only the Refer-To:
   URI to convey the same information if possible.









































Olson                  Expires December 19, 2003               [Page 23]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


9. IANA Considerations

9.1 norefersub option tag registration

   This document defines a new option tag, norefersub, which specifies
   that an implicit subscription for event package refer should not be
   created as a result of accepting this REFER request. This option tag
   is only meaningful for the REFER request defined in RFC3515.

9.2 refer-response option tag registration

   This document defines a new option tag, refer-response, which
   specifies that the recipient of the REFER request is expected to
   issue a response for the SIP transaction identified within the
   Refer-To URI. This option tag is only meaningful for the REFER
   request defined in RFC3515.



































Olson                  Expires December 19, 2003               [Page 24]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


10. Security Considerations

   No additional concerns above what is defined in RFC3515.
















































Olson                  Expires December 19, 2003               [Page 25]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


11. Acknowledgements

   The author would like to thank Rohan Mahy for his insightful
   comments. The author would also like to thank Sriram Parameswar for
   his draft-parameswar-sipping-norefersub-00 proposal which is the
   basis for the norefersub option tag proposed in this draft.













































Olson                  Expires December 19, 2003               [Page 26]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


References

   [1]  Bradner, S., "Key words for use in RFCs to Indicate Requirement
        Levels", BCP 14, RFC 2119, March 1997.

   [2]  Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A.,
        Peterson, J., Sparks, R., Handley, M. and E. Schooler, "SIP:
        Session Initiation Protocol", RFC 3261, June 2002.

   [3]  Sparks, R., "The Session Initiation Protocol (SIP) Refer
        Method", RFC 3515, April 2003.

   [4]  Sparks, R., "Internet Media Type message/sipfrag", RFC 3420,
        November 2002.

   [5]  Roach, A., "Session Initiation Protocol (SIP)-Specific Event
        Notification", RFC 3265, June 2002.

   [6]  Levinson, E., "Content-ID and Message-ID Uniform Resource
        Locators", RFC 2392, August 1998.

   [7]  Rosenberg, J. and H. Schulzrinne, "An INVITE Inititiated Dialog
        Event Package for the Session Initiation  Protocol (SIP",
        draft-ietf-sipping-dialog-package-01 (work in progress), March
        2003.

   [8]  Rosenberg, J., Schulzrinne, H. and P. Kyzivat, "Caller
        Preferences and Callee Capabilities for the Session Initiation
        Protocol (SIP)", draft-ietf-sip-callerprefs-08 (work in
        progress), March 2003.


Author's Address

   Sean Olson
   Microsoft
   One Microsoft Way
   Redmond, WA  98052
   US

   Phone: +1-425-707-2846
   EMail: seanol@microsoft.com
   URI:   http://www.microsoft.com/rtc








Olson                  Expires December 19, 2003               [Page 27]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


Intellectual Property Statement

   The IETF takes no position regarding the validity or scope of any
   intellectual property or other rights that might be claimed to
   pertain to the implementation or use of the technology described in
   this document or the extent to which any license under such rights
   might or might not be available; neither does it represent that it
   has made any effort to identify any such rights. Information on the
   IETF's procedures with respect to rights in standards-track and
   standards-related documentation can be found in BCP-11. Copies of
   claims of rights made available for publication and any assurances of
   licenses to be made available, or the result of an attempt made to
   obtain a general license or permission for the use of such
   proprietary rights by implementors or users of this specification can
   be obtained from the IETF Secretariat.

   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights which may cover technology that may be required to practice
   this standard. Please address the information to the IETF Executive
   Director.


Full Copyright Statement

   Copyright (C) The Internet Society (2003). All Rights Reserved.

   This document and translations of it may be copied and furnished to
   others, and derivative works that comment on or otherwise explain it
   or assist in its implementation may be prepared, copied, published
   and distributed, in whole or in part, without restriction of any
   kind, provided that the above copyright notice and this paragraph are
   included on all such copies and derivative works. However, this
   document itself may not be modified in any way, such as by removing
   the copyright notice or references to the Internet Society or other
   Internet organizations, except as needed for the purpose of
   developing Internet standards in which case the procedures for
   copyrights defined in the Internet Standards process must be
   followed, or as required to translate it into languages other than
   English.

   The limited permissions granted above are perpetual and will not be
   revoked by the Internet Society or its successors or assignees.

   This document and the information contained herein is provided on an
   "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET ENGINEERING
   TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING
   BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION



Olson                  Expires December 19, 2003               [Page 28]

Internet-Draft    Extensions to the REFER mechanism for Third Party Call Control                                  June 2003


   HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF
   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.


Acknowledgement

   Funding for the RFC Editor function is currently provided by the
   Internet Society.











































Olson                  Expires December 19, 2003               [Page 29]

