<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>The Messaging Layer Security (MLS) Protocol</title>
<meta content="Richard Barnes" name="author">
<meta content="Benjamin Beurdouche" name="author">
<meta content="Raphael Robert" name="author">
<meta content="Jon Millican" name="author">
<meta content="Emad Omara" name="author">
<meta content="Katriel Cohn-Gordon" name="author">
<meta content="
       Messaging applications are increasingly making use of end-to-end
security mechanisms to ensure that messages are only accessible to
the communicating endpoints, and not to any servers involved in delivering
messages.  Establishing keys to provide such protections is
challenging for group chat settings, in which more than two
clients need to agree on a key but may not be online at the same
time.  In this document, we specify a key establishment
protocol that provides efficient asynchronous group key establishment
with forward secrecy and post-compromise security for groups
in size ranging from two to thousands. 
    " name="description">
<meta content="xml2rfc 3.12.3" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-ietf-mls-protocol-13" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.12.3
    Python 3.6.12
    appdirs 1.4.4
    ConfigArgParse 1.5.3
    google-i18n-address 2.5.0
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 2.11.3
    kitchen 1.2.6
    lxml 4.8.0
    MarkupSafe 2.0.1
    pycountry 22.1.10
    pyflakes 2.4.0
    PyYAML 6.0
    requests 2.27.1
    setuptools 59.6.0
    six 1.16.0
    WeasyPrint 52.5
-->
<link href="/tmp/draft-ietf-mls-protocol-13-23rusjs7.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necssary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: 'Noto Sans', Arial, Helvetica, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre, code {
  background-color: #f9f9f9;
  font-family: 'Roboto Mono', monospace;
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    float: none;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: "Noto Sans",Arial,Helvetica,sans-serif;
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {

    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The follwing is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre, code {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
pre.sourcecode,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact informatio look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background sligthtly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottim margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the comact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div:first-child > pre.sourcecode,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<script type="application/javascript">async function addMetadata(){try{const e=document.styleSheets[0].cssRules;for(let t=0;t<e.length;t++)if(/#identifiers/.exec(e[t].selectorText)){const a=e[t].cssText.replace("#identifiers","#external-updates");document.styleSheets[0].insertRule(a,document.styleSheets[0].cssRules.length)}}catch(e){console.log(e)}const e=document.getElementById("external-metadata");if(e)try{var t,a="",o=function(e){const t=document.getElementsByTagName("meta");for(let a=0;a<t.length;a++)if(t[a].getAttribute("name")===e)return t[a].getAttribute("content");return""}("rfc.number");if(o){t="https://www.rfc-editor.org/rfc/rfc"+o+".json";try{const e=await fetch(t);a=await e.json()}catch(e){t=document.URL.indexOf("html")>=0?document.URL.replace(/html$/,"json"):document.URL+".json";const o=await fetch(t);a=await o.json()}}if(!a)return;e.style.display="block";const s="",d="https://datatracker.ietf.org/doc",n="https://datatracker.ietf.org/ipr/search",c="https://www.rfc-editor.org/info",l=a.doc_id.toLowerCase(),i=a.doc_id.slice(0,3).toLowerCase(),f=a.doc_id.slice(3).replace(/^0+/,""),u={status:"Status",obsoletes:"Obsoletes",obsoleted_by:"Obsoleted By",updates:"Updates",updated_by:"Updated By",see_also:"See Also",errata_url:"Errata"};let h="<dl style='overflow:hidden' id='external-updates'>";["status","obsoletes","obsoleted_by","updates","updated_by","see_also","errata_url"].forEach(e=>{if("status"==e){a[e]=a[e].toLowerCase();var t=a[e].split(" "),o=t.length,w="",p=1;for(let e=0;e<o;e++)p<o?w=w+r(t[e])+" ":w+=r(t[e]),p++;a[e]=w}else if("obsoletes"==e||"obsoleted_by"==e||"updates"==e||"updated_by"==e){var g,m="",b=1;g=a[e].length;for(let t=0;t<g;t++)a[e][t]&&(a[e][t]=String(a[e][t]).toLowerCase(),m=b<g?m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>, ":m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>",b++);a[e]=m}else if("see_also"==e){var y,L="",C=1;y=a[e].length;for(let t=0;t<y;t++)if(a[e][t]){a[e][t]=String(a[e][t]);var _=a[e][t].slice(0,3),v=a[e][t].slice(3).replace(/^0+/,"");L=C<y?"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>, ":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>, ":"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>",C++}a[e]=L}else if("errata_url"==e){var R="";R=a[e]?R+"<a href='"+a[e]+"'>Errata exist</a> | <a href='"+d+"/"+l+"'>Datatracker</a>| <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>":"<a href='"+d+"/"+l+"'>Datatracker</a> | <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>",a[e]=R}""!=a[e]?"Errata"==u[e]?h+=`<dt>More info:</dt><dd>${a[e]}</dd>`:h+=`<dt>${u[e]}:</dt><dd>${a[e]}</dd>`:"Errata"==u[e]&&(h+=`<dt>More info:</dt><dd>${a[e]}</dd>`)}),h+="</dl>",e.innerHTML=h}catch(e){console.log(e)}else console.log("Could not locate metadata <div> element");function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}}window.removeEventListener("load",addMetadata),window.addEventListener("load",addMetadata);</script>
</head>
<body>
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MLS</td>
<td class="right">March 2022</td>
</tr></thead>
<tfoot><tr>
<td class="left">Barnes, et al.</td>
<td class="center">Expires 8 September 2022</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-mls-protocol-13</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2022-03-07" class="published">7 March 2022</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2022-09-08">8 September 2022</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">R. Barnes</div>
<div class="org">Cisco</div>
</div>
<div class="author">
      <div class="author-name">B. Beurdouche</div>
<div class="org">Inria &amp; Mozilla</div>
</div>
<div class="author">
      <div class="author-name">R. Robert</div>
</div>
<div class="author">
      <div class="author-name">J. Millican</div>
<div class="org">Facebook</div>
</div>
<div class="author">
      <div class="author-name">E. Omara</div>
<div class="org">Google</div>
</div>
<div class="author">
      <div class="author-name">K. Cohn-Gordon</div>
<div class="org">University of Oxford</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">The Messaging Layer Security (MLS) Protocol</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">Messaging applications are increasingly making use of end-to-end
security mechanisms to ensure that messages are only accessible to
the communicating endpoints, and not to any servers involved in delivering
messages.  Establishing keys to provide such protections is
challenging for group chat settings, in which more than two
clients need to agree on a key but may not be online at the same
time.  In this document, we specify a key establishment
protocol that provides efficient asynchronous group key establishment
with forward secrecy and post-compromise security for groups
in size ranging from two to thousands.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-discussion-venues">
<a href="#name-discussion-venues" class="section-name selfRef">Discussion Venues</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">Source for this draft and an issue tracker can be found at
  <a href="https://github.com/mlswg/mls-protocol">https://github.com/mlswg/mls-protocol</a>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo-5">
<a href="#name-status-of-this-memo-5" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 8 September 2022.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice-5">
<a href="#name-copyright-notice-5" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2022 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents-5">
<a href="#name-table-of-contents-5" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction-5" class="xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="xref">1.1</a>.  <a href="#name-change-log" class="xref">Change Log</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="xref">2</a>.  <a href="#name-terminology" class="xref">Terminology</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1"><a href="#section-2.1" class="xref">2.1</a>.  <a href="#name-presentation-langauge" class="xref">Presentation Langauge</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1.2.1">
                    <p id="section-toc.1-1.2.2.1.2.1.1" class="keepWithNext"><a href="#section-2.1.1" class="xref">2.1.1</a>.  <a href="#name-optional-value" class="xref">Optional Value</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1.2.2">
                    <p id="section-toc.1-1.2.2.1.2.2.1"><a href="#section-2.1.2" class="xref">2.1.2</a>.  <a href="#name-variable-size-vector-header" class="xref">Variable-size Vector Headers</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-operating-context" class="xref">Operating Context</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-protocol-overview" class="xref">Protocol Overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="xref">4.1</a>.  <a href="#name-cryptographic-state-and-evo" class="xref">Cryptographic State and Evolution</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="xref">4.2</a>.  <a href="#name-example-protocol-execution" class="xref">Example Protocol Execution</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="xref">4.3</a>.  <a href="#name-relationships-between-epoch" class="xref">Relationships Between Epochs</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-ratchet-tree-concepts" class="xref">Ratchet Tree Concepts</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-ratchet-tree-terminology" class="xref">Ratchet Tree Terminology</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-views-of-a-ratchet-tree" class="xref">Views of a Ratchet Tree</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="xref">5.3</a>.  <a href="#name-ratchet-tree-nodes" class="xref">Ratchet Tree Nodes</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-cryptographic-objects" class="xref">Cryptographic Objects</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="xref">6.1</a>.  <a href="#name-ciphersuites" class="xref">Ciphersuites</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="xref">6.2</a>.  <a href="#name-hash-based-identifiers" class="xref">Hash-Based Identifiers</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3" class="xref">6.3</a>.  <a href="#name-credentials" class="xref">Credentials</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.1">
                    <p id="section-toc.1-1.6.2.3.2.1.1"><a href="#section-6.3.1" class="xref">6.3.1</a>.  <a href="#name-uniquely-identifying-client" class="xref">Uniquely Identifying Clients</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-message-framing" class="xref">Message Framing</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="xref">7.1</a>.  <a href="#name-content-authentication" class="xref">Content Authentication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="xref">7.2</a>.  <a href="#name-encoding-and-decoding-a-pla" class="xref">Encoding and Decoding a Plaintext</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3" class="xref">7.3</a>.  <a href="#name-encoding-and-decoding-a-cip" class="xref">Encoding and Decoding a Ciphertext</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3.2.1">
                    <p id="section-toc.1-1.7.2.3.2.1.1"><a href="#section-7.3.1" class="xref">7.3.1</a>.  <a href="#name-content-encryption" class="xref">Content Encryption</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3.2.2">
                    <p id="section-toc.1-1.7.2.3.2.2.1"><a href="#section-7.3.2" class="xref">7.3.2</a>.  <a href="#name-sender-data-encryption" class="xref">Sender Data Encryption</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-ratchet-tree-operations" class="xref">Ratchet Tree Operations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="xref">8.1</a>.  <a href="#name-parent-node-contents" class="xref">Parent Node Contents</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="xref">8.2</a>.  <a href="#name-leaf-node-contents" class="xref">Leaf Node Contents</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.3">
                <p id="section-toc.1-1.8.2.3.1"><a href="#section-8.3" class="xref">8.3</a>.  <a href="#name-leaf-node-validation" class="xref">Leaf Node Validation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.4">
                <p id="section-toc.1-1.8.2.4.1"><a href="#section-8.4" class="xref">8.4</a>.  <a href="#name-ratchet-tree-evolution" class="xref">Ratchet Tree Evolution</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.5">
                <p id="section-toc.1-1.8.2.5.1"><a href="#section-8.5" class="xref">8.5</a>.  <a href="#name-adding-and-removing-leaves" class="xref">Adding and Removing Leaves</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.6">
                <p id="section-toc.1-1.8.2.6.1"><a href="#section-8.6" class="xref">8.6</a>.  <a href="#name-synchronizing-views-of-the-" class="xref">Synchronizing Views of the Tree</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.7">
                <p id="section-toc.1-1.8.2.7.1"><a href="#section-8.7" class="xref">8.7</a>.  <a href="#name-tree-hashes" class="xref">Tree Hashes</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.8">
                <p id="section-toc.1-1.8.2.8.1"><a href="#section-8.8" class="xref">8.8</a>.  <a href="#name-parent-hash" class="xref">Parent Hash</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.8.2.1">
                    <p id="section-toc.1-1.8.2.8.2.1.1"><a href="#section-8.8.1" class="xref">8.8.1</a>.  <a href="#name-using-parent-hashes" class="xref">Using Parent Hashes</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.8.2.2">
                    <p id="section-toc.1-1.8.2.8.2.2.1"><a href="#section-8.8.2" class="xref">8.8.2</a>.  <a href="#name-verifying-parent-hashes" class="xref">Verifying Parent Hashes</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.9">
                <p id="section-toc.1-1.8.2.9.1"><a href="#section-8.9" class="xref">8.9</a>.  <a href="#name-update-paths" class="xref">Update Paths</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="xref">9</a>.  <a href="#name-key-schedule" class="xref">Key Schedule</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="xref">9.1</a>.  <a href="#name-group-context" class="xref">Group Context</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2" class="xref">9.2</a>.  <a href="#name-transcript-hashes" class="xref">Transcript Hashes</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.3">
                <p id="section-toc.1-1.9.2.3.1"><a href="#section-9.3" class="xref">9.3</a>.  <a href="#name-external-initialization" class="xref">External Initialization</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.4">
                <p id="section-toc.1-1.9.2.4.1"><a href="#section-9.4" class="xref">9.4</a>.  <a href="#name-pre-shared-keys" class="xref">Pre-Shared Keys</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.5">
                <p id="section-toc.1-1.9.2.5.1"><a href="#section-9.5" class="xref">9.5</a>.  <a href="#name-exporters" class="xref">Exporters</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.6">
                <p id="section-toc.1-1.9.2.6.1"><a href="#section-9.6" class="xref">9.6</a>.  <a href="#name-resumption-secret" class="xref">Resumption Secret</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.7">
                <p id="section-toc.1-1.9.2.7.1"><a href="#section-9.7" class="xref">9.7</a>.  <a href="#name-state-authentication-keys" class="xref">State Authentication Keys</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="xref">10</a>. <a href="#name-secret-tree" class="xref">Secret Tree</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="xref">10.1</a>.  <a href="#name-encryption-keys" class="xref">Encryption Keys</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="xref">10.2</a>.  <a href="#name-deletion-schedule" class="xref">Deletion Schedule</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="xref">11</a>. <a href="#name-key-packages" class="xref">Key Packages</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1" class="xref">11.1</a>.  <a href="#name-keypackage-validation" class="xref">KeyPackage Validation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-11.2" class="xref">11.2</a>.  <a href="#name-keypackage-identifiers" class="xref">KeyPackage Identifiers</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="xref">12</a>. <a href="#name-group-creation" class="xref">Group Creation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-12.1" class="xref">12.1</a>.  <a href="#name-required-capabilities" class="xref">Required Capabilities</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#section-12.2" class="xref">12.2</a>.  <a href="#name-reinitialization" class="xref">Reinitialization</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.3">
                <p id="section-toc.1-1.12.2.3.1"><a href="#section-12.3" class="xref">12.3</a>.  <a href="#name-sub-group-branching" class="xref">Sub-group Branching</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="xref">13</a>. <a href="#name-group-evolution" class="xref">Group Evolution</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#section-13.1" class="xref">13.1</a>.  <a href="#name-proposals" class="xref">Proposals</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.1">
                    <p id="section-toc.1-1.13.2.1.2.1.1"><a href="#section-13.1.1" class="xref">13.1.1</a>.  <a href="#name-add" class="xref">Add</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.2">
                    <p id="section-toc.1-1.13.2.1.2.2.1"><a href="#section-13.1.2" class="xref">13.1.2</a>.  <a href="#name-update" class="xref">Update</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.3">
                    <p id="section-toc.1-1.13.2.1.2.3.1"><a href="#section-13.1.3" class="xref">13.1.3</a>.  <a href="#name-remove" class="xref">Remove</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.4">
                    <p id="section-toc.1-1.13.2.1.2.4.1"><a href="#section-13.1.4" class="xref">13.1.4</a>.  <a href="#name-presharedkey" class="xref">PreSharedKey</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.5">
                    <p id="section-toc.1-1.13.2.1.2.5.1"><a href="#section-13.1.5" class="xref">13.1.5</a>.  <a href="#name-reinit" class="xref">ReInit</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.6">
                    <p id="section-toc.1-1.13.2.1.2.6.1"><a href="#section-13.1.6" class="xref">13.1.6</a>.  <a href="#name-externalinit" class="xref">ExternalInit</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.7">
                    <p id="section-toc.1-1.13.2.1.2.7.1"><a href="#section-13.1.7" class="xref">13.1.7</a>.  <a href="#name-appack" class="xref">AppAck</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.8">
                    <p id="section-toc.1-1.13.2.1.2.8.1"><a href="#section-13.1.8" class="xref">13.1.8</a>.  <a href="#name-groupcontextextensions" class="xref">GroupContextExtensions</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1.2.9">
                    <p id="section-toc.1-1.13.2.1.2.9.1"><a href="#section-13.1.9" class="xref">13.1.9</a>.  <a href="#name-external-proposals" class="xref">External Proposals</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.2">
                <p id="section-toc.1-1.13.2.2.1"><a href="#section-13.2" class="xref">13.2</a>.  <a href="#name-commit" class="xref">Commit</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.2.2.1">
                    <p id="section-toc.1-1.13.2.2.2.1.1"><a href="#section-13.2.1" class="xref">13.2.1</a>.  <a href="#name-creating-a-commit" class="xref">Creating a Commit</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.2.2.2">
                    <p id="section-toc.1-1.13.2.2.2.2.1"><a href="#section-13.2.2" class="xref">13.2.2</a>.  <a href="#name-processing-a-commit" class="xref">Processing a Commit</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.2.2.3">
                    <p id="section-toc.1-1.13.2.2.2.3.1"><a href="#section-13.2.3" class="xref">13.2.3</a>.  <a href="#name-adding-members-to-the-group" class="xref">Adding Members to the Group</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.3">
                <p id="section-toc.1-1.13.2.3.1"><a href="#section-13.3" class="xref">13.3</a>.  <a href="#name-ratchet-tree-extension" class="xref">Ratchet Tree Extension</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-14" class="xref">14</a>. <a href="#name-extensibility" class="xref">Extensibility</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14.2.1">
                <p id="section-toc.1-1.14.2.1.1"><a href="#section-14.1" class="xref">14.1</a>.  <a href="#name-ciphersuites-2" class="xref">Ciphersuites</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14.2.2">
                <p id="section-toc.1-1.14.2.2.1"><a href="#section-14.2" class="xref">14.2</a>.  <a href="#name-proposals-2" class="xref">Proposals</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14.2.3">
                <p id="section-toc.1-1.14.2.3.1"><a href="#section-14.3" class="xref">14.3</a>.  <a href="#name-extensions" class="xref">Extensions</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-15" class="xref">15</a>. <a href="#name-sequencing-of-state-changes" class="xref">Sequencing of State Changes</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15.2.1">
                <p id="section-toc.1-1.15.2.1.1"><a href="#section-15.1" class="xref">15.1</a>.  <a href="#name-server-enforced-ordering" class="xref">Server-Enforced Ordering</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15.2.2">
                <p id="section-toc.1-1.15.2.2.1"><a href="#section-15.2" class="xref">15.2</a>.  <a href="#name-client-enforced-ordering" class="xref">Client-Enforced Ordering</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-16" class="xref">16</a>. <a href="#name-application-messages" class="xref">Application Messages</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.1">
                <p id="section-toc.1-1.16.2.1.1"><a href="#section-16.1" class="xref">16.1</a>.  <a href="#name-message-encryption-and-decr" class="xref">Message Encryption and Decryption</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.2">
                <p id="section-toc.1-1.16.2.2.1"><a href="#section-16.2" class="xref">16.2</a>.  <a href="#name-restrictions" class="xref">Restrictions</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.3">
                <p id="section-toc.1-1.16.2.3.1"><a href="#section-16.3" class="xref">16.3</a>.  <a href="#name-delayed-and-reordered-appli" class="xref">Delayed and Reordered Application messages</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#section-17" class="xref">17</a>. <a href="#name-security-considerations-5" class="xref">Security Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17.2.1">
                <p id="section-toc.1-1.17.2.1.1"><a href="#section-17.1" class="xref">17.1</a>.  <a href="#name-confidentiality-of-the-grou" class="xref">Confidentiality of the Group Secrets</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17.2.2">
                <p id="section-toc.1-1.17.2.2.1"><a href="#section-17.2" class="xref">17.2</a>.  <a href="#name-authentication" class="xref">Authentication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17.2.3">
                <p id="section-toc.1-1.17.2.3.1"><a href="#section-17.3" class="xref">17.3</a>.  <a href="#name-forward-secrecy-and-post-co" class="xref">Forward Secrecy and Post-Compromise Security</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17.2.4">
                <p id="section-toc.1-1.17.2.4.1"><a href="#section-17.4" class="xref">17.4</a>.  <a href="#name-keypackage-reuse" class="xref">KeyPackage Reuse</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17.2.5">
                <p id="section-toc.1-1.17.2.5.1"><a href="#section-17.5" class="xref">17.5</a>.  <a href="#name-group-fragmentation-by-mali" class="xref">Group Fragmentation by Malicious Insiders</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18">
            <p id="section-toc.1-1.18.1"><a href="#section-18" class="xref">18</a>. <a href="#name-iana-considerations-4" class="xref">IANA Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18.2.1">
                <p id="section-toc.1-1.18.2.1.1"><a href="#section-18.1" class="xref">18.1</a>.  <a href="#name-mls-ciphersuites" class="xref">MLS Ciphersuites</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18.2.2">
                <p id="section-toc.1-1.18.2.2.1"><a href="#section-18.2" class="xref">18.2</a>.  <a href="#name-mls-extension-types" class="xref">MLS Extension Types</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18.2.3">
                <p id="section-toc.1-1.18.2.3.1"><a href="#section-18.3" class="xref">18.3</a>.  <a href="#name-mls-proposal-types" class="xref">MLS Proposal Types</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18.2.4">
                <p id="section-toc.1-1.18.2.4.1"><a href="#section-18.4" class="xref">18.4</a>.  <a href="#name-mls-credential-types" class="xref">MLS Credential Types</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18.2.5">
                <p id="section-toc.1-1.18.2.5.1"><a href="#section-18.5" class="xref">18.5</a>.  <a href="#name-mls-designated-expert-pool" class="xref">MLS Designated Expert Pool</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.18.2.6">
                <p id="section-toc.1-1.18.2.6.1"><a href="#section-18.6" class="xref">18.6</a>.  <a href="#name-the-message-mls-mime-type" class="xref">The "message/mls" MIME Type</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.19">
            <p id="section-toc.1-1.19.1"><a href="#section-19" class="xref">19</a>. <a href="#name-contributors" class="xref">Contributors</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.20">
            <p id="section-toc.1-1.20.1"><a href="#section-20" class="xref">20</a>. <a href="#name-references-4" class="xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.20.2.1">
                <p id="section-toc.1-1.20.2.1.1"><a href="#section-20.1" class="xref">20.1</a>.  <a href="#name-normative-references-5" class="xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.20.2.2">
                <p id="section-toc.1-1.20.2.2.1"><a href="#section-20.2" class="xref">20.2</a>.  <a href="#name-informative-references-4" class="xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.21">
            <p id="section-toc.1-1.21.1"><a href="#appendix-A" class="xref">Appendix A</a>.  <a href="#name-protocol-origins-of-example" class="xref">Protocol Origins of Example Trees</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.22">
            <p id="section-toc.1-1.22.1"><a href="#appendix-B" class="xref">Appendix B</a>.  <a href="#name-array-based-trees" class="xref">Array-Based Trees</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.23">
            <p id="section-toc.1-1.23.1"><a href="#appendix-C" class="xref">Appendix C</a>.  <a href="#name-link-based-trees" class="xref">Link-Based Trees</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.24">
            <p id="section-toc.1-1.24.1"><a href="#appendix-D" class="xref"></a><a href="#name-authors-addresses-4" class="xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction-5">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction-5" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">DISCLAIMER: This is a work-in-progress draft of MLS and has not yet
seen significant security analysis. It should not be used as a basis
for building production systems.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">RFC EDITOR: PLEASE REMOVE THE FOLLOWING PARAGRAPH The source for
this draft is maintained in GitHub. Suggested changes should be
submitted as pull requests at https://github.com/mlswg/mls-protocol.
Instructions are on that page as well. Editorial changes can be
managed in GitHub, but any substantive change should be discussed on
the MLS mailing list.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">A group of users who want to send each other encrypted messages needs
a way to derive shared symmetric encryption keys. For two parties,
this problem has been studied thoroughly, with the Double Ratchet
emerging as a common solution <span>[<a href="#doubleratchet" class="xref">doubleratchet</a>]</span> <span>[<a href="#signal" class="xref">signal</a>]</span>.
Channels implementing the Double Ratchet enjoy fine-grained forward secrecy
as well as post-compromise security, but are nonetheless efficient
enough for heavy use over low-bandwidth networks.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">For a group of size greater than two, a common strategy is to
unilaterally broadcast symmetric "sender" keys over existing shared
symmetric channels, and then for each member to send messages to the
group encrypted with their own sender key. Unfortunately, while this
improves efficiency over pairwise broadcast of individual messages and
provides forward secrecy (with the addition of a hash ratchet),
it is difficult to achieve post-compromise security with
sender keys. An adversary who learns a sender key can often indefinitely and
passively eavesdrop on that member's messages.  Generating and
distributing a new sender key provides a form of post-compromise
security with regard to that sender.  However, it requires
computation and communications resources that scale linearly with
the size of the group.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">In this document, we describe a protocol based on tree structures
that enable asynchronous group keying with forward secrecy and
post-compromise security.  Based on earlier work on "asynchronous
ratcheting trees" <span>[<a href="#art" class="xref">art</a>]</span>, the protocol presented here uses an
asynchronous key-encapsulation mechanism for tree structures.
This mechanism allows the members of the group to derive and update
shared keys with costs that scale as the log of the group size.<a href="#section-1-5" class="pilcrow">¶</a></p>
<div id="change-log">
<section id="section-1.1">
        <h3 id="name-change-log">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-change-log" class="section-name selfRef">Change Log</a>
        </h3>
<p id="section-1.1-1">RFC EDITOR PLEASE DELETE THIS SECTION.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">draft-13<a href="#section-1.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-3.1">TLS syntax updates (including variable-header-length vectors) (*)<a href="#section-1.1-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.2">Stop generating redundant PKE key pairs. (*)<a href="#section-1.1-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.3">Move validation of identity change to the AS<a href="#section-1.1-3.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.4">Add message/mls MIME type registration<a href="#section-1.1-3.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.5">Split LeafNode from KeyPackage (*)<a href="#section-1.1-3.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.6">Remove endpoint_id (*)<a href="#section-1.1-3.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.7">Reorganize to make section layout more sane<a href="#section-1.1-3.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.8">Forbid proposals by reference in external commits (*)<a href="#section-1.1-3.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.9">Domain separation for KeyPackage and Proposal references (*)<a href="#section-1.1-3.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.10">Downgrade MUST to SHOULD for commit senders including all valid commits<a href="#section-1.1-3.10" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.11">Stronger parent hashes for authenticated identities (*)<a href="#section-1.1-3.11" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.12">Move wire_format to a separate tagged-union structure MLSMessage<a href="#section-1.1-3.12" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.13">Generalize tree extend/truncate algorithms<a href="#section-1.1-3.13" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.14">Add algorithms for link-based trees<a href="#section-1.1-3.14" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.15">Forbid self-Update entirely (*)<a href="#section-1.1-3.15" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.16">Consolidate resumption PSK cases (*)<a href="#section-1.1-3.16" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.17">384 Ciphersuite Addition<a href="#section-1.1-3.17" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.18">Remove explicit version pin on HPKE (*)<a href="#section-1.1-3.18" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.19">Remove the requirement for Add in external commit (*)<a href="#section-1.1-3.19" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.20">Use smaller, fixed-size hash-based identifiers (*)<a href="#section-1.1-3.20" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-3.21">Be explicit that Credentials can attest to multiple identities (*)<a href="#section-1.1-3.21" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-4">draft-12<a href="#section-1.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-5.1">Use the GroupContext to derive the joiner_secret (*)<a href="#section-1.1-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.2">Make PreSharedKeys non optional in GroupSecrets (*)<a href="#section-1.1-5.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.3">Update name for this particular key (*)<a href="#section-1.1-5.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.4">Truncate tree size on removal (*)<a href="#section-1.1-5.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.5">Use HPKE draft-08 (*)<a href="#section-1.1-5.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.6">Clarify requirements around identity in MLS groups (*)<a href="#section-1.1-5.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.7">Signal the intended wire format for MLS messages (*)<a href="#section-1.1-5.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.8">Inject GroupContext as HPKE info instead of AAD (*)<a href="#section-1.1-5.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.9">Clarify extension handling and make extension updatable (*)<a href="#section-1.1-5.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.10">Improve extensibility of Proposals (*)<a href="#section-1.1-5.10" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.11">Constrain proposal in External Commit (*)<a href="#section-1.1-5.11" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.12">Remove the notion of a 'leaf index' (*)<a href="#section-1.1-5.12" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.13">Add group_context_extensions proposal ID (*)<a href="#section-1.1-5.13" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.14">Add RequiredCapabilities extension (*)<a href="#section-1.1-5.14" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.15">Use cascaded KDF instead of concatenation to consolidate PSKs (*)<a href="#section-1.1-5.15" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.16">Use key package hash to index clients in message structs (*)<a href="#section-1.1-5.16" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.17">Don't require PublicGroupState for external init (*)<a href="#section-1.1-5.17" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.18">Make ratchet tree section clearer.<a href="#section-1.1-5.18" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.19">Handle non-member sender cases in MLSPlaintextTBS<a href="#section-1.1-5.19" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.20">Clarify encoding of signatures with NIST curves<a href="#section-1.1-5.20" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.21">Remove OPEN ISSUEs and TODOs<a href="#section-1.1-5.21" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-5.22">Normalize the description of the zero vector<a href="#section-1.1-5.22" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-6">draft-11<a href="#section-1.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-7.1">Include subtree keys in parent hash (*)<a href="#section-1.1-7.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.2">Pin HPKE to draft-07 (*)<a href="#section-1.1-7.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.3">Move joiner secret to the end of the first key schedule epoch (*)<a href="#section-1.1-7.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.4">Add an AppAck proposal<a href="#section-1.1-7.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-7.5">Make initializations of transcript hashes consistent<a href="#section-1.1-7.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-8">draft-10<a href="#section-1.1-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-9.1">Allow new members to join via an external Commit (*)<a href="#section-1.1-9.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.2">Enable proposals to be sent inline in a Commit (*)<a href="#section-1.1-9.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.3">Re-enable constant-time Add (*)<a href="#section-1.1-9.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.4">Change expiration extension to lifetime extension (*)<a href="#section-1.1-9.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.5">Make the tree in the Welcome optional (*)<a href="#section-1.1-9.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.6">PSK injection, re-init, sub-group branching (*)<a href="#section-1.1-9.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.7">Require the initial init_secret to be a random value (*)<a href="#section-1.1-9.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.8">Remove explicit sender data nonce (*)<a href="#section-1.1-9.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.9">Do not encrypt to joiners in UpdatePath generation (*)<a href="#section-1.1-9.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.10">Move MLSPlaintext signature under the confirmation tag (*)<a href="#section-1.1-9.10" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.11">Explicitly authenticate group membership with MLSPLaintext (*)<a href="#section-1.1-9.11" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.12">Clarify X509Credential structure (*)<a href="#section-1.1-9.12" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.13">Remove unneeded interim transcript hash from GroupInfo (*)<a href="#section-1.1-9.13" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.14">IANA considerations<a href="#section-1.1-9.14" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.15">Derive an authentication secret<a href="#section-1.1-9.15" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.16">Use Extract/Expand from HPKE KDF<a href="#section-1.1-9.16" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-9.17">Clarify that application messages MUST be encrypted<a href="#section-1.1-9.17" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-10">draft-09<a href="#section-1.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-11.1">Remove blanking of nodes on Add (*)<a href="#section-1.1-11.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.2">Change epoch numbers to uint64 (*)<a href="#section-1.1-11.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.3">Add PSK inputs (*)<a href="#section-1.1-11.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.4">Add key schedule exporter (*)<a href="#section-1.1-11.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.5">Sign the updated direct path on Commit, using "parent hashes" and one
signature per leaf (*)<a href="#section-1.1-11.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.6">Use structured types for external senders (*)<a href="#section-1.1-11.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.7">Redesign Welcome to include confirmation and use derived keys (*)<a href="#section-1.1-11.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.8">Remove ignored proposals (*)<a href="#section-1.1-11.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.9">Always include an Update with a Commit (*)<a href="#section-1.1-11.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.10">Add per-message entropy to guard against nonce reuse (*)<a href="#section-1.1-11.10" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.11">Use the same hash ratchet construct for both application and handshake keys (*)<a href="#section-1.1-11.11" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.12">Add more ciphersuites<a href="#section-1.1-11.12" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.13">Use HKDF to derive key pairs (*)<a href="#section-1.1-11.13" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.14">Mandate expiration of ClientInitKeys (*)<a href="#section-1.1-11.14" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.15">Add extensions to GroupContext and flesh out the extensibility story (*)<a href="#section-1.1-11.15" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-11.16">Rename ClientInitKey to KeyPackage<a href="#section-1.1-11.16" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-12">draft-08<a href="#section-1.1-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-13.1">Change ClientInitKeys so that they only refer to one ciphersuite (*)<a href="#section-1.1-13.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.2">Decompose group operations into Proposals and Commits (*)<a href="#section-1.1-13.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.3">Enable Add and Remove proposals from outside the group (*)<a href="#section-1.1-13.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.4">Replace Init messages with multi-recipient Welcome message (*)<a href="#section-1.1-13.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.5">Add extensions to ClientInitKeys for expiration and downgrade resistance (*)<a href="#section-1.1-13.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-13.6">Allow multiple Proposals and a single Commit in one MLSPlaintext (*)<a href="#section-1.1-13.6" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-14">draft-07<a href="#section-1.1-14" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-15.1">Initial version of the Tree based Application Key Schedule (*)<a href="#section-1.1-15.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-15.2">Initial definition of the Init message for group creation (*)<a href="#section-1.1-15.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-15.3">Fix issue with the transcript used for newcomers (*)<a href="#section-1.1-15.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-15.4">Clarifications on message framing and HPKE contexts (*)<a href="#section-1.1-15.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-16">draft-06<a href="#section-1.1-16" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-17.1">Reorder blanking and update in the Remove operation (*)<a href="#section-1.1-17.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-17.2">Rename the GroupState structure to GroupContext (*)<a href="#section-1.1-17.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-17.3">Rename UserInitKey to ClientInitKey<a href="#section-1.1-17.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-17.4">Resolve the circular dependency that draft-05 introduced in the
confirmation MAC calculation (*)<a href="#section-1.1-17.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-17.5">Cover the entire MLSPlaintext in the transcript hash (*)<a href="#section-1.1-17.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-18">draft-05<a href="#section-1.1-18" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-19.1">Common framing for handshake and application messages (*)<a href="#section-1.1-19.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-19.2">Handshake message encryption (*)<a href="#section-1.1-19.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-19.3">Convert from literal state to a commitment via the "tree hash" (*)<a href="#section-1.1-19.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-19.4">Add credentials to the tree and remove the "roster" concept (*)<a href="#section-1.1-19.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-19.5">Remove the secret field from tree node values<a href="#section-1.1-19.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-20">draft-04<a href="#section-1.1-20" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-21.1">Updating the language to be similar to the Architecture document<a href="#section-1.1-21.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.2">ECIES is now renamed in favor of HPKE (*)<a href="#section-1.1-21.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-21.3">Using a KDF instead of a Hash in TreeKEM (*)<a href="#section-1.1-21.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-22">draft-03<a href="#section-1.1-22" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-23.1">Added ciphersuites and signature schemes (*)<a href="#section-1.1-23.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-23.2">Re-ordered fields in UserInitKey to make parsing easier (*)<a href="#section-1.1-23.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-23.3">Fixed inconsistencies between Welcome and GroupState (*)<a href="#section-1.1-23.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-23.4">Added encryption of the Welcome message (*)<a href="#section-1.1-23.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-24">draft-02<a href="#section-1.1-24" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-25.1">Removed ART (*)<a href="#section-1.1-25.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-25.2">Allowed partial trees to avoid double-joins (*)<a href="#section-1.1-25.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-25.3">Added explicit key confirmation (*)<a href="#section-1.1-25.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-26">draft-01<a href="#section-1.1-26" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-27.1">Initial description of the Message Protection mechanism. (*)<a href="#section-1.1-27.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.2">Initial specification proposal for the Application Key Schedule
using the per-participant chaining of the Application Secret design. (*)<a href="#section-1.1-27.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.3">Initial specification proposal for an encryption mechanism to protect
Application Messages using an AEAD scheme. (*)<a href="#section-1.1-27.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.4">Initial specification proposal for an authentication mechanism
of Application Messages using signatures. (*)<a href="#section-1.1-27.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.5">Initial specification proposal for a padding mechanism to improving
protection of Application Messages against traffic analysis. (*)<a href="#section-1.1-27.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.6">Inversion of the Group Init Add and Application Secret derivations
in the Handshake Key Schedule to be ease chaining in case we switch
design. (*)<a href="#section-1.1-27.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.7">Removal of the UserAdd construct and split of GroupAdd into Add
and Welcome messages (*)<a href="#section-1.1-27.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.8">Initial proposal for authenticating handshake messages by signing
over group state and including group state in the key schedule (*)<a href="#section-1.1-27.8" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.9">Added an appendix with example code for tree math<a href="#section-1.1-27.9" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.1-27.10">Changed the ECIES mechanism used by TreeKEM so that it uses nonces
generated from the shared secret<a href="#section-1.1-27.10" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.1-28">draft-00<a href="#section-1.1-28" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-29.1">Initial adoption of draft-barnes-mls-protocol-01 as a WG item.<a href="#section-1.1-29.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="terminology">
<section id="section-2">
      <h2 id="name-terminology">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
      </h2>
<p id="section-2-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and
"OPTIONAL" in this document are to be interpreted as described in
BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span> when, and only when, they appear in all
capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2-2">
        <dt id="section-2-2.1">
Client:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.2">
          <p id="section-2-2.2.1">An agent that uses this protocol to establish shared cryptographic
state with other clients.  A client is defined by the
cryptographic keys it holds.<a href="#section-2-2.2.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.3">
Group:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.4">
          <p id="section-2-2.4.1">A group represents a logical collection of clents that share a common
secret value at any given time.  Its state is represented as a linear
sequence of epochs in which each epoch depends on its predecessor.<a href="#section-2-2.4.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.5">
Epoch:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.6">
          <p id="section-2-2.6.1">A state of a group in which a specific set of authenticated clients hold
shared cryptographic state.<a href="#section-2-2.6.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.7">
Member:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.8">
          <p id="section-2-2.8.1">A client that is included in the shared state of a group, hence
has access to the group's secrets.<a href="#section-2-2.8.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.9">
Key Package:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.10">
          <p id="section-2-2.10.1">A signed object describing a client's identity and capabilities, and including
a hybrid public-key encryption (HPKE <span>[<a href="#RFC9180" class="xref">RFC9180</a>]</span>) public key that
can be used to encrypt to that client, and which other clients can use to
introduce the client to a new group.<a href="#section-2-2.10.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.11">
Signature Key:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.12">
          <p id="section-2-2.12.1">A signing key pair used to authenticate the sender of a message.<a href="#section-2-2.12.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.13">
Handshake Message:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.14">
          <p id="section-2-2.14.1">An MLSPlaintext or MLSCiphertext message carrying an MLS Proposal or Commit
object, as opposed to application data.<a href="#section-2-2.14.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.15">
Application Message:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.16">
          <p id="section-2-2.16.1">An MLSCiphertext message carrying application data.<a href="#section-2-2.16.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-2-3">Terminology specific to tree computations is described in
<a href="#ratchet-tree-terminology" class="xref">Section 5.1</a>.<a href="#section-2-3" class="pilcrow">¶</a></p>
<div id="presentation-langauge">
<section id="section-2.1">
        <h3 id="name-presentation-langauge">
<a href="#section-2.1" class="section-number selfRef">2.1. </a><a href="#name-presentation-langauge" class="section-name selfRef">Presentation Langauge</a>
        </h3>
<p id="section-2.1-1">We use the TLS presentation language <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span> to describe the structure of
protocol messages.  In addition to the base syntax, we add two additional
features, the ability for fields to be optional and the ability for vectors to
have variable-size length headers.<a href="#section-2.1-1" class="pilcrow">¶</a></p>
<div id="optional-value">
<section id="section-2.1.1">
          <h4 id="name-optional-value">
<a href="#section-2.1.1" class="section-number selfRef">2.1.1. </a><a href="#name-optional-value" class="section-name selfRef">Optional Value</a>
          </h4>
<p id="section-2.1.1-1">An optional value is encoded with a presence-signaling octet, followed by the
value itself if present.  When decoding, a presence octet with a value other
than 0 or 1 MUST be rejected as malformed.<a href="#section-2.1.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-2.1.1-2">
<pre>
struct {
    uint8 present;
    select (present) {
        case 0: struct{};
        case 1: T value;
    }
} optional&lt;T&gt;;
</pre><a href="#section-2.1.1-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="variable-size-vector-headers">
<section id="section-2.1.2">
          <h4 id="name-variable-size-vector-header">
<a href="#section-2.1.2" class="section-number selfRef">2.1.2. </a><a href="#name-variable-size-vector-header" class="section-name selfRef">Variable-size Vector Headers</a>
          </h4>
<p id="section-2.1.2-1">In the TLS presentation language, vectors are encoded as a sequence of encoded
elements prefixed with a length.  The length field has a fixed size set by
specifying the minimum and maximum lengths of the encoded sequence of elements.<a href="#section-2.1.2-1" class="pilcrow">¶</a></p>
<p id="section-2.1.2-2">In MLS, there are several vectors whose sizes vary over significant ranges.  So
instead of using a fixed-size length field, we use a variable-size length using
a variable-length integer encoding based on the one in Section 16 of
<span>[<a href="#RFC9000" class="xref">RFC9000</a>]</span>. (They differ only in that the one here requires a minimum-size
encoding.) Instead of presenting min and max values, the vector description
simply includes a <code>V</code>. For example:<a href="#section-2.1.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-2.1.2-3">
<pre>
struct {
    uint32 fixed&lt;0..255&gt;;
    opaque variable&lt;V&gt;;
} StructWithVectors;
</pre><a href="#section-2.1.2-3" class="pilcrow">¶</a>
</div>
<p id="section-2.1.2-4">Such a vector can represent values with length from 0 bytes to 2^30 bytes.
The variable-length integer encoding reserves the two most significant bits
of the first byte to encode the base 2 logarithm of the integer encoding length
in bytes.  The integer value is encoded on the remaining bits, in network byte
order.  The encoded value MUST use the smallest number of bits required to
represent the value.  When decoding, values using more bits than necessary MUST
be treated as malformed.<a href="#section-2.1.2-4" class="pilcrow">¶</a></p>
<p id="section-2.1.2-5">This means that integers are encoded on 1, 2, or 4 bytes and can encode 6-,
14-, or 30-bit values respectively.<a href="#section-2.1.2-5" class="pilcrow">¶</a></p>
<span id="name-summary-of-integer-encoding"></span><div id="integer-summary">
<table class="center" id="table-1">
            <caption>
<a href="#table-1" class="selfRef">Table 1</a>:
<a href="#name-summary-of-integer-encoding" class="selfRef">Summary of Integer Encodings</a>
            </caption>
<thead>
              <tr>
                <th class="text-left" rowspan="1" colspan="1">Prefix</th>
                <th class="text-left" rowspan="1" colspan="1">Length</th>
                <th class="text-left" rowspan="1" colspan="1">Usable Bits</th>
                <th class="text-left" rowspan="1" colspan="1">Min</th>
                <th class="text-left" rowspan="1" colspan="1">Max</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">00</td>
                <td class="text-left" rowspan="1" colspan="1">1</td>
                <td class="text-left" rowspan="1" colspan="1">6</td>
                <td class="text-left" rowspan="1" colspan="1">0</td>
                <td class="text-left" rowspan="1" colspan="1">63</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">01</td>
                <td class="text-left" rowspan="1" colspan="1">2</td>
                <td class="text-left" rowspan="1" colspan="1">14</td>
                <td class="text-left" rowspan="1" colspan="1">64</td>
                <td class="text-left" rowspan="1" colspan="1">16383</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">10</td>
                <td class="text-left" rowspan="1" colspan="1">4</td>
                <td class="text-left" rowspan="1" colspan="1">30</td>
                <td class="text-left" rowspan="1" colspan="1">16384</td>
                <td class="text-left" rowspan="1" colspan="1">1073741823</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">11</td>
                <td class="text-left" rowspan="1" colspan="1">invalid</td>
                <td class="text-left" rowspan="1" colspan="1">-</td>
                <td class="text-left" rowspan="1" colspan="1">-</td>
                <td class="text-left" rowspan="1" colspan="1">-</td>
              </tr>
            </tbody>
          </table>
</div>
<p id="section-2.1.2-7">Vectors that start with "11" prefix are invalid and MUST be rejected.<a href="#section-2.1.2-7" class="pilcrow">¶</a></p>
<p id="section-2.1.2-8">For example, the four byte sequence 0x9d7f3e7d decodes to 494878333;
the two byte sequence 0x7bbd decodes to 15293; and the single byte 0x25
decodes to 37.<a href="#section-2.1.2-8" class="pilcrow">¶</a></p>
<p id="section-2.1.2-9">The following figure adapts the pseudocode provided in <span>[<a href="#RFC9000" class="xref">RFC9000</a>]</span> to add a
check for minimum-length encoding:<a href="#section-2.1.2-9" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-2.1.2-10">
<pre>
ReadVarint(data):
  // The length of variable-length integers is encoded in the
  // first two bits of the first byte.
  v = data.next_byte()
  prefix = v &gt;&gt; 6
  length = 1 &lt;&lt; prefix

  // Once the length is known, remove these bits and read any
  // remaining bytes.
  v = v &amp; 0x3f
  repeat length-1 times:
    v = (v &lt;&lt; 8) + data.next_byte()
  return v

  // Check that the encoder used the minimum bits required
  if length &gt; 1 &amp;&amp; v &lt; (1 &lt;&lt; (length - 1)):
    raise an exception
</pre><a href="#section-2.1.2-10" class="pilcrow">¶</a>
</div>
<p id="section-2.1.2-11">The use of variable-size integers for vector lengths allows vectors to grow
very large, up to 2^30 bytes.  Implementations should take care not to allow
vectors to overflow available storage.  To facilitate debugging of potential
interoperatbility problems, implementations should provide a clear error when
such an overflow condition occurs.<a href="#section-2.1.2-11" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="operating-context">
<section id="section-3">
      <h2 id="name-operating-context">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-operating-context" class="section-name selfRef">Operating Context</a>
      </h2>
<p id="section-3-1">MLS is designed to operate in the context described in
<span>[<a href="#I-D.ietf-mls-architecture" class="xref">I-D.ietf-mls-architecture</a>]</span>.  In particular, we assume that the following
services are provided:<a href="#section-3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.1">
          <p id="section-3-2.1.1">A Delivery Service that routes MLS messages among the participants in the
protocol.  The following types of delivery are typically required:<a href="#section-3-2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.1.2.1">Pre-publication of KeyPackage objects for clients<a href="#section-3-2.1.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-3-2.1.2.2">Broadcast delivery of Proposal and Commit messages to members of a group<a href="#section-3-2.1.2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-3-2.1.2.3">Unicast delivery of Welcome messages to new members of a group<a href="#section-3-2.1.2.3" class="pilcrow">¶</a>
</li>
          </ul>
</li>
        <li class="normal" id="section-3-2.2">An Authentication Service that enables group members to authenticate the
credentials presented by other group members.<a href="#section-3-2.2" class="pilcrow">¶</a>
</li>
      </ul>
</section>
</div>
<div id="protocol-overview">
<section id="section-4">
      <h2 id="name-protocol-overview">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-protocol-overview" class="section-name selfRef">Protocol Overview</a>
      </h2>
<p id="section-4-1">The core functionality of MLS is continuous group authenticated key exchange
(AKE).  As with other authenticated key exchange protocols (such as TLS), the
participants in the protocol agree on a common secret value, and each
participant can verify the identity of the other participants.  MLS provides
group AKE in the sense that there can be more than two participants in the
protocol, and continuous group AKE in the sense that the set of participants in
the protocol can change over time.<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">The core organizing principles of MLS are <em>groups</em> and <em>epochs</em>.  A group
represents a logical collection of clients that share a common secret value at
any given time.  The history of a group is divided into a linear sequence of
epochs.  In each epoch, a set of authenticated <em>members</em> agree on an <em>epoch
secret</em> that is known only to the members of the group in that epoch.  The set
of members involved in the group can change from one epoch to the next, and MLS
ensures that only the members in the current epoch have access to the epoch
secret.  From the epoch secret, members derive further shared secrets for
message encryption, group membership authentication, etc.<a href="#section-4-2" class="pilcrow">¶</a></p>
<p id="section-4-3">The creator of an MLS group creates the group's first epoch unilaterally, with
no protocol interactions.  Thereafter, the members of the group advance their
shared cryptographic state from one epoch to another by exchanging MLS messages:<a href="#section-4-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4-4.1">A <em>KeyPackage</em> object describes a client's capabilities and provides keys that
can be used to add the client to a group.<a href="#section-4-4.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-4.2">A <em>Proposal</em> message proposes a change to be made in the next epoch, such as
adding or removing a member<a href="#section-4-4.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-4.3">A <em>Commit</em> message initiates a new epoch by instructing members of the group
to implement a collection of proposals<a href="#section-4-4.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-4.4">A <em>Welcome</em> message provides a new member to the group with the information to
initialize their state for the epoch in which they were added or in which they
want to add themselves to the group<a href="#section-4-4.4" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-4-5">KeyPackage and Welcome messages are used to initiate a group or introduce new
members, so they are exchanged between group members and clients not yet in the
group.<a href="#section-4-5" class="pilcrow">¶</a></p>
<p id="section-4-6">Proposal and Commit messages are sent from one member of a group to the others.
MLS provides a common framing layer for sending messages within a group:
An <em>MLSPlaintext</em>
message provides sender authentication for unencrypted Proposal and Commit
messages.  An <em>MLSCiphertext</em> message provides encryption and authentication for
both Proposal/Commit messages as well as any application data.<a href="#section-4-6" class="pilcrow">¶</a></p>
<div id="cryptographic-state-and-evolution">
<section id="section-4.1">
        <h3 id="name-cryptographic-state-and-evo">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-cryptographic-state-and-evo" class="section-name selfRef">Cryptographic State and Evolution</a>
        </h3>
<p id="section-4.1-1">The cryptographic state at the core of MLS is divided into three areas of responsibility:<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<span id="name-overview-of-mls-group-evolu"></span><figure id="figure-1">
          <div class="alignLeft art-text artwork" id="section-4.1-2.1">
<pre>
                           epoch_secret
                         _      |      _
|\ Ratchet              /      ...      \                    Secret /|
| \ Tree                :       |       :                     Tree / |
|  \                    :       |       :                         /  |
|   \                   :       V       :                        /   |
|    --&gt; commit_secret --&gt; epoch_secret --&gt; encryption_secret --&gt;    |
|   /                   :       |       :                        \   |
|  /                    :      ...      &gt; Key Schedule            \  |
| /                     :       |       :                          \ |
|/                      \_      |      _/                           \|
                                V
                           epoch_secret
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-overview-of-mls-group-evolu" class="selfRef">Overview of MLS group evolution</a>
          </figcaption></figure>
<ul class="normal">
<li class="normal" id="section-4.1-3.1">A <em>ratchet tree</em> that represents the membership of the group, providing group
members a way to authenticate each other and efficiently encrypt messages to
subsets of the group.  Each epoch has a distinct ratchet tree. It seeds the
<em>key schedule</em>.<a href="#section-4.1-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.1-3.2">A <em>key schedule</em> that describes the chain of key derivations used to progress from
epoch to epoch (mainly using the <em>init_secret</em> and <em>epoch_secret</em>); and to derive
a variety of other secrets (see <a href="#epoch-derived-secrets" class="xref">Table 3</a>) used during the current
epoch. One of these (the <em>encryption_secret</em>) is the root of <em>secret_tree</em>.<a href="#section-4.1-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.1-3.3">A <em>secret tree</em> derived from the key schedule that represents shared secrets
used by the members of the group to provide confidentiality and forward
secrecy for MLS messages.  Each epoch has a distinct secret tree.<a href="#section-4.1-3.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-4.1-4">Each member of the group maintains a view of these facets of the group's
state.  MLS messages are used to initialize these views and keep them in sync as
the group transitions between epochs.<a href="#section-4.1-4" class="pilcrow">¶</a></p>
<p id="section-4.1-5">Each new epoch is initiated with a Commit message.  The Commit instructs
existing members of the group to update their views of the ratchet tree by applying
a set of Proposals, and uses the updated ratchet tree to distribute fresh
entropy to the group.  This fresh entropy is provided only to members in the new
epoch, not to members who have been removed, so it maintains the confidentiality
of the epoch secret (in other words, it provides post-compromise security with
respect to those members).<a href="#section-4.1-5" class="pilcrow">¶</a></p>
<p id="section-4.1-6">For each Commit that adds member(s) to the group, there is a single corresponding
Welcome message.  The Welcome message provides all the new members with the information
they need to initialize their views of the key schedule and ratchet tree, so
that these views are equivalent to the views held by other members of the group
in this epoch.<a href="#section-4.1-6" class="pilcrow">¶</a></p>
<p id="section-4.1-7">In addition to defining how one epoch secret leads to the next, the key schedule
also defines a collection of secrets that are derived from the epoch secret.
For example:<a href="#section-4.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1-8.1">An <em>encryption secret</em> that is used to initialize the secret tree for the
epoch.<a href="#section-4.1-8.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.1-8.2">A <em>confirmation key</em> that is used to confirm that all members agree on the
shared state of the group.<a href="#section-4.1-8.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.1-8.3">A <em>resumption secret</em> that members can use to prove their membership in the
group, e.g., in the case of branching a subgroup.<a href="#section-4.1-8.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-4.1-9">Finally, an <em>init secret</em> is derived that is used to initialize the next epoch.<a href="#section-4.1-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="example-protocol-execution">
<section id="section-4.2">
        <h3 id="name-example-protocol-execution">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-example-protocol-execution" class="section-name selfRef">Example Protocol Execution</a>
        </h3>
<p id="section-4.2-1">There are three major operations in the lifecycle of a group:<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-2.1">Adding a member, initiated by a current member;<a href="#section-4.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.2-2.2">Updating the leaf secret of a member;<a href="#section-4.2-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.2-2.3">Removing a member.<a href="#section-4.2-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-4.2-3">Each of these operations is "proposed" by sending a message of the corresponding
type (Add / Update / Remove).  The state of the group is not changed, however,
until a Commit message is sent to provide the group with fresh entropy.  In this
section, we show each proposal being committed immediately, but in more advanced
deployment cases an application might gather several proposals before
committing them all at once.  In the illustrations below, we show the Proposal
and Commit messages directly, while in reality they would be sent encapsulated in
MLSPlaintext or MLSCiphertext objects.<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<p id="section-4.2-4">Before the initialization of a group, clients publish KeyPackages to a directory
provided by the Service Provider.<a href="#section-4.2-4" class="pilcrow">¶</a></p>
<span id="name-clients-a-b-and-c-publish-k"></span><figure id="figure-2">
          <div class="alignLeft art-text artwork" id="section-4.2-5.1">
<pre>
                                                               Group
A                B                C            Directory       Channel
|                |                |                |              |
| KeyPackageA    |                |                |              |
|-------------------------------------------------&gt;|              |
|                |                |                |              |
|                | KeyPackageB    |                |              |
|                |--------------------------------&gt;|              |
|                |                |                |              |
|                |                | KeyPackageC    |              |
|                |                |---------------&gt;|              |
|                |                |                |              |
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-clients-a-b-and-c-publish-k" class="selfRef">Clients A, B, and C publish KeyPackages to the directory</a>
          </figcaption></figure>
<p id="section-4.2-6">When a client A wants to establish a group with B and C, it first initializes a
group state containing only itself and downloads KeyPackages for B and C. For
each member, A generates an Add and Commit message adding that member, and
broadcasts them to the group. It also generates a Welcome message and sends this
directly to the new member (there's no need to send it to the group). Only after
A has received its Commit message back from the server does it update its state
to reflect the new member's addition.<a href="#section-4.2-6" class="pilcrow">¶</a></p>
<p id="section-4.2-7">Upon receiving the Welcome message, the new member will be able to read and send
new messages to the group. However, messages sent before they were added to the
group will not be accessible.<a href="#section-4.2-7" class="pilcrow">¶</a></p>
<span id="name-client-a-creates-a-group-wi"></span><figure id="figure-3">
          <div class="alignLeft art-text artwork" id="section-4.2-8.1">
<pre>
                                                               Group
A              B              C          Directory            Channel
|              |              |              |                   |
|         KeyPackageB, KeyPackageC           |                   |
|&lt;-------------------------------------------|                   |
|              |              |              |                   |
|              |              |              | Add(A-&gt;AB)        |
|              |              |              | Commit(Add)       |
|---------------------------------------------------------------&gt;|
|              |              |              |                   |
|  Welcome(B)  |              |              |                   |
|-------------&gt;|              |              |                   |
|              |              |              |                   |
|              |              |              | Add(A-&gt;AB)        |
|              |              |              | Commit(Add)       |
|&lt;---------------------------------------------------------------|
|              |              |              |                   |
|              |              |              |                   |
|              |              |              | Add(AB-&gt;ABC)      |
|              |              |              | Commit(Add)       |
|---------------------------------------------------------------&gt;|
|              |              |              |                   |
|              |  Welcome(C)  |              |                   |
|----------------------------&gt;|              |                   |
|              |              |              |                   |
|              |              |              | Add(AB-&gt;ABC)      |
|              |              |              | Commit(Add)       |
|&lt;---------------------------------------------------------------|
|              |&lt;------------------------------------------------|
|              |              |              |                   |
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-client-a-creates-a-group-wi" class="selfRef">Client A creates a group with clients B and C</a>
          </figcaption></figure>
<p id="section-4.2-9">Subsequent additions of group members proceed in the same way.  Any
member of the group can download a KeyPackage for a new client
and broadcast Add and Commit messages that the current group will use to update
their state, and a Welcome message that the new client can use to
initialize its state and join the group.<a href="#section-4.2-9" class="pilcrow">¶</a></p>
<p id="section-4.2-10">To enforce the forward secrecy and post-compromise security of messages, each
member periodically updates the keys that represent them to the group.  A member
does this by sending a Commit (possibly with no proposals), or by sending an
Update message that is committed by another member.  Once the other members of
the group have processed these messages, the group's secrets will be unknown to
an attacker that had compromised the sender's prior leaf secret.<a href="#section-4.2-10" class="pilcrow">¶</a></p>
<p id="section-4.2-11">Update messages should be sent at regular intervals of time as long as the group
is active, and members that don't update should eventually be removed from the
group. It's left to the application to determine an appropriate amount of time
between Updates.<a href="#section-4.2-11" class="pilcrow">¶</a></p>
<span id="name-client-b-proposes-to-update"></span><figure id="figure-4">
          <div class="alignLeft art-text artwork" id="section-4.2-12.1">
<pre>
                                                          Group
A              B     ...      Z          Directory        Channel
|              |              |              |              |
|              | Update(B)    |              |              |
|              |-------------------------------------------&gt;|
| Commit(Upd)  |              |              |              |
|----------------------------------------------------------&gt;|
|              |              |              |              |
|              |              |              | Update(B)    |
|              |              |              | Commit(Upd)  |
|&lt;----------------------------------------------------------|
|              |&lt;-------------------------------------------|
|              |              |&lt;----------------------------|
|              |              |              |              |
</pre>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-client-b-proposes-to-update" class="selfRef">Client B proposes to update its key, and client A commits the proposal.  As a result, the keys for both B and A updated, so the group has post-compromise security with respect to both of them.</a>
          </figcaption></figure>
<p id="section-4.2-13">Members are removed from the group in a similar way.
Any member of the group can send a Remove proposal followed by a
Commit message.  The Commit message provides new entropy to all members of the
group except the removed member.  This new entropy is added to the epoch secret
for the new epoch, so that it is not known to the removed member.
Note that this does not necessarily imply that any member
is actually allowed to evict other members; groups can
enforce access control policies on top of these
basic mechanism.<a href="#section-4.2-13" class="pilcrow">¶</a></p>
<span id="name-client-z-removes-client-b-f"></span><figure id="figure-5">
          <div class="alignLeft art-text artwork" id="section-4.2-14.1">
<pre>
                                                          Group
A              B     ...      Z          Directory       Channel
|              |              |              |              |
|              |              | Remove(B)    |              |
|              |              | Commit(Rem)  |              |
|              |              |----------------------------&gt;|
|              |              |              |              |
|              |              |              | Remove(B)    |
|              |              |              | Commit(Rem)  |
|&lt;----------------------------------------------------------|
|              |              |&lt;----------------------------|
|              |              |              |              |
</pre>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-client-z-removes-client-b-f" class="selfRef">Client Z removes client B from the group</a>
          </figcaption></figure>
</section>
</div>
<div id="relationships-between-epochs">
<section id="section-4.3">
        <h3 id="name-relationships-between-epoch">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-relationships-between-epoch" class="section-name selfRef">Relationships Between Epochs</a>
        </h3>
<p id="section-4.3-1">A group has a single linear sequence of epochs. Groups and epochs are generally
independent of one-another. However, it can sometimes be useful to link epochs
cryptographically, either within a group or across groups. MLS derives a
resumption pre-shared key (PSK) from each epoch to allow entropy extracted from
one epoch to be injected into a future epoch. This link guarantees that members
entering the new epoch agree on a key if and only if they were members of the group
during the epoch from which the resumption key was extracted.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.3-2">MLS supports two ways to tie a new group to an existing group. Re-initialization
closes one group and creates a new group comprising the same members with
different parameters. Branching starts a new group with a subset of the original
group's participants (with no effect on the original group).  In both cases,
the new group is linked to the old group via a resumption PSK.<a href="#section-4.3-2" class="pilcrow">¶</a></p>
<span id="name-reinitializing-a-group"></span><figure id="figure-6">
          <div class="alignLeft art-text artwork" id="section-4.3-3.1">
<pre>
epoch_A_[n-1]
     |
     |
     |&lt;-- ReInit
     |
     V
epoch_A_[n]           epoch_B_[0]
     .                     |
     .  PSK(usage=reinit)  |
     .....................&gt;|
                           |
                           V
                      epoch_B_[1]
</pre>
</div>
<figcaption><a href="#figure-6" class="selfRef">Figure 6</a>:
<a href="#name-reinitializing-a-group" class="selfRef">Reinitializing a group</a>
          </figcaption></figure>
<span id="name-branching-a-group"></span><figure id="figure-7">
          <div class="alignLeft art-text artwork" id="section-4.3-4.1">
<pre>
epoch_A_[n-1]
     |
     |
     |&lt;-- ReInit
     |
     V
epoch_A_[n]           epoch_B_[0]
     |                     |
     |  PSK(usage=branch)  |
     |....................&gt;|
     |                     |
     V                     V
epoch_A_[n+1]         epoch_B_[1]
</pre>
</div>
<figcaption><a href="#figure-7" class="selfRef">Figure 7</a>:
<a href="#name-branching-a-group" class="selfRef">Branching a group</a>
          </figcaption></figure>
<p id="section-4.3-5">Applications may also choose to use resumption PSKs to link epochs in other
ways.  For example, the following figure shows a case where a resumption PSK
from epoch <code>n</code> is injected into epoch <code>n+k</code>.  This demonstrates that the members
of the group at epoch <code>n+k</code> were also members at epoch <code>n</code>, irrespective of any
changes to these members' keys due to Updates or Commits.<a href="#section-4.3-5" class="pilcrow">¶</a></p>
<span id="name-reinjecting-entropy-from-an"></span><figure id="figure-8">
          <div class="alignLeft art-text artwork" id="section-4.3-6.1">
<pre>
epoch_A_[n-1]
     |
     |
     |&lt;-- ReInit
     |
     V
epoch_A_[n]
     |
     |  PSK(usage=application)
     |.....................
     |                    .
     |                    .
    ...                  ...
     |                    .
     |                    .
     V                    .
epoch_A_[n+k-1]           .
     |                    .
     |                    .
     |&lt;....................
     |
     V
epoch_A_[n+k]
</pre>
</div>
<figcaption><a href="#figure-8" class="selfRef">Figure 8</a>:
<a href="#name-reinjecting-entropy-from-an" class="selfRef">Reinjecting entropy from an earlier epoch</a>
          </figcaption></figure>
</section>
</div>
</section>
</div>
<div id="ratchet-tree-concepts">
<section id="section-5">
      <h2 id="name-ratchet-tree-concepts">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-ratchet-tree-concepts" class="section-name selfRef">Ratchet Tree Concepts</a>
      </h2>
<p id="section-5-1">The protocol uses "ratchet trees" for deriving shared secrets among a group of
clients.  A ratchet tree is an arrangement of secrets and key pairs among the
members of a group in a way that allows for secrets to be efficiently updated to
reflect changes in the group.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">Ratchet trees allow a group to efficiently remove any member by encrypting new
entropy to a subset of the group.  A ratchet tree assigns shared keys to
subgroups of the overall group, so that, for example, encrypting to all but one
member of the group requires only log(N) encryptions, instead of the N-1
encryptions that would be needed to encrypt to each participant individually
(where N is the number of members in the group).<a href="#section-5-2" class="pilcrow">¶</a></p>
<p id="section-5-3">This remove operation allows MLS to efficiently achieve
post-compromise security.  In an Update proposal or a full Commit message, an old (possibly
compromised) representation of a member is efficiently removed from the group and
replaced with a freshly generated instance.<a href="#section-5-3" class="pilcrow">¶</a></p>
<div id="ratchet-tree-terminology">
<section id="section-5.1">
        <h3 id="name-ratchet-tree-terminology">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-ratchet-tree-terminology" class="section-name selfRef">Ratchet Tree Terminology</a>
        </h3>
<p id="section-5.1-1">Trees consist of <em>nodes</em>. A node is a
<em>leaf</em> if it has no children, and a <em>parent</em> otherwise; note that all
parents in our trees have precisely
two children, a <em>left</em> child and a <em>right</em> child. A node is the <em>root</em>
of a tree if it has no parents, and <em>intermediate</em> if it has both
children and parents. The <em>descendants</em> of a node are that node's
children, and the descendants of its children, and we say a tree
<em>contains</em> a node if that node is a descendant of the root of the tree,
or if the node itself is the root of the tree. Nodes are <em>siblings</em> if they share the same parent.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1-2">A <em>subtree</em> of a tree is the tree given by any node (the <em>head</em> of the
subtree) and its descendants. The <em>size</em> of a tree or subtree is the
number of leaf nodes it contains.  For a given parent node, its <em>left
subtree</em> is the subtree with its left child as head (respectively
<em>right subtree</em>).<a href="#section-5.1-2" class="pilcrow">¶</a></p>
<p id="section-5.1-3">All trees used in this protocol are left-balanced binary trees. A
binary tree is <em>full</em> (and <em>balanced</em>) if its size is a power of
two and for any parent node in the tree, its left and right subtrees
have the same size.<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<p id="section-5.1-4">A binary tree is <em>left-balanced</em> if for every
parent, either the parent is balanced, or the left subtree of that
parent is the largest full subtree that could be constructed from
the leaves present in the parent's own subtree.
Given a list of <code>n</code> items, there is a unique left-balanced
binary tree structure with these elements as leaves.<a href="#section-5.1-4" class="pilcrow">¶</a></p>
<p id="section-5.1-5">(Note that left-balanced binary trees are the same structure that is
used for the Merkle trees in the Certificate Transparency protocol
<span>[<a href="#I-D.ietf-trans-rfc6962-bis" class="xref">I-D.ietf-trans-rfc6962-bis</a>]</span>.)<a href="#section-5.1-5" class="pilcrow">¶</a></p>
<p id="section-5.1-6">The <em>direct path</em> of a root is the empty list, and of any other node
is the concatenation of that node's parent along with the parent's direct path.
The <em>copath</em> of a node is the node's sibling concatenated with the list of
siblings of all the nodes in its direct path, excluding the root.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<p id="section-5.1-7">For example, in the below tree:<a href="#section-5.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.1-8.1">The direct path of C is (W, V, X)<a href="#section-5.1-8.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.1-8.2">The copath of C is (D, U, Z)<a href="#section-5.1-8.2" class="pilcrow">¶</a>
</li>
        </ul>
<span id="name-a-complete-tree-with-seven-"></span><div id="full-tree">
<figure id="figure-9">
          <div class="alignLeft art-text artwork" id="section-5.1-9.1">
<pre>
              X = root
        ______|______
       /             \
      V               Z
    __|__           __|
   /     \         /   \
  U       W       Y     |
 / \     / \     / \    |
A   B   C   D   E   F   G

0   1   2   3   4   5   6
</pre>
</div>
<figcaption><a href="#figure-9" class="selfRef">Figure 9</a>:
<a href="#name-a-complete-tree-with-seven-" class="selfRef">A complete tree with seven members</a>
          </figcaption></figure>
</div>
<p id="section-5.1-10">A tree with <code>n</code> leaves has <code>2*n - 1</code> nodes.  For example, the above tree has 7
leaves (A, B, C, D, E, F, G) and 13 nodes.<a href="#section-5.1-10" class="pilcrow">¶</a></p>
<p id="section-5.1-11">Each leaf is given an <em>index</em> (or <em>leaf index</em>), starting at <code>0</code> from the left to
<code>n-1</code> at the right.<a href="#section-5.1-11" class="pilcrow">¶</a></p>
<p id="section-5.1-12">Finally, a node in the tree may also be <em>blank</em>, indicating that no value
is present at that node (i.e. no keying material). This is often the case
when a leaf was recently removed from the tree.<a href="#section-5.1-12" class="pilcrow">¶</a></p>
<p id="section-5.1-13">There are multiple ways that an implementation might represent a ratchet tree in
memory.  For example, left-balanced binary trees can be represented as an array
of nodes, with node relationships computed based on nodes' indices in the array.
Or a more traditional representation of linked node objects may be used.
<a href="#array-based-trees" class="xref">Appendix B</a> and <a href="#link-based-trees" class="xref">Appendix C</a> provide some details on how to
implement the tree operations required for MLS in these representations.
MLS places no requirements on implementations' internal representations
of ratchet trees.  An implementation MAY use any tree representation and
associated algorithms, as long as they produce correct protocol messages.<a href="#section-5.1-13" class="pilcrow">¶</a></p>
</section>
</div>
<div id="views">
<section id="section-5.2">
        <h3 id="name-views-of-a-ratchet-tree">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-views-of-a-ratchet-tree" class="section-name selfRef">Views of a Ratchet Tree</a>
        </h3>
<p id="section-5.2-1">We generally assume that each participant maintains a complete and
up-to-date view of the public state of the group's ratchet tree,
including the public keys for all nodes and the credentials
associated with the leaf nodes.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2-2">No participant in an MLS group knows the private key associated with
every node in the tree. Instead, each member is assigned to a leaf of the tree,
which determines the subset of private keys it knows. The
credential stored at that leaf is one provided by the member.<a href="#section-5.2-2" class="pilcrow">¶</a></p>
<p id="section-5.2-3">In particular, MLS maintains the members' views of the tree in such
a way as to maintain the <em>tree invariant</em>:<a href="#section-5.2-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2-4">
<pre>
The private key for a node in the tree is known to a member of
the group only if the node's subtree contains that member's leaf.
</pre><a href="#section-5.2-4" class="pilcrow">¶</a>
</div>
<p id="section-5.2-5">In other words, if a node is not blank, then it holds a public key.
The corresponding private key is known only to members occupying
leaves below that node.<a href="#section-5.2-5" class="pilcrow">¶</a></p>
<p id="section-5.2-6">The reverse implication is not true: A member may not know the private keys of
all the intermediate nodes they're below.  Such a member has an <em>unmerged</em> leaf.
Encrypting to an intermediate node requires encrypting to the node's public key,
as well as the public keys of all the unmerged leaves below it.  A leaf is
unmerged when it is first added, because the process of adding the leaf does not
give it access to all of the nodes above it in the tree.  Leaves are "merged" as
they receive the private keys for nodes, as described in
<a href="#ratchet-tree-evolution" class="xref">Section 8.4</a>.<a href="#section-5.2-6" class="pilcrow">¶</a></p>
<p id="section-5.2-7">For example, consider a four-member group (A, B, C, D) where the node above the
right two members is blank.  (This is what it would look like if A created a
group with B, C, and D.)  Then the public state of the tree and the views of the
private keys of the tree held by each participant would be as follows, where <code>_</code>
represents a blank node, <code>?</code> represents an unknown private key, and <code>pk(X)</code>
represents the public key corresponding to the private key <code>X</code>:<a href="#section-5.2-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2-8">
<pre>
         Public Tree
============================
            pk(ABCD)
          /          \
    pk(AB)            _
     / \             / \
pk(A)   pk(B)   pk(C)   pk(D)


 Private @ A       Private @ B       Private @ C       Private @ D
=============     =============     =============     =============
     ABCD              ABCD              ABCD              ABCD
    /   \             /   \             /   \             /   \
  AB      _         AB      _         ?       _         ?       _
 / \     / \       / \     / \       / \     / \       / \     / \
A   ?   ?   ?     ?   B   ?   ?     ?   ?   C   ?     ?   ?   ?   D
</pre><a href="#section-5.2-8" class="pilcrow">¶</a>
</div>
<p id="section-5.2-9">Note how the tree invariant applies: Each member knows only their own leaf, and
the private key AB is known only to A and B.<a href="#section-5.2-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ratchet-tree-nodes">
<section id="section-5.3">
        <h3 id="name-ratchet-tree-nodes">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-ratchet-tree-nodes" class="section-name selfRef">Ratchet Tree Nodes</a>
        </h3>
<p id="section-5.3-1">A particular instance of a ratchet tree includes the same parameters that
define an instance of HPKE, namely:<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-2.1">A Key Encapsulation Mechanism (KEM), including a <code>DeriveKeyPair</code> function that
creates a key pair for the KEM from a symmetric secret<a href="#section-5.3-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-2.2">A Key Derivation Function (KDF), including <code>Extract</code> and <code>Expand</code> functions<a href="#section-5.3-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-2.3">An AEAD encryption scheme<a href="#section-5.3-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.3-3">Each non-blank node in a ratchet tree contains up to five values:<a href="#section-5.3-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-4.1">A public key<a href="#section-5.3-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-4.2">A private key (only within the member's direct path, see below)<a href="#section-5.3-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-4.3">A credential (only for leaf nodes)<a href="#section-5.3-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-4.4">An ordered list of "unmerged" leaves (see <a href="#views" class="xref">Section 5.2</a>)<a href="#section-5.3-4.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-4.5">A hash of certain information about the node's parent, as of the last time the
node was changed (see <a href="#parent-hash" class="xref">Section 8.8</a>).<a href="#section-5.3-4.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.3-5">The <em>resolution</em> of a node is an ordered list of non-blank nodes
that collectively cover all non-blank descendants of the node.  The resolution
of a non-blank node with no unmerged leaves is just the node itself. More generally, the resolution
of a node is effectively a depth-first, left-first enumeration of the nearest
non-blank nodes below the node:<a href="#section-5.3-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-6.1">The resolution of a non-blank node comprises the node itself,
followed by its list of unmerged leaves, if any<a href="#section-5.3-6.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-6.2">The resolution of a blank leaf node is the empty list<a href="#section-5.3-6.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-6.3">The resolution of a blank intermediate node is the result of
concatenating the resolution of its left child with the resolution
of its right child, in that order<a href="#section-5.3-6.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.3-7">For example, consider the following subtree, where the <code>_</code> character
represents a blank node and unmerged leaves are indicated in square
brackets:<a href="#section-5.3-7" class="pilcrow">¶</a></p>
<span id="name-a-tree-with-blanks-and-unme"></span><div id="resolution-tree">
<figure id="figure-10">
          <div class="alignLeft art-text artwork" id="section-5.3-8.1">
<pre>
       ...
       /
      _
    __|__
   /     \
  _       Z[C]
 / \     / \
A   _   C   D

0   1   2   3
</pre>
</div>
<figcaption><a href="#figure-10" class="selfRef">Figure 10</a>:
<a href="#name-a-tree-with-blanks-and-unme" class="selfRef">A tree with blanks and unmerged leaves</a>
          </figcaption></figure>
</div>
<p id="section-5.3-9">In this tree, we can see all of the above rules in play:<a href="#section-5.3-9" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-10.1">The resolution of node Z is the list [Z, C]<a href="#section-5.3-10.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-10.2">The resolution of leaf 1 is the empty list []<a href="#section-5.3-10.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-10.3">The resolution of top node is the list [A, Z, C]<a href="#section-5.3-10.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-5.3-11">Every node, regardless of whether the node is blank or populated, has
a corresponding <em>hash</em> that summarizes the contents of the subtree
below that node.  The rules for computing these hashes are described
in <a href="#tree-hashes" class="xref">Section 8.7</a>.<a href="#section-5.3-11" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="cryptographic-objects">
<section id="section-6">
      <h2 id="name-cryptographic-objects">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-cryptographic-objects" class="section-name selfRef">Cryptographic Objects</a>
      </h2>
<div id="ciphersuites">
<section id="section-6.1">
        <h3 id="name-ciphersuites">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-ciphersuites" class="section-name selfRef">Ciphersuites</a>
        </h3>
<p id="section-6.1-1">Each MLS session uses a single ciphersuite that specifies the
following primitives to be used in group key computations:<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1-2.1">
            <p id="section-6.1-2.1.1">HPKE parameters:<a href="#section-6.1-2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1-2.1.2.1">A Key Encapsulation Mechanism (KEM)<a href="#section-6.1-2.1.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-6.1-2.1.2.2">A Key Derivation Function (KDF)<a href="#section-6.1-2.1.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-6.1-2.1.2.3">An AEAD encryption algorithm<a href="#section-6.1-2.1.2.3" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-6.1-2.2">A hash algorithm<a href="#section-6.1-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.1-2.3">A MAC algorithm<a href="#section-6.1-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.1-2.4">A signature algorithm<a href="#section-6.1-2.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-6.1-3">MLS uses HPKE for public-key encryption <span>[<a href="#RFC9180" class="xref">RFC9180</a>]</span>.  The
<code>DeriveKeyPair</code> function associated to the KEM for the ciphersuite maps octet
strings to HPKE key pairs.  As in HPKE, MLS assumes that an AEAD algorithm
produces a single ciphertext output from AEAD encryption (aligning with
<span>[<a href="#RFC5116" class="xref">RFC5116</a>]</span>), as opposed to a separate ciphertext and tag.<a href="#section-6.1-3" class="pilcrow">¶</a></p>
<p id="section-6.1-4">Ciphersuites are represented with the CipherSuite type. HPKE public keys
are opaque values in a format defined by the underlying
protocol (see the Cryptographic Dependencies section of the HPKE specification for more
information).<a href="#section-6.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1-5">
<pre>
opaque HPKEPublicKey&lt;V&gt;;
</pre><a href="#section-6.1-5" class="pilcrow">¶</a>
</div>
<p id="section-6.1-6">The signature algorithm specified in the ciphersuite is the mandatory algorithm
to be used for signatures in MLSMessageAuth and the tree signatures.  It MUST be
the same as the signature algorithm specified in the credentials in the leaves
of the tree (including the leaf node information in KeyPackages used to add new
members).<a href="#section-6.1-6" class="pilcrow">¶</a></p>
<p id="section-6.1-7">To disambiguate different signatures used in MLS, each signed value is prefixed
by a label as shown below:<a href="#section-6.1-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1-8">
<pre>
SignWithLabel(SignatureKey, Label, Content) =
    Signature.Sign(SignatureKey, SignContent)

VerifyWithLabel(VerificationKey, Label, Content) =
    Signature.Verify(VerificationKey, SignContent)

Where SignContent is specified as:

struct {
    opaque label&lt;V&gt; = "MLS 1.0 " + Label;
    opaque content&lt;V&gt; = Content;
} SignContent;
</pre><a href="#section-6.1-8" class="pilcrow">¶</a>
</div>
<p id="section-6.1-9">Here, the functions <code>Signature.Sign</code> and <code>Signature.Verify</code> are defined
by the signature algorithm.<a href="#section-6.1-9" class="pilcrow">¶</a></p>
<p id="section-6.1-10">The ciphersuites are defined in section <a href="#mls-ciphersuites" class="xref">Section 18.1</a>.<a href="#section-6.1-10" class="pilcrow">¶</a></p>
</section>
</div>
<div id="hash-based-identifiers">
<section id="section-6.2">
        <h3 id="name-hash-based-identifiers">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-hash-based-identifiers" class="section-name selfRef">Hash-Based Identifiers</a>
        </h3>
<p id="section-6.2-1">Some MLS messages refer to other MLS objects by hash.  For example, Welcome
messages refer to KeyPackages for the members being welcomed, and Commits refer
to Proposals they cover.  These identifiers are computed as follows:<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.2-2">
<pre>
opaque HashReference[16];

MakeKeyPackageRef(value) = KDF.expand(
  KDF.extract("", value), "MLS 1.0 KeyPackage Reference", 16)

MakeLeafNodeRef(value) = KDF.expand(
  KDF.extract("", value), "MLS 1.0 Leaf Node Reference", 16)

MakeProposalRef(value) = KDF.expand(
  KDF.extract("", value), "MLS 1.0 Proposal Reference", 16)

HashReference KeyPackageRef;
HashReference LeafNodeRef;
HashReference ProposalRef;
</pre><a href="#section-6.2-2" class="pilcrow">¶</a>
</div>
<p id="section-6.2-3">For a KeyPackageRef, the <code>value</code> input is the encoded KeyPackage, and the
ciphersuite specified in the KeyPackage determines the KDF used.  For a
LeafNodeRef, the <code>value</code> input is the LeafNode object for the leaf node in
question.  For a ProposalRef, the <code>value</code> input is the MLSMessageContentAuth carrying the
proposal.  In the latter two cases, the KDF is determined by the group's
ciphersuite.<a href="#section-6.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="credentials">
<section id="section-6.3">
        <h3 id="name-credentials">
<a href="#section-6.3" class="section-number selfRef">6.3. </a><a href="#name-credentials" class="section-name selfRef">Credentials</a>
        </h3>
<p id="section-6.3-1">A member of a group authenticates the identities of other participants by means
of credentials issued by some authentication system, like a PKI. Each type of
credential MUST express the following data in the context of the group it is
used with:<a href="#section-6.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.3-2.1">The public key of a signature key pair matching the SignatureScheme specified
by the CipherSuite of the group<a href="#section-6.3-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.3-2.2">One or more identifiers of the holder of the private key<a href="#section-6.3-2.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-6.3-3">Note that a Credential can provide multiple identifiers for the client.  If an
application wishes to decided whether a credential represents the correct
identifier for a participant in a given context, it is up to the application to
decide what the correct value is and compare it to the credential.  For example,
a certificate in an X509Credential may attest to several domain names or email
addresses in its subjectAltName extension.  An application may decide to
present all of these to a user, or if it knows a "desired" domain name or email
address, it can check that the desired identifier is among those attested.
Using the terminology from <span>[<a href="#RFC6125" class="xref">RFC6125</a>]</span>, a Credential provides "presented
identifiers", and it is up to the application to supply a "reference identifier"
for the authenticated client, if any.<a href="#section-6.3-3" class="pilcrow">¶</a></p>
<p id="section-6.3-4">Credentials MAY also include information that allows a relying party
to verify the identity / signing key binding.<a href="#section-6.3-4" class="pilcrow">¶</a></p>
<p id="section-6.3-5">Additionally, Credentials SHOULD specify the signature scheme corresponding to
each contained public key.<a href="#section-6.3-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3-6">
<pre>
// See RFC 8446 and the IANA TLS SignatureScheme registry
uint16 SignatureScheme;

// See IANA registry for registered values
uint16 CredentialType;

struct {
    opaque identity&lt;V&gt;;
    SignatureScheme signature_scheme;
    opaque signature_key&lt;V&gt;;
} BasicCredential;

struct {
    opaque cert_data&lt;V&gt;;
} Certificate;

struct {
    CredentialType credential_type;
    select (Credential.credential_type) {
        case basic:
            BasicCredential;

        case x509:
            Certificate chain&lt;V&gt;;
    };
} Credential;
</pre><a href="#section-6.3-6" class="pilcrow">¶</a>
</div>
<p id="section-6.3-7">A BasicCredential is a raw, unauthenticated assertion of an identity/key
binding. The format of the key in the <code>public_key</code> field is defined by the
relevant ciphersuite: the group ciphersuite for a credential in a leaf node of a
ratchet tree or the KeyPackage ciphersuite for a credential in a KeyPackage
object.  For ciphersuites using Ed25519 or Ed448 signature schemes, the public
key is in the format specified in <span>[<a href="#RFC8032" class="xref">RFC8032</a>]</span>.  For ciphersuites using ECDSA with
the NIST curves P-256 or P-521, the public key is the output of the uncompressed
Elliptic-Curve-Point-to-Octet-String conversion according to <span>[<a href="#SECG" class="xref">SECG</a>]</span>.<a href="#section-6.3-7" class="pilcrow">¶</a></p>
<p id="section-6.3-8">For an X.509 credential, each entry in the chain represents a single DER-encoded
X.509 certificate. The chain is ordered such that the first entry (chain[0])
is the end-entity certificate and each subsequent certificate in the chain
MUST be the issuer of the previous certificate. The algorithm for the
<code>public_key</code> in the end-entity certificate MUST match the relevant
ciphersuite.<a href="#section-6.3-8" class="pilcrow">¶</a></p>
<p id="section-6.3-9">The signatures used in this document are encoded as specified in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.
In particular, ECDSA signatures are DER-encoded and EdDSA signatures are defined
as the concatenation of <code>r</code> and <code>s</code> as specified in <span>[<a href="#RFC8032" class="xref">RFC8032</a>]</span>.<a href="#section-6.3-9" class="pilcrow">¶</a></p>
<p id="section-6.3-10">Each new credential that has not already been validated by the application MUST
be validated against the Authentication Service.  Applications SHOULD require
that a client present the same set of identifiers throughout its presence in
the group, even if its Credential is changed in a Commit or Update.  If an
application allows clients to change identifiers over time, then each time the
client presents a new credential, the application MUST verify that the set
of identifiers in the credential is acceptable to the application for this
client.<a href="#section-6.3-10" class="pilcrow">¶</a></p>
<div id="uniquely-identifying-clients">
<section id="section-6.3.1">
          <h4 id="name-uniquely-identifying-client">
<a href="#section-6.3.1" class="section-number selfRef">6.3.1. </a><a href="#name-uniquely-identifying-client" class="section-name selfRef">Uniquely Identifying Clients</a>
          </h4>
<p id="section-6.3.1-1">MLS implementations will presumably provide applications with a way to request
protocol operations with regard to other clients (e.g., removing clients).  Such
functions will need to refer to the other clients using some identifier.  MLS
clients have a few types of identifiers, with different operational properties.<a href="#section-6.3.1-1" class="pilcrow">¶</a></p>
<p id="section-6.3.1-2">The Credentials presented by the clients in a group authenticate
application-level identifiers for the clients.  These identifiers may not
uniquely identify clients.  For example, if a user has multiple devices that are
all present in an MLS group, then those devices' clients could all present the
user's application-layer identifiers.<a href="#section-6.3.1-2" class="pilcrow">¶</a></p>
<p id="section-6.3.1-3">Internally to the protocol, group members are uniquely identified by their
leaves, expressed as LeafNodeRef objects.  These identifiers are unstable:
They change whenever the member sends a Commit, or whenever an Update
proposal from the member is committed.<a href="#section-6.3.1-3" class="pilcrow">¶</a></p>
<p id="section-6.3.1-4">MLS provides two unique client identifiers that are stable across epochs:<a href="#section-6.3.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.3.1-5.1">The index of a client among the leaves of the tree<a href="#section-6.3.1-5.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-6.3.1-5.2">The <code>epoch_id</code> field in the key package<a href="#section-6.3.1-5.2" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-6.3.1-6">The application may also provide application-specific unique identifiers in the
<code>extensions</code> field of KeyPackage or LeafNode objects.<a href="#section-6.3.1-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="message-framing">
<section id="section-7">
      <h2 id="name-message-framing">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-message-framing" class="section-name selfRef">Message Framing</a>
      </h2>
<p id="section-7-1">Handshake and application messages use a common framing structure.
This framing provides encryption to ensure confidentiality within the
group, as well as signing to authenticate the sender within the group.<a href="#section-7-1" class="pilcrow">¶</a></p>
<p id="section-7-2">The main structure is MLSMessageContent, which contains the content of
the message.  This structure is authenticated using MLSMessageAuth
(see <a href="#content-authentication" class="xref">Section 7.1</a>).
The two structures are combined in MLSMessageContentAuth, which can then be
encoded/decoded from/to MLSPlaintext or MLSCiphertext, which are then included
in the MLSMessage structure.<a href="#section-7-2" class="pilcrow">¶</a></p>
<p id="section-7-3">MLSCiphertext represents a signed and encrypted message, with
protections for both the content of the message and related
metadata.  MLSPlaintext represents a message that is only signed,
and not encrypted.  Applications MUST use MLSCiphertext to encrypt
application messages and SHOULD use MLSCiphertext to encode
handshake messages, but MAY transmit handshake messages encoded
as MLSPlaintext objects in cases where it is necessary for the
Delivery Service to examine such messages.<a href="#section-7-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7-4">
<pre>
enum {
    reserved(0),
    mls10(1),
    (255)
} ProtocolVersion;

enum {
    reserved(0),
    application(1),
    proposal(2),
    commit(3),
    (255)
} ContentType;

enum {
    reserved(0),
    member(1),
    preconfigured(2),
    new_member(3),
    (255)
} SenderType;

struct {
    SenderType sender_type;
    switch (sender_type) {
        case member:
            LeafNodeRef member_ref;
        case preconfigured:
            opaque sender_id&lt;V&gt;;
        case new_member:
            struct{};
    }
} Sender;

enum {
  reserved(0),
  mls_plaintext(1),
  mls_ciphertext(2),
  mls_welcome(3),
  mls_group_info(4),
  mls_key_package(5),
  (255)
} WireFormat;

struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    Sender sender;
    opaque authenticated_data&lt;V&gt;;

    ContentType content_type;
    select (MLSMessageContent.content_type) {
        case application:
          opaque application_data&lt;V&gt;;
        case proposal:
          Proposal proposal;
        case commit:
          Commit commit;
    }
} MLSMessageContent;

struct {
    ProtocolVersion version = mls10;
    WireFormat wire_format;
    select (MLSMessage.wire_format) {
        case mls_plaintext:
            MLSPlaintext plaintext;
        case mls_ciphertext:
            MLSCiphertext ciphertext;
        case mls_welcome:
            Welcome welcome;
        case mls_group_info:
            GroupInfo group_info;
        case mls_key_package:
            KeyPackage key_package;
    }
} MLSMessage;
</pre><a href="#section-7-4" class="pilcrow">¶</a>
</div>
<p id="section-7-5">External sender types are sent as MLSPlaintext, see <a href="#external-proposals" class="xref">Section 13.1.9</a>
for their use.<a href="#section-7-5" class="pilcrow">¶</a></p>
<p id="section-7-6">The following structure is used to fully describe the data transmitted in
plaintexts or ciphertexts.<a href="#section-7-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7-7">
<pre>
struct {
    WireFormat wire_format;
    MLSMessageContent content;
    MLSMessageAuth auth;
} MLSMessageContentAuth;
</pre><a href="#section-7-7" class="pilcrow">¶</a>
</div>
<div id="content-authentication">
<section id="section-7.1">
        <h3 id="name-content-authentication">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-content-authentication" class="section-name selfRef">Content Authentication</a>
        </h3>
<p id="section-7.1-1">MLSMessageContent is authenticated using the MLSMessageAuth structure.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.1-2">
<pre>
struct {
    opaque mac_value&lt;V&gt;;
} MAC;

struct {
    // SignWithLabel(., "MLSMessageContentTBS", MLSMessageContentTBS)
    opaque signature&lt;V&gt;;
    select (MLSMessageContent.content_type) {
        case commit:
            // MAC(confirmation_key, GroupContext.confirmed_transcript_hash)
            MAC confirmation_tag;
        case application:
        case proposal:
            struct{};
    }
} MLSMessageAuth;
</pre><a href="#section-7.1-2" class="pilcrow">¶</a>
</div>
<p id="section-7.1-3">The <code>signature</code> field in an MLSMessageAuth object is computed using the signing
private key corresponding to the public key, which was authenticated by the
credential at the leaf of the tree indicated by the sender field. The signature
is computed using <code>SignWithLabel</code> with label <code>"MLSMessageContentTBS"</code> and with a content
that covers the message content and the wire format that will be used for this message.
If the sender is a member of the group, the content also covers the
GroupContext for the current epoch, so that signatures are specific to a given
group and epoch.<a href="#section-7.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.1-4">
<pre>
struct {
    ProtocolVersion version = mls10;
    WireFormat wire_format;
    MLSMessageContent content;
    select (MLSMessageContentTBS.content.sender.sender_type) {
        case member:
        case new_member:
            GroupContext context;

        case preconfigured:
            struct{};
    }
} MLSMessageContentTBS;
</pre><a href="#section-7.1-4" class="pilcrow">¶</a>
</div>
<p id="section-7.1-5">The confirmation tag value confirms that the members of the group have arrived
at the same state of the group.<a href="#section-7.1-5" class="pilcrow">¶</a></p>
<p id="section-7.1-6">A MLSMessageAuth is said to be valid when both the <code>signature</code> and
<code>confirmation_tag</code> fields are valid.<a href="#section-7.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encoding-and-decoding-a-plaintext">
<section id="section-7.2">
        <h3 id="name-encoding-and-decoding-a-pla">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-encoding-and-decoding-a-pla" class="section-name selfRef">Encoding and Decoding a Plaintext</a>
        </h3>
<p id="section-7.2-1">Plaintexts are encoded using the MLSPlaintext structure.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.2-2">
<pre>
struct {
    MLSMessageContent content;
    MLSMessageAuth auth;
    select(MLSPlaintext.content.sender.sender_type) {
        case member:
            MAC membership_tag;
        case preconfigured:
        case new_member:
            struct{};
    }
} MLSPlaintext;
</pre><a href="#section-7.2-2" class="pilcrow">¶</a>
</div>
<p id="section-7.2-3">The <code>membership_tag</code> field in the MLSPlaintext object authenticates the sender's
membership in the group. For messages sent by members, it MUST be set to the
following value:<a href="#section-7.2-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.2-4">
<pre>
struct {
  MLSMessageContentTBS content_tbs;
  MLSMessageAuth auth;
} MLSMessageContentTBM;

membership_tag = MAC(membership_key, MLSMessageContentTBM);
</pre><a href="#section-7.2-4" class="pilcrow">¶</a>
</div>
<p id="section-7.2-5">When decoding a MLSPlaintext into a MLSMessageContentAuth,
the application MUST check <code>membership_tag</code>, and MUST check that the
MLSMessageAuth is valid.<a href="#section-7.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encoding-and-decoding-a-ciphertext">
<section id="section-7.3">
        <h3 id="name-encoding-and-decoding-a-cip">
<a href="#section-7.3" class="section-number selfRef">7.3. </a><a href="#name-encoding-and-decoding-a-cip" class="section-name selfRef">Encoding and Decoding a Ciphertext</a>
        </h3>
<p id="section-7.3-1">Ciphertexts are encoded using the MLSCiphertext structure.<a href="#section-7.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3-2">
<pre>
struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    ContentType content_type;
    opaque authenticated_data&lt;V&gt;;
    opaque encrypted_sender_data&lt;V&gt;;
    opaque ciphertext&lt;V&gt;;
} MLSCiphertext;
</pre><a href="#section-7.3-2" class="pilcrow">¶</a>
</div>
<p id="section-7.3-3"><code>encrypted_sender_data</code> and <code>ciphertext</code> are encrypted using the AEAD function
specified by the ciphersuite in use, using as input the structures MLSSenderData
and MLSCiphertextContent.<a href="#section-7.3-3" class="pilcrow">¶</a></p>
<div id="content-encryption">
<section id="section-7.3.1">
          <h4 id="name-content-encryption">
<a href="#section-7.3.1" class="section-number selfRef">7.3.1. </a><a href="#name-content-encryption" class="section-name selfRef">Content Encryption</a>
          </h4>
<p id="section-7.3.1-1">The ciphertext content is encoded using the MLSCiphertextContent structure.<a href="#section-7.3.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3.1-2">
<pre>
struct {
    select (MLSCiphertext.content_type) {
        case application:
          opaque application_data&lt;V&gt;;

        case proposal:
          Proposal proposal;

        case commit:
          Commit commit;
    }

    MLSMessageAuth auth;
    opaque padding&lt;V&gt;;
} MLSCiphertextContent;
</pre><a href="#section-7.3.1-2" class="pilcrow">¶</a>
</div>
<p id="section-7.3.1-3">In the MLS key schedule, the sender creates two distinct key ratchets for
handshake and application messages for each member of the group. When encrypting
a message, the sender looks at the ratchets it derived for its own member and
chooses an unused generation from either the handshake or application ratchet
depending on the content type of the message. This generation of the ratchet is
used to derive a provisional nonce and key.<a href="#section-7.3.1-3" class="pilcrow">¶</a></p>
<p id="section-7.3.1-4">Before use in the encryption operation, the nonce is XORed with a fresh random
value to guard against reuse.  Because the key schedule generates nonces
deterministically, a client must keep persistent state as to where in the key
schedule it is; if this persistent state is lost or corrupted, a client might
reuse a generation that has already been used, causing reuse of a key/nonce pair.<a href="#section-7.3.1-4" class="pilcrow">¶</a></p>
<p id="section-7.3.1-5">To avoid this situation, the sender of a message MUST generate a fresh random
4-byte "reuse guard" value and XOR it with the first four bytes of the nonce
from the key schedule before using the nonce for encryption.  The sender MUST
include the reuse guard in the <code>reuse_guard</code> field of the sender data object, so
that the recipient of the message can use it to compute the nonce to be used for
decryption.<a href="#section-7.3.1-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3.1-6">
<pre>
+-+-+-+-+---------...---+
|   Key Schedule Nonce  |
+-+-+-+-+---------...---+
           XOR
+-+-+-+-+---------...---+
| Guard |       0       |
+-+-+-+-+---------...---+
           ===
+-+-+-+-+---------...---+
| Encrypt/Decrypt Nonce |
+-+-+-+-+---------...---+
</pre><a href="#section-7.3.1-6" class="pilcrow">¶</a>
</div>
<p id="section-7.3.1-7">The Additional Authenticated Data (AAD) input to the encryption
contains an object of the following form, with the values used to
identify the key and nonce:<a href="#section-7.3.1-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3.1-8">
<pre>
struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    ContentType content_type;
    opaque authenticated_data&lt;V&gt;;
} MLSCiphertextContentAAD;
</pre><a href="#section-7.3.1-8" class="pilcrow">¶</a>
</div>
<p id="section-7.3.1-9">When decoding a MLSCiphertextContent, the application MUST check that the
MLSMessageAuth is valid.<a href="#section-7.3.1-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sender-data-encryption">
<section id="section-7.3.2">
          <h4 id="name-sender-data-encryption">
<a href="#section-7.3.2" class="section-number selfRef">7.3.2. </a><a href="#name-sender-data-encryption" class="section-name selfRef">Sender Data Encryption</a>
          </h4>
<p id="section-7.3.2-1">The "sender data" used to look up the key for the content encryption is
encrypted with the ciphersuite's AEAD with a key and nonce derived from both the
<code>sender_data_secret</code> and a sample of the encrypted content. Before being
encrypted, the sender data is encoded as an object of the following form:<a href="#section-7.3.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3.2-2">
<pre>
struct {
    LeafNodeRef sender;
    uint32 generation;
    opaque reuse_guard[4];
} MLSSenderData;
</pre><a href="#section-7.3.2-2" class="pilcrow">¶</a>
</div>
<p id="section-7.3.2-3">MLSSenderData.sender is assumed to be a <code>member</code> sender type.  When constructing
an MLSSenderData from a Sender object, the sender MUST verify Sender.sender_type
is <code>member</code> and use Sender.sender for MLSSenderData.sender.<a href="#section-7.3.2-3" class="pilcrow">¶</a></p>
<p id="section-7.3.2-4">The <code>reuse_guard</code> field contains a fresh random value used to avoid nonce reuse
in the case of state loss or corruption, as described in <a href="#content-encryption" class="xref">Section 7.3.1</a>.<a href="#section-7.3.2-4" class="pilcrow">¶</a></p>
<p id="section-7.3.2-5">The key and nonce provided to the AEAD are computed as the KDF of the first
<code>KDF.Nh</code> bytes of the ciphertext generated in the previous section. If the
length of the ciphertext is less than <code>KDF.Nh</code>, the whole ciphertext is used
without padding. In pseudocode, the key and nonce are derived as:<a href="#section-7.3.2-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3.2-6">
<pre>
ciphertext_sample = ciphertext[0..KDF.Nh-1]

sender_data_key = ExpandWithLabel(sender_data_secret, "key",
                      ciphertext_sample, AEAD.Nk)
sender_data_nonce = ExpandWithLabel(sender_data_secret, "nonce",
                      ciphertext_sample, AEAD.Nn)
</pre><a href="#section-7.3.2-6" class="pilcrow">¶</a>
</div>
<p id="section-7.3.2-7">The Additional Authenticated Data (AAD) for the SenderData ciphertext is the
first three fields of MLSCiphertext:<a href="#section-7.3.2-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.3.2-8">
<pre>
struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    ContentType content_type;
} MLSSenderDataAAD;
</pre><a href="#section-7.3.2-8" class="pilcrow">¶</a>
</div>
<p id="section-7.3.2-9">When parsing a SenderData struct as part of message decryption, the recipient
MUST verify that the LeafNodeRef indicated in the <code>sender</code> field identifies a
member of the group.<a href="#section-7.3.2-9" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="ratchet-tree-operations">
<section id="section-8">
      <h2 id="name-ratchet-tree-operations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-ratchet-tree-operations" class="section-name selfRef">Ratchet Tree Operations</a>
      </h2>
<p id="section-8-1">The ratchet tree for an epoch describes the membership of a group in that epoch,
providing public-key encryption (HPKE) keys that can be used to encrypt to subsets of
the group as well as information to authenticate the members.  In order to
reflect changes to the membership of the group from one epoch to the next,
corresponding changes are made to the ratchet tree.  In this section, we
describe the content of the tree and the required operations.<a href="#section-8-1" class="pilcrow">¶</a></p>
<div id="parent-node-contents">
<section id="section-8.1">
        <h3 id="name-parent-node-contents">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-parent-node-contents" class="section-name selfRef">Parent Node Contents</a>
        </h3>
<p id="section-8.1-1">As discussed in <a href="#ratchet-tree-nodes" class="xref">Section 5.3</a>, the nodes of a ratchet tree contain
several types of data describing individual members (for leaf nodes) or
subgroups of the group (for parent nodes).  Parent nodes are simpler:<a href="#section-8.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.1-2">
<pre>
struct {
    HPKEPublicKey public_key;
    opaque parent_hash&lt;V&gt;;
    uint32 unmerged_leaves&lt;V&gt;;
} ParentNode;
</pre><a href="#section-8.1-2" class="pilcrow">¶</a>
</div>
<p id="section-8.1-3">The <code>public_key</code> field contains an HPKE public key whose private key is held only
by the members at the leaves among its descendants.  The <code>parent_hash</code> field
contains a hash of this node's parent node, as described in <a href="#parent-hash" class="xref">Section 8.8</a>.
The <code>unmerged_leaves</code> field lists the leaves under this parent node that are
unmerged, according to their indices among all the leaves in the tree.<a href="#section-8.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="leaf-node-contents">
<section id="section-8.2">
        <h3 id="name-leaf-node-contents">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-leaf-node-contents" class="section-name selfRef">Leaf Node Contents</a>
        </h3>
<p id="section-8.2-1">A leaf node in the tree describes all the details of an individual client's
appearance in the group, signed by that client. It is also used in client
KeyPackage objects to store the information that will be needed to add a
client to a group.<a href="#section-8.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.2-2">
<pre>
enum {
    reserved(0),
    key_package(1),
    update(2),
    commit(3),
    (255)
} LeafNodeSource;

struct {
    ProtocolVersion versions&lt;V&gt;;
    CipherSuite ciphersuites&lt;V&gt;;
    ExtensionType extensions&lt;V&gt;;
    ProposalType proposals&lt;V&gt;;
} Capabilities;

struct {
    uint64 not_before;
    uint64 not_after;
} Lifetime;

// See IANA registry for registered values
uint16 ExtensionType;

struct {
    ExtensionType extension_type;
    opaque extension_data&lt;V&gt;;
} Extension;

struct {
    HPKEPublicKey public_key;
    Credential credential;
    Capabilities capabilities;

    LeafNodeSource leaf_node_source;
    select (leaf_node_source) {
        case add:
            Lifetime lifetime;

        case update:
            struct {}

        case commit:
            opaque parent_hash&lt;V&gt;;
    }

    Extension extensions&lt;V&gt;;
    // SignWithLabel(., "LeafNodeTBS", LeafNodeTBS)
    opaque signature&lt;V&gt;;
} LeafNode;

struct {
    HPKEPublicKey public_key;
    Credential credential;
    Capabilities capabilities;

    LeafNodeSource leaf_node_source;
    select (leaf_node_source) {
        case key_package:
            Lifetime lifetime;

        case update:
            struct{};

        case commit:
            opaque parent_hash&lt;V&gt;;
    }

    Extension extensions&lt;V&gt;;

    select (leaf_node_source) {
        case key_package:
            struct{};

        case update:
            opaque group_id&lt;V&gt;;

        case commit:
            opaque group_id&lt;V&gt;;
    }
} LeafNodeTBS;
</pre><a href="#section-8.2-2" class="pilcrow">¶</a>
</div>
<p id="section-8.2-3">The <code>public_key</code> field conains an HPKE public key whose private key is held only
by the member occupying this leaf (or in the case of a LeafNode in a KeyPackage
object, the issuer of the KeyPackage).  The <code>credential</code> contains authentication
information for this member, as described in <a href="#credentials" class="xref">Section 6.3</a>.<a href="#section-8.2-3" class="pilcrow">¶</a></p>
<p id="section-8.2-4">The <code>capabilities</code> field indicates what protocol versions, ciphersuites,
protocol extensions, and non-default proposal types are supported by a client.
Proposal types defined in this document are considered "default" and thus need
not be listed.  Extensions that appear in the <code>extensions</code> field of a LeafNode
MUST be included in the <code>extensions</code> field of the <code>capabilities</code> field.<a href="#section-8.2-4" class="pilcrow">¶</a></p>
<p id="section-8.2-5">The <code>leaf_node_source</code> field indicates how this LeafNode came to be added to the
tree.  This signal tells other members of the group whether the leaf node is
required to have a <code>lifetime</code> or <code>parent_hash</code>, and whether the <code>group_id</code> is
added as context to the signature.  Whether these fields can be computed by the
client represented by the LeafNode depends on when the LeafNode was created.
For example, a KeyPackage is created before the client knows which group it will
be used with, so its signature can't bind to a <code>group_id</code>.<a href="#section-8.2-5" class="pilcrow">¶</a></p>
<p id="section-8.2-6">In the case where the leaf was added to the tree based on a pre-published
KeyPackage, the <code>lifetime</code> field represents the times between which clients will
consider a LeafNode valid.  These times are represented as absolute times,
measured in seconds since the Unix epoch (1970-01-01T00:00:00Z).  Applications
MUST define a maximum total lifetime that is acceptable for a LeafNode, and
reject any LeafNode where the total lifetime is longer than this duration.<a href="#section-8.2-6" class="pilcrow">¶</a></p>
<p id="section-8.2-7">In the case where the leaf node was inserted into the tree via a Commit message,
the <code>parent_hash</code> field contains the parent hash for this leaf node (see
<a href="#parent-hash" class="xref">Section 8.8</a>).<a href="#section-8.2-7" class="pilcrow">¶</a></p>
<p id="section-8.2-8">The LeafNodeTBS structure covers the fields above the signature in the LeafNode.
In addition, when the leaf node was created in the context of a group (the
update and commit cases), the group ID of the group is added as context to the
signature.<a href="#section-8.2-8" class="pilcrow">¶</a></p>
<p id="section-8.2-9">LeafNode objects stored in the group's ratchet tree
are updated according to the evolution of the tree. Each modification of
LeafNode content MUST be reflected by a change in its signature. This allows other
members to verify the validity of the LeafNode at any time, particularly in the
case of a newcomer joining the group.<a href="#section-8.2-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="leaf-node-validation">
<section id="section-8.3">
        <h3 id="name-leaf-node-validation">
<a href="#section-8.3" class="section-number selfRef">8.3. </a><a href="#name-leaf-node-validation" class="section-name selfRef">Leaf Node Validation</a>
        </h3>
<p id="section-8.3-1">The validity of a LeafNode needs to be verified at a few stages:<a href="#section-8.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.3-2.1">When a LeafNode is downloaded in a KeyPackage, before it is used
to add the client to the group<a href="#section-8.3-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.3-2.2">When a LeafNode is received by a group member in an Add, Update, or Commit
message<a href="#section-8.3-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.3-2.3">When a client joining a group receives LeafNode objects for the other members
of the group in the group's ratchet tree<a href="#section-8.3-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-8.3-3">The client verifies the validity of a LeafNode using the following steps:<a href="#section-8.3-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.3-4.1">Verify that the credential in the LeafNode is valid according to the
authentication service and the client's local policy. These actions MUST be
the same regardless of at what point in the protocol the LeafNode is being
verified with the following exception: If the LeafNode is an update to
another LeafNode, the authentication service MUST additionally validate that
the set of identities attested by the credential in the new LeafNode is
acceptable relative to the identities attested by the old credential.<a href="#section-8.3-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.3-4.2">Verify that the signature on the LeafNode is valid using the public key
in the LeafNode's credential<a href="#section-8.3-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.3-4.3">Verify that the LeafNode is compatible with the group's parameters.  If the
GroupContext has a <code>required_capabilities</code> extension, then the required
extensions and proposals MUST be listed in the LeafNode's <code>capabilities</code>
field.<a href="#section-8.3-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.3-4.4">
            <p id="section-8.3-4.4.1">Verify the <code>lifetime</code> field:<a href="#section-8.3-4.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.3-4.4.2.1">When validating a LeafNode in a KeyPackage before sending an Add proposal,
the current time MUST be within the <code>lifetime</code> range.  A KeyPackage
containing a LeafNode that is expired or not yet valid MUST NOT be sent in
an Add proposal.<a href="#section-8.3-4.4.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-8.3-4.4.2.2">When receiving an Add or validating a tree, checking the <code>lifetime</code> is
RECOMMENDED, if it is feasible in a given application context.  Because of
the asynchronous nature of MLS, the <code>lifetime</code> may have been valid when the
leaf node was proposed for addition, even if it is expired at these later
points in the protocol.<a href="#section-8.3-4.4.2.2" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-8.3-4.5">Verify that the <code>leaf_node_source</code> field has the appropriate value for the
context in which the LeafNode is being validated (as defined in
<a href="#leaf-node-contents" class="xref">Section 8.2</a>).<a href="#section-8.3-4.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.3-4.6">
            <p id="section-8.3-4.6.1">Verify that the following fields in the LeafNode are unique among the
members of the group (including any other members added in the same
Commit):<a href="#section-8.3-4.6.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.3-4.6.2.1">
                <code>public_key</code><a href="#section-8.3-4.6.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-8.3-4.6.2.2">
                <code>credential.signature_key</code><a href="#section-8.3-4.6.2.2" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-8.3-4.7">Verify that the extensions in the leaf node are supported.  The ID for each
extension in the <code>extensions</code> field MUST be listed in the field
<code>capabilities.extensions</code> of the LeafNode.<a href="#section-8.3-4.7" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="ratchet-tree-evolution">
<section id="section-8.4">
        <h3 id="name-ratchet-tree-evolution">
<a href="#section-8.4" class="section-number selfRef">8.4. </a><a href="#name-ratchet-tree-evolution" class="section-name selfRef">Ratchet Tree Evolution</a>
        </h3>
<p id="section-8.4-1">In order to provide forward secrecy and post-compromise security, whenever a
member initiates an epoch change (i.e., commits; see <a href="#commit" class="xref">Section 13.2</a>), they refresh
the key pairs of their leaf and of all nodes on their leaf's direct path (all
nodes for which they know the secret key).<a href="#section-8.4-1" class="pilcrow">¶</a></p>
<p id="section-8.4-2">The member initiating the epoch change generates the fresh key pairs using the
following procedure. The procedure is designed in a way that allows group members to
efficiently communicate the fresh secret keys to other group members, as
described in <a href="#update-paths" class="xref">Section 8.9</a>.<a href="#section-8.4-2" class="pilcrow">¶</a></p>
<p id="section-8.4-3">Recall the definition of resolution from <a href="#ratchet-tree-nodes" class="xref">Section 5.3</a>.
To begin with, the generator of the UpdatePath updates its leaf and its leaf's
<em>filtered direct path</em> with new key pairs. The filtered direct path of a node
is obtained from the node's direct path by removing all nodes whose child on
the nodes's copath has an empty resolution (any unmerged leaves of the copath
child count towards its resolution). Such a removed node does not need a key
pair, since after blanking it, its resolution consists of a single node on the
filtered direct path. Using the key pair of the node in the resolution is
equivalent to using the key pair of the removed node.<a href="#section-8.4-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.4-4.1">Blank all the nodes on the direct path from the leaf to the root.<a href="#section-8.4-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.4-4.2">Generate a fresh HPKE key pair for the leaf.<a href="#section-8.4-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.4-4.3">
            <p id="section-8.4-4.3.1">Generate a sequence of path secrets, one for each node on the leaf's filtered direct
path, as follows. In this setting, <code>path_secret[0]</code> refers to the first parent node
in the filtered direct path, <code>path_secret[1]</code> to the second parent node, and so on.<a href="#section-8.4-4.3.1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.4-4.3.2">
<pre>
path_secret[0] is sampled at random
path_secret[n] = DeriveSecret(path_secret[n-1], "path")
</pre><a href="#section-8.4-4.3.2" class="pilcrow">¶</a>
</div>
</li>
          <li class="normal" id="section-8.4-4.4">
            <p id="section-8.4-4.4.1">Compute the sequence of HPKE key pairs <code>(node_priv,node_pub)</code>, one for each
node on the leaf's direct path, as follows.<a href="#section-8.4-4.4.1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.4-4.4.2">
<pre>
node_secret[n] = DeriveSecret(path_secret[n], "node")
node_priv[n], node_pub[n] = KEM.DeriveKeyPair(node_secret[n])
</pre><a href="#section-8.4-4.4.2" class="pilcrow">¶</a>
</div>
</li>
        </ul>
<p id="section-8.4-5">The node secret is derived as a temporary intermediate secret so that each
secret is only used with one algorithm: The path secret is used as an input to
DeriveSecret and the node secret is used as an input to DeriveKeyPair.<a href="#section-8.4-5" class="pilcrow">¶</a></p>
<p id="section-8.4-6">For example, suppose there is a group with four members, with C an unmerged leaf
at Z:<a href="#section-8.4-6" class="pilcrow">¶</a></p>
<span id="name-a-full-tree-with-one-unmerg"></span><div id="evolution-tree">
<figure id="figure-11">
          <div class="alignLeft art-text artwork" id="section-8.4-7.1">
<pre>
      Y
    __|__
   /     \
  X       Z[C]
 / \     / \
A   B   C   D

0   1   2   3
</pre>
</div>
<figcaption><a href="#figure-11" class="selfRef">Figure 11</a>:
<a href="#name-a-full-tree-with-one-unmerg" class="selfRef">A full tree with one unmerged leaf</a>
          </figcaption></figure>
</div>
<p id="section-8.4-8">If member B subsequently generates an UpdatePath based on a secret
"leaf_secret", then it would generate the following sequence
of path secrets:<a href="#section-8.4-8" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.4-9">
<pre>
path_secret[1] --&gt; node_secret[1] --&gt; node_priv[1], node_pub[1]
     ^
     |
path_secret[0] --&gt; node_secret[0] --&gt; node_priv[0], node_pub[0]
     ^
     |
leaf_secret    --&gt; leaf_node_secret --&gt; leaf_priv, leaf_pub
                                     ~&gt; leaf_node
</pre><a href="#section-8.4-9" class="pilcrow">¶</a>
</div>
<p id="section-8.4-10">After applying the UpdatePath, the tree will have the following structure, where
<code>lp</code> and <code>np[i]</code> represent the leaf_priv and node_priv values generated as
described above:<a href="#section-8.4-10" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.4-11">
<pre>
    np[1] -&gt; Y'
           __|__
          /     \
np[0] -&gt; X'      Z[C]
        / \     / \
       A   B   C   D
           ^
           |
           lp

       0   1   2   3
</pre><a href="#section-8.4-11" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="adding-and-removing-leaves">
<section id="section-8.5">
        <h3 id="name-adding-and-removing-leaves">
<a href="#section-8.5" class="section-number selfRef">8.5. </a><a href="#name-adding-and-removing-leaves" class="section-name selfRef">Adding and Removing Leaves</a>
        </h3>
<p id="section-8.5-1">In addition to the path-based updates to the tree described above, it is also
necessary to add and remove leaves of the tree in order to reflect changes to the
membership of the group (see <a href="#add" class="xref">Section 13.1.1</a> and <a href="#remove" class="xref">Section 13.1.3</a>).  Leaves are always added and removed at the
right edge of the tree: Either a new rightmost leaf is added, or the rightmost
leaf is removed.  Nodes' parent/child node relationships are then updated to
maintain the tree's left-balanced structure.  These operations are also known as
<em>extending</em> and <em>truncating</em> the tree.<a href="#section-8.5-1" class="pilcrow">¶</a></p>
<p id="section-8.5-2">To add a new leaf: Add leaf L as the new rightmost leaf of the tree.  Add
a blank parent node P whose right child is L.  P is attached to the
tree as the right child of the only appropriate node to make the updated tree
left-balanced (or set it as a new root).  The former right child of P's
parent becomes P's left child (or the old root becomes P's left child if
P is the new root).<a href="#section-8.5-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.5-3">
<pre>
                   _ &lt;-- new parent              _
                 __|_                          __|__
                /    \                        /     \
  X    ===&gt;    X     |               ===&gt;    X       _ &lt;-- new parent
 / \          / \    |                      / \     / \
A   B        A   B   C &lt;-- new leaf        A   B   C   D &lt;-- new leaf
</pre><a href="#section-8.5-3" class="pilcrow">¶</a>
</div>
<p id="section-8.5-4">To remove the rightmost leaf: Remove the rightmost leaf node L and its parent
node P.  If P was the root of the tree, P's left child
is now the root of the tree.  Otherwise, set the right child of P's parent
to be P's left child.<a href="#section-8.5-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.5-5">
<pre>
      Y                                    Y
    __|__                                __|_
   /     \                              /    \
  X       Z &lt;-- remove parent  ===&gt;    X     | &lt;-- reassign child
 / \     / \                          / \    |
A   B   C   D &lt;-- remove leaf        A   B   C


      Y &lt;-- remove parent
    __|_
   /    \
  X     |                  ===&gt;    X &lt;-- reassign root
 / \    |                         / \
A   B   C &lt;-- remove leaf        A   B
</pre><a href="#section-8.5-5" class="pilcrow">¶</a>
</div>
<p id="section-8.5-6">Note that in the rest of the protocol, the rightmost leaf will only be removed when it is blank.<a href="#section-8.5-6" class="pilcrow">¶</a></p>
<p id="section-8.5-7">Concrete algorithms for these operations on array-based and link-based trees are
provided in <a href="#array-based-trees" class="xref">Appendix B</a> and <a href="#link-based-trees" class="xref">Appendix C</a>.  The concrete
algorithms are non-normative.  An implementation MAY use any algorithm that
produces the correct tree in its internal representation.<a href="#section-8.5-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="synchronizing-views-of-the-tree">
<section id="section-8.6">
        <h3 id="name-synchronizing-views-of-the-">
<a href="#section-8.6" class="section-number selfRef">8.6. </a><a href="#name-synchronizing-views-of-the-" class="section-name selfRef">Synchronizing Views of the Tree</a>
        </h3>
<p id="section-8.6-1">After generating fresh key material and applying it to ratchet forward their
local tree state as described in the <a href="#ratchet-tree-evolution" class="xref">Section 8.4</a>, the
generator must broadcast
this update to other members of the group in a Commit message, who
apply it to keep their local views of the tree in
sync with the sender's.  More specifically, when a member commits a change to
the tree (e.g., to add or remove a member), it transmits an UpdatePath
containing a set of public keys and encrypted path secrets
for intermediate nodes in the filtered direct path of its leaf. The
other members of the group use these values to update
their view of the tree, aligning their copy of the tree to the
sender's.<a href="#section-8.6-1" class="pilcrow">¶</a></p>
<p id="section-8.6-2">An UpdatePath contains
the following information for each node in the filtered direct path of the
sender's leaf, including the root:<a href="#section-8.6-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.6-3.1">The public key for the node<a href="#section-8.6-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.6-3.2">Zero or more encrypted copies of the path secret corresponding to
the node<a href="#section-8.6-3.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-8.6-4">The path secret value for a given node is encrypted for the subtree
corresponding to the parent's non-updated child, that is, the child
on the copath of the sender's leaf node.
There is one encryption of the path secret to each public key in the resolution
of the non-updated child.<a href="#section-8.6-4" class="pilcrow">¶</a></p>
<p id="section-8.6-5">The recipient of an UpdatePath processes it with the following steps:<a href="#section-8.6-5" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.6-6">
<li id="section-8.6-6.1">
            <p id="section-8.6-6.1.1">Compute the updated path secrets.<a href="#section-8.6-6.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.6-6.1.2.1">Identify a node in the filtered direct path for which the recipient
is in the subtree of the non-updated child.<a href="#section-8.6-6.1.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-8.6-6.1.2.2">Identify a node in the resolution of the copath node for
which the recipient has a private key.<a href="#section-8.6-6.1.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-8.6-6.1.2.3">Decrypt the path secret for the parent of the copath node using
the private key from the resolution node.<a href="#section-8.6-6.1.2.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-8.6-6.1.2.4">Derive path secrets for ancestors of that node using the
algorithm described above.<a href="#section-8.6-6.1.2.4" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-8.6-6.1.2.5">The recipient SHOULD verify that the received public keys agree
with the public keys derived from the new path_secret values.<a href="#section-8.6-6.1.2.5" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li id="section-8.6-6.2">
            <p id="section-8.6-6.2.1">Merge the updated path secrets into the tree.<a href="#section-8.6-6.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.6-6.2.2.1">Blank all nodes on the direct path of the sender's leaf.<a href="#section-8.6-6.2.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-8.6-6.2.2.2">
                <p id="section-8.6-6.2.2.2.1">For all nodes on the filtered direct path of the sender's leaf,<a href="#section-8.6-6.2.2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.6-6.2.2.2.2.1">Set the public key to the received public key.<a href="#section-8.6-6.2.2.2.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-8.6-6.2.2.2.2.2">Set the list of unmerged leaves to the empty list.<a href="#section-8.6-6.2.2.2.2.2" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-8.6-6.2.2.2.2.3">Store the updated hash of the next node on the filtered direct path
(represented as a ParentNode struct), going from root to leaf, so that
each hash incorporates all the non-blank nodes above it. The root node
always has a zero-length hash for this value.<a href="#section-8.6-6.2.2.2.2.3" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-8.6-6.2.2.3">For nodes where a path secret was recovered in step 1 ("Compute the
updated path secrets"), compute and store the node's updated private key.<a href="#section-8.6-6.2.2.3" class="pilcrow">¶</a>
</li>
            </ul>
</li>
        </ol>
<p id="section-8.6-7">For example, in order to communicate the example update described in
the previous section, the sender would transmit the following
values:<a href="#section-8.6-7" class="pilcrow">¶</a></p>
<table class="center" id="table-2">
          <caption><a href="#table-2" class="selfRef">Table 2</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Public Key</th>
              <th class="text-left" rowspan="1" colspan="1">Ciphertext(s)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">node_pub[1]</td>
              <td class="text-left" rowspan="1" colspan="1">E(pk(Z), path_secret[1]), E(pk(C), path_secret[1])</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">node_pub[0]</td>
              <td class="text-left" rowspan="1" colspan="1">E(pk(A), path_secret[0])</td>
            </tr>
          </tbody>
        </table>
<p id="section-8.6-9">In this table, the value node_pub[i] represents the public key
derived from node_secret[i], pk(X) represents the current public key
of node X, and E(K, S) represents
the public-key encryption of the path secret S to the
public key K (using HPKE).<a href="#section-8.6-9" class="pilcrow">¶</a></p>
<p id="section-8.6-10">After processing the update, each recipient MUST delete outdated key material,
specifically:<a href="#section-8.6-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.6-11.1">The path secrets used to derive each updated node key pair.<a href="#section-8.6-11.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.6-11.2">Each outdated node key pair that was replaced by the update.<a href="#section-8.6-11.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="tree-hashes">
<section id="section-8.7">
        <h3 id="name-tree-hashes">
<a href="#section-8.7" class="section-number selfRef">8.7. </a><a href="#name-tree-hashes" class="section-name selfRef">Tree Hashes</a>
        </h3>
<p id="section-8.7-1">To allow group members to verify that they agree on the public cryptographic state
of the group, this section defines a scheme for generating a hash value (called
the "tree hash") that represents the contents of the group's ratchet tree and the
members' leaf nodes. The tree hash of a tree is the tree hash of its root node,
which we define recursively, starting with the leaves.<a href="#section-8.7-1" class="pilcrow">¶</a></p>
<p id="section-8.7-2">The tree hash of a leaf node is the hash of leaf's <code>LeafNodeHashInput</code> object which
might include a <code>LeafNode</code> object depending on whether or not it is blank.<a href="#section-8.7-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.7-3">
<pre>
struct {
    uint32 leaf_index;
    optional&lt;LeafNode&gt; leaf_node;
} LeafNodeHashInput;
</pre><a href="#section-8.7-3" class="pilcrow">¶</a>
</div>
<p id="section-8.7-4">Now the tree hash of any non-leaf node is recursively defined to be the hash of
its <code>ParentNodeHashInput</code>. This includes an optional <code>ParentNode</code>
object depending on whether the node is blank or not.<a href="#section-8.7-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.7-5">
<pre>
struct {
    optional&lt;ParentNode&gt; parent_node;
    opaque left_hash&lt;V&gt;;
    opaque right_hash&lt;V&gt;;
} ParentNodeHashInput;
</pre><a href="#section-8.7-5" class="pilcrow">¶</a>
</div>
<p id="section-8.7-6">The <code>left_hash</code> and <code>right_hash</code> fields hold the tree hashes of the node's
left and right children, respectively.<a href="#section-8.7-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="parent-hash">
<section id="section-8.8">
        <h3 id="name-parent-hash">
<a href="#section-8.8" class="section-number selfRef">8.8. </a><a href="#name-parent-hash" class="section-name selfRef">Parent Hash</a>
        </h3>
<p id="section-8.8-1">The <code>parent_hash</code> field in ratchet tree nodes carries information to
authenticate the information in the ratchet tree.  Parent hashes chain together
so that the signature on a leaf node, by covering the leaf node's parent hash,
indirectly includes information about the structure of the tree at the time the
leaf node was last updated.<a href="#section-8.8-1" class="pilcrow">¶</a></p>
<p id="section-8.8-2">Consider a ratchet tree with a non-blank parent node P and children V and S.<a href="#section-8.8-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.8-3">
<pre>
        ...
        /
       P
     __|__
    /     \
   V       S
  / \     / \
... ... ... ...
</pre><a href="#section-8.8-3" class="pilcrow">¶</a>
</div>
<p id="section-8.8-4">The parent hash of P changes whenever an <code>UpdatePath</code> object is applied to
the ratchet tree along a path from a leaf U traversing node V (and hence also
P). The new "Parent hash of P (with copath child S)" is obtained by hashing P's
<code>ParentHashInput</code> struct.<a href="#section-8.8-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.8-5">
<pre>
struct {
    HPKEPublicKey public_key;
    opaque parent_hash&lt;V&gt;;
    opaque original_sibling_tree_hash&lt;V&gt;;
} ParentHashInput;
</pre><a href="#section-8.8-5" class="pilcrow">¶</a>
</div>
<p id="section-8.8-6">The field <code>public_key</code> contains the HPKE public key of P. If P is the root,
then the <code>parent_hash</code> field is set to a zero-length octet string. Otherwise,
<code>parent_hash</code> is the Parent Hash of the next node after P on the filtered
direct path of U. This way, P's Parent Hash fixes
the new HPKE public key of each node V on the path from P to the root. Note
that the path from P to the root may contain some blank nodes that are not
fixed by P's Parent Hash. However, for each node that has an HPKE key, this key
is fixed by P's Parent Hash.<a href="#section-8.8-6" class="pilcrow">¶</a></p>
<p id="section-8.8-7">Finally, <code>original_sibling_tree_hash</code> is the original tree hash of S. The
original tree hash corresponds to the tree hash of S the last time P was
updated. It can be computed as the tree hash of S in the ratchet tree modified
the following way:<a href="#section-8.8-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.8-8.1">reset the leaves in P.unmerged_leaves to blanks<a href="#section-8.8-8.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.8-8.2">remove P.unmerged_leaves from all unmerged_leaves lists<a href="#section-8.8-8.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-8.8-8.3">truncate the ratchet tree as described in <a href="#remove" class="xref">Section 13.1.3</a><a href="#section-8.8-8.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-8.8-9">For example, in the following tree:<a href="#section-8.8-9" class="pilcrow">¶</a></p>
<span id="name-a-full-tree-unmerged-leaves"></span><div id="parent-hash-tree">
<figure id="figure-12">
          <div class="alignLeft art-text artwork" id="section-8.8-10.1">
<pre>
              W [D, H]
        ______|_____
       /             \
      U [D]           Y [F, H]
    __|__           __|__
   /     \         /     \
  T       _       X [F]   _
 / \     / \     / \     / \
A   B   C   D   E   F   G   H
</pre>
</div>
<figcaption><a href="#figure-12" class="selfRef">Figure 12</a>:
<a href="#name-a-full-tree-unmerged-leaves" class="selfRef">A full tree unmerged leaves that illustrate parent hash computations</a>
          </figcaption></figure>
</div>
<p id="section-8.8-11">With P = W and S = Y, <code>original_sibling_tree_hash</code> is the tree hash of the
following tree:<a href="#section-8.8-11" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.8-12">
<pre>
      Y [F]
    __|__
   /     \
  X [F]  |
 / \     |
E   F    G
</pre><a href="#section-8.8-12" class="pilcrow">¶</a>
</div>
<p id="section-8.8-13">Because <code>W.unmerged_leaves = [H]</code>, H is removed from <code>Y.unmerged_leaves</code>,
then H is replaced with a blank leaf, then the tree is truncated removing the
last two nodes.<a href="#section-8.8-13" class="pilcrow">¶</a></p>
<p id="section-8.8-14">With P = W and S = U, <code>original_sibling_tree_hash</code> is the tree hash of the
following tree:<a href="#section-8.8-14" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.8-15">
<pre>
      U
    __|__
   /     \
  T       _
 / \     / \
A   B   C   _
</pre><a href="#section-8.8-15" class="pilcrow">¶</a>
</div>
<p id="section-8.8-16">This time we have 4 leaf nodes because the truncation of the ratchet tree didn't
remove the last leaf.<a href="#section-8.8-16" class="pilcrow">¶</a></p>
<p id="section-8.8-17">Note that no recomputation is needed if the tree hash of S is unchanged since
the last time P was updated.  This is the case for computing or processing a
Commit whose UpdatePath traverses P, since the Commit itself resets P.  (In
other words, it is only necessary to recompute the original sibling tree hash
when validating group's tree on joining.) More generally, if none of the entries
in <code>P.unmerged_leaves</code> is in the subtree under S (and thus no nodes were truncated),
then the original tree hash at S is the tree hash of S in the current tree.<a href="#section-8.8-17" class="pilcrow">¶</a></p>
<p id="section-8.8-18">If it is necessary to recompute the original tree hash of a node, the efficiency
of recomputation can be improved by caching intermediate tree hashes, to avoid
recomputing over the subtree when the subtree is included in multiple parent
hashes.  A subtree hash can be reused as long as the intersection of the
parent's unmerged leaves with the subtree is the same as in the earlier
computation.<a href="#section-8.8-18" class="pilcrow">¶</a></p>
<p id="section-8.8-19">Observe that <code>original_child_resolution</code> is equal to the resolution of S at the
time the <code>UpdatePath</code> was generated, since at that point P's set of unmerged
leaves was emptied. (Observe also that <code>original_child_resolution</code> contains all
unmerged leaves of S.) Therefore, P's Parent Hash fixes, for each node V on the
path from P to the root, not only the HPKE public key of V, but also the set of
HPKE public keys to which the corresponding HPKE secret key of V was encrypted by
the generator of the <code>UpdatePath</code>.<a href="#section-8.8-19" class="pilcrow">¶</a></p>
<div id="using-parent-hashes">
<section id="section-8.8.1">
          <h4 id="name-using-parent-hashes">
<a href="#section-8.8.1" class="section-number selfRef">8.8.1. </a><a href="#name-using-parent-hashes" class="section-name selfRef">Using Parent Hashes</a>
          </h4>
<p id="section-8.8.1-1">The Parent Hash of P appears in three types of structs. If V is itself a parent node
then P's Parent Hash is stored in the <code>parent_hash</code> field of the structs
<code>ParentHashInput</code> and <code>ParentNode</code> of the node before P on the filtered direct
path of U. (The <code>ParentNode</code> struct is used to encapsulate all public
information about that node that must be conveyed to a new
member joining the group as well as to define its Tree Hash.)<a href="#section-8.8.1-1" class="pilcrow">¶</a></p>
<p id="section-8.8.1-2">If, on the other hand, V is the leaf U and its LeafNode has <code>leaf_node_source</code> set to <code>commit</code>,
then the Parent Hash of P (with V's sibling as copath child) is stored in
the <code>parent_hash</code> field.  This is true in particular of the LeafNode object sent
in the <code>leaf_node</code> field of an UpdatePath. The signature of such a LeafNode thus also
attests to which keys the group member introduced into the ratchet tree and
to whom the corresponding secret keys were sent. This helps prevent malicious insiders
from constructing artificial ratchet trees with a node V whose HPKE secret key is
known to the insider yet where the insider isn't assigned a leaf in the subtree rooted
at V. Indeed, such a ratchet tree would violate the tree invariant.<a href="#section-8.8.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="verifying-parent-hashes">
<section id="section-8.8.2">
          <h4 id="name-verifying-parent-hashes">
<a href="#section-8.8.2" class="section-number selfRef">8.8.2. </a><a href="#name-verifying-parent-hashes" class="section-name selfRef">Verifying Parent Hashes</a>
          </h4>
<p id="section-8.8.2-1">Parent hashes are verified at two points in the protocol: When joining a group
and when processing a Commit.<a href="#section-8.8.2-1" class="pilcrow">¶</a></p>
<p id="section-8.8.2-2">The parent hash in a node U is valid with respect to a parent node P if the
following criteria hold:<a href="#section-8.8.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.8.2-3.1">U is a descendant of P in the tree<a href="#section-8.8.2-3.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-8.8.2-3.2">The nodes between U and P in the tree are all blank<a href="#section-8.8.2-3.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-8.8.2-3.3">The <code>parent_hash</code> field of U is equal to the parent hash of P with copath
child S, where S is the child of P that is not on the path from U to P.<a href="#section-8.8.2-3.3" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-8.8.2-4">A parent node P is "parent-hash valid" if it can be chained back to a leaf node
in this way.  That is, if there is leaf node L and a sequence of parent nodes
P_1, ..., P_N such that P_N = P and each step in the chain is authenticated
by a parent hash: L's parent hash is valid with respect to P_1, P_1's parent
hash is valid with respect to P_2, and so on.<a href="#section-8.8.2-4" class="pilcrow">¶</a></p>
<p id="section-8.8.2-5">When joining a group, the new member MUST authenticate that each non-blank
parent node P is parent-hash valid.  This can be done "bottom up" by building
chains up from leaves and verifying that all non-blank parent nodes are covered
by exactly one such chain, or "top down" by verifying that there is exactly one
descendant of each non-blank parent node for which the parent node is
parent-hash valid.<a href="#section-8.8.2-5" class="pilcrow">¶</a></p>
<p id="section-8.8.2-6">When processing a Commit message that includes an UpdatePath, clients MUST
recompute the expected value of <code>parent_hash</code> for the committer's new leaf and
verify that it matches the <code>parent_hash</code> value in the supplied <code>leaf_node</code>.
After being merged into the tree, the nodes in the UpdatePath form a parent-hash
chain from the committer's leaf to the root.<a href="#section-8.8.2-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="update-paths">
<section id="section-8.9">
        <h3 id="name-update-paths">
<a href="#section-8.9" class="section-number selfRef">8.9. </a><a href="#name-update-paths" class="section-name selfRef">Update Paths</a>
        </h3>
<p id="section-8.9-1">As described in <a href="#commit" class="xref">Section 13.2</a>, each MLS Commit message may optionally
transmit a LeafNode and parent node values along its direct path.
The path contains a public key and encrypted secret value for all
intermediate nodes in the filtered direct path from the leaf to the
root. The path is ordered
from the closest node to the leaf to the root; each node MUST be the
parent of its predecessor.<a href="#section-8.9-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.9-2">
<pre>
struct {
    opaque kem_output&lt;V&gt;;
    opaque ciphertext&lt;V&gt;;
} HPKECiphertext;

struct {
    HPKEPublicKey public_key;
    HPKECiphertext encrypted_path_secret&lt;V&gt;;
} UpdatePathNode;

struct {
    LeafNode leaf_node;
    UpdatePathNode nodes&lt;V&gt;;
} UpdatePath;
</pre><a href="#section-8.9-2" class="pilcrow">¶</a>
</div>
<p id="section-8.9-3">For each <code>UpdatePathNode</code>, the resolution of the corresponding copath node MUST
be filtered by removing all new leaf nodes added as part of this MLS Commit
message. The number of ciphertexts in the <code>encrypted_path_secret</code> vector MUST be
equal to the length of the filtered resolution, with each ciphertext being the
encryption to the respective resolution node.<a href="#section-8.9-3" class="pilcrow">¶</a></p>
<p id="section-8.9-4">The HPKECiphertext values are computed as<a href="#section-8.9-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-8.9-5">
<pre>
kem_output, context = SetupBaseS(node_public_key, group_context)
ciphertext = context.Seal("", path_secret)
</pre><a href="#section-8.9-5" class="pilcrow">¶</a>
</div>
<p id="section-8.9-6">where <code>node_public_key</code> is the public key of the node that the path
secret is being encrypted for, group_context is the current GroupContext object
for the group, and the functions <code>SetupBaseS</code> and
<code>Seal</code> are defined according to <span>[<a href="#RFC9180" class="xref">RFC9180</a>]</span>.<a href="#section-8.9-6" class="pilcrow">¶</a></p>
<p id="section-8.9-7">Decryption is performed in the corresponding way, using the private
key of the resolution node.<a href="#section-8.9-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="key-schedule">
<section id="section-9">
      <h2 id="name-key-schedule">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-key-schedule" class="section-name selfRef">Key Schedule</a>
      </h2>
<p id="section-9-1">Group keys are derived using the <code>Extract</code> and <code>Expand</code> functions from the KDF
for the group's ciphersuite, as well as the functions defined below:<a href="#section-9-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9-2">
<pre>
ExpandWithLabel(Secret, Label, Context, Length) =
    KDF.Expand(Secret, KDFLabel, Length)

Where KDFLabel is specified as:

struct {
    uint16 length = Length;
    opaque label&lt;V&gt; = "MLS 1.0 " + Label;
    opaque context&lt;V&gt; = Context;
} KDFLabel;

DeriveSecret(Secret, Label) =
    ExpandWithLabel(Secret, Label, "", KDF.Nh)
</pre><a href="#section-9-2" class="pilcrow">¶</a>
</div>
<p id="section-9-3">The value <code>KDF.Nh</code> is the size of an output from <code>KDF.Extract</code>, in bytes.  In
the below diagram:<a href="#section-9-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9-4.1">KDF.Extract takes its salt argument from the top and its Input
Key Material (IKM) argument from the left<a href="#section-9-4.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-4.2">DeriveSecret takes its Secret argument from the incoming arrow<a href="#section-9-4.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-4.3">
          <code>0</code> represents an all-zero byte string of length <code>KDF.Nh</code>.<a href="#section-9-4.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-9-5">When processing a handshake message, a client combines the
following information to derive new epoch secrets:<a href="#section-9-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9-6.1">The init secret from the previous epoch<a href="#section-9-6.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-6.2">The commit secret for the current epoch<a href="#section-9-6.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-9-6.3">The GroupContext object for current epoch<a href="#section-9-6.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-9-7">Given these inputs, the derivation of secrets for an epoch
proceeds as shown in the following diagram:<a href="#section-9-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9-8">
<pre>
                   init_secret_[n-1]
                         |
                         V
    commit_secret -&gt; KDF.Extract
                         |
                         V
                 ExpandWithLabel(., "joiner", GroupContext_[n], KDF.Nh)
                         |
                         V
                    joiner_secret
                         |
                         V
psk_secret (or 0) -&gt; KDF.Extract
                         |
                         +--&gt; DeriveSecret(., "welcome")
                         |    = welcome_secret
                         |
                         V
                 ExpandWithLabel(., "epoch", GroupContext_[n], KDF.Nh)
                         |
                         V
                    epoch_secret
                         |
                         +--&gt; DeriveSecret(., &lt;label&gt;)
                         |    = &lt;secret&gt;
                         |
                         V
                   DeriveSecret(., "init")
                         |
                         V
                   init_secret_[n]
</pre><a href="#section-9-8" class="pilcrow">¶</a>
</div>
<p id="section-9-9">A number of secrets are derived from the epoch secret for different purposes:<a href="#section-9-9" class="pilcrow">¶</a></p>
<span id="name-epoch-derived-secrets"></span><div id="epoch-derived-secrets">
<table class="center" id="table-3">
        <caption>
<a href="#table-3" class="selfRef">Table 3</a>:
<a href="#name-epoch-derived-secrets" class="selfRef">Epoch-derived secrets</a>
        </caption>
<thead>
          <tr>
            <th class="text-left" rowspan="1" colspan="1">Secret</th>
            <th class="text-left" rowspan="1" colspan="1">Label</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">
              <code>sender_data_secret</code>
</td>
            <td class="text-left" rowspan="1" colspan="1">"sender data"</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">
              <code>encryption_secret</code>
</td>
            <td class="text-left" rowspan="1" colspan="1">"encryption"</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">
              <code>exporter_secret</code>
</td>
            <td class="text-left" rowspan="1" colspan="1">"exporter"</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">
              <code>authentication_secret</code>
</td>
            <td class="text-left" rowspan="1" colspan="1">"authentication"</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">
              <code>external_secret</code>
</td>
            <td class="text-left" rowspan="1" colspan="1">"external"</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">
              <code>confirmation_key</code>
</td>
            <td class="text-left" rowspan="1" colspan="1">"confirm"</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">
              <code>membership_key</code>
</td>
            <td class="text-left" rowspan="1" colspan="1">"membership"</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">
              <code>resumption_secret</code>
</td>
            <td class="text-left" rowspan="1" colspan="1">"resumption"</td>
          </tr>
        </tbody>
      </table>
</div>
<p id="section-9-11">The "external secret" is used to derive an HPKE key pair whose private key is
held by the entire group:<a href="#section-9-11" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9-12">
<pre>
external_priv, external_pub = KEM.DeriveKeyPair(external_secret)
</pre><a href="#section-9-12" class="pilcrow">¶</a>
</div>
<p id="section-9-13">The public key <code>external_pub</code> can be published as part of the GroupInfo struct
in order to allow non-members to join the group using an external commit.<a href="#section-9-13" class="pilcrow">¶</a></p>
<div id="group-context">
<section id="section-9.1">
        <h3 id="name-group-context">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-group-context" class="section-name selfRef">Group Context</a>
        </h3>
<p id="section-9.1-1">Each member of the group maintains a GroupContext object that
summarizes the state of the group:<a href="#section-9.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.1-2">
<pre>
struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    opaque tree_hash&lt;V&gt;;
    opaque confirmed_transcript_hash&lt;V&gt;;
    Extension extensions&lt;V&gt;;
} GroupContext;
</pre><a href="#section-9.1-2" class="pilcrow">¶</a>
</div>
<p id="section-9.1-3">The fields in this state have the following semantics:<a href="#section-9.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.1-4.1">The <code>group_id</code> field is an application-defined identifier for the
group.<a href="#section-9.1-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.1-4.2">The <code>epoch</code> field represents the current version of the group.<a href="#section-9.1-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.1-4.3">The <code>tree_hash</code> field contains a commitment to the contents of the
group's ratchet tree and the credentials for the members of the
group, as described in <a href="#tree-hashes" class="xref">Section 8.7</a>.<a href="#section-9.1-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.1-4.4">The <code>confirmed_transcript_hash</code> field contains a running hash over
the messages that led to this state.<a href="#section-9.1-4.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.1-4.5">The <code>extensions</code> field contains the details of any protocol extensions that
apply to the group.<a href="#section-9.1-4.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-9.1-5">When a new member is added to the group, an existing member of the
group provides the new member with a Welcome message.  The Welcome
message provides the information the new member needs to initialize
its GroupContext.<a href="#section-9.1-5" class="pilcrow">¶</a></p>
<p id="section-9.1-6">Different changes to the group will have different effects on the group state.
These effects are described in their respective subsections of <a href="#proposals" class="xref">Section 13.1</a>.
The following general rules apply:<a href="#section-9.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.1-7.1">The <code>group_id</code> field is constant.<a href="#section-9.1-7.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.1-7.2">The <code>epoch</code> field increments by one for each Commit message that
is processed.<a href="#section-9.1-7.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.1-7.3">The <code>tree_hash</code> is updated to represent the current tree and
credentials.<a href="#section-9.1-7.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.1-7.4">The <code>confirmed_transcript_hash</code> field is updated with the data for an
MLSPlaintext message encoding a Commit message as described below.<a href="#section-9.1-7.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.1-7.5">The <code>extensions</code> field changes when a GroupContextExtensions proposal is
committed.<a href="#section-9.1-7.5" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="transcript-hashes">
<section id="section-9.2">
        <h3 id="name-transcript-hashes">
<a href="#section-9.2" class="section-number selfRef">9.2. </a><a href="#name-transcript-hashes" class="section-name selfRef">Transcript Hashes</a>
        </h3>
<p id="section-9.2-1">The transcript hashes computed in MLS represent a running hash over all Proposal
and Commit messages that have ever been sent in a group.  Commit messages are
included directly. Proposal messages are indirectly included via the Commit that
applied them. Both types of message are included by hashing the MLSPlaintext
in which they were sent.<a href="#section-9.2-1" class="pilcrow">¶</a></p>
<p id="section-9.2-2">The <code>confirmed_transcript_hash</code> is updated with an MLSMessageContent and
MLSMessageAuth containing a Commit in two steps:<a href="#section-9.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.2-3">
<pre>
struct {
    WireFormat wire_format;
    MLSMessageContent content; //with content.content_type == commit
    opaque signature&lt;V&gt;;
} MLSMessageCommitContent;

struct {
    MAC confirmation_tag;
} MLSMessageCommitAuthData;

interim_transcript_hash_[0] = ""; // zero-length octet string

confirmed_transcript_hash_[n] =
    Hash(interim_transcript_hash_[n] ||
        MLSMessageCommitContent_[n]);

interim_transcript_hash_[n+1] =
    Hash(confirmed_transcript_hash_[n] ||
        MLSMessageCommitAuthData_[n]);
</pre><a href="#section-9.2-3" class="pilcrow">¶</a>
</div>
<p id="section-9.2-4">Thus the <code>confirmed_transcript_hash</code> field in a GroupContext object represents a
transcript over the whole history of MLSMessage Commit messages, up to the
confirmation_tag field of the most recent Commit.  The confirmation
tag is then included in the transcript for the next epoch.  The interim
transcript hash is computed by new members using the confirmation_tag of the
GroupInfo struct, while existing members can compute it directly.<a href="#section-9.2-4" class="pilcrow">¶</a></p>
<p id="section-9.2-5">As shown above, when a new group is created, the <code>interim_transcript_hash</code> field
is set to the zero-length octet string.<a href="#section-9.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="external-initialization">
<section id="section-9.3">
        <h3 id="name-external-initialization">
<a href="#section-9.3" class="section-number selfRef">9.3. </a><a href="#name-external-initialization" class="section-name selfRef">External Initialization</a>
        </h3>
<p id="section-9.3-1">In addition to initializing a new epoch via KDF invocations as described above,
an MLS group can also initialize a new epoch via an asymmetric interaction using
the external key pair for the previous epoch.  This is done when an new member
is joining via an external commit.<a href="#section-9.3-1" class="pilcrow">¶</a></p>
<p id="section-9.3-2">In this process, the joiner sends a new <code>init_secret</code> value to the group using
the HPKE export method.  The joiner then uses that <code>init_secret</code> with
information provided in the GroupInfo and an external Commit to initialize
their copy of the key schedule for the new epoch.<a href="#section-9.3-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.3-3">
<pre>
kem_output, context = SetupBaseS(external_pub, "")
init_secret = context.export("MLS 1.0 external init secret", KDF.Nh)
</pre><a href="#section-9.3-3" class="pilcrow">¶</a>
</div>
<p id="section-9.3-4">Members of the group receive the <code>kem_output</code> in an ExternalInit proposal and
preform the corresponding calculation to retrieve the <code>init_secret</code> value.<a href="#section-9.3-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.3-5">
<pre>
context = SetupBaseR(kem_output, external_priv, "")
init_secret = context.export("MLS 1.0 external init secret", KDF.Nh)
</pre><a href="#section-9.3-5" class="pilcrow">¶</a>
</div>
<p id="section-9.3-6">In both cases, the <code>info</code> input to HPKE is set to the GroupInfo for the
previous epoch, encoded using the TLS serialization.<a href="#section-9.3-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="pre-shared-keys">
<section id="section-9.4">
        <h3 id="name-pre-shared-keys">
<a href="#section-9.4" class="section-number selfRef">9.4. </a><a href="#name-pre-shared-keys" class="section-name selfRef">Pre-Shared Keys</a>
        </h3>
<p id="section-9.4-1">Groups which already have an out-of-band mechanism to generate
shared group secrets can inject those into the MLS key schedule to seed
the MLS group secrets computations by this external entropy.<a href="#section-9.4-1" class="pilcrow">¶</a></p>
<p id="section-9.4-2">Injecting an external PSK can improve security in the case
where having a full run of updates across members is too expensive, or if
the external group key establishment mechanism provides
stronger security against classical or quantum adversaries.<a href="#section-9.4-2" class="pilcrow">¶</a></p>
<p id="section-9.4-3">Note that, as a PSK may have a different lifetime than an update, it does not
necessarily provide the same Forward Secrecy (FS) or Post-Compromise Security
(PCS) guarantees as a Commit message.  Unlike the key pairs populated in the
tree by an Update or Commit, which are always freshly generated, PSKs may be
pre-distributed and stored. This creates the risk that a PSK may be compromised
in the process of distribution and storage. The security that the group gets
from injecting a PSK thus depends on both the entropy of the PSK and the risk of
compromise.  These factors are outside of the scope of this document, but should
be considered by application designers relying on PSKs.<a href="#section-9.4-3" class="pilcrow">¶</a></p>
<p id="section-9.4-4">Each PSK in MLS has a type that designates how it was provisioned.
External PSKs are provided by the application, while resumption PSKs
are derived from the MLS key schedule and used in cases where it is
necessary to authenticate a member's participation in a prior epoch.<a href="#section-9.4-4" class="pilcrow">¶</a></p>
<p id="section-9.4-5">The injection of one or more PSKs into the key schedule is signaled in two ways:
Existing members are informed via PreSharedKey proposals covered by a Commit,
and new members added in the Commit are informed via GroupSecrets object in the
Welcome message corresponding to the Commit.  To ensure that existing and new
members compute the same PSK input to the key schedule, the Commit and
GroupSecrets objects MUST indicate the same set of PSKs, in the same order.<a href="#section-9.4-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.4-6">
<pre>
enum {
  reserved(0),
  external(1),
  resumption(2),
  (255)
} PSKType;

enum {
  reserved(0),
  application(1),
  reinit(2),
  branch(3),
} ResumptionPSKUsage;

struct {
  PSKType psktype;
  select (PreSharedKeyID.psktype) {
    case external:
      opaque psk_id&lt;V&gt;;

    case resumption:
      ResumptionPSKUsage usage;
      opaque psk_group_id&lt;V&gt;;
      uint64 psk_epoch;
  }
  opaque psk_nonce&lt;V&gt;;
} PreSharedKeyID;

struct {
    PreSharedKeyID psks&lt;V&gt;;
} PreSharedKeys;
</pre><a href="#section-9.4-6" class="pilcrow">¶</a>
</div>
<p id="section-9.4-7">On receiving a Commit with a <code>PreSharedKey</code> proposal or a GroupSecrets object
with the <code>psks</code> field set, the receiving Client includes them in the key
schedule in the order listed in the Commit, or in the <code>psks</code> field respectively.
For resumption PSKs, the PSK is defined as the <code>resumption_secret</code> of the group and
epoch specified in the <code>PreSharedKeyID</code> object. Specifically, <code>psk_secret</code> is
computed as follows:<a href="#section-9.4-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.4-8">
<pre>
struct {
    PreSharedKeyID id;
    uint16 index;
    uint16 count;
} PSKLabel;

psk_extracted_[i] = KDF.Extract(0, psk_[i])
psk_input_[i] = ExpandWithLabel(psk_extracted_[i], "derived psk",
                  PSKLabel, KDF.Nh)

psk_secret_[0] = 0
psk_secret_[i] = KDF.Extract(psk_input_[i-1], psk_secret_[i-1])
psk_secret     = psk_secret_[n]
</pre><a href="#section-9.4-8" class="pilcrow">¶</a>
</div>
<p id="section-9.4-9">Here <code>0</code> represents the all-zero vector of length <code>KDF.Nh</code>. The <code>index</code> field in
<code>PSKLabel</code> corresponds to the index of the PSK in the <code>psk</code> array, while the
<code>count</code> field contains the total number of PSKs.  In other words, the PSKs are
chained together with KDF.Extract invocations (labelled "Extract" for brevity
in the diagram), as follows:<a href="#section-9.4-9" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.4-10">
<pre>
                 0                               0    = psk_secret_[0]
                 |                               |
                 V                               V
psk_[0]   --&gt; Extract --&gt; ExpandWithLabel --&gt; Extract = psk_secret_[1]
                                                 |
                 0                               |
                 |                               |
                 V                               V
psk_[1]   --&gt; Extract --&gt; ExpandWithLabel --&gt; Extract = psk_secret_[2]
                                                 |
                 0                              ...
                 |                               |
                 V                               V
psk_[n-1] --&gt; Extract --&gt; ExpandWithLabel --&gt; Extract = psk_secret_[n]
</pre><a href="#section-9.4-10" class="pilcrow">¶</a>
</div>
<p id="section-9.4-11">In particular, if there are no PreSharedKey proposals in a given Commit, then
the resulting <code>psk_secret</code> is <code>psk_secret_[0]</code>, the all-zero vector.<a href="#section-9.4-11" class="pilcrow">¶</a></p>
</section>
</div>
<div id="exporters">
<section id="section-9.5">
        <h3 id="name-exporters">
<a href="#section-9.5" class="section-number selfRef">9.5. </a><a href="#name-exporters" class="section-name selfRef">Exporters</a>
        </h3>
<p id="section-9.5-1">The main MLS key schedule provides an <code>exporter_secret</code> which can
be used by an application as the basis to derive new secrets called
<code>exported_value</code> outside the MLS layer.<a href="#section-9.5-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.5-2">
<pre>
MLS-Exporter(Label, Context, key_length) =
       ExpandWithLabel(DeriveSecret(exporter_secret, Label),
                         "exporter", Hash(Context), key_length)
</pre><a href="#section-9.5-2" class="pilcrow">¶</a>
</div>
<p id="section-9.5-3">Each application SHOULD provide a unique label to <code>MLS-Exporter</code> that
identifies its use case. This is to prevent two
exported outputs from being generated with the same values and used
for different functionalities.<a href="#section-9.5-3" class="pilcrow">¶</a></p>
<p id="section-9.5-4">The exported values are bound to the group epoch from which the
<code>exporter_secret</code> is derived, hence reflects a particular state of
the group.<a href="#section-9.5-4" class="pilcrow">¶</a></p>
<p id="section-9.5-5">It is RECOMMENDED for the application generating exported values
to refresh those values after a Commit is processed.<a href="#section-9.5-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="resumption-secret">
<section id="section-9.6">
        <h3 id="name-resumption-secret">
<a href="#section-9.6" class="section-number selfRef">9.6. </a><a href="#name-resumption-secret" class="section-name selfRef">Resumption Secret</a>
        </h3>
<p id="section-9.6-1">The main MLS key schedule provides a <code>resumption_secret</code> that is used as a PSK
to inject entropy from one epoch into another.  This functionality is used in the
reinitialization and branching processes described in <a href="#reinitialization" class="xref">Section 12.2</a> and
<a href="#sub-group-branching" class="xref">Section 12.3</a>, but may be used by applications for other purposes.<a href="#section-9.6-1" class="pilcrow">¶</a></p>
<p id="section-9.6-2">Some uses of resumption PSKs might call for the use of PSKs from historical
epochs. The application SHOULD specify an upper limit on the number of past
epochs for which the <code>resumption_secret</code> may be stored.<a href="#section-9.6-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="state-authentication-keys">
<section id="section-9.7">
        <h3 id="name-state-authentication-keys">
<a href="#section-9.7" class="section-number selfRef">9.7. </a><a href="#name-state-authentication-keys" class="section-name selfRef">State Authentication Keys</a>
        </h3>
<p id="section-9.7-1">The main MLS key schedule provides a per-epoch <code>authentication_secret</code>.
If one of the parties is being actively impersonated by an attacker, their
<code>authentication_secret</code> will differ from that of the other group members.
Thus, members of a group MAY use their <code>authentication_secrets</code> within
an out-of-band authentication protocol to ensure that they
share the same view of the group.<a href="#section-9.7-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="secret-tree">
<section id="section-10">
      <h2 id="name-secret-tree">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-secret-tree" class="section-name selfRef">Secret Tree</a>
      </h2>
<p id="section-10-1">For the generation of encryption keys and nonces, the key schedule begins with
the <code>encryption_secret</code> at the root and derives a tree of secrets with the same
structure as the group's ratchet tree. Each leaf in the Secret Tree is
associated with the same group member as the corresponding leaf in the ratchet
tree.<a href="#section-10-1" class="pilcrow">¶</a></p>
<p id="section-10-2">If N is a parent node in the Secret Tree then the secrets of the children of N
are defined as follows (where left(N) and right(N) denote the children of N):<a href="#section-10-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10-3">
<pre>
tree_node_[N]_secret
        |
        |
        +--&gt; ExpandWithLabel(., "tree", "left", KDF.Nh)
        |    = tree_node_[left(N)]_secret
        |
        +--&gt; ExpandWithLabel(., "tree", "right", KDF.Nh)
             = tree_node_[right(N)]_secret
</pre><a href="#section-10-3" class="pilcrow">¶</a>
</div>
<p id="section-10-4">The secret in the leaf of the Secret Tree is used to initiate two symmetric hash
ratchets, from which a sequence of single-use keys and nonces are derived, as
described in <a href="#encryption-keys" class="xref">Section 10.1</a>. The root of each ratchet is computed as:<a href="#section-10-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10-5">
<pre>
tree_node_[N]_secret
        |
        |
        +--&gt; ExpandWithLabel(., "handshake", "", KDF.Nh)
        |    = handshake_ratchet_secret_[N]_[0]
        |
        +--&gt; ExpandWithLabel(., "application", "", KDF.Nh)
             = application_ratchet_secret_[N]_[0]
</pre><a href="#section-10-5" class="pilcrow">¶</a>
</div>
<div id="encryption-keys">
<section id="section-10.1">
        <h3 id="name-encryption-keys">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-encryption-keys" class="section-name selfRef">Encryption Keys</a>
        </h3>
<p id="section-10.1-1">As described in <a href="#message-framing" class="xref">Section 7</a>, MLS encrypts three different
types of information:<a href="#section-10.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.1-2.1">Metadata (sender information)<a href="#section-10.1-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-2.2">Handshake messages (Proposal and Commit)<a href="#section-10.1-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-2.3">Application messages<a href="#section-10.1-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-10.1-3">The sender information used to look up the key for content encryption is
encrypted with an AEAD where the key and nonce are derived from both
<code>sender_data_secret</code> and a sample of the encrypted message content.<a href="#section-10.1-3" class="pilcrow">¶</a></p>
<p id="section-10.1-4">For handshake and application messages, a sequence of keys is derived via a
"sender ratchet".  Each sender has their own sender ratchet, and each step along
the ratchet is called a "generation".<a href="#section-10.1-4" class="pilcrow">¶</a></p>
<p id="section-10.1-5">A sender ratchet starts from a per-sender base secret derived from a Secret
Tree, as described in <a href="#secret-tree" class="xref">Section 10</a>. The base secret initiates a symmetric
hash ratchet which generates a sequence of keys and nonces. The sender uses the
j-th key/nonce pair in the sequence to encrypt (using the AEAD) the j-th message
they send during that epoch. Each key/nonce pair MUST NOT be used to encrypt
more than one message.<a href="#section-10.1-5" class="pilcrow">¶</a></p>
<p id="section-10.1-6">Keys, nonces, and the secrets in ratchets are derived using
DeriveTreeSecret. The context in a given call consists of the current position
in the ratchet.<a href="#section-10.1-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.1-7">
<pre>
DeriveTreeSecret(Secret, Label, Generation, Length) =
    ExpandWithLabel(Secret, Label, Generation, Length)

Where Generation is encoded as a uint32.
</pre><a href="#section-10.1-7" class="pilcrow">¶</a>
</div>
<div class="alignLeft art-text artwork" id="section-10.1-8">
<pre>
ratchet_secret_[N]_[j]
      |
      +--&gt; DeriveTreeSecret(., "nonce", j, AEAD.Nn)
      |    = ratchet_nonce_[N]_[j]
      |
      +--&gt; DeriveTreeSecret(., "key", j,  AEAD.Nk)
      |    = ratchet_key_[N]_[j]
      |
      V
DeriveTreeSecret(., "secret", j, KDF.Nh)
= ratchet_secret_[N]_[j+1]
</pre><a href="#section-10.1-8" class="pilcrow">¶</a>
</div>
<p id="section-10.1-9">Here, AEAD.Nn and AEAD.Nk denote the lengths
in bytes of the nonce and key for the AEAD scheme defined by
the ciphersuite.<a href="#section-10.1-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="deletion-schedule">
<section id="section-10.2">
        <h3 id="name-deletion-schedule">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-deletion-schedule" class="section-name selfRef">Deletion Schedule</a>
        </h3>
<p id="section-10.2-1">It is important to delete all security-sensitive values as soon as they are
<em>consumed</em>. A sensitive value S is said to be <em>consumed</em> if<a href="#section-10.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-2.1">S was used to encrypt or (successfully) decrypt a message, or if<a href="#section-10.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-2.2">a key, nonce, or secret derived from S has been consumed. (This goes for
values derived via DeriveSecret as well as ExpandWithLabel.)<a href="#section-10.2-2.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-10.2-3">Here, S may be the <code>init_secret</code>, <code>commit_secret</code>, <code>epoch_secret</code>,
<code>encryption_secret</code> as well as any secret in a Secret Tree or one of the
ratchets.<a href="#section-10.2-3" class="pilcrow">¶</a></p>
<p id="section-10.2-4">As soon as a group member consumes a value they MUST immediately delete
(all representations of) that value. This is crucial to ensuring
forward secrecy for past messages. Members MAY keep unconsumed values around
for some reasonable amount of time to handle out-of-order message delivery.<a href="#section-10.2-4" class="pilcrow">¶</a></p>
<p id="section-10.2-5">For example, suppose a group member encrypts or (successfully) decrypts an
application message using the j-th key and nonce in the ratchet of leaf node
L in some epoch n. Then, for that member, at least the following
values have been consumed and MUST be deleted:<a href="#section-10.2-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-6.1">the <code>commit_secret</code>, <code>joiner_secret</code>, <code>epoch_secret</code>, <code>encryption_secret</code> of
that epoch n as well as the <code>init_secret</code> of the previous epoch n-1,<a href="#section-10.2-6.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-6.2">all node secrets in the Secret Tree on the path from the root to the leaf with
node L,<a href="#section-10.2-6.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-6.3">the first j secrets in the application data ratchet of node L and<a href="#section-10.2-6.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.2-6.4">
            <code>application_ratchet_nonce_[L]_[j]</code> and <code>application_ratchet_key_[L]_[j]</code>.<a href="#section-10.2-6.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-10.2-7">Concretely, suppose we have the following Secret Tree and ratchet for
participant D:<a href="#section-10.2-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-10.2-8">
<pre>
       G
     /   \
    /     \
   E       F
  / \     / \
 A   B   C   D
            / \
          HR0  AR0 -+- K0
                |   |
                |   +- N0
                |
               AR1 -+- K1
                |   |
                |   +- N1
                |
               AR2
</pre><a href="#section-10.2-8" class="pilcrow">¶</a>
</div>
<p id="section-10.2-9">Then if a client uses key K1 and nonce N1 during epoch n then it must consume
(at least) values G, F, D, AR0, AR1, K1, N1 as well as the key schedule secrets
used to derive G (the <code>encryption_secret</code>), namely <code>init_secret</code> of epoch n-1
and <code>commit_secret</code>, <code>joiner_secret</code>, <code>epoch_secret</code> of epoch n. The client MAY
retain (not consume) the values K0 and N0 to allow for out-of-order delivery,
and SHOULD retain AR2 for processing future messages.<a href="#section-10.2-9" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="key-packages">
<section id="section-11">
      <h2 id="name-key-packages">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-key-packages" class="section-name selfRef">Key Packages</a>
      </h2>
<p id="section-11-1">In order to facilitate the asynchronous addition of clients to a
group, key packages are pre-published that
provide some public information about a user. A KeyPackage object specifies:<a href="#section-11-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-11-2">
<li id="section-11-2.1">A protocol version and ciphersuite that the client supports,<a href="#section-11-2.1" class="pilcrow">¶</a>
</li>
        <li id="section-11-2.2">a public key that others can use to encrypt a Welcome message to this client,
(an "init key") and<a href="#section-11-2.2" class="pilcrow">¶</a>
</li>
        <li id="section-11-2.3">the content of the leaf node that should be added to the tree to represent
this client.<a href="#section-11-2.3" class="pilcrow">¶</a>
</li>
      </ol>
<p id="section-11-3">KeyPackages are intended to be used only once and SHOULD NOT
be reused except in case of last resort. (See <a href="#keypackage-reuse" class="xref">Section 17.4</a>).
Clients MAY generate and publish multiple KeyPackages to
support multiple ciphersuites.<a href="#section-11-3" class="pilcrow">¶</a></p>
<p id="section-11-4">The value for <code>init_key</code> MUST be a public key for the asymmetric encryption
scheme defined by <code>cipher_suite</code>, and it MUST be unique among the set of
KeyPackages created by this client.  Likewise, the <code>leaf_node</code> field MUST be
valid for the ciphersuite, including both the <code>public_key</code> and <code>credential</code>
fields.  The whole structure is signed using the client's signature key. A
KeyPackage object with an invalid signature field MUST be considered malformed.<a href="#section-11-4" class="pilcrow">¶</a></p>
<p id="section-11-5">The signature is computed by the function <code>SignWithLabel</code> with a label
<code>KeyPackage</code> and a content comprising of all of the fields except for the
signature field.<a href="#section-11-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-11-6">
<pre>
struct {
    ProtocolVersion version;
    CipherSuite cipher_suite;
    HPKEPublicKey init_key;
    LeafNode leaf_node;
    Extension extensions&lt;V&gt;;
    // SignWithLabel(., "KeyPackageTBS", KeyPackageTBS)
    opaque signature&lt;V&gt;;
} KeyPackage;

struct {
    ProtocolVersion version;
    CipherSuite cipher_suite;
    HPKEPublicKey init_key;
    LeafNode leaf_node;
    Extension extensions&lt;V&gt;;
} KeyPackageTBS;
</pre><a href="#section-11-6" class="pilcrow">¶</a>
</div>
<p id="section-11-7">If a client receives a KeyPackage carried within an MLSMessage object, then it
MUST verify that the <code>version</code> field of the KeyPackage has the same value as the
<code>version</code> field of the MLSMessage.  The <code>version</code> field in the KeyPackage
provides an explicit signal of the intended version to the other members of
group when they receive the KeyPackage in an Add proposal.<a href="#section-11-7" class="pilcrow">¶</a></p>
<p id="section-11-8">The field <code>leaf_node.capabilities</code> indicates what protocol versions,
ciphersuites, protocol extensions, and non-default proposal types are supported
by the client.  (Proposal types defined in this document are considered
"default" and not listed.)  This information allows MLS session
establishment to be safe from downgrade attacks on the parameters described (as
discussed in <a href="#group-creation" class="xref">Section 12</a>), while still only advertising one version /
ciphersuite per KeyPackage.<a href="#section-11-8" class="pilcrow">¶</a></p>
<p id="section-11-9">The field <code>leaf_node.leaf_node_source</code> of the LeafNode in a KeyPackage MUST be
set to <code>key_package</code>.<a href="#section-11-9" class="pilcrow">¶</a></p>
<p id="section-11-10">Extension included in the <code>extensions</code> or <code>leaf_node.extensions</code> fields MUST be
included in the <code>leaf_node.capabilities</code> field.<a href="#section-11-10" class="pilcrow">¶</a></p>
<div id="keypackage-validation">
<section id="section-11.1">
        <h3 id="name-keypackage-validation">
<a href="#section-11.1" class="section-number selfRef">11.1. </a><a href="#name-keypackage-validation" class="section-name selfRef">KeyPackage Validation</a>
        </h3>
<p id="section-11.1-1">The validity of a KeyPackage needs to be verified at a few stages:<a href="#section-11.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-11.1-2.1">When a KeyPackage is downloaded by a group member, before it is used
to add the client to the group<a href="#section-11.1-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-11.1-2.2">When a KeyPackage is received by a group member in an Add message<a href="#section-11.1-2.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-11.1-3">The client verifies the validity of a KeyPackage using the following steps:<a href="#section-11.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-11.1-4.1">Verify that the ciphersuite and protocol version of the KeyPackage match
those in use in the group.<a href="#section-11.1-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-11.1-4.2">Verify the <code>leaf_node</code> field of the KeyPackage according to the process
defined in <a href="#leaf-node-validation" class="xref">Section 8.3</a>.<a href="#section-11.1-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-11.1-4.3">Verify that the signature on the KeyPackage is valid using the public key
in <code>leaf_node.credential</code>.<a href="#section-11.1-4.3" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="keypackage-identifiers">
<section id="section-11.2">
        <h3 id="name-keypackage-identifiers">
<a href="#section-11.2" class="section-number selfRef">11.2. </a><a href="#name-keypackage-identifiers" class="section-name selfRef">KeyPackage Identifiers</a>
        </h3>
<p id="section-11.2-1">Within MLS, a KeyPackage is identified by its hash (see, e.g.,
<a href="#joining-via-welcome-message" class="xref">Section 13.2.3.2</a>).  The <code>external_key_id</code> extension allows
applications to add an explicit, application-defined identifier to a KeyPackage.<a href="#section-11.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-11.2-2">
<pre>
opaque external_key_id&lt;V&gt;;
</pre><a href="#section-11.2-2" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="group-creation">
<section id="section-12">
      <h2 id="name-group-creation">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-group-creation" class="section-name selfRef">Group Creation</a>
      </h2>
<p id="section-12-1">A group is always created with a single member, the "creator".  The other
members are added when the creator effectively sends itself an Add proposal and
commits it, then sends the corresponding Welcome message to the new
participants.  These processes are described in detail in <a href="#add" class="xref">Section 13.1.1</a>, <a href="#commit" class="xref">Section 13.2</a>,
and <a href="#joining-via-welcome-message" class="xref">Section 13.2.3.2</a>.<a href="#section-12-1" class="pilcrow">¶</a></p>
<p id="section-12-2">The creator of a group MUST take the following steps to initialize the group:<a href="#section-12-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12-3.1">Fetch KeyPackages for the members to be added, and select a version and
ciphersuite according to the capabilities of the members.  To protect against
downgrade attacks, the creator MUST use the <code>capabilities</code> information
in these KeyPackages to verify that the
chosen version and ciphersuite is the best option supported by all members.<a href="#section-12-3.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-12-3.2">
          <p id="section-12-3.2.1">Initialize a one-member group with the following initial values:<a href="#section-12-3.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12-3.2.2.1">Ratchet tree: A tree with a single node, a leaf containing an HPKE public
key and credential for the creator<a href="#section-12-3.2.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-12-3.2.2.2">Group ID: A value set by the creator<a href="#section-12-3.2.2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-12-3.2.2.3">Epoch: 0<a href="#section-12-3.2.2.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-12-3.2.2.4">Tree hash: The root hash of the above ratchet tree<a href="#section-12-3.2.2.4" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-12-3.2.2.5">Confirmed transcript hash: The zero-length octet string<a href="#section-12-3.2.2.5" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-12-3.2.2.6">Interim transcript hash: The zero-length octet string<a href="#section-12-3.2.2.6" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-12-3.2.2.7">Init secret: A fresh random value of size <code>KDF.Nh</code><a href="#section-12-3.2.2.7" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-12-3.2.2.8">Extensions: Any values of the creator's choosing<a href="#section-12-3.2.2.8" class="pilcrow">¶</a>
</li>
          </ul>
</li>
        <li class="normal" id="section-12-3.3">For each member, construct an Add proposal from the KeyPackage for that
member (see <a href="#add" class="xref">Section 13.1.1</a>)<a href="#section-12-3.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-12-3.4">Construct a Commit message that commits all of the Add proposals, in any order
chosen by the creator (see <a href="#commit" class="xref">Section 13.2</a>)<a href="#section-12-3.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-12-3.5">Process the Commit message to obtain a new group state (for the epoch in which
the new members are added) and a Welcome message<a href="#section-12-3.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-12-3.6">Transmit the Welcome message to the other new members<a href="#section-12-3.6" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-12-4">The recipient of a Welcome message processes it as described in
<a href="#joining-via-welcome-message" class="xref">Section 13.2.3.2</a>.  If application context informs the recipient that
the Welcome should reflect the creation of a new group (for example, due to a
branch or reinitialization), then the recipient MUST verify that the epoch value
in the GroupInfo is equal to 1.<a href="#section-12-4" class="pilcrow">¶</a></p>
<p id="section-12-5">In principle, the above process could be streamlined by having the
creator directly create a tree and choose a random value for first
epoch's epoch secret.  We follow the steps above because it removes
unnecessary choices, by which, for example, bad randomness could be
introduced.  The only choices the creator makes here are its own
KeyPackage and the leaf secret from which the Commit is built.<a href="#section-12-5" class="pilcrow">¶</a></p>
<div id="required-capabilities">
<section id="section-12.1">
        <h3 id="name-required-capabilities">
<a href="#section-12.1" class="section-number selfRef">12.1. </a><a href="#name-required-capabilities" class="section-name selfRef">Required Capabilities</a>
        </h3>
<p id="section-12.1-1">The configuration of a group imposes certain requirements on clients in the
group.  At a minimum, all members of the group need to support the ciphersuite
and protocol version in use.  Additional requirements can be imposed by
including a <code>required_capabilities</code> extension in the GroupContext.<a href="#section-12.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-12.1-2">
<pre>
struct {
    ExtensionType extension_types&lt;V&gt;;
    ProposalType proposal_types&lt;V&gt;;
} RequiredCapabilities;
</pre><a href="#section-12.1-2" class="pilcrow">¶</a>
</div>
<p id="section-12.1-3">This extension lists the extensions and proposal types that must be supported by
all members of the group. The "default" proposal and extension types defined in this
document are assumed to be implemented by all clients, and need not be listed in
RequiredCapabilities in order to be safely used.<a href="#section-12.1-3" class="pilcrow">¶</a></p>
<p id="section-12.1-4">For new members, support for required capabilities is enforced by existing
members during the application of Add commits.  Existing members should of
course be in compliance already.  In order to ensure this continues to be the
case even as the group's extensions can be updated, a GroupContextExtensions
proposal is invalid if it contains a <code>required_capabilities</code> extension that
requires non-default capabilities not supported by all current members.<a href="#section-12.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="reinitialization">
<section id="section-12.2">
        <h3 id="name-reinitialization">
<a href="#section-12.2" class="section-number selfRef">12.2. </a><a href="#name-reinitialization" class="section-name selfRef">Reinitialization</a>
        </h3>
<p id="section-12.2-1">A group may be reinitialized by creating a new group with the same membership
and different parameters, and linking it to the old group via a resumption PSK.
The members of a group reinitialize it using the following steps:<a href="#section-12.2-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-12.2-2">
<li id="section-12.2-2.1">A member of the old group sends a ReInit proposal (see <a href="#reinit" class="xref">Section 13.1.5</a>)<a href="#section-12.2-2.1" class="pilcrow">¶</a>
</li>
          <li id="section-12.2-2.2">A member of the old group sends a Commit covering the ReInit proposal<a href="#section-12.2-2.2" class="pilcrow">¶</a>
</li>
          <li id="section-12.2-2.3">
            <p id="section-12.2-2.3.1">A member of the old group sends a Welcome message for the new group that
matches the ReInit<a href="#section-12.2-2.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.2-2.3.2.1">The <code>group_id</code>, <code>version</code>, and <code>cipher_suite</code> fields in the Welcome
message MUST be the same as the corresponding fields in the ReInit
proposal.<a href="#section-12.2-2.3.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-12.2-2.3.2.2">The <code>epoch</code> in the Welcome message MUST be 1<a href="#section-12.2-2.3.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-12.2-2.3.2.3">The Welcome MUST specify a PreSharedKey of type <code>resumption</code> with usage
<code>reinit</code>.  The <code>group_id</code> must match the old group, and the <code>epoch</code> must
indicate the epoch after the Commit covering the ReInit.<a href="#section-12.2-2.3.2.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-12.2-2.3.2.4">The <code>psk_nonce</code> included in the <code>PreSharedKeyID</code> of the resumption PSK
MUST be a randomly sampled nonce of length <code>KDF.Nh</code>, for the KDF defined
by the new group's ciphersuite.<a href="#section-12.2-2.3.2.4" class="pilcrow">¶</a>
</li>
            </ul>
</li>
        </ol>
<p id="section-12.2-3">Note that these three steps may be done by the same group member or different
members.  For example, if a group member sends a commit with an inline ReInit
proposal (steps 1 and 2), but then goes offline, another group member may send
the corresponding Welcome.  This flexibility avoids situations where a group
gets stuck between steps 2 and 3.<a href="#section-12.2-3" class="pilcrow">¶</a></p>
<p id="section-12.2-4">Resumption PSKs with usage <code>reinit</code> MUST NOT be used in other contexts.  A
PreSharedKey proposal with type <code>resumption</code> and usage <code>reinit</code> MUST be
considered invalid.<a href="#section-12.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sub-group-branching">
<section id="section-12.3">
        <h3 id="name-sub-group-branching">
<a href="#section-12.3" class="section-number selfRef">12.3. </a><a href="#name-sub-group-branching" class="section-name selfRef">Sub-group Branching</a>
        </h3>
<p id="section-12.3-1">A new group can be formed from a subset of an existing group's members, using
the same parameters as the old group.  The creator of the group indicates this
situation by including a PreSharedKey of type <code>resumption</code> with usage <code>branch</code>
in the Welcome message that creates the branched subgroup.<a href="#section-12.3-1" class="pilcrow">¶</a></p>
<p id="section-12.3-2">A client receiving a Welcome including a PreSharedKey of type <code>resumption</code> with
usage <code>branch</code> MUST verify that the new group reflects a subgroup branched from
the referenced group.<a href="#section-12.3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-12.3-3.1">The <code>version</code> and <code>ciphersuite</code> values in the Welcome MUST be the same as
those used by the old group.<a href="#section-12.3-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-12.3-3.2">Each LeafNode in the new group's tree MUST be a leaf in the
old group's tree at the epoch indicated in the PreSharedKey.<a href="#section-12.3-3.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-12.3-4">In addition, to avoid key re-use, the <code>psk_nonce</code> included in the
<code>PreSharedKeyID</code> object MUST be a randomly sampled nonce of length <code>KDF.Nh</code>.<a href="#section-12.3-4" class="pilcrow">¶</a></p>
<p id="section-12.3-5">Resumption PSKs with usage <code>branch</code> MUST NOT be used in other contexts.  A
PreSharedKey proposal with type <code>resumption</code> and usage <code>branch</code> MUST be
considered invalid.<a href="#section-12.3-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="group-evolution">
<section id="section-13">
      <h2 id="name-group-evolution">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-group-evolution" class="section-name selfRef">Group Evolution</a>
      </h2>
<p id="section-13-1">Over the lifetime of a group, its membership can change, and existing members
might want to change their keys in order to achieve post-compromise security.
In MLS, each such change is accomplished by a two-step process:<a href="#section-13-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-13-2">
<li id="section-13-2.1">A proposal to make the change is broadcast to the group in a Proposal message<a href="#section-13-2.1" class="pilcrow">¶</a>
</li>
        <li id="section-13-2.2">A member of the group or a new member broadcasts a Commit message that causes
one or more proposed changes to enter into effect<a href="#section-13-2.2" class="pilcrow">¶</a>
</li>
      </ol>
<p id="section-13-3">In cases where the Proposal and Commit are sent by the same member, these two steps
can be combined by sending the proposals in the commit.<a href="#section-13-3" class="pilcrow">¶</a></p>
<p id="section-13-4">The group thus evolves from one cryptographic state to another each time a
Commit message is sent and processed.  These states are referred to as "epochs"
and are uniquely identified among states of the group by eight-octet epoch values.
When a new group is initialized, its initial state epoch is 0x0000000000000000.  Each time
a state transition occurs, the epoch number is incremented by one.<a href="#section-13-4" class="pilcrow">¶</a></p>
<div id="proposals">
<section id="section-13.1">
        <h3 id="name-proposals">
<a href="#section-13.1" class="section-number selfRef">13.1. </a><a href="#name-proposals" class="section-name selfRef">Proposals</a>
        </h3>
<p id="section-13.1-1">Proposals are included in an MLSMessageContent by way of a Proposal structure
that indicates their type:<a href="#section-13.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.1-2">
<pre>
// See IANA registry for registered values
uint16 ProposalType;

struct {
    ProposalType msg_type;
    select (Proposal.msg_type) {
        case add:                      Add;
        case update:                   Update;
        case remove:                   Remove;
        case psk:                      PreSharedKey;
        case reinit:                   ReInit;
        case external_init:            ExternalInit;
        case app_ack:                  AppAck;
        case group_context_extensions: GroupContextExtensions;
    };
} Proposal;
</pre><a href="#section-13.1-2" class="pilcrow">¶</a>
</div>
<p id="section-13.1-3">On receiving an MLSMessageContent containing a Proposal, a client MUST verify the
signature inside MLSMessageAuth.  If the signature verifies
successfully, then the Proposal should be cached in such a way that it can be
retrieved by hash (as a ProposalOrRef object) in a later Commit message.<a href="#section-13.1-3" class="pilcrow">¶</a></p>
<div id="add">
<section id="section-13.1.1">
          <h4 id="name-add">
<a href="#section-13.1.1" class="section-number selfRef">13.1.1. </a><a href="#name-add" class="section-name selfRef">Add</a>
          </h4>
<p id="section-13.1.1-1">An Add proposal requests that a client with a specified KeyPackage be added
to the group.  The proposer of the Add MUST verify the validity of the
KeyPackage, as specified in <a href="#keypackage-validation" class="xref">Section 11.1</a>.<a href="#section-13.1.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.1.1-2">
<pre>
struct {
    KeyPackage key_package;
} Add;
</pre><a href="#section-13.1.1-2" class="pilcrow">¶</a>
</div>
<p id="section-13.1.1-3">An Add is applied after being included in a Commit message.  The position of the
Add in the list of proposals determines the leaf node where the new member will
be added.  For the first Add in the Commit, the corresponding new member will be
placed in the leftmost empty leaf in the tree, for the second Add, the next
empty leaf to the right, etc. If no empty leaf exists, the tree is extended to
the right.<a href="#section-13.1.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.1.1-4.1">Validate the KeyPackage as specified in <a href="#keypackage-validation" class="xref">Section 11.1</a>.  The
<code>leaf_node_source</code> field in the LeafNode MUST be set to <code>key_package</code>.<a href="#section-13.1.1-4.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.1-4.2">Identify the leaf L for the new member: if there are empty leaves in the tree,
L is the leftmost empty leaf.  Otherwise, the tree is extended to the right
by one leaf node and L is the new leaf.<a href="#section-13.1.1-4.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.1-4.3">For each non-blank intermediate node along the path from the leaf L
to the root, add L's leaf index to the <code>unmerged_leaves</code> list for the node.<a href="#section-13.1.1-4.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.1-4.4">Set the leaf node L to a new node containing the LeafNode object carried in
the <code>leaf_node</code> field of the KeyPackage in the Add.<a href="#section-13.1.1-4.4" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="update">
<section id="section-13.1.2">
          <h4 id="name-update">
<a href="#section-13.1.2" class="section-number selfRef">13.1.2. </a><a href="#name-update" class="section-name selfRef">Update</a>
          </h4>
<p id="section-13.1.2-1">An Update proposal is a similar mechanism to Add with the distinction
that it replaces the sender's LeafNode in the tree instead of adding a new leaf
to the tree.<a href="#section-13.1.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.1.2-2">
<pre>
struct {
    LeafNode leaf_node;
} Update;
</pre><a href="#section-13.1.2-2" class="pilcrow">¶</a>
</div>
<p id="section-13.1.2-3">A member of the group applies an Update message by taking the following steps:<a href="#section-13.1.2-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.1.2-4.1">Validate the LeafNode as specified in <a href="#leaf-node-validation" class="xref">Section 8.3</a>.  The
<code>leaf_node_source</code> field MUST be set to <code>update</code>.<a href="#section-13.1.2-4.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.2-4.2">Verify that the <code>public_key</code> value in the LeafNode is different from the
corresponding field in the LeafNode being replaced.<a href="#section-13.1.2-4.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.2-4.3">Replace the sender's LeafNode with the one contained in the Update proposal<a href="#section-13.1.2-4.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.2-4.4">Blank the intermediate nodes along the path from the sender's leaf to the root<a href="#section-13.1.2-4.4" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="remove">
<section id="section-13.1.3">
          <h4 id="name-remove">
<a href="#section-13.1.3" class="section-number selfRef">13.1.3. </a><a href="#name-remove" class="section-name selfRef">Remove</a>
          </h4>
<p id="section-13.1.3-1">A Remove proposal requests that the member with LeafNodeRef <code>removed</code> be removed
from the group.<a href="#section-13.1.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.1.3-2">
<pre>
struct {
    LeafNodeRef removed;
} Remove;
</pre><a href="#section-13.1.3-2" class="pilcrow">¶</a>
</div>
<p id="section-13.1.3-3">A member of the group applies a Remove message by taking the following steps:<a href="#section-13.1.3-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.1.3-4.1">Identify a leaf node matching <code>removed</code>.  This lookup MUST be done on the tree
before any non-Remove proposals have been applied (the "old" tree in the
terminology of <a href="#commit" class="xref">Section 13.2</a>), since proposals such as Update can change the
LeafNode stored at a leaf.  Let L be this leaf node.<a href="#section-13.1.3-4.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.3-4.2">Replace the leaf node L with a blank node<a href="#section-13.1.3-4.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.3-4.3">Blank the intermediate nodes along the path from L to the root<a href="#section-13.1.3-4.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.3-4.4">Truncate the tree by removing leaves from the right side of the tree until the
rightmost leaf node is not blank.<a href="#section-13.1.3-4.4" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="presharedkey">
<section id="section-13.1.4">
          <h4 id="name-presharedkey">
<a href="#section-13.1.4" class="section-number selfRef">13.1.4. </a><a href="#name-presharedkey" class="section-name selfRef">PreSharedKey</a>
          </h4>
<p id="section-13.1.4-1">A PreSharedKey proposal can be used to request that a pre-shared key be
injected into the key schedule in the process of advancing the epoch.<a href="#section-13.1.4-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.1.4-2">
<pre>
struct {
    PreSharedKeyID psk;
} PreSharedKey;
</pre><a href="#section-13.1.4-2" class="pilcrow">¶</a>
</div>
<p id="section-13.1.4-3">The <code>psktype</code> of the pre-shared key MUST be <code>external</code> and the <code>psk_nonce</code> MUST
be a randomly sampled nonce of length <code>KDF.Nh</code>. When processing a Commit message
that includes one or more PreSharedKey proposals, group members derive
<code>psk_secret</code> as described in <a href="#pre-shared-keys" class="xref">Section 9.4</a>, where the order of the PSKs
corresponds to the order of the <code>PreSharedKey</code> proposals in the Commit.<a href="#section-13.1.4-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="reinit">
<section id="section-13.1.5">
          <h4 id="name-reinit">
<a href="#section-13.1.5" class="section-number selfRef">13.1.5. </a><a href="#name-reinit" class="section-name selfRef">ReInit</a>
          </h4>
<p id="section-13.1.5-1">A ReInit proposal represents a request to reinitialize the group with different
parameters, for example, to increase the version number or to change the
ciphersuite. The reinitialization is done by creating a completely new group
and shutting down the old one.<a href="#section-13.1.5-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.1.5-2">
<pre>
struct {
    opaque group_id&lt;V&gt;;
    ProtocolVersion version;
    CipherSuite cipher_suite;
    Extension extensions&lt;V&gt;;
} ReInit;
</pre><a href="#section-13.1.5-2" class="pilcrow">¶</a>
</div>
<p id="section-13.1.5-3">A member of the group applies a ReInit proposal by waiting for the committer to
send the Welcome message that matches the ReInit, according to the criteria in
<a href="#reinitialization" class="xref">Section 12.2</a>.<a href="#section-13.1.5-3" class="pilcrow">¶</a></p>
<p id="section-13.1.5-4">If a ReInit proposal is included in a Commit, it MUST be the only proposal
referenced by the Commit. If other non-ReInit proposals have been sent during
the epoch, the committer SHOULD prefer them over the ReInit proposal, allowing
the ReInit to be resent and applied in a subsequent epoch. The <code>version</code> field
in the ReInit proposal MUST be no less than the version for the current group.<a href="#section-13.1.5-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="externalinit">
<section id="section-13.1.6">
          <h4 id="name-externalinit">
<a href="#section-13.1.6" class="section-number selfRef">13.1.6. </a><a href="#name-externalinit" class="section-name selfRef">ExternalInit</a>
          </h4>
<p id="section-13.1.6-1">An ExternalInit proposal is used by new members that want to join a group by
using an external commit. This proposal can only be used in that context.<a href="#section-13.1.6-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.1.6-2">
<pre>
struct {
  opaque kem_output&lt;V&gt;;
} ExternalInit;
</pre><a href="#section-13.1.6-2" class="pilcrow">¶</a>
</div>
<p id="section-13.1.6-3">A member of the group applies an ExternalInit message by initializing the next
epoch using an init secret computed as described in <a href="#external-initialization" class="xref">Section 9.3</a>.
The <code>kem_output</code> field contains the required KEM output.<a href="#section-13.1.6-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="appack">
<section id="section-13.1.7">
          <h4 id="name-appack">
<a href="#section-13.1.7" class="section-number selfRef">13.1.7. </a><a href="#name-appack" class="section-name selfRef">AppAck</a>
          </h4>
<p id="section-13.1.7-1">An AppAck proposal is used to acknowledge receipt of application messages.
Though this information implies no change to the group, it is structured as a
Proposal message so that it is included in the group's transcript by being
included in Commit messages.<a href="#section-13.1.7-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.1.7-2">
<pre>
struct {
    LeafNodeRef sender;
    uint32 first_generation;
    uint32 last_generation;
} MessageRange;

struct {
    MessageRange received_ranges&lt;V&gt;;
} AppAck;
</pre><a href="#section-13.1.7-2" class="pilcrow">¶</a>
</div>
<p id="section-13.1.7-3">An AppAck proposal represents a set of messages received by the sender in the
current epoch.  Messages are represented by the <code>sender</code> and <code>generation</code> values
in the MLSCiphertext for the message.  Each MessageRange represents receipt of a
span of messages whose <code>generation</code> values form a continuous range from
<code>first_generation</code> to <code>last_generation</code>, inclusive.<a href="#section-13.1.7-3" class="pilcrow">¶</a></p>
<p id="section-13.1.7-4">AppAck proposals are sent as a guard against the Delivery Service dropping
application messages.  The sequential nature of the <code>generation</code> field provides
a degree of loss detection, since gaps in the <code>generation</code> sequence indicate
dropped messages.  AppAck completes this story by addressing the scenario where
the Delivery Service drops all messages after a certain point, so that a later
generation is never observed.  Obviously, there is a risk that AppAck messages
could be suppressed as well, but their inclusion in the transcript means that if
they are suppressed then the group cannot advance at all.<a href="#section-13.1.7-4" class="pilcrow">¶</a></p>
<p id="section-13.1.7-5">The schedule on which sending AppAck proposals are sent is up to the application,
and determines which cases of loss/suppression are detected.  For example:<a href="#section-13.1.7-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.1.7-6.1">The application might have the committer include an AppAck proposal whenever a
Commit is sent, so that other members could know when one of their messages
did not reach the committer.<a href="#section-13.1.7-6.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.7-6.2">The application could have a client send an AppAck whenever an application
message is sent, covering all messages received since its last AppAck.  This
would provide a complete view of any losses experienced by active members.<a href="#section-13.1.7-6.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.7-6.3">The application could simply have clients send AppAck proposals on a timer, so
that all participants' state would be known.<a href="#section-13.1.7-6.3" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-13.1.7-7">An application using AppAck proposals to guard against loss/suppression of
application messages also needs to ensure that AppAck messages and the Commits
that reference them are not dropped.  One way to do this is to always encrypt
Proposal and Commit messages, to make it more difficult for the Delivery Service
to recognize which messages contain AppAcks.  The application can also have
clients enforce an AppAck schedule, reporting loss if an AppAck is not received
at the expected time.<a href="#section-13.1.7-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="groupcontextextensions">
<section id="section-13.1.8">
          <h4 id="name-groupcontextextensions">
<a href="#section-13.1.8" class="section-number selfRef">13.1.8. </a><a href="#name-groupcontextextensions" class="section-name selfRef">GroupContextExtensions</a>
          </h4>
<p id="section-13.1.8-1">A GroupContextExtensions proposal is used to update the list of extensions in
the GroupContext for the group.<a href="#section-13.1.8-1" class="pilcrow">¶</a></p>
<p id="section-13.1.8-2"><code>
struct {
  Extension extensions&lt;V&gt;;
} GroupContextExtensions;
</code><a href="#section-13.1.8-2" class="pilcrow">¶</a></p>
<p id="section-13.1.8-3">A member of the group applies a GroupContextExtensions proposal with the
following steps:<a href="#section-13.1.8-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.1.8-4.1">If the new extensions include a <code>required_capabilities</code> extension, verify that
all members of the group support the required capabilities (including those
added in the same commit, and excluding those removed).<a href="#section-13.1.8-4.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.1.8-4.2">Remove all of the existing extensions from the GroupContext object for the
group and replacing them with the list of extensions in the proposal.  (This
is a wholesale replacement, not a merge.  An extension is only carried over if
the sender of the proposal includes it in the new list.)<a href="#section-13.1.8-4.2" class="pilcrow">¶</a>
</li>
          </ul>
<p id="section-13.1.8-5">Note that once the GroupContext is updated, its inclusion in the
confirmation_tag by way of the key schedule will confirm that all members of the
group agree on the extensions in use.<a href="#section-13.1.8-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="external-proposals">
<section id="section-13.1.9">
          <h4 id="name-external-proposals">
<a href="#section-13.1.9" class="section-number selfRef">13.1.9. </a><a href="#name-external-proposals" class="section-name selfRef">External Proposals</a>
          </h4>
<p id="section-13.1.9-1">Add and Remove proposals can be constructed and sent to the group by a party
that is outside the group.  For example, a Delivery Service might propose to
remove a member of a group who has been inactive for a long time, or propose adding
a newly-hired staff member to a group representing a real-world team.  Proposals
originating outside the group are identified by a <code>preconfigured</code> or
<code>new_member</code> SenderType in MLSPlaintext.<a href="#section-13.1.9-1" class="pilcrow">¶</a></p>
<p id="section-13.1.9-2">ReInit proposals can also be sent to the group by a <code>preconfigured</code> sender, for
example to enforce a changed policy regarding MLS version or ciphersuite.<a href="#section-13.1.9-2" class="pilcrow">¶</a></p>
<p id="section-13.1.9-3">The <code>new_member</code> SenderType is used for clients proposing that they themselves
be added.  For this ID type the sender value MUST be zero and the Proposal type
MUST be Add. The MLSPlaintext MUST be signed with the private key corresponding
to the KeyPackage in the Add message.  Recipients MUST verify that the
MLSPlaintext carrying the Proposal message is validly signed with this key.<a href="#section-13.1.9-3" class="pilcrow">¶</a></p>
<p id="section-13.1.9-4">The <code>preconfigured</code> SenderType is reserved for signers that are pre-provisioned
to the clients within a group.  If proposals with these sender IDs are to be
accepted within a group, the members of the group MUST be provisioned by the
application with a mapping between these IDs and authorized signing keys.
Recipients MUST verify that the MLSPlaintext carrying the Proposal message is
validly signed with the corresponding key. To ensure consistent handling of
external proposals, the application MUST ensure that the members of a group
have the same mapping and apply the same policies to external proposals.<a href="#section-13.1.9-4" class="pilcrow">¶</a></p>
<p id="section-13.1.9-5">An external proposal MUST be sent as an MLSPlaintext
object, since the sender will not have the keys necessary to construct an
MLSCiphertext object.<a href="#section-13.1.9-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="commit">
<section id="section-13.2">
        <h3 id="name-commit">
<a href="#section-13.2" class="section-number selfRef">13.2. </a><a href="#name-commit" class="section-name selfRef">Commit</a>
        </h3>
<p id="section-13.2-1">A Commit message initiates a new epoch for the group, based on a collection of
Proposals. It instructs group members to update their representation of the
state of the group by applying the proposals and advancing the key schedule.<a href="#section-13.2-1" class="pilcrow">¶</a></p>
<p id="section-13.2-2">Each proposal covered by the Commit is included by a ProposalOrRef value, which
identifies the proposal to be applied by value or by reference.  Commits that
refer to new Proposals from the committer can be included by value. Commits
for previously sent proposals from anyone (including the committer) can be sent
by reference.  Proposals sent by reference are specified by including the hash of
the MLSPlaintext in which the proposal was sent (see <a href="#hash-based-identifiers" class="xref">Section 6.2</a>).<a href="#section-13.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.2-3">
<pre>
enum {
  reserved(0),
  proposal(1)
  reference(2),
  (255)
} ProposalOrRefType;

struct {
  ProposalOrRefType type;
  select (ProposalOrRef.type) {
    case proposal:  Proposal proposal;
    case reference: ProposalRef reference;
  }
} ProposalOrRef;

struct {
    ProposalOrRef proposals&lt;V&gt;;
    optional&lt;UpdatePath&gt; path;
} Commit;
</pre><a href="#section-13.2-3" class="pilcrow">¶</a>
</div>
<p id="section-13.2-4">A group member that has observed one or more valid proposals within an epoch MUST send
a Commit message before sending application data. This ensures, for example,
that any members whose removal was proposed during the epoch are actually
removed before any application data is transmitted.<a href="#section-13.2-4" class="pilcrow">¶</a></p>
<p id="section-13.2-5">The sender of a Commit MUST include all valid proposals that it has received
during the current epoch. Invalid proposals include, for example, proposals with
an invalid signature or proposals that are semantically invalid, such as an Add
when the sender does not have the application-level permission to add new users.
Proposals with a non-default proposal type MUST NOT be included in a commit
unless the proposal type is supported by all the members of the group that will
process the Commit (i.e., not including any members being added or removed by
the Commit).<a href="#section-13.2-5" class="pilcrow">¶</a></p>
<p id="section-13.2-6">If there are multiple proposals that apply to the same leaf, or multiple
PreSharedKey proposals that reference the same PreSharedKeyID, the committer
MUST choose one and include only that one in the Commit, considering the rest
invalid. The committer MUST NOT include any Update proposals generated by the
committer, since they would be duplicative with the <code>path</code> field in the Commit.
The committer MUST prefer any Remove received, or the most recent Update for
the leaf if there are no Removes. If there are multiple Add proposals
containing KeyPackages that the committer considers to represent the same
client or a client already in the group (for example, identical KeyPackages or
KeyPackages sharing the same Credential), the committer again chooses one to
include and considers the rest invalid. The committer MUST consider invalid any
Add or Update proposal if the Credential in the contained KeyPackage shares the
same signature key with a Credential in any leaf of the group, or if the
LeafNode in the KeyPackage shares the same <code>public_key</code> with another LeafNode in
the group.<a href="#section-13.2-6" class="pilcrow">¶</a></p>
<p id="section-13.2-7">The Commit MUST NOT combine proposals sent within different epochs. Due to the
asynchronous nature of proposals, receivers of a Commit SHOULD NOT enforce that
all valid proposals sent within the current epoch are referenced by the next
Commit. In the event that a valid proposal is omitted from the next Commit, and
that proposal is still valid in the current epoch, the sender of the proposal
MAY resend it after updating it to reflect the current epoch.<a href="#section-13.2-7" class="pilcrow">¶</a></p>
<p id="section-13.2-8">A member of the group MAY send a Commit that references no proposals at all,
which would thus have an empty <code>proposals</code> vector.  Such
a Commit resets the sender's leaf and the nodes along its direct path, and
provides forward secrecy and post-compromise security with regard to the sender
of the Commit.  An Update proposal can be regarded as a "lazy" version of this
operation, where only the leaf changes and intermediate nodes are blanked out.<a href="#section-13.2-8" class="pilcrow">¶</a></p>
<p id="section-13.2-9">By default, the <code>path</code> field of a Commit MUST be populated.  The <code>path</code> field
MAY be omitted if (a) it covers at least one proposal and (b) none of the proposals
covered by the Commit are of "path required" types.  A proposal type requires a
path if it cannot change the group membership in a way that requires the forward
secrecy and post-compromise security guarantees that an UpdatePath provides.
The only proposal types defined in this document that do not require a path are:<a href="#section-13.2-9" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2-10.1">
            <code>add</code><a href="#section-13.2-10.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-13.2-10.2">
            <code>psk</code><a href="#section-13.2-10.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-13.2-10.3">
            <code>app_ack</code><a href="#section-13.2-10.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-13.2-10.4">
            <code>reinit</code><a href="#section-13.2-10.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-13.2-11">New proposal types MUST state whether they require a path. If any instance of a
proposal type requires a path, then the proposal type requires a path. This
attribute of a proposal type is reflected in the "Path Required" field of the
proposal type registry defined in <a href="#mls-proposal-types" class="xref">Section 18.3</a>.<a href="#section-13.2-11" class="pilcrow">¶</a></p>
<p id="section-13.2-12">Update and Remove proposals are the clearest examples of proposals that require
a path.  An UpdatePath is required to evict the removed member or the old
appearance of the updated member.<a href="#section-13.2-12" class="pilcrow">¶</a></p>
<p id="section-13.2-13">In pseudocode, the logic for validating the <code>path</code> field of a Commit is as
follows:<a href="#section-13.2-13" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.2-14">
<pre>
pathRequiredTypes = [
    update,
    remove,
    external_init,
    group_context_extensions
]

pathRequired = false

for i, id in commit.proposals:
    proposal = proposalCache[id]
    assert(proposal != null)

    pathRequired = pathRequired ||
                   (proposal.msg_type in pathRequiredTypes)

if len(commit.proposals) == 0 || pathRequired:
    assert(commit.path != null)
</pre><a href="#section-13.2-14" class="pilcrow">¶</a>
</div>
<p id="section-13.2-15">To summarize, a Commit can have three different configurations, with different
uses:<a href="#section-13.2-15" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-13.2-16">
<li id="section-13.2-16.1">An "empty" Commit that references no proposals, which updates the committer's
contribution to the group and provides PCS with regard to the committer.<a href="#section-13.2-16.1" class="pilcrow">¶</a>
</li>
          <li id="section-13.2-16.2">A "partial" Commit that references proposals that do not require a path, and
where the path is empty. Such a commit doesn't provide PCS with regard to the
committer.<a href="#section-13.2-16.2" class="pilcrow">¶</a>
</li>
          <li id="section-13.2-16.3">A "full" Commit that references proposals of any type, which provides FS with
regard to any removed members and PCS for the committer and any updated
members.<a href="#section-13.2-16.3" class="pilcrow">¶</a>
</li>
        </ol>
<div id="creating-a-commit">
<section id="section-13.2.1">
          <h4 id="name-creating-a-commit">
<a href="#section-13.2.1" class="section-number selfRef">13.2.1. </a><a href="#name-creating-a-commit" class="section-name selfRef">Creating a Commit</a>
          </h4>
<p id="section-13.2.1-1">When creating or processing a Commit, three different ratchet trees and
their associated GroupContexts are used:<a href="#section-13.2.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-13.2.1-2">
<li id="section-13.2.1-2.1">"Old" refers to the ratchet tree and GroupContext for the epoch before the
commit.  The old GroupContext is used when signing the MLSPlainText so that
existing group members can verify the signature before processing the
commit.<a href="#section-13.2.1-2.1" class="pilcrow">¶</a>
</li>
            <li id="section-13.2.1-2.2">"Provisional" refers to the ratchet tree and GroupContext constructed after
applying the proposals that are referenced by the Commit.  The provisional
GroupContext uses the epoch number for the new epoch, and the old confirmed
transcript hash.  This is used when creating the UpdatePath, if the
UpdatePath is needed.<a href="#section-13.2.1-2.2" class="pilcrow">¶</a>
</li>
            <li id="section-13.2.1-2.3">"New" refers to the ratchet tree and GroupContext constructed after applying
the proposals and the UpdatePath (if any).  The new GroupContext uses the
epoch number for the new epoch, and the new confirmed transcript hash.  This
is used when deriving the new epoch secrets, and is the only GroupContext
that newly-added members will have.<a href="#section-13.2.1-2.3" class="pilcrow">¶</a>
</li>
          </ol>
<p id="section-13.2.1-3">A member of the group creates a Commit message and the corresponding Welcome
message at the same time, by taking the following steps:<a href="#section-13.2.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.1-4.1">Construct an initial Commit object with the <code>proposals</code>
field populated from Proposals received during the current epoch, and an empty
<code>path</code> field.<a href="#section-13.2.1-4.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.1-4.2">
              <p id="section-13.2.1-4.2.1">Generate the provisional ratchet tree and GroupContext by applying the proposals
referenced in the initial Commit object, as described in <a href="#proposals" class="xref">Section 13.1</a>. Update
proposals are applied first, followed by Remove proposals, and then finally
Add proposals. Add proposals are applied in the order listed in the
<code>proposals</code> vector, and always to the leftmost unoccupied leaf in the tree, or
the right edge of the tree if all leaves are occupied.<a href="#section-13.2.1-4.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.1-4.2.2.1">Note that the order in which different types of proposals are applied should
be updated by the implementation to include any new proposals added by
negotiated group extensions.<a href="#section-13.2.1-4.2.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.2.2.2">PreSharedKey proposals are processed later when deriving the <code>psk_secret</code> for the Key
Schedule.<a href="#section-13.2.1-4.2.2.2" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-13.2.1-4.3">Decide whether to populate the <code>path</code> field: If the <code>path</code> field is required
based on the proposals that are in the commit (see above), then it MUST be
populated.  Otherwise, the sender MAY omit the <code>path</code> field at its discretion.<a href="#section-13.2.1-4.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.1-4.4">
              <p id="section-13.2.1-4.4.1">If populating the <code>path</code> field: Create an UpdatePath using the provisional
ratchet tree and GroupContext. Any new member (from an add proposal) MUST be
excluded from the resolution during the computation of the UpdatePath.  The
<code>leaf_node</code> for this UpdatePath MUST have <code>leaf_node_source</code> set to <code>commit</code>.
Note that the LeafNode in the <code>UpdatePath</code> effectively updates an existing
LeafNode in the group and thus MUST adhere to the same restrictions as
LeafNodes used in <code>Update</code> proposals (aside from <code>leaf_node_source</code>).<a href="#section-13.2.1-4.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.1-4.4.2.1">Assign this UpdatePath to the <code>path</code> field in the Commit.<a href="#section-13.2.1-4.4.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.4.2.2">Apply the UpdatePath to the tree, as described in
<a href="#synchronizing-views-of-the-tree" class="xref">Section 8.6</a>, creating the new ratchet tree. Define
<code>commit_secret</code> as the value <code>path_secret[n+1]</code> derived from the
<code>path_secret[n]</code> value assigned to the root node.<a href="#section-13.2.1-4.4.2.2" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-13.2.1-4.5">If not populating the <code>path</code> field: Set the <code>path</code> field in the Commit to the
null optional.  Define <code>commit_secret</code> as the all-zero vector of length
<code>KDF.Nh</code> (the same length as a <code>path_secret</code> value would be).  In this case,
the new ratchet tree is the same as the provisional ratchet tree.<a href="#section-13.2.1-4.5" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.1-4.6">Derive the <code>psk_secret</code> as specified in <a href="#pre-shared-keys" class="xref">Section 9.4</a>, where the order
of PSKs in the derivation corresponds to the order of PreSharedKey proposals
in the <code>proposals</code> vector.<a href="#section-13.2.1-4.6" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.1-4.7">
              <p id="section-13.2.1-4.7.1">Construct an MLSMessageContent object containing the Commit object. Sign the
MLSMessageContent using the old GroupContext as context.<a href="#section-13.2.1-4.7.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.1-4.7.2.1">Use the MLSMessageContent to update the confirmed transcript hash and generate
the new GroupContext.<a href="#section-13.2.1-4.7.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.7.2.2">Use the <code>init_secret</code> from the previous epoch, the <code>commit_secret</code> and the
<code>psk_secret</code> as defined in the previous steps, and the new GroupContext to
compute the new <code>joiner_secret</code>, <code>welcome_secret</code>, <code>epoch_secret</code>, and
derived secrets for the new epoch.<a href="#section-13.2.1-4.7.2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.7.2.3">Use the <code>confirmation_key</code> for the new epoch to compute the
<code>confirmation_tag</code> value, and the <code>membership_key</code> for the old epoch to
compute the <code>membership_tag</code> value in the MLSPlaintext.<a href="#section-13.2.1-4.7.2.3" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.7.2.4">Calculate the interim transcript hash using the new confirmed transcript
hash and the <code>confirmation_tag</code> from the MLSMessageAuth.<a href="#section-13.2.1-4.7.2.4" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-13.2.1-4.8">
              <p id="section-13.2.1-4.8.1">Construct a GroupInfo reflecting the new state:<a href="#section-13.2.1-4.8.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.1-4.8.2.1">Group ID, epoch, tree, confirmed transcript hash, interim transcript
hash, and group context extensions from the new state<a href="#section-13.2.1-4.8.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.8.2.2">The confirmation_tag from the MLSMessageAuth object<a href="#section-13.2.1-4.8.2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.8.2.3">Other extensions as defined by the application<a href="#section-13.2.1-4.8.2.3" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.8.2.4">Optionally derive an external keypair as described in <a href="#key-schedule" class="xref">Section 9</a>
(required for External Commits, see <a href="#joining-via-external-commits" class="xref">Section 13.2.3.1</a>)<a href="#section-13.2.1-4.8.2.4" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.8.2.5">Sign the GroupInfo using the member's private signing key<a href="#section-13.2.1-4.8.2.5" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.8.2.6">Encrypt the GroupInfo using the key and nonce derived from the <code>joiner_secret</code>
for the new epoch (see <a href="#joining-via-welcome-message" class="xref">Section 13.2.3.2</a>)<a href="#section-13.2.1-4.8.2.6" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-13.2.1-4.9">
              <p id="section-13.2.1-4.9.1">For each new member in the group:<a href="#section-13.2.1-4.9.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.1-4.9.2.1">Identify the lowest common ancestor in the tree of the new member's
leaf node and the member sending the Commit<a href="#section-13.2.1-4.9.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.9.2.2">If the <code>path</code> field was populated above: Compute the path secret
corresponding to the common ancestor node<a href="#section-13.2.1-4.9.2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.9.2.3">Compute an EncryptedGroupSecrets object that encapsulates the <code>init_secret</code>
for the current epoch and the path secret (if present).<a href="#section-13.2.1-4.9.2.3" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-13.2.1-4.10">Construct a Welcome message from the encrypted GroupInfo object, the encrypted
key packages, and any PSKs for which a proposal was included in the Commit. The
order of the <code>psks</code> MUST be the same as the order of PreSharedKey proposals in the
<code>proposals</code> vector.<a href="#section-13.2.1-4.10" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.1-4.11">
              <p id="section-13.2.1-4.11.1">If a ReInit proposal was part of the Commit, the committer MUST create a new
group with the parameters specified in the ReInit proposal,
and with the same members as the original group.
The Welcome message MUST include a <code>PreSharedKeyID</code> with the following
parameters:<a href="#section-13.2.1-4.11.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.1-4.11.2.1">
                  <code>psktype</code>: <code>resumption</code><a href="#section-13.2.1-4.11.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.11.2.2">
                  <code>usage</code>: <code>reinit</code><a href="#section-13.2.1-4.11.2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.11.2.3">
                  <code>group_id</code>: The group ID for the current group<a href="#section-13.2.1-4.11.2.3" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.1-4.11.2.4">
                  <code>epoch</code>: The epoch that the group will be in after this Commit<a href="#section-13.2.1-4.11.2.4" class="pilcrow">¶</a>
</li>
              </ul>
</li>
          </ul>
</section>
</div>
<div id="processing-a-commit">
<section id="section-13.2.2">
          <h4 id="name-processing-a-commit">
<a href="#section-13.2.2" class="section-number selfRef">13.2.2. </a><a href="#name-processing-a-commit" class="section-name selfRef">Processing a Commit</a>
          </h4>
<p id="section-13.2.2-1">A member of the group applies a Commit message by taking the following steps:<a href="#section-13.2.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.2-2.1">Verify that the <code>epoch</code> field of the enclosing MLSMessageContent is equal
to the <code>epoch</code> field of the current GroupContext object<a href="#section-13.2.2-2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.2">Verify that the signature on the MLSMessageContent message verifies using the
public key from the credential stored at the leaf in the tree indicated by
the <code>sender</code> field.<a href="#section-13.2.2-2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.3">Verify that all PreSharedKey proposals in the <code>proposals</code> vector have unique
PreSharedKeyIDs and are available.<a href="#section-13.2.2-2.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.4">
              <p id="section-13.2.2-2.4.1">Generate the provisional ratchet tree and GroupContext by applying the proposals
referenced in the initial Commit object, as described in <a href="#proposals" class="xref">Section 13.1</a>. Update
proposals are applied first, followed by Remove proposals, and then finally
Add proposals. Add proposals are applied in the order listed in the
<code>proposals</code> vector, and always to the leftmost unoccupied leaf in the tree, or
the right edge of the tree if all leaves are occupied.<a href="#section-13.2.2-2.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.2-2.4.2.1">Note that the order in which different types of proposals are applied should
be updated by the implementation to include any new proposals added by
negotiated group extensions.<a href="#section-13.2.2-2.4.2.1" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-13.2.2-2.5">Verify that the <code>path</code> value is populated if the <code>proposals</code> vector contains
any Update or Remove proposals, or if it's empty. Otherwise, the <code>path</code> value
MAY be omitted.<a href="#section-13.2.2-2.5" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.6">
              <p id="section-13.2.2-2.6.1">If the <code>path</code> value is populated: Process the <code>path</code> value using the
provisional ratchet tree and GroupContext, to generate the new ratchet tree
and the <code>commit_secret</code>:<a href="#section-13.2.2-2.6.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.2-2.6.2.1">Validate the LeafNode as specified in <a href="#leaf-node-validation" class="xref">Section 8.3</a>.  The
<code>leaf_node_source</code> field MUST be set to <code>commit</code>.<a href="#section-13.2.2-2.6.2.1" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.2-2.6.2.2">Verify that the <code>public_key</code> value in the LeafNode is different from the
committer's current leaf node.<a href="#section-13.2.2-2.6.2.2" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.2-2.6.2.3">Apply the UpdatePath to the tree, as described in
<a href="#synchronizing-views-of-the-tree" class="xref">Section 8.6</a>, and store <code>leaf_node</code> at the
committer's leaf.<a href="#section-13.2.2-2.6.2.3" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.2-2.6.2.4">Verify that the LeafNode has a <code>parent_hash</code> field and that its value
matches the new parent of the sender's leaf node.<a href="#section-13.2.2-2.6.2.4" class="pilcrow">¶</a>
</li>
                <li class="normal" id="section-13.2.2-2.6.2.5">Define <code>commit_secret</code> as the value <code>path_secret[n+1]</code> derived from the
<code>path_secret[n]</code> value assigned to the root node.<a href="#section-13.2.2-2.6.2.5" class="pilcrow">¶</a>
</li>
              </ul>
</li>
            <li class="normal" id="section-13.2.2-2.7">If the <code>path</code> value is not populated: Define <code>commit_secret</code> as the all-zero
vector of length <code>KDF.Nh</code> (the same length as a <code>path_secret</code> value would be).<a href="#section-13.2.2-2.7" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.8">Update the confirmed and interim transcript hashes using the new Commit, and
generate the new GroupContext.<a href="#section-13.2.2-2.8" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.9">Derive the <code>psk_secret</code> as specified in <a href="#pre-shared-keys" class="xref">Section 9.4</a>, where the order
of PSKs in the derivation corresponds to the order of PreSharedKey proposals
in the <code>proposals</code> vector.<a href="#section-13.2.2-2.9" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.10">Use the <code>init_secret</code> from the previous epoch, the <code>commit_secret</code> and the
<code>psk_secret</code> as defined in the previous steps, and the new GroupContext to
compute the new <code>joiner_secret</code>, <code>welcome_secret</code>, <code>epoch_secret</code>, and
derived secrets for the new epoch.<a href="#section-13.2.2-2.10" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.11">Use the <code>confirmation_key</code> for the new epoch to compute the confirmation tag
for this message, as described below, and verify that it is the same as the
<code>confirmation_tag</code> field in the MLSMessageAuth object.<a href="#section-13.2.2-2.11" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.12">If the above checks are successful, consider the new GroupContext object
as the current state of the group.<a href="#section-13.2.2-2.12" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-13.2.2-2.13">If the Commit included a ReInit proposal, the client MUST NOT use the group to
send messages anymore. Instead, it MUST wait for a Welcome message from the committer
meeting the requirements of <a href="#reinitialization" class="xref">Section 12.2</a>.<a href="#section-13.2.2-2.13" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="adding-members-to-the-group">
<section id="section-13.2.3">
          <h4 id="name-adding-members-to-the-group">
<a href="#section-13.2.3" class="section-number selfRef">13.2.3. </a><a href="#name-adding-members-to-the-group" class="section-name selfRef">Adding Members to the Group</a>
          </h4>
<p id="section-13.2.3-1">New members can join the group in two ways. Either by being added by a group
member, or by adding themselves through an external Commit. In both cases, the
new members need information to bootstrap their local group state.<a href="#section-13.2.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.2.3-2">
<pre>
struct {
    CipherSuite cipher_suite;
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    opaque tree_hash&lt;V&gt;;
    opaque confirmed_transcript_hash&lt;V&gt;;
    Extension group_context_extensions&lt;V&gt;;
    Extension other_extensions&lt;V&gt;;
    MAC confirmation_tag;
    LeafNodeRef signer;
    // SignWithLabel(., "GroupInfoTBS", GroupInfoTBS)
    opaque signature&lt;V&gt;;
} GroupInfo;
</pre><a href="#section-13.2.3-2" class="pilcrow">¶</a>
</div>
<p id="section-13.2.3-3">New members MUST verify the <code>signature</code> using the public key taken from the
credential in the leaf node of the member with LeafNodeRef <code>signer</code>. The
signature covers the following structure, comprising all the fields in the
GroupInfo above <code>signature</code>:<a href="#section-13.2.3-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.2.3-4">
<pre>
struct {
    CipherSuite cipher_suite;
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    opaque tree_hash&lt;V&gt;;
    opaque confirmed_transcript_hash&lt;V&gt;;
    Extension group_context_extensions&lt;V&gt;;
    Extension other_extensions&lt;V&gt;;
    MAC confirmation_tag;
    LeafNodeRef signer;
} GroupInfoTBS;
</pre><a href="#section-13.2.3-4" class="pilcrow">¶</a>
</div>
<div id="joining-via-external-commits">
<section id="section-13.2.3.1">
            <h5 id="name-joining-via-external-commit">
<a href="#section-13.2.3.1" class="section-number selfRef">13.2.3.1. </a><a href="#name-joining-via-external-commit" class="section-name selfRef">Joining via External Commits</a>
            </h5>
<p id="section-13.2.3.1-1">External Commits are a mechanism for new members (external parties that want to
become members of the group) to add themselves to a group, without requiring
that an existing member has to come online to issue a Commit that references an
Add Proposal.<a href="#section-13.2.3.1-1" class="pilcrow">¶</a></p>
<p id="section-13.2.3.1-2">Whether existing members of the group will accept or reject an External Commit
follows the same rules that are applied to other handshake messages.<a href="#section-13.2.3.1-2" class="pilcrow">¶</a></p>
<p id="section-13.2.3.1-3">New members can create and issue an External Commit if they have access to the
following information for the group's current epoch:<a href="#section-13.2.3.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.3.1-4.1">group ID<a href="#section-13.2.3.1-4.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-4.2">epoch ID<a href="#section-13.2.3.1-4.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-4.3">ciphersuite<a href="#section-13.2.3.1-4.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-4.4">public tree hash<a href="#section-13.2.3.1-4.4" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-4.5">confirmed transcript hash<a href="#section-13.2.3.1-4.5" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-4.6">confirmation tag of the most recent Commit<a href="#section-13.2.3.1-4.6" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-4.7">group extensions<a href="#section-13.2.3.1-4.7" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-4.8">external public key<a href="#section-13.2.3.1-4.8" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-13.2.3.1-5">In other words, to join a group via an External Commit, a new member needs a
GroupInfo with an <code>ExternalPub</code> extension present in the <code>other_extensions</code>.<a href="#section-13.2.3.1-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.2.3.1-6">
<pre>
struct {
    HPKEPublicKey external_pub;
} ExternalPub;
</pre><a href="#section-13.2.3.1-6" class="pilcrow">¶</a>
</div>
<p id="section-13.2.3.1-7">Thus, a member of the group can enable new clients to join by making a GroupInfo
object available to them. Note that because a GroupInfo object is specific to an
epoch, it will need to be updated as the group advances. In particular, each
GroupInfo object can be used for one external join, since that external join
will cause the epoch to change.<a href="#section-13.2.3.1-7" class="pilcrow">¶</a></p>
<p id="section-13.2.3.1-8">Note that the <code>tree_hash</code> field is used the same way as in the Welcome message.
The full tree can be included via the <code>ratchet_tree</code> extension
<a href="#ratchet-tree-extension" class="xref">Section 13.3</a>.<a href="#section-13.2.3.1-8" class="pilcrow">¶</a></p>
<p id="section-13.2.3.1-9">The information in a GroupInfo is not generally public information, but applications
can choose to make it available to new members in order to allow External
Commits.<a href="#section-13.2.3.1-9" class="pilcrow">¶</a></p>
<p id="section-13.2.3.1-10">In principle, External Commits work like regular Commits. However, their content
has to meet a specific set of requirements:<a href="#section-13.2.3.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.3.1-11.1">External Commits MUST contain a <code>path</code> field (and is therefore a "full"
Commit).  The joiner is added at the leftmost free leaf node (just as if they
were added with an Add proposal), and the path is calculated relative to that
leaf node.<a href="#section-13.2.3.1-11.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-11.2">The Commit MUST NOT include any proposals by reference, since an external
joiner cannot determine the validity of proposals sent within the group<a href="#section-13.2.3.1-11.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-11.3">
                <p id="section-13.2.3.1-11.3.1">The proposals included by value in an External Commit MUST meet the following
conditions:<a href="#section-13.2.3.1-11.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.3.1-11.3.2.1">There MUST be a single ExternalInit proposal.<a href="#section-13.2.3.1-11.3.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.1-11.3.2.2">There MAY be a single Remove proposal, where the LeafNode in the <code>path</code>
field MUST meet the same criteria as the LeafNode in an Update for the
removed leaf (see <a href="#update" class="xref">Section 13.1.2</a>). In particular, the <code>credential</code> in the
LeafNode MUST present a set of identifiers that is acceptable to the
application for the removed participant.<a href="#section-13.2.3.1-11.3.2.2" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.1-11.3.2.3">There MAY be one or more PreSharedKey proposals.<a href="#section-13.2.3.1-11.3.2.3" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.1-11.3.2.4">There MUST NOT be any other proposals.<a href="#section-13.2.3.1-11.3.2.4" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-13.2.3.1-11.4">External Commits MUST be signed by the new member.  In particular, the
signature on the enclosing MLSPlaintext MUST verify using the public key for
the credential in the <code>leaf_node</code> of the <code>path</code> field.<a href="#section-13.2.3.1-11.4" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-11.5">When processing a Commit, both existing and new members MUST use the external
init secret as described in <a href="#external-initialization" class="xref">Section 9.3</a>.<a href="#section-13.2.3.1-11.5" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.1-11.6">The sender type for the MLSPlaintext encapsulating the External Commit MUST be
<code>new_member</code><a href="#section-13.2.3.1-11.6" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-13.2.3.1-12">External Commits come in two "flavors" -- a "join" commit that
adds the sender to the group or a "resync" commit that replaces a member's prior
appearance with a new one.<a href="#section-13.2.3.1-12" class="pilcrow">¶</a></p>
<p id="section-13.2.3.1-13">Note that the "resync" operation allows an attacker that has compromised a
member's signature private key to introduce themselves into the group and remove the
prior, legitimate member in a single Commit.  Without resync, this
can still be done, but requires two operations, the external Commit to join and
a second Commit to remove the old appearance.  Applications for whom this
distinction is salient can choose to disallow external commits that contain a
Remove, or to allow such resync commits only if they contain a "reinit" PSK
proposal that demonstrates the joining member's presence in a prior epoch of the
group.  With the latter approach, the attacker would need to compromise the PSK
as well as the signing key, but the application will need to ensure that
continuing, non-resynchronizing members have the required PSK.<a href="#section-13.2.3.1-13" class="pilcrow">¶</a></p>
</section>
</div>
<div id="joining-via-welcome-message">
<section id="section-13.2.3.2">
            <h5 id="name-joining-via-welcome-message">
<a href="#section-13.2.3.2" class="section-number selfRef">13.2.3.2. </a><a href="#name-joining-via-welcome-message" class="section-name selfRef">Joining via Welcome Message</a>
            </h5>
<p id="section-13.2.3.2-1">The sender of a Commit message is responsible for sending a single Welcome message to
all the new members added via Add proposals.  The Welcome message provides the new
members with the current state of the group, after the application of the Commit
message.  The new members will not be able to decrypt or verify the Commit
message, but will have the secrets they need to participate in the epoch
initiated by the Commit message.<a href="#section-13.2.3.2-1" class="pilcrow">¶</a></p>
<p id="section-13.2.3.2-2">In order to allow the same Welcome message to be sent to all new members,
information describing the group is encrypted with a symmetric key and nonce
derived from the <code>joiner_secret</code> for the new epoch.  The <code>joiner_secret</code> is
then encrypted to each new member using HPKE.  In the same encrypted package,
the committer transmits the path secret for the lowest (closest to the leaf) node
which is contained in the direct paths of both the committer and the new member.
This allows the new
member to compute private keys for nodes in its direct path that are being
reset by the corresponding Commit.<a href="#section-13.2.3.2-2" class="pilcrow">¶</a></p>
<p id="section-13.2.3.2-3">If the sender of the Welcome message wants the receiving member to include a PSK
in the derivation of the <code>epoch_secret</code>, they can populate the <code>psks</code> field
indicating which PSK to use.<a href="#section-13.2.3.2-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.2.3.2-4">
<pre>
struct {
  opaque path_secret&lt;V&gt;;
} PathSecret;

struct {
  opaque joiner_secret&lt;V&gt;;
  optional&lt;PathSecret&gt; path_secret;
  PreSharedKeys psks;
} GroupSecrets;

struct {
  KeyPackageRef new_member;
  HPKECiphertext encrypted_group_secrets;
} EncryptedGroupSecrets;

struct {
  CipherSuite cipher_suite;
  EncryptedGroupSecrets secrets&lt;V&gt;;
  opaque encrypted_group_info&lt;V&gt;;
} Welcome;
</pre><a href="#section-13.2.3.2-4" class="pilcrow">¶</a>
</div>
<p id="section-13.2.3.2-5">The client processing a Welcome message will need to have a copy of the group's
ratchet tree.  The tree can be provided in the Welcome message, in an extension
of type <code>ratchet_tree</code>.  If it is sent otherwise (e.g., provided by a caching
service on the Delivery Service), then the client MUST download the tree before
processing the Welcome.<a href="#section-13.2.3.2-5" class="pilcrow">¶</a></p>
<p id="section-13.2.3.2-6">On receiving a Welcome message, a client processes it using the following steps:<a href="#section-13.2.3.2-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.3.2-7.1">Identify an entry in the <code>secrets</code> array where the <code>new_member</code>
value corresponds to one of this client's KeyPackages, using the hash
indicated by the <code>cipher_suite</code> field. If no such field exists, or if the
ciphersuite indicated in the KeyPackage does not match the one in the
Welcome message, return an error.<a href="#section-13.2.3.2-7.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.2-7.2">Decrypt the <code>encrypted_group_secrets</code> using HPKE with the algorithms indicated
by the ciphersuite and the HPKE private key corresponding to the GroupSecrets.
If a <code>PreSharedKeyID</code> is part of the GroupSecrets and the client is not in
possession of the corresponding PSK, return an error.<a href="#section-13.2.3.2-7.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.2-7.3">From the <code>joiner_secret</code> in the decrypted GroupSecrets object and the PSKs
specified in the <code>GroupSecrets</code>, derive the <code>welcome_secret</code> and using that
the <code>welcome_key</code> and <code>welcome_nonce</code>. Use the key and nonce to decrypt the
<code>encrypted_group_info</code> field.<a href="#section-13.2.3.2-7.3" class="pilcrow">¶</a>
</li>
            </ul>
<div class="alignLeft art-text artwork" id="section-13.2.3.2-8">
<pre>
welcome_nonce = KDF.Expand(welcome_secret, "nonce", AEAD.Nn)
welcome_key = KDF.Expand(welcome_secret, "key", AEAD.Nk)
</pre><a href="#section-13.2.3.2-8" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-13.2.3.2-9.1">Verify the signature on the GroupInfo object. The signature input comprises
all of the fields in the GroupInfo object except the signature field. The
public key and algorithm are taken from the credential in the leaf node of the
member with LeafNodeRef <code>signer</code>. If there is no matching leaf node, or if
signature verification fails, return an error.<a href="#section-13.2.3.2-9.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.2-9.2">
                <p id="section-13.2.3.2-9.2.1">Verify the integrity of the ratchet tree.<a href="#section-13.2.3.2-9.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.3.2-9.2.2.1">Verify that the tree hash of the ratchet tree matches the <code>tree_hash</code> field
in the GroupInfo.<a href="#section-13.2.3.2-9.2.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.2-9.2.2.2">For each non-empty parent node, verify that exactly one of the node's
children are non-empty and have the hash of this node set as their
<code>parent_hash</code> value (if the child is another parent) or has a <code>parent_hash</code>
field in the LeafNode containing the same value (if the child is a
leaf). If either of the node's children is empty, and in particular does not
have a parent hash, then its respective children's <code>parent_hash</code> values have
to be considered instead.<a href="#section-13.2.3.2-9.2.2.2" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.2-9.2.2.3">For each non-empty leaf node, validate the LeafNode as described in
<a href="#leaf-node-validation" class="xref">Section 8.3</a>.<a href="#section-13.2.3.2-9.2.2.3" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-13.2.3.2-9.3">Identify a leaf in the <code>tree</code> array (any even-numbered node) whose LeafNode is
identical to the one in the KeyPackage.  If no such field exists, return an
error.  Let <code>my_leaf</code> represent this leaf in the tree.<a href="#section-13.2.3.2-9.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.2-9.4">
                <p id="section-13.2.3.2-9.4.1">Construct a new group state using the information in the GroupInfo object.<a href="#section-13.2.3.2-9.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-13.2.3.2-9.4.2.1">The GroupContext contains the <code>group_id</code>, <code>epoch</code>, <code>tree_hash</code>,
<code>confirmed_transcript_hash</code>, and <code>group_context_extensions</code> fields from
the GroupInfo object.<a href="#section-13.2.3.2-9.4.2.1" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.2-9.4.2.2">The new member's position in the tree is at the leaf <code>my_leaf</code>, as defined
above.<a href="#section-13.2.3.2-9.4.2.2" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.2-9.4.2.3">Update the leaf <code>my_leaf</code> with the private key corresponding to the
public key in the node.<a href="#section-13.2.3.2-9.4.2.3" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.2-9.4.2.4">If the <code>path_secret</code> value is set in the GroupSecrets object: Identify the
lowest common ancestor of the leaf node <code>my_leaf</code> and of the node of
the member with LeafNodeRef <code>GroupInfo.signer</code>. Set the private key for
this node to the private key derived from the <code>path_secret</code>.<a href="#section-13.2.3.2-9.4.2.4" class="pilcrow">¶</a>
</li>
                  <li class="normal" id="section-13.2.3.2-9.4.2.5">For each parent of the common ancestor, up to the root of the tree, derive
a new path secret and set the private key for the node to the private key
derived from the path secret.  The private key MUST be the private key
that corresponds to the public key in the node.<a href="#section-13.2.3.2-9.4.2.5" class="pilcrow">¶</a>
</li>
                </ul>
</li>
              <li class="normal" id="section-13.2.3.2-9.5">Use the <code>joiner_secret</code> from the GroupSecrets object to generate the epoch secret
and other derived secrets for the current epoch.<a href="#section-13.2.3.2-9.5" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.2-9.6">Set the confirmed transcript hash in the new state to the value of the
<code>confirmed_transcript_hash</code> in the GroupInfo.<a href="#section-13.2.3.2-9.6" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.2-9.7">Verify the confirmation tag in the GroupInfo using the derived confirmation
key and the <code>confirmed_transcript_hash</code> from the GroupInfo.<a href="#section-13.2.3.2-9.7" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-13.2.3.2-9.8">Use the confirmed transcript hash and confirmation tag to compute the interim
transcript hash in the new state.<a href="#section-13.2.3.2-9.8" class="pilcrow">¶</a>
</li>
            </ul>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="ratchet-tree-extension">
<section id="section-13.3">
        <h3 id="name-ratchet-tree-extension">
<a href="#section-13.3" class="section-number selfRef">13.3. </a><a href="#name-ratchet-tree-extension" class="section-name selfRef">Ratchet Tree Extension</a>
        </h3>
<p id="section-13.3-1">By default, a GroupInfo message only provides the joiner with a commitment
to the group's ratchet tree.  In order to process or generate handshake
messages, the joiner will need to get a copy of the ratchet tree from some other
source.  (For example, the DS might provide a cached copy.)  The inclusion of
the tree hash in the GroupInfo message means that the source of the ratchet
tree need not be trusted to maintain the integrity of tree.<a href="#section-13.3-1" class="pilcrow">¶</a></p>
<p id="section-13.3-2">In cases where the application does not wish to provide such an external source,
the whole public state of the ratchet tree can be provided in an extension of
type <code>ratchet_tree</code>, containing a <code>ratchet_tree</code> object of the following form:<a href="#section-13.3-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.3-3">
<pre>
enum {
    reserved(0),
    leaf(1),
    parent(2),
    (255)
} NodeType;

struct {
    NodeType node_type;
    select (Node.node_type) {
        case leaf:   LeafNode leaf_node;
        case parent: ParentNode parent_node;
    };
} Node;

optional&lt;Node&gt; ratchet_tree&lt;V&gt;;
</pre><a href="#section-13.3-3" class="pilcrow">¶</a>
</div>
<p id="section-13.3-4">The nodes are listed in the order specified by a left-to-right in-order
traversal of the rachet tree. Each node is listed between its left subtree and
its right subtree.  (This is the same ordering as specified for the array-based
trees outlined in <a href="#array-based-trees" class="xref">Appendix B</a>.)<a href="#section-13.3-4" class="pilcrow">¶</a></p>
<p id="section-13.3-5">The leaves of the tree are stored in even-numbered entries in
the array (the leaf with index L in array position 2*L). The root node of the
tree is at position 2^k - 1 of the array, where k is the largest number such
that 2^k is smaller than the length of the array. Intermediate parent nodes can
be identified by performing the same calculation to the subarrays to the left
and right of the root, following something like the following algorithm:<a href="#section-13.3-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.3-6">
<pre>
# Assuming a class Node that has left and right members
def subtree_root(nodes):
    # If there is only one node in the array return it
    if len(nodes) == 1:
        return Node(nodes[0])

    # Otherwise, the length of the array MUST be odd
    if len(nodes) % 2 == 0:
        raise Exception("Malformed node array {}", len(nodes))

    # Identify the root of the subtree
    k = 0
    while (2**(k+1)) &lt; len(nodes):
       k += 1
    R = 2**k - 1
    root = Node(nodes[R])
    root.left = subtree_root(nodes[:R])
    root.right = subtree_root(nodes[(R+1):])
    return root
</pre><a href="#section-13.3-6" class="pilcrow">¶</a>
</div>
<p id="section-13.3-7">(Note that this is the same ordering of nodes as in the array-based tree representation
described in <a href="#array-based-trees" class="xref">Appendix B</a>.  The algorithms in that section may be used to
simplify decoding this extension into other representations.)<a href="#section-13.3-7" class="pilcrow">¶</a></p>
<p id="section-13.3-8">The example tree in <a href="#ratchet-tree-terminology" class="xref">Section 5.1</a> would be represented as an
array of nodes in the following form, where R represents the "subtree root" for
a given subarray of the node array:<a href="#section-13.3-8" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-13.3-9">
<pre>
              X
        ______|______
       /             \
      V               Z
    __|__           __|
   /     \         /   \
  U       W       Y     |
 / \     / \     / \    |
A   B   C   D   E   F   G

                    1 1 1
0 1 2 3 4 5 6 7 8 9 0 1 2
&lt;-----------&gt; R &lt;-------&gt;
&lt;---&gt; R &lt;---&gt;   &lt;---&gt; R -
- R -   - R -   - R -
</pre><a href="#section-13.3-9" class="pilcrow">¶</a>
</div>
<p id="section-13.3-10">The presence of a <code>ratchet_tree</code> extension in a GroupInfo message does not
result in any changes to the GroupContext extensions for the group.  The ratchet
tree provided is simply stored by the client and used for MLS operations.<a href="#section-13.3-10" class="pilcrow">¶</a></p>
<p id="section-13.3-11">If this extension is not provided in a Welcome message, then the client will
need to fetch the ratchet tree over some other channel before it can generate or
process Commit messages.  Applications should ensure that this out-of-band
channel is provided with security protections equivalent to the protections that
are afforded to Proposal and Commit messages.  For example, an application that
encrypts Proposal and Commit messages might distribute ratchet trees encrypted
using a key exchanged over the MLS channel.<a href="#section-13.3-11" class="pilcrow">¶</a></p>
<p id="section-13.3-12">Regardless of how the client obtains the tree, the client MUST verify that the
root hash of the ratchet tree matches the <code>tree_hash</code> of the GroupContext before
using the tree for MLS operations.<a href="#section-13.3-12" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="extensibility">
<section id="section-14">
      <h2 id="name-extensibility">
<a href="#section-14" class="section-number selfRef">14. </a><a href="#name-extensibility" class="section-name selfRef">Extensibility</a>
      </h2>
<p id="section-14-1">The base MLS protocol can be extended in a few ways.  New ciphersuites can be
added to enable the use of new cryptographic algorithms.  New types of proposals
can be used to perform new actions within an epoch.  Extension fields can be
used to add additional information to the protocol.  In this section, we discuss
some constraints on these extensibility mechanisms that are necessary to ensure
broad interoperability.<a href="#section-14-1" class="pilcrow">¶</a></p>
<div id="ciphersuites-1">
<section id="section-14.1">
        <h3 id="name-ciphersuites-2">
<a href="#section-14.1" class="section-number selfRef">14.1. </a><a href="#name-ciphersuites-2" class="section-name selfRef">Ciphersuites</a>
        </h3>
<p id="section-14.1-1">As discussed in <a href="#ciphersuites" class="xref">Section 6.1</a>, MLS allows the participants in a group to
negotiate the cryptographic algorithms used within the group.  This
extensibility is important for maintaining the security of the protocol over
time <span>[<a href="#RFC7696" class="xref">RFC7696</a>]</span>.  It also creates a risk of interoperability failure due to
clients not supporting a common ciphersuite.<a href="#section-14.1-1" class="pilcrow">¶</a></p>
<p id="section-14.1-2">The ciphersuite registry defined in <a href="#mls-ciphersuites" class="xref">Section 18.1</a> attempts to strike a
balance on this point.  On the one hand, the base policy for the registry is
Specification Required, a fairly low bar designed to avoid the need for
standards work in cases where different ciphers are needed for niche
applications.  There is a higher bar (Standards Action) for ciphers to set the
Recommended field in the registry.  This higher bar is there in part to ensure
that the interoperability implications of new ciphersuites are considered.<a href="#section-14.1-2" class="pilcrow">¶</a></p>
<p id="section-14.1-3">MLS ciphersuites are defined independent of MLS versions, so that in principle
the same ciphersuite can be used across versions.  Standards work defining new
versions of MLS should consider whether it is desirable for the new version to
be compatible with existing ciphersuites, or whether the new version should rule
out some ciphersuites. For example, a new version could follow the example of
HTTP/2, which restricted the set of allowed TLS ciphers (see Section 9.2.2 of
<span>[<a href="#RFC7540" class="xref">RFC7540</a>]</span>.<a href="#section-14.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="proposals-1">
<section id="section-14.2">
        <h3 id="name-proposals-2">
<a href="#section-14.2" class="section-number selfRef">14.2. </a><a href="#name-proposals-2" class="section-name selfRef">Proposals</a>
        </h3>
<p id="section-14.2-1">Commit messages do not have an extension field because the set of protocols is
extensible.  As discussed in <a href="#commit" class="xref">Section 13.2</a>, Proposals with a non-default proposal
type MUST NOT be included in a commit unless the proposal type is supported by
all the members of the group that will process the Commit.<a href="#section-14.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="extensions">
<section id="section-14.3">
        <h3 id="name-extensions">
<a href="#section-14.3" class="section-number selfRef">14.3. </a><a href="#name-extensions" class="section-name selfRef">Extensions</a>
        </h3>
<p id="section-14.3-1">This protocol includes a mechanism for negotiating extension parameters similar
to the one in TLS <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.  In TLS, extension negotiation is one-to-one: The
client offers extensions in its ClientHello message, and the server expresses
its choices for the session with extensions in its ServerHello and
EncryptedExtensions messages.  In MLS, extensions appear in the following
places:<a href="#section-14.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-14.3-2.1">In KeyPackages, to describe additional information related to the client<a href="#section-14.3-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-14.3-2.2">In LeafNodes, to describe additional information about the client or its
participation in the group (once in the ratchet tree)<a href="#section-14.3-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-14.3-2.3">In the GroupInfo, to tell new members of a group what parameters are
being used by the group, and to provide any additional details required to
join the group<a href="#section-14.3-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-14.3-2.4">In the GroupContext object, to ensure that all members of the group have the
same view of the parameters in use<a href="#section-14.3-2.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-14.3-3">In other words, an application can use GroupContext extensions to ensure that
all members of the group agree on a set of parameters. Clients indicate their
support for parameters in the <code>capabilities</code> field of their LeafNode. New
members of a group are informed of the group's GroupContext extensions via the
<code>group_context_extensions</code> field in the GroupInfo object. The <code>other_extensions</code>
field in a GroupInfo object can be used to provide additional parameters to new
joiners that are used to join the group.<a href="#section-14.3-3" class="pilcrow">¶</a></p>
<p id="section-14.3-4">This extension mechanism is designed to allow for secure and forward-compatible
negotiation of extensions.  For this to work, implementations MUST correctly
handle extensible fields:<a href="#section-14.3-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-14.3-5.1">A client that posts a KeyPackage MUST support all parameters advertised in
it.  Otherwise, another client might fail to interoperate by selecting one of
those parameters.<a href="#section-14.3-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-14.3-5.2">A client initiating a group MUST ignore all unrecognized ciphersuites,
extensions, and other parameters.  Otherwise, it may fail to interoperate with
newer clients.<a href="#section-14.3-5.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-14.3-5.3">A client adding a new member to a group MUST verify that the LeafNode for the
new member is compatible with the group's extensions.  The <code>capabilities</code>
field MUST indicate support for each extension in the GroupContext.<a href="#section-14.3-5.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-14.3-5.4">If any extension in a GroupInfo message is unrecognized (i.e., not contained
in the <code>capabilities</code> of the corresponding KeyPackage), then the client MUST
reject the Welcome message and not join the group.<a href="#section-14.3-5.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-14.3-5.5">The extensions populated into a GroupContext object are drawn from those in
the GroupInfo object, according to the definitions of those extensions.<a href="#section-14.3-5.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-14.3-5.6">Any field containing a list of extensions MUST NOT have more than one extension of any given type.<a href="#section-14.3-5.6" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-14.3-6">Note that the latter two requirements mean that all MLS extensions are
mandatory, in the sense that an extension in use by the group MUST be supported
by all members of the group.<a href="#section-14.3-6" class="pilcrow">¶</a></p>
<p id="section-14.3-7">This document does not define any way for the parameters of the group to change
once it has been created; such a behavior could be implemented as an extension.<a href="#section-14.3-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="sequencing">
<section id="section-15">
      <h2 id="name-sequencing-of-state-changes">
<a href="#section-15" class="section-number selfRef">15. </a><a href="#name-sequencing-of-state-changes" class="section-name selfRef">Sequencing of State Changes</a>
      </h2>
<p id="section-15-1">Each Commit message is premised on a given starting state,
indicated by the <code>epoch</code> field of the enclosing MLSMessageContent.
If the changes implied by a Commit messages are made
starting from a different state, the results will be incorrect.<a href="#section-15-1" class="pilcrow">¶</a></p>
<p id="section-15-2">This need for sequencing is not a problem as long as each time a
group member sends a Commit message, it is based on the most
current state of the group.  In practice, however, there is a risk
that two members will generate Commit messages simultaneously,
based on the same state.<a href="#section-15-2" class="pilcrow">¶</a></p>
<p id="section-15-3">When this happens, there is a need for the members of the group to
deconflict the simultaneous Commit messages.  There are two
general approaches:<a href="#section-15-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-15-4.1">Have the Delivery Service enforce a total order<a href="#section-15-4.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-15-4.2">Have a signal in the message that clients can use to break ties<a href="#section-15-4.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-15-5">As long as Commit messages cannot be merged, there is a risk of
starvation.  In a sufficiently busy group, a given member may never
be able to send a Commit message, because he always loses to other
members.  The degree to which this is a practical problem will depend
on the dynamics of the application.<a href="#section-15-5" class="pilcrow">¶</a></p>
<p id="section-15-6">It might be possible, because of the non-contributivity of intermediate
nodes, that Commit messages could be applied one after the other
without the Delivery Service having to reject any Commit message,
which would make MLS more resilient regarding the concurrency of
Commit messages.
The Messaging system can decide to choose the order for applying
the state changes. Note that there are certain cases (if no total
ordering is applied by the Delivery Service) where the ordering is
important for security, ie. all updates must be executed before
removes.<a href="#section-15-6" class="pilcrow">¶</a></p>
<p id="section-15-7">Regardless of how messages are kept in sequence, implementations
MUST only update their cryptographic state when valid Commit
messages are received.
Generation of Commit messages MUST NOT modify a client's state, since the
endpoint doesn't know at that time whether the changes implied by
the Commit message will succeed or not.<a href="#section-15-7" class="pilcrow">¶</a></p>
<div id="server-enforced-ordering">
<section id="section-15.1">
        <h3 id="name-server-enforced-ordering">
<a href="#section-15.1" class="section-number selfRef">15.1. </a><a href="#name-server-enforced-ordering" class="section-name selfRef">Server-Enforced Ordering</a>
        </h3>
<p id="section-15.1-1">With this approach, the Delivery Service ensures that incoming
messages are added to an ordered queue and outgoing messages are
dispatched in the same order. The server is trusted to break ties
when two members send a Commit message at the same time.<a href="#section-15.1-1" class="pilcrow">¶</a></p>
<p id="section-15.1-2">Messages should have a counter field sent in clear-text that can
be checked by the server and used for tie-breaking. The counter
starts at 0 and is incremented for every new incoming message.
If two group members send a message with the same counter, the
first message to arrive will be accepted by the server and the
second one will be rejected. The rejected message needs to be sent
again with the correct counter number.<a href="#section-15.1-2" class="pilcrow">¶</a></p>
<p id="section-15.1-3">To prevent counter manipulation by the server, the counter's
integrity can be ensured by including the counter in a signed
message envelope.<a href="#section-15.1-3" class="pilcrow">¶</a></p>
<p id="section-15.1-4">This applies to all messages, not only state changing messages.<a href="#section-15.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="client-enforced-ordering">
<section id="section-15.2">
        <h3 id="name-client-enforced-ordering">
<a href="#section-15.2" class="section-number selfRef">15.2. </a><a href="#name-client-enforced-ordering" class="section-name selfRef">Client-Enforced Ordering</a>
        </h3>
<p id="section-15.2-1">Order enforcement can be implemented on the client as well,
one way to achieve it is to use a two step update protocol: the
first client sends a proposal to update and the proposal is
accepted when it gets 50%+ approval from the rest of the group,
then it sends the approved update. Clients which didn't get
their proposal accepted, will wait for the winner to send their
update before retrying new proposals.<a href="#section-15.2-1" class="pilcrow">¶</a></p>
<p id="section-15.2-2">While this seems safer as it doesn't rely on the server, it is
more complex and harder to implement. It also could cause starvation
for some clients if they keep failing to get their proposal accepted.<a href="#section-15.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="application-messages">
<section id="section-16">
      <h2 id="name-application-messages">
<a href="#section-16" class="section-number selfRef">16. </a><a href="#name-application-messages" class="section-name selfRef">Application Messages</a>
      </h2>
<p id="section-16-1">The primary purpose of the Handshake protocol is to provide an
authenticated group key exchange to clients. In order to protect
Application messages sent among the members of a group, the Application
secret provided by the Handshake key schedule is used to derive nonces
and encryption keys for the Message Protection Layer according to
the Application Key Schedule. That is, each epoch is equipped with
a fresh Application Key Schedule which consist of a tree of Application
Secrets as well as one symmetric ratchet per group member.<a href="#section-16-1" class="pilcrow">¶</a></p>
<p id="section-16-2">Each client maintains their own local copy of the Application Key
Schedule for each epoch during which they are a group member. They
derive new keys, nonces and secrets as needed while deleting old
ones as soon as they have been used.<a href="#section-16-2" class="pilcrow">¶</a></p>
<p id="section-16-3">Application messages MUST be protected with the Authenticated-Encryption
with Associated-Data (AEAD) encryption scheme associated with the
MLS ciphersuite using the common framing mechanism.
Note that "Authenticated" in this context does not mean messages are
known to be sent by a specific client but only from a legitimate
member of the group.
To authenticate a message from a particular member, signatures are
required. Handshake messages MUST use asymmetric signatures to strongly
authenticate the sender of a message.<a href="#section-16-3" class="pilcrow">¶</a></p>
<div id="message-encryption-and-decryption">
<section id="section-16.1">
        <h3 id="name-message-encryption-and-decr">
<a href="#section-16.1" class="section-number selfRef">16.1. </a><a href="#name-message-encryption-and-decr" class="section-name selfRef">Message Encryption and Decryption</a>
        </h3>
<p id="section-16.1-1">The group members MUST use the AEAD algorithm associated with
the negotiated MLS ciphersuite to AEAD encrypt and decrypt their
Application messages according to the Message Framing section.<a href="#section-16.1-1" class="pilcrow">¶</a></p>
<p id="section-16.1-2">The group identifier and epoch allow a recipient to know which group secrets
should be used and from which Epoch secret to start computing other secrets
and keys. The sender identifier is used to identify the member's
symmetric ratchet from the initial group Application secret. The application
generation field is used to determine how far into the ratchet to iterate in
order to reproduce the required AEAD keys and nonce for performing decryption.<a href="#section-16.1-2" class="pilcrow">¶</a></p>
<p id="section-16.1-3">Application messages SHOULD be padded to provide some resistance
against traffic analysis techniques over encrypted traffic.
<span>[<a href="#CLINIC" class="xref">CLINIC</a>]</span>
          <span>[<a href="#HCJ16" class="xref">HCJ16</a>]</span>
While MLS might deliver the same payload less frequently across
a lot of ciphertexts than traditional web servers, it might still provide
the attacker enough information to mount an attack. If Alice asks Bob:
"When are we going to the movie ?" the answer "Wednesday" might be leaked
to an adversary by the ciphertext length. An attacker expecting Alice to
answer Bob with a day of the week might find out the plaintext by
correlation between the question and the length.<a href="#section-16.1-3" class="pilcrow">¶</a></p>
<p id="section-16.1-4">The content and length of the <code>padding</code> field in <code>MLSCiphertextContent</code> can be
chosen at the time of message encryption by the sender. It is recommended that
padding data is comprised of zero-valued bytes and follows an established
deterministic padding scheme.<a href="#section-16.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="restrictions">
<section id="section-16.2">
        <h3 id="name-restrictions">
<a href="#section-16.2" class="section-number selfRef">16.2. </a><a href="#name-restrictions" class="section-name selfRef">Restrictions</a>
        </h3>
<p id="section-16.2-1">During each epoch senders MUST NOT encrypt more data than permitted by the
security bounds of the AEAD scheme used.<a href="#section-16.2-1" class="pilcrow">¶</a></p>
<p id="section-16.2-2">Note that each change to the Group through a Handshake message will also set a
new <code>encryption_secret</code>. Hence this change MUST be applied before encrypting
any new application message. This is required both to ensure that any users
removed from the group can no longer receive messages and to (potentially)
recover confidentiality and authenticity for future messages despite a past
state compromise.<a href="#section-16.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="delayed-and-reordered-application-messages">
<section id="section-16.3">
        <h3 id="name-delayed-and-reordered-appli">
<a href="#section-16.3" class="section-number selfRef">16.3. </a><a href="#name-delayed-and-reordered-appli" class="section-name selfRef">Delayed and Reordered Application messages</a>
        </h3>
<p id="section-16.3-1">Since each Application message contains the group identifier, the epoch and a
message counter, a client can receive messages out of order.
If they are able to retrieve or recompute the correct AEAD decryption key
from currently stored cryptographic material clients can decrypt
these messages.<a href="#section-16.3-1" class="pilcrow">¶</a></p>
<p id="section-16.3-2">For usability, MLS clients might be required to keep the AEAD key
and nonce for a certain amount of time to retain the ability to decrypt
delayed or out of order messages, possibly still in transit while a
decryption is being done.<a href="#section-16.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-17">
      <h2 id="name-security-considerations-5">
<a href="#section-17" class="section-number selfRef">17. </a><a href="#name-security-considerations-5" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-17-1">The security goals of MLS are described in <span>[<a href="#I-D.ietf-mls-architecture" class="xref">I-D.ietf-mls-architecture</a>]</span>.
We describe here how the protocol achieves its goals at a high level,
though a complete security analysis is outside of the scope of this
document.<a href="#section-17-1" class="pilcrow">¶</a></p>
<div id="confidentiality-of-the-group-secrets">
<section id="section-17.1">
        <h3 id="name-confidentiality-of-the-grou">
<a href="#section-17.1" class="section-number selfRef">17.1. </a><a href="#name-confidentiality-of-the-grou" class="section-name selfRef">Confidentiality of the Group Secrets</a>
        </h3>
<p id="section-17.1-1">Group secrets are partly derived from the output of a ratchet tree. Ratchet
trees work by assigning each member of the group to a leaf in the tree and
maintaining the following property: the private key of a node in the tree is
known only to members of the group that are assigned a leaf in the node's
subtree. This is called the <em>ratchet tree invariant</em> and it makes it possible to
encrypt to all group members except one, with a number of ciphertexts that's
logarithmic in the number of group members.<a href="#section-17.1-1" class="pilcrow">¶</a></p>
<p id="section-17.1-2">The ability to efficiently encrypt to all members except one allows members to
be securely removed from a group. It also allows a member to rotate their
keypair such that the old private key can no longer be used to decrypt new
messages.<a href="#section-17.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authentication">
<section id="section-17.2">
        <h3 id="name-authentication">
<a href="#section-17.2" class="section-number selfRef">17.2. </a><a href="#name-authentication" class="section-name selfRef">Authentication</a>
        </h3>
<p id="section-17.2-1">The first form of authentication we provide is that group members can verify a
message originated from one of the members of the group. For encrypted messages,
this is guaranteed because messages are encrypted with an AEAD under a key
derived from the group secrets. For plaintext messages, this is guaranteed by
the use of a <code>membership_tag</code> which constitutes a MAC over the message, under a
key derived from the group secrets.<a href="#section-17.2-1" class="pilcrow">¶</a></p>
<p id="section-17.2-2">The second form of authentication is that group members can verify a message
originated from a particular member of the group. This is guaranteed by a
digital signature on each message from the sender's signature key.<a href="#section-17.2-2" class="pilcrow">¶</a></p>
<p id="section-17.2-3">The signature keys held by group members are critical to the security of MLS
against active attacks.  If a member's signature key is compromised, then an
attacker can create LeafNodes and KeyPackages impersonating the member; depending on the
application, this can then allow the attacker to join the group with the
compromised member's identity.  For example, if a group has enabled external
parties to join via external commits, then an attacker that has compromised a
member's signature key could use an external commit to insert themselves into
the group -- even using a "resync"-style external commit to replace the
compromised member in the group.<a href="#section-17.2-3" class="pilcrow">¶</a></p>
<p id="section-17.2-4">Applications can mitigate the risks of signature key compromise using pre-shared
keys.  If a group requires joiners to know a PSK in addition to authenticating
with a credential, then in order to mount an impersonation attack, the attacker
would need to compromise the relevant PSK as well as the victim's signature key.
The cost of this mitigation is that the application needs some external
arrangement that ensures that the legitimate members of the group to have the
required PSKs.<a href="#section-17.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="forward-secrecy-and-post-compromise-security">
<section id="section-17.3">
        <h3 id="name-forward-secrecy-and-post-co">
<a href="#section-17.3" class="section-number selfRef">17.3. </a><a href="#name-forward-secrecy-and-post-co" class="section-name selfRef">Forward Secrecy and Post-Compromise Security</a>
        </h3>
<p id="section-17.3-1">Post-compromise security is provided between epochs by members regularly
updating their leaf key in the ratchet tree. Updating their leaf key prevents
group secrets from continuing to be encrypted to previously compromised public
keys.<a href="#section-17.3-1" class="pilcrow">¶</a></p>
<p id="section-17.3-2">Forward-secrecy between epochs is provided by deleting private keys from past
version of the ratchet tree, as this prevents old group secrets from being
re-derived. Forward secrecy <em>within</em> an epoch is provided by deleting message
encryption keys once they've been used to encrypt or decrypt a message.<a href="#section-17.3-2" class="pilcrow">¶</a></p>
<p id="section-17.3-3">Post-compromise security is also provided for new groups by members regularly
generating new KeyPackages and uploading them to the Delivery Service, such that
compromised key material won't be used when the member is added to a new group.<a href="#section-17.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="keypackage-reuse">
<section id="section-17.4">
        <h3 id="name-keypackage-reuse">
<a href="#section-17.4" class="section-number selfRef">17.4. </a><a href="#name-keypackage-reuse" class="section-name selfRef">KeyPackage Reuse</a>
        </h3>
<p id="section-17.4-1">KeyPackages are intended to be used only once.  That is, once a KeyPackage
has been used to introduce the corresponding client to a group, it SHOULD be
deleted from the KeyPackage publication system.  Reuse of KeyPackages can lead
to replay attacks.<a href="#section-17.4-1" class="pilcrow">¶</a></p>
<p id="section-17.4-2">An application MAY allow for reuse of a "last resort" KeyPackage in order to
prevent denial of service attacks.  Since a KeyPackage is needed to add a
client to a new group, an attacker could prevent a client being added to new
groups by exhausting all available KeyPackages. To prevent such a denial of
service attack, the KeyPackage publication system SHOULD rate limit KeyPackage
requests, especially if not authenticated.<a href="#section-17.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="group-fragmentation-by-malicious-insiders">
<section id="section-17.5">
        <h3 id="name-group-fragmentation-by-mali">
<a href="#section-17.5" class="section-number selfRef">17.5. </a><a href="#name-group-fragmentation-by-mali" class="section-name selfRef">Group Fragmentation by Malicious Insiders</a>
        </h3>
<p id="section-17.5-1">It is possible for a malicious member of a group to "fragment" the group by
crafting an invalid UpdatePath.  Recall that an UpdatePath encrypts a sequence
of path secrets to different subtrees of the group's ratchet trees.  These path
secrets should be derived in a sequence as described in
<a href="#ratchet-tree-evolution" class="xref">Section 8.4</a>, but the UpdatePath syntax allows the sender to
encrypt arbitrary, unrelated secrets.  The syntax also does not guarantee that
the encrypted path secret encrypted for a given node corresponds to the public
key provided for that node.<a href="#section-17.5-1" class="pilcrow">¶</a></p>
<p id="section-17.5-2">Both of these types of corruption will cause processing of a Commit to fail for
some members of the group.  If the public key for a node does not match the path
secret, then the members that decrypt that path secret will reject the commit
based on this mismatch.  If the path secret sequence is incorrect at some point,
then members that can decrypt nodes before that point will compute a different
public key for the mismatched node than the one in the UpdatePath, which also
causes the Commit to fail.  Applications SHOULD provide mechanisms for failed
commits to be reported, so that group members who were not able to recognize the
error themselves can reject the commit and roll back to a previous state if
necessary.<a href="#section-17.5-2" class="pilcrow">¶</a></p>
<p id="section-17.5-3">Even with such an error reporting mechanism in place, however, it is still
possible for members to get locked out of the group by a malformed commit.
Since malformed Commits can only be recognized by certain members of the group,
in an asynchronous application, it may be the case that all members that could
detect a fault in a Commit are offline.  In such a case, the Commit will be
accepted by the group, and the resulting state possibly used as the basis for
further Commits.  When the affected members come back online, they will reject
the first commit, and thus be unable to catch up with the group.<a href="#section-17.5-3" class="pilcrow">¶</a></p>
<p id="section-17.5-4">Applications can address this risk by requiring certain members of the group to
acknowledge successful processing of a Commit before the group regards the
Commit as accepted.  The minimum set of acknowledgements necessary to verify
that a Commit is well-formed comprises an acknowledgement from one member per
node in the UpdatePath, that is, one member from each subtree rooted in the
copath node corresponding to the node in the UpdatePath.<a href="#section-17.5-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-18">
      <h2 id="name-iana-considerations-4">
<a href="#section-18" class="section-number selfRef">18. </a><a href="#name-iana-considerations-4" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-18-1">This document requests the creation of the following new IANA registries:<a href="#section-18-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-18-2.1">MLS Ciphersuites (<a href="#mls-ciphersuites" class="xref">Section 18.1</a>)<a href="#section-18-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-18-2.2">MLS Extension Types (<a href="#mls-extension-types" class="xref">Section 18.2</a>)<a href="#section-18-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-18-2.3">MLS Proposal Types (<a href="#mls-proposal-types" class="xref">Section 18.3</a>)<a href="#section-18-2.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-18-2.4">MLS Credential Types (<a href="#mls-credential-types" class="xref">Section 18.4</a>)<a href="#section-18-2.4" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-18-3">All of these registries should be under a heading of "Messaging Layer Security",
and assignments are made via the Specification Required policy <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>. See
<a href="#de" class="xref">Section 18.5</a> for additional information about the MLS Designated Experts (DEs).<a href="#section-18-3" class="pilcrow">¶</a></p>
<p id="section-18-4">RFC EDITOR: Please replace XXXX throughout with the RFC number assigned to
this document<a href="#section-18-4" class="pilcrow">¶</a></p>
<div id="mls-ciphersuites">
<section id="section-18.1">
        <h3 id="name-mls-ciphersuites">
<a href="#section-18.1" class="section-number selfRef">18.1. </a><a href="#name-mls-ciphersuites" class="section-name selfRef">MLS Ciphersuites</a>
        </h3>
<p id="section-18.1-1">A ciphersuite is a combination of a protocol version and the set of
cryptographic algorithms that should be used.<a href="#section-18.1-1" class="pilcrow">¶</a></p>
<p id="section-18.1-2">Ciphersuite names follow the naming convention:<a href="#section-18.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-18.1-3">
<pre>
CipherSuite MLS_LVL_KEM_AEAD_HASH_SIG = VALUE;
</pre><a href="#section-18.1-3" class="pilcrow">¶</a>
</div>
<p id="section-18.1-4">Where VALUE is represented as a sixteen-bit integer:<a href="#section-18.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-18.1-5">
<pre>
uint16 CipherSuite;
</pre><a href="#section-18.1-5" class="pilcrow">¶</a>
</div>
<table class="center" id="table-4">
          <caption><a href="#table-4" class="selfRef">Table 4</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Component</th>
              <th class="text-left" rowspan="1" colspan="1">Contents</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">LVL</td>
              <td class="text-left" rowspan="1" colspan="1">The security level</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">KEM</td>
              <td class="text-left" rowspan="1" colspan="1">The KEM algorithm used for HPKE in ratchet tree operations</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">AEAD</td>
              <td class="text-left" rowspan="1" colspan="1">The AEAD algorithm used for HPKE and message protection</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">HASH</td>
              <td class="text-left" rowspan="1" colspan="1">The hash algorithm used for HPKE and the MLS transcript hash</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">SIG</td>
              <td class="text-left" rowspan="1" colspan="1">The Signature algorithm used for message authentication</td>
            </tr>
          </tbody>
        </table>
<p id="section-18.1-7">The columns in the registry are as follows:<a href="#section-18.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-18.1-8.1">Value: The numeric value of the ciphersuite<a href="#section-18.1-8.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.1-8.2">Name: The name of the ciphersuite<a href="#section-18.1-8.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.1-8.3">Recommended: Whether support for this ciphersuite is recommended by the IETF MLS
WG.  Valid values are "Y" and "N".  The "Recommended" column is assigned a
value of "N" unless explicitly requested, and adding a value with a
"Recommended" value of "Y" requires Standards Action <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>.  IESG Approval
is REQUIRED for a Y-&gt;N transition.<a href="#section-18.1-8.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.1-8.4">Reference: The document where this ciphersuite is defined<a href="#section-18.1-8.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-18.1-9">Initial contents:<a href="#section-18.1-9" class="pilcrow">¶</a></p>
<table class="center" id="table-5">
          <caption><a href="#table-5" class="selfRef">Table 5</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">Name</th>
              <th class="text-left" rowspan="1" colspan="1">R</th>
              <th class="text-left" rowspan="1" colspan="1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0000</td>
              <td class="text-left" rowspan="1" colspan="1">RESERVED</td>
              <td class="text-left" rowspan="1" colspan="1">-</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">MLS_128_DHKEMP256_AES128GCM_SHA256_P256</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">MLS_128_DHKEMX25519_CHACHA20POLY1305_SHA256_Ed25519</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0004</td>
              <td class="text-left" rowspan="1" colspan="1">MLS_256_DHKEMX448_AES256GCM_SHA512_Ed448</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0005</td>
              <td class="text-left" rowspan="1" colspan="1">MLS_256_DHKEMP521_AES256GCM_SHA512_P521</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0006</td>
              <td class="text-left" rowspan="1" colspan="1">MLS_256_DHKEMX448_CHACHA20POLY1305_SHA512_Ed448</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0007</td>
              <td class="text-left" rowspan="1" colspan="1">MLS_256_DHKEMP384_AES256GCM_SHA384_P384.</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0xff00 - 0xffff</td>
              <td class="text-left" rowspan="1" colspan="1">Reserved for Private Use</td>
              <td class="text-left" rowspan="1" colspan="1">-</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
          </tbody>
        </table>
<p id="section-18.1-11">All of these ciphersuites use HMAC <span>[<a href="#RFC2104" class="xref">RFC2104</a>]</span> as their MAC function, with
different hashes per ciphersuite.  The mapping of ciphersuites to HPKE
primitives, HMAC hash functions, and TLS signature schemes is as follows
<span>[<a href="#RFC9180" class="xref">RFC9180</a>]</span> <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>:<a href="#section-18.1-11" class="pilcrow">¶</a></p>
<table class="center" id="table-6">
          <caption><a href="#table-6" class="selfRef">Table 6</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">KEM</th>
              <th class="text-left" rowspan="1" colspan="1">KDF</th>
              <th class="text-left" rowspan="1" colspan="1">AEAD</th>
              <th class="text-left" rowspan="1" colspan="1">Hash</th>
              <th class="text-left" rowspan="1" colspan="1">Signature</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">0x0020</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">SHA256</td>
              <td class="text-left" rowspan="1" colspan="1">ed25519</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">0x0010</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">SHA256</td>
              <td class="text-left" rowspan="1" colspan="1">ecdsa_secp256r1_sha256</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">0x0020</td>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">SHA256</td>
              <td class="text-left" rowspan="1" colspan="1">ed25519</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0004</td>
              <td class="text-left" rowspan="1" colspan="1">0x0021</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">SHA512</td>
              <td class="text-left" rowspan="1" colspan="1">ed448</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0005</td>
              <td class="text-left" rowspan="1" colspan="1">0x0012</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">SHA512</td>
              <td class="text-left" rowspan="1" colspan="1">ecdsa_secp521r1_sha512</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0006</td>
              <td class="text-left" rowspan="1" colspan="1">0x0021</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">SHA512</td>
              <td class="text-left" rowspan="1" colspan="1">ed448</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0007</td>
              <td class="text-left" rowspan="1" colspan="1">0x0011</td>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">SHA384</td>
              <td class="text-left" rowspan="1" colspan="1">ecdsa_secp384r1_sha384</td>
            </tr>
          </tbody>
        </table>
<p id="section-18.1-13">The hash used for the MLS transcript hash is the one referenced in the
ciphersuite name.  In the ciphersuites defined above, "SHA256", "SHA384", and "SHA512"
refer to the SHA-256, SHA-384, and SHA-512 functions defined in <span>[<a href="#SHS" class="xref">SHS</a>]</span>.<a href="#section-18.1-13" class="pilcrow">¶</a></p>
<p id="section-18.1-14">It is advisable to keep the number of ciphersuites low to increase the chances
clients can interoperate in a federated environment, therefore the ciphersuites
only include modern, yet well-established algorithms.  Depending on their
requirements, clients can choose between two security levels (roughly 128-bit
and 256-bit). Within the security levels clients can choose between faster
X25519/X448 curves and FIPS 140-2 compliant curves for Diffie-Hellman key
negotiations. Additionally clients that run predominantly on mobile processors
can choose ChaCha20Poly1305 over AES-GCM for performance reasons. Since
ChaCha20Poly1305 is not listed by FIPS 140-2 it is not paired with FIPS 140-2
compliant curves. The security level of symmetric encryption algorithms and hash
functions is paired with the security level of the curves.<a href="#section-18.1-14" class="pilcrow">¶</a></p>
<p id="section-18.1-15">The mandatory-to-implement ciphersuite for MLS 1.0 is
<code>MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519</code> which uses
Curve25519 for key exchange, AES-128-GCM for HPKE, HKDF over SHA2-256, and
Ed25519 for signatures.<a href="#section-18.1-15" class="pilcrow">¶</a></p>
<p id="section-18.1-16">Values with the first byte 255 (decimal) are reserved for Private Use.<a href="#section-18.1-16" class="pilcrow">¶</a></p>
<p id="section-18.1-17">New ciphersuite values are assigned by IANA as described in
<a href="#iana-considerations" class="xref">Section 18</a>.<a href="#section-18.1-17" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mls-extension-types">
<section id="section-18.2">
        <h3 id="name-mls-extension-types">
<a href="#section-18.2" class="section-number selfRef">18.2. </a><a href="#name-mls-extension-types" class="section-name selfRef">MLS Extension Types</a>
        </h3>
<p id="section-18.2-1">This registry lists identifiers for extensions to the MLS protocol.  The
extension type field is two bytes wide, so valid extension type values are in
the range 0x0000 to 0xffff.<a href="#section-18.2-1" class="pilcrow">¶</a></p>
<p id="section-18.2-2">Template:<a href="#section-18.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-18.2-3.1">Value: The numeric value of the extension type<a href="#section-18.2-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.2-3.2">Name: The name of the extension type<a href="#section-18.2-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.2-3.3">
            <p id="section-18.2-3.3.1">Message(s): The messages in which the extension may appear, drawn from the following
list:<a href="#section-18.2-3.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-18.2-3.3.2.1">KP: KeyPackage objects<a href="#section-18.2-3.3.2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-18.2-3.3.2.2">LN: LeafNode objects<a href="#section-18.2-3.3.2.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-18.2-3.3.2.3">GC: GroupContext objects (and the <code>group_context_extensions</code> field of
GroupInfo objects)<a href="#section-18.2-3.3.2.3" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-18.2-3.3.2.4">GI: The <code>other_extensions</code> field of GroupInfo objects<a href="#section-18.2-3.3.2.4" class="pilcrow">¶</a>
</li>
            </ul>
</li>
          <li class="normal" id="section-18.2-3.4">Recommended: Whether support for this extension is recommended by the IETF MLS
WG.  Valid values are "Y" and "N".  The "Recommended" column is assigned a
value of "N" unless explicitly requested, and adding a value with a
"Recommended" value of "Y" requires Standards Action <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>.  IESG Approval
is REQUIRED for a Y-&gt;N transition.<a href="#section-18.2-3.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.2-3.5">Reference: The document where this extension is defined<a href="#section-18.2-3.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-18.2-4">Initial contents:<a href="#section-18.2-4" class="pilcrow">¶</a></p>
<table class="center" id="table-7">
          <caption><a href="#table-7" class="selfRef">Table 7</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">Name</th>
              <th class="text-left" rowspan="1" colspan="1">Message(s)</th>
              <th class="text-left" rowspan="1" colspan="1">Recommended</th>
              <th class="text-left" rowspan="1" colspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0000</td>
              <td class="text-left" rowspan="1" colspan="1">RESERVED</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">external_key_id</td>
              <td class="text-left" rowspan="1" colspan="1">KP</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">ratchet_tree</td>
              <td class="text-left" rowspan="1" colspan="1">GI</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">required_capabilities</td>
              <td class="text-left" rowspan="1" colspan="1">GC</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0004</td>
              <td class="text-left" rowspan="1" colspan="1">external_pub</td>
              <td class="text-left" rowspan="1" colspan="1">GI</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0xff00  - 0xffff</td>
              <td class="text-left" rowspan="1" colspan="1">Reserved for Private Use</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
          </tbody>
        </table>
</section>
</div>
<div id="mls-proposal-types">
<section id="section-18.3">
        <h3 id="name-mls-proposal-types">
<a href="#section-18.3" class="section-number selfRef">18.3. </a><a href="#name-mls-proposal-types" class="section-name selfRef">MLS Proposal Types</a>
        </h3>
<p id="section-18.3-1">This registry lists identifiers for types of proposals that can be made for
changes to an MLS group.  The extension type field is two bytes wide, so valid
extension type values are in the range 0x0000 to 0xffff.<a href="#section-18.3-1" class="pilcrow">¶</a></p>
<p id="section-18.3-2">Template:<a href="#section-18.3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-18.3-3.1">Value: The numeric value of the proposal type<a href="#section-18.3-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.3-3.2">Name: The name of the proposal type<a href="#section-18.3-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.3-3.3">Recommended: Whether support for this extension is recommended by the IETF MLS
WG.  Valid values are "Y" and "N".  The "Recommended" column is assigned a
value of "N" unless explicitly requested, and adding a value with a
"Recommended" value of "Y" requires Standards Action <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>.  IESG Approval
is REQUIRED for a Y-&gt;N transition.<a href="#section-18.3-3.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.3-3.4">Reference: The document where this extension is defined<a href="#section-18.3-3.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-18.3-4">Initial contents:<a href="#section-18.3-4" class="pilcrow">¶</a></p>
<table class="center" id="table-8">
          <caption><a href="#table-8" class="selfRef">Table 8</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">Name</th>
              <th class="text-left" rowspan="1" colspan="1">Recommended</th>
              <th class="text-left" rowspan="1" colspan="1">Path Required</th>
              <th class="text-left" rowspan="1" colspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0000</td>
              <td class="text-left" rowspan="1" colspan="1">RESERVED</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">add</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">N</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">update</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0003</td>
              <td class="text-left" rowspan="1" colspan="1">remove</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0004</td>
              <td class="text-left" rowspan="1" colspan="1">psk</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">N</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0005</td>
              <td class="text-left" rowspan="1" colspan="1">reinit</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">N</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0006</td>
              <td class="text-left" rowspan="1" colspan="1">external_init</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0007</td>
              <td class="text-left" rowspan="1" colspan="1">app_ack</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">N</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0008</td>
              <td class="text-left" rowspan="1" colspan="1">group_context_extensions</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0xff00  - 0xffff</td>
              <td class="text-left" rowspan="1" colspan="1">Reserved for Private Use</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
          </tbody>
        </table>
</section>
</div>
<div id="mls-credential-types">
<section id="section-18.4">
        <h3 id="name-mls-credential-types">
<a href="#section-18.4" class="section-number selfRef">18.4. </a><a href="#name-mls-credential-types" class="section-name selfRef">MLS Credential Types</a>
        </h3>
<p id="section-18.4-1">This registry lists identifiers for types of credentials that can be used for
authentication in the MLS protocol.  The credential type field is two bytes wide,
so valid credential type values are in the range 0x0000 to 0xffff.<a href="#section-18.4-1" class="pilcrow">¶</a></p>
<p id="section-18.4-2">Template:<a href="#section-18.4-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-18.4-3.1">Value: The numeric value of the credential type<a href="#section-18.4-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.4-3.2">Name: The name of the credential type<a href="#section-18.4-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.4-3.3">Recommended: Whether support for this credential is recommended by the IETF MLS
WG.  Valid values are "Y" and "N".  The "Recommended" column is assigned a
value of "N" unless explicitly requested, and adding a value with a
"Recommended" value of "Y" requires Standards Action <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span>.  IESG Approval
is REQUIRED for a Y-&gt;N transition.<a href="#section-18.4-3.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-18.4-3.4">Reference: The document where this credential is defined<a href="#section-18.4-3.4" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-18.4-4">Initial contents:<a href="#section-18.4-4" class="pilcrow">¶</a></p>
<table class="center" id="table-9">
          <caption><a href="#table-9" class="selfRef">Table 9</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Value</th>
              <th class="text-left" rowspan="1" colspan="1">Name</th>
              <th class="text-left" rowspan="1" colspan="1">Recommended</th>
              <th class="text-left" rowspan="1" colspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0000</td>
              <td class="text-left" rowspan="1" colspan="1">RESERVED</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0001</td>
              <td class="text-left" rowspan="1" colspan="1">basic</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0x0002</td>
              <td class="text-left" rowspan="1" colspan="1">x509</td>
              <td class="text-left" rowspan="1" colspan="1">Y</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">0xff00  - 0xffff</td>
              <td class="text-left" rowspan="1" colspan="1">Reserved for Private Use</td>
              <td class="text-left" rowspan="1" colspan="1">N/A</td>
              <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
            </tr>
          </tbody>
        </table>
</section>
</div>
<div id="de">
<section id="section-18.5">
        <h3 id="name-mls-designated-expert-pool">
<a href="#section-18.5" class="section-number selfRef">18.5. </a><a href="#name-mls-designated-expert-pool" class="section-name selfRef">MLS Designated Expert Pool</a>
        </h3>
<p id="section-18.5-1">Specification Required <span>[<a href="#RFC8126" class="xref">RFC8126</a>]</span> registry requests are registered
after a three-week review period on the MLS DEs' mailing list:
<a href="mailto:mls-reg-review@ietf.org">mls-reg-review@ietf.org</a>, on the advice of one or more of the MLS DEs. However,
to allow for the allocation of values prior to publication, the MLS
DEs may approve registration once they are satisfied that such a
specification will be published.<a href="#section-18.5-1" class="pilcrow">¶</a></p>
<p id="section-18.5-2">Registration requests sent to the MLS DEs mailing list for review
SHOULD use an appropriate subject (e.g., "Request to register value
in MLS Bar registry").<a href="#section-18.5-2" class="pilcrow">¶</a></p>
<p id="section-18.5-3">Within the review period, the MLS DEs will either approve or deny
the registration request, communicating this decision to the MLS DEs
mailing list and IANA. Denials SHOULD include an explanation and, if
applicable, suggestions as to how to make the request successful.
Registration requests that are undetermined for a period longer than
21 days can be brought to the IESG's attention for resolution using
the <a href="mailto:iesg@ietf.org">iesg@ietf.org</a> mailing list.<a href="#section-18.5-3" class="pilcrow">¶</a></p>
<p id="section-18.5-4">Criteria that SHOULD be applied by the MLS DEs includes determining
whether the proposed registration duplicates existing functionality,
whether it is likely to be of general applicability or useful only
for a single application, and whether the registration description
is clear. For example, the MLS DEs will apply the ciphersuite-related
advisory found in <a href="#ciphersuites" class="xref">Section 6.1</a>.<a href="#section-18.5-4" class="pilcrow">¶</a></p>
<p id="section-18.5-5">IANA MUST only accept registry updates from the MLS DEs and SHOULD
direct all requests for registration to the MLS DEs' mailing list.<a href="#section-18.5-5" class="pilcrow">¶</a></p>
<p id="section-18.5-6">It is suggested that multiple MLS DEs be appointed who are able to
represent the perspectives of different applications using this
specification, in order to enable broadly informed review of
registration decisions. In cases where a registration decision could
be perceived as creating a conflict of interest for a particular
MLS DE, that MLS DE SHOULD defer to the judgment of the other MLS DEs.<a href="#section-18.5-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="the-messagemls-mime-type">
<section id="section-18.6">
        <h3 id="name-the-message-mls-mime-type">
<a href="#section-18.6" class="section-number selfRef">18.6. </a><a href="#name-the-message-mls-mime-type" class="section-name selfRef">The "message/mls" MIME Type</a>
        </h3>
<p id="section-18.6-1">This document registers the "message/mls" MIME media type in order to allow other
protocols (ex: HTTP <span>[<a href="#RFC7540" class="xref">RFC7540</a>]</span>) to convey MLS messages.<a href="#section-18.6-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-18.6-2">
<pre>
  Media type name: message
  Media subtype name: mls
  Required parameters: none
  Optional parameters: version
     version: The MLS protocol version expressed as a string
     &lt;major&gt;.&lt;minor&gt;.  If omitted the version is "1.0", which
     corresponds to MLS ProtocolVersion mls10. If for some reason
     the version number in the MIME type parameter differs from the
     ProtocolVersion embedded in the protocol, the protocol takes
     precedence.

  Encoding scheme: MLS messages are represented using the TLS
     presentation language [RFC8446]. Therefore MLS messages need to be
     treated as binary data.

  Security considerations: MLS is an encrypted messaging layer designed
     to be transmitted over arbitrary lower layer protocols. The
     security considerations in this document (RFC XXXX) also apply.
</pre><a href="#section-18.6-2" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="contributors">
<section id="section-19">
      <h2 id="name-contributors">
<a href="#section-19" class="section-number selfRef">19. </a><a href="#name-contributors" class="section-name selfRef">Contributors</a>
      </h2>
<ul class="normal">
<li class="normal" id="section-19-1.1">Joel Alwen <br>
Wickr <br>
joel.alwen@wickr.com<a href="#section-19-1.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.2">Karthikeyan Bhargavan <br>
INRIA <br>
karthikeyan.bhargavan@inria.fr<a href="#section-19-1.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.3">Cas Cremers <br>
University of Oxford <br>
cremers@cispa.de<a href="#section-19-1.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.4">Alan Duric <br>
Wire <br>
alan@wire.com<a href="#section-19-1.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.5">Britta Hale <br>
Naval Postgraduate School <br>
britta.hale@nps.edu<a href="#section-19-1.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.6">Srinivas Inguva <br>
Twitter <br>
singuva@twitter.com<a href="#section-19-1.6" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.7">Konrad Kohbrok <br>
Aalto University <br>
konrad.kohbrok@datashrine.de<a href="#section-19-1.7" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.8">Albert Kwon <br>
MIT <br>
kwonal@mit.edu<a href="#section-19-1.8" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.9">Brendan McMillion <br>
Cloudflare <br>
brendan@cloudflare.com<a href="#section-19-1.9" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.10">Eric Rescorla <br>
Mozilla <br>
ekr@rtfm.com<a href="#section-19-1.10" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.11">Michael Rosenberg <br>
Trail of Bits <br>
michael.rosenberg@trailofbits.com<a href="#section-19-1.11" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-19-1.12">Thyla van der Merwe <br>
Royal Holloway, University of London <br>
thyla.van.der@merwe.tech<a href="#section-19-1.12" class="pilcrow">¶</a>
</li>
      </ul>
</section>
</div>
<section id="section-20">
      <h2 id="name-references-4">
<a href="#section-20" class="section-number selfRef">20. </a><a href="#name-references-4" class="section-name selfRef">References</a>
      </h2>
<section id="section-20.1">
        <h3 id="name-normative-references-5">
<a href="#section-20.1" class="section-number selfRef">20.1. </a><a href="#name-normative-references-5" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="RFC2104">[RFC2104]</dt>
        <dd>
<span class="refAuthor">Krawczyk, H.</span>, <span class="refAuthor">Bellare, M.</span>, and <span class="refAuthor">R. Canetti</span>, <span class="refTitle">"HMAC: Keyed-Hashing for Message Authentication"</span>, <span class="seriesInfo">RFC 2104</span>, <span class="seriesInfo">DOI 10.17487/RFC2104</span>, <time datetime="1997-02" class="refDate">February 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2104">https://www.rfc-editor.org/rfc/rfc2104</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7540">[RFC7540]</dt>
        <dd>
<span class="refAuthor">Belshe, M.</span>, <span class="refAuthor">Peon, R.</span>, and <span class="refAuthor">M. Thomson, Ed.</span>, <span class="refTitle">"Hypertext Transfer Protocol Version 2 (HTTP/2)"</span>, <span class="seriesInfo">RFC 7540</span>, <span class="seriesInfo">DOI 10.17487/RFC7540</span>, <time datetime="2015-05" class="refDate">May 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7540">https://www.rfc-editor.org/rfc/rfc7540</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8126">[RFC8126]</dt>
        <dd>
<span class="refAuthor">Cotton, M.</span>, <span class="refAuthor">Leiba, B.</span>, and <span class="refAuthor">T. Narten</span>, <span class="refTitle">"Guidelines for Writing an IANA Considerations Section in RFCs"</span>, <span class="seriesInfo">BCP 26</span>, <span class="seriesInfo">RFC 8126</span>, <span class="seriesInfo">DOI 10.17487/RFC8126</span>, <time datetime="2017-06" class="refDate">June 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8126">https://www.rfc-editor.org/rfc/rfc8126</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9180">[RFC9180]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Bhargavan, K.</span>, <span class="refAuthor">Lipp, B.</span>, and <span class="refAuthor">C. Wood</span>, <span class="refTitle">"Hybrid Public Key Encryption"</span>, <span class="seriesInfo">RFC 9180</span>, <span class="seriesInfo">DOI 10.17487/RFC9180</span>, <time datetime="2022-02" class="refDate">February 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9180">https://www.rfc-editor.org/rfc/rfc9180</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-20.2">
        <h3 id="name-informative-references-4">
<a href="#section-20.2" class="section-number selfRef">20.2. </a><a href="#name-informative-references-4" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="art">[art]</dt>
        <dd>
<span class="refAuthor">Cohn-Gordon, K.</span>, <span class="refAuthor">Cremers, C.</span>, <span class="refAuthor">Garratt, L.</span>, <span class="refAuthor">Millican, J.</span>, and <span class="refAuthor">K. Milner</span>, <span class="refTitle">"On Ends-to-Ends Encryption: Asynchronous Group Messaging with Strong Security Guarantees"</span>, <time datetime="2018-01-18" class="refDate">18 January 2018</time>, <span>&lt;<a href="https://eprint.iacr.org/2017/666.pdf">https://eprint.iacr.org/2017/666.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="CLINIC">[CLINIC]</dt>
        <dd>
<span class="refAuthor">Miller, B.</span>, <span class="refAuthor">Huang, L.</span>, <span class="refAuthor">Joseph, A.</span>, and <span class="refAuthor">J. Tygar</span>, <span class="refTitle">"I Know Why You Went to the Clinic: Risks and Realization of HTTPS Traffic Analysis"</span>, <span class="seriesInfo">Privacy Enhancing Technologies pp. 143-163</span>, <span class="seriesInfo">DOI 10.1007/978-3-319-08506-7_8</span>, <time datetime="2014" class="refDate">2014</time>, <span>&lt;<a href="https://doi.org/10.1007/978-3-319-08506-7_8">https://doi.org/10.1007/978-3-319-08506-7_8</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="doubleratchet">[doubleratchet]</dt>
        <dd>
<span class="refAuthor">Cohn-Gordon, K.</span>, <span class="refAuthor">Cremers, C.</span>, <span class="refAuthor">Dowling, B.</span>, <span class="refAuthor">Garratt, L.</span>, and <span class="refAuthor">D. Stebila</span>, <span class="refTitle">"A Formal Security Analysis of the Signal Messaging Protocol"</span>, <span class="seriesInfo">2017 IEEE European Symposium on Security and Privacy (EuroS&amp;P)</span>, <span class="seriesInfo">DOI 10.1109/eurosp.2017.27</span>, <time datetime="2017-04" class="refDate">April 2017</time>, <span>&lt;<a href="https://doi.org/10.1109/eurosp.2017.27">https://doi.org/10.1109/eurosp.2017.27</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="HCJ16">[HCJ16]</dt>
        <dd>
<span class="refAuthor">Husák, M.</span>, <span class="refAuthor">Čermák, M.</span>, <span class="refAuthor">Jirsík, T.</span>, and <span class="refAuthor">P. Čeleda</span>, <span class="refTitle">"HTTPS traffic analysis and client identification using passive SSL/TLS fingerprinting"</span>, <span class="seriesInfo">EURASIP Journal on Information Security Vol. 2016</span>, <span class="seriesInfo">DOI 10.1186/s13635-016-0030-7</span>, <time datetime="2016-02" class="refDate">February 2016</time>, <span>&lt;<a href="https://doi.org/10.1186/s13635-016-0030-7">https://doi.org/10.1186/s13635-016-0030-7</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-mls-architecture">[I-D.ietf-mls-architecture]</dt>
        <dd>
<span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Rescorla, E.</span>, <span class="refAuthor">Omara, E.</span>, <span class="refAuthor">Inguva, S.</span>, <span class="refAuthor">Kwon, A.</span>, and <span class="refAuthor">A. Duric</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Architecture"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mls-architecture-07</span>, <time datetime="2021-10-04" class="refDate">4 October 2021</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-architecture-07">https://datatracker.ietf.org/doc/html/draft-ietf-mls-architecture-07</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-trans-rfc6962-bis">[I-D.ietf-trans-rfc6962-bis]</dt>
        <dd>
<span class="refAuthor">Laurie, B.</span>, <span class="refAuthor">Langley, A.</span>, <span class="refAuthor">Kasper, E.</span>, <span class="refAuthor">Messeri, E.</span>, and <span class="refAuthor">R. Stradling</span>, <span class="refTitle">"Certificate Transparency Version 2.0"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-trans-rfc6962-bis-42</span>, <time datetime="2021-08-31" class="refDate">31 August 2021</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-trans-rfc6962-bis-42">https://datatracker.ietf.org/doc/html/draft-ietf-trans-rfc6962-bis-42</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5116">[RFC5116]</dt>
        <dd>
<span class="refAuthor">McGrew, D.</span>, <span class="refTitle">"An Interface and Algorithms for Authenticated Encryption"</span>, <span class="seriesInfo">RFC 5116</span>, <span class="seriesInfo">DOI 10.17487/RFC5116</span>, <time datetime="2008-01" class="refDate">January 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5116">https://www.rfc-editor.org/rfc/rfc5116</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6125">[RFC6125]</dt>
        <dd>
<span class="refAuthor">Saint-Andre, P.</span> and <span class="refAuthor">J. Hodges</span>, <span class="refTitle">"Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 6125</span>, <span class="seriesInfo">DOI 10.17487/RFC6125</span>, <time datetime="2011-03" class="refDate">March 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6125">https://www.rfc-editor.org/rfc/rfc6125</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7696">[RFC7696]</dt>
        <dd>
<span class="refAuthor">Housley, R.</span>, <span class="refTitle">"Guidelines for Cryptographic Algorithm Agility and Selecting Mandatory-to-Implement Algorithms"</span>, <span class="seriesInfo">BCP 201</span>, <span class="seriesInfo">RFC 7696</span>, <span class="seriesInfo">DOI 10.17487/RFC7696</span>, <time datetime="2015-11" class="refDate">November 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7696">https://www.rfc-editor.org/rfc/rfc7696</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8032">[RFC8032]</dt>
        <dd>
<span class="refAuthor">Josefsson, S.</span> and <span class="refAuthor">I. Liusvaara</span>, <span class="refTitle">"Edwards-Curve Digital Signature Algorithm (EdDSA)"</span>, <span class="seriesInfo">RFC 8032</span>, <span class="seriesInfo">DOI 10.17487/RFC8032</span>, <time datetime="2017-01" class="refDate">January 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8032">https://www.rfc-editor.org/rfc/rfc8032</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9000">[RFC9000]</dt>
        <dd>
<span class="refAuthor">Iyengar, J., Ed.</span> and <span class="refAuthor">M. Thomson, Ed.</span>, <span class="refTitle">"QUIC: A UDP-Based Multiplexed and Secure Transport"</span>, <span class="seriesInfo">RFC 9000</span>, <span class="seriesInfo">DOI 10.17487/RFC9000</span>, <time datetime="2021-05" class="refDate">May 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9000">https://www.rfc-editor.org/rfc/rfc9000</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SECG">[SECG]</dt>
        <dd>
<span class="refTitle">"Elliptic Curve Cryptography, Standards for Efficient Cryptography Group, ver. 2"</span>, <time datetime="2009" class="refDate">2009</time>, <span>&lt;<a href="https://secg.org/sec1-v2.pdf">https://secg.org/sec1-v2.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SHS">[SHS]</dt>
        <dd>
<span class="refAuthor">Dang, Q.</span>, <span class="refTitle">"Secure Hash Standard"</span>, <span class="seriesInfo">National Institute of Standards and Technology report</span>, <span class="seriesInfo">DOI 10.6028/nist.fips.180-4</span>, <time datetime="2015-07" class="refDate">July 2015</time>, <span>&lt;<a href="https://doi.org/10.6028/nist.fips.180-4">https://doi.org/10.6028/nist.fips.180-4</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="signal">[signal]</dt>
      <dd>
<span class="refAuthor">Perrin(ed), T.</span> and <span class="refAuthor">M. Marlinspike</span>, <span class="refTitle">"The Double Ratchet Algorithm"</span>, <time datetime="2016-11-20" class="refDate">20 November 2016</time>, <span>&lt;<a href="https://www.signal.org/docs/specifications/doubleratchet/">https://www.signal.org/docs/specifications/doubleratchet/</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="protocol-origins-of-example-trees">
<section id="appendix-A">
      <h2 id="name-protocol-origins-of-example">
<a href="#appendix-A" class="section-number selfRef">Appendix A. </a><a href="#name-protocol-origins-of-example" class="section-name selfRef">Protocol Origins of Example Trees</a>
      </h2>
<p id="appendix-A-1">Protocol operations in MLS give rise to specific forms of ratchet tree,
typically affecting a whole direct path at once.  In this section, we describe
the protocol operations that could have given rise to the various example trees
in this document.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
<p id="appendix-A-2">To construct the tree in <a href="#full-tree" class="xref">Figure 9</a>:<a href="#appendix-A-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-3.1">A creates a group with B, ..., G<a href="#appendix-A-3.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-3.2">Each member sends an empty Commit setting its direct path<a href="#appendix-A-3.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="appendix-A-4">To construct the tree in <a href="#resolution-tree" class="xref">Figure 10</a>:<a href="#appendix-A-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-5.1">A creates a group with B, C, D, as well as some members outside this subtree<a href="#appendix-A-5.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-5.2">D removes C, setting Z and the top node (as well as any further nodes in the
direct path)<a href="#appendix-A-5.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-5.3">A member outside this subtree removes B, blanking B's direct path<a href="#appendix-A-5.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-5.4">A adds a new member at C with a partial Commit, adding it as unmerged at Z<a href="#appendix-A-5.4" class="pilcrow">¶</a>
</li>
      </ul>
<p id="appendix-A-6">To construct the tree in <a href="#evolution-tree" class="xref">Figure 11</a>:<a href="#appendix-A-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-7.1">A creates a group with B, C, D<a href="#appendix-A-7.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-7.2">B sends a full Commit, setting X and Y<a href="#appendix-A-7.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-7.3">D removes C, setting Z and Y<a href="#appendix-A-7.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-7.4">
          <p id="appendix-A-7.4.1">B adds a new member at C with a full Commit<a href="#appendix-A-7.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-7.4.2.1">The Add proposal adds C as unmerged at Z and Y<a href="#appendix-A-7.4.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="appendix-A-7.4.2.2">The path in the Commit resets X and Y, clearing Y's unmerged leaves<a href="#appendix-A-7.4.2.2" class="pilcrow">¶</a>
</li>
          </ul>
</li>
      </ul>
<p id="appendix-A-8">To construct the tree in <a href="#parent-hash-tree" class="xref">Figure 12</a>:<a href="#appendix-A-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-9.1">A creates a group with B, ... G<a href="#appendix-A-9.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-9.2">A removes F in a full Commit, setting T, U, and W<a href="#appendix-A-9.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-9.3">E sends an empty Commit, setting X, Y, and W<a href="#appendix-A-9.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-9.4">A adds a new member at F in a partial Commit, adding F as unmerged at X, Y,
and W<a href="#appendix-A-9.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-9.5">A removes D, resetting T, U, and W (in particular, F is no longer unmerged at
W)<a href="#appendix-A-9.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-A-9.6">
          <p id="appendix-A-9.6.1">A adds new memebers at D and H in a partial commit<a href="#appendix-A-9.6.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A-9.6.2.1">D is added as unmerged at U, W<a href="#appendix-A-9.6.2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="appendix-A-9.6.2.2">H is added as unmerged at Y, W<a href="#appendix-A-9.6.2.2" class="pilcrow">¶</a>
</li>
          </ul>
</li>
      </ul>
</section>
</div>
<div id="array-based-trees">
<section id="appendix-B">
      <h2 id="name-array-based-trees">
<a href="#appendix-B" class="section-number selfRef">Appendix B. </a><a href="#name-array-based-trees" class="section-name selfRef">Array-Based Trees</a>
      </h2>
<p id="appendix-B-1">One benefit of using left-balanced trees is that they admit a simple
flat array representation.  In this representation, leaf nodes are
even-numbered nodes, with the n-th leaf at 2*n.  Intermediate nodes
are held in odd-numbered nodes.  For example, tree with 11 leaves has
the following structure:<a href="#appendix-B-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-B-2">
<pre>
                                                   X
                           X
               X                       X                       X
         X           X           X           X           X
      X     X     X     X     X     X     X     X     X     X     X
Node: 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20
Leaf: 0     1     2     3     4     5     6     7     8     9    10
</pre><a href="#appendix-B-2" class="pilcrow">¶</a>
</div>
<p id="appendix-B-3">This allows us to compute relationships between tree nodes simply by
manipulating indices, rather than having to maintain complicated structures in
memory. The basic rule is that the high-order bits of parent and child nodes
indices have the following relation (where <code>x</code> is an arbitrary bit string):<a href="#appendix-B-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-B-4">
<pre>
parent=01x =&gt; left=00x, right=10x
</pre><a href="#appendix-B-4" class="pilcrow">¶</a>
</div>
<p id="appendix-B-5">Since node relationships are implicit, the algorithms for adding and removing
nodes at the right edge of the tree are quite simple:<a href="#appendix-B-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-B-6.1">Add: Append a blank parent node to the array of nodes, then append the new
leaf node<a href="#appendix-B-6.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="appendix-B-6.2">Remove: Remove the rightmost two nodes from the array of nodes<a href="#appendix-B-6.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="appendix-B-7">The following python code demonstrates the tree computations necessary to use an
array-based tree for MLS.<a href="#appendix-B-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-B-8">
<pre>
# The exponent of the largest power of 2 less than x. Equivalent to:
#   int(math.floor(math.log(x, 2)))
def log2(x):
    if x == 0:
        return 0

    k = 0
    while (x &gt;&gt; k) &gt; 0:
        k += 1
    return k-1

# The level of a node in the tree. Leaves are level 0, their parents are
# level 1, etc. If a node's children are at different levels, then its
# level is the max level of its children plus one.
def level(x):
    if x &amp; 0x01 == 0:
        return 0

    k = 0
    while ((x &gt;&gt; k) &amp; 0x01) == 1:
        k += 1
    return k

# The number of nodes needed to represent a tree with n leaves.
def node_width(n):
    if n == 0:
        return 0
    else:
        return 2*(n - 1) + 1

# The index of the root node of a tree with n leaves.
def root(n):
    w = node_width(n)
    return (1 &lt;&lt; log2(w)) - 1

# The left child of an intermediate node. Note that because the tree is
# left-balanced, there is no dependency on the size of the tree.
def left(x):
    k = level(x)
    if k == 0:
        raise Exception('leaf node has no children')

    return x ^ (0x01 &lt;&lt; (k - 1))

# The right child of an intermediate node. Depends on the number of
# leaves because the straightforward calculation can take you beyond the
# edge of the tree.
def right(x, n):
    k = level(x)
    if k == 0:
        raise Exception('leaf node has no children')

    r = x ^ (0x03 &lt;&lt; (k - 1))
    while r &gt;= node_width(n):
        r = left(r)
    return r

# The immediate parent of a node. May be beyond the right edge of the
# tree.
def parent_step(x):
    k = level(x)
    b = (x &gt;&gt; (k + 1)) &amp; 0x01
    return (x | (1 &lt;&lt; k)) ^ (b &lt;&lt; (k + 1))

# The parent of a node. As with the right child calculation, we have to
# walk back until the parent is within the range of the tree.
def parent(x, n):
    if x == root(n):
        raise Exception('root node has no parent')

    p = parent_step(x)
    while p &gt;= node_width(n):
        p = parent_step(p)
    return p

# The other child of the node's parent.
def sibling(x, n):
    p = parent(x, n)
    if x &lt; p:
        return right(p, n)
    else:
        return left(p)

# The direct path of a node, ordered from leaf to root.
def direct_path(x, n):
    r = root(n)
    if x == r:
        return []

    d = []
    while x != r:
        x = parent(x, n)
        d.append(x)
    return d

# The copath of a node, ordered from leaf to root.
def copath(x, n):
    if x == root(n):
        return []

    d = direct_path(x, n)
    d.insert(0, x)
    d.pop()
    return [sibling(y, n) for y in d]

# The common ancestor of two nodes is the lowest node that is in the
# direct paths of both leaves.
def common_ancestor_semantic(x, y, n):
    dx = set([x]) | set(direct_path(x, n))
    dy = set([y]) | set(direct_path(y, n))
    dxy = dx &amp; dy
    if len(dxy) == 0:
        raise Exception('failed to find common ancestor')

    return min(dxy, key=level)

# The common ancestor of two nodes is the lowest node that is in the
# direct paths of both leaves.
def common_ancestor_direct(x, y, _):
    # Handle cases where one is an ancestor of the other
    lx, ly = level(x)+1, level(y)+1
    if (lx &lt;= ly) and (x&gt;&gt;ly == y&gt;&gt;ly):
      return y
    elif (ly &lt;= lx) and (x&gt;&gt;lx == y&gt;&gt;lx):
      return x

    # Handle other cases
    xn, yn = x, y
    k = 0
    while xn != yn:
       xn, yn = xn &gt;&gt; 1, yn &gt;&gt; 1
       k += 1
    return (xn &lt;&lt; k) + (1 &lt;&lt; (k-1)) - 1
</pre><a href="#appendix-B-8" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="link-based-trees">
<section id="appendix-C">
      <h2 id="name-link-based-trees">
<a href="#appendix-C" class="section-number selfRef">Appendix C. </a><a href="#name-link-based-trees" class="section-name selfRef">Link-Based Trees</a>
      </h2>
<p id="appendix-C-1">An implementation may choose to store ratchet trees in a "link-based"
representation, where each node stores references to its parents and/or
children.   (As opposed to the array-based representation suggested above, where
these relationships are computed from relationships between nodes' indices in
the array.)  Such an implementation needs to update these links to maintain the
left-balanced structure of the tree as the tree is extended to add new members,
or truncated when memebers are removed.<a href="#appendix-C-1" class="pilcrow">¶</a></p>
<p id="appendix-C-2">The following code snippet shows how these algorithms could be implemented in
Python.<a href="#appendix-C-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-C-3">
<pre>
class Node:
    def __init__(self, value, parent=None, left=None, right=None):
        self.value = value    # Value of the node
        self.parent = parent  # Parent node
        self.left = left      # Left child node
        self.right = right    # Right child node

    def leaf(self):
        return self.left == None and self.right == None

    def span(self):
        if self.leaf():
            return 1
        return self.left.span() + self.right.span()

    def full(self):
        span = self.span()
        while span % 2 == 0:
            span &gt;&gt;= 1
        return span == 1

    def rightmost_leaf(self):
        X = self
        while X.right != None:
            X = X.right
        return X

class Tree:
    def __init__(self):
        self.root = None  # Root node of the tree, initially empty

    def extend(self, N):
        if self.root == None:
            self.root = N
            return

        # Identify the proper point to insert the new parent node
        X = self.root.rightmost_leaf()
        while X.full() and X != self.root:
            X = X.parent

        # If X is not full, insert the new parent under X
        P = Node("_", right=N)
        N.parent = P
        if not X.full():
            P.parent = X
            P.left = X.right
            X.right.parent = P
            X.right = P
            return

        # If X is full, then X is the root, so P replaces the root
        P.left = self.root
        self.root.parent = P
        self.root = P
        return

    def truncate(self):
        X = self.root.rightmost_leaf()
        if X == self.root:
            self.root = None
            return

        # If X's parent is the root, then shift the root to the left
        if X.parent == self.root:
            self.root = self.root.left
            self.root.parent = None
            return

        # Otherwise, reassign the right child of the parent's parent
        Q = X.parent.parent
        Q.right = X.parent.left
        Q.right.parent = Q
        return
</pre><a href="#appendix-C-3" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-D">
      <h2 id="name-authors-addresses-4">
<a href="#name-authors-addresses-4" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Richard Barnes</span></div>
<div dir="auto" class="left"><span class="org">Cisco</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rlb@ipv.sx" class="email">rlb@ipv.sx</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Benjamin Beurdouche</span></div>
<div dir="auto" class="left"><span class="org">Inria &amp; Mozilla</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@beurdouche.com" class="email">ietf@beurdouche.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@raphaelrobert.com" class="email">ietf@raphaelrobert.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Jon Millican</span></div>
<div dir="auto" class="left"><span class="org">Facebook</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:jmillican@fb.com" class="email">jmillican@fb.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Emad Omara</span></div>
<div dir="auto" class="left"><span class="org">Google</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:emadomara@google.com" class="email">emadomara@google.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Katriel Cohn-Gordon</span></div>
<div dir="auto" class="left"><span class="org">University of Oxford</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:me@katriel.co.uk" class="email">me@katriel.co.uk</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
