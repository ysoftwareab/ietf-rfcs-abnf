<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>DKIM Third-Party Authorization for Author Domain Signing Practices</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="DKIM Third-Party Authorization for Author Domain Signing Practices">
<meta name="keywords" content="TPA-label, Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">DKIM Working Group</td><td class="header">D. Otis</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Trend Micro, NSSG</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">May 24, 2008</td></tr>
<tr><td class="header">Expires: November 25, 2008</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />DKIM Third-Party Authorization for Author Domain Signing Practices<br />draft-otis-dkim-tpa-adsp-00</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on November 25, 2008.</p>

<h3>Abstract</h3>

<p>TPA-label is a DNS-based prefix mechanism for DKIM policy records as a means to authorize
        Third-Party domains. This mechanism allows first-party domains to autonomously authorize a
        range of third-party domains in a scalable, individual DNS transaction. This authorization
        extends the scope of DKIM policy assertions to supplant more difficult to administer
        mechanisms. Alternatives for facilitating third-party authorizations currently necessitate
        the coordination between two or more domains by setting up selector/key DNS records, DNS
        zone delegations, or the regular exchange of public/private keys.
</p>
<p>Checking DKIM policies may occur when a From header email-address is not within the domain
        of a valid DKIM signature. When a Third-Party signature is found, TPA-labels offer an
        efficient means for email address domains to authorize specific third-party signing domains.
        The scope of the authorization may separately assert identity authentication for From and
        Sender and Resent-* headers for email-addresses within the authorizing domain. Identity
        authentication can be asserted by the scope of the authorization, even when signed by a
        Third-Party domain. In addition, the RFC2821.MailFrom domain can authorize domains for
        controlling DSNs.<br />
<br />

</p>
<h3>Requirements Language</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in
          <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Envelope Authorizations<br />
<a href="#anchor3">3.</a>&nbsp;
Evaluating Signing Domains<br />
<a href="#anchor4">4.</a>&nbsp;
Authorization Scope<br />
<a href="#anchor5">5.</a>&nbsp;
TPA-labeled Policy Assertions<br />
<a href="#anchor6">6.</a>&nbsp;
Scope<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">6.1.</a>&nbsp;
From Originator Header Field<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">6.2.</a>&nbsp;
MailFrom Parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">6.3.</a>&nbsp;
Other than From Originating Header Fields<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">6.4.</a>&nbsp;
NO-TPA<br />
<a href="#anchor11">7.</a>&nbsp;
Authorized Signing Domain<br />
<a href="#anchor12">8.</a>&nbsp;
Use of TPA-labeled Policy<br />
<a href="#anchor13">9.</a>&nbsp;
Restricted Local-part<br />
<a href="#IANA">10.</a>&nbsp;
IANA Considerations<br />
<a href="#Security">11.</a>&nbsp;
Security Considerations<br />
<a href="#Acknowledgements">12.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">13.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">13.1.</a>&nbsp;
References - Normative<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">13.2.</a>&nbsp;
References - Informative<br />
<a href="#anchor16">Appendix&nbsp;A.</a>&nbsp;
Change Log<br />
<a href="#anchor17">Appendix&nbsp;B.</a>&nbsp;
DNS Example of TPA-label policy record placement<br />
<a href="#anchor18">Appendix&nbsp;C.</a>&nbsp;
C code for label generation<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>This document describes how any email-address domain publishing DKIM policy records such as
        those defined in <a class='info' href='#I-D.otis-dkim-adsp'>[I&#8209;D.otis&#8209;dkim&#8209;adsp]<span> (</span><span class='info'>Contents, T., Address, A., and D. Otis, &ldquo;DKIM Author Domain Signing Practices (ADSP),&rdquo; June&nbsp;2008.</span><span>)</span></a> can also autonomously authorize <a class='info' href='#RFC4871'>[RFC4871]<span> (</span><span class='info'>Allman, E., Callas, J., Delany, M., Libbey, M., Fenton, J., and M. Thomas, &ldquo;DomainKeys Identified Mail (DKIM) Signatures,&rdquo; May&nbsp;2007.</span><span>)</span></a> signing by specific third-party domains. Recommended or suggested
        actions for DKIM receivers are not included, and are considered "out-of-scope" for this
        document. The receiver is assumed to better understand their environment's impact upon the
        performance of DKIM signatures and how results are utilized within their domain.
</p>
<p>TPA-labels authorize signing domains to permit compliance with DKIM policies. TPA-label
        authorized domains are to be considered equivalent to the authorizing domain for the
        application of DKIM policies. This mechanism eliminates the complex coordination of
        selector/key DNS records, DNS delegation, or exchanges of public/private keys between two or
        more domains otherwise required to facilitate desired authorizations.
</p>
<p>Trust is an essential requisite before the DKIM signature header field's 'i=' semantics or
        the TPA-label policy record's "-i" suffix scope assertions provide valuable advisory
        information. This advisory information regarding "on-behalf-of" identity authentication
        enables safer message annotations to better ensure trusted identities can be recognized.
</p>
<p>TPA-labeled policy records also convey which third-party domains are authoritative.
        Although third-party domains are unable to utilize DKIM signature's 'i=' semantics to assert
        which identifiers on whose behalf a signature was added, the related identity can be
        constrained by the policy record's 'g=' parameter and by permitted header fields specified
        by the policy scope parameter. Policy scoping in this manner enables control over the
        recognition of trusted identities, as well as indicating when a message source may require
        added scrutiny.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Envelope Authorizations</h3>

<p>DKIM is fully independent of the SMTP Client and the <a class='info' href='#RFC2821'>[RFC2821]<span> (</span><span class='info'>Klensin, J., &ldquo;Simple Mail Transfer Protocol,&rdquo; April&nbsp;2001.</span><span>)</span></a>.MailFrom
        email-address. Depending upon the normal policy assertions, allowing the <a class='info' href='#RFC2821'>[RFC2821]<span> (</span><span class='info'>Klensin, J., &ldquo;Simple Mail Transfer Protocol,&rdquo; April&nbsp;2001.</span><span>)</span></a>.MailFrom email-address to authorize signing domains and assert policies
        may prevent Delivery Status Notifications (DSNs) from being sent when the domain is not
        authorized. Conversely, authorization may ensure DSNs are not dropped when the signing
        domain is authorized. The application of TPA-labels at the MailFrom domain represents an
        entirely optional strategy which may or may not prove either effective or practical. The
        MailFrom scope is offered only for experimentation.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Evaluating Signing Domains</h3>

<p>Regulatory agencies are unable to control Internet abuse by curtailing access. Unlike IPv4
        addresses, there is virtually no limit on the number of domain-names available. Registrar
        pricing of domain-names need to remain uniform. Otherwise, fees based upon the intrinsic
        value of a name could cause name holders to become extortion targets. High initial costs for
        domain-names are also unlikely to represent a deterrent, largely due to high levels of
        payment fraud. Driven by market forces, registrars also offer the sampling of domain names
        (domain tasting) to generate additional revenue.
</p>
<p>In addition, DKIM can not directly identify the domain transmitting the message, and can
        not prevent abusive message replay. Abusive message replay may prove indistinguishable from
        bulk mailings of various types. Since abuse may not be controlled by the signing domain,
        message acceptance will likely remain largely dependent upon the reputation of the SMTP
        client's IP address. Abuse reporting facilitated by DKIM signatures should therefore first
        select signing domains that correspond with domains administering the SMTP Client publicly
        transmitting the message. A correspondence between SMTP Client and the DKIM signing domain
        can be retained by using TPA-label authorizations.
</p>
<p>The receiver's domain evaluation process will confront many domains with unknown
        reputations. New domains are constantly being introduced where registrars are unable to
        prevent bad actors from controlling either a new or previously held domain names. The
        receiver may seek to limit the DKIM verification process, since acquiring policy records or
        DKIM keys may inadvertently leak valuable information that benefit bad actors. Processing
        all DKIM signatures may also inundate a receiver's limited resources. As a result,
        validating DKIM signatures and obtaining policy resource records might become limited to
        known trustworthy domains. Signing domains authorized with TPA-labels by domains having good
        reputations provide a means to safely extend a limited verification resources.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Authorization Scope</h3>

<p>An Authorization effort without using TPA-labels will likely involve sharing details
        between the domain owner, and one or more email and DNS providers. Since there are many ways
        in which authorizations can be accomplished, it is unlikely there will be consistent or
        standardized formats for exchanging the necessary information. In addition, in the case of
        security breaches, the wrong party might be held accountable for content never seen nor
        logged by them. The TPA-label authorization scheme clarifies who signed the message and on
        whose behalf, while permitting greater control by the authorizing domain.
</p>
<p>TPA-labeled policy records replace domain delegations, selector/key record mirroring, or
        key exchanges. Significant amounts of detail is associated with selector/key records. These
        details include user limitations, suitable services, key resource record's Time-To-Live,
        revocation and update procedures, and how the DKIM Signature header field's 'i=' semantics
        are to be applied. The TPA-labeled policy records allow authorizing domains an improved
        ability to limit the scope of their authorizations and associated identities.
</p>
<p>When a signing domain differs from that of a domain within the header email-address,
        TPA-labeled policy records can safely extend compliance where the action of only the
        email-address domain is required. In addition, just as a DKIM signature can assert an
        email-address has been authenticated via the "i" construct, a signing domain that only signs
        authenticated email-addresses from the authorizing domain can be denoted by the "-i" suffix
        on the scope assertion within the corresponding TPA-labeled policy record. A TPA-labeled
        policy record returning a scope with an "-i" suffix indicates the domain assures that
        email-addresses identities from the authorizing domain have been authenticated. This
        assertion remains valid even when signing domains and the email-address domains differ.
</p>
<p>Without the "-i" suffix on the scope assertion within the TPA-labeled policy record, the
        authorized domain is designated as providing only acceptable signatures. The same would be
        true for a DKIM signature lacking the "i" parameter. While offering only valid signatures
        will not ensure all possible spoofing is prevented, messages signed in this manner should
        not receive annotations indicating authenticated identities either.
</p>
<p>Choosing not to implement identity authentication may represent an economical means to
        administer domains employing DKIM signatures. Authorizing domains to play the role of only
        providing acceptable signatures may be suitable for non-critical messages, where the goal
        might be to improve delivery acceptance.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
TPA-labeled Policy Assertions</h3>

<p>Syntax descriptions use the form described in Augmented BNF for Syntax Specifications <a class='info' href='#RFC5234'>[RFC5234]<span> (</span><span class='info'>Crocker, D. and P. Overell, &ldquo;Augmented BNF for Syntax Specifications: ABNF,&rdquo; January&nbsp;2008.</span><span>)</span></a>. The "base32" function is defined in <a class='info' href='#RFC4648'>[RFC4648]<span> (</span><span class='info'>Josefsson, S., &ldquo;The Base16, Base32, and Base64 Data Encodings,&rdquo; October&nbsp;2006.</span><span>)</span></a> and the
        "sha-1" hash function is defined in <a class='info' href='#FIPS.180-2.2002'>[FIPS.180&#8209;2.2002]<span> (</span><span class='info'>National Institute of Standards and Technology, &ldquo;Secure Hash Standard,&rdquo; August&nbsp;2002.</span><span>)</span></a>. The TPA-labeled policy
        records follow the tag-value syntax described in section 4.2.1 of <a class='info' href='#I-D.otis-dkim-adsp'>[I&#8209;D.otis&#8209;dkim&#8209;adsp]<span> (</span><span class='info'>Contents, T., Address, A., and D. Otis, &ldquo;DKIM Author Domain Signing Practices (ADSP),&rdquo; June&nbsp;2008.</span><span>)</span></a> and section 3.2 of <a class='info' href='#RFC4871'>[RFC4871]<span> (</span><span class='info'>Allman, E., Callas, J., Delany, M., Libbey, M., Fenton, J., and M. Thomas, &ldquo;DomainKeys Identified Mail (DKIM) Signatures,&rdquo; May&nbsp;2007.</span><span>)</span></a>. Unrecognized
        tags and tags with illegal values MUST be ignored. In the ABNF below, the WSP token is
        inherited from <a class='info' href='#RFC2822'>[RFC2822]<span> (</span><span class='info'>Resnick, P., &ldquo;Internet Message Format,&rdquo; April&nbsp;2001.</span><span>)</span></a>. The ALPHA and DIGIT tokens are imported from <a class='info' href='#RFC5234'>[RFC5234]<span> (</span><span class='info'>Crocker, D. and P. Overell, &ldquo;Augmented BNF for Syntax Specifications: ABNF,&rdquo; January&nbsp;2008.</span><span>)</span></a>. The function "lcase" converts upper-case ALPHA characters to
        lower-case. The function "sha-1" returns a hash that is converted to a base32 character set.
        The terminating period is not included in domain-name conversions. In addition, a newline
        character (0x0A) is appended to the end of the string to match a command line generation of
        SHA1 values. The tags used in TPA-labeled policy records are as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  asterisk = %x2A ; "*"
  dash = %x2D ; "-"
  dot = %x2E ; "."
  underscore = %x5F ; "_"
  ANY = asterisk dot ; "*."
  dns-char = ALPHA / DIGIT / dash
  id-prefix = ALPHA / DIGIT
  label = id-prefix [*61dns-char id-prefix]
  sldn = label dot label
  base-char = (dns-char / underscore)
  domain = *(label dot) sldn
  tpa-label = base32( sha-1( lcase(signing-domain)))
</pre></div><br /><hr class="insert" />
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="center"><col align="left">
<tr><th align="center">Tag</th><th align="left">Function</th></tr>
<tr>
<td align="center">scope=</td>
<td align="left">Authorization Scope List (as-list)</td>
</tr>
<tr>
<td align="center">tpa=</td>
<td align="left">Authorized Domains List (ad-list)</td>
</tr>
<tr>
<td align="center">g=</td>
<td align="left">Local-part restriction</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;TPA-label Policy Tags&nbsp;</b></font><br /></td></tr></table><hr class="insert" />
<br /><hr class="insert" />
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left" width="10%"><col align="left"><col align="left" width="20%">
<tr><th align="left">Scope Values</th><th align="left">Field or Parameter</th><th align="left">Identity Authenticated</th></tr>
<tr>
<td align="left">F</td>
<td align="left">From (Author) Header</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">F-i</td>
<td align="left">From (Author) Header</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">O</td>
<td align="left">Other than From (Author) Headers</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">O-i</td>
<td align="left">Other than From (Author) Headers</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">M</td>
<td align="left">MailFrom</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">M-i</td>
<td align="left">MailFrom</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">NO-TPA</td>
<td align="left">All</td>
<td align="left">No</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;TPA-label Policy Scope Values&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The receiver obtains the TPA-labeled policy record for the email-address domain using a DNS
        query for an IN class TXT resource record. The tpa-label is created by processing the domain
        found within the signature's "d=" parameter (does not include the trailing period). The
        tpa-label would be placed below the normal policy records, for example
        "._adsp.&lt;email-address domain&gt;". These labels would then be used to access the
        TPA-labeled policy TXT records. Character-strings contained within the TXT resource record
        are concatenated into forming a single string. A character-string is a single length octet
        followed by that number of characters treated as binary information. As an example, a
        TPA-labeled policy record may be located at these domains:</p>
<blockquote class="text">
<p>
</p>
<p>&lt;tpa-label&gt;._adsp.&lt;email-address domain&gt;.
</p>
</blockquote><p>
        <br />
<br />

</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Scope</h3>

<p>scope= Authorization Scope List (Optional). This tag defines a list of scoping assertions
        for various email-address locations within the message.
</p>
<p>
        </p>
<blockquote class="text">
<p>scope = "F" / "F-i" / "O" / "O-i" / "M" / "M-i" / "NO-TPA"
</p>
<p>as-list = "scope" [WSP] "=" [WSP] scope 0*([WSP] ":" [WSP] scope)
</p>
</blockquote><p>
      
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
From Originator Header Field</h3>

<p>The "F" or "F-i" scope asserts that messages carrying the email-address domain within the
          From header field are authorized to be signed by the tpa listed domain. When the "-i"
          suffix is included, it can be assumed identities for the scoped header have been
            authenticated.<br />
<br />

</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
MailFrom Parameter</h3>

<p>This "M" or "M-i" scope asserts that messages carrying the email-address domain within
          the MailFrom parameter are authorized to be signed by the authorized domain. When the "-i"
          suffix is included, it can be assumed identities for the MailFrom have been
            authenticated.<br />
<br />

</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Other than From Originating Header Fields</h3>

<p>The "O" or "O-i" scope asserts that messages carrying the email-address domain within the
          Sender or Resent-* header fields are authorized to be signed by the authorized domain.
          When the "-i" suffix is included, it can be assumed identities for the scoped header have
          been authenticated.<br />
<br />

</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
NO-TPA</h3>

<p>The "NO-TPA" scope asserts that domain does not publish TPA-labeled policy
            records.<br />
<br />

</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Authorized Signing Domain</h3>

<p>tpa= Authorized Signing Domain list (Optional). This tag repeats all or portions of the
        domain encoded within the tpa-label. This option ensures proper handling of possible hash
        collisions. When a domain is prefixed with the "*." ANY label, then all subdomains of this
        domain are to be considered included within the list.
</p>
<p>
        </p>
<blockquote class="text">
<p>ad = [ANY] domain
</p>
<p>ad-list = "tpa" [WSP] "=" [WSP] ad 0*([WSP] ":" [WSP] ad)
</p>
<p>
            <br />
<br />

          
</p>
</blockquote><p>
      
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Use of TPA-labeled Policy</h3>

<p>Use of TPA-labeled policy is subsequent to the discovery of the policy record specified by
          <a class='info' href='#I-D.otis-dkim-adsp'>[I&#8209;D.otis&#8209;dkim&#8209;adsp]<span> (</span><span class='info'>Contents, T., Address, A., and D. Otis, &ldquo;DKIM Author Domain Signing Practices (ADSP),&rdquo; June&nbsp;2008.</span><span>)</span></a>. Only when an acceptable First-Party signature was not
        discovered, and the normal policy record contains the "scope" tag then:
</p>
<p>
        </p>
<blockquote class="text">
<p>When one or more valid Third-Party Signatures are present in the message, and a scope
            tag exists within the normal policy record, and the scope tag does not contain "NO-TPA",
              then:</p>
<ul class="text">
<li>When a TPA-labeled policy record within the From header domain has a scope tag of
                "F" or "F-i" and the email-address domain within the From headers is within the
                authorizing domain, then the message is considered signed with an Author's Domain
                Acceptable Third-Party Signature. When the scope tag within the TPA-labeled policy
                record is "F-i", then email-addresses within the authorizing domain can be
                considered to have been authenticated.
</li>
<li>When a TPA-labeled poliy record within the From header domain has a scope tag of
                "O" or "O-i" and the email-address domain within the Sender, or Resent-* headers are
                within the authorizing domain, then the message is considered signed with an
                Author's Domain Acceptable Third-Party Signature. When the scope tag within the
                TPA-labeled policy record is "O-i", then email-addresses within the authorizing
                domain can be considered to have been authenticated when included within the
                signature's hash.
</li>
<li>When no TPA-labeled policy record is found or published, and a valid Third-party
                signature is acceptable to the verifier, then the message is considered signed by a
                Verifier Acceptable Third-Party Signature.
</li>
</ul>

</blockquote><p>
      
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Restricted Local-part</h3>

<p>The "g=" tag provides a means for an authorizing domain to restrict authorization for
        local-parts appearing within the scoped headers.
</p>
<p>g= Granularity of the TPA authorization (plain-text; OPTIONAL, default is "*"). This value
        MUST match the Local-part of the From header email-address. A single optional "*" character
        matches a sequence of zero or more arbitrary characters ("wildcarding"). An email with a
        From address local-part that does not match the value of this tag constitutes a failed TPA
        authorization. The intent of this tag is to constrain which email-addresses the domain can
        legitimately be authorized to sign. Wildcarding allows matching for addresses such as
        "user+*" or "*-offer". An empty "g=" value never matches any addresses.
</p>
<p>
        </p>
<blockquote class="text">
<p>ABNF: tpa-g-tag = %x67 [WSP] "=" [WSP] tpa-tag-lpart 
</p>
<p>tpa-g-tag-lpart = [dot-atom-text] ["*" [dot-atom-text] ]
</p>
</blockquote><p>
      
</p>
<a name="IANA"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
IANA Considerations</h3>

<p>Unless a registry is established for DKIM policy record tags, there are no IANA
        requirements in this draft.
</p>
<p>Note to RFC Editor: this section may be removed on publication as an RFC and no request is
        desired or registration is not considered practical.
</p>
<a name="Security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Security Considerations</h3>

<p>This draft extends signing policies related to <a class='info' href='#RFC4871'>[RFC4871]<span> (</span><span class='info'>Allman, E., Callas, J., Delany, M., Libbey, M., Fenton, J., and M. Thomas, &ldquo;DomainKeys Identified Mail (DKIM) Signatures,&rdquo; May&nbsp;2007.</span><span>)</span></a>. Security
        considerations in the Author Domain Signing Practices are mostly related to attempts on the
        part of malicious senders to represent themselves as other senders, often in an attempt to
        defraud the recipient. Additional security considerations regarding Sender Signing Practices
        may be found in the DKIM threat analysis <a class='info' href='#RFC4686'>[RFC4686]<span> (</span><span class='info'>Fenton, J., &ldquo;Analysis of Threats Motivating DomainKeys Identified Mail (DKIM),&rdquo; September&nbsp;2006.</span><span>)</span></a>.
</p>
<p>The use of the SHA-1 hash algorithm does not represent a security concern. The hash simply
        ensures a deterministic domain-name size is achieved. Unexpected collisions can be detected
        and handled by using the extended TPA-label "tpa=" option.
</p>
<a name="Acknowledgements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Acknowledgements</h3>

<p>Frank Ellermann and Wietse Venema.<br />
<br />
<br />
<br />
<br />
<br />

</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>13.1.&nbsp;References - Normative</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="FIPS.180-2.2002">[FIPS.180-2.2002]</a></td>
<td class="author-text">National Institute of Standards and Technology, &ldquo;<a href="http://csrc.nist.gov/publications/fips/fips180-2/fips180-2.pdf">Secure Hash Standard</a>,&rdquo; FIPS&nbsp;PUB 180-2, August&nbsp;2002.</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.otis-dkim-adsp">[I-D.otis-dkim-adsp]</a></td>
<td class="author-text">Contents, T., Address, A., and D. Otis, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-otis-dkim-adsp-04.txt">DKIM Author Domain Signing Practices (ADSP)</a>,&rdquo; draft-otis-dkim-adsp-04 (work in progress), June&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-otis-dkim-adsp-04.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2821">[RFC2821]</a></td>
<td class="author-text">Klensin, J., &ldquo;<a href="http://tools.ietf.org/html/rfc2821">Simple Mail Transfer Protocol</a>,&rdquo; RFC&nbsp;2821, April&nbsp;2001 (<a href="http://www.rfc-editor.org/rfc/rfc2821.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2822">[RFC2822]</a></td>
<td class="author-text">Resnick, P., &ldquo;<a href="http://tools.ietf.org/html/rfc2822">Internet Message Format</a>,&rdquo; RFC&nbsp;2822, April&nbsp;2001 (<a href="http://www.rfc-editor.org/rfc/rfc2822.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4033">[RFC4033]</a></td>
<td class="author-text">Arends, R., Austein, R., Larson, M., Massey, D., and S. Rose, &ldquo;<a href="http://tools.ietf.org/html/rfc4033">DNS Security Introduction and Requirements</a>,&rdquo; RFC&nbsp;4033, March&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4033.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4648">[RFC4648]</a></td>
<td class="author-text">Josefsson, S., &ldquo;<a href="http://tools.ietf.org/html/rfc4648">The Base16, Base32, and Base64 Data Encodings</a>,&rdquo; RFC&nbsp;4648, October&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4648.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4871">[RFC4871]</a></td>
<td class="author-text">Allman, E., Callas, J., Delany, M., Libbey, M., Fenton, J., and M. Thomas, &ldquo;<a href="http://tools.ietf.org/html/rfc4871">DomainKeys Identified Mail (DKIM) Signatures</a>,&rdquo; RFC&nbsp;4871, May&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4871.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5234">[RFC5234]</a></td>
<td class="author-text">Crocker, D. and P. Overell, &ldquo;<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>,&rdquo; STD&nbsp;68, RFC&nbsp;5234, January&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5234.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>13.2.&nbsp;References - Informative</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2434">[RFC2434]</a></td>
<td class="author-text"><a href="mailto:narten@raleigh.ibm.com">Narten, T.</a> and <a href="mailto:Harald@Alvestrand.no">H. Alvestrand</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2434">Guidelines for Writing an IANA Considerations Section in RFCs</a>,&rdquo; BCP&nbsp;26, RFC&nbsp;2434, October&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2434.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2434.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2434.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4686">[RFC4686]</a></td>
<td class="author-text">Fenton, J., &ldquo;<a href="http://tools.ietf.org/html/rfc4686">Analysis of Threats Motivating DomainKeys Identified Mail (DKIM)</a>,&rdquo; RFC&nbsp;4686, September&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4686.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5016">[RFC5016]</a></td>
<td class="author-text">Thomas, M., &ldquo;<a href="http://tools.ietf.org/html/rfc5016">Requirements for a DomainKeys Identified Mail (DKIM) Signing Practices Protocol</a>,&rdquo; RFC&nbsp;5016, October&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc5016.txt">TXT</a>).</td></tr>
</table>

<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Change Log</h3>

<p>Changed title and record references used in draft-otis-dkim-tpa-ssp to reflect the record
        name change.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
DNS Example of TPA-label policy record placement</h3>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
####
# Policies for Example.com email domain using both example.com, isp.com,
# and example.com.isp.com as signing domains.
####

#### 2822.From authorization for TP domains ####
                                _adsp.example.com.  IN TXT
    "dkim=all; scope=F-i:O:M;"

## "isp.com" tpa-label ##
_HGSSD3SNMI6635J5743VDJHAJKMPMFIF._adsp.example.com.  IN TXT
    "tpa=isp.com; scope=F;"

#### 2822.From/Originator/MailFrom authorization for TP domains ####

## "example.com.isp.com" tpa-label ##
_ZZHFFXWCFI7RPDDQDIGYHPBTAA7VWITU._adsp.example.com.  IN TXT
    "tpa=*.isp.com; scope=F-i:O:M; "
</pre></div>
<p>
        
      
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.C"></a><h3>Appendix C.&nbsp;
C code for label generation</h3>

<p>The following utility can be compiled as tpa-label.c using the following:
</p>
<p>gcc -lcrypto tpa-label.c -o tpa-label
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
/*  tpa-label generation utility
 *  Copyright (C) The IETF Trust &amp; Douglas Otis (2008).
 *  Mountain View, CA
 */

#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stddef.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;ctype.h&gt;
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;errno.h&gt;
#include &lt;openssl/sha.h&gt;

/*
 * Copyright (C) The IETF Trust &amp; Douglas Otis (2008).
 * Redistributions of source code must retain the above copyright
 * notice and the following disclaimer.
 *
 * This document is subject to the rights, licenses and restrictions
 * contained in BCP 78, and except as set forth therein, the authors
 * retain all their rights.
 * This document and the information contained herein are provided on an
 * "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS
 * OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST AND
 * THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF
 * THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
 * WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
 */

#define TPA_LABEL_VERSION   100
#define MAX_DOMAIN_NAME     512
#define MAX_FILE_NAME       1024

static char base32[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
static char sign_on[] =
 {"%s v%d.%02d Copyright (C) The IETF Trust &amp; Douglas Otis (2008)\n"};
char err_cmd[] =\
 "ERR: Command error with [%s]\n";
char use_txt[]=\
 "Usage: tpa-label [-i domain_input_file] [-o label_output_file][-v]\n";
char help_txt[]=\
"The options are as follows:\n"\
"-i  domain name input. Defaults to stdin. Removes trailing '.'\n"\
"-o  tpa-label output.  Defaults to stdout.\n"\
"-v  Specifies Verbose Mode.\n\n";

static void usage(void);
/*- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */

static void
usage(void)
{
    (void) fprintf(stderr, "\n%s%s", use_txt, help_txt);
    exit(1);
}
/*- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */

int
main (int argc, char * argv[])
{
    int  ret_val, in_mode, out_mode, verbose, done, i, j, k;
    char ch;
    unsigned long len;
    unsigned long long b_5;
    char in_fn[MAX_FILE_NAME], out_fn[MAX_FILE_NAME];
    unsigned char in_buf[MAX_DOMAIN_NAME + 2];
    unsigned char sha_res[20], tpa_label[33];
    FILE *in_file, *out_file;

    ret_val = in_mode = out_mode = verbose = done = 0;
    len = 0;

    while ((ch = getopt(argc, argv, "i:o:v")) != -1)
    {
        switch (ch)
        {
            case 'i':
                in_mode = 1;          /* input from file */
                (void) strncpy(in_fn, optarg, sizeof(in_fn));
                in_fn[sizeof(in_fn) - 1] = '\0';
                break;
            case 'o':
                 out_mode = 1;         /* out to time */
                 (void) strncpy(out_fn, optarg, sizeof(out_fn));
                 out_fn[sizeof(out_fn) - 1] = '\0';
                 break;
            case 'v':
                 verbose = 1;
                 break;
            case '?':
            default:
                (void) usage();
                break;
        }
    };

    if (in_mode)
    {
        if ((in_file = fopen(in_fn, "r")) == NULL)
        {
            (void) fprintf(stderr,
                           "ERR: Error opening [%s] input file.\n",
                           in_fn);
            exit(2);
        }
    }
    else
    {
        in_file = stdin;
    }

    if (out_mode)
    {
        if ((out_file = fopen(out_fn, "w")) == NULL)
        {
            (void) fprintf(stderr,
                           "ERR: Error opening [%s] output file.\n",
                           out_fn);
            exit(3);
        }
    }
    else
    {
        out_file = stdout;
    }

    if (out_mode &amp;&amp; verbose)
    {
        (void) printf(sign_on, "tpa-label utility",
                      TPA_LABEL_VERSION / 100,
                      TPA_LABEL_VERSION % 100);
    }

    for (i = 0; i &lt; MAX_DOMAIN_NAME &amp;&amp; !done; i++)
    {
        if ((ch = fgetc(in_file)) == EOF)
        {
            ch = 0;
        }
        else  if (ch == '\n' || ch == '\r')
        {
            ch = 0;
        }

        in_buf[i] = tolower(ch);

        if (ch == 0)
        {
            len = i;         /* string length */
            done = 1;
        }
    }

    if (!done)
    {
        (void) fprintf(stderr, "ERR: Domain name too long.\n");
        exit (4);
    }

    if (len &amp;&amp; in_buf[len - 1] == '.')    /* remove any trailing "." */
    {
        len--;
        in_buf[len] = 0;     /* replace trailing "." with 0 */
    }

    in_buf[len++] = '\n';    /* newline simulates commmand-line use */
    in_buf[len] = 0;         /* terminate string */

    if (len &lt; 2)
    {
        (void)
        fprintf(stderr,
                "ERR: Domain name [%s] too short with %d length.\n",
                in_buf,
                len);
        exit (5);
    }

    SHA1(in_buf, len, sha_res);

    if (verbose)
    {
        printf("Normalized Domain = [%s] %d, SHA-1 = ", in_buf, len);

        for (i = 0; i &lt; 20; i++)
        {
            printf("%02X", sha_res[i]);
        }
        printf("\nTPA-Label: 5 bit intervals left to right.\n");
    }

    /* process sha-1 results 4 times by 40 bits 0 to 160 */

    for (i = 0, j = 0; i &lt; 4 ; i++)
    {
        b_5 =  (unsigned long long) sha_res[(i * 5)] &lt;&lt; 32;
        b_5 |= (unsigned long long) sha_res[(i * 5) + 1] &lt;&lt; 24;
        b_5 |= (unsigned long long) sha_res[(i * 5) + 2] &lt;&lt; 16;
        b_5 |= (unsigned long long) sha_res[(i * 5) + 3] &lt;&lt; 8;
        b_5 |= (unsigned long long) sha_res[(i * 5) + 4];

        if (verbose)
        {
            printf(" {%010llX}-&gt;", b_5);
        }

        for (k = 35; k &gt;= 0; k-= 5, j++)    /* convert 40 bits (5x8) */
        {
            tpa_label[j] = base32[(b_5 &gt;&gt; k) &amp; 0x1F];

            if (verbose)
            {
                 printf(" %02X:%c",
                        (unsigned int)(b_5 &gt;&gt; k) &amp; 0x1F,
                        tpa_label[j]);
            }
        }
        if (verbose)
        {
            printf ("\n");
        }
    }
    if (verbose)
    {
        printf("\n");
    }

    tpa_label[j] = 0;   /* terminate label string */
    fprintf(out_file, "_%s", tpa_label);
    printf("\n");

    /* close */
    if (out_mode)
    {
        if (fclose (out_file) != 0)
        {
            (void) fprintf(stderr,
                           "ERR: Unable to close %s output file.\n",
                           out_fn);
            ret_val = 6;
        }
    }
    if (in_mode)
    {
        if (fclose (in_file) != 0)
        {
            (void) fprintf(stderr,
                           "ERR: Unable to close %s input file.\n",
                           in_fn);
             ret_val = 7;
        }
    }
    return (ret_val);
}
</pre></div>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Douglas Otis</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Trend Micro, NSSG</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">10101 N. De Anza Blvd</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cupertino, CA  95014</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1.408.257-1500</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:doug_otis@trendmicro.com">doug_otis@trendmicro.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
