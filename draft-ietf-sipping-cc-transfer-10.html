<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Session Initiation Protocol Call Control - Transfer</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Session Initiation Protocol Call Control - Transfer">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">SIPPING WG</td><td class="header">R. Sparks</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Estacado Systems</td></tr>
<tr><td class="header">Intended status: BCP</td><td class="header">A. Johnston, Ed.</td></tr>
<tr><td class="header">Expires: March 7, 2009</td><td class="header">Avaya</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">D. Petrie</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">SIPez LLC</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">September 03, 2008</td></tr>
</table></td></tr></table>
<h1><br />Session Initiation Protocol Call Control - Transfer<br />draft-ietf-sipping-cc-transfer-10</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on March 7, 2009.</p>

<h3>Abstract</h3>

<p>
This document describes providing Call Transfer capabilities in the Session Initiation Protocol (SIP).  SIP extensions such as REFER and Replaces are used to provide a number of transfer services including blind transfer, consultative transfer, and attended transfer.  This work is part of the SIP multiparty call 
control framework. 
 
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Overview<br />
<a href="#anchor2">2.</a>&nbsp;
Actors and Roles<br />
<a href="#anchor3">3.</a>&nbsp;
Terminology<br />
<a href="#anchor4">4.</a>&nbsp;
Requirements<br />
<a href="#anchor5">5.</a>&nbsp;
Using REFER to achieve Call Transfer<br />
<a href="#anchor6">6.</a>&nbsp;
Basic Transfer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">6.1.</a>&nbsp;
Successful Transfer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">6.2.</a>&nbsp;
Transfer with Dialog Reuse<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">6.3.</a>&nbsp;
Failed Transfer<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">6.3.1.</a>&nbsp;
Target Busy<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">6.3.2.</a>&nbsp;
Transfer Target does not answer<br />
<a href="#anchor12">7.</a>&nbsp;
Transfer with Consultation Hold<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">7.1.</a>&nbsp;
Exposing transfer target<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">7.2.</a>&nbsp;
Protecting transfer target<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">7.3.</a>&nbsp;
Attended Transfer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">7.4.</a>&nbsp;
Recovery when one party does not support REFER<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">7.5.</a>&nbsp;
Attended transfer when Contact URI is not known to route to a unique user agent.<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">7.6.</a>&nbsp;
Semi-Attended Transfer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">7.7.</a>&nbsp;
Attended Transfer Fallback to Basic Transfer<br />
<a href="#anchor20">8.</a>&nbsp;
Transfer with Referred-By<br />
<a href="#anchor21">9.</a>&nbsp;
Transfer as an Ad-Hoc Conference<br />
<a href="#anchor22">10.</a>&nbsp;
Transfer with multiple parties<br />
<a href="#anchor23">11.</a>&nbsp;
Gateway Transfer Issues<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">11.1.</a>&nbsp;
Coerce Gateway Hairpins to the Same Gateway<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">11.2.</a>&nbsp;
Consultative Turned Blind Gateway Glare<br />
<a href="#anchor26">12.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor27">13.</a>&nbsp;
Security Considerations<br />
<a href="#anchor28">14.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">15.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">15.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">15.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Overview</h3>

<p>  
  This document describes providing Call Transfer capabilities and requirements
  in SIP <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. This work is part of the Multiparty Call 
  Control Framework <a class='info' href='#I-D.ietf-sipping-cc-framework'>[I&#8209;D.ietf&#8209;sipping&#8209;cc&#8209;framework]<span> (</span><span class='info'>Mahy, R., Sparks, R., Rosenberg, J., Petrie, D., and A. Johnston, &ldquo;A Call Control and Multi-party usage framework for the Session Initiation Protocol (SIP),&rdquo; December&nbsp;2009.</span><span>)</span></a>. 
 
</p>
<p>  
  The mechanisms discussed here are most closely related to traditional 
  basic and consultation hold transfers. 
 
</p>
<p>
  This document details the use of REFER method <a class='info' href='#RFC3515'>[RFC3515]<span> (</span><span class='info'>Sparks, R., &ldquo;The Session Initiation Protocol (SIP) Refer Method,&rdquo; April&nbsp;2003.</span><span>)</span></a> and
  Replaces <a class='info' href='#RFC3891'>[RFC3891]<span> (</span><span class='info'>Mahy, R., Biggs, B., and R. Dean, &ldquo;The Session Initiation Protocol (SIP) &quot;Replaces&quot; Header,&rdquo; September&nbsp;2004.</span><span>)</span></a> header field to achieve call transfer. 
 
</p>
<p>
A user agent that fully supports the transfer mechanisms described in this document supports REFER<a class='info' href='#RFC3515'>[RFC3515]<span> (</span><span class='info'>Sparks, R., &ldquo;The Session Initiation Protocol (SIP) Refer Method,&rdquo; April&nbsp;2003.</span><span>)</span></a> and Replaces<a class='info' href='#RFC3891'>[RFC3891]<span> (</span><span class='info'>Mahy, R., Biggs, B., and R. Dean, &ldquo;The Session Initiation Protocol (SIP) &quot;Replaces&quot; Header,&rdquo; September&nbsp;2004.</span><span>)</span></a> in addition to RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.  A user agent should use a Contact URI which meets the requirements in Section 8.1.1.8 of RFC 3261.  A compliant user agent supports the Target-Dialog header field <a class='info' href='#RFC4538'>[RFC4538]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Request Authorization through Dialog Identification in the Session Initiation Protocol (SIP),&rdquo; June&nbsp;2006.</span><span>)</span></a>.

</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Actors and Roles</h3>

<p>
    There are three actors in a given transfer event, each playing one of 
    the following roles: 
  </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Transferee -      the party being transferred to the Transfer
                    Target.

  Transferor -      the party initiating the transfer

  Transfer Target - the new party being introduced into a
                    call with the Transferee.
</pre></div><p>

  
</p>
<p> 
    The following roles are used to describe transfer requirements and 
    scenarios: 
  </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   Originator -  wishes to place a call to the Recipient. This
                 actor is the source of the first INVITE in a
                 session, to either a Facilitator or a Screener.

   Facilitator - receives a call or out-of-band request from the
                 Originator, establishes a call to the Recipient
                 through the Screener, and connects the
                 Originator to the Recipient.  Typically, a Facilitator
                 acts on behalf of the Originator.

   Screener -    receives a call ultimately intended for the
                 Recipient and transfers the calling party to
                 the Recipient if appropriate. Typically, a Screener
                 acts on behalf of the Recipient.


   Recipient -   the party the Originator is ultimately
                 connected to.
</pre></div><p>

  
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Terminology</h3>

<p>
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in BCP 14, RFC 2119 <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.

</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Requirements</h3>

<p>
  </p>
<ol class="text">
<li>Any party in a SIP session MUST be able to transfer any other party in 
       that session at any point in that session.
</li>
<li>The Transferor and the Transferee MUST NOT be removed from a session 
       as part of a transfer transaction. 
    <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
          At first glance, requirement 2 may seem to indicate
          that the user experience in a transfer must be
          significantly different from what a current PBX or
          Centrex user expects. As the call-flows in this
          document show, this is not the case. A client MAY
          preserve the current experience. In fact, without
          this requirement, some forms of the current
          experience (ringback on transfer failure
          for instance) will be lost.
</pre></div>
    
</li>
<li>The Transferor MUST know whether or not the transfer was successful.
</li>
<li>The Transferee MUST be able to replace an existing dialog with a new
       dialog.
</li>
<li>The Transferor and Transferee SHOULD indicate their support for the
       primitives required to achieve transfer.
</li>
<li>The Transferor SHOULD provide the Transfer Target and Transferee with information about the nature and progress of the transfer operation being attempted. 
</li><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

          To meet this requirement, the transfer operation can
          be modeled as an ad-hoc conference between three
          parties, as discussed in Section 8.
</pre></div>
</ol><p>
  
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Using REFER to achieve Call Transfer</h3>

<p> 
    A REFER <a class='info' href='#RFC3515'>[RFC3515]<span> (</span><span class='info'>Sparks, R., &ldquo;The Session Initiation Protocol (SIP) Refer Method,&rdquo; April&nbsp;2003.</span><span>)</span></a> can be issued by the Transferor to cause the Transferee to 
    issue an INVITE to the Transfer-Target. Note that a successful REFER 
    transaction does not terminate the session between the Transferor and 
    the Transferee. If those parties wish to terminate their session, they 
    must do so with a subsequent BYE request. The media negotiated between 
    the transferee and the transfer target is not affected by the media 
    that had been negotiated between the transferor and the transferee. In 
    particular, the INVITE issued by the Transferee will have the same SDP 
    body it would have if he Transferee had initiated that INVITE on its 
    own. Further, the disposition of the media streams between the 
    Transferor and the Transferee is not altered by the REFER method. 

</p>
<p>
    Agents may alter a session's media through additional signaling. For 
    example, they may make use of the SIP hold re-INVITE 
    <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> or 
    conferencing extensions described in the conferencing framework <a class='info' href='#RFC4353'>[RFC4353]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Framework for Conferencing with the Session Initiation Protocol (SIP),&rdquo; February&nbsp;2006.</span><span>)</span></a>. 

</p>
<p>
To perform the transfer, the transferor and transferee could reuse an existing dialog established by an INVITE to send the REFER.  This would result in a single dialog shared by two uses - an invite usage and a subscription usage.  The call flows for this are shown in detail in Section 6.2.  However, the approach described in this document is to avoid dialog reuse.  The issues and difficulties associated with dialog reuse are described in <a class='info' href='#I-D.ietf-sipping-dialogusage'>[I&#8209;D.ietf&#8209;sipping&#8209;dialogusage]<span> (</span><span class='info'>Sparks, R., &ldquo;Multiple Dialog Usages in the Session Initiation Protocol,&rdquo; February&nbsp;2007.</span><span>)</span></a>.

</p>
<p>
Motivations for reusing the existing dialog include:

</p>
<ol class="text">
<li>  There was no way to ensure that a REFER on a new dialog would
       reach the particular endpoint involved in a transfer.  Many
       factors, including details of implementations and changes in
       proxy routing between an INVITE and a REFER could cause the REFER
       to be sent to the wrong place.  Sending the REFER down the
       existing dialog ensured it got to the endpoint we were already
       talking to.
</li>
<li>
     It was unclear how to associate an existing invite usage with a
       REFER arriving on a new dialog, where it was completely obvious
       what the association was when the REFER came on the invite
       usage's dialog.
</li>
<li>
     There were concerns with authorizing out-of-dialog REFERs.  The
       authorization policy for REFER in most implementations piggybacks
       on the authorization policy for INVITE (which is, in most cases,
       based simply on "I placed or answered this call").

</li>
</ol>
<p>
   GRUUs <a class='info' href='#I-D.ietf-sip-gruu'>[I&#8209;D.ietf&#8209;sip&#8209;gruu]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the  Session Initiation Protocol (SIP),&rdquo; October&nbsp;2007.</span><span>)</span></a> can be used to address problem 1.  Problem 2 can be addressed using the Target-Dialog header field defined in <a class='info' href='#RFC4538'>[RFC4538]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Request Authorization through Dialog Identification in the Session Initiation Protocol (SIP),&rdquo; June&nbsp;2006.</span><span>)</span></a>.  In the
   immediate term, this solution to problem 2 allows the existing REFER
   authorization policy to be reused.  

   
</p>
<p>   


</p>
<p>
    As a result, if the Transferee supports the target-dialog extension and the Transferor knows the Contact URI is routable outside the dialog, the REFER SHOULD be sent in a new dialog.  If the nature of the Contact URI is not known or if support for the target-dialog extension is not known, the REFER should be sent inside the existing dialog.  A Transferee must be prepared to receive a REFER either inside or outside a dialog.  One way that a Transferor could know that a Contact URI is routable outside a dialog is by validation (e.g. sending an OPTIONS and receiving a response) or if it satisfies the properties described in the GRUU specification <a class='info' href='#I-D.ietf-sip-gruu'>[I&#8209;D.ietf&#8209;sip&#8209;gruu]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the  Session Initiation Protocol (SIP),&rdquo; October&nbsp;2007.</span><span>)</span></a>. 

</p>
<p>
In most of the following examples, the Transferor is in the atlanta.example.com domain, the Transferee is in the biloxi.example.com, and the Transfer Target is in the chicago.example.com domain.

</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Basic Transfer</h3>

<p> 
    Basic Transfer consists of the Transferor providing the Transfer 
    Target's contact to the Transferee. The Transferee attempts to 
    establish a session using that contact and reports the results of that 
    attempt to the Transferor. The signaling relationship between the 
    Transferor and Transferee is not terminated, so the call is   
    recoverable if the Transfer Target cannot be reached. Note that the 
    Transfer Target's contact information has been exposed to the 
    Transferee. The provided contact can be used to make new calls in the 
    future. 
  
</p>
<p>
    The participants in a basic transfer should indicate support for the REFER
    and NOTIFY methods in Allow header fields in INVITE, 200 OK to
    INVITE, and OPTIONS messages.  Participants should also indicate support for Target-Dialog in the Supported header field.
  
</p>
<p> 
    The diagrams below show the first line of each message. The first column of the figure shows the dialog used in that particular message. In these 
    diagrams, media is managed through re-INVITE holds, but other 
    mechanisms (mixing multiple media streams at the UA or using the 
    conferencing extensions for example) are valid.  Selected message details are shown labeled as message F1, F2, etc.
  
</p>
<p>
    Each of the flows below shows the dialog between the Transferor
    and the Transferee remaining connected (on hold) during the REFER
    process. While this provides the greatest flexibility for recovery
    from failure, it is not necessary. If the Transferor's agent does
    not wish to participate in the remainder of the REFER process and
    has no intention of assisting with recovery from transfer failure,
    it could emit a BYE to the Transferee as soon as the REFER
    transaction completes. This flow is sometimes known as "unattended 
    transfer" or "blind transfer".
   
</p>
<p>
   Figure 1 shows transfer when the Transferee utilizes a GRUU and supports the target-dialog extension and indicates this to the Transferor.  As a result, the Transferor sends the REFER outside the INVITE dialog.  The Transferee is able to match this REFER to the existing dialog using the Target-Dialog header field in the refer which references the existing dialog.
   
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Successful Transfer</h3>

<p>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |          INVITE F1 |                    |
        dialog1 |&lt;-------------------|                    |
                |          200 OK F2 |                    |
        dialog1 |-------------------&gt;|                    |
                |            ACK     |                    |
        dialog1 |&lt;-------------------|                    |
                |  INVITE (hold)     |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
                |  ACK               |                    |
        dialog1 |-------------------&gt;|                    |
                |  REFER F3 (Target-Dialog:1)             |
        dialog2 |-------------------&gt;|                    |
                |  202 Accepted      |                    |
        dialog2 |&lt;-------------------|                    |
                | NOTIFY (100 Trying) F4                  |
        dialog2 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog2 |-------------------&gt;|                    |
                |                    |  INVITE F5         |
        dialog3 |                    |-------------------&gt;|
                |                    |  200 OK            |
        dialog3 |                    |&lt;-------------------|
                |                    |  ACK               |
        dialog3 |                    |-------------------&gt;|
                |  NOTIFY (200 OK) F6|                    |
        dialog2 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog2 |-------------------&gt;|                    |
                |  BYE               |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
                |                    |             BYE    |
        dialog3 |                    |&lt;-------------------|
                |                    |             200 OK |
        dialog3 |                    |-------------------&gt;|
</pre></div><p>

   Figure 1. Basic Transfer Call Flow.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

F1 INVITE Transferee -&gt; Transferor

INVITE sips:transferor@atlanta.example.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu, tdialog
Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
Content-Type: application/sdp
Content-Length: ...


F2 200 OK Transferor -&gt; Transferee

SIP/2.0 200 OK
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu, tdialog
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Type: application/sdp
Content-Length: ...


F3 REFER Transferor -&gt; Transferee

REFER sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKna9
Max-Forwards: 70
To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 REFER
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: gruu, replaces, tdialog
Require: tdialog
Refer-To: &lt;sips:transfertarget@chicago.example.com&gt;
Target-Dialog: 090459243588173445;local-tag=7553452
 ;remote-tag=31kdl4i3k
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Length: 0


F4 NOTIFY Transferee -&gt; Transferor

NOTIFY sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
From: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
 ;tag=a6c85cf
Call-ID: a84b4c76e66710
CSeq: 73 NOTIFY
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, tdialog
Event: refer
Subscription-State: active;expires=60
Content-Type: message/sipfrag
Content-Length: ...

SIP/2.0 100 Trying


F5 INVITE Transferee -&gt; Transfer Target

INVITE sips:transfertarget@chicago.example.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas41234
Max-Forwards: 70
To: &lt;sips:transfertarget@chicago.example.com&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=j3kso3iqhq
Call-ID: 90422f3sd23m4g56832034
CSeq: 521 REFER
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu, tdialog
Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
Content-Type: application/sdp
Content-Length: ...


F6 NOTIFY Transferee -&gt; Transferor

NOTIFY sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
From: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
 ;tag=a6c85cf
Call-ID: a84b4c76e66710
CSeq: 74 NOTIFY
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, tdialog
Event: refer
Subscription-State: terminated;reason=noresource
Content-Type: message/sipfrag
Content-Length: ...

SIP/2.0 200 OK

</pre></div>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Transfer with Dialog Reuse</h3>

<p>
In this scenario, the Transferor does not know the properties of the Transferee's Contact URI or does not know that the Transferee supports the Target-Dialog header field.  As a result, the REFER is sent inside the INVITE dialog.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |         INVITE F1  |                    |
        dialog1 |&lt;-------------------|                    |
                |         200 OK F2  |                    |
        dialog1 |-------------------&gt;|                    |
                |            ACK     |                    |
        dialog1 |&lt;-------------------|                    |
                |  INVITE (hold)     |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
                |  ACK               |                    |
        dialog1 |-------------------&gt;|                    |
                |  REFER F3          |                    |
        dialog1 |-------------------&gt;|                    |
                |  202 Accepted      |                    |
        dialog1 |&lt;-------------------|                    |
                | NOTIFY (100 Trying) F4                  |
        dialog1 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog1 |-------------------&gt;|                    |
                |                    |  INVITE F5         |
        dialog2 |                    |-------------------&gt;|
                |                    |  200 OK            |
        dialog2 |                    |&lt;-------------------|
                |                    |  ACK               |
        dialog2 |                    |-------------------&gt;|
                |  NOTIFY (200 OK) F6|                    |
        dialog1 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog1 |-------------------&gt;|                    |
                |  BYE               |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
                |                    |             BYE    |
        dialog2 |                    |&lt;-------------------|
                |                    |             200 OK |
        dialog2 |                    |-------------------&gt;|
</pre></div>
<p>Figure 2. Transfer with Dialog Reuse.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

F1 INVITE Transferee -&gt; Transferor

INVITE sips:transferor@atlanta.example.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Contact: &lt;sips:transferee@192.0.2.4&gt;
Content-Type: application/sdp
Content-Length: ...


F2 200 OK Transferor -&gt; Transferee

SIP/2.0 200 OK
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: gruu, replaces
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Type: application/sdp
Content-Length: ...


F3 REFER Transferor -&gt; Transferee

REFER sips:transferee@192.0.2.4 SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKna9
Max-Forwards: 70
To: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
Call-ID: 090459243588173445
CSeq: 314159 REFER
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Refer-To: &lt;sips:transfertarget@chicago.example.com&gt;
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Length: 0


F4 NOTIFY Transferee -&gt; Transferor

NOTIFY sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29888 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Event: refer
Subscription-State: active;expires=60
Content-Type: message/sipfrag
Content-Length: ...

SIP/2.0 100 Trying


F5 INVITE Transferee -&gt; Transfer Target

INVITE sips:transfertarget@chicago.example.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas41234
Max-Forwards: 70
To: &lt;sips:transfertarget@chicago.example.com&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=j3kso3iqhq
Call-ID: 90422f3sd23m4g56832034
CSeq: 521 REFER
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Contact: &lt;sips:transferee@192.0.2.4&gt;
Content-Type: application/sdp
Content-Length: ...


F6 NOTIFY Transferee -&gt; Transferor

NOTIFY sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31kdl4i3k
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29889 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Event: refer
Subscription-State: terminated;reason=noresource
Content-Type: message/sipfrag
Content-Length: ...

SIP/2.0 200 OK

</pre></div>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Failed Transfer</h3>

<p>
   This section shows examples of failed transfer attempts.  After the transfer
   failure occurs, the Transferor takes the Transferee off hold and resumes the
   session.
  
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3.1"></a><h3>6.3.1.&nbsp;
Target Busy</h3>

<p>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |                    |                    |
                |            INVITE  |                    |
        dialog1 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog1 |-------------------&gt;|                    |
                |            ACK     |                    |
        dialog1 |&lt;-------------------|                    |
                |  INVITE (hold)     |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
                |  ACK               |                    |
        dialog1 |-------------------&gt;|                    |
                |  REFER (Target-Dialog:1)                |
        dialog2 |-------------------&gt;|                    |
                |  202 Accepted      |                    |
        dialog2 |&lt;-------------------|                    |
                | NOTIFY (100 Trying)|                    |
        dialog2 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog2 |-------------------&gt;|                    |
                |                    |  INVITE            |
        dialog3 |                    |-------------------&gt;|
                |                    |  486 Busy Here     |
        dialog3 |                    |&lt;-------------------|
                |                    |  ACK               |
        dialog3 |                    |-------------------&gt;|
                | NOTIFY (486 Busy Here)                  |
        dialog2 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog2 |-------------------&gt;|                    |
                |  INVITE (unhold)   |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
                |  ACK               |                    |
        dialog1 |-------------------&gt;|                    |
                |  BYE               |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
</pre></div><p>
 
   Figure 3. Failed Transfer - Target Busy
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3.2"></a><h3>6.3.2.&nbsp;
Transfer Target does not answer</h3>

<p>
    </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |            INVITE  |                    |
        dialog1 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog1 |-------------------&gt;|                    |
                |            ACK     |                    |
        dialog1 |&lt;-------------------|                    |
                |  INVITE (hold)     |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
                |  ACK               |                    |
        dialog1 |-------------------&gt;|                    |
                |  REFER             |                    |
        dialog2 |-------------------&gt;|                    |
                |  202 Accepted      |                    |
        dialog2 |&lt;-------------------|                    |
                | NOTIFY (100 Trying)|                    |
        dialog2 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog2 |-------------------&gt;|                    |
                |                    |  INVITE            |
        dialog3 |                    |-------------------&gt;|
                |                    |  180 Ringing       |
        dialog3 |                    |&lt;-------------------|
                |          (Transferee gets tired of waiting)
                |                    |  CANCEL            |
        dialog3 |                    |-------------------&gt;|
                |                    |  200 OK (CANCEL)   |
        dialog3 |                    |&lt;-------------------|
                |                 487 Request Cancelled (INVITE)
        dialog3 |                    |&lt;-------------------|
                |                    |  ACK               |
        dialog3 |                    |-------------------&gt;|
                |    NOTIFY (487 Request Cancelled)       |
        dialog2 |&lt;-------------------|                    |
                |            200 OK  |                    |
        dialog2 |-------------------&gt;|                    |
                |  INVITE (unhold)   |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
                |  ACK               |                    |
        dialog1 |-------------------&gt;|                    |
                |  BYE               |                    |
        dialog1 |-------------------&gt;|                    |
                |  200 OK            |                    |
        dialog1 |&lt;-------------------|                    |
</pre></div><p>
 

   Figure 4. Failed Transfer - Target Does Not Answer.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Transfer with Consultation Hold</h3>

<p> 
    Transfer with Consultation Hold involves a session between the 
    transferor and the transfer target before the transfer actually takes 
    place. This is implemented with SIP Hold and Transfer as 
    described above.  
  
</p>
<p>
  A nice feature is for the transferor to let the target know that the session relates to an intended transfer.  Since many UAs render the display name in the From header field to the user, a consultation INVITE could contain a string such as "Incoming consultation from Transferor with intent to transfer Transferee", where the display names of the transferor and transferee are included in the string.
  
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Exposing transfer target</h3>

<p>
     The transferor places the transferee on hold, establishes a call with 
     the transfer target to alert them to the impending transfer, 

     terminates the connection with the transfer target, then proceeds with 
     transfer as above. This variation can be used to provide an 
     experience similar to that expected by current PBX and Centrex users. 
   
</p>
<p>
     To (hopefully) improve clarity, non-REFER transactions have been 
     collapsed into one indicator with the arrow showing the direction of 
     the request. 
   
</p>
<p>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |                    |                    |
        dialog1 | INVITE/200 OK/ACK  |                    |
                |&lt;-------------------|                    |
        dialog1 | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
        dialog2 | INVITE/200 OK/ACK  |                    |
                |----------------------------------------&gt;|
        dialog2 | BYE/200 OK         |                    |
                |----------------------------------------&gt;|
        dialog3 | REFER              |                    |
                |-------------------&gt;|                    |
        dialog3 | 202 Accepted       |                    |
                |&lt;-------------------|                    |
        dialog3 | NOTIFY (100 Trying)|                    |
                |&lt;-------------------|                    |
        dialog3 |            200 OK  |                    |
                |-------------------&gt;|                    |
        dialog4 |                    |  INVITE/200 OK/ACK |
                |                    |-------------------&gt;|
        dialog3 | NOTIFY (200 OK)    |                    |
                |&lt;-------------------|                    |
        dialog3 |            200 OK  |                    |
                |-------------------&gt;|                    |
        dialog1 | BYE/200 OK         |                    |
                |-------------------&gt;|                    |
        dialog4 |                    |         BYE/200 OK |
                |                    |&lt;-------------------|
</pre></div><p>

  Figure 5. Transfer with Consultation Hold - Exposing Transfer Target.


  
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
Protecting transfer target</h3>

<p>
    The transferor places the transferee on hold, establishes a call with 
    the transfer target and then reverses their roles, transferring the 
    original transfer target to the original transferee. This has the 
    advantage of hiding information about the original transfer target 
    from the original transferee. On the other hand, the Transferee's 
    experience is different that in current systems. The Transferee is 
    effectively "called back" by the Transfer Target. 
   
</p>
<p> One of the problems with this simplest implementation of 
         a target protecting transfer is that the transferee is
         receiving a new call from the transfer-target.
         Unless the transferee's agent has a reliable way to associate
         this new call with the call it already has with the transferor,
         it will have to alert the new call on another appearance. If
         this, or some other call-waiting-like UI were not available, the
         transferee might be stuck returning a Busy-Here to the transfer
         target, effectively preventing the transfer.
         There are many ways that that correlation could be provided. The
         dialog parameters could be provided directly as header parameters
         in the Refer-To: URI for example. The Replaces mechanism
         <a class='info' href='#RFC3891'>[RFC3891]<span> (</span><span class='info'>Mahy, R., Biggs, B., and R. Dean, &ldquo;The Session Initiation Protocol (SIP) &quot;Replaces&quot; Header,&rdquo; September&nbsp;2004.</span><span>)</span></a> uses this approach and solves this problem
         nicely.

     
</p>
<p>
        For the flow below, dialog1 means dialog identifier 1, and consists
        of the parameters of the Replaces header for dialog 1. In 
        <a class='info' href='#RFC3891'>[RFC3891]<span> (</span><span class='info'>Mahy, R., Biggs, B., and R. Dean, &ldquo;The Session Initiation Protocol (SIP) &quot;Replaces&quot; Header,&rdquo; September&nbsp;2004.</span><span>)</span></a> this is the Call-ID, To-tag and From-tag.

     
</p>
<p>
       Note that the transferee's agent emits a BYE to the transferor's agent
       as an immediate consequence of processing the Replaces header. 
     
</p>
<p>
     The Transferor knows that both the Transferee and the Transfer Target 
     support the Replaces header from the Supported: replaces header contained 
     in the 200 OK responses from both.
     
</p>
<p>
     In this scenario, the Transferee utilizes a GRUU as a Contact URI for reasons discussed in Section 6.3.

</p>
<p>
Note that the conventions used in the <a class='info' href='#RFC4475'>SIP Torture Test Messages<span> (</span><span class='info'>Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg, J., and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP) Torture Test Messages,&rdquo; May&nbsp;2006.</span><span>)</span></a> [RFC4475] document are reused, specifically the  &lt;allOneLine&gt; tag.

</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

           Transferor           Transferee             Transfer
                |                    |                  Target
                |                    |                    |
      dialog1   | INVITE/200 OK/ACK F1 F2                 |
                |&lt;-------------------|                    |
      dialog1   | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
      dialog2   | INVITE/200 OK/ACK F3 F4                 |
                |----------------------------------------&gt;|
      dialog2   | INVITE (hold)/200 OK/ACK                |
                |----------------------------------------&gt;|
      dialog3   | REFER (Target-Dialog:2,                 |
                |  Refer-To:sips:Transferee?Replaces=1) F5|
                |----------------------------------------&gt;|
      dialog3   | 202 Accepted       |                    |
                |&lt;----------------------------------------|
      dialog3   | NOTIFY (100 Trying)|                    |
                |&lt;----------------------------------------|
      dialog3   |                    |            200 OK  |
                |----------------------------------------&gt;|
      dialog4   |         INVITE (Replaces:dialog1)/200 OK/ACK F6
                |                    |&lt;-------------------|
      dialog1   | BYE/200 OK         |                    |
                |&lt;-------------------|                    |
      dialog3   | NOTIFY (200 OK)    |                    |
                |&lt;----------------------------------------|
      dialog3   |                    |            200 OK  |
                |----------------------------------------&gt;|
      dialog2   | BYE/200 OK         |                    |
                |----------------------------------------&gt;|
                |              (transferee and target converse)
      dialog4   |                    |  BYE/200 OK        |
                |                    |-------------------&gt;|
</pre></div><p>

     Figure 6. Transfer Protecting Transfer Target.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

F1 INVITE Transferee -&gt; Transferor

INVITE sips:transferor@atlanta.example.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu
Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
Content-Type: application/sdp
Content-Length: ...


F2 200 OK Transferor -&gt; Transferee

SIP/2.0 200 OK
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31431
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu, tdialog
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Type: application/sdp
Content-Length: ...


F3 INVITE Transferor -&gt; Transfer Target

INVITE sips:transfertarget@chicago.example.com SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transfertarget@chicago.example.com&gt;
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
Call-ID: 592435881734450904
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: gruu, replaces, tdialog
Require: replaces
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=384i32lw3&gt;
Content-Type: application/sdp
Content-Length: ...


F4 200 OK Transfer Target -&gt; Transferor

SIP/2.0 200 OK
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
 ;received=192.0.2.1
To: &lt;sips:transfertarget@chicago.example.com&gt;;tag=9m2n3wq
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
Call-ID: 592435881734450904
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu, tdialog
Contact: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
Content-Type: application/sdp
Content-Length: ...


F5 REFER Transferor -&gt; Transfer Target

REFER sips:482n4z24kdg@chicago.example.com;gr=8594958 SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
Max-Forwards: 70
To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 REFER
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: gruu, replaces, tdialog
Require: tdialog
&lt;allOneLine&gt;
Refer-To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha
?Replaces=090459243588173445%3Bto-tag%3D7553452%3Bfrom-tag%3D31431&gt;
&lt;/allOneLine&gt;
Target-Dialog: 592435881734450904;local-tag=9m2n3wq
 ;remote-tag=763231
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Length: 0


F6 INVITE Transfer Target -&gt; Transferee

INVITE sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha SIP/2.0
Via: SIP/2.0/TLS client.chicago.example.com;branch=z9hG4bKnaslu84
Max-Forwards: 70
To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
From: &lt;sips:transfertarget@chicago.example.com&gt;;tag=341234
Call-ID: kmzwdle3dl3d08
CSeq: 41 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: gruu, replaces, tdialog
Contact: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
Replaces: 090459243588173445;to-tag=7553452;from-tag=31431
Content-Type: application/sdp
Content-Length: ...


</pre></div>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
Attended Transfer</h3>

<p>
     The transferor places the transferee on hold, establishes a call with 
     the transfer target to alert them to the impending transfer, 
     places the target on hold, then proceeds with 
     transfer using an escaped Replaces header field in the Refer-To header.
     This is another common service expected by current PBX and Centrex users. 

</p>
<p>
The Contact URI of the Transfer Target SHOULD be used by the Transferor as the Refer-To URI, unless the URI is suspected or known to not be routable outside the dialog.  Otherwise, the Address of Record (AOR) of the Transfer Target should be used.  That is, the same URI that the Transferor used to establish the session with the Transfer Target should be used.  In case the triggered INVITE is routed to a different User Agent than the Transfer Target, the Require: replaces header field should be used in the triggered INVITE. (This is to prevent an incorrect User Agent which does not support Replaces from ignoring the Replaces and answering the INVITE without a dialog match.)

</p>
<p>
It is possible that proxy/service routing may prevent the triggered INVITE from reaching the same User Agent.  If this occurs, the triggered invite will fail with a timout, 403, 404, etc error.  The Transferee MAY then retry the transfer with the Refer-To URI set to the Contact URI.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |                    |                    |
       dialog1  | INVITE/200 OK/ACK F1 F2                 |
                |&lt;-------------------|                    |
       dialog1  | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
       dialog2  | INVITE/200 OK/ACK F3 F4                 |
                |----------------------------------------&gt;|
       dialog2  | INVITE (hold)/200 OK/ACK                |
                |----------------------------------------&gt;|
       dialog3  | REFER (Target-Dialog:1,                 |
                |  Refer-To:sips:TransferTarget?Replaces=2) F5
                |-------------------&gt;|                    |
       dialog3  | 202 Accepted       |                    |
                |&lt;-------------------|                    |
       dialog3  | NOTIFY (100 Trying)|                    |
                |&lt;-------------------|                    |
       dialog3  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog4  |        INVITE (Replaces:dialog2)/200 OK/ACK F6
                |                    |-------------------&gt;|
       dialog2  | BYE/200 OK         |                    |
                |&lt;----------------------------------------|
       dialog3  | NOTIFY (200 OK)    |                    |
                |&lt;-------------------|                    |
       dialog3  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog1  | BYE/200 OK         |                    |
                |-------------------&gt;|                    |
       dialog4  |                    |         BYE/200 OK |
                |                    |&lt;-------------------|
</pre></div>
<p>  Figure 7. Attended Transfer Call Flow.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

F1 INVITE Transferee -&gt; Transferor

INVITE sips:transferor@atlanta.example.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu, tdialog
Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
Content-Type: application/sdp
Content-Length: ...


F2 200 OK Transferor -&gt; Transferee

SIP/2.0 200 OK
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=31431
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=7553452
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu, tdialog
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Type: application/sdp
Content-Length: ...


F3 INVITE Transferor -&gt; Transfer Target

INVITE sips:transfertarget@chicago.example.com SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transfertarget@chicago.example.com&gt;
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
Call-ID: 592435881734450904
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: gruu, replaces, tdialog
Require: replaces
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=384i32lw3&gt;
Content-Type: application/sdp
Content-Length: ...


F4 200 OK Transfer Target -&gt; Transferor

SIP/2.0 200 OK
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
 ;received=192.0.2.1
To: &lt;sips:transfertarget@chicago.example.com&gt;;tag=9m2n3wq
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
Call-ID: 592435881734450904
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces, gruu
Contact: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
Content-Type: application/sdp
Content-Length: ...


F5 REFER Transferor -&gt; Transferee

REFER sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
Max-Forwards: 70
To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 REFER
Require: tdialog
&lt;allOneLine&gt;
Refer-To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958?
Replaces=592435881734450904%3Bto-tag%3D9m2n3wq%3Bfrom-tag3D763231&gt;
&lt;/allOneLine&gt;
Target-Dialog: 592435881734450904;local-tag=9m2n3wq
 ;remote-tag=763231
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Length: 0


F6 INVITE Transferee -&gt; Transfer Target

INVITE sips:482n4z24kdg@chicago.example.com;gr=8594958 SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnaslu82
Max-Forwards: 70
To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=954
Call-ID: kmzwdle3dl3d08
CSeq: 41 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: gruu, replaces, tdialog
Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
Replaces: 592435881734450904;to-tag=9m2n3wq;from-tag=763231
Content-Type: application/sdp
Content-Length: ...

</pre></div>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.4"></a><h3>7.4.&nbsp;
Recovery when one party does not support REFER</h3>

<p>
   If protecting or exposing the transfer target is not a concern,
   it is possible to complete a transfer with consultation hold when
   only the transferor and one other party support REFER.  Note that a 405 
   Method Not Allowed might be returned instead of the 501 Not Implemented
   response.
   
</p>
<p>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |                    |                    |
       dialog1  | INVITE/200 OK/ACK  |                    |
                |&lt;-------------------|                    |
       dialog1  | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
       dialog2  | INVITE/200 OK/ACK  |                    |
                |----------------------------------------&gt;|
       dialog2  | INVITE (hold)/200 OK/ACK                |
                |----------------------------------------&gt;|
       dialog3  | REFER (Target-Dialog:1,                 |
                |    Refer-To:sips:TransferTarget?Replaces=2)
                |-------------------&gt;|                    |
       dialog3  | 501 Not Implemented                     |
                |&lt;-------------------|                    |
       dialog4  | REFER (Refer-To:sips:Transferee?Replaces=dialog1)
                |----------------------------------------&gt;|
       dialog4  | 202 Accepted       |                    |
                |&lt;----------------------------------------|
       dialog4  | NOTIFY (100 Trying)|                    |
                |&lt;----------------------------------------|
       dialog4  |                    |            200 OK  |
                |----------------------------------------&gt;|
       dialog5  |             INVITE (Replaces:dialog1)/200 OK/ACK
                |                    |&lt;-------------------|
       dialog4  | NOTIFY (200 OK)    |                    |
                |&lt;----------------------------------------|
       dialog4  |                    |            200 OK  |
                |----------------------------------------&gt;|
       dialog1  | BYE/200 OK         |                    |
                |&lt;-------------------|                    |
       dialog2  | BYE/200 OK         |                    |
                |----------------------------------------&gt;|
       dialog5  |                    |  BYE/200 OK        |
                |                    |-------------------&gt;|
</pre></div><p>

  Figure 8. Recovery when one party does not support REFER. 
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.5"></a><h3>7.5.&nbsp;
Attended transfer when Contact URI is not known to route to a unique user agent.</h3>

<p>
    It is a requirement of RFC3261 that a Contact URI be globally routable even outside the dialog.  However, due to RFC2543 User Agents and some architectures (NAT/Firewall traversal, screening proxies, ALGs, etc.) this will not always be the case. As a result, the method of Attended Transfer shown in Figures 6, 7, and 8 should only be used if the Contact URI is known to be routable outside the dialog.  

</p>
<p>

Figure 9 shows such a scenario where the Transfer Target Contact URI is not routable outside the dialog, so the triggered INVITE is sent to the AOR of the Transfer Target.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    Transferor           Transferee  Screening       Transfer
        |                  |           Proxy         Target
        |                  |             |             |
dialog1 | INVITE/200 OK/ACK|             |             |
        |&lt;-----------------|             |             |
dialog1 | INVITE (hold)/200 OK/ACK       |             |
        |-----------------&gt;|             |             |
dialog2 | INVITE/200 OK/ACK F1 F2        |             |
        |--------------------------------|------------&gt;|
dialog2 | INVITE (hold)/200 OK/ACK                     |
        |--------------------------------|------------&gt;|
dialog1 | REFER (Refer-To:sips:TargetAOR               |
        |         ?Replaces=dialog2&amp;Require=replaces) F3
        |-----------------&gt;|             |             |
dialog1 | 202 Accepted     |             |             |
        |&lt;-----------------|             |             |
dialog1 | NOTIFY (100 Trying)            |             |
        |&lt;-----------------|             |             |
dialog1 |          200 OK  |             |             |
        |-----------------&gt;|             |             |
dialog4 |INVITE (Replaces:dialog2,Require:replaces)/200 OK/ACK F6
        |                  |------------&gt;|------------&gt;|
dialog2 | BYE/200 OK       |             |             |
        |&lt;-------------------------------|&lt;------------|
dialog1 | NOTIFY (200 OK) F7             |             |
        |&lt;-----------------|             |             |
dialog1 |          200 OK  |             |             |
        |-----------------&gt;|             |             |
dialog1 | BYE/200 OK       |             |             |
        |-----------------&gt;|             |             |
dialog3 |                  |             |  BYE/200 OK |
        |                  |&lt;------------|-------------|
</pre></div>
<p>  Figure 9. Attended Transfer Call Flow with a Contact URI not known to be Globally Routable
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

F1 INVITE Transferor -&gt; Transfer Target

INVITE sips:transfertarget@chicago.example.com SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bK76
Max-Forwards: 70
To: &lt;sips:transfertarget@chicago.example.com&gt;
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
Content-Type: application/sdp
Content-Length: ...


F2 200 OK Transfer Target -&gt; Transferee

SIP/2.0 200 OK
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
 ;received=192.0.2.1
To: &lt;sips:transfertarget@chicago.example.com&gt;;tag=9m2n3wq
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Contact: &lt;sips:transfertarget@client.chicago.example.com&gt;
Content-Type: application/sdp
Content-Length: ...


F3 REFER Transferor -&gt; Transferee

REFER sips:transferee@192.0.2.4 SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
Max-Forwards: 70
To: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314160 REFER
&lt;allOneLine&gt;
Refer-To: &lt;sips:transfertarget@chicago.example.com?Replaces=
090459243588173445%3Bto-tag%3D9m2n3wq%3Bfrom-tag%3D763231
&amp;Require=replaces&gt;
&lt;allOneLine&gt;
Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
Content-Length: 0


F4 INVITE Transferee -&gt; Transfer Target

INVITE sips:transfertarget@chicago.example.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnaslu82
Max-Forwards: 70
To: &lt;sips:transfertarget@chicago.example.com&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=954
Call-ID: 20482817324945934422930
CSeq: 42 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Contact: &lt;sips:transferee@192.0.2.4&gt;
Replaces: 090459243588173445;to-tag=9m2n3wq;from-tag=763231
Require: replaces
Content-Type: application/sdp
Content-Length: ...


F5 NOTIFY Transferee -&gt; Transferor

NOTIFY sips:transferor@pc33.atlanta.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
Call-ID: a84b4c76e66710
CSeq: 76 NOTIFY
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Event: refer;id=98873867
Subscription-State: terminated;reason=noresource
Content-Type: message/sipfrag
Content-Length: ...

SIP/2.0 200 OK

</pre></div>
<p>
Figure 10 shows a failure case in which the AOR URI fails to reach the transfer Target.  As a result, the transfer is retried with the Contact URI which succeeds.

</p>
<p>
Note that there is still no guarantee that the correct endpoint will be reached, and the result of this second REFER may also be a failure.  In that case, the Transferor could fall back to unattended transfer or give up on the transfer entirely.  Since two REFERs are sent within the dialog creating two distinct subscriptions, the Transferee uses the 'id' parameter in the Event header field to distinguish notifications for the two subscriptions.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    Transferor           Transferee  Screening      Transfer
        |                  |           Proxy         Target
        |                  |             |             |
dialog1 | INVITE/200 OK/ACK|             |             |
        |&lt;-----------------|             |             |
dialog1 | INVITE (hold)/200 OK/ACK       |             |
        |-----------------&gt;|             |             |
dialog2 | INVITE/200 OK/ACK F1 F2        |             |
        |--------------------------------|------------&gt;|
dialog2 | INVITE (hold)/200 OK/ACK                     |
        |--------------------------------|------------&gt;|
dialog1 | REFER (Refer-To:sips:TargetAOR?              |
        |       Replaces=dialog2&amp;Require=replaces) F3  |
        |-----------------&gt;|             |             |
dialog1 | 202 Accepted     |             |             |
        |&lt;-----------------|             |             |
dialog1 | NOTIFY (100 Trying)            |             |
        |&lt;-----------------|             |             |
dialog1 |          200 OK  |             |             |
        |-----------------&gt;|             |             |
dialog3 |                  |INVITE (Replaces:dialog2,  |
        |                  | Require:replaces)/403/ACK |
        |                  |------------&gt;|             |
dialog1 | NOTIFY (403 Forbidden) F4      |             |
        |&lt;-----------------|             |             |
dialog1 |          200 OK  |             |             |
        |-----------------&gt;|             |             |
dialog1 |REFER(Refer-To:sips:TargetContact?Replaces=dialog2) F5
        |-----------------&gt;|             |             |
dialog1 | 202 Accepted     |             |             |
        |&lt;-----------------|             |             |
dialog1 | NOTIFY (100 Trying)            |             |
        |&lt;-----------------|             |             |
dialog1 |          200 OK  |             |             |
        |-----------------&gt;|             |             |
dialog4 |                INVITE (Replaces:dialog2)/200 OK/ACK F6
        |                  |------------&gt;|------------&gt;|
dialog2 | BYE/200 OK       |             |             |
        |&lt;-------------------------------|&lt;------------|
dialog1 | NOTIFY (200 OK) F7             |             |
        |&lt;-----------------|             |             |
dialog1 |          200 OK  |             |             |
        |-----------------&gt;|             |             |
dialog1 | BYE/200 OK       |             |             |
        |-----------------&gt;|             |             |
dialog3 |                  |             |  BYE/200 OK |
        |                  |&lt;------------|-------------|
</pre></div>
<p>  Figure 10. Attended Transfer Call Flow with non-routable Contact URI and AOR Failure
   
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

F1 INVITE Transferor -&gt; Transfer Target

INVITE sips:transfertarget@chicago.example.com SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bK76
Max-Forwards: 70
To: &lt;sips:transfertarget@chicago.example.com&gt;
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
Content-Type: application/sdp
Content-Length: ...


F2 200 OK Transfer Target -&gt; Transferee

SIP/2.0 200 OK
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnas432
 ;received=192.0.2.1
To: &lt;sips:transfertarget@chicago.example.com&gt;;tag=9m2n3wq
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=763231
Call-ID: 090459243588173445
CSeq: 29887 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Contact: &lt;sips:transfertarget@client.chicago.example.com&gt;
Content-Type: application/sdp
Content-Length: ...


F3 REFER Transferor -&gt; Transferee

REFER sips:transferee@192.0.2.4 SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
Max-Forwards: 70
To: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 REFER
&lt;allOneLine&gt;
Refer-To: &lt;sips:transfertarget@chicago.example.com?Replaces=
090459243588173445%3Bto-tag%3D9m2n3wq%3Bfrom-tag%3D763231
&amp;Require=replaces&gt;
&lt;/allOneLine&gt;
Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
Content-Length: 0


F4 NOTIFY Transferee -&gt; Transferor

NOTIFY sips:transferor@pc33.atlanta.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
Call-ID: a84b4c76e66710
CSeq: 74 NOTIFY
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Event: refer;id=314159
Subscription-State: terminated;reason=noresource
Content-Type: message/sipfrag
Content-Length: ...

SIP/2.0 403 Forbidden


F5 REFER Transferor -&gt; Transferee

REFER sips:transferee@192.0.2.4 SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bKnashds9
Max-Forwards: 70
To: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314160 REFER
&lt;allOneLine&gt;
Refer-To: &lt;sips:transfertarget@client.chicago.example.com
?Replaces=090459243588173445%3Bto-tag%3D9m2n3wq
%3Bfrom-tag%3D763231&gt;
&lt;/allOneLine&gt;
Contact: &lt;sips:transferor@pc33.atlanta.example.com&gt;
Content-Length: 0


F6 INVITE Transferee -&gt; Transfer Target

INVITE sips:transfertarget@client.chicago.example.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnaslu82
Max-Forwards: 70
To: &lt;sips:transfertarget@chicago.example.com&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=954
Call-ID: 20482817324945934422930
CSeq: 42 INVITE
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Contact: &lt;sips:transferee@192.0.2.4&gt;
Replaces: 090459243588173445;to-tag=9m2n3wq;from-tag=763231
Content-Type: application/sdp
Content-Length: ...


F7 NOTIFY Transferee -&gt; Transferor

NOTIFY sips:transferor@pc33.atlanta.com SIP/2.0
Via: SIP/2.0/TLS 192.0.2.4;branch=z9hG4bKnas432
Max-Forwards: 70
To: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=a6c85cf
Call-ID: a84b4c76e66710
CSeq: 76 NOTIFY
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY
Supported: replaces
Event: refer;id=314160
Subscription-State: terminated;reason=noresource
Content-Type: message/sipfrag
Content-Length: ...

SIP/2.0 200 OK

</pre></div>
<p>
To prevent this scenario from happening, the Transfer Target should use a Contact URI which is routable outside the dialog, which will result in the call flow of Figure 7.

</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.6"></a><h3>7.6.&nbsp;
Semi-Attended Transfer</h3>

<p>
    In any of the consultation hold flows above, the Transferor may decide
    to terminate its attempt to contact the Transfer target before that 
    session is established. Most frequently, that will be the end of the
    scenario, but in some circumstances, the transferor may wish to proceed
    with the transfer action. For example, the Transferor may wish to complete the transfer
    knowing that the transferee will end up eventually talking to the 
    transfer-target's voice-mail service.  Some PBX systems support this feature, sometimes called "semi-attended transfer", that is effectively a hybrid between a fully attended transfer and an unattended transfer.  A call flow is shown in Figure 11.  In this flow, the Transferor's User Agent continues the transfer as an attended transfer even after the Transferor hangs up.  Note that media must be played to the Transfer Target upon answer - otherwise, the Target may hang up and the resulting transfer operation will fail.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee            Transfer
                |                    |                 Target
                |                    |                    |
       dialog1  | INVITE/200 OK/ACK F1 F2                 |
                |&lt;-------------------|                    |
       dialog1  | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
       dialog2  | INVITE             |                    |
                |----------------------------------------&gt;|
       dialog2  |                    |       180 Ringing  |
                |&lt;----------------------------------------|
             Transferor hangs up but wants transfer to continue
                |                    |                    |
                | User Agent continues transfer operation |
                |                    |                    |
       dialog2  |                    |           200 OK   |
                |&lt;----------------------------------------|
       dialog2  | ACK                |                    |
                |----------------------------------------&gt;|
       dialog2  | Media Played to keep Target from hanging up
                |========================================&gt;|
       dialog3  | REFER (Target-Dialog:1,                 |
                |  Refer-To:sips:TransferTarget?Replaces=2)
                |-------------------&gt;|                    |
       dialog3  | 202 Accepted       |                    |
                |&lt;-------------------|                    |
       dialog3  | NOTIFY (100 Trying)|                    |
                |&lt;-------------------|                    |
       dialog3  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog4  |             INVITE (Replaces:dialog2)/200 OK/ACK
                |                    |-------------------&gt;|
       dialog2  | BYE/200 OK         |                    |
                |&lt;----------------------------------------|
       dialog3  | NOTIFY (200 OK)    |                    |
                |&lt;-------------------|                    |
       dialog3  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog1  | BYE/200 OK         |                    |
                |-------------------&gt;|                    |
       dialog4  |                    |         BYE/200 OK |
                |                    |&lt;-------------------|
</pre></div>
<p>  Figure 11. Recommended Semi-Attended Transfer Call Flow.
</p>
<p>
Two other possible semi-attended transfer call flows are shown in Figures 12 and 13.  However, these call flows are NOT RECOMMENDED due to a race conditions.  In both of these flows, when the Transferor hangs up, the Transferor attempts to revert to unattended transfer by sending a CANCEL to the Target.  This can result in two race conditions.  One is that the Target answers despite the CANCEL and the resulting unattended transfer fails.  This race condition can be eliminated by the Transferor waiting to send the REFER until the 487 response from the Target is returned.   Instead of a 487, a 200 OK may return indicating that the Target has answered the consultation call.  In this, case the call flow in Figure 13 must be followed.  In this flow, the Transferor must play some kind of media to the Target to prevent the Target from hanging up, or the Transfer will fail.  That is, the human at the Transfer Target will hear silence from when they answer (message F1) until the transfer completes (F3 and they are talking to the Transferee unless some media is played (F2).

</p>
<p>
The second race condition occurs in Figure 12 if the Transfer Target goes "off hook" after the CANCEL is received and the 487 returned.  This may result in a 486 Busy Here response to the unattended transfer.
</p>
<p>
The recommended call flow of Figure 11 does not utilize a CANCEL and does not suffer from these race conditions.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee            Transfer
                |                    |                 Target
                |                    |                    |
       dialog1  | INVITE/200 OK/ACK  |                    |
                |&lt;-------------------|                    |
       dialog1  | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
       dialog2  | INVITE                                  |
                |----------------------------------------&gt;|
       dialog2  | 180 Ringing                             |
                |&lt;----------------------------------------|
                |                                         |
                |  Transferor gives up waiting            |
                |                                         |
       dialog2  | CANCEL                                  |
                |----------------------------------------&gt;|
       dialog2  | 200 OK                                  |
                |&lt;----------------------------------------|
       dialog2  | 487 Request Terminated                  |
                |&lt;----------------------------------------|
       dialog2  | ACK                                     |
                |----------------------------------------&gt;|
       dialog3  | REFER (Target-Dialog:1) F3              |
                |-------------------&gt;|                    |
       dialog3  | 202 Accepted       |                    |
                |&lt;-------------------|                    |
       dialog3  | NOTIFY (100 Trying)|                    |
                |&lt;-------------------|                    |
       dialog3  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog4  |                INVITE/200 OK/ACK        |
                |                    |-------------------&gt;|
       dialog3  | NOTIFY (200 OK)    |                    |
                |&lt;-------------------|                    |
       dialog3  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog1  | BYE/200 OK         |                    |
                |-------------------&gt;|                    |
       dialog4  |                    |         BYE/200 OK |
                |                    |&lt;-------------------|
</pre></div>
<p>
  Figure 12. Semi-Attended Transfer as Blind Transfer Call Flow. (Not Recommended)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee            Transfer
                |                    |                 Target
                |                    |                    |
       dialog1  | INVITE/200 OK/ACK  |                    |
                |&lt;-------------------|                    |
       dialog1  | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
       dialog2  | INVITE                                  |
                |----------------------------------------&gt;|
       dialog2  | 180 Ringing                             |
                |&lt;----------------------------------------|
                |                                         |
                |Transferor gives up waiting but Target answers
                |                                         |
       dialog2  | CANCEL                                  |
                |----------------------------------------&gt;|
       dialog2  | 200 OK (CANCEL)                         |
                |&lt;----------------------------------------|
       dialog2  | 200 OK (INVITE) F1                      |
                |&lt;----------------------------------------|
       dialog2  | ACK                                     |
                |----------------------------------------&gt;|
       dialog2  | INVITE (hold)/200 OK/ACK                |
                |----------------------------------------&gt;|
                |  Tones or media played avoid silence F2 |
                |========================================&gt;|
       dialog1  |REFER (Refer-To:sips:TransferTarget      |
                |                      ?Replaces=dialog2) |
                |-------------------&gt;|                    |
       dialog1  | 202 Accepted       |                    |
                |&lt;-------------------|                    |
       dialog1  | NOTIFY (100 Trying)|                    |
                |&lt;-------------------|                    |
       dialog1  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog3  |         INVITE (Replaces:dialog2)/200 OK/ACK F3
                |                    |-------------------&gt;|
       dialog2  | BYE/200 OK         |                    |
                |&lt;----------------------------------------|
       dialog1  | NOTIFY (200 OK)    |                    |
                |&lt;-------------------|                    |
       dialog1  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog1  | BYE/200 OK         |                    |
                |-------------------&gt;|                    |
       dialog3  |                    |         BYE/200 OK |
                |                    |&lt;-------------------|
</pre></div>
<p>Figure 13. Semi-Attended Transfer as Attended Transfer Call Flow. (Not Recommended)
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.7"></a><h3>7.7.&nbsp;
Attended Transfer Fallback to Basic Transfer</h3>

<p>
In this flow, an attempted attended transfer fails so the transferor falls back to basic transfer. 
</p>
<p>
The call flow in Figure 14 shows the use of Require: replaces in the INVITE sent by the Transferor to the Transfer Target in which the Transferor's intention at the time of sending the INVITE to the Transfer Target was known to be to complete an attended transfer.  Since the Target does not support Replaces, the INVITE is rejected with a 420 Bad Extension response, and the Transferor switches from attended transfer to basic transfer immediately.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |                    |                    |
       dialog1  | INVITE/200 OK/ACK  |                    |
                |&lt;-------------------|                    |
       dialog1  |   OPTIONS/200 OK   |                    |
                |-------------------&gt;|                    |
       dialog1  | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
       dialog2  | INVITE (Require:replaces)               |
                |----------------------------------------&gt;|
       dialog2  |                     420 Bad Extension   |
                |&lt;----------------------------------------|
       dialog2  |    ACK                                  |
                |----------------------------------------&gt;|
       dialog1  | REFER (Refer-To:sips:TransferTarget)    |
                |-------------------&gt;|                    |
       dialog1  |    202 Accepted    |                    |
                |&lt;-------------------|                    |
       dialog1  | NOTIFY (100 Trying)|                    |
                |&lt;-------------------|                    |
       dialog1  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog3  |                    |  INVITE/200 OK/ACK |
                |                    |-------------------&gt;|
       dialog1  | NOTIFY (200 OK)    |                    |
                |&lt;-------------------|                    |
       dialog1  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog1  | BYE/200 OK         |                    |
                |-------------------&gt;|                    |
       dialog3  |                    |         BYE/200 OK |
                |                    |&lt;-------------------|
</pre></div>
<p>  Figure 14. Attended Transfer Fallback to Basic Transfer using Require:replaces.
</p>
<p> Figure 15 shows the use of OPTIONS when the Transferee and Transfer Target do not explicitly indicate support for the REFER method and Replaces header fields in Allow and Supported header fields and the Transferor did not have the intention of performing an attended transfer when the INVITE to the Target was sent.  In dialog1, the Transferor determines using OPTIONS that the Transferee does support REFER and Replaces.  As a result, the Transferor begins the attended transfer by placing the Transferee on hold and calling the Transfer Target.  Using an OPTIONS in dialog2, the Transferor determines that the Target does not support either REFER or Replaces, making attended transfer impossible.  The Transferor then ends dialog2 by sending a BYE then sends a REFER to the Transferee using the AOR URI of the Transfer Target.
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Transferor           Transferee             Transfer
                |                    |                  Target
                |                    |                    |
       dialog1  | INVITE/200 OK/ACK  |                    |
                |&lt;-------------------|                    |
       dialog1  |   OPTIONS/200 OK   |                    |
                |-------------------&gt;|                    |
       dialog1  | INVITE (hold)/200 OK/ACK                |
                |-------------------&gt;|                    |
       dialog2  | INVITE/200 OK/ACK  |                    |
                |----------------------------------------&gt;|
       dialog2  | OPTIONS/200 OK     |                    |
                |----------------------------------------&gt;|
       dialog2  |    BYE/200 OK      |                    |
                |----------------------------------------&gt;|
       dialog3  |REFER (Target-Dialog:1,                  |
                |          Refer-To:sips:TransferTarget)  |
                |-------------------&gt;|                    |
       dialog3  |    202 Accepted    |                    |
                |&lt;-------------------|                    |
       dialog3  | NOTIFY (100 Trying)|                    |
                |&lt;-------------------|                    |
       dialog3  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog4  |                    |  INVITE/200 OK/ACK |
                |                    |-------------------&gt;|
       dialog3  | NOTIFY (200 OK)    |                    |
                |&lt;-------------------|                    |
       dialog3  |            200 OK  |                    |
                |-------------------&gt;|                    |
       dialog1  | BYE/200 OK         |                    |
                |-------------------&gt;|                    |
       dialog4  |                    |         BYE/200 OK |
                |                    |&lt;-------------------|
</pre></div><p>

  Figure 15. Attended Transfer Fallback to Basic Transfer.
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Transfer with Referred-By</h3>

<p>
In the previous examples, the Transfer Target does not have definitive information about what party initiated the transfer, or, in some cases, even that transfer is taking place.  The <a class='info' href='#RFC3892'>Referred-By mechanism<span> (</span><span class='info'>Sparks, R., &ldquo;The Session Initiation Protocol (SIP) Referred-By Mechanism,&rdquo; September&nbsp;2004.</span><span>)</span></a> [RFC3892] provides a way for the Transferor to provide the Transferee with a way to let the Transfer Target know what party initiated the transfer.

</p>
<p>

The simplest and least secure approach just involves the inclusion of the Referred-By header field in the REFER which is then copied into the triggered INVITE.  However, a more secure mechanism involving the Referred-By security token which is generated and signed by the Transferor and passed in a message body to the Transferee then to the Transfer Target. 

</p>
<p>
The call flow would be identical to Figure 7.  However, the REFER and triggered INVITE messages for this flow showing the Referred-By mechanism are shown below.  

</p>
<p>
Note that the conventions used in the <a class='info' href='#RFC4475'>SIP Torture Test Messages<span> (</span><span class='info'>Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg, J., and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP) Torture Test Messages,&rdquo; May&nbsp;2006.</span><span>)</span></a> [RFC4475] document are reused, specifically the &lt;hex&gt; and &lt;allOneLine&gt; tags.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

F5 REFER Transferor -&gt; Transferee

REFER sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha SIP/2.0
Via: SIP/2.0/TLS pc33.atlanta.example.com;branch=z9hG4bK392039842
Max-Forwards: 70
To: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
From: &lt;sips:transferor@atlanta.example.com&gt;;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314160 REFER
&lt;allOneLine&gt;
Refer-To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958
?Replaces=090459243588173445%3Bto-tag%3D9m2n3wq%3Bfrom-tag
%3D763231&amp;Require=replaces&gt;
&lt;/allOneLine&gt;
Supported: gruu, replaces, tdialog
Require: tdialog
Referred-By: &lt;sips:transferor@atlanta.example.com&gt;
  ;cid="20398823.2UWQFN309shb3@atlanta.example.com"
Target-Dialog: 592435881734450904;local-tag=9m2n3wq;remote-tag=763231
Contact: &lt;sips:4889445d8kjtk3@atlanta.example.com;gr=723jd2d&gt;
Content-Type: multipart/mixed; boundary=unique-boundary-1
Content-Length: 3267

--unique-boundary-1
Content-ID: &lt;20398823.2UWQFN309shb3@atlanta.example.com&gt;

Content-Length: 2961
Content-Type: multipart/signed;
              protocol="application/pkcs-7-signature";
              micalg=sha1;
              boundary="----590F24D439B31E08745DEF0CD9397189"



------590F24D439B31E08745DEF0CD9397189
Content-Type: message/sipfrag

Date: Thu, 18 Sep 2003 13:07:43 GMT
&lt;allOneLine&gt;
Refer-To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958
?Replaces=090459243588173445%3B
to-tag%3D9m2n3wq%3Bfrom-tag%3D763231&amp;Require=replaces&gt;
&lt;/allOneLine&gt;
Referred-By: &lt;sips:transferor@atlanta.example.com&gt;
  ;cid="20398823.2UWQFN309shb3@atlanta.example.com"

------590F24D439B31E08745DEF0CD9397189
Content-Type: application/pkcs-7-signature; name="smime.p7s"
Content-Transfer-Encoding: binary
Content-Disposition: attachment; filename="smime.p7s"

&lt;hex&gt;3082088806092A86
4886F70D010702A082087930820875020101310B300906052B0E03021A050030
0B06092A864886F70D010701A082067A30820339308202A2A003020102020800
90008902240001300D06092A864886F70D01010505003070310B300906035504
0613025553311330110603550408130A43616C69666F726E69613111300F0603
550407130853616E4A6F7365310E300C060355040A1305736970697431293027
060355040B135369706974546573744365727469666963617465417574686F72
697479301E170D3033313032313134343332355A170D31333130313831343433
32355A3062310B3009060355040613025553311330110603550408130A43616C
69666F726E69613111300F0603550407130853616E4A6F7365310E300C060355
040A13057369706974311B30190603550403141273656E646572406578616D70
6C652E6F726730819F300D06092A864886F70D010101050003818D0030818902
818100CB8302060F12C8FA2D1786922CA173DCEB80BF1B1B8AF74A310C6975A5
56A7630FB6E044D9E994DCD49AFF7976C462D7A8E74ECBF98723AEBF2796EDDD
6263577C6C2B77DC7C300B533DEDB5FB8EB3827FD6FC9B37B9A0DE829F1B1081
D632A8AD9FB00A860928E88F87E0B979BA65294AC7D6D2D18A78C86B4FA73387
4E230203010001A381E93081E6301D0603551D1104163014811273656E646572
406578616D706C652E6F726730090603551D1304023000301D0603551D0E0416
041440FF1C0C1BB8684CA917839D70E97DF8DD5B60D130819A0603551D230481
9230818F80146B461714EA94762580546E1354DAA1E35414A1B6A174A4723070
310B3009060355040613025553311330110603550408130A43616C69666F726E
69613111300F0603550407130853616E4A6F7365310E300C060355040A130573
6970697431293027060355040B13536970697454657374436572746966696361
7465417574686F72697479820100300D06092A864886F70D0101050500038181
006FFE1A3B5CE807C3DD2CFDF6E9787F491C84DBF7DCD11DB2D6A8887D2FE3F2
2E9C6894994282E50AA0DFFE1CBD4EC2C20217831FC2AD360FF1C0DE1DE1E870
102CFA99EE504C7DC0D8752A63294AC748DDDEFADE55C6D051F1CD54CFE7C153
278962A53CEF61B875C1FD3C74E972242CBA0131B3B8C607BF95B378212CA9A7
5E30820339308202A2A00302010202080090008902240001300D06092A864886
F70D01010505003070310B300906035504061302555331133011060355040813
0A43616C69666F726E69613111300F0603550407130853616E4A6F7365310E30
0C060355040A1305736970697431293027060355040B13536970697454657374
4365727469666963617465417574686F72697479301E170D3033313032313134
343332355A170D3133313031383134343332355A3062310B3009060355040613
025553311330110603550408130A43616C69666F726E69613111300F06035504
07130853616E4A6F7365310E300C060355040A13057369706974311B30190603
550403141273656E646572406578616D706C652E6F726730819F300D06092A86
4886F70D010101050003818D0030818902818100CB8302060F12C8FA2D178692
2CA173DCEB80BF1B1B8AF74A310C6975A556A7630FB6E044D9E994DCD49AFF79
76C462D7A8E74ECBF98723AEBF2796EDDD6263577C6C2B77DC7C300B533DEDB5
FB8EB3827FD6FC9B37B9A0DE829F1B1081D632A8AD9FB00A860928E88F87E0B9
79BA65294AC7D6D2D18A78C86B4FA733874E230203010001A381E93081E6301D
0603551D1104163014811273656E646572406578616D706C652E6F7267300906
03551D1304023000301D0603551D0E0416041440FF1C0C1BB8684CA917839D70
E97DF8DD5B60D130819A0603551D2304819230818F80146B461714EA94762580
546E1354DAA1E35414A1B6A174A4723070310B30090603550406130255533113
30110603550408130A43616C69666F726E69613111300F060355040713085361
6E4A6F7365310E300C060355040A1305736970697431293027060355040B1353
69706974546573744365727469666963617465417574686F7269747982010030
0D06092A864886F70D0101050500038181006FFE1A3B5CE807C3DD2CFDF6E978
7F491C84DBF7DCD11DB2D6A8887D2FE3F22E9C6894994282E50AA0DFFE1CBD4E
C2C20217831FC2AD360FF1C0DE1DE1E870102CFA99EE504C7DC0D8752A63294A
C748DDDEFADE55C6D051F1CD54CFE7C153278962A53CEF61B875C1FD3C74E972
242CBA0131B3B8C607BF95B378212CA9A75E318201D6308201D2020101307C30
70310B3009060355040613025553311330110603550408130A43616C69666F72
6E69613111300F0603550407130853616E4A6F7365310E300C060355040A1305
736970697431293027060355040B135369706974546573744365727469666963
617465417574686F7269747902080090008902240001300906052B0E03021A05
00A081B1301806092A864886F70D010903310B06092A864886F70D010701301C
06092A864886F70D010905310F170D3034303132363139313831345A30230609
2A864886F70D01090431160414408CCA5772916A968204FD24CC24EDAEAD3943
95305206092A864886F70D01090F31453043300A06082A864886F70D0307300E
06082A864886F70D030202020080300D06082A864886F70D0302020140300706
052B0E030207300D06082A864886F70D0302020128300D06092A864886F70D01
010105000481807795329BB23B8BB9F72526AB9CC22D93B9A37A2E69A0171D3C
C417DD394F0A5FD4F8B082733CD9F2E26F6991031F7FF2EAD31640718502FB4C
822771211E6228C793DA4DBBA2159227C221030FE9088CD659578EB862568087
8E63D306487A740A197A3970594CF47DD385643B1DC49FF767A3D2B428388966
79089AAD95767F&lt;/hex&gt;

------590F24D439B31E08745DEF0CD9397189--

--unique_boundary-1


F6 INVITE Transferee -&gt; Transfer Target

INVITE sips:482n4z24kdg@chicago.example.com;gr=8594958 SIP/2.0
Via: SIP/2.0/TLS referee.example;branch=z9hG4bKffe209934aac
To: &lt;sips:482n4z24kdg@chicago.example.com;gr=8594958&gt;
From: &lt;sips:transferee@biloxi.example.com&gt;;tag=2909034023
Call-ID: fe9023940-a3465@referee.example
CSeq: 889823409 INVITE
Max-Forwards: 70
Contact: &lt;sips:3ld812adkjw@biloxi.example.com;gr=3413kj2ha&gt;
Referred-By: &lt;sips:transferor@atlanta.example.com&gt;
    ;cid="20398823.2UWQFN309shb3@atlanta.example.com"
Replaces:090459243588173445;to-tag=9m2n3wq;from-
  tag=76323
Require: replaces
Supported: gruu, replaces, tdialog
Content-Type: multipart/mixed; boundary=my-boundary-9
Content-Length: 3432

--my-boundary-9
Content-Type: application/sdp

Content-Length: 156

v=0
o=referee 2890844526 2890844526 IN IP4 referee.example
s=Session SDP
c=IN IP4 referee.example
t=0 0
m=audio 49172 RTP/AVP 0
a=rtpmap:0 PCMU/8000

--my-boundary-9
Content-Length: 2961
Content-Type: multipart/signed;
              protocol="application/pkcs-7-signature";
              micalg=sha1;
              boundary="----590F24D439B31E08745DEF0CD9397189"

------590F24D439B31E08745DEF0CD9397189
Content-Type: message/sipfrag

Date: Thu, 18 Sep 2003 13:07:43 GMT

&lt;allOneLine&gt;
Refer-To: &lt;sips:transfertarget@chicago.example.com;
Replaces=090459243588173445%3B
to-tag%3D9m2n3wq%3Bfrom-tag%3D763231&amp;Require=replaces&gt;
&lt;/allOneLine&gt;
Referred-By: &lt;sips:transferor@atlanta.example.com&gt;
  ;cid="20398823.2UWQFN309shb3@atlanta.example.com"

------590F24D439B31E08745DEF0CD9397189
Content-Type: application/pkcs-7-signature; name="smime.p7s"
Content-Transfer-Encoding: binary
Content-Disposition: attachment; filename="smime.p7s"

&lt;hex&gt;3082088806092A86

4886F70D010702A082087930820875020101310B300906052B0E03021A050030
0B06092A864886F70D010701A082067A30820339308202A2A003020102020800
90008902240001300D06092A864886F70D01010505003070310B300906035504
0613025553311330110603550408130A43616C69666F726E69613111300F0603
550407130853616E4A6F7365310E300C060355040A1305736970697431293027
060355040B135369706974546573744365727469666963617465417574686F72
697479301E170D3033313032313134343332355A170D31333130313831343433
32355A3062310B3009060355040613025553311330110603550408130A43616C
69666F726E69613111300F0603550407130853616E4A6F7365310E300C060355
040A13057369706974311B30190603550403141273656E646572406578616D70
6C652E6F726730819F300D06092A864886F70D010101050003818D0030818902
818100CB8302060F12C8FA2D1786922CA173DCEB80BF1B1B8AF74A310C6975A5
56A7630FB6E044D9E994DCD49AFF7976C462D7A8E74ECBF98723AEBF2796EDDD
6263577C6C2B77DC7C300B533DEDB5FB8EB3827FD6FC9B37B9A0DE829F1B1081
D632A8AD9FB00A860928E88F87E0B979BA65294AC7D6D2D18A78C86B4FA73387
4E230203010001A381E93081E6301D0603551D1104163014811273656E646572
406578616D706C652E6F726730090603551D1304023000301D0603551D0E0416
041440FF1C0C1BB8684CA917839D70E97DF8DD5B60D130819A0603551D230481
9230818F80146B461714EA94762580546E1354DAA1E35414A1B6A174A4723070
310B3009060355040613025553311330110603550408130A43616C69666F726E
69613111300F0603550407130853616E4A6F7365310E300C060355040A130573
6970697431293027060355040B13536970697454657374436572746966696361
7465417574686F72697479820100300D06092A864886F70D0101050500038181
006FFE1A3B5CE807C3DD2CFDF6E9787F491C84DBF7DCD11DB2D6A8887D2FE3F2
2E9C6894994282E50AA0DFFE1CBD4EC2C20217831FC2AD360FF1C0DE1DE1E870
102CFA99EE504C7DC0D8752A63294AC748DDDEFADE55C6D051F1CD54CFE7C153
278962A53CEF61B875C1FD3C74E972242CBA0131B3B8C607BF95B378212CA9A7
5E30820339308202A2A00302010202080090008902240001300D06092A864886
F70D01010505003070310B300906035504061302555331133011060355040813
0A43616C69666F726E69613111300F0603550407130853616E4A6F7365310E30
0C060355040A1305736970697431293027060355040B13536970697454657374
4365727469666963617465417574686F72697479301E170D3033313032313134
343332355A170D3133313031383134343332355A3062310B3009060355040613
025553311330110603550408130A43616C69666F726E69613111300F06035504
07130853616E4A6F7365310E300C060355040A13057369706974311B30190603
550403141273656E646572406578616D706C652E6F726730819F300D06092A86
4886F70D010101050003818D0030818902818100CB8302060F12C8FA2D178692
2CA173DCEB80BF1B1B8AF74A310C6975A556A7630FB6E044D9E994DCD49AFF79
76C462D7A8E74ECBF98723AEBF2796EDDD6263577C6C2B77DC7C300B533DEDB5
FB8EB3827FD6FC9B37B9A0DE829F1B1081D632A8AD9FB00A860928E88F87E0B9
79BA65294AC7D6D2D18A78C86B4FA733874E230203010001A381E93081E6301D
0603551D1104163014811273656E646572406578616D706C652E6F7267300906
03551D1304023000301D0603551D0E0416041440FF1C0C1BB8684CA917839D70
E97DF8DD5B60D130819A0603551D2304819230818F80146B461714EA94762580
546E1354DAA1E35414A1B6A174A4723070310B30090603550406130255533113
30110603550408130A43616C69666F726E69613111300F060355040713085361
6E4A6F7365310E300C060355040A1305736970697431293027060355040B1353
69706974546573744365727469666963617465417574686F7269747982010030
0D06092A864886F70D0101050500038181006FFE1A3B5CE807C3DD2CFDF6E978
7F491C84DBF7DCD11DB2D6A8887D2FE3F22E9C6894994282E50AA0DFFE1CBD4E
C2C20217831FC2AD360FF1C0DE1DE1E870102CFA99EE504C7DC0D8752A63294A
C748DDDEFADE55C6D051F1CD54CFE7C153278962A53CEF61B875C1FD3C74E972
242CBA0131B3B8C607BF95B378212CA9A75E318201D6308201D2020101307C30
70310B3009060355040613025553311330110603550408130A43616C69666F72
6E69613111300F0603550407130853616E4A6F7365310E300C060355040A1305
736970697431293027060355040B135369706974546573744365727469666963
617465417574686F7269747902080090008902240001300906052B0E03021A05
00A081B1301806092A864886F70D010903310B06092A864886F70D010701301C
06092A864886F70D010905310F170D3034303132363139313831345A30230609
2A864886F70D01090431160414408CCA5772916A968204FD24CC24EDAEAD3943
95305206092A864886F70D01090F31453043300A06082A864886F70D0307300E
06082A864886F70D030202020080300D06082A864886F70D0302020140300706
052B0E030207300D06082A864886F70D0302020128300D06092A864886F70D01
010105000481807795329BB23B8BB9F72526AB9CC22D93B9A37A2E69A0171D3C
C417DD394F0A5FD4F8B082733CD9F2E26F6991031F7FF2EAD31640718502FB4C
822771211E6228C793DA4DBBA2159227C221030FE9088CD659578EB862568087
8E63D306487A740A197A3970594CF47DD385643B1DC49FF767A3D2B428388966
79089AAD95767F&lt;/hex&gt;

------590F24D439B31E08745DEF0CD9397189--

--my-boundary-9--

</pre></div>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Transfer as an Ad-Hoc Conference</h3>

<p>
In this flow, shown in Figure 16, Bob does an attended transfer of Alice to Carol.  In order to keep both Alice and Carol fully informed of the nature and state of the transfer operation, Bob acts as a focus<a class='info' href='#RFC4579'>[RFC4579]<span> (</span><span class='info'>Johnston, A. and O. Levin, &ldquo;Session Initiation Protocol (SIP) Call Control - Conferencing for User Agents,&rdquo; August&nbsp;2006.</span><span>)</span></a>  and hosts an ad-hoc conference involving Alice, Bob, and Carol.  Alice and Carol subscribe to the conference package<a class='info' href='#RFC4575'>[RFC4575]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and O. Levin, &ldquo;A Session Initiation Protocol (SIP) Event Package for Conference State,&rdquo; August&nbsp;2006.</span><span>)</span></a>  of Bob's focus, which allows them to know the exact status of the operation.  After the transfer operation is complete, Bob deletes the conference.

</p>
<p>
This call flow meets requirement 6 of Section 3.  NOTIFY messages related to the refer package are indicated as NOTIFY (refer), while NOTIFYs related to the Conference Info package are indicated as NOTIFY (Conf-Info).

</p>
<p>
Note that any type of semi-attended transfer in which media mixing or relaying could be implemented using this model.  In addition to simply mixing, the focus could introduce additional media signals such as simulated ring tone or on hold announcements to improve the user experience.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 Alice                  Bob                 Carol
    |                    |                    |
    | INVITE             |                    |
    |-------------------&gt;|                    |
    |   180 Ringing      |                    |
    |&lt;-------------------|                    |
    |     200 OK         |                    |
    |&lt;-------------------|                    |
    |        ACK         |                    |
    |-------------------&gt;|                    |
    |        RTP         |                    |
    |&lt;==================&gt;|                    |
    |                    |                    |
 Bob places Alice on hold and begins acting like a focus
    |                    |                    |
    | INVITE (hold) Contact:Conf-ID;isfocus   |
    |&lt;-------------------|                    |
    |    200 OK          |                    |
    |-------------------&gt;|                    |
    |        ACK         |                    |
    |&lt;-------------------|                    |
    |                    |                    |
    | Alice subscribes to the conference package
    |                    |                    |
    | SUBSCRIBE sip:Conf-ID                   |
    |-------------------&gt;|                    |
    |     200 OK         |                    |
    |&lt;-------------------|                    |
    | NOTIFY (Conf-Info) |                    |
    |&lt;-------------------|                    |
    |     200 OK         |                    |
    |-------------------&gt;|                    |
    |                    |                    |
    |       Bob begins consultation operation |
    |                    |                    |
    |INVITE Require:replaces Contact:Conf-ID;isfocus
    |                    |-------------------&gt;|
    |                    |   180 Ringing      |
    |                    |&lt;-------------------|
    |                    |     200 OK         |
    |                    |&lt;-------------------|
    |                    |       ACK          |
    |                    |-------------------&gt;|
    |                    |        RTP         |
    |                    |&lt;==================&gt;|
    |                    |                    |
    |Carol subscribes to the conference package
    |                - learns Bob is on hold  |
    |                    |                    |
    |                    |SUBSCRIBE sip:Conf-ID
    |                    |&lt;-------------------|
    |                    |      200 OK        |
    |                    |-------------------&gt;|
    |                    | NOTIFY (Conf-Info) |
    |                    |-------------------&gt;|
    |                    |      200 OK        |
    |                    |&lt;-------------------|
    |                    |                    |
    | Alice learns that Bob is talking to Carol
    |                    |                    |
    | NOTIFY (Conf-Info) |                    |
    |&lt;-------------------|                    |
    |     200 OK         |                    |
    |-------------------&gt;|                    |
    |                    |  INVITE (hold)     |
    |                    |-------------------&gt;|
    |                    |      200 OK        |
    |                    |&lt;-------------------|
    |                    |      ACK           |
    |                    |-------------------&gt;|
    |                    |                    |
    | Alice learns that Carol is now on hold  |
    |                    |                    |
    | NOTIFY (Conf-Info) |                    |
    |&lt;-------------------|                    |
    |     200 OK         |                    |
    |-------------------&gt;|                    |
    |                    |                    |
    |           Bob begins transfer operation |
    |                    |                    |
    |     REFER Refer-To: Carol               |
    |&lt;-------------------|                    |
    |     202 Accepted   |                    |
    |-------------------&gt;|                    |
    | NOTIFY (Refer)     |                    |
    |-------------------&gt;|                    |
    |     200 OK         |                    |
    |&lt;-------------------|                    |
    |  INVITE Replaces:B-C Contact:Alice      |
    |----------------------------------------&gt;|
    |                 200 OK                  |
    |&lt;----------------------------------------|
    |                   ACK                   |
    |----------------------------------------&gt;|
    |                    RTP                  |
    |&lt;=======================================&gt;|
    |                    |       BYE          |
    |                    |&lt;-------------------|
    |                    |      200 OK        |
    |                    |-------------------&gt;|
    | NOTIFY (Refer)     |                    |
    |-------------------&gt;|                    |
    |     200 OK         |                    |
    |&lt;-------------------|                    |
    |                    |                    |
    | Bob terminates the ad-hoc conference    |
    |                    |                    |
    |       BYE          |                    |
    |&lt;-------------------|                    |
    |     200 OK         |                    |
    |-------------------&gt;|                    |
    |                    | NOTIFY (Conf-Info) |
    |                    |-------------------&gt;|
    |                    |      200 OK        |
    |                    |&lt;-------------------|
    | NOTIFY (Conf-Info) |                    |
    |&lt;-------------------|                    |
    |     200 OK         |                    |
    |-------------------&gt;|                    |

Figure 16. Attended Transfer as an Ad-Hoc Conference.
</pre></div><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>


</pre></div>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Transfer with multiple parties</h3>

<p>
   In this example shown in Figure 17, the Originator places call to the Facilitator who 
   reaches the Recipient through the Screener. The Recipient's contact 
   information is exposed to the Facilitator and the Originator. This 
   example is provided for clarification of the semantics of the REFER 
   method only and should not be used as the design of an   
   implementation. 
  
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     Originator   Facilitator   Screener   Recipient
    |            |            |          |
 1  |INVITE/200 OK/ACK        |          |"Get Fred for me!"
    |-----------&gt;|            |          |     "Right away!"
 2  |INVITE (hold)/200 OK/ACK |          |
    |&lt;-----------|            |          |
 2  |            |INVITE/200 OK/ACK      |"I have a call
    |            |-----------&gt;|          |from Mary for Fred"
 2  |            |INVITE (hold)/200 OK/ACK   "Hold please"
    |            |&lt;-----------|          |
 3  |            |            |INVITE/200 OK/ACK
    |            |            |---------&gt;|"You have a call
    |            |            |          |from Mary"
    |            |            |          |  "Put her through"
 3  |            |            |INVITE (hold)/200 OK/ACK
    |            |            |---------&gt;|
 4  |            |REFER       |          |
    |            |&lt;-----------|          |
 4  |            |202 Accepted|          |
    |            |-----------&gt;|          |
 4  |            |NOTIFY (100 Trying)    |
    |            |-----------&gt;|          |
 4  |            |200 OK      |          |
    |            |&lt;-----------|          |
 5  |            |INVITE/200 OK/ACK      |
    |            |----------------------&gt;|"This is Fred"
 4  |            |NOTIFY (200 OK)        |  "Please hold for
    |            |-----------&gt;|          |              Mary"
 4  |            |200 OK      |          |
    |            |&lt;-----------|          |
 2  |            |BYE/200 OK  |          |
    |            |&lt;-----------|          |
 3  |            |            |BYE/200 OK|
    |            |            |---------&gt;|
 5  |            |INVITE (hold)/200 OK/ACK
    |            |----------------------&gt;|
 6  |REFER       |            |          |
    |&lt;-----------|            |          |
 6  |202 Accepted|            |          |
    |-----------&gt;|            |          |
 6  |NOTIFY (100 Trying)      |          |
    |-----------&gt;|            |          |
 6  |200 OK      |            |          |
    |&lt;-----------|            |          |
 7  |INVITE/200 OK/ACK        |          |
    |-----------------------------------&gt;| "Hey Fred"
 6  |NOTIFY (200 OK)          |          |    "Hello Mary"
    |-----------&gt;|            |          |
 6  |200 OK      |            |          |
    |&lt;-----------|            |          |
 1  |BYE/200 OK  |            |          |
    |&lt;-----------|            |          |
 5  |            |BYE/200 OK  |          |
    |            |----------------------&gt;|
 7  |BYE/200 OK  |            |          |
    |&lt;-----------------------------------| "See you later"
</pre></div>
<p>
 Figure 17. Transfer with Multiple Parties Example.

</p>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Gateway Transfer Issues</h3>

<p>
   A gateway in SIP acts as a User Agent.  As a result, the entire preceding
   discussion and call flows apply equally well to gateways as native SIP 
   endpoints.  However, there are some gateway specific issues that are 
   documented in this section. While this discussion focuses on the common cases 
   involving PSTN gateways, similar situations exist for other gateways, such as 
   H.323/SIP gateways.

</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.1"></a><h3>11.1.&nbsp;
Coerce Gateway Hairpins to the Same Gateway</h3>

<p>
   To illustrate how a hairpin situation can occur in transfer, consider
   this example.  The original call dialog is setup with the transferee
   residing on the PSTN side of a SIP gateway.  The transferor is a SIP
   phone purely in the IP space.  The transfer target is on the PSTN side
   of a SIP gateway as well.  After completing the transfer, (regardless
   of consultative or blind) the transferee is in a call with the
   transfer target (both on the PSTN side of a gateway).  It is often
   desirable to remove the gateway(s) out of the loop.  This is likely
   to only be possible if both legs of the target call are on the same
   gateway.  With both legs on the same gateway, it may be able to
   invoke the analogous transfer on the PSTN side.  Then the target call
   would not involve the gateway.

</p>
<p>
   So the problem is how to give the proxy enough information so that it
   knows to route the call to the same gateway.  With a simple single
   call that hairpins, the incoming and outgoing leg have the same
   dialog.  The proxy should have enough information to optimize the
   routing.

</p>
<p>
   In the consultative transfer scenario, it is desirable to coerce the
   consultative INVITE out the same gateway as the original call to be
   transferred.  However there is no way to relate the consultation with
   the original call.  In the consultative case the target call INVITE
   includes the Replaces header which contains dialog information that
   can be used to relate it to the consultation.  However there is no
   information that relates the target call to the original.

</p>
<p>
   In the blind transfer scenario, it is desirable to coerce the target
   call onto the same gateway as the original call.  However the same
   problem exists in that the target dialog cannot be related to the
   original dialog.

</p>
<p>
   In either transfer scenario, it may be desirable to push the transfer
   operation onto the non-SIP side of the gateway.  Presumably this is
   not possible unless all of the legs go out the same gateway.  If the
   gateway supports more than one truck group, it might also be
   necessary to get all of the legs on the same trunk group in order to
   perform the transfer on the non-SIP side of the gateway.

</p>
<p>
   Solutions to these gateway specific issues may involve new extensions
   to SIP in the future.

</p>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.2"></a><h3>11.2.&nbsp;
Consultative Turned Blind Gateway Glare</h3>

<p>
   In the consultative transfer case turned blind, there is a glare-like
   problem.  The transferor initiates the consultation INVITE, the transferor
   gets impatient and hangs up, transitioning this to a blind transfer.
   The transfer target on the gateway (connected through a PSTN switch to
   a single line or dumb analog phone) rings.  The user answers the
   phone just after the CANCEL is received by the transfer target.  The
   REFER and INVITE for the target call are sent.  The transferee
   attempts to setup the call on the PSTN side, but gets either a busy or
   lands in the users voicemail as the user has the handset in hand and
   off hook.

</p>
<p>
   This is another example of a race condition that this call flow can cause.
   The recommended behavior is to use the approach described in Section 6.6.

</p>
<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
IANA Considerations</h3>

<p>None.
</p>
<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
Security Considerations</h3>

<p>
The call transfer flows shown in this document are implemented using the REFER and Replaces call control primitives in SIP.  As such, the security considerations detailed in the REFER <a class='info' href='#RFC3515'>[RFC3515]<span> (</span><span class='info'>Sparks, R., &ldquo;The Session Initiation Protocol (SIP) Refer Method,&rdquo; April&nbsp;2003.</span><span>)</span></a>  and Replaces <a class='info' href='#RFC3891'>[RFC3891]<span> (</span><span class='info'>Mahy, R., Biggs, B., and R. Dean, &ldquo;The Session Initiation Protocol (SIP) &quot;Replaces&quot; Header,&rdquo; September&nbsp;2004.</span><span>)</span></a> documents MUST be followed, which are briefly summarized in the following paragraphs.  This document addresses the issue of protecting the Address of Record URI of a transfer target in Sections 7.1 and 7.2.
</p>
<p>
Any REFER request must be appropriately authenticated and authorized using standard SIP mechanisms or calls may be hijacked.  A user agent may use local policy or human intervention in deciding whether or not to accept a REFER.  In generating NOTIFY responses based on the outcome of the triggered request, care should be taken in constructing the message/sipfrag body to ensure that no private information is leaked.

</p>
<p>

An INVITE containing a Replaces header field should only be accepted if it has been properly authenticated and authorized using standard SIP mechanisms, and the requestor is authorized to perform dialog replacement.  

</p>
<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
Acknowledgments</h3>

<p>
  This draft is a collaborative product of the SIP working group. Thanks
  to Rohan Mahy for his input on the use of Replaces in transfer.  
 
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15"></a><h3>15.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>15.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3515">[RFC3515]</a></td>
<td class="author-text">Sparks, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3515">The Session Initiation Protocol (SIP) Refer Method</a>,&rdquo; RFC&nbsp;3515, April&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3515.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3891">[RFC3891]</a></td>
<td class="author-text">Mahy, R., Biggs, B., and R. Dean, &ldquo;<a href="http://tools.ietf.org/html/rfc3891">The Session Initiation Protocol (SIP) "Replaces" Header</a>,&rdquo; RFC&nbsp;3891, September&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3891.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3892">[RFC3892]</a></td>
<td class="author-text">Sparks, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3892">The Session Initiation Protocol (SIP) Referred-By Mechanism</a>,&rdquo; RFC&nbsp;3892, September&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3892.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4538">[RFC4538]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc4538">Request Authorization through Dialog Identification in the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;4538, June&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4538.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>15.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sipping-cc-framework">[I-D.ietf-sipping-cc-framework]</a></td>
<td class="author-text">Mahy, R., Sparks, R., Rosenberg, J., Petrie, D., and A. Johnston, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-cc-framework-12.txt">A Call Control and Multi-party usage framework for the Session Initiation Protocol (SIP)</a>,&rdquo; draft-ietf-sipping-cc-framework-12 (work in progress), December&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-cc-framework-12.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sip-gruu">[I-D.ietf-sip-gruu]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-gruu-15.txt">Obtaining and Using Globally Routable User Agent (UA) URIs (GRUU) in the  Session Initiation Protocol (SIP)</a>,&rdquo; draft-ietf-sip-gruu-15 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-gruu-15.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4475">[RFC4475]</a></td>
<td class="author-text">Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg, J., and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc4475">Session Initiation Protocol (SIP) Torture Test Messages</a>,&rdquo; RFC&nbsp;4475, May&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4475.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4353">[RFC4353]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc4353">A Framework for Conferencing with the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;4353, February&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4353.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4579">[RFC4579]</a></td>
<td class="author-text">Johnston, A. and O. Levin, &ldquo;<a href="http://tools.ietf.org/html/rfc4579">Session Initiation Protocol (SIP) Call Control - Conferencing for User Agents</a>,&rdquo; BCP&nbsp;119, RFC&nbsp;4579, August&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4579.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4575">[RFC4575]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., and O. Levin, &ldquo;<a href="http://tools.ietf.org/html/rfc4575">A Session Initiation Protocol (SIP) Event Package for Conference State</a>,&rdquo; RFC&nbsp;4575, August&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4575.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sipping-dialogusage">[I-D.ietf-sipping-dialogusage]</a></td>
<td class="author-text">Sparks, R., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-dialogusage-06.txt">Multiple Dialog Usages in the Session Initiation Protocol</a>,&rdquo; draft-ietf-sipping-dialogusage-06 (work in progress), February&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipping-dialogusage-06.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Robert J. Sparks</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Estacado Systems</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:RjS@estacado.net">RjS@estacado.net</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Alan Johnston (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Avaya</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">St. Louis, MO</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:alan@sipstation.com">alan@sipstation.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Daniel Petrie</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">SIPez LLC</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">34 Robbins Rd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Arlington, MA  02476</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 617 273 4000</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:dan.ietf AT SIPez DOT com">dan.ietf AT SIPez DOT com</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.SIPez.com/">http://www.SIPez.com/</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
