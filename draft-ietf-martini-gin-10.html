<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Registration for Multiple Phone Numbers in the Session Initiation Protocol (SIP)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Registration for Multiple Phone Numbers in the Session Initiation Protocol (SIP)">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">MARTINI WG</td><td class="header">A. Roach</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Tekelec</td></tr>
<tr><td class="header">Updates: <a href='http://tools.ietf.org/html/rfc3680'>3680</a> (if&nbsp;approved)</td><td class="header">October 18, 2010</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">&nbsp;</td></tr>
<tr><td class="header">Expires: April 21, 2011</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Registration for Multiple Phone Numbers in the Session Initiation Protocol (SIP)<br />draft-ietf-martini-gin-10</h1>

<h3>Abstract</h3>

<p>
      This document defines a mechanism by which a SIP server
      acting as a traditional Private Branch Exchange (SIP-PBX)
      can register with a SIP Service Provider (SSP) to receive
      phone calls for UAs designated by phone numbers.
      In order to function properly, this mechanism relies on
      the fact that the phone numbers are fully qualified and
      globally unique.
    
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on April 21, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#constraints">2.</a>&nbsp;
Constraints<br />
<a href="#anchor2">3.</a>&nbsp;
Terminology and Conventions<br />
<a href="#anchor3">4.</a>&nbsp;
Mechanism Overview<br />
<a href="#anchor4">5.</a>&nbsp;
Registering for Multiple Phone Numbers<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sip-pbx">5.1.</a>&nbsp;
SIP-PBX Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">5.2.</a>&nbsp;
Registrar Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">5.3.</a>&nbsp;
SIP URI "user" Parameter Handling<br />
<a href="#ssp-processing">6.</a>&nbsp;
SSP Processing of Inbound Requests<br />
<a href="#anchor7">7.</a>&nbsp;
Interaction with Other Mechanisms<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#gruu">7.1.</a>&nbsp;
Globally Routable User-Agent URIs (GRUU)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">7.1.1.</a>&nbsp;
Public GRUUs<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#temp-gruu">7.1.2.</a>&nbsp;
Temporary GRUUs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">7.2.</a>&nbsp;
Registration Event Package<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#pbx-reg-event">7.2.1.</a>&nbsp;
SIP-PBX Aggregate Registration State<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#reg-UA">7.2.2.</a>&nbsp;
Individual AOR Registration State<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#outbound">7.3.</a>&nbsp;
Client-Initiated (Outbound) Connections<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#path">7.4.</a>&nbsp;
Non-Adjacent Contact Registration (Path) and Service Route Discovery<br />
<a href="#anchor12">8.</a>&nbsp;
Examples<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">8.1.</a>&nbsp;
Usage Scenario: Basic Registration<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">8.2.</a>&nbsp;
Usage Scenario: Using Path to Control Request URI<br />
<a href="#anchor15">9.</a>&nbsp;
IANA Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">9.1.</a>&nbsp;
New SIP Option Tag<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">9.2.</a>&nbsp;
New SIP URI Parameters<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">9.2.1.</a>&nbsp;
'bnc' SIP URI parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">9.2.2.</a>&nbsp;
'sg' SIP URI parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor20">9.3.</a>&nbsp;
New SIP Header Field Parameter<br />
<a href="#anchor21">10.</a>&nbsp;
Security Considerations<br />
<a href="#anchor22">11.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">12.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">12.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">12.2.</a>&nbsp;
Informative References<br />
<a href="#anchor25">Appendix&nbsp;A.</a>&nbsp;
Requirements Analysis<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>
      One of SIP's primary functions is providing rendezvous between
      users. By design, this rendezvous has been provided through
      a combination of the server look-up procedures defined in
      RFC 3263 <a class='info' href='#RFC3263'>[5]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a>, and the registrar procedures
      described in RFC 3261 <a class='info' href='#RFC3261'>[4]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
    
</p>
<p>
      The intention of the original protocol design was that any user's
      AOR would be handled by the authority indicated by the hostport
      portion of the AOR. The users registered individual reachability
      information with this authority, which would then route
      incoming requests accordingly.
    
</p>
<p>
      In actual deployments, some SIP servers have been deployed
      in architectures that, for various reasons, have
      requirements to provide dynamic routing information
      for large blocks of AORs, where all of the AORs in
      the block were to be handled by the same server. For
      purposes of efficiency, many of these deployments do
      not wish to maintain separate registrations for each of
      the AORs in the block. This leads to the desire for an
      alternate mechanism for providing dynamic routing
      information for blocks of AORs.
    
</p>
<p>
      Although the use of REGISTER requests to update reachability
      information for multiple users simultaneously is somewhat
      beyond the original semantics defined for REGISTER requests, this
      approach has seen significant deployment in certain
      environments. In particular, deployments in which small
      to medium SIP-PBX servers are addressed using E.164 numbers
      have used this mechanism to avoid the need to maintain
      DNS entries or static IP addresses for the SIP-PBX servers.
    
</p>
<p>
      In recognition of the momentum that REGISTER-based
      approaches have seen in deployments,
      this document defines a REGISTER-based approach that is
      tailored to E.164-addressed UAs in a SIP-PBX
      environment. It does not address
      registration of SIP URIs in which the user portion
      is not an E.164 number.
    
</p>
<a name="constraints"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Constraints</h3>

<p>
      The following paragraph is perhaps the most important
      in understanding the reasons for the design decisions
      made in this document.
    
</p>
<p>
      Within the problem space that has been established for
      this work, several constraints shape our solution. These
      are defined in the MARTINI requirements document
      <a class='info' href='#RFC5947'>[18]<span> (</span><span class='info'>Elwell, J. and H. Kaplan, &ldquo;Requirements for Multiple Address of Record (AOR) Reachability Information in the Session Initiation Protocol (SIP),&rdquo; September&nbsp;2010.</span><span>)</span></a>.
      In terms of impact to the solution at hand, the following
      two constraints have the most profound effect:
      (1) The SIP-PBX cannot be assumed to be assigned a static
          IP address; and 
      (2) No DNS entry can be relied upon to consistently resolve
          to the IP address of the SIP-PBX.
    
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Terminology and Conventions</h3>

<p> The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
    NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
    in this document are to be interpreted as described in RFC 2119
    <a class='info' href='#RFC2119'>[3]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<p>Further, the term "SSP" is meant as an acronym for a "SIP Service
    Provider," while the term "SIP-PBX" is used to indicate a SIP Private
    Branch Exchange.
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
      Indented portions of the document, such as this one,
      form non-normative, explanatory sections of the document.
    
</dd>
</dl></blockquote>

<p>
   Although SIP is a text-based protocol, some of the examples in this
   document cannot
   be unambiguously rendered without additional markup due to the
   constraints placed on the formatting of RFCs.  This document uses the
   &lt;allOneLine/> markup convention established in 
   RFC 4475 <a class='info' href='#RFC4475'>[15]<span> (</span><span class='info'>Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg, J., and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP) Torture Test Messages,&rdquo; May&nbsp;2006.</span><span>)</span></a> to avoid
   ambiguity and meet the RFC layout requirements.  For the
   sake of completeness, the text defining this markup from Section 2.1
   of RFC 4475 <a class='info' href='#RFC4475'>[15]<span> (</span><span class='info'>Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg, J., and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP) Torture Test Messages,&rdquo; May&nbsp;2006.</span><span>)</span></a>
   is reproduced in its entirety below:
   
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
      Several of these examples contain unfolded lines longer than 72
      characters.  These are captured between &lt;allOneLine/> tags.  The
      single unfolded line is reconstructed by directly concatenating
      all lines appearing between the tags (discarding any line feeds or
      carriage returns).  There will be no whitespace at the end of
      lines.  Any whitespace appearing at a fold-point will appear at
      the beginning of a line.
    
</dd>
</dl></blockquote>

<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
      The following represent the same string of bits:
    
</dd>
</dl></blockquote>

<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
      Header-name: first value, reallylongsecondvalue, third value
    
</dd>
</dl></blockquote>

<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
         &lt;allOneLine>
         Header-name: first value,<br />

          reallylongsecondvalue<br />

         , third value<br />

         &lt;/allOneLine>
    
</dd>
</dl></blockquote>

<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
         &lt;allOneLine>
         Header-name: first value,<br />

          reallylong<br />

         second<br />

         value,<br />

          third value<br />

         &lt;/allOneLine>
    
</dd>
</dl></blockquote>

<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
      Note that this is NOT SIP header-line folding, where different
      strings of bits have equivalent meaning.
    
</dd>
</dl></blockquote>

<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Mechanism Overview</h3>

<p>
      The overall mechanism is achieved using a REGISTER
      request with a specially-formatted Contact URI.
      This document also defines an option tag that can be used to
      ensure a registrar and any intermediaries understand the
      mechanism described herein.
    
</p>
<p>
      The Contact URI itself is tagged with a URI parameter
      to indicate that it actually represents multiple
      phone-number-associated contacts.
    
</p>
<p>
      We also define some lightweight extensions for Globally Routable
      UA URIs (GRUU) to
      allow the use of public and temporary GRUUs assigned by
      the SSP. 
    
</p>
<p>
      Aside from these extensions, the REGISTER request itself
      is processed by a registrar in the same way as normal
      registrations: by updating its location service with
      additional AOR-to-Contact bindings.
    
</p>
<p>
      Note that the list of AORs associated with a
      SIP-PBX is a matter of local provisioning at the SSP and
      at the SIP-PBX. The mechanism defined in this document
      does not provide any means to detect or recover from
      provisioning mismatches (although the registration
      event package can be used as a standardized means
      for auditing such AORs;
      see <a class='info' href='#pbx-reg-event'>Section&nbsp;7.2.1<span> (</span><span class='info'>SIP-PBX Aggregate Registration State</span><span>)</span></a>).
    
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Registering for Multiple Phone Numbers</h3>

<a name="sip-pbx"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
SIP-PBX Behavior</h3>

<p>
        To register for multiple AORs, the SIP-PBX sends
        a REGISTER request to the SSP. This REGISTER request varies
        from a typical REGISTER request in two important ways. First,
        it MUST contain an option tag of "gin"
        in both a "Require" header field and a "Proxy-Require"
        header field.  (The option tag "gin" is an acronym for
        "generate implicit numbers".)
        Second, in at least 
        one "Contact" header field, it MUST include a Contact
        URI that contains the URI parameter "bnc" (which stands
        for "bulk number contact"), and no user
        portion (hence no "@" symbol).
        A URI with a "bnc" parameter MUST NOT contain a
        user portion. Except for the SIP URI "user" parameter,
        this URI MAY contain any other parameters that the
        SIP-PBX desires. These parameters will be echoed back by
        the SSP in any requests bound for the SIP-PBX.
      
</p>
<p>
        Because of the constraints
        discussed in <a class='info' href='#constraints'>Section&nbsp;2<span> (</span><span class='info'>Constraints</span><span>)</span></a>, the host
        portion of the Contact URI will generally contain
        an IP address, although nothing in this mechanism
        enforces or relies upon that fact. If the SIP-PBX operator
        chooses to maintain DNS entries that resolve to the
        IP address of his SIP-PBX via RFC 3263 resolution procedures,
        then this mechanism works just fine with domain names
        in the Contact header field.
      
</p>
<p>
        The "bnc" URI parameter indicates that special interpretation
        of the Contact URI is necessary: instead of representing
        a single, concrete Contact URI to be inserted into the
        location service, it represents multiple
        URIs (one for each associated AOR), semantically
        resulting in multiple AOR-to-Contact rows in the
        location service.
      
</p>
<p>
        Any SIP-PBX implementing the registration mechanism defined in
        this document MUST also support the Path mechanism defined
        by RFC 3327 <a class='info' href='#RFC3327'>[10]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>, and MUST include a
        'path' option-tag in the Supported header field of the REGISTER
        request (which is a stronger requirement than imposed by the
        Path mechanism itself).  This behavior is necessary because
        proxies between the SIP-PBX and the Registrar may need to insert
        Path header field values in the REGISTER request for this
        document's mechanism to function properly, and per RFC 3327
        <a class='info' href='#RFC3327'>[10]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>, they can only do so if the UAC
        inserted the option-tag in the Supported header field.  In
        accordance with the procedures defined in RFC 3327 <a class='info' href='#RFC3327'>[10]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>, the SIP-PBX is allowed to ignore the Path
        header fields returned in the REGISTER response.
      
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Registrar Behavior</h3>

<p>
        The registrar, upon receipt of a REGISTER request 
        containing at least one Contact header field with
        a "bnc" parameter will use the value in the "To" header field
        to identify the SIP-PBX for which registration is being requested.
        It then authenticates the SIP-PBX (using, e.g., SIP Digest
        authentication, mutual TLS, or some other authentication
        mechanism).  After the SIP-PBX is authenticated, the registrar
        updates its location service with a unique AOR-to-Contact
        mapping for each of the AORs associated with the
        SIP-PBX.  Semantically, each of these mappings will be treated
        as a unique row in the location service.  The actual
        implementation may, of course, perform internal optimizations
        to reduce the amount of memory used to store
        such information.
      
</p>
<p>
        For each of these unique rows, the AOR will be in the format
        that the SSP expects to receive from external parties (e.g.
        "sip:+12145550102@ssp.example.com"), and the corresponding
        Contact will be formed by adding to the REGISTER request's Contact
        URI a user portion containing the fully-qualified, E.164-formatted
        number (including the preceding "+" symbol) and removing
        the "bnc" parameter. Aside from the initial "+" symbol, this
        E.164-formatted number MUST consist exclusively of digits
        from 0 through 9, and explicitly MUST NOT contain any visual
        separator symbols (e.g., "-", ".", "(", or ")").  For
        example, if the "Contact" header field contains the URI
        &lt;sip:198.51.100.3:5060;bnc>, then the Contact
        value
        associated with the aforementioned AOR will be
        &lt;sip:+12145550102@198.51.100.3:5060>.
      
</p>
<p>
        Although the SSP treats this registration as a number of
        discrete rows for the purpose of re-targeting incoming requests,
        the renewal, expiration, and removal of these rows is bound
        to the registered contact. In particular, this means
        that REGISTER requests that attempt to de-register a single
        AOR that has been implicitly registered MUST NOT
        remove that AOR from the bulk registration.  In this circumstance,
        the registrar simply acts as if the UA attempted to unregister
        a contact that wasn't actually registered (e.g., return the
        list of presently registered contacts in a success response).
        A further
        implication of this property is that an individual extension
        that is implicitly registered may also be explicitly registered
        using a normal, non-bulk registration (subject to SSP policy).
        If such a registration exists, it is refreshed independently
        of the bulk registration, and is not removed when the bulk
        registration is removed.
      
</p>
<p>
        A registrar that receives a REGISTER request containing a
        Contact URI with both a "bnc"
        parameter and a user portion MUST NOT
        send a 200-class (success) response. If no other error
        is applicable, the registrar can use a 400 (Bad Request)
        response to indicate this error condition.
        
      
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
          Note that the preceding paragraph is talking about
          the user portion of a URI:<br />

          sip:+12145550100@example.com<br />

          &#x0A0;&#x0A0;&#x0A0;&#x0A0;^^^^^^^^^^^^
        
</dd>
</dl></blockquote>

<p>
        A Registrar compliant with this document MUST support the
        Path mechanism defined in RFC 3327 <a class='info' href='#RFC3327'>[10]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>.
        The rationale for support of this mechanism is given in
        section <a class='info' href='#sip-pbx'>Section&nbsp;5.1<span> (</span><span class='info'>SIP-PBX Behavior</span><span>)</span></a>.
      
</p>
<p>
        Aside from the "bnc" parameter, all URI
        parameters present
        on the "Contact" URI in the REGISTER request MUST be copied
        to the Contact value stored in the location service.
      
</p>
<p>
        If the SSP servers perform processing based on User Agent
        Capabilities (as defined in RFC 3840 <a class='info' href='#RFC3840'>[13]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Indicating User Agent Capabilities in the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a>),
        they will treat any feature tags present on a Contact
        header field with a "bnc" parameter in its URI as applicable 
        to all of the resulting
        AOR-to-Contact mappings. Similarly, any option tags present
        on the REGISTER request that indicate special handling
        for any subsequent requests are also applicable to all
        of the AOR-to-Contact mappings.
      
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
SIP URI "user" Parameter Handling</h3>

<p>
        This document does not modify the behavior specified
        in RFC 3261 <a class='info' href='#RFC3261'>[4]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> for inclusion
        of the "user" parameter on request URIs. However,
        to avoid any ambiguity in handling at the SIP-PBX,
        the following normative behavior is imposed on its
        interactions with the SSP.
      
</p>
<p>
        When a SIP-PBX registers with an SSP using a contact containing
        a "bnc" parameter,
        that contact MUST NOT include a "user" parameter.  An SSP registrar 
        that
        receives a REGISTER request containing a Contact URI with both a
        "bnc" parameter and a "user" parameter MUST NOT
        send a 200-class (success) response. If no other error
        is applicable, the registrar can use a 400 (Bad Request)
        response to indicate this error condition.
      
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
          Note that the preceding paragraph is talking about
          the "user" parameter of a URI:<br />

          sip:+12145550100@example.com;user=phone<br />

          &#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;&#x0A0;^^^^^^^^^^
        
</dd>
</dl></blockquote>

<p>
        When a SIP-PBX receives a request from an SSP, and
        the Request-URI contains a user portion corresponding
        to an AOR registered using a contact containing a "bnc" parameter, 
        then the
        SIP-PBX MUST NOT reject the request (or otherwise
        cause the request to fail) due to the
        absence, presence, or value of a "user" parameter
        on the Request-URI.
      
</p>
<a name="ssp-processing"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
SSP Processing of Inbound Requests</h3>

<p>
      In general, after processing the AOR-to-Contact mapping
      described in the preceding section, the SSP Proxy/Registrar
      (or equivalent entity) performs traditional Proxy/Registrar
      behavior, based on the mapping.  For any inbound SIP requests
      whose AOR indicates an E.164 number assigned to one of
      the SSP's customers, this will generally involve
      setting the target set to the registered contacts
      associated with that AOR, and performing
      request forwarding as described in section 16.6 of
      RFC 3261 <a class='info' href='#RFC3261'>[4]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. An SSP using the mechanism
      defined in this document MUST perform
      such processing for inbound INVITE requests and SUBSCRIBE requests
      to the "reg" event package (see <a class='info' href='#reg-UA'>Section&nbsp;7.2.2<span> (</span><span class='info'>Individual AOR Registration State</span><span>)</span></a>),
      and SHOULD perform such processing for all other method types, 
      including unrecognized SIP methods.
    
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Interaction with Other Mechanisms</h3>

<p>
      The following sections describe the means by which this mechanism
      interacts with relevant REGISTER-related extensions currently
      defined by the IETF.
    
</p>
<a name="gruu"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Globally Routable User-Agent URIs (GRUU)</h3>

<p>
        To enable advanced services to work with UAs
        behind a SIP-PBX, it is important that the GRUU
        mechanism defined by RFC 5627 
        <a class='info' href='#RFC5627'>[17]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP),&rdquo; October&nbsp;2009.</span><span>)</span></a> work correctly
        with the mechanism defined by this document -- that is,
        that User Agents served by the SIP-PBX can acquire and
        use GRUUs for their own use.
      
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.1"></a><h3>7.1.1.&nbsp;
Public GRUUs</h3>

<p>
        
          Support of public GRUUs is optional in SSPs and SIP-PBXes.
        
</p>
<p>
          When a SIP-PBX registers a Bulk Number Contact (a Contact with
          a "bnc" parameter), and also invokes GRUU procedures for
          that Contact during registration, then the SSP will
          assign a public GRUU to the SIP-PBX in the normal fashion.
          Because the URI being registered contains a "bnc" parameter,
          the GRUU will also contain a "bnc" parameter. In particular,
          this means that the GRUU will not contain a user portion.
        
</p>
<p>
        When a UA registers a contact with the SIP-PBX using GRUU procedures, the SIP-PBX provides to the UA a public GRUU formed by adding an "sg" parameter to the GRUU parameter it received from the SSP. This "sg" parameter contains a disambiguation token that the SIP-PBX can use to route inbound requests to the proper UA.
        
</p>
<p>
          So, for example, when the SIP-PBX registers with the following
          contact header field:

          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Contact: &lt;sip:198.51.100.3;bnc&gt;;
  +sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
</pre></div><p>


          Then the SSP may choose to respond with a Contact header field
          that looks like this:

          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;allOneLine&gt;
Contact: &lt;sip:198.51.100.3;bnc&gt;;
pub-gruu="sip:ssp.example.com;bnc;gr=urn:
uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6";
+sip.instance="&lt;urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6&gt;"
;expires=7200
&lt;/allOneLine&gt;
</pre></div><p>


          When its own UAs register using GRUU procedures, the SIP-PBX
          can then add  whatever device identifier it feels appropriate
          in an "sg" parameter, and present this value to its
          own UAs. For example, assume the UA associated
          with the AOR "+12145550102" sent the following
          Contact header field in its REGISTER request:

          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Contact: &lt;sip:line-1@10.20.1.17&gt;;
  +sip.instance="&lt;urn:uuid:d0e2f290-104b-11df-8a39-0800200c9a66&gt;"
</pre></div><p>


          The SIP-PBX will add an "sg" parameter to the pub-gruu it
          received from the SSP with a token that uniquely 
          identifies the device (possibly the URN itself; possibly
          some other identifier); insert a user portion containing
          the fully-qualified E.164 number associated with the
          UA; and return the result to the UA as its
          public GRUU. The resulting Contact header field sent from
          the SIP-PBX to the registering UA would 
          look something like this:

          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;allOneLine&gt;
Contact: &lt;sip:line-1@10.20.1.17&gt;;
pub-gruu="sip:+12145550102@ssp.example.com;gr=urn:
uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6;sg=00:05:03:5e:70:a6";
+sip.instance="&lt;urn:uuid:d0e2f290-104b-11df-8a39-0800200c9a66&gt;"
;expires=3600
&lt;/allOneLine&gt;
</pre></div><p>

        
</p>
<p>
          When an incoming request arrives at the SSP for a GRUU
          corresponding to a bulk number contact ("bnc"), the SSP
          performs slightly different processing for the GRUU than
          it would for a URI without a "bnc" parameter.
          When the GRUU is re-targeted
          to the registered bulk number contact, the SSP MUST
          copy the "sg" parameter from the GRUU to the new target.
          The SIP-PBX can then use this "sg" parameter to determine which
          user agent the request should be routed to. For example,
          the first line of an INVITE request that has been re-targeted
          to the SIP-PBX for the UA shown above would look like this:
          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
INVITE sip:+12145550102@198.51.100.3;sg=00:05:03:5e:70:a6 SIP/2.0
</pre></div><p>

        
</p>
<a name="temp-gruu"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.2"></a><h3>7.1.2.&nbsp;
Temporary GRUUs</h3>

<p>
          In order to provide support for privacy, the SSP
          SHOULD implement the temporary GRUU
          mechanism described in this section. Reasons for
          not doing so would include systems with an
          alternative privacy mechanism which maintains
          the integrity of public GRUUs (i.e., if public
          GRUUs are anonymized then the anonymizer
          function would need to be capable of providing as
          the anonymized URI a globally routable URI
          that routes back only to the target identified by
          the original public GRUU).
        
</p>
<p>
          Temporary GRUUs are used to provide anonymity
          for the party creating and sharing the GRUU.
          Being able to correlate two temporary GRUUs as
          having originated from behind the same SIP-PBX violates
          this principle of anonymity. Consequently, rather
          than relying upon a single, invariant identifier
          for the SIP-PBX in its UA's temporary GRUUs, we define
          a mechanism whereby the SSP provides the SIP-PBX with
          sufficient information for the SIP-PBX to mint unique
          temporary GRUUs. These GRUUs have the property that
          the SSP
          can correlate them to the proper SIP-PBX, but no other
          party can do so. To achieve this goal, we use a
          slight modification of the procedure described
          in appendix A.2 of RFC 5627 <a class='info' href='#RFC5627'>[17]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP),&rdquo; October&nbsp;2009.</span><span>)</span></a>.
        
</p>
<p>
          The SIP-PBX needs to be able to construct a temp-gruu in a way that
          the SSP can decode.
          In order to ensure that the SSP can decode GRUUs,
          we need to standardize the algorithm for creation
          of temp-gruus at the SIP-PBX.  This allows the SSP to
          reverse the algorithm to identify
          the registration entry that corresponds to the
          GRUU.
        
</p>
<p>
          It is equally important that no party other than
          the SSP is capable of decoding a temporary GRUU,
          including other SIP-PBXes serviced by the SSP.
          To achieve this property, an SSP that supports
          temporary GRUUs MUST create and store an asymmetric key
          pair, {K_e1,K_e2}. K_e1 is kept secret by the
          SSP, while K_e2 is shared with the SIP-PBXes via provisioning.
        
</p>
<p>
          All base64 encoding discussed in the following sections MUST 
          use the character set and encoding defined in
          RFC 2045 <a class='info' href='#RFC2045'>[1]<span> (</span><span class='info'>Freed, N. and N. Borenstein, &ldquo;Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies,&rdquo; November&nbsp;1996.</span><span>)</span></a>, except that
          any trailing "=" characters are discarded on encoding,
          and added as necessary to decode.
        
</p>
<a name="ssp-tgc-gen"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.2.1"></a><h3>7.1.2.1.&nbsp;
Generation of temp-gruu-cookie by the SSP</h3>

<p>
            An SSP that supports temporary GRUUs 
            MUST include a "temp-gruu-cookie"
            parameter on all Contact header fields containing a
            "bnc" parameter in a
            200-class REGISTER response. This "temp-gruu-cookie"
            MUST have the following properties:
          
</p>
<p>
            </p>
<ol class="text">
<li>
                It can be used by the SSP to uniquely identify
                the registration to which it corresponds.
              
</li>
<li>
                It is encoded using base64. This allows the
                SIP-PBX to decode it into as compact a form as
                possible for use in its calculations.
              
</li>
<li>
                It is of a fixed length. This allows for
                extraction of it once the SIP-PBX has concatenated
                a distinguisher onto it.
              
</li>
<li>
                The temp-gruu-cookie MUST NOT be forgeable
                by any party. In other words, the SSP needs
                to be able to examine the cookie and validate
                that it was generated by the SSP.
              
</li>
<li>
                The temp-gruu-cookie MUST be invariant during
                the course of a registration, including any
                refreshes to that registration. This property
                is important, as it allows the SIP-PBX to
                examine the temp-gruu-cookie to determine
                whether the temp-gruus it has issued to its
                UAs are still valid.
              
</li>
</ol><p>
          
</p>
<p>
            The above properties can be met using the following
            algorithm, which is non-normative. Implementors may
            chose to implement any algorithm of their choosing for
            generation of the temp-gruu-cookie, as
            long as it fulfills the five properties listed above.
          
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
            The SSP registrar maintains a counter, I.
            this counter is 48 bits long, and initialized to zero.
            This counter is persistently stored, using a
            back-end database or similar technique. When the
            SSP registrar
            creates the first temporary GRUU for a particular SIP-PBX
            and instance ID (as defined by <a class='info' href='#RFC5627'>[17]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP),&rdquo; October&nbsp;2009.</span><span>)</span></a>),
            the SSP registrar notes the current value
            of the counter, I_i, and increments the counter in the
            database.  The SSP registrar then maps I_i to the 
            Contact and
            instance ID using the database, a persistent hash-map
            or similar technology.  If the registration expires
            such that there are no longer any contacts with that
            particular instance ID bound to the GRUU, the SSP registrar
            removes the mapping.  Similarly, if the temporary GRUUs
            are invalidated due to a change in Call-ID, the SSP registrar
            removes the current mapping from I_i to the AOR and
            instance ID, notes the current value of the counter
            I_j, and stores a mapping from I_j to the 
            contact containing a "bnc" parameter and
            instance ID.  Based on these rules, the hash-map will
            contain a single mapping for each contact containing a
            "bnc" parameter and instance ID
            for which there is a currently valid registration.
          
</dd>
</dl></blockquote>

<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
            The SSP registrar maintains a symmetric key SK_a,
            which is regenerated every time the counter rolls
            over or is is reset. When the counter rolls over or is reset,
            the SSP registrar remembers the old value of SK_a for
            a while. To generate a temp-gruu-cookie, the SSP
            registrar computes:
          <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

      SA = HMAC-SHA256-80(SK_a, I_i)
      temp-gruu-cookie = base64enc(I_i || SA)

</pre></div>
          where || denotes concatenation.
          
</dd>
</dl></blockquote>

<a name="pbx-tg-gen"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.2.2"></a><h3>7.1.2.2.&nbsp;
Generation of temp-gruu by the SIP-PBX</h3>

<p>
          According to RFC5627 <a class='info' href='#RFC5627'>[17]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP),&rdquo; October&nbsp;2009.</span><span>)</span></a> section 3.2, 
          every registration refresh generates a new temp-gruu that
          is valid for as long as the contact remains registered.
          This property is both critical for the privacy properties
          of temp-gruu and is expected by UAs that implement the
          temp-gruu procedures. Nothing in this document should
          be construed as changing this fundamental temp-gruu
          property in any way. SIP-PBXes that implement
          temporary GRUUs MUST generate a new temp-gruu according
          to the procedures in this section for every registration
          or registration refresh from GRUU-supporting UAs 
          attached to the SIP-PBX.
        
</p>
<p>
          Similarly, if the registration that a SIP-PBX has with
          its SSP expires or is terminated, then the temp-gruu
          cookie it maintains with the SSP will change. This change
          will invalidate all the temp-gruus the SIP-PBX has issued
          to its UAs. If the SIP-PBX tracks this information
          (e.g., to include &lt;temp-gruu> elements in
          registration event bodies, as described in RFC 5628
          <a class='info' href='#RFC5628'>[9]<span> (</span><span class='info'>Kyzivat, P., &ldquo;Registration Event Package Extension for Session Initiation Protocol (SIP) Globally Routable User Agent URIs (GRUUs),&rdquo; October&nbsp;2009.</span><span>)</span></a>), it can determine that
          previously issued temp-gruus are invalid by observing
          a change in the temp-gruu-cookie provided to it
          by the SSP.
        
</p>
<p>
          A SIP-PBX that issues temporary GRUUs to its UAs
          MUST maintain an HMAC key, PK_a. This value is used
          to validate that incoming GRUUs were generated by
          the SIP-PBX.
        
</p>
<p>
          To generate a new temporary GRUU for use by its own
          UAs, the SIP-PBX MUST generate a random distinguisher
          value D. The length of this value is up to implementors,
          but MUST be long enough to prevent collisions among
          all the temporary GRUUs issued by the SIP-PBX. A size of
          80 bits or longer is RECOMMENDED. The SIP-PBX then 
          MUST calculate:
          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  M    = base64dec(SSP-cookie) || D
  E    = RSA-Encrypt(K_e2, M)
  PA   = HMAC(PK_a, E)

  Temp-Gruu-userpart = "tgruu." || base64(E) || "." || base64(PA)

</pre></div><p>

          where || denotes concatenation. "HMAC" represents
          any suitably strong HMAC algorithm; see RFC 2104
          <a class='info' href='#RFC2104'>[2]<span> (</span><span class='info'>Krawczyk, H., Bellare, M., and R. Canetti, &ldquo;HMAC: Keyed-Hashing for Message Authentication,&rdquo; February&nbsp;1997.</span><span>)</span></a>
          for a discussion of HMAC algorithms. One suitable
          HMAC algorithm for this purpose is HMAC-SHA256-80.
        
</p>
<p>
           Finally, the SIP-PBX adds a "gr" parameter to the temporary
           GRUU that can be used to uniquely identify the UA
           registration record to which the GRUU corresponds.
           The means of generation of the "gr" parameter are
           left to the implementor, as long as they satisfy
           the properties of a GRUU as described in 
           RFC 5627 <a class='info' href='#RFC5627'>[17]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP),&rdquo; October&nbsp;2009.</span><span>)</span></a>.
        
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
           One valid approach for generation of the "gr"
           parameter is calculation of "E" and "A" as described
           in Appendix A.2 of RFC 5627 <a class='info' href='#RFC5627'>[17]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP),&rdquo; October&nbsp;2009.</span><span>)</span></a>,
           and forming the "gr" parameter as:
          <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

      gr = base64enc(E) || base64enc(A)

</pre></div>
       
</dd>
</dl></blockquote>

<p>
            Using this procedure may result in a temporary GRUU
            returned to the registering UA by the SIP-PBX that looks similar
            to this:
          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;allOneLine&gt;
Contact: &lt;sip:line-1@10.20.1.17&gt;
;temp-gruu="sip:tgruu.MQyaRiLEd78RtaWkcP7N8Q.5qVbsasdo2pkKw@
ssp.example.com;gr=YZGSCjKD42ccxO08pA7HwAM4XNDIlMSL0HlA"
;+sip.instance="&lt;urn:uuid:d0e2f290-104b-11df-8a39-0800200c9a66&gt;"
;expires=3600
&lt;/allOneLine&gt;
</pre></div><p>

          
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.2.3"></a><h3>7.1.2.3.&nbsp;
Decoding of temp-gruu by the SSP</h3>

<p>
            When the SSP proxy receives a request in which the
            user part begins with "tgruu.", it extracts
            the remaining portion, and splits it at the
            "." character into E' and PA'. It discards
            PA'. It then computes E by performing a base64
            decode of E'. Next, it computes:
            </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  M = RSA-Decrypt(K_e1, E)

</pre></div><p>

            The SSP proxy extracts the fixed-length
            temp-gruu-cookie information from the
            beginning of this M, and discards the remainder
            (which will be the distinguisher added by
            the SIP-PBX). It then validates this temp-gruu-cookie.
            If valid, it uses it to locate the corresponding
            SIP-PBX registration record, and routes the message
            appropriately.
          
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
            If the non-normative, exemplary algorithm
            described in <a class='info' href='#ssp-tgc-gen'>Section&nbsp;7.1.2.1<span> (</span><span class='info'>Generation of temp-gruu-cookie by the SSP</span><span>)</span></a>
            is used to generate the temp-gruu-cookie,
            then this identification is performed
            by splitting the temp-gruu-cookie information
            into its 48-bit counter I and 80-bit HMAC.
            It validates that the HMAC matches the counter I,
            and then uses counter I to locate the SIP-PBX
            registration record in its map. If the counter
            has rolled over or reset, this computation
            is performed with the current and previous
            SK_a.
          
</dd>
</dl></blockquote>

<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.2.4"></a><h3>7.1.2.4.&nbsp;
Decoding of temp-gruu by the SIP-PBX</h3>

<p>
            When the SIP-PBX receives a request in which the
            user part begins with "tgruu.", it extracts
            the remaining portion, and splits it at the
            "." character into E' and PA'.
            It then computes E and PA by performing a base64
            decode of E' and PA' respectively. Next, it computes:
            </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  PAc = HMAC(PK_a, E)

</pre></div><p>

            where HMAC is the HMAC algorithm used for the steps
            in <a class='info' href='#pbx-tg-gen'>Section&nbsp;7.1.2.2<span> (</span><span class='info'>Generation of temp-gruu by the SIP-PBX</span><span>)</span></a>. If this computed value
            for PAc does not match the value of PA extracted
            from the GRUU, then the GRUU is rejected as
            invalid.
          
</p>
<p>
            The SIP-PBX then uses the value of the "gr" parameter
            to locate the UA registration to which the GRUU
            corresponds, and routes the message accordingly.
          
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
Registration Event Package</h3>

<p>
        Neither the SSP nor the SIP-PBX is required to support
        the Registration event package defined by
        RFC 3680 <a class='info' href='#RFC3680'>[12]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a>. However, if they do
        support the Registration event package, they MUST conform
        to the behavior described in this section and its subsections.
      
</p>
<p>
        As this mechanism inherently deals with REGISTER transaction behavior,
        it is imperative to consider its impact on the Registration
        Event Package defined by RFC 3680 <a class='info' href='#RFC3680'>[12]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a>.
        In practice, there will be two main use cases for subscribing
        to registration data: learning about the overall registration
        state for the SIP-PBX, and learning about the registration state
        for a single SIP-PBX AOR.
      
</p>
<a name="pbx-reg-event"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2.1"></a><h3>7.2.1.&nbsp;
SIP-PBX Aggregate Registration State</h3>

<p>
          If the SIP-PBX (or another interested and authorized party)
          wishes to monitor or audit the registration state for
          all of the AORs currently registered to that SIP-PBX,
          it can subscribe to the SIP registration event package
          at the SIP-PBX's main URI -- that is, the URI used in
          the "To" header field of the REGISTER request.
        
</p>
<p>
          The NOTIFY messages for such a subscription will contain
          a body that contains one record for each AOR
          associated with the SIP-PBX. The AORs will be in the format
          expected to be received by the SSP (e.g., 
          "sip:+12145550105@ssp.example.com"), and the Contacts
          will correspond to the mapped Contact created by the
          registration (e.g., "sip:+12145550105@98.51.100.3").
        
</p>
<p>
          In particular, the "bnc" parameter is forbidden from
          appearing in the body of a reg-event NOTIFY request unless
          the subscriber has indicated knowledge of the semantics
          of the "bnc" parameter. The means for indicating this
          support are out of scope of this document.
        
</p>
<p>
          Because the SSP does not necessarily know which
          GRUUs have been issued by the SIP-PBX to its associated UAs,
          these records will not generally the contain &lt;temp-gruu>
          or &lt;pub-gruu> elements defined in RFC 5628 
          <a class='info' href='#RFC5628'>[9]<span> (</span><span class='info'>Kyzivat, P., &ldquo;Registration Event Package Extension for Session Initiation Protocol (SIP) Globally Routable User Agent URIs (GRUUs),&rdquo; October&nbsp;2009.</span><span>)</span></a>. This information can be
          learned, if necessary, by subscribing to the individual
          AOR registration state, as described in
          <a class='info' href='#reg-UA'>Section&nbsp;7.2.2<span> (</span><span class='info'>Individual AOR Registration State</span><span>)</span></a>.
        
</p>
<a name="reg-UA"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2.2"></a><h3>7.2.2.&nbsp;
Individual AOR Registration State</h3>

<p>
          As described in <a class='info' href='#ssp-processing'>Section&nbsp;6<span> (</span><span class='info'>SSP Processing of Inbound Requests</span><span>)</span></a>, the
          SSP will generally retarget all requests addressed to
          an AOR owned by a SIP-PBX to that SIP-PBX according
          to the mapping established at registration time.
          Although policy at the SSP may override this generally
          expected behavior, proper behavior of the registration
          event package requires that all "reg" event SUBSCRIBE
          requests are processed by the SIP-PBX. As a consequence,
          the requirements on an SSP for processing registration
          event package SUBSCRIBE requests are not left to policy.
        
</p>
<p>
          If the SSP receives a SUBSCRIBE request for the registration
          event package with a Request-URI that indicates an
          AOR registered via the "Bulk Number Contact" mechanism
          defined in this document, then the SSP MUST proxy that SUBSCRIBE
          to the SIP-PBX in the same way that it would proxy an INVITE
          bound for that AOR, unless the SSP has and can maintain
          a copy of complete, accurate, and up-to-date information
          from the SIP-PBX (e.g., through an active back-end
          subscription).
        
</p>
<p>
          If the Request-URI in a SUBSCRIBE request for the
          registration event package indicates a contact that
          is registered by more than one SIP-PBX, then the SSP
          proxy will fork the SUBSCRIBE request to all the applicable
          SIP-PBXes. Similarly, if the Request-URI corresponds
          to a contact that is both implicitly registered by
          a SIP-PBX and explicitly registered directly with the
          SSP proxy, then the SSP proxy will semantically fork the
          SUBSCRIBE request to the applicable SIP-PBX or SIP-PBXes and to
          the SSP registrar function (which will respond with registration
          data corresponding to the explicit registrations at the
          SSP). The forking in both of these cases can be
          avoided if the SSP has and can maintain a copy of
          up-to-date information from the PBXes.
        
</p>
<p>
          Section 4.9 of RFC 3680 <a class='info' href='#RFC3680'>[12]<span> (</span><span class='info'>Rosenberg, J., &ldquo;A Session Initiation Protocol (SIP) Event Package for Registrations,&rdquo; March&nbsp;2004.</span><span>)</span></a> indicates that
          "a subscriber MUST NOT create multiple dialogs as a result of a 
          single [registration event] subscription request." Consequently,
          subscribers who are not aware of the extension described by
          this document will accept only one dialog in response to 
          such requests. In the case described in the preceding paragraph,
          this behavior will result in such client receiving
          accurate but incomplete information about the registration
          state of an AOR. As an explicit change to the normative behavior 
          of RFC 3680, this document stipulates that subscribers to the 
          registration event package MAY create multiple dialogs as the 
          result of a single subscription request. This will allow subscribers
          to create a complete view of an AOR's registration state.
        
</p>
<p>
          Defining the behavior as described above is important, since
          the reg-event subscriber is interested in finding out
          about the comprehensive list of devices associated with
          the AOR. Only the SIP-PBX will have authoritative
          access to this information.  For example, if the user has
          registered multiple UAs with differing capabilities,
          the SSP will not know about the devices or their capabilities.
          By contrast, the SIP-PBX will.
        
</p>
<p>
          If the SIP-PBX is not registered with the
          SSP when a registration event subscription for a contact
          that would be implicitly registered if the SIP-PBX were
          registered, then the SSP SHOULD accept the subscription
          and indicate that the user is not currently registered.
          Once the associated SIP-PBX is registered, the SSP
          SHOULD use the subscription migration mechanism defined
          in RFC 3265 <a class='info' href='#RFC3265'>[6]<span> (</span><span class='info'>Roach, A., &ldquo;Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a> to migrate the
          subscription to the SIP-PBX.
        
</p>
<p>
          When a SIP-PBX  receives a
          registration event subscription addressed to an AOR that
          has been registered  using the bulk
          registration mechanism described in this document, then
          each resulting registration information document
          SHOULD contain an 'aor' attribute in its
          &lt;registration/> element that corresponds to the
          AOR at the SSP. 
        
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
          For example, consider a SIP-PBX that has registered
          with an SSP that has a domain of "ssp.example.com" The
          SIP-PBX used a contact of "sip:198.51.100.3:5060;bnc". 
          After such registration is complete,
          a registration event subscription arriving at the SSP
          with a Request-URI of "sip:+12145550102@ssp.example.com"
          will be re-targeted to the SIP-PBX, with a
          Request-URI of "sip:+12145550102@198.51.100.3:5060".
          The resulting registration document created by the
          SIP-PBX would contain
          a &lt;registration/> element with an "aor" attribute
          of "sip:+12145550102@ssp.example.com".
        
</dd>
</dl></blockquote>

<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>
          This behavior ensures that subscribers
          external to the system (and unaware of GIN procedures)
          will be able to find the relevant information in the
          registration document (since they will be looking
          for the publicly-visible AOR, not the address
          used for sending information from the SSP to the
          SIP-PBX).
        
</dd>
</dl></blockquote>

<p>
          A SIP-PBX that supports both GRUU procedures and
          the registration event packages SHOULD implement
          the extension defined in RFC 5628 <a class='info' href='#RFC5628'>[9]<span> (</span><span class='info'>Kyzivat, P., &ldquo;Registration Event Package Extension for Session Initiation Protocol (SIP) Globally Routable User Agent URIs (GRUUs),&rdquo; October&nbsp;2009.</span><span>)</span></a>.
        
</p>
<a name="outbound"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
Client-Initiated (Outbound) Connections</h3>

<p>
        RFC 5626 <a class='info' href='#RFC5626'>[16]<span> (</span><span class='info'>Jennings, C., Mahy, R., and F. Audet, &ldquo;Managing Client-Initiated Connections in the Session Initiation Protocol (SIP),&rdquo; October&nbsp;2009.</span><span>)</span></a> defines a mechanism
        that allows UAs to establish long-lived TCP connections
        or UDP associations with a proxy in a way that allows
        bidirectional traffic between the proxy and the UA.
        This behavior is particularly important in the presence
        of NATs, and whenever TLS security is required.
        Neither the SSP nor the SIP-PBX is required to support
        client-initiated connections.
      
</p>
<p>
        The outbound mechanism generally works with the
        solution defined in this document without any modifications.
        Implementors should note that the instance ID used
        between the SIP-PBX and the SSP's registrar identifies
        the SIP-PBX itself, and not any of the UAs registered with
        the SIP-PBX. As a consequence, any attempts to use
        caller preferences
        (defined in RFC 3841<a class='info' href='#RFC3841'>[14]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;Caller Preferences for the Session Initiation Protocol (SIP),&rdquo; August&nbsp;2004.</span><span>)</span></a>)
        to target a specific instance are likely to fail. This
        shouldn't be an issue, as the preferred mechanism for
        targeting specific instances of a user agent is GRUU
        (see <a class='info' href='#gruu'>Section&nbsp;7.1<span> (</span><span class='info'>Globally Routable User-Agent URIs (GRUU)</span><span>)</span></a>).
      
</p>
<a name="path"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.4"></a><h3>7.4.&nbsp;
Non-Adjacent Contact Registration (Path) and Service Route Discovery</h3>

<p>
        RFC 3327 <a class='info' href='#RFC3327'>[10]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a> defines a means by which
        a registrar and its associated proxy can be informed of a
        route that is to be used between the proxy and the registered
        user agent. The scope of the route created by a "Path" header
        field is contact-specific; if an AOR has multiple contacts
        associated with it, the routes associated with each contact
        may be different from each other. Support for non-adjacent
        contact registration is required in all SSPs and SIP-PBXes
        implementing the multiple-AOR-registration protocol
        described in this document.
      
</p>
<p>
        At registration time, any proxies between the user agent and
        the registrar may add themselves to the Path. By doing so,
        they request that any requests destined to the user agent
        as a result of the associated registration include them
        as part of the Route towards the User Agent. Although the
        Path mechanism does deliver the final Path value to the
        registering UA, UAs typically ignore the value of the Path.
      
</p>
<p>
        To provide similar functionality in the opposite direction --
        that is, to establish a route for requests sent by a registering
        UA -- RFC 3608 <a class='info' href='#RFC3608'>[11]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Service Route Discovery During Registration,&rdquo; October&nbsp;2003.</span><span>)</span></a> defines a means
        by which a UA can be informed of a route that is to be used by
        the UA to route all outbound requests associated with the
        AOR used in the registration. This information is scoped to the
        AOR within the UA, and is not specific to the Contact (or Contacts)
        in the REGISTER request. 
        Support of service route discovery is optional in SSPs and SIP-PBXes.
      
</p>
<p>
        The registrar unilaterally generates the values of the service
        route using whatever local policy it wishes to apply. Although it
        is common to use the Path and/or Route information in the request
        in composing the Service-Route, registrar behavior is not constrained
        in any way that requires it to do so.
      
</p>
<p>
        In considering the interaction between these mechanisms and the
        registration of multiple AORs in a single request, implementors
        of proxies, registrars, and intermediaries must keep in mind
        the following issues, which stem from the fact that GIN effectively
        registers multiple AORs and multiple Contacts. 
      
</p>
<p>
        First, all location service records that result from expanding a
        single Contact containing a "bnc" parameter will necessarily share
        a single path. Proxies
        will be unable to make policy decisions on a contact-by-contact
        basis regarding whether to include themselves in the path. Second,
        and similarly, all AORs on the SIP-PBX that are registered with a
        common REGISTER request will be forced to share a common
        Service-Route.
      
</p>
<p>
        One interesting technique that Path and Service-Route enable
        is the inclusion of a token or cookie in the user portion of the
        Service-Route or Path entries. This token or cookie may convey
        information to proxies about the identity, capabilities, and/or
        policies associated with the user. Since this information will
        be shared among several AORs and several Contacts when multiple
        AOR registration is employed, care should be taken to ensure that
        doing so is acceptable for all AORs and all Contacts registered
        in a single REGISTER request.
      
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Examples</h3>

<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.1"></a><h3>8.1.&nbsp;
Usage Scenario: Basic Registration</h3>

<p>
        This example shows the message flows for a basic bulk REGISTER
        transaction, followed by an INVITE addressed to one of the
        registered UAs. Example messages are shown after
        the sequence diagram.
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Internet                        SSP                          SIP-PBX
|                                |                                 |
|                                |(1) REGISTER                     |
|                                |Contact:&lt;sip:198.51.100.3;bnc&gt;   |
|                                |&lt;--------------------------------|
|                                |                                 |
|                                |(2) 200 OK                       |
|                                |--------------------------------&gt;|
|                                |                                 |
|(3) INVITE                      |                                 |
|sip:+12145550105@ssp.example.com|                                 |
|-------------------------------&gt;|                                 |
|                                |                                 |
|                                |(4) INVITE                       |
|                                |sip:+12145550105@198.51.100.3    |
|                                |--------------------------------&gt;|
</pre></div><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
(1) The SIP-PBX registers with the SSP for a range of AORs.

REGISTER sip:ssp.example.com SIP/2.0
Via: SIP/2.0/UDP 198.51.100.3:5060;branch=z9hG4bKnashds7
Max-Forwards: 70
To: &lt;sip:pbx@ssp.example.com&gt;
From: &lt;sip:pbx@ssp.example.com&gt;;tag=a23589
Call-ID: 843817637684230@998sdasdh09
CSeq: 1826 REGISTER
Proxy-Require: gin
Require: gin
Supported: path
Contact: &lt;sip:198.51.100.3:5060;bnc&gt;
Expires: 7200
Content-Length: 0
</pre></div><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
(3) The SSP receives a request for an AOR assigned
    to the SIP-PBX.

INVITE sip:+12145550105@ssp.example.com SIP/2.0
Via: SIP/2.0/UDP foo.example;branch=z9hG4bKa0bc7a0131f0ad
Max-Forwards: 69
To: &lt;sip:2145550105@some-other-place.example.net&gt;
From: &lt;sip:gsmith@example.org&gt;;tag=456248
Call-ID: f7aecbfc374d557baf72d6352e1fbcd4
CSeq: 24762 INVITE
Contact: &lt;sip:line-1@192.0.2.178:2081&gt;
Content-Type: application/sdp
Content-Length: ...

&lt;sdp body here&gt;
</pre></div><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
(4) The SSP retargets the incoming request according to the
    information received from the SIP-PBX at registration time.

INVITE sip:+12145550105@198.51.100.3 SIP/2.0
Via: SIP/2.0/UDP foo.example;branch=z9hG4bKa0bc7a0131f0ad
Via: SIP/2.0/UDP ssp.example.com;branch=z9hG4bKa45cd5c52a6dd50
Max-Forwards: 68
To: &lt;sip:2145550105@some-other-place.example.net&gt;
From: &lt;sip:gsmith@example.org&gt;;tag=456248
Call-ID: 7ca24b9679ffe9aff87036a105e30d9b
CSeq: 24762 INVITE
Contact: &lt;sip:line-1@192.0.2.178:2081&gt;
Content-Type: application/sdp
Content-Length: ...

&lt;sdp body here&gt;
</pre></div>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.2"></a><h3>8.2.&nbsp;
Usage Scenario: Using Path to Control Request URI</h3>

<p>
        This example shows a bulk REGISTER transaction with
        the SSP making use of the "Path" header field extension
        <a class='info' href='#RFC3327'>[10]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a>.
        This allows the SSP to designate a domain on the incoming
        Request URI that does not necessarily resolve to the
        SIP-PBX when the SSP applies RFC 3263 procedures to it.
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Internet                        SSP                          SIP-PBX
|                                |                                 |
|                                |(1) REGISTER                     |
|                                |Path:&lt;sip:pbx@198.51.100.3;lr&gt;   |
|                                |Contact:&lt;sip:pbx.example;bnc&gt;    |
|                                |&lt;--------------------------------|
|                                |                                 |
|                                |(2) 200 OK                       |
|                                |--------------------------------&gt;|
|                                |                                 |
|(3) INVITE                      |                                 |
|sip:+12145550105@ssp.example.com|                                 |
|-------------------------------&gt;|                                 |
|                                |                                 |
|                                |(4) INVITE                       |
|                                |sip:+12145550105@pbx.example     |
|                                |Route:&lt;sip:pbx@198.51.100.3;lr&gt;  |
|                                |--------------------------------&gt;|
</pre></div><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
(1) The SIP-PBX registers with the SSP for a range of AORs.
    It includes the form of the URI it expects to receive in the
    Request-URI in its "Contact" header field, and includes
    information that routes to the SIP-PBX in the "Path" header
    field.

REGISTER sip:ssp.example.com SIP/2.0
Via: SIP/2.0/UDP 198.51.100.3:5060;branch=z9hG4bKnashds7
Max-Forwards: 70
To: &lt;sip:pbx@ssp.example.com&gt;
From: &lt;sip:pbx@ssp.example.com&gt;;tag=a23589
Call-ID: 843817637684230@998sdasdh09
CSeq: 1826 REGISTER
Proxy-Require: gin
Require: gin
Supported: path
Path: &lt;sip:pbx@198.51.100.3:5060;lr&gt;
Contact: &lt;sip:pbx.example;bnc&gt;
Expires: 7200
Content-Length: 0
</pre></div><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
(3) The SSP receives a request for an AOR assigned
    to the SIP-PBX.

INVITE sip:+12145550105@ssp.example.com SIP/2.0
Via: SIP/2.0/UDP foo.example;branch=z9hG4bKa0bc7a0131f0ad
Max-Forwards: 69
To: &lt;sip:2145550105@some-other-place.example.net&gt;
From: &lt;sip:gsmith@example.org&gt;;tag=456248
Call-ID: f7aecbfc374d557baf72d6352e1fbcd4
CSeq: 24762 INVITE
Contact: &lt;sip:line-1@192.0.2.178:2081&gt;
Content-Type: application/sdp
Content-Length: ...

&lt;sdp body here&gt;
</pre></div><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
(4) The SSP retargets the incoming request according to the
    information received from the SIP-PBX at registration time.
    Per the normal processing associated with "Path," it
    will insert the "Path" value indicated by the SIP-PBX at
    registration time in a "Route" header field, and
    set the request URI to the registered Contact.

INVITE sip:+12145550105@pbx.example SIP/2.0
Via: SIP/2.0/UDP foo.example;branch=z9hG4bKa0bc7a0131f0ad
Via: SIP/2.0/UDP ssp.example.com;branch=z9hG4bKa45cd5c52a6dd50
Route: &lt;sip:pbx@198.51.100.3:5060;lr&gt;
Max-Forwards: 68
To: &lt;sip:2145550105@some-other-place.example.net&gt;
From: &lt;sip:gsmith@example.org&gt;;tag=456248
Call-ID: 7ca24b9679ffe9aff87036a105e30d9b
CSeq: 24762 INVITE
Contact: &lt;sip:line-1@192.0.2.178:2081&gt;
Content-Type: application/sdp
Content-Length: ...

&lt;sdp body here&gt;
</pre></div>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
IANA Considerations</h3>

<p>
      This document registers a new SIP option tag to indicate support
      for the mechanism it defines, two new SIP URI parameters, and
      a "Contact" header field parameter.
    
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.1"></a><h3>9.1.&nbsp;
New SIP Option Tag</h3>

<p> This section defines a new SIP option tag per the guidelines
      in Section 27.1 of RFC 3261<a class='info' href='#RFC3261'>[4]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.

        </p>
<blockquote class="text"><dl>
<dt>Name:</dt>
<dd>gin
</dd>
<dt>Description:</dt>
<dd> This option tag is used to identify
          the extension that provides Registration for Multiple Phone
          Numbers in SIP. When present in a Require or Proxy-Require
          header field of a REGISTER request, it indicates that support
          for this extension is required of registrars and proxies,
          respectively, that are a party to the registration transaction.
          
</dd>
<dt>Reference:</dt>
<dd>RFCXXXX (this document)
</dd>
</dl></blockquote><p>
      
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.2"></a><h3>9.2.&nbsp;
New SIP URI Parameters</h3>

<p>
        This specification defines two new SIP URI parameters, as per the
        registry created by RFC 3969 <a class='info' href='#RFC3969'>[8]<span> (</span><span class='info'>Camarillo, G., &ldquo;The Internet Assigned Number Authority (IANA) Uniform Resource Identifier (URI) Parameter Registry for the Session Initiation Protocol (SIP),&rdquo; December&nbsp;2004.</span><span>)</span></a>.
      
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.2.1"></a><h3>9.2.1.&nbsp;
'bnc' SIP URI parameter</h3>

<p>
        </p>
<blockquote class="text"><dl>
<dt>Parameter Name:</dt>
<dd>bnc
</dd>
<dt>Predefined Values:</dt>
<dd>No (no values are allowed)
</dd>
<dt>Reference:</dt>
<dd>RFCXXXX (this document)
</dd>
</dl></blockquote><p>
        
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.2.2"></a><h3>9.2.2.&nbsp;
'sg' SIP URI parameter</h3>

<p>
        </p>
<blockquote class="text"><dl>
<dt>Parameter Name:</dt>
<dd>sg
</dd>
<dt>Predefined Values:</dt>
<dd>No
</dd>
<dt>Reference:</dt>
<dd>RFCXXXX (this document)
</dd>
</dl></blockquote><p>
        
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.3"></a><h3>9.3.&nbsp;
New SIP Header Field Parameter</h3>

<p> This section defines a new SIP header field parameter
      per the registry created by RFC3968 <a class='info' href='#RFC3968'>[7]<span> (</span><span class='info'>Camarillo, G., &ldquo;The Internet Assigned Number Authority (IANA) Header Field Parameter Registry for the Session Initiation Protocol (SIP),&rdquo; December&nbsp;2004.</span><span>)</span></a>.
      
</p>
<p>
        </p>
<blockquote class="text"><dl>
<dt>Header field:</dt>
<dd>Contact
</dd>
<dt>Parameter name:</dt>
<dd>temp-gruu-cookie
</dd>
<dt>Predefined values:</dt>
<dd>none
</dd>
<dt>Reference:</dt>
<dd>RFCXXXX (this document)
</dd>
</dl></blockquote><p>
      
</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Security Considerations</h3>

<p>
      The change proposed for the mechanism described
      in this document takes the unprecedented step
      of extending the previously-defined REGISTER
      method to apply to more than one AOR. In general,
      this kind of change has the potential to cause
      problems at intermediaries -- such as proxies --
      that are party to the REGISTER transaction. In
      particular, such intermediaries may attempt to
      apply policy to the user indicated in the
      "To" header field (i.e. the SIP-PBX's identity),
      without any knowledge of the multiple AORs
      that are being implicitly registered.
    
</p>
<p>
      The mechanism defined by this document solves
      this issue by adding an option tag to a
      "Proxy-Require" header in such REGISTER requests.
      Proxies that are unaware of this mechanism will
      not process the requests, preventing them from
      mis-applying policy. Proxies that process
      requests with this option tag are clearly aware
      of the nature of the REGISTER request, and can
      make reasonable policy decisions.
    
</p>
<p>
      As noted in <a class='info' href='#path'>Section&nbsp;7.4<span> (</span><span class='info'>Non-Adjacent Contact Registration (Path) and Service Route Discovery</span><span>)</span></a>, intermediaries
      need to take care if they use a policy token in the Path
      and Service-Route mechanisms, as doing so will cause
      them to apply the same policy to all users serviced
      by the same SIP-PBX. This may frequently be the correct
      behavior, but circumstances can arise in which
      differentiation of user policy is required.
    
</p>
<p>
      One of the key properties of the outbound client connection
      mechanism discussed in <a class='info' href='#outbound'>Section&nbsp;7.3<span> (</span><span class='info'>Client-Initiated (Outbound) Connections</span><span>)</span></a> is assurances
      that a single connection is associated with a single user,
      and cannot be hijacked by other users. With the mechanism
      defined in this document, such connections necessarily
      become shared between users. However, the only entity
      in a position to hijack calls as a consequence is the
      SIP-PBX itself. Because the SIP-PBX acts as a registrar
      for all the potentially affected users, it already has
      the ability to redirect any such communications as it
      sees fit. In other words, the SIP-PBX must be trusted
      to handle calls in an appropriate fashion, and the use of
      the outbound connection mechanism introduces no
      additional vulnerabilities.
    
</p>
<p>
      The ability to learn the identity and registration
      state of every user on the PBX (as described in 
      <a class='info' href='#pbx-reg-event'>Section&nbsp;7.2.1<span> (</span><span class='info'>SIP-PBX Aggregate Registration State</span><span>)</span></a>) is invaluable for
      diagnostic and administrative purposes. For example,
      this allows the SIP-PBX to determine whether all the 
      its extensions are properly registered with the SSP.
      However, this information can also be highly sensitive,
      as many organizations may not wish to make their entire
      list of phone numbers available to external entities.
      Consequently, SSP servers are advised to use explicit
      (i.e. white-list) and configurable policies regarding
      who can access this information, with very conservative
      defaults (e.g., an empty access list or an access list
      consisting only of the PBX itself).
    
</p>
<p>
      The procedure for generation of temporary GRUUs
      requires the use of RSA keys. The selection of
      the proper key length for such keys requires
      careful analysis, taking into consideration the
      current and foreseeable speed of processing for
      the period of time during which GRUUs must remain
      anonymous, as well as emerging cryptographic
      analysis methods. The most recent guidance from
      RSA Laboratories <a class='info' href='#rsa-key-length'>[19]<span> (</span><span class='info'>Kaliski, B., &ldquo;TWIRL and RSA Key Size,&rdquo; May&nbsp;2003.</span><span>)</span></a>
      suggests a key length of 2048 bits for data that
      needs protection through the year 2030, and a
      length of 3072 bits thereafter.
    
</p>
<p>
      Similarly, implementors are warned to take
      precautionary measures to prevent unauthorized
      disclosure of the private key used in GRUU generation.
      Any such disclosure would result in the ability
      to correlate temporary GRUUs to each other, and
      potentially to their associated PBXes.
    
</p>
<p>
      Further, the use of RSA decryption when processing
      GRUUs received from arbitrary parties can be exploited
      by DoS attackers to amplify the impact of an attack:
      because of the presence of a cryptographic operation
      in the processing of such messages, the CPU load may
      be marginally higher when the attacker uses (valid or
      invalid) temporary GRUUs in the messages employed by
      such an attack. Normal DoS mitigation techniques,
      such as rate-limiting processing of received messages,
      should help to reduce the impact of this issue as well.
    
</p>
<p>
      Finally, good security practices should be followed
      regarding the duration an RSA key is used. For implementors,
      this means that systems MUST include an easy way to
      update the public key provided to the SIP-PBX. To avoid
      immediately invalidating all currently issued temporary
      GRUUs, the SSP servers SHOULD keep the retired RSA
      key around for a grace period before discarding it. If
      decryption fails based on the new RSA key, then the SSP
      server can attempt to use the retired key instead. By
      contrast, the SIP-PBXes MUST discard the retired public key
      immediately, and exclusively use the new public key.
    
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Acknowledgements</h3>

<p>
      This document represents the hard work of many people
      in the IETF MARTINI working group and the IETF RAI community
      as a whole.  Particular thanks are owed to John Elwell for
      his requirements analysis of the mechanism described in
      this document, to Dean Willis for his analysis of the
      interaction between this mechanism and the Path and
      Service-Route extensions, to Cullen Jennings
      for his analysis of the interaction between this mechanism
      and the SIP Outbound extension, and to
      to Richard Barnes for his detailed security analysis
      of the GRUU construction algorithm.
      Thanks to Eric
      Rescorla, whose text in the appendix of RFC5627 was lifted directly to
      provide substantial portions of <a class='info' href='#temp-gruu'>Section&nbsp;7.1.2<span> (</span><span class='info'>Temporary GRUUs</span><span>)</span></a>.

      Finally, thanks to 
      Bernard Aboba,
      Francois Audet,
      John Elwell,
      David Hancock,
      Martien Huysmans,
      Cullen Jennings,
      Alan Johnston,
      Hadriel Kaplan,
      and Paul Kyzivat
      for their careful reviews
      of and constructive feedback on this document.
    
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2045">[1]</a></td>
<td class="author-text"><a href="mailto:ned@innosoft.com">Freed, N.</a> and <a href="mailto:nsb@nsb.fv.com">N. Borenstein</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2045">Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies</a>,&rdquo; RFC&nbsp;2045, November&nbsp;1996 (<a href="http://www.rfc-editor.org/rfc/rfc2045.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2104">[2]</a></td>
<td class="author-text"><a href="mailto:hugo@watson.ibm.com">Krawczyk, H.</a>, <a href="mailto:mihir@cs.ucsd.edu">Bellare, M.</a>, and <a href="mailto:canetti@watson.ibm.com">R. Canetti</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>,&rdquo; RFC&nbsp;2104, February&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2104.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[3]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3261">[4]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3263">[5]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3263">Session Initiation Protocol (SIP): Locating SIP Servers</a>,&rdquo; RFC&nbsp;3263, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3263.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3265">[6]</a></td>
<td class="author-text">Roach, A., &ldquo;<a href="http://tools.ietf.org/html/rfc3265">Session Initiation Protocol (SIP)-Specific Event Notification</a>,&rdquo; RFC&nbsp;3265, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3265.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3968">[7]</a></td>
<td class="author-text">Camarillo, G., &ldquo;<a href="http://tools.ietf.org/html/rfc3968">The Internet Assigned Number Authority (IANA) Header Field Parameter Registry for the Session Initiation Protocol (SIP)</a>,&rdquo; BCP&nbsp;98, RFC&nbsp;3968, December&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3968.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3969">[8]</a></td>
<td class="author-text">Camarillo, G., &ldquo;<a href="http://tools.ietf.org/html/rfc3969">The Internet Assigned Number Authority (IANA) Uniform Resource Identifier (URI) Parameter Registry for the Session Initiation Protocol (SIP)</a>,&rdquo; BCP&nbsp;99, RFC&nbsp;3969, December&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3969.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5628">[9]</a></td>
<td class="author-text">Kyzivat, P., &ldquo;<a href="http://tools.ietf.org/html/rfc5628">Registration Event Package Extension for Session Initiation Protocol (SIP) Globally Routable User Agent URIs (GRUUs)</a>,&rdquo; RFC&nbsp;5628, October&nbsp;2009 (<a href="http://www.rfc-editor.org/rfc/rfc5628.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC3327">[10]</a></td>
<td class="author-text">Willis, D. and B. Hoeneisen, &ldquo;<a href="http://tools.ietf.org/html/rfc3327">Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts</a>,&rdquo; RFC&nbsp;3327, December&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3327.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3608">[11]</a></td>
<td class="author-text">Willis, D. and B. Hoeneisen, &ldquo;<a href="http://tools.ietf.org/html/rfc3608">Session Initiation Protocol (SIP) Extension Header Field for Service Route Discovery During Registration</a>,&rdquo; RFC&nbsp;3608, October&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3608.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3680">[12]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc3680">A Session Initiation Protocol (SIP) Event Package for Registrations</a>,&rdquo; RFC&nbsp;3680, March&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3680.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3840">[13]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;<a href="http://tools.ietf.org/html/rfc3840">Indicating User Agent Capabilities in the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3840, August&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3840.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3841">[14]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., and P. Kyzivat, &ldquo;<a href="http://tools.ietf.org/html/rfc3841">Caller Preferences for the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;3841, August&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3841.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4475">[15]</a></td>
<td class="author-text">Sparks, R., Hawrylyshen, A., Johnston, A., Rosenberg, J., and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc4475">Session Initiation Protocol (SIP) Torture Test Messages</a>,&rdquo; RFC&nbsp;4475, May&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4475.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5626">[16]</a></td>
<td class="author-text">Jennings, C., Mahy, R., and F. Audet, &ldquo;<a href="http://tools.ietf.org/html/rfc5626">Managing Client-Initiated Connections in the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;5626, October&nbsp;2009 (<a href="http://www.rfc-editor.org/rfc/rfc5626.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5627">[17]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc5627">Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;5627, October&nbsp;2009 (<a href="http://www.rfc-editor.org/rfc/rfc5627.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5947">[18]</a></td>
<td class="author-text">Elwell, J. and H. Kaplan, &ldquo;<a href="http://tools.ietf.org/html/rfc5947">Requirements for Multiple Address of Record (AOR) Reachability Information in the Session Initiation Protocol (SIP)</a>,&rdquo; RFC&nbsp;5947, September&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5947.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="rsa-key-length">[19]</a></td>
<td class="author-text">Kaliski, B., &ldquo;<a href="http://www.rsa.com/rsalabs/node.asp?id=2004">TWIRL and RSA Key Size</a>,&rdquo; May&nbsp;2003.</td></tr>
</table>

<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Requirements Analysis</h3>

<p>
      The document "Requirements for multiple address of record
      (AOR) reachability information in the Session Initiation
      Protocol (SIP)" <a class='info' href='#RFC5947'>[18]<span> (</span><span class='info'>Elwell, J. and H. Kaplan, &ldquo;Requirements for Multiple Address of Record (AOR) Reachability Information in the Session Initiation Protocol (SIP),&rdquo; September&nbsp;2010.</span><span>)</span></a>
      contains a list of requirements and desired properties for a
      mechanism to register multiple AORs with a single SIP
      transaction.  This section evaluates those requirements against
      the mechanism described in this document.
    
</p>
<p>REQ1 - The mechanism MUST allow a SIP-PBX to enter into a trunking arrangement with an SSP whereby the two parties have agreed on a set of telephone numbers deemed to have been assigned to the SIP-PBX.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied.
</p>
</blockquote>

<p>REQ2 - The mechanism MUST allow a set of assigned telephone numbers to comprise E.164 numbers, which can be in contiguous ranges, discrete, or in any combination of the two.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied; the DIDs associated with a registration is established by bilateral agreement between the SSP and the SIP-PBX, and is not part of the mechanism described in this document.
</p>
</blockquote>

<p>REQ3 - The mechanism MUST allow a SIP-PBX to register reachability information with its SSP, in order to enable the SSP to route to the SIP-PBX inbound requests targeted at assigned telephone numbers.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied.
</p>
</blockquote>

<p>REQ4 - The mechanism MUST allow UAs attached to a SIP-PBX to register
    with the SIP-PBX for AORs based on assigned telephone numbers, in
    order to receive requests targeted at those telephone numbers,
    without needing to involve the SSP in the registration process.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied; in the presumed architecture, SIP-PBX UAs register with the SIP-PBX, an require no interaction with the SSP.
</p>
</blockquote>

<p>REQ5 - The mechanism MUST allow a SIP-PBX to handle requests
    originating at its own UAs and targeted at its assigned telephone
    numbers, without routing those requests to the SSP.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied; SIP-PBXes may recognize their own DID and their own GRUUs, and perform on-SIP-PBX routing without sending the requests to the SSP.
</p>
</blockquote>

<p>REQ6 - The mechanism MUST allow a SIP-PBX to receive requests to its assigned telephone numbers originating outside the SIP-PBX and arriving via the SSP, so that the SIP-PBX can route those requests onwards to its UAs, as it would for internal requests to those telephone numbers.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied
</p>
</blockquote>

<p>REQ7 - The mechanism MUST provide a means whereby a SIP-PBX knows which of its assigned telephone numbers an inbound request from its SSP is targeted at.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied. For ordinary calls and calls using Public GRUUs, the DID is indicated in the user portion of the Request-URI. For calls using Temp GRUUs constructed with the mechanism described in <a class='info' href='#temp-gruu'>Section&nbsp;7.1.2<span> (</span><span class='info'>Temporary GRUUs</span><span>)</span></a>, the "gr" parameter provides a correlation token the SIP-PBX can use to identify which UA the call should be routed to.
</p>
</blockquote>

<p>REQ8 - The mechanism MUST provide a means of avoiding problems due to one side using the mechanism and the other side not.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied through the 'gin' option tag and the 'bnc' Contact parameter.
</p>
</blockquote>

<p>REQ9 - The mechanism MUST observe SIP backwards compatibility principles.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied through the 'gin' option tag.
</p>
</blockquote>

<p>REQ10 - The mechanism MUST work in the presence of a sequence of
    intermediate SIP entities on the SIP-PBX-to-SSP interface (i.e.,
    between the SIP-PBX and the SSP's domain proxy), where those
    intermediate SIP entities indicated during registration a need to be
    on the path of inbound requests to the SIP-PBX.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied through the use of the Path mechanism defined in RFC 3327 <a class='info' href='#RFC3327'>[10]<span> (</span><span class='info'>Willis, D. and B. Hoeneisen, &ldquo;Session Initiation Protocol (SIP) Extension Header Field for Registering Non-Adjacent Contacts,&rdquo; December&nbsp;2002.</span><span>)</span></a> 
</p>
</blockquote>

<p>REQ11 - The mechanism MUST work when a SIP-PBX obtains its IP address dynamically.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied by allowing the SIP-PBX to use an IP address in the Bulk Number Contact URI contained in a REGISTER Contact header field.
</p>
</blockquote>

<p>REQ12 - The mechanism MUST work without requiring the SIP-PBX to have a domain name or the ability to publish its domain name in the DNS.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied by allowing the SIP-PBX to use an IP address in the Bulk Number Contact URI contained in a REGISTER Contact header field.
</p>
</blockquote>

<p>REQ13 - For a given SIP-PBX and its SSP, there MUST be no impact on other domains, which are expected to be able to use normal RFC 3263 procedures to route requests, including requests needing to be routed via the SSP in order to reach the SIP-PBX.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied by allowing the domain name in the Request URI used by external entities to resolve to the SSP's servers via normal RFC 3263 resolution procedures.
</p>
</blockquote>

<p>REQ14 - The mechanism MUST be able to operate over a transport that
    provides end-to-end integrity protection and confidentiality between
    the SIP-PBX and the SSP, e.g., using TLS as specified in 
    <a class='info' href='#RFC3261'>[4]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied; nothing in the proposed mechanism prevent the use of TLS between the SSP and the SIP-PBX.
</p>
</blockquote>

<p>REQ15 - The mechanism MUST support authentication of the SIP-PBX by
    the SSP and vice versa, e.g., using SIP digest authentication plus
    TLS server authentication as specified in <a class='info' href='#RFC3261'>[4]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied; SIP-PBXes may employ either SIP digest authentication or mutually-authenticated TLS for authentication purposes.
</p>
</blockquote>

<p>REQ16 - The mechanism MUST allow the SIP-PBX to provide its UAs with public or temporary Globally Routable UA URIs (GRUUs) <a class='info' href='#RFC5627'>[17]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Obtaining and Using Globally Routable User Agent URIs (GRUUs) in the Session Initiation Protocol (SIP),&rdquo; October&nbsp;2009.</span><span>)</span></a>.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied via the mechanisms detailed in <a class='info' href='#gruu'>Section&nbsp;7.1<span> (</span><span class='info'>Globally Routable User-Agent URIs (GRUU)</span><span>)</span></a>.
</p>
</blockquote>

<p>REQ17 - The mechanism MUST work over any existing transport specified for SIP, including UDP.
</p>
<p></p>
<blockquote class="text">
<p>The requirement is satisfied to the extent that UDP can be used for REGISTER requests in general. The application of certain extensions and/or network topologies may exceed UDP MTU sizes, but such issues arise both with and without the mechanism described in this document. This document does not exacerbate such issues.
</p>
</blockquote>

<p>DES1 - The mechanism SHOULD allow an SSP to exploit its mechanisms for providing SIP service to ordinary subscribers in order to provide a SIP trunking service to SIP-PBXes.
</p>
<p></p>
<blockquote class="text">
<p>The desired property is satisfied; the routing mechanism described in this document is identical to the routing performed for singly-registered AORs.
</p>
</blockquote>

<p>DES2 - The mechanism SHOULD scale to SIP-PBX's of several thousand assigned telephone numbers.
</p>
<p></p>
<blockquote class="text">
<p>The desired property is satisfied; nothing in this document precludes DID pools of arbitrary size.
</p>
</blockquote>

<p>DES3 - The mechanism SHOULD scale to support several thousand SIP-PBX's on a single SSP.
</p>
<p></p>
<blockquote class="text">
<p>The desired property is satisfied; nothing in this document precludes an arbitrary number of SIP-PBXes from attaching to a single SSP.
</p>
</blockquote>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Adam Roach</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tekelec</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">17210 Campbell Rd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Suite 250</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dallas, TX  75252</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:adam@nostrum.com">adam@nostrum.com</a></td></tr>
</table>
</body></html>
