<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>IPv6 Tunnel Broker with the Tunnel Setup Protocol (TSP)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="IPv6 Tunnel Broker with the Tunnel Setup Protocol (TSP)">
<meta name="keywords" content="IPv6, Tunnel, Transition, TSP">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">M. Blanchet</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Viagenie</td></tr>
<tr><td class="header">Intended status: Experimental</td><td class="header">F. Parent</td></tr>
<tr><td class="header">Expires: November 8, 2008</td><td class="header">Beon Solutions</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">May 07, 2008</td></tr>
</table></td></tr></table>
<h1><br />IPv6 Tunnel Broker with the Tunnel Setup Protocol (TSP)<br />draft-blanchet-v6ops-tunnelbroker-tsp-04</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on November 8, 2008.</p>

<h3>Abstract</h3>

<p>
A tunnel broker with the Tunnel Setup Protocol (TSP) enables the
establishment of tunnels of various inner protocols, such as IPv6 or
IPv4, inside various outer protocols packets, such as IPv4, IPv6 or
UDP over IPv4 for IPv4 NAT traversal. The control protocol (TSP) is
used by the tunnel client to negotiate the tunnel with the broker.  A
mobile node implementing TSP can be connected to both IPv4 and IPv6
networks whether it is on IPv4 only, IPv4 behind a NAT or on IPv6
only.  A tunnel broker may terminate the tunnels on remote tunnel
servers or on itself.  This document describes the TSP protocol within
the model of the tunnel broker model.

</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Description of the TSP framework<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">2.1.</a>&nbsp;
NAT Discovery<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">2.2.</a>&nbsp;
Any encapsulation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">2.3.</a>&nbsp;
Mobility<br />
<a href="#anchor6">3.</a>&nbsp;
Advantages of TSP<br />
<a href="#anchor7">4.</a>&nbsp;
Protocol Description<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">4.1.</a>&nbsp;
Terminology<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">4.2.</a>&nbsp;
Topology<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">4.3.</a>&nbsp;
Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">4.4.</a>&nbsp;
TSP signaling<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">4.4.1.</a>&nbsp;
Signaling transport<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">4.4.2.</a>&nbsp;
Authentication phase<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#cmd_response_phase">4.4.3.</a>&nbsp;
Command and response phase<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">4.5.</a>&nbsp;
Tunnel establishment<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">4.5.1.</a>&nbsp;
IPv6-over-IPv4 tunnels<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#v6udpv4_establishment">4.5.2.</a>&nbsp;
IPv6-over-UDP tunnels<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#keepalive">4.6.</a>&nbsp;
Tunnel Keep-alive<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">4.7.</a>&nbsp;
XML Messaging<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">4.7.1.</a>&nbsp;
Tunnel<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">4.7.2.</a>&nbsp;
Client Element<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor20">4.7.3.</a>&nbsp;
Server Element<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">4.7.4.</a>&nbsp;
Broker Element<br />
<a href="#anchor22">5.</a>&nbsp;
Tunnel request examples<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor23">5.1.</a>&nbsp;
Host tunnel request and reply<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">5.2.</a>&nbsp;
Router Tunnel request with a /48 prefix delegation, and reply<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">5.3.</a>&nbsp;
IPv4 over IPv6 tunnel request<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor26">5.4.</a>&nbsp;
NAT Traversal tunnel request<br />
<a href="#anchor27">6.</a>&nbsp;
Applicability of TSP in Different Networks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor28">6.1.</a>&nbsp;
Provider Networks with Enterprise Customers<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor29">6.2.</a>&nbsp;
Provider Networks with Home/Small Office Customers<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor30">6.3.</a>&nbsp;
Enterprise Networks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor31">6.4.</a>&nbsp;
Wireless Networks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor32">6.5.</a>&nbsp;
Unmanaged networks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor33">6.6.</a>&nbsp;
Mobile Hosts and Mobile Networks<br />
<a href="#IANA">7.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor34">8.</a>&nbsp;
Security Considerations<br />
<a href="#anchor35">9.</a>&nbsp;
Conclusion<br />
<a href="#anchor36">10.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">11.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">11.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">11.2.</a>&nbsp;
Informative References<br />
<a href="#DTD_section">Appendix&nbsp;A.</a>&nbsp;
The TSP DTD<br />
<a href="#anchor39">Appendix&nbsp;B.</a>&nbsp;
Error codes<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>
This document first describes the TSP framework, the protocol details,
and the different profiles used. It then describes the applicability
of TSP in different environments, some of which were described in the
v6ops scenario documents.
    
</p>
<p>
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.

</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Description of the TSP framework</h3>

<p>
Tunnel Setup Protocol (TSP) is a signaling protocol to setup tunnel
parameters between two tunnel end-points. TSP is implemented as a tiny
client code in the requesting tunnel end-point.  The other end-point
is the server that will setup the tunnel service. TSP uses XML <a class='info' href='#W3C.REC-xml-20040204'>[W3C.REC&#8209;xml&#8209;20040204]<span> (</span><span class='info'>Yergeau, F., Paoli, J., Sperberg-McQueen, C., Bray, T., and E. Maler, &ldquo;Extensible Markup Language (XML) 1.0 (Third Edition),&rdquo; February&nbsp;2004.</span><span>)</span></a> basic messaging over TCP or UDP.
The use of XML gives extensibility and easy option processing.

</p>
<p>
TSP negotiates tunnel parameters between the two tunnel
end-points. Parameters that are always negociated are:

</p>
<p>
  </p>
<ul class="text">
<li>
authentication of the users, using any kind of authentication
mechanism (through SASL <a class='info' href='#RFC4422'>[RFC4422]<span> (</span><span class='info'>Melnikov, A. and K. Zeilenga, &ldquo;Simple Authentication and Security Layer (SASL),&rdquo; June&nbsp;2006.</span><span>)</span></a>) including
anonymous

</li>
<li>Tunnel encapsulation

<ul class="text">
<li>
    IPv6 over IPv4 tunnels <a class='info' href='#RFC4213'>[RFC4213]<span> (</span><span class='info'>Nordmark, E. and R. Gilligan, &ldquo;Basic Transition Mechanisms for IPv6 Hosts and Routers,&rdquo; October&nbsp;2005.</span><span>)</span></a>
  
</li>
<li>
    IPv4 over IPv6 tunnels <a class='info' href='#RFC2473'>[RFC2473]<span> (</span><span class='info'>Conta, A. and S. Deering, &ldquo;Generic Packet Tunneling in IPv6 Specification,&rdquo; December&nbsp;1998.</span><span>)</span></a>
  
</li>
<li>
    IPv6 over UDP-IPv4 tunnels for NAT traversal
  
</li>
</ul>

</li>
<li>
  IP address assignment for the tunnel endpoints

</li>
<li>
DNS registration of the IP end point address (AAAA)

</li>
</ul><p>

<p>
  Other tunnel parameters that may be negotiated are:

</p>
  
<ul class="text">
<li>
Tunnel keep-alive

</li>
<li>
IPv6 prefix assignment when the client is a router

</li>
<li>
DNS delegation of the inverse tree, based on the IPv6 prefix assigned

</li>
<li>
Routing protocols

</li>
</ul><p>

</p>
<p>
The tunnel encapsulation can be explicitly specified by the client, or
can be determined during the TSP exchange by the broker. The latter is used to
detect the presence of NAT in the path and select IPv6 over UDP-IPv4
encapsulation.

</p>
<p>
The TSP connection can be established between two nodes, where each
node can control a tunnel end-point.  

</p>
<p>
The nodes involved in the framework are:

</p>
<ol class="text">
<li>the TSP client
</li>
<li>client tunnel end-point
</li>
<li>the TSP server
</li>
<li>server tunnel end-point
</li>
</ol><p>

1,3 and 4 form the tunnel broker model <a class='info' href='#RFC3053'>[RFC3053]<span> (</span><span class='info'>Durand, A., Fasano, P., Guardini, I., and D. Lento, &ldquo;IPv6 Tunnel Broker,&rdquo; January&nbsp;2001.</span><span>)</span></a>,
where 3 is the tunnel broker and 4 is the tunnel server (<a class='info' href='#Broker_Model'>Figure&nbsp;1<span> (</span><span class='info'>Tunnel Setup Protocol used on Tunnel Broker model</span><span>)</span></a>). The tunnel broker may control one or many
tunnel servers. 
</p>
<p>
In its simplest model, one node is the client configured as a tunnel
end-point (1 and 2 on same node), and the second node is the server
configured as the other tunnel end-point (3 and 4 on same node). This
model is shown in
<a class='info' href='#Server_Model'>Figure&nbsp;2<span> (</span><span class='info'>Tunnel Setup Protocol used on Tunnel Server model</span><span>)</span></a>

</p><br /><hr class="insert" />
<a name="Broker_Model"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                           _______________
                          | TUNNEL BROKER |--&gt; Databases (DNS)
                          |               |
                          |  TSP          |
                          | SERVER        |
                          |_______________|
                              |     |
         __________           |     |          ________
        |           |         |     |         |        |
        |   TSP     |--[TSP]--      +---------|        |
        |  CLIENT   |                         | TUNNEL |--[NETWORK]--
[HOST]--|           |&lt;==[CONFIGURED TUNNEL]==&gt;| SERVER |
        |___________|                         |        |
                                              |________|
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Tunnel Setup Protocol used on Tunnel Broker model&nbsp;</b></font><br /></td></tr></table><hr class="insert" />
<br /><hr class="insert" />
<a name="Server_Model"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
         ___________                           ________
        |           |                         |  TSP   |
        |   TSP     |-----------[TSP]---------| SERVER |
        |  CLIENT   |                         |        |--[NETWORK]--
[HOST]--|           |&lt;==[CONFIGURED TUNNEL]==&gt;| TUNNEL |
        |___________|                         | SERVER |
                                              |________|
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Tunnel Setup Protocol used on Tunnel Server model&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
From the point of view of an operating system, TSP is implemented as a
client application which is able to configure network parameters of
the operating system.

</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
NAT Discovery</h3>

<p>
TSP is also used to discover if a NAT is in the path. In this
discovery mode, the client sends a TSP message over UDP, containing
its tunnel request information (such as its source IPv4 address) to
the TSP server. The TSP server compares the IPv4 source address of the
packet with the address in the TSP message. If they differ, one or
many IPv4 NAT is in the path.

</p>
<p>
If an IPv4 NAT is discovered, then IPv6 over UDP-IPv4 tunnel encapsulation is
selected. Once the TSP signaling is done, the tunnel is established over the
same UDP channel used for TSP, so the same NAT address-port mapping is used
for both the TSP session and the IPv6 traffic.  If no IPv4 NAT is detected in
the path by the TSP server, then IPv6 over IPv4 encapsulation is used.

</p>
<p>A keep-alive mechanism is also included to keep the NAT
mapping active.
</p>
<p>The IPv4 NAT discovery builds the most effective tunnel for all
cases, including in a dynamic situation where the client moves.

</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Any encapsulation</h3>

<p>
TSP is used to negotiate IPv6 over IPv4 tunnels, IPv6 over UDP-IPv4
tunnels and IPv4 over IPv6 tunnels.  IPv4 over IPv6 tunnels are used
in the Dual Stack Transition Mechanism (DSTM) together with TSP <a class='info' href='#I-D.bound-dstm-exp'>[I&#8209;D.bound&#8209;dstm&#8209;exp]<span> (</span><span class='info'>Bound, J., Toutain, L., and JL. Richier, &ldquo;Dual Stack IPv6 Dominant Transition Mechanism,&rdquo; October&nbsp;2005.</span><span>)</span></a>.

</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
Mobility</h3>

<p>
When a node moves to a different IP network (i.e. change of its IPv4
address when doing IPv6 over IPv4 encapsulation), the TSP client
reconnects automatically to the broker to re-establish the tunnel
(keep-alive mechanism). On the IPv6 layer, if the client uses user
authentication, the same IPv6 address and prefix are kept and
re-established, even if the IPv4 address or tunnel encapsulation type
changes.

</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Advantages of TSP</h3>

<p>
        </p>
<ul class="text">
<li>
Tunnels established by TSP are static tunnels, which are more secure
than automated tunnels (<a class='info' href='#RFC3964'>[RFC3964]<span> (</span><span class='info'>Savola, P. and C. Patel, &ldquo;Security Considerations for 6to4,&rdquo; December&nbsp;2004.</span><span>)</span></a>). No 3rd party relay
required.
          
</li>
<li>
Stability of the IP address and prefix, enabling applications needing
stable address to be deployed and used. For example, when tunneling
IPv6, there is no dependency on the underlying IPv4 address.

</li>
<li>
Prefix assignment supported. Can use provider address space.

</li>
<li>
Signaling protocol flexible and extensible (XML, SASL)
          
</li>
<li>
One solution to many encapsulation techniques: v6 in v4, v4 in v6, v6
over UDP over v4. Can be extended to other encapsulation types, such
as v6 in v6.

</li>
<li>
Discovery of IPv4 NAT in the path, establishing the most optimized
tunnelling technique depending on the discovery.

</li>
</ul><p>

</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Protocol Description</h3>

<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Terminology</h3>

<p>
</p>
<blockquote class="text"><dl>
<dt>Tunnel Broker (TB):</dt>
<dd>
In a tunnel broker model, the broker is taking charge of all
communication between tunnel servers (TS) and tunnel clients
(TC). Tunnel clients query brokers for a tunnel and the broker finds a
suitable tunnel server, asks the Tunnel server to setup the tunnel and
sends the tunnel information to the Tunnel Client.

</dd>
<dt>Tunnel Server (TS):</dt>
<dd>
Tunnel Servers are providing the specific tunnel service to a Tunnel
Client. It can receive the tunnel request from a Tunnel Broker (as in
the Tunnel Broker model) or directly from the Tunnel Client. The
Tunnel Server is the tunnel end-point.

</dd>
<dt>Tunnel Client (TC):</dt>
<dd>
The tunnel client is the entity that needs a tunnel for a particular
service or connectivity. A tunnel client can be either a host or a
router. The tunnel client is the other tunnel end-point.

</dd>
<dt>v6v4:</dt>
<dd>
  IPv6-over-IPv4 tunnel encapsulation

</dd>
<dt>v6udpv4:</dt>
<dd>
  IPv6-over-UDP-over-IPv4 tunnel encapsulation

</dd>
<dt>v4v6:</dt>
<dd>
  IPv4-over-IPv6 tunnel encapsulation

</dd>
</dl></blockquote><p>

</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Topology</h3>

<p>
The following diagrams describe typical TSP scenarios. The goal is to establish
a tunnel between Tunnel client and Tunnel server.

</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Overview</h3>

<p>
  The Tunnel Setup Protocol is initiated from a client node to a
  tunnel broker. The Tunnel Setup Protocol has three phases:

</p>
<p>  
  </p>
<blockquote class="text"><dl>
<dt>Authentication phase:</dt>
<dd>
      The Authentication phase is when the tunnel broker/server
      advertises its capability to a tunnel client and when a tunnel
      client authenticate to the broker/server.
    
</dd>
<dt>Command phase:</dt>
<dd>
      The command phase is where the client requests or updates a
      tunnel.
    
</dd>
<dt>Response phase:</dt>
<dd>
      The response phase is where the tunnel client receives the
      request response from the tunnel broker/server, and the client
      accepts or rejects the tunnel offered.
    
</dd>
</dl></blockquote><p>

</p>
<p>
For each command sent by a Tunnel Client there is an expected response
by the server.

</p>
<p>
After the response phase is completed, a tunnel is established as
requested by the client. If requested, periodic keep-alive packets can
be sent from the client to the server.
          
</p><br /><hr class="insert" />
<a name="Message_sequence"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
        tunnel                              tunnel
        client                              broker
          +|         Send version              +
          ||---------------------------------&gt; ||
          ||         Send capabilities         ||
          ||&lt;--------------------------------- +| Authentication
          ||         SASL authentication       || phase
          ||&lt;--------------------------------&gt; ||
 TSP      ||         Authentication OK         ||
 signaling||&lt;--------------------------------- +
          ||         Tunnel request            || Command
          ||---------------------------------&gt; || phase
          ||         Tunnel response           +
          ||&lt;--------------------------------- || Response
          ||         Tunnel acknowledge        || phase
          ||---------------------------------&gt; +
          +|                                   |
          ||         Tunnel established        |
 Data     ||===================================|
 phase    ||                                   |
          +|           (keep-alive)            |



</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Tunnel Setup Protocol exchange&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
TSP signaling</h3>

<p>
  The following sections describes in detail the TSP protocol and the
  different phases in the TSP signaling.

</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4.1"></a><h3>4.4.1.&nbsp;
Signaling transport</h3>

<p>
  TSP signaling can be transported over TCP or UDP, and over IPv4 or
  IPv6. The tunnel client selects the transport according to the
  tunnel encapsulation to be requested. <a class='info' href='#TSP_transport_table'>Figure&nbsp;4<span> (</span><span class='info'>TSP signaling transport</span><span>)</span></a> shows the transport used for TSP
  signaling with possible tunnel encapsulation requested. 

</p>
<p>
TSP signaling over UDP/v4 MUST be used if a v6 over UDP over IPv4
(v6udpv4) tunnel is to be requested (e.g., for NAT traversal).

</p>
<p>


          <br /><hr class="insert" />
<a name="TSP_transport_table"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    Tunnel
    Encapsulation   Valid       Valid
    Requested       Transport   Address family
    ------------------------------------------
    v6anyv4         TCP UDP     IPv4
    v6v4            TCP UDP     IPv4
    v6udpv4             UDP     IPv4
    v4v6            TCP UDP     IPv6

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: TSP signaling transport&nbsp;</b></font><br /></td></tr></table><hr class="insert" />



</p>
<p>
  Note that the TSP framework allows for other type of encapsulation
  to be defined, such as IPv6 over GRE or IPv6 over IPv6.

</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4.1.1"></a><h3>4.4.1.1.&nbsp;
TSP signaling over TCP</h3>

<p>
  TSP over TCP is sent over port number 3653 (IANA assigned). TSP
  data used during signaling is detailed in the next sections.

<br /><hr class="insert" />
<a name="TCP_control_phase_packet"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                   +------+-----------+----------+
                   |  IP  | TCP       | TSP data |
                   |      | port 3653 |          |
                   +------+-----------+----------+
                   where IP is IPv4 or IPv6
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: Tunnel Setup Protocol packet format (TCP)&nbsp;</b></font><br /></td></tr></table><hr class="insert" />



</p>
<a name="udpv4_signaling"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4.1.2"></a><h3>4.4.1.2.&nbsp;
TSP signaling over UDP/v4</h3>

<p>
  While TCP provides the connection-oriented and reliable data
  delivery features required during the TSP signaling session, UDP
  does not offer any reliability. This reliability is added inside the
  TSP session as an extra header at the beginning of the UDP payload.


<br /><hr class="insert" />
<a name="UDP_control_phase_packet"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                +------+-----------+------------+----------+
                | IPv4 | UDP       | TSP header | TSP data |
                |      | port 3653 |            |          |
                +------+-----------+------------+----------+
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: Tunnel Setup Protocol packet format (UDP)&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


</p>
<p>

The algorithm used to add reliability to TSP packets sent over UDP is
described in section 22.5 in <a class='info' href='#UNP'>[UNP]<span> (</span><span class='info'>Stevens, R., Fenner, B., and A. Rudoff, &ldquo;Unix Network Programming, 3rd edition,&rdquo; 2004.</span><span>)</span></a>.
  
<br /><hr class="insert" />
<a name="TSP_header"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

   0                   1                   2                   3
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |  0xF  |                 Sequence Number                       |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |                            Timestamp                          |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |                            TSP data                           |
  ...

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;7: TSP header for reliable UDP&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


</p>
<blockquote class="text"><dl>
<dt></dt>
<dd>The four bit field (0-3) is set to 0xF. This marker is used by
  the tunnel broker to identify a TSP signaling packets that is sent
  after an IPv6 over UDP is established. This is explained in section
  <a class='info' href='#v6udpv4_establishment'>Section&nbsp;4.5.2<span> (</span><span class='info'>IPv6-over-UDP tunnels</span><span>)</span></a> 
</dd>
<dt>Sequence Number:</dt>
<dd>
    28 bit field. Set by the tunnel client. Value is increased by one for
    every new packet sent to the tunnel broker. The return packet from
    the broker contains the unaltered sequence number.
</dd>
<dt>Timestamp:</dt>
<dd>
    32 bit field. Set by the tunnel client. Generated from the client
    local time value. The return packet from the broker contains the
    unaltered timestamp.
  
</dd>
<dt>TSP data:</dt>
<dd>
    Same as in the TCP/v4 case. Content described in latter sections.
  
</dd>
</dl></blockquote><p>


</p>
<p>
  The TSP client builds its UDP packet as described above and sends it
  to the tunnel broker. When the tunnel broker responds, the same
  values for the sequence number and timestamp MUST be sent back to
  the client. The TSP client can use the timestamp to determine the
  retransmission timeout (current time minus the packet
  timestamp). The client SHOULD retransmit the packet when the
  retransmission timeout is reached. The retransmitted packet MUST use
  the same sequence number as the original packet so that the server
  can detect duplicate packets. The client SHOULD use exponential
  backoff when retransmitting packets to avoid network congestion.

</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4.2"></a><h3>4.4.2.&nbsp;
Authentication phase</h3>

<p>
    The authentication phase has 3 steps :
  
</p>
<p>
              </p>
<ul class="text">
<li>Client's protocol version identification
</li>
<li>Server's capability advertisement
</li>
<li>Client authentication
</li>
</ul><p>
            
</p>
<p>
              When a TCP or UDP session is established to a tunnel
              broker, the tunnel client sends the current protocol
              version it is supporting.  The version number syntax is:
            
</p>
<p>
              </p>
<blockquote class="text">
<p> VERSION=2.0.0 CR LF
</p>
</blockquote><p>  
            
</p>
<p>
Version 2.0.0 is the version number of this specification. Version 1.0.0 was
defined in earlier drafts.
<br />
<br />

If the server doesn't support the protocol version it sends an error message
and closes the session. The server can optionally send a server list that may
support the protocol version of the client.
            
</p><br /><hr class="insert" />
<a name="NotSupported_1"></a>

<p>Example of an unsupported client version (without a server list)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      -- Successful TCP Connection --
      C:VERSION=0.1 CR LF
      S:302 Unsupported client version CR LF
      -- Connection closed --
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;8: Example of unsupported client version&nbsp;</b></font><br /></td></tr></table><hr class="insert" />
<br /><hr class="insert" />
<a name="NotSupported_2"></a>

<p>Example of a version not supported (with a server list)
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      -- Successful TCP Connection --
      C:VERSION=1.1 CR LF
      S:1302 Unsupported client version CR LF
        &lt;tunnel action="list" type="broker"&gt;
           &lt;broker&gt;
              &lt;address type="ipv4"&gt;1.2.3.4&lt;/address&gt;
           &lt;/broker&gt;
           &lt;broker&gt;
              &lt;address type="dn"&gt;ts1.isp1.com&lt;/address&gt;
           &lt;/broker&gt;
        &lt;/tunnel&gt;
      -- Connection closed --
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;9: Example of unsupported client version, with server redirection&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
If the server supports the version sent by the client, then the server sends a
list of the capabilities supported for authentication and tunnels.
            
</p>
<p>
              </p>
<blockquote class="text">
<p>CAPABILITY TUNNEL=V6V4 TUNNEL=V6UDPV4
                AUTH=ANONYMOUS AUTH=PLAIN AUTH=DIGEST-MD5 CR LF
</p>
</blockquote><p>
            
</p>
<p>
Tunnel types must be registered with IANA and their profiles are defined in
<a class='info' href='#IANA'>Section&nbsp;7<span> (</span><span class='info'>IANA Considerations</span><span>)</span></a>. Authentication is done using <a class='info' href='#RFC4422'>SASL<span> (</span><span class='info'>Melnikov, A. and K. Zeilenga, &ldquo;Simple Authentication and Security Layer (SASL),&rdquo; June&nbsp;2006.</span><span>)</span></a> [RFC4422].  Each authentication mechanism should be a
registered SASL mechanism. Description of such mechanisms is not in the scope
of this document.

</p>
<p>
The tunnel client can then choose to close the session if none of the
capabilities fits its needs. If the tunnel client chooses to continue,
it authenticates to the server using one of the advertised mechanism
using SASL. If the authentication fails, the server sends an error
message and closes the session.

</p>
<p>
  The example in <a class='info' href='#Failed_Auth'>Figure&nbsp;10<span> (</span><span class='info'>Example of failed authentication</span><span>)</span></a> shows a failed
  authentication where the tunnel client requests an anonymous
  authentication which is not supported by the server.

</p>
<p>
  Note that linebreaks and indentation within a "C:" or "S:" are
  editorial and not part of the protocol.

</p><br /><hr class="insert" />
<a name="Failed_Auth"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
-- Successful TCP Connection --
C:VERSION=2.0.0 CR LF
S:CAPABILITY TUNNEL=V6V4 AUTH=DIGEST-MD5 CR LF
C:AUTHENTICATE ANONYMOUS CR LF
S:300 Authentication failed CR LF
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;10: Example of failed authentication&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
<a class='info' href='#Successful_Auth'>Figure&nbsp;11<span> (</span><span class='info'>Successful anonymous authentication</span><span>)</span></a> shows a successful anonymous
authentication.

</p><br /><hr class="insert" />
<a name="Successful_Auth"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
-- Successful TCP Connection --
C:VERSION=2.0.0 CR LF
S:CAPABILITY TUNNEL=V6V4 TUNNEL=V6UDPV4 AUTH=ANONYMOUS AUTH=PLAIN
  AUTH=DIGEST-MD5 CR LF
C:AUTHENTICATE ANONYMOUS CR LF
S:200 Success CR LF
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;11: Successful anonymous authentication&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
  Digest-MD5 authentication with SASL follows <a class='info' href='#RFC2831'>[RFC2831]<span> (</span><span class='info'>Leach, P. and C. Newman, &ldquo;Using Digest Authentication as a SASL Mechanism,&rdquo; May&nbsp;2000.</span><span>)</span></a>. <a class='info' href='#Digest_success'>Figure&nbsp;12<span> (</span><span class='info'>Successful Digest-MD5 authentication</span><span>)</span></a> shows a successgul digest-md5
  SASL authentication.

</p><br /><hr class="insert" />
<a name="Digest_success"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
-- Successful TCP Connection --
C:VERSION=2.0.0 CR LF
S:CAPABILITY TUNNEL=V6V4 TUNNEL=V6UDPV4 AUTH=ANONYMOUS AUTH=PLAIN
  AUTH=DIGEST-MD5 CR LF
C:AUTHENTICATE DIGEST-MD5 CR LF
S:cmVhbG09aGV4b3Msbm9uY2U9MTExMzkwODk2OCxxb3A9YXV0aCxhbGdvcml0aG09bWQ
  1LXNlc3MsY2hhcnNldD11dGY4
C:Y2hhcnNldD11dGY4LHVzZXJuYW1lPSJ1c2VybmFtZTEiLHJlYWxtPSJoZXhvcyIsbm9
  uY2U9IjExMTM5MDg5NjgiLG5jPTAwMDAwMDAxLGNub25jZT0iMTExMzkyMzMxMSIsZG
  lnZXN0LXVyaT0idHNwL2hleG9zIixyZXNwb25zZT1mOGU0MmIzYzUwYzU5NzcxODUzZ
  jYyNzRmY2ZmZDFjYSxxb3A9YXV0aA==
S:cnNwYXV0aD03MGQ1Y2FiYzkyMzU1NjhiZTM4MGJhMmM5MDczODFmZQ==
S:200 Success CR LF
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;12: Successful Digest-MD5 authentication&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
  The base64-decoded version of the SASL exchange is:

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
S:realm="hexos",nonce="1113908968",qop="auth",algorithm=md5-sess,
  charset=utf8
C:charset=utf8,username="username1",realm="hexos",nonce="1113908968",
  nc=00000001,cnonce="1113923311",digest-uri="tsp/hexos",
  response=f8e42b3c50c59771853f6274fcffd1ca,qop=auth
S:rspauth=70d5cabc9235568be380ba2c907381fe
</pre></div>
<p>
Once the authentication succeeds, the server sends a success return
code and the protocol enters the Command phase.
            
</p>
<a name="cmd_response_phase"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4.3"></a><h3>4.4.3.&nbsp;
Command and response phase</h3>

<p>
    The Command phase is where the tunnel client send a tunnel request
    or a tunnel update to the server. In this phase, commands are sent
    as XML messages. The first line is a "Content-length" directive
    that indicates the size of the following XML message. When the
    server sends a response, the first line is the "Content-length"
    directive, the second is the return code and third one is the XML
    message if any. The "Content-length" is calculated from the first
    character of the return code line to the last character of the XML
    message, inclusively.
    <br />
<br />

    Spaces can be inserted freely.
  
</p><br /><hr class="insert" />
<a name="command_response_sequence"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      -- UDP session established --
      C:VERSION=2.0.0 CR LF
      S:CAPABILITY TUNNEL=V6V4 TUNNEL=V6UDPV4 AUTH=ANONYMOUS
        AUTH=PLAIN AUTH=DIGEST-MD5 CR LF
      C:AUTHENTICATE ANONYMOUS CR LF
      S:200 Success CR LF

      C:Content-length: 205 CR LF
      &lt;tunnel action="create" type="v6udpv4"&gt;
       &lt;client&gt;
        &lt;address type="ipv4"&gt;192.0.2.135&lt;/address&gt;
      &lt;keepalive interval="30"&gt;&lt;/keepalive&gt;
      &lt;/client&gt;
      &lt;/tunnel&gt; CR LF

      S:Content-length: 501 CR LF
      200 Success CR LF
      &lt;tunnel action="info" type="v6udpv4" lifetime="604800"&gt;
        &lt;server&gt;
          &lt;address type="ipv4"&gt;192.0.2.115&lt;/address&gt;
          &lt;address type="ipv6"&gt;
          2001:db8:8000:0000:0000:0000:0000:38b2
          &lt;/address&gt;
        &lt;/server&gt;
        &lt;client&gt;
          &lt;address type="ipv4"&gt;192.0.2.135&lt;/address&gt;
          &lt;address type="ipv6"&gt;
          2001:db8:8000:0000:0000:0000:0000:38b3
          &lt;/address&gt;
          &lt;keepalive interval="30"&gt;
            &lt;address type="ipv6"&gt;
            2001:db8:8000:0000:0000:0000:0000:38b2
            &lt;/address&gt;
          &lt;/keepalive&gt;
        &lt;/client&gt;
      &lt;/tunnel&gt; CR LF

      C:Content-length: 35 CR LF
      &lt;tunnel action="accept"&gt;&lt;/tunnel&gt; CR LF

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;13: Example of a command/response sequence&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
  The example in <a class='info' href='#command_response_sequence'>Figure&nbsp;13<span> (</span><span class='info'>Example of a command/response sequence</span><span>)</span></a> shows a
  client requesting an anonymous v6udpv4 tunnel, indicating that a
  keep-alive packet will be sent every 30 seconds. The tunnel broker
  responds with the tunnel parameters and indicates its acceptance of
  the keepalive period (<a class='info' href='#keepalive'>Section&nbsp;4.6<span> (</span><span class='info'>Tunnel Keep-alive</span><span>)</span></a>). Finally, the
  client sends an accept message to the server.

</p>
<p>
  Once the accept message has been sent, the server and client
  configure their tunnel endpoint based on the negotiated tunnel
  parameters.

</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Tunnel establishment</h3>

<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5.1"></a><h3>4.5.1.&nbsp;
IPv6-over-IPv4 tunnels</h3>

<p>
    Once the TSP signaling is completed, a tunnel can be established
    on the tunnel server and client node. If a v6v4 tunnel has been
    negotiated, then an IPv6-over-IPv4 tunnel <a class='info' href='#RFC4213'>[RFC4213]<span> (</span><span class='info'>Nordmark, E. and R. Gilligan, &ldquo;Basic Transition Mechanisms for IPv6 Hosts and Routers,&rdquo; October&nbsp;2005.</span><span>)</span></a> is established using the operating system tunneling
    interface. On the client node, this is accomplished by the TSP
    client calling the appropriate OS commands or system calls.
  
</p>
<a name="v6udpv4_establishment"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5.2"></a><h3>4.5.2.&nbsp;
IPv6-over-UDP tunnels</h3>

<p>
  If a v6udpv4 tunnel is configured, the same source/destination
  address and port used during the TSP signaling are used to configure
  the v6udpv4 tunnel. If a NAT is in the path between the TSP client
  and tunnel broker, the TSP signaling session will have created a UDP
  state in the NAT. By reusing the same UDP socket parameters to
  transport IPv6, the traffic will flow across the NAT using the same
  state.

<br /><hr class="insert" />
<a name="IPv6_over_UDP"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                +------+-----------+--------+
                | IPv4 | UDP       |  IPv6  |
                | hdr. | port 3653 |        |
                +------+-----------+--------+
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;14: IPv6 transport over UDP&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


</p>
<p>
    At any time, a client may re-establish a TSP signaling
    session. The client disconnects the current tunnel and starts a
    new TSP signaling session as described in <a class='info' href='#udpv4_signaling'>Section&nbsp;4.4.1.2<span> (</span><span class='info'>TSP signaling over UDP/v4</span><span>)</span></a>.  If a NAT is present and the new TSP
    session uses the same UDP mapping in the NAT as for the tunnel,
    the tunnel broker will need to disconnect the client tunnel before
    the client can establish a new TSP session.
  
</p>
<a name="keepalive"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
Tunnel Keep-alive</h3>

<p>
    A TSP client may select to send periodic keep-alive messages to
    the server in order to maintain its tunnel connectivity. This
    allows the client to detect network changes and enable automatic
    tunnel re-establishment. In the case of IPv6-over-UDP tunnels,
    periodic keep-alive can help refresh the connection state in a NAT
    if such device is in the tunnel path.
  
</p>
<p>
    For IPv6-over-IPv4 and IPv6-over-UDP tunnels, the keep-alive
    message is an ICMPv6 echo request <a class='info' href='#RFC4443'>[RFC4443]<span> (</span><span class='info'>Conta, A., Deering, S., and M. Gupta, &ldquo;Internet Control Message Protocol (ICMPv6) for the Internet Protocol Version 6 (IPv6) Specification,&rdquo; March&nbsp;2006.</span><span>)</span></a> sent
    from the client to the tunnel server. The IPv6 destination address
    of the echo message MUST be the address from the 'keepalive'
    element sent in the tunnel response during the TSP signaling
    (<a class='info' href='#cmd_response_phase'>Section&nbsp;4.4.3<span> (</span><span class='info'>Command and response phase</span><span>)</span></a>). The echo message is sent
    over the configured tunnel.
  
</p>
<p>
    The tunnel server responds to the ICMPv6 echo requests and can
    keep track of which tunnel is active. Any client traffic can also
    be used to verify if the tunnel is active. This can be used by the
    broker to disconnect tunnels that are no longer in use.
  
</p>
<p>
  The broker can send a different keep-alive interval from the value
  specified in the client request. The client MUST conform to the
  broker specified keep-alive interval. The client SHOULD apply a
  random "jitter" value to avoid synchronization of keep-alive
  messages from many clients to the server <a class='info' href='#FJ93'>[FJ93]<span> (</span><span class='info'>Floyd, S. and V. Jacobson, &ldquo;The Synchronization of Periodic Routing Messages,&rdquo; September&nbsp;1993.</span><span>)</span></a>. This
  is achieved by using an interval value in the range of [0.75T -
  T], where T is the keep-alive interval specified by the server.


</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7"></a><h3>4.7.&nbsp;
XML Messaging</h3>

<p>
  This section describes the XML messaging used in the TSP signaling
  during the command and response phase. The XML elements and
  attributes are listed in the DTD (<a class='info' href='#DTD_section'>Appendix&nbsp;A<span> (</span><span class='info'>The TSP DTD</span><span>)</span></a>).

</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7.1"></a><h3>4.7.1.&nbsp;
Tunnel</h3>

<p>
      The client and server use the tunnel token with an action
      attribute. Valid actions for this profile are : 'create',
      'delete', 'info', 'accept' and 'reject'.
</p>
<blockquote class="text"><dl>
<dt>create:</dt>
<dd>
  action used to request a new tunnel or update an existing
  tunnel. Sent by the tunnel client.

</dd>
<dt>delete:</dt>
<dd>
  action used to remove an existing tunnel from the server. Sent by
  the tunnel client.

</dd>
<dt>info:</dt>
<dd>
  action used to request current properties of an existing
  tunnel. This action is also used by the tunnel broker to send tunnel
  parameters following a client 'create' action.

</dd>
<dt>accept:</dt>
<dd>
  action used by the client to acknowledge the server that the tunnel
  parameters are accepted. The client will establish a tunnel.

</dd>
<dt>reject:</dt>
<dd>
  action used by the client to signal the server that the tunnel
  parameters offered are rejected and no tunnel will be established.

</dd>
</dl></blockquote><p>
    
</p>
<p>
  The tunnel 'lifetime' attribute is set by the tunnel broker and
  specifies the lifetime of the tunnel in minutes. The lifetime is an
  administratively set value. When a tunnel lifetime is expired, it is
  disconnected on the tunnel server.

</p>
<p>
      The 'tunnel' message contains three elements:
    
</p>
<p>
      </p>
<blockquote class="text"><dl>
<dt>&lt;client&gt;: </dt>
<dd>Client's information
</dd>
<dt>&lt;server&gt;: </dt>
<dd>Server's information
</dd>
<dt>&lt;broker&gt;: </dt>
<dd>List of other server's
</dd>
</dl></blockquote><p>
    
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7.2"></a><h3>4.7.2.&nbsp;
Client Element</h3>

<p>
      The client element contains 3 sub-elements: 'address', 'router'
      and 'keepalive'. These elements are used to describe the client
      request and will be used by the server to create the appropriate
      tunnel. The client element is the only element sent by a client.
    
</p>
<p>
      The 'address' element is used to identify the client IP endpoint
      of the tunnel. When tunneling over IPv4, the client MUST send
      only its IPv4 address to the server. When tunneling over IPv6,
      the client MUST only send its IPv6 address to the server.
    
</p>
<p>
      The broker then returns the assigned IPv6 or IPv4 address
      endpoint and domain name inside the 'client' element when the
      tunnel is created or updated. If supported by the broker, the
      'client' element MAY contain the registered DNS name for the
      address endpoint assigned to the client.
    
</p>
<p>
      Optionally a client MAY send a 'router' element to ask for
      a prefix delegation.
    
</p>
<p>
      Optionally, a client MAY send a 'keepalive' element which
      contains the keep-alive time interval requested by the client.
    
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7.3"></a><h3>4.7.3.&nbsp;
Server Element</h3>

<p>
      The 'server' element contains 2 elements: 'address' and
      'router'. These elements are used to describe the server's
      tunnel endpoint. The 'address' element is used to provide both
      IPv4 and IPv6 addresses of the server's tunnel endpoint, while
      the 'router' element provides information for the routing method
      chosen by the client.
    
</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7.4"></a><h3>4.7.4.&nbsp;
Broker Element</h3>

<p>
      The 'broker' element is used by a tunnel broker to provide a
      alternate list of brokers to a client in the case where the
      server is not able to provide the requested tunnel.
    
</p>
<p>
      The 'broker' element contains a series of 'address' element(s).
    
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Tunnel request examples</h3>

<p>This section presents multiple examples of requests.
</p>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Host tunnel request and reply</h3>

<p>
      A simple tunnel request consist of a 'tunnel' element which
      contains only an 'address' element. The tunnel action is
      'create', specifying a 'v6v4' tunnel encapsulation type. The
      response sent by the tunnel broker is an 'info' action. Note
      that the registered FQDN of the assigned client IPv6 address is
      also returned to the tunnel client.

</p><br /><hr class="insert" />
<a name="SimpleRequest"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      -- Successful TCP Connection --
      C:VERSION=2.0.0 CR LF
      S:CAPABILITY TUNNEL=V6V4 AUTH=ANONYMOUS CR LF
      C:AUTHENTICATE ANONYMOUS CR LF
      S:200 Authentication successful CR LF
      C:Content-length: 123 CR LF
        &lt;tunnel action="create" type="v6v4"&gt;
           &lt;client&gt;
               &lt;address type="ipv4"&gt;1.1.1.1&lt;/address&gt;
           &lt;/client&gt;
        &lt;/tunnel&gt; CR LF
      S: Content-length: 234 CR LF
         200 OK CR LF
         &lt;tunnel action="info" type="v6v4" lifetime="1440"&gt;
           &lt;server&gt;
              &lt;address type="ipv4"&gt;192.0.2.114&lt;/address&gt;
              &lt;address type="ipv6"&gt;
              2001:db8:c18:ffff:0000:0000:0000:0000
              &lt;/address&gt;
           &lt;/server&gt;
           &lt;client&gt;
              &lt;address type="ipv4"&gt;1.1.1.1&lt;/address&gt;
              &lt;address type="ipv6"&gt;
              2001:db8:c18:ffff::0000:0000:0000:0001
              &lt;/address&gt;
              &lt;address type="dn"&gt;userid.domain&lt;/address&gt;
           &lt;/client&gt;
         &lt;/tunnel&gt; CR LF
      C: Content-length: 35 CR LF
         &lt;tunnel action="accept"&gt;&lt;/tunnel&gt; CR LF
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;15: Simple tunnel request made by a client&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Router Tunnel request with a /48 prefix delegation, and reply</h3>

<p>
      A tunnel request with prefix consist of a 'tunnel' element which
      contains 'address' element and a 'router' element. The 'router'
      element also contains the 'dns_server' element which is used to
      request DNS delegation of the assigned IPv6 prefix. The
      'dns_server' element lists the IP address of the DNS servers to
      be registered for the reverse-mapping zone.
    
</p><br /><hr class="insert" />
<a name="StaticRequest"></a>

<p>Tunnel request with prefix and static
        routes.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
C: Content-length: 234 CR LF
   &lt;tunnel action="create" type="v6v4"&gt;
    &lt;client&gt;
     &lt;address type="ipv4"&gt;192.0.2.9&lt;/address&gt;
     &lt;router&gt;
      &lt;prefix length="48"/&gt;
      &lt;dns_server&gt;
       &lt;address type="ipv4"&gt;192.0.2.5&lt;/address&gt;
       &lt;address type="ipv4"&gt;192.0.2.4&lt;/address&gt;
       &lt;address type="ipv6"&gt;2001:db8::1&lt;/address&gt;
      &lt;/dns_server&gt;
     &lt;/router&gt;
    &lt;/client&gt;
   &lt;/tunnel&gt; CR LF
S: Content-length: 234 CR LF
   200 OK CR LF
   &lt;tunnel action="info" type="v6v4" lifetime="1440"&gt;
    &lt;server&gt;
     &lt;address type="ipv4"&gt;192.0.2.114&lt;/address&gt;
     &lt;address type="ipv6"&gt;
     2001:db8:c18:ffff:0000:0000:0000:0000
     &lt;/address&gt;
    &lt;/server&gt;
    &lt;client&gt;
     &lt;address type="ipv4"&gt;192.0.2.9&lt;/address&gt;
     &lt;address type="ipv6"&gt;
     2001:db8:c18:ffff::0000:0000:0000:0001
     &lt;/address&gt;
     &lt;address type="dn"&gt;userid.domain&lt;/address&gt;
     &lt;router&gt;
      &lt;prefix length="48"&gt;2001:db8:c18:1234::&lt;/prefix&gt;
      &lt;dns_server&gt;
       &lt;address type="ipv4"&gt;192.0.2.5&lt;/address&gt;
       &lt;address type="ipv4"&gt;192.0.2.4&lt;/address&gt;
       &lt;address type="ipv6"&gt;2001:db8::1&lt;/address&gt;
      &lt;/dns_server&gt;
     &lt;/router&gt;
    &lt;/client&gt;
   &lt;/tunnel&gt; CR LF
C: Content-length: 35 CR LF
   &lt;tunnel action="accept"&gt;&lt;/tunnel&gt; CR LF
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;16: Tunnel request with prefix and DNS delegation&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
IPv4 over IPv6 tunnel request</h3>

<p>This is similar to the previous 'create' action, but with the
    tunnel type is set to 'v4v6'.
    
    
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

          -- Successful TCP Connection --
          C:VERSION=1.0 CR LF
          S:CAPABILITY TUNNEL=V4V6 AUTH=DIGEST-MD5 AUTH=ANONYMOUS
            CR LF
          C:AUTHENTICATE ANONYMOUS CR LF
          S:OK Authentication successful CR LF
          C:Content-length: 228 CR LF
            &lt;tunnel action="create" type="v4v6"&gt;
               &lt;client&gt;
                   &lt;address type="ipv6"&gt;
                   2001:db8:0c18:ffff:0000:0000:0000:0001
                   &lt;/address&gt;
               &lt;/client&gt;
            &lt;/tunnel&gt; CR LF
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Simple tunnel request made by a client&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
If the allocation request is accepted, the broker will acknowledge the
allocation to the client by sending a 'tunnel' element with the
attribute 'action' set to 'info', 'type' set to 'v4v6' and the
'lifetime' attribute set to the period of validity or lease time of
the allocation. The 'tunnel' element contains 'server' and 'client'
elements.
          
</p><br /><hr class="insert" />
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

          S: Content-length: 370 CR LF
             200 OK CR LF
             &lt;tunnel action="info" type="v4v6" lifetime="1440"&gt;
               &lt;server&gt;
                  &lt;address type="ipv4" length="30"&gt;
                  192.0.2.2
                  &lt;/address&gt;
                  &lt;address type="ipv6"&gt;
                  2001:db8:c18:ffff:0000:0000:0000:0002
                  &lt;/address&gt;
               &lt;/server&gt;
               &lt;client&gt;
                  &lt;address type="ipv4" length="30"&gt;
                  192.0.2.1
                  &lt;/address&gt;
                  &lt;address type="ipv6"&gt;
                  2001:db8:c18:ffff::0000:0000:0000:0001
                  &lt;/address&gt;
               &lt;/client&gt;
             &lt;/tunnel&gt; CR LF
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;IPv4 over IPv6 tunnel response&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
            In DSTM <a class='info' href='#I-D.bound-dstm-exp'>[I&#8209;D.bound&#8209;dstm&#8209;exp]<span> (</span><span class='info'>Bound, J., Toutain, L., and JL. Richier, &ldquo;Dual Stack IPv6 Dominant Transition Mechanism,&rdquo; October&nbsp;2005.</span><span>)</span></a>
            terminology, the DSTM server is the TSP broker and the TEP
            is the tunnel server.
          
</p>
<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
NAT Traversal tunnel request</h3>

<p>  
When a client is capable of both IPv6 over IPv4 and IPv6 over UDP over
IPv4 encapsulation, it can request the broker, by using the "v6anyv4"
tunnel mode, to determine if it is behind a NAT and to send the
appropriate tunnel encapsulation mode as part of the response. The
client can also explicitly request an IPv6 over UDP over IPv4 tunnel
by specifying "v6udpv4" in its request.
          
</p>
<p>
  In the following example, the client informs the broker that it
  requests to send keep-alives every 30 seconds. In its response, the
  broker accepted the client suggested keep-alive interval, and the
  IPv6 destination address for the keep-alive packets is specified.

          <br /><hr class="insert" />
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  C:VERSION=2.0.0 CR LF
  S:CAPABILITY TUNNEL=V6V4 TUNNEL=V6UDPV4 AUTH=DIGEST-MD5 CR LF
  C:AUTHENTICATE ... CR LF
  S:200 Authentication successful CR LF
  C:Content-length: ... CR LF
    &lt;tunnel action="create" type="v6anyv4"&gt;
       &lt;client&gt;
           &lt;address type="ipv4"&gt;10.1.1.1&lt;/address&gt;
           &lt;keepalive interval="30"&gt;&lt;/keepalive&gt;
       &lt;/client&gt;
    &lt;/tunnel&gt; CR LF
  S: Content-length: ... CR LF
     200 OK CR LF
     &lt;tunnel action="info" type="v6udpv4" lifetime="1440"&gt;
       &lt;server&gt;
          &lt;address type="ipv4"&gt;192.0.2.114&lt;/address&gt;
          &lt;address type="ipv6"&gt;
          2001:db8:c18:ffff:0000:0000:0000:0002
          &lt;/address&gt;
       &lt;/server&gt;
       &lt;client&gt;
          &lt;address type="ipv4"&gt;10.1.1.1&lt;/address&gt;
          &lt;address type="ipv6"&gt;
          2001:db8:c18:ffff::0000:0000:0000:0003
          &lt;/address&gt;
          &lt;keepalive interval="30"&gt;
             &lt;address type="ipv6"&gt;
             2001:db8:c18:ffff:0000:0000:0000:0002
             &lt;/address&gt;
          &lt;/keepalive&gt;
       &lt;/client&gt;
     &lt;/tunnel&gt; CR LF
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Tunnel request using v6anyv4 mode&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


</p>
<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Applicability of TSP in Different Networks</h3>

<p>
This section describes the applicability of TSP in different networks.

</p>
<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Provider Networks with Enterprise Customers</h3>

<p>
In a provider network where IPv4 is dominant, a tunnelled
infrastructure can be used to provide IPv6 services to the enterprise
customers, before a full IPv6 native infrastructure is built.  In
order to start deploying in a controlled manner and to give enterprise
customers a prefix, the TSP framework is used.  The TSP server can be
in the core, in the aggregation points or in the PoPs to offer the
service to the customers. IPv6 over IPv4 encapsulation can be used. If
the customers are behind an IPv4 NAT, then IPv6 over UDP-IPv4
encapsulation can be used.  TSP can be used in combination of other
techniques.

</p>
<a name="anchor29"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Provider Networks with Home/Small Office Customers</h3>

<p>
In a provider network where IPv4 is dominant, a tunnelled
infrastructure can be used to provider IPv6 services to the home/small
office customers, before a full IPv6 native infrastructure is built.
The small networks such as Home/Small offices have a non-upgradable
gateway with NAT. TSP with NAT traversal is used to offer IPv6
connectivity and a prefix to the internal network.

</p>
<p>
Automation of the prefix assignment and DNS delegation, done by TSP,
is a very important feature for a provider in order to substantially
decrease support costs. The provider can use the same AAA database
that is used to authenticate the IPv4 broadband users.  Customers can
deploy home IPv6 networks without any intervention of the provider
support people.

</p>
<p>
With the NAT discovery function of TSP, providers can use the same TSP
infrastructure for both NAT and non-NAT parts of the network.

</p>
<a name="anchor30"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Enterprise Networks</h3>

<p>
In an enterprise network where IPv4 is dominant, a tunnelled
infrastructure can be used to provider IPv6 services to the IPv6
islands (hosts or networks) inside the enterprise, before a full IPv6
native infrastructure is built <a class='info' href='#RFC4057'>[RFC4057]<span> (</span><span class='info'>Bound, J., &ldquo;IPv6 Enterprise Network Scenarios,&rdquo; June&nbsp;2005.</span><span>)</span></a>. TSP can be
used to give IPv6 connectivity, prefix and routing for the
islands. This gives to the enterprise a full control deployment of
IPv6 while maintaining automation and permanence of the IPv6
assignments to the islands.

</p>
<a name="anchor31"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
Wireless Networks</h3>

<p>
In a wireless network where IPv4 is dominant, hosts and networks move
and change IPv4 address. TSP enables the automatic re-establishment of
the tunnel when the IPv4 address change.

</p>
<p>
In a wireless network where IPv6 is dominant, hosts and networks
move. TSP enables the automatic re-establishment of the IPv4 over IPv6
tunnel.

</p>
<a name="anchor32"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.5"></a><h3>6.5.&nbsp;
Unmanaged networks</h3>

<p>
An unmanaged network is where no network manager or staff is available
to configure network devices <a class='info' href='#RFC3904'>[RFC3904]<span> (</span><span class='info'>Huitema, C., Austein, R., Satapati, S., and R. van der Pol, &ldquo;Evaluation of IPv6 Transition Mechanisms for Unmanaged Networks,&rdquo; September&nbsp;2004.</span><span>)</span></a>.  TSP is
particularly useful in this context where automation of all necessary
information for the IPv6 connectivity is handled by TSP: tunnel
end-points parameters, prefix assignment, dns delegation, routing.

</p>
<p>
An unmanaged network may be behind a NAT, maybe not. With the NAT
discovery function, TSP works automatically in both cases.

</p>
<a name="anchor33"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.6"></a><h3>6.6.&nbsp;
Mobile Hosts and Mobile Networks</h3>

<p>
Mobile hosts are common and used. Laptops moving from wireless, wired
in office, home, ... are examples. They often have IPv4 connectivity,
but not necessarily IPv6. TSP framework enables the mobile hosts to
have IPv6 connectivity wherever they are, by having the TSP client
send updated information of the new environment to the TSP server,
when a change occurs. Together with NAT discovery and traversal, the
mobile host can be always IPv6 connected wherever it is.

</p>
<p>
Mobile here means only the change of IPv4 address. Mobile-IP mechanisms
and fast hand-off take care of additional constraints in mobile
environments.

</p>
<p>
Mobile networks share the applicability of the mobile hosts. Moreover,
in the TSP framework, they also keep their prefix assignment and can
control the routing. NAT discovery can also be used.

</p>
<a name="IANA"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA Considerations</h3>

<p>
A tunnel type registry should be setup by IANA. The following strings
are defined in this document:

</p>
<p></p>
<ul class="text">
<li>"v6v4" for IPv6 in IPv4 encapsulation (using IPv4 protocol 41)
</li>
<li>"v6udpv4" for IPv6 in UDP in IPv4 encapsulation
</li>
<li>"v6anyv4" for IPv6 in IPv4 or IPv6 in UDP in IPv4 encapsulation
</li>
<li>"v4v6" for IPv4 in IPv6 encapsulation.
</li>
</ul><p>

</p>
<p>
Registration of a new tunnel type can be obtained on a first come
first served policy <a class='info' href='#RFC2434'>[RFC2434]<span> (</span><span class='info'>Narten, T. and H. Alvestrand, &ldquo;Guidelines for Writing an IANA Considerations Section in RFCs,&rdquo; October&nbsp;1998.</span><span>)</span></a>. A new registration
should provide a point of contact, the tunnel type string, and a brief
description on the applicability.

</p>
<p>IANA assigned 3653 as the TSP port number.
</p>
<a name="anchor34"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>
Authentication of the TSP session uses the SASL <a class='info' href='#RFC4422'>[RFC4422]<span> (</span><span class='info'>Melnikov, A. and K. Zeilenga, &ldquo;Simple Authentication and Security Layer (SASL),&rdquo; June&nbsp;2006.</span><span>)</span></a> framework, where the authentication mechanism is negotiated between
the client and the server. The framework uses the level of
authentication needed for securing the session, based on the policies.

</p>
<p>
Static tunnels are created when the TSP negotiation is
terminated. Static tunnels are not open gateways and exhibit less
security issues than automated tunnels. Static IPv6 in IPv4 tunnels
security considerations are described in <a class='info' href='#RFC4213'>[RFC4213]<span> (</span><span class='info'>Nordmark, E. and R. Gilligan, &ldquo;Basic Transition Mechanisms for IPv6 Hosts and Routers,&rdquo; October&nbsp;2005.</span><span>)</span></a>.

</p>
<p>
  In order to help ensure that the traffic is traceable to its correct
  source network, a tunnel server implementation should allow ingress
  filtering on the user tunnel <a class='info' href='#RFC3704'>[RFC3704]<span> (</span><span class='info'>Baker, F. and P. Savola, &ldquo;Ingress Filtering for Multihomed Networks,&rdquo; March&nbsp;2004.</span><span>)</span></a>.

</p>
<p>
A customer A behind a NAT can use a large number of (private) IPv4
addresses and/or source ports and request multiple v6udpv4
tunnels. That would quickly saturate the tunnel server capacity. The
tunnel broker implementation should offer a way to throttle and limit
the number of tunnel established to the same IPv4 address.

</p>
<a name="anchor35"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Conclusion</h3>

<p>
The Tunnel Setup Protocol (TSP) is applicable in many environments,
such as: providers, enterprises, wireless, unmanaged networks, mobile
hosts and networks. TSP gives the two tunnel end-points the ability
to negotiate tunnel parameters, as well as prefix assignment, dns
delegation and routing in an authenticated session. It also provides
IPv4 NAT discovery function by using the most effective encapsulation.
It also supports the IPv4 mobility of the nodes.

</p>
<a name="anchor36"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Acknowledgements</h3>

<p>
    This draft is the merge of many previous drafts about TSP. Octavio
    Medina has contributed to an earlier draft (IPv4 in IPv6). Thanks
    to the following people for comments on improving and clarifying
    this document: Pekka Savola, Alan Ford, Jeroen Massar and
    Jean-Francois Tremblay.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2473">[RFC2473]</a></td>
<td class="author-text"><a href="mailto:aconta@lucent.com">Conta, A.</a> and <a href="mailto:deering@cisco.com">S. Deering</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2473">Generic Packet Tunneling in IPv6 Specification</a>,&rdquo; RFC&nbsp;2473, December&nbsp;1998 (<a href="ftp://ftp.isi.edu/in-notes/rfc2473.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2473.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2473.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2831">[RFC2831]</a></td>
<td class="author-text">Leach, P. and C. Newman, &ldquo;<a href="http://tools.ietf.org/html/rfc2831">Using Digest Authentication as a SASL Mechanism</a>,&rdquo; RFC&nbsp;2831, May&nbsp;2000 (<a href="ftp://ftp.isi.edu/in-notes/rfc2831.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4213">[RFC4213]</a></td>
<td class="author-text">Nordmark, E. and R. Gilligan, &ldquo;<a href="http://tools.ietf.org/html/rfc4213">Basic Transition Mechanisms for IPv6 Hosts and Routers</a>,&rdquo; RFC&nbsp;4213, October&nbsp;2005 (<a href="ftp://ftp.isi.edu/in-notes/rfc4213.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4422">[RFC4422]</a></td>
<td class="author-text">Melnikov, A. and K. Zeilenga, &ldquo;<a href="http://tools.ietf.org/html/rfc4422">Simple Authentication and Security Layer (SASL)</a>,&rdquo; RFC&nbsp;4422, June&nbsp;2006 (<a href="ftp://ftp.isi.edu/in-notes/rfc4422.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4443">[RFC4443]</a></td>
<td class="author-text">Conta, A., Deering, S., and M. Gupta, &ldquo;<a href="http://tools.ietf.org/html/rfc4443">Internet Control Message Protocol (ICMPv6) for the Internet Protocol Version 6 (IPv6) Specification</a>,&rdquo; RFC&nbsp;4443, March&nbsp;2006 (<a href="ftp://ftp.isi.edu/in-notes/rfc4443.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="W3C.REC-xml-20040204">[W3C.REC-xml-20040204]</a></td>
<td class="author-text">Yergeau, F., Paoli, J., Sperberg-McQueen, C., Bray, T., and E. Maler, &ldquo;<a href="http://www.w3.org/TR/2004/REC-xml-20040204">Extensible Markup Language (XML) 1.0 (Third Edition)</a>,&rdquo; W3C REC&nbsp;REC-xml-20040204, February&nbsp;2004.</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="FJ93">[FJ93]</a></td>
<td class="author-text">Floyd, S. and V. Jacobson, &ldquo;The Synchronization of Periodic Routing Messages,&rdquo; Proceedings of ACM&nbsp;SIGCOMM '93, September&nbsp;1993.</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.bound-dstm-exp">[I-D.bound-dstm-exp]</a></td>
<td class="author-text">Bound, J., Toutain, L., and JL. Richier, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-bound-dstm-exp-04.txt">Dual Stack IPv6 Dominant Transition Mechanism</a>,&rdquo; draft-bound-dstm-exp-04 (work in progress), October&nbsp;2005 (<a href="http://www.ietf.org/internet-drafts/draft-bound-dstm-exp-04.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2434">[RFC2434]</a></td>
<td class="author-text"><a href="mailto:narten@raleigh.ibm.com">Narten, T.</a> and <a href="mailto:Harald@Alvestrand.no">H. Alvestrand</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2434">Guidelines for Writing an IANA Considerations Section in RFCs</a>,&rdquo; BCP&nbsp;26, RFC&nbsp;2434, October&nbsp;1998 (<a href="ftp://ftp.isi.edu/in-notes/rfc2434.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2434.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2434.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3053">[RFC3053]</a></td>
<td class="author-text">Durand, A., Fasano, P., Guardini, I., and D. Lento, &ldquo;<a href="http://tools.ietf.org/html/rfc3053">IPv6 Tunnel Broker</a>,&rdquo; RFC&nbsp;3053, January&nbsp;2001 (<a href="ftp://ftp.isi.edu/in-notes/rfc3053.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3704">[RFC3704]</a></td>
<td class="author-text">Baker, F. and P. Savola, &ldquo;<a href="http://tools.ietf.org/html/rfc3704">Ingress Filtering for Multihomed Networks</a>,&rdquo; BCP&nbsp;84, RFC&nbsp;3704, March&nbsp;2004 (<a href="ftp://ftp.isi.edu/in-notes/rfc3704.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3904">[RFC3904]</a></td>
<td class="author-text">Huitema, C., Austein, R., Satapati, S., and R. van der Pol, &ldquo;<a href="http://tools.ietf.org/html/rfc3904">Evaluation of IPv6 Transition Mechanisms for Unmanaged Networks</a>,&rdquo; RFC&nbsp;3904, September&nbsp;2004 (<a href="ftp://ftp.isi.edu/in-notes/rfc3904.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3964">[RFC3964]</a></td>
<td class="author-text">Savola, P. and C. Patel, &ldquo;<a href="http://tools.ietf.org/html/rfc3964">Security Considerations for 6to4</a>,&rdquo; RFC&nbsp;3964, December&nbsp;2004 (<a href="ftp://ftp.isi.edu/in-notes/rfc3964.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4057">[RFC4057]</a></td>
<td class="author-text">Bound, J., &ldquo;<a href="http://tools.ietf.org/html/rfc4057">IPv6 Enterprise Network Scenarios</a>,&rdquo; RFC&nbsp;4057, June&nbsp;2005 (<a href="ftp://ftp.isi.edu/in-notes/rfc4057.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="UNP">[UNP]</a></td>
<td class="author-text">Stevens, R., Fenner, B., and A. Rudoff, &ldquo;Unix Network Programming, 3rd edition,&rdquo; Addison Wesley&nbsp;ISBN 0-13-141155-1, 2004.</td></tr>
</table>

<a name="DTD_section"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
The TSP DTD</h3>
<br /><hr class="insert" />
<a name="DTD"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE tunnel  [
&lt;!ELEMENT tunnel (server?,client?,broker?)&gt;
  &lt;!ATTLIST tunnel action
               (create|delete|info|accept|reject) #REQUIRED &gt;
  &lt;!ATTLIST tunnel type
               (v6v4|v4v6|v6anyv4|v6udpv4) #REQUIRED &gt;
  &lt;!ATTLIST tunnel lifetime CDATA "1440"    &gt;

&lt;!ELEMENT server        (address+,router?)&gt;

&lt;!ELEMENT client        (address+,router?)&gt;

&lt;!ELEMENT broker        (address+)&gt;

&lt;!ELEMENT router        (prefix?,dns_server?)&gt;

&lt;!ELEMENT dns_server    (address+)&gt;

&lt;!ELEMENT prefix        (#PCDATA)&gt;
  &lt;!ATTLIST prefix length CDATA #REQUIRED&gt;

&lt;!ELEMENT address       (#PCDATA)&gt;
  &lt;!ATTLIST address type (ipv4|ipv6|dn) #REQUIRED&gt;
  &lt;!ATTLIST address length CDATA ""&gt;

&lt;!ELEMENT keepalive (address?)&gt;
  &lt;!ATTLIST keepalive interval CDATA #REQUIRED&gt;
]&gt;
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;17: TSP DTD&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor39"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
Error codes</h3>

<p>
Error codes are sent as a numeric value followed by a text message
describing the code, similar to SMTP. The codes are sent from the
broker to the client. The currently defined error codes are showned
below. Upon receiving an error, the client will display the
appropriate message to the user.

</p>
<p>
New error messages may be defined in the future. For interoperability
purpose, the error code range to use should be from 300 to 599.

</p>
<p>
The reply code 200 is used to inform the client that an action
successfully completed. For example, this reply code is used in
response to an authentication request and a tunnel creation request.

</p>
<p>
  The server may redirect the client to another broker. The details on
  how these brokers are knowned or discovered is beyond the scope of
  this document. When a list of tunnel brokers follows the error code
  as a referal service, then 1000 is added to the error code.

</p>
<p>
<br />
<br />

The predefined values are :
<br />
<br />


</p>
<p>
</p>
<blockquote class="text"><dl>
<dt>200 Success: </dt>
<dd>
  Successful operation
</dd>
<dt>300 Authentication failed:</dt>
<dd>
     Invalid userid, password or authentication mechanism.
</dd>
<dt>301 No more tunnels available:</dt>
<dd>
     The server has reached its capacity limit.
</dd>
<dt>302 Unsupported client version:</dt>
<dd>
     The client version is not supported by the server.
</dd>
<dt>303 Unsupported tunnel type:</dt>
<dd>
     The server does not provide the requested tunnel type.
</dd>
<dt>310 Server side error:</dt>
<dd>
  Undefined server error.

</dd>
<dt>500 Invalid request format or specified length:</dt>
<dd>
  Received request has invalid syntax or truncated

</dd>
<dt>501 Invalid IPv4 address:</dt>
<dd>
  IPv4 address specified by the client is invalid

</dd>
<dt>502 Invalid IPv6 address:</dt>
<dd>
  IPv6 address specified by the client is invalid

</dd>
<dt>506 IPv4 address already used for existing tunnel</dt>
<dd>
A IPv6-over-IPv4 tunnel already exists using the same IPv4 address
endpoints.

</dd>
<dt>507 Requested prefix length cannot be assigned</dt>
<dd>
The requested prefix length cannot be allocated on the server

</dd>
<dt>521 Request already in progress</dt>
<dd>
The client tunnel request is being processed by the server. Temporary
error.

</dd>
<dt>530 Server too busy</dt>
<dd>
Request cannot be process, insufficient resources. Temporary error.

</dd>
</dl></blockquote><p>

</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Marc Blanchet</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Viagenie</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">2600 boul. Laurier, suite 625</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Quebec, QC  G1V 4W1</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1-418-656-9254</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Marc.Blanchet@viagenie.ca">Marc.Blanchet@viagenie.ca</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Florent Parent</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Beon Solutions</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Quebec, QC  </td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 418 353 0857</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Florent.Parent@beon.ca">Florent.Parent@beon.ca</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
