<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Verification Involving PSTN Reachability: The ViPR Access Protocol (VAP)</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction to ViPR">
<link href="#rfc.section.2" rel="Chapter" title="2 Overview of VAP">
<link href="#rfc.section.3" rel="Chapter" title="3 Terminology">
<link href="#rfc.section.4" rel="Chapter" title="4 VAP Message Structure">
<link href="#rfc.section.5" rel="Chapter" title="5 VAP Transactions">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Transport and Connection Management">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Requestor Procedures">
<link href="#rfc.section.5.2.1" rel="Chapter" title="5.2.1 Generating Requests">
<link href="#rfc.section.5.2.2" rel="Chapter" title="5.2.2 Receiving Responses">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 Responder Behaviors">
<link href="#rfc.section.5.3.1" rel="Chapter" title="5.3.1 Receiving Requests">
<link href="#rfc.section.5.3.2" rel="Chapter" title="5.3.2 Sending Responses">
<link href="#rfc.section.6" rel="Chapter" title="6 State Model">
<link href="#rfc.section.7" rel="Chapter" title="7 Protocol Versioning">
<link href="#rfc.section.8" rel="Chapter" title="8 ViPR Client Procedures">
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 Discovery">
<link href="#rfc.section.8.2" rel="Chapter" title="8.2 Registration">
<link href="#rfc.section.8.3" rel="Chapter" title="8.3 Unregistering">
<link href="#rfc.section.8.4" rel="Chapter" title="8.4 Publishing Services">
<link href="#rfc.section.8.4.1" rel="Chapter" title="8.4.1 VService">
<link href="#rfc.section.8.4.2" rel="Chapter" title="8.4.2 ViPR Number Service">
<link href="#rfc.section.8.5" rel="Chapter" title="8.5 Updating the VService">
<link href="#rfc.section.8.6" rel="Chapter" title="8.6 Uploading VCRs">
<link href="#rfc.section.8.7" rel="Chapter" title="8.7 Subscribing to Number Service">
<link href="#rfc.section.8.8" rel="Chapter" title="8.8 Unsubscribing to Services">
<link href="#rfc.section.8.9" rel="Chapter" title="8.9 Receiving Notify">
<link href="#rfc.section.8.10" rel="Chapter" title="8.10 Receiving PublishRevoke">
<link href="#rfc.section.9" rel="Chapter" title="9 ViPR Server Procedures">
<link href="#rfc.section.9.1" rel="Chapter" title="9.1 Connection Establishment">
<link href="#rfc.section.9.2" rel="Chapter" title="9.2 Registration ">
<link href="#rfc.section.9.3" rel="Chapter" title="9.3 Unregistration">
<link href="#rfc.section.9.4" rel="Chapter" title="9.4 Publication">
<link href="#rfc.section.9.4.1" rel="Chapter" title="9.4.1 VService">
<link href="#rfc.section.9.4.2" rel="Chapter" title="9.4.2 ViPR Number Service">
<link href="#rfc.section.9.5" rel="Chapter" title="9.5 Unpublish">
<link href="#rfc.section.9.6" rel="Chapter" title="9.6 Subscribe">
<link href="#rfc.section.9.7" rel="Chapter" title="9.7 Unsubscribe">
<link href="#rfc.section.9.8" rel="Chapter" title="9.8 UploadVCR">
<link href="#rfc.section.9.8.1" rel="Chapter" title="9.8.1 Originating">
<link href="#rfc.section.9.8.2" rel="Chapter" title="9.8.2 Terminating">
<link href="#rfc.section.9.9" rel="Chapter" title="9.9 Sending Notify">
<link href="#rfc.section.9.10" rel="Chapter" title="9.10 Sending PublishRevoke">
<link href="#rfc.section.10" rel="Chapter" title="10 Syntax Details">
<link href="#rfc.section.10.1" rel="Chapter" title="10.1 XML Schema for VService">
<link href="#rfc.section.10.2" rel="Chapter" title="10.2 XML Schema for ValInfo">
<link href="#rfc.section.10.3" rel="Chapter" title="10.3 VAP Attributes">
<link href="#rfc.section.10.3.1" rel="Chapter" title="10.3.1 USERNAME">
<link href="#rfc.section.10.3.2" rel="Chapter" title="10.3.2 REALM">
<link href="#rfc.section.10.3.3" rel="Chapter" title="10.3.3 MESSAGE-INTEGRITY">
<link href="#rfc.section.10.3.4" rel="Chapter" title="10.3.4 ERROR-CODE">
<link href="#rfc.section.10.3.5" rel="Chapter" title="10.3.5 Client-Name">
<link href="#rfc.section.10.3.6" rel="Chapter" title="10.3.6 Client-Handle">
<link href="#rfc.section.10.3.7" rel="Chapter" title="10.3.7 Protocol-Version">
<link href="#rfc.section.10.3.8" rel="Chapter" title="10.3.8 Client-Label">
<link href="#rfc.section.10.3.9" rel="Chapter" title="10.3.9 Keepalive">
<link href="#rfc.section.10.3.10" rel="Chapter" title="10.3.10 ServiceIdentity">
<link href="#rfc.section.10.3.11" rel="Chapter" title="10.3.11 ServiceVersion">
<link href="#rfc.section.10.3.12" rel="Chapter" title="10.3.12 ServiceContent">
<link href="#rfc.section.10.3.13" rel="Chapter" title="10.3.13 SubscriptionID">
<link href="#rfc.section.10.3.14" rel="Chapter" title="10.3.14 CallDirection">
<link href="#rfc.section.10.3.15" rel="Chapter" title="10.3.15 StartTime">
<link href="#rfc.section.10.3.16" rel="Chapter" title="10.3.16 StopTime Attribute">
<link href="#rfc.section.10.3.17" rel="Chapter" title="10.3.17 CallingNum Attribute">
<link href="#rfc.section.10.3.18" rel="Chapter" title="10.3.18 CalledNum Attribute">
<link href="#rfc.section.10.3.19" rel="Chapter" title="10.3.19 Quota Attribute">
<link href="#rfc.section.10.3.20" rel="Chapter" title="10.3.20 DHTLifetime Attribute">
<link href="#rfc.section.11" rel="Chapter" title="11 Security Considerations">
<link href="#rfc.section.11.1" rel="Chapter" title="11.1 Outsider Attacks">
<link href="#rfc.section.11.2" rel="Chapter" title="11.2 Insider Attacks">
<link href="#rfc.section.12" rel="Chapter" title="12 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="13 References">
<link href="#rfc.references.1" rel="Chapter" title="13.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="13.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Release notes">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 Modifications between rosenberg-03 and rosenberg-02">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="Verification Involving PSTN Reachability (ViPR) is a technique for inter-domain SIP federation. ViPR hybridizes the PSTN, P2P networks, and SIP, and in doing so, addresses the phone number routing and VoIP spam problems that have been a barrier to federation. The ViPR architecture uses a server, the ViPR server, which performs P2P and validation services on behalf of call agents, which acts as clients to the server.  Such an architecture requires a client/server protocol between call agents and the ViPR server. That protocol, defined here, is called the ViPR Access Protocol (VAP)." />
  <meta name="description" content="Verification Involving PSTN Reachability (ViPR) is a technique for inter-domain SIP federation. ViPR hybridizes the PSTN, P2P networks, and SIP, and in doing so, addresses the phone number routing and VoIP spam problems that have been a barrier to federation. The ViPR architecture uses a server, the ViPR server, which performs P2P and validation services on behalf of call agents, which acts as clients to the server.  Such an architecture requires a client/server protocol between call agents and the ViPR server. That protocol, defined here, is called the ViPR Access Protocol (VAP)." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">vipr</td>
<td class="right">C. Jennings</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Cisco</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">J.R. Rosenberg</td>
</tr>
<tr>
<td class="left">Expires: October 03, 2011</td>
<td class="right">jdrosen.net</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">M. Petit-Huguenin</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Stonyfish</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">April 01, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Verification Involving PSTN Reachability: The ViPR Access Protocol (VAP)<br />
  <span class="filename">draft-jennings-vipr-vap-00</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>Verification Involving PSTN Reachability (ViPR) is a technique for inter-domain SIP federation. ViPR hybridizes the PSTN, P2P networks, and SIP, and in doing so, addresses the phone number routing and VoIP spam problems that have been a barrier to federation. The ViPR architecture uses a server, the ViPR server, which performs P2P and validation services on behalf of call agents, which acts as clients to the server.  Such an architecture requires a client/server protocol between call agents and the ViPR server. That protocol, defined here, is called the ViPR Access Protocol (VAP).</p>
<p>The IETF has been notified of intellectual property rights claimed in regard to some or all of the specification contained in this document.  For more information consult the online list of claimed rights.</p>
<h1><a>Legal</a></h1>
<p>This documents and the information contained therein are provided on an "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE INFORMATION THEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on October 03, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction to ViPR</a>
</li>
<li>2.   <a href="#rfc.section.2">Overview of VAP</a>
</li>
<li>3.   <a href="#rfc.section.3">Terminology</a>
</li>
<li>4.   <a href="#rfc.section.4">VAP Message Structure</a>
</li>
<li>5.   <a href="#rfc.section.5">VAP Transactions</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Transport and Connection Management</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Requestor Procedures</a>
</li>
<li>5.2.1.   <a href="#rfc.section.5.2.1">Generating Requests</a>
</li>
<li>5.2.2.   <a href="#rfc.section.5.2.2">Receiving Responses</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">Responder Behaviors</a>
</li>
<li>5.3.1.   <a href="#rfc.section.5.3.1">Receiving Requests</a>
</li>
<li>5.3.2.   <a href="#rfc.section.5.3.2">Sending Responses</a>
</li>
<li>6.   <a href="#rfc.section.6">State Model</a>
</li>
<li>7.   <a href="#rfc.section.7">Protocol Versioning</a>
</li>
<li>8.   <a href="#rfc.section.8">ViPR Client Procedures</a>
</li>
<li>8.1.   <a href="#rfc.section.8.1">Discovery</a>
</li>
<li>8.2.   <a href="#rfc.section.8.2">Registration</a>
</li>
<li>8.3.   <a href="#rfc.section.8.3">Unregistering</a>
</li>
<li>8.4.   <a href="#rfc.section.8.4">Publishing Services</a>
</li>
<li>8.4.1.   <a href="#rfc.section.8.4.1">VService</a>
</li>
<li>8.4.2.   <a href="#rfc.section.8.4.2">ViPR Number Service</a>
</li>
<li>8.5.   <a href="#rfc.section.8.5">Updating the VService</a>
</li>
<li>8.6.   <a href="#rfc.section.8.6">Uploading VCRs</a>
</li>
<li>8.7.   <a href="#rfc.section.8.7">Subscribing to Number Service</a>
</li>
<li>8.8.   <a href="#rfc.section.8.8">Unsubscribing to Services</a>
</li>
<li>8.9.   <a href="#rfc.section.8.9">Receiving Notify</a>
</li>
<li>8.10.   <a href="#rfc.section.8.10">Receiving PublishRevoke</a>
</li>
<li>9.   <a href="#rfc.section.9">ViPR Server Procedures</a>
</li>
<li>9.1.   <a href="#rfc.section.9.1">Connection Establishment</a>
</li>
<li>9.2.   <a href="#rfc.section.9.2">Registration </a>
</li>
<li>9.3.   <a href="#rfc.section.9.3">Unregistration</a>
</li>
<li>9.4.   <a href="#rfc.section.9.4">Publication</a>
</li>
<li>9.4.1.   <a href="#rfc.section.9.4.1">VService</a>
</li>
<li>9.4.2.   <a href="#rfc.section.9.4.2">ViPR Number Service</a>
</li>
<li>9.5.   <a href="#rfc.section.9.5">Unpublish</a>
</li>
<li>9.6.   <a href="#rfc.section.9.6">Subscribe</a>
</li>
<li>9.7.   <a href="#rfc.section.9.7">Unsubscribe</a>
</li>
<li>9.8.   <a href="#rfc.section.9.8">UploadVCR</a>
</li>
<li>9.8.1.   <a href="#rfc.section.9.8.1">Originating</a>
</li>
<li>9.8.2.   <a href="#rfc.section.9.8.2">Terminating</a>
</li>
<li>9.9.   <a href="#rfc.section.9.9">Sending Notify</a>
</li>
<li>9.10.   <a href="#rfc.section.9.10">Sending PublishRevoke</a>
</li>
<li>10.   <a href="#rfc.section.10">Syntax Details</a>
</li>
<li>10.1.   <a href="#rfc.section.10.1">XML Schema for VService</a>
</li>
<li>10.2.   <a href="#rfc.section.10.2">XML Schema for ValInfo</a>
</li>
<li>10.3.   <a href="#rfc.section.10.3">VAP Attributes</a>
</li>
<li>10.3.1.   <a href="#rfc.section.10.3.1">USERNAME</a>
</li>
<li>10.3.2.   <a href="#rfc.section.10.3.2">REALM</a>
</li>
<li>10.3.3.   <a href="#rfc.section.10.3.3">MESSAGE-INTEGRITY</a>
</li>
<li>10.3.4.   <a href="#rfc.section.10.3.4">ERROR-CODE</a>
</li>
<li>10.3.5.   <a href="#rfc.section.10.3.5">Client-Name</a>
</li>
<li>10.3.6.   <a href="#rfc.section.10.3.6">Client-Handle</a>
</li>
<li>10.3.7.   <a href="#rfc.section.10.3.7">Protocol-Version</a>
</li>
<li>10.3.8.   <a href="#rfc.section.10.3.8">Client-Label</a>
</li>
<li>10.3.9.   <a href="#rfc.section.10.3.9">Keepalive</a>
</li>
<li>10.3.10.   <a href="#rfc.section.10.3.10">ServiceIdentity</a>
</li>
<li>10.3.11.   <a href="#rfc.section.10.3.11">ServiceVersion</a>
</li>
<li>10.3.12.   <a href="#rfc.section.10.3.12">ServiceContent</a>
</li>
<li>10.3.13.   <a href="#rfc.section.10.3.13">SubscriptionID</a>
</li>
<li>10.3.14.   <a href="#rfc.section.10.3.14">CallDirection</a>
</li>
<li>10.3.15.   <a href="#rfc.section.10.3.15">StartTime</a>
</li>
<li>10.3.16.   <a href="#rfc.section.10.3.16">StopTime Attribute</a>
</li>
<li>10.3.17.   <a href="#rfc.section.10.3.17">CallingNum Attribute</a>
</li>
<li>10.3.18.   <a href="#rfc.section.10.3.18">CalledNum Attribute</a>
</li>
<li>10.3.19.   <a href="#rfc.section.10.3.19">Quota Attribute</a>
</li>
<li>10.3.20.   <a href="#rfc.section.10.3.20">DHTLifetime Attribute</a>
</li>
<li>11.   <a href="#rfc.section.11">Security Considerations</a>
</li>
<li>11.1.   <a href="#rfc.section.11.1">Outsider Attacks</a>
</li>
<li>11.2.   <a href="#rfc.section.11.2">Insider Attacks</a>
</li>
<li>12.   <a href="#rfc.section.12">IANA Considerations</a>
</li>
<li>13.   <a href="#rfc.references">References</a>
</li>
<li>13.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>13.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Release notes</a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">Modifications between rosenberg-03 and rosenberg-02</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction to ViPR</h1>
<p><a href="#VIPR-OVERVIEW">[VIPR-OVERVIEW]</a> introduces a new technology, called Verification Involving PSTN Reachability (ViPR), which enables VoIP federation between domains, over the Internet. ViPR is a hybrid technology that combines together the PSTN, P2P networks, and SIP. In doing so, it addresses the phone number routing problem and anti-spam problems that have been the most significant barriers to widespread deployment of SIP inter-domain federation.</p>
<p id="rfc.section.1.p.2">It is assumed that readers of this document have read and understood <a href="#VIPR-OVERVIEW">[VIPR-OVERVIEW]</a>.</p>
<p id="rfc.section.1.p.3">One of the key protocols used in ViPR is the ViPR Access Protocol (VAP). VAP connects call agents, such as phones, SBCs and IP PBXs, to a ViPR server. This document defines the VAP protocol in detail.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Overview of VAP</h1>
<p id="rfc.section.2.p.1">A high level view on the ViPR architecture is shown in <a href="#fig-arch">Figure 1</a>. This architecture is discussed in more detail in <a href="#VIPR-OVERVIEW">[VIPR-OVERVIEW]</a>.</p>
<div id="#rfc.figure.1"></div>
<div id="#fig-arch"></div>
<pre>
                    +-+            +-+
                    | |            | |   +------+
                    | |      +-----| |---|Enroll|
                    | |      |     | |   +------+
                    |I|      |     |I|
                    |n|   +-----+  |n|
             VAP    |t|   | ViPR|  |t|
         +----------|r|---|Srvr |--|e|-----------------
         |          |a|   |     |  |r|   P2P-Validation
         |          |n|   +-----+  |n|
         |          |e|            |e|
         |          |t|            |t|
      +-----+  SIP  | |   +-----+  | |
      | CA  |-------|F|---|     |--|F| ---------------
      +-----+       |i|   |     |  |i|  SIP/TLS
         .          |r|   |  .  |  |r|
  SIP/   .          |e|   |     |  |e|
  MGCP/  .          |w|   | BE  |  |w|
  TDM    .          |a|   |     |  |a|
         .          |l|   |     |  |l|
      +-----+       |l|   |     |  |l|
      | UA  |-------| |---|     |--| |-----------------
      +-----+       | |   +-----+  | |   SRTP
                    | |            | |
                    +-+            +-+
 |                                      |
 +--------------------+-----------------+
                      |
         Single administrative domain
</pre>
<p id="rfc.section.2.p.2">A key component of this architecture is the ViPR server. The ViPR server is responsible for connecting to the P2P network, publishing phone numbers into that network, performing validation, and learning new routes. The ViPR server performs those functions on behalf of one or more call agents. This requires a protocol to run between the call agents and the ViPR server. This protocol is called VAP - the ViPR Access Protocol.</p>
<p id="rfc.section.2.p.3">VAP is a client-server protocol that runs between the call agent and the ViPR server. VAP is a simple, binary based, request/response protocol. It utilizes the same syntactic structure and transaction state machinery as STUN <a href="#RFC5389">[RFC5389]</a>, but otherwise is totally distinct from it. VAP clients initiate TCP/TLS connections towards the ViPR server. The ViPR server never opens connections towards the call agent. This allows the ViPR servers to run on the public side of NATs and firewalls.</p>
<p id="rfc.section.2.p.4">Once the connections are established, the call agent sends a Register message to the ViPR server. This register message primarily provides authentication and connects the client to the ViPR server. VAP provides several messages for different purposes: </p>

<ul>
<li>Publish: The Publish message informs the ViPR server of service information. There are two types of Publishes supported in ViPR. The first is the ViPR Service (VService). This informs the ViPR server of the SIP URIs on the call agent and black and white lists used by the ViPR server to block validations. The ViPR server stores that information locally and uses it during the validation process, as described above. The second Publish is the ViPR Number Service. The ViPR server, upon receiving this message, performs a Store operation into the DHT.</li>
<li>UploadVCR: This message comes in two flavors - an originating and terminating message. An originating UploadVCR comes from a call agent upon completion of a non-ViPR call to the PSTN. A terminating UploadVCR comes from an agent upon completion of a call received FROM the PSTN. The ViPR server behavior for both messages is very different. For originating UploadVCR, the ViPR server will store these, and at a random time later, query the DHT for the called number and attempt validation against the ViPR servers that are found. For a terminating UploadVCR, the ViPR server will store these, awaiting receipt of a validation against them.</li>
<li>Subscribe: Call agents can subscribe for information from the ViPR server. There is one service that call agent can subscribe for: Number Service. When a new number is validated, the ViPR server will send a Notify to the call agent, containing the validated number, the ticket, and a set of SIP trunk URIs.</li>
<li>Notify: The ViPR server sends this message to the call agent when it has an event to report for a particular subscription.</li>
</ul>
<p id="rfc.section.2.p.5">The VAP protocol provides authentication by including an integrity object in each message. This integrity message is the hash of the contents of the message and a shared secret between the ViPR server and the client. VAP can also be run over TLS, which enhances security further.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Terminology</h1>
<p id="rfc.section.3.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#message_structure" id="message_structure">VAP Message Structure</a>
</h1>
<p id="rfc.section.4.p.1">VAP messages follow the syntax and structure of Session Traversal Utilities for NAT (STUN) <a href="#RFC5389">[RFC5389]</a>. It also shares the same transaction model as STUN. However, aside from its common syntax and transaction model, STUN and VAP are unrelated.</p>
<p id="rfc.section.4.p.2">VAP messages are encoded in binary using network-oriented format (most significant byte or octet first, also commonly known as big-endian). The transmission order is described in detail in Appendix B of <a href="#RFC0791">RFC791</a> <cite title="NONE">[RFC0791]</cite>. Unless otherwise noted, numeric constants are in decimal (base 10).</p>
<div id="#rfc.figure.2"></div>
<div id="#stun_message_header"></div>
<p>All VAP messages MUST start with a 20-byte header followed by zero or more Attributes. The VAP header contains a VAP message type, message length, magic cookie and transaction ID.</p>
<pre>
   0                   1                   2                   3
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |0 0|     VAP Message Type      |         Message Length        |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |                         Magic Cookie                          |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |                                                               |
  |                     Transaction ID (96 bits)                  |
  |                                                               |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.4.p.3">The most significant two bits of every VAP message MUST be zeroes.</p>
<p id="rfc.section.4.p.4">The message type defines the message class (request, success response, failure response) and the message method (the primary function) of the VAP message. Although there are four message classes, there is only one type of transaction in VAP: request/response transactions (which consist of a request message and a response message). Response classes are split into error and success responses to aid in quickly processing the VAP message.</p>
<div id="#rfc.figure.3"></div>
<div id="#stun_message_type"></div>
<p>The message type field is decomposed further into the following structure:</p>
<pre>
   0                 1
   2  3  4 5 6 7 8 9 0 1 2 3 4 5

  +--+--+-+-+-+-+-+-+-+-+-+-+-+-+
  |M |M |M|M|M|C|M|M|M|C|M|M|M|M|
  |11|10|9|8|7|1|6|5|4|0|3|2|1|0|
  +--+--+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.4.p.5">Here the bits in the message type field are shown as most-significant (M11) through least-significant (M0). M11 through M0 represent a 12-bit encoding of the method. C1 and C0 represent a 2 bit encoding of the class. A class of 0b00 is a Request, a class of 0b10 is a success response, and a class of 0b11 is an error response. The method and class are orthogonal, so that for each method, a request, success response, error response and indication are defined for that method.</p>
<p id="rfc.section.4.p.6">The magic cookie field MUST contain the fixed value 0x41666679 in network byte order (note that this is a different value than STUN).</p>
<p id="rfc.section.4.p.7">The transaction ID is a 96 bit identifier, used to uniquely identify VAP transactions. For request/response transactions, the transaction ID is chosen by the VAP client for the request and echoed by the server in the response. The transaction ID MUST be uniformly and randomly chosen from the interval 0 .. 2**96-1, and SHOULD be cryptographically random.  The client MUST choose a new transaction ID for new transactions.  Success and error responses MUST carry the same transaction ID as their corresponding request.</p>
<p id="rfc.section.4.p.8">The message length MUST contain the size, in bytes, of the message not including the 20 byte VAP header. Since all VAP attributes are padded to a multiple of four bytes, the last two bits of this field are always zero.</p>
<p id="rfc.section.4.p.9">Following the VAP fixed portion of the header are zero or more attributes. Each attribute is TLV (type-length-value) encoded. The details of the attributes themselves is given in <a href="#attribute_details">Section 10.3</a>.</p>
<p id="rfc.section.4.p.10">The methods defined in VAP, and their corresponding method values, are:</p>
<div id="#rfc.figure.4"></div>
<div id="#vap_methods"></div>
<pre>

Method            Value
------           ------
Register          0x001
Unregister        0x002
Publish           0x004
Unpublish         0x005
PublishRevoke     0x006
Subscribe         0x007
Unsubscribe       0x008
Notify            0x00a
UploadVCR         0x00b
</pre>
<p id="rfc.section.4.p.11">After the VAP header are zero or more attributes. Each attribute is TLV encoded, with a 16 bit type, 16 bit length, and variable value. Each attribute MUST end on a 32 bit boundary:</p>
<div id="#rfc.figure.5"></div>
<div id="#fig-vap-atts"></div>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Type                  |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             Value                 ....        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.4.p.12">The Length refers to the length of the actual useful content of the Value portion of the attribute, measured in bytes. Since VAP aligns attributes on 32 bit boundaries, attributes whose content is not a multiple of 4 bytes are padded with 1, 2 or 3 bytes of padding so that they are a multiple of 4 bytes. Such padding is only needed with attributes that take freeform strings, such as USERNAME. For attributes that contain more structured data, the attributes are constructed to align on 32 bit boundaries. The value in the Length field refers to the length of the Value part of the attribute prior to padding - i.e., the useful content. Consequently, when parsing messages, implementations will need to round up the Length field to the nearest multiple of four in order to find the start of the next attribute.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> VAP Transactions</h1>
<p id="rfc.section.5.p.1">This section describes the general behavior of VAP transactions, regardless of the method.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Transport and Connection Management</h1>
<p id="rfc.section.5.1.p.1">VAP runs only over TCP. UDP is not supported. As a consequence, transactions are simple. For each transaction, the client sends a single request, and the server sends a response.</p>
<p id="rfc.section.5.1.p.2">VAP can also be run over TLS. The server MUST implement TLS, and the client SHOULD utilize it. The TLS_RSA_WITH_AES_128_CBC_SHA ciphersuite MUST be implemented. The client MUST verify that the server certificate matches a configured value associated with the ViPR server that is to be used. The server MUST accept any certificate from the client. Client authentication is performed using a simple digest technique.</p>
<p id="rfc.section.5.1.p.3">Reliability of VAP over TCP and TLS-over-TCP is handled by TCP itself, and there are no retransmissions at the VAP protocol level.  However, for a request/response transaction, if the client has not received a response by Ti seconds after it sent the SYN to establish the connection, it considers the transaction to have timed out. Ti SHOULD be configurable and SHOULD have a default of 39.5s.</p>
<p id="rfc.section.5.1.p.4">In addition, if the client is unable to establish the TCP connection, or the TCP connection is reset or fails before a response is received, any request/response transaction in progress is considered to have failed.</p>
<p id="rfc.section.5.1.p.5">The client MAY send multiple transactions over a single TCP (or TLS-over-TCP) connection, and it MAY send another request before receiving a response to the previous. The client SHOULD keep the connection open until it</p>

<ul>
<li>has no further VAP requests to send over that connection, and;</li>
<li>has no outstanding subscriptions</li>
</ul>
<p id="rfc.section.5.1.p.6">At the server end, the server SHOULD keep the connection open, and let the client close it, unless the server has determined that the connection has timed out (for example, due to the client disconnecting from the network). The server SHOULD NOT close a connection if a request was received over that connection for which a response was not sent. A server MUST NOT ever open a connection back towards the client in order to send a response. Servers SHOULD follow best practices regarding connection management in cases of overload.</p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#sec-requestor" id="sec-requestor">Requestor Procedures</a>
</h1>
<p id="rfc.section.5.2.p.1">Though VAP is a client/server protocol, the ViPR server can asynchronously send requests towards the client call agent. As such, this section defines transaction rules in terms of the requestor (the entity sending the request) and the responder (the entity receiving the request).</p>
<h1 id="rfc.section.5.2.1">
<a href="#rfc.section.5.2.1">5.2.1.</a> Generating Requests</h1>
<p id="rfc.section.5.2.1.p.1">The requestor MUST construct a request message based on the syntax in <a href="#message_structure">Section 4</a>. The message class MUST be a request. The method depends on the method of the request.</p>
<p id="rfc.section.5.2.1.p.2">The requestor MUST add a MESSAGE-INTEGRITY, REALM and USERNAME attribute to the request message. The USERNAME contains a string which is the provisioned username identifying the client to the VAP server. The REALM attribute MUST have the value of "ViPR". The MESSAGE-INTEGRITY is computed as described in <a href="#sec-mi">Section 10.3.3</a>. That computation relies on a 16-byte key.  The 16-byte key for MESSAGE-INTEGRITY HMAC is formed by taking the MD5 hash of the result of concatenating the following five fields: (1) The username, with any quotes and trailing nulls removed, (2) A single colon, (3) The realm, with any quotes and trailing nulls removed, (4) A single colon, and (5) The password, with any trailing nulls removed. Note that the password itself never appears in the message.</p>
<p id="rfc.section.5.2.1.p.3">This format for the key was chosen so as to enable a common authentication database for SIP, which uses digest authentication as defined in RFC 2617 <a href="#RFC2617">[RFC2617]</a>.</p>
<p id="rfc.section.5.2.1.p.4">The request will contain other attributes depending on the method.</p>
<h1 id="rfc.section.5.2.2">
<a href="#rfc.section.5.2.2">5.2.2.</a> Receiving Responses</h1>
<p id="rfc.section.5.2.2.p.1">All responses MUST first be authenticated by the requestor.  Authentication is performed by first comparing the Transaction ID of the response to an outstanding request. If there is no match, the requestor MUST discard the response. Then the requestor SHOULD check the response for a MESSAGE-INTEGRITY attribute. If not present, it MUST discard the response, except for error responses with response codes 431 and 436. If MESSAGE-INTEGRITY is present, the requestor computes the HMAC over the response. The key that is used MUST be same as used to compute the MESSAGE-INTEGRITY attribute in the request.</p>
<p id="rfc.section.5.2.2.p.2">If the computed HMAC matches the one from the response, processing continues. If the response was discarded, in cases where the failure is due to an implementation error, this will cause timeout of the transaction.</p>
<p id="rfc.section.5.2.2.p.3">If the response is an Error Response, the requestor checks the response code from the ERROR-CODE attribute of the response. For a 400 (Bad Request) response code, the requestor SHOULD generate an alarm (a notification here refers to some kind of indication, sent to the administrator of the system, indicating an error condition.  Notification mechanisms include SNMP alarms, logs, syslog, and so on, and are a matter of local implementation) containing the reason phrase.</p>
<p id="rfc.section.5.2.2.p.4">For a 431 (Integrity Check Failure) response code, this is typically caused by a mis-provisioning of the password. The requestor SHOULD generate an alarm and SHOULD NOT retry.</p>
<p id="rfc.section.5.2.2.p.5">If the requestor receives a 436 (Unknown Username) response, it means that the username it provided in the request is unknown. This is typically due to a provisioning error, a consequence of a mismatched username. The requestor SHOULD generate an alarm.</p>
<p id="rfc.section.5.2.2.p.6">The requestor MUST ignore any attributes from the response whose attribute type were not understood by the requestor.</p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> <a href="#sec-responders" id="sec-responders">Responder Behaviors</a>
</h1>
<h1 id="rfc.section.5.3.1">
<a href="#rfc.section.5.3.1">5.3.1.</a> Receiving Requests</h1>
<p id="rfc.section.5.3.1.p.1">A responder will receive requests on an existing TCP connection, either one initiated by the client, or the one accepted by the ViPR server.</p>
<p id="rfc.section.5.3.1.p.2">If a responder cannot process a request because the request does not meet the syntactic requirements necessary for the processing described below, the responder SHOULD reject the request with an error response and include an ERROR-CODE attribute with a response code of 400 (Bad Request). If the request is so malformed that a response cannot be generated, the request is just dropped. Error codes for specific failures are not provided, since these failures would not be seen in a functionally correct system. The protocol only provides error codes for errors that can arise due to misconfiguration or network error. Note, however, that a responder SHOULD NOT verify that a requestor has generated the request in full compliance to this specification; it should only validate what it needs to perform the processing described for handling the request.</p>
<p id="rfc.section.5.3.1.p.3">First, the responder authenticates the request. The request will contain a USERNAME, REALM, and MESSAGE-INTEGRITY attribute. If the USERNAME is unknown, the responder generates an error response with an ERROR-CODE attribute with a response code of 436 (Unknown Username). The response MUST include the REALM, but MUST omit the MESSAGE-INTEGRITY attribute.</p>
<p id="rfc.section.5.3.1.p.4">The responder computes the HMAC over the request. If the computed HMAC differs from the one from the MESSAGE-INTEGRITY attribute in the request, the responder MUST generate an error response with an ERROR-CODE attribute with a response code of 431 (Integrity Check Failure). This response MUST include a REALM but MUST omit the MESSAGE-INTEGRITY attribute.</p>
<p id="rfc.section.5.3.1.p.5">The responder MUST ignore any attributes from the request whose attribute type were not understood by the responder.</p>
<h1 id="rfc.section.5.3.2">
<a href="#rfc.section.5.3.2">5.3.2.</a> Sending Responses</h1>
<p id="rfc.section.5.3.2.p.1">To construct the response the responder follows the message structure described in <a href="#message_structure">Section 4</a>. The message type MUST indicate either a success response or error response class and MUST indicate the same method as the request. The responder MUST copy the transaction ID from the request to the response.</p>
<p id="rfc.section.5.3.2.p.2">The attributes that get added to the response depend on the type of response.</p>
<p id="rfc.section.5.3.2.p.3">When sending an error response, the server MUST add an ERROR-CODE attribute containing the error code. The reason phrase is not fixed, but SHOULD be something suitable for the error code.</p>
<p id="rfc.section.5.3.2.p.4">All responses except for an error response with ERROR-CODE of 431 and 436 will contain a MESSAGE-INTEGRITY attribute. All responses will contain a REALM attribute. The computation of the message integrity is based on the same username value present in the request (along with its corresponding password); however the response SHOULD NOT contain the USERNAME attribute.</p>
<p id="rfc.section.5.3.2.p.5">All responses MUST be sent on the same TCP connection on which the request was received. If this connection has closed, the responder MUST NOT open a new connection in order to try to send the response. The transaction is considered failed in this case.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#sec-state" id="sec-state">State Model</a>
</h1>
<p id="rfc.section.6.p.1">The state model for VAP is shown in Figure <a href="#fig-vap-state">Figure 6</a>. This state is built up as a consequence of the primary messages which build state on the ViPR server: Register, Publish, UploadVCR and Subscribe.</p>
<div id="#rfc.figure.6"></div>
<div id="#fig-vap-state"></div>
<pre>

 +-------+
 |Handle |
 +-------+
    ^1                                            1 +----+
    |1                                    +--------&gt;|DHT |
 +-------+       n+--------+ n            |         +----+
 |Client |&lt;-------|Instance|&lt;------+      |
 +-------+        +--------+       |      |       1 +----------+
    |                 |            |      | +------&gt;|BlackWhite|
    |                 |            |      | |       +----------+
    Vn                |         +-------------+
 +------------+       |         |             |   1 +---------+
 |Subscription|       V         | VService    |----&gt;|NumCount |
 +------------+    +-----+      +-------------+     +---------+
                   |route|           |1    |
                   +-----+           |     |      1 +--------+
                                     |     +-------&gt;|domain  |
                                     |1             +--------+
                               +----------+
                               |VServiceID|
                               +----------+
                                |1      |1
                                |       |
                                Vn      Vn
                         +--------+    +--------+
                         |OrigVCR |    |TermVCR |
                         +--------+    +--------+

</pre>
<p id="rfc.section.6.p.2">It is important to understand that the ViPR client publishes two unique sets of information to the ViPR server:</p>
<p id="rfc.section.6.p.3">1. The set of numbers that are reachable by the client through a particular ViPR service,</p>
<p id="rfc.section.6.p.4">2. The set of ViPR services</p>
<p id="rfc.section.6.p.5">Both of these are uploaded from the client to the ViPR server using a VAP Publish operation. The ViPR clients have the concept of a "ViPR Service" (not to be confused with ViPR server). A ViPR service is a unique instance of ViPR processing in a call agent - and is associated with a specific DHT, specific routes, specific domain, specific set of numbers to use, and specific set of policies governing operation. When a client publishes a number, it is always associated with a specific ViPR service, or VService. Multiple clients can publish the same VServices, and they will differ only in the routes associated with that VService, as each client will have its own route to reach the same VService.</p>
<p id="rfc.section.6.p.6">The ViPR server actively tracks the association of clients, VServices, routes, DHTs, BlackWhite lists, and VServiceIDs. Number publications and VService publications are differentiated from each other by different serviceID values in attributes in the Publish request. To be thoroughly confusing, this serviceID is not the same as a VServiceID. ServiceID refers to whether something is a VService publication or number publication, and is an enumerated value, whereas a VServiceID is an instance ID for a particular VService. The ViPR server only actually stores the VService publications; when receiving a Publish for a number service, the corresponding data is written directly to the DHT and then forgotten by the ViPR server. The ViPR server doesn't take any responsibility for removing the state or for keeping it fresh. All of this is the responsibility of the ViPR client. Consequently, VAP itself is not responsible for maintaining this information.</p>
<p id="rfc.section.6.p.7">Firstly, when a client connects, it will Register to the ViPR server.  That creates an instance of the client object, which is assigned a unique handle that identifies it. The client object is one of the key pieces of state (ViPR service being the other). All subsequent messaging from the client includes that Client-Handle, allowing the ViPR server to immediately determine the client associated with the messaging.</p>
<p id="rfc.section.6.p.8">The client can issue subscriptions for services over its connection to the ViPR server. The ViPR server remembers the set of subscriptions from that client.</p>
<p id="rfc.section.6.p.9">The VService publication builds the next large block of state. When a VService publication is received from a client, the ViPR server creates the VService object if it didn't have one yet for that VServiceID. Each distinct instance of a VService publication gets linked to it, and each distinct instance is, in turn, associated with one or more routes. Each route has a SIP URI, but the internal structure of the route is opaque to the ViPR server. It parses no deeper than the route element itself; the contents are not parsed, examined or checked by the ViPR server.  This allows for future extensibility on how call routing is done. The VService itself has a numberCount, domain, BlackWhite list and DHT, all of which are learned from the VService publication. The VServiceID is 1-1 associated with each VService.</p>
<p id="rfc.section.6.p.10">Finally, each UploadVCR, whether it is originating or terminating, contains a VServiceID as well. This binds it to a particular VService.  It is important to note that, the linkage from VCRs to VServices is indirect, through the VServiceID. This allows a temporary outage to break all client connections, which will delete the VService objects, but keep the VCRs and the VServiceIDs. When the clients reconnect, the VServices are rebuilt, along with their IDs, and once again can be linked to the VCRs.</p>
<p id="rfc.section.6.p.11">When the VAP connection terminates, the client object and subscription state from the corresponding client is destroyed. Any instances of a VService from that client are destroyed. If there are no longer any instances of the VService left, the VService itself is destroyed. The VCRs are not affected by the termination of a connection from a client.</p>
<p id="rfc.section.6.p.12">When the client TCP connection breaks or keepalives cease to be sent, the ViPR server will remove the registration, subscription and VServiceID to SIP trunk/DHT mappings. Similarly, on the client side, if the TCP connection breaks, the client must create a new TCP connection, register without a handle, subscribe and performs its VService publications.</p>
<p id="rfc.section.6.p.13">The VAP state above is, in addition, utterly and completely orthogonal to the state of the DHT itself. That state is driven through number service publications, which cause storage operations into the DHT.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#sec-version" id="sec-version">Protocol Versioning</a>
</h1>
<p id="rfc.section.7.p.1">Each version of VAP has a major and minor version number. This specification describes major version 1, minor version 0. It is anticipated that the protocol may require updating in the future.</p>
<p id="rfc.section.7.p.2">If an update can be done such that an older client will work with a newer server, and an older server with a newer client, this MUST be done using an increase in the minor version number within the major version.  This would typically include bug fixes and minor extensions. If a protocol change is such that it cannot be understood by previous servers and clients, this MUST be done using an increase in the major version number of the protocol.</p>
<p id="rfc.section.7.p.3">This specification further requires that, in addition to the most recent version of the protocol they understand, a client MUST understand the previous major version number. For example, a client supporting version 2.1 would also need to support version 1.0.</p>
<p id="rfc.section.7.p.4">The protocol version number is included in client register messages, and negotiation as part of that exchange.</p>
<p id="rfc.section.7.p.5">This allows for a graceful upgrade procedure. When a new version of the protocol is to be rolled out, the clients are upgraded first, each in turn. When they are upgraded, they'll come back, but during registration, notices that the servers only support a previous major version. The clients thus switch to the previous version of the protocol. Once all of the clients are updated, the servers can be updated. When the clients connect to them, they will utilize the newest version of the protocol.</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> ViPR Client Procedures</h1>
<h1 id="rfc.section.8.1">
<a href="#rfc.section.8.1">8.1.</a> Discovery</h1>
<p id="rfc.section.8.1.p.1">VAP provides no discovery mechanism. The client must be provisioned with the domain names and/or IP addresses and ports of its ViPR servers. Typically, a client will be provisioned with two servers - a primary and a backup.</p>
<h1 id="rfc.section.8.2">
<a href="#rfc.section.8.2">8.2.</a> Registration</h1>
<p id="rfc.section.8.2.p.1">Once a TCP connection is established, the client MUST perform a registration. This applies to all TCP connections held by the client for purposes of high availability.</p>
<p id="rfc.section.8.2.p.2">The client constructs a Register request based on the basic client procedures in <a href="#sec-requestor">Section 5.2</a>. In addition, the client MUST include the Client-Name attribute. This field is used strictly for debugging purposes and indicates the name of the client to the server.</p>
<p id="rfc.section.8.2.p.3">If the client is registering for the first time towards this ViPR server, the registration MUST omit the Client-Handle attribute.</p>
<p id="rfc.section.8.2.p.4">If the client is registering for the first time towards this ViPR server (and thus there was not Client-Handle attribute), the client MUST include a Protocol-Version attribute in the request. This includes the major and minor version number of the most recent version of the protocol supported by the client. For purposes of extensibility, in addition to their current version of the client protocol, a client MUST support the previous major version as well.</p>
<p id="rfc.section.8.2.p.5">The client MUST include the Client-Label attribute in the request.  However, it is not used and its contents are arbitrary.</p>
<p id="rfc.section.8.2.p.6">Once constructed, the client sends the Register request to the ViPR server. The response is processed using the general techniques in <a href="#sec-requestor">Section 5.2</a>. Assuming a success response is ultimately received, it indicates that the client has successfully registered. This response will contain a Client-Handle attribute. The client MUST retain this handle and store it for the lifetime of the clients connection to the server. The response will also contain the Keepalive attribute, which tells the client how often it needs to keepalive its registration to the server.</p>
<p id="rfc.section.8.2.p.7">If the response to the initial Register request (one without a Client-Handle) is an error response with an ERROR-CODE attribute with a response code of 478, it means that the server does not support the major protocol version signaled by the client. The client MUST extract the Protocol-Version attribute from the error response. This attribute indicates the major and minor versions supported by the server. Based on the principles in <a href="#sec-version">Section 7</a>, the client will be able to support a version of the protocol that has a major protocol version matching the one in the Protocol-Version attribute of the error response. The client MUST switch to this version of the protocol, and then MUST generate a new Register request (without a Client-Handle), indicating a Protocol-Version equal to the new, lower version of the protocol.</p>
<p id="rfc.section.8.2.p.8">If the response to the initial Register request (one without a Client-Handle) is an error response with an ERROR-CODE attribute with a response code of 477, it means that the server believes that the client has already registered on this connection. There has been a state synchronization error. The client SHOULD generate an alarm, and then tear down the TCP connection. It MUST open a new TCP connection, and then generate a fresh Register request (without a Client-Handle) over that connection.</p>
<p id="rfc.section.8.2.p.9">If the Register message was for an existing connection (and thus a keepalive), and thus included the Client-Handle attribute in the request, but the response was a Register Error response with an ERROR-RESPONSE with a response code of 471, the client MUST consider this a failure of the connection. It SHOULD attempt a new connection and a new Register, but without a Client-Handle.</p>
<p id="rfc.section.8.2.p.10">During an initial Register (one that omits Client-Handle), the client MUST NOT generate any subsequent requests until that Register transaction completes.</p>
<p id="rfc.section.8.2.p.11">If the TCP connection fails, the client needs to reconnect and create a new registration without the handle, and furthermore, resubscribe and republish as needed. In other words, on the client side, the lifetime of the handle is equal to the lifetime of the TCP connection. The server also holds onto the handle as long as the connection is active. However, it will also watch for refreshes of registrations, and if it doesn't see one fast enough, remove the client registration, the handle, and state received from that client, as well.</p>
<h1 id="rfc.section.8.3">
<a href="#rfc.section.8.3">8.3.</a> Unregistering</h1>
<p id="rfc.section.8.3.p.1">A Client that wishes to terminate its connection gracefully does so using the Unregister request. This request is first constructed as described in <a href="#sec-requestor">Section 5.2</a>. Once constructed, the client MUST add the Client-Handle attribute to the request, and send it to the ViPR server.</p>
<p id="rfc.section.8.3.p.2">If the response was an error response and was of type 400, it means that the client did not construct the request properly. The client MUST NOT retry unless it changes the content or set of attributes in the request to match the requirements defined here.</p>
<p id="rfc.section.8.3.p.3">If the response was an error response with an ERROR-RESPONSE attribute with a response code of 471, the client MUST consider this a failure of the connection. It indicates a synchronization error between client and server. The client SHOULD generate an alarm.</p>
<p id="rfc.section.8.3.p.4">If the response was an error response and was of type 474, it means that the client sent an Unregister request on a TCP connection but had not yet registered. If the client had registered, there has been some kind of synchronization error. The client SHOULD generate an alarm.</p>
<p id="rfc.section.8.3.p.5">In all cases, success or error responses, the client MUST consider all subscriptions to this server terminated, and consider all published VServices to this server as unpublished. The client MUST terminate the TCP connection after the response has been received.</p>
<h1 id="rfc.section.8.4">
<a href="#rfc.section.8.4">8.4.</a> Publishing Services</h1>
<p id="rfc.section.8.4.p.1">Publish requests inform the ViPR server of information from the client. There are two types, VService publications and number publications. These differ in the value of the ServiceIdentity attribute.</p>
<p id="rfc.section.8.4.p.2">All publications contain a ServiceContent attribute which contains an XML element that defines the service. The schema for the ServiceContent element depends on whether the publication is a VService or number publication.</p>
<p id="rfc.section.8.4.p.3">The Publish request MUST contain a ServiceVersion attribute. This attribute is a version number that increments by at least one every time a particular service (identified by a unique VService, instance, service ID and sub-service ID value) changes in any way. If the service data different from the previous published value, the ServiceVersion attribute MUST increase. If the service data is the same as the previous published value, the ServiceVersion SHOULD stay the same, but MAY increase. Consequently, increasing version numbers are not a guarantee that there was a change; only that lack of increasing version number is a guarantee that there was no change.</p>
<p id="rfc.section.8.4.p.4">If a client loses track of the previous version number of the service (due, for example, to a restart), it MUST choose a new instance ID and then it can reset the ServiceVersion.</p>
<p id="rfc.section.8.4.p.5">Finally, the Publish Request MUST contain a ServiceContent attribute. This attribute contains the actual service data. Its actual structure and syntax are a function of the service and sub-service.</p>
<p id="rfc.section.8.4.p.6">If the response was an error response and was of type 472, it means that the client didn't increment the sequence number. More likely, it indicates that the client has inadvertently forgotten the version number of the service and gotten out of sync with the server. The client SHOULD choose a new instance ID for this service, withdraw the old one, and publish the new one.</p>
<p id="rfc.section.8.4.p.7">If the response was an error response and was of type 474, it means that the client sent a Publish request on a TCP connection but had not yet registered. If the client hadn't registered, it MUST now do so. If it had registered, there has been some kind of synchronization error.  The client SHOULD generate an alarm. Then, it MUST generate a new register (without the Client-Handle), flushing all subscriptions.</p>
<p id="rfc.section.8.4.p.8">If the response was an error response and was of type 400, it means that the client did not construct the request properly. The client MUST NOT retry unless it changes the content or set of attributes in the request to match the requirements defined here.</p>
<p id="rfc.section.8.4.p.9">If the response was a success, the publication has been accepted.</p>
<h1 id="rfc.section.8.4.1">
<a href="#rfc.section.8.4.1">8.4.1.</a> VService</h1>
<p id="rfc.section.8.4.1.p.1">The VService indicates the critical information for the VService identified by the VService ID. Typically, a call agent will run on many servers, each of which is listening for SIP traffic on a specific IP address and port. Each such IP address and port forms a particular instance of the VService, and represents an alternative SIP destination for receiving incoming calls. The instance ID is a unique identifier, within the scope of the VServiceID, which identifies that call agent server.</p>
<p id="rfc.section.8.4.1.p.2">The additional information placed into the VService publication will not vary amongst different instances. That information is:</p>
<p></p>

<ul>
<li>The DHT that the client wishes its numbers to be published into for this VService. This must always be the name of the public ViPR DHT, which is "Quetzalcoatl".</li>
<li>The domain name associated with this VService, e.g., example.com. This domain name is used by the ViPR server at the end of the validation process.</li>
<li>The set of routes which can be used to reach a SIP server on the call agent instance. Each route contains a SIP URI, in addition to extensions to allow for future advanced routing.  This parameter of the VService data is instance specific.</li>
<li>a black/white list of domains. These are used by the ViPR server during the validation protocol. The white list contains the set of domains that this domain wishes to only federate with. The black list contains the list of domains that this domain does not wish to federate with.</li>
<li>A count of the number of phone numbers being published for this VService. This is used for quota management on the ViPR server.</li>
</ul>
<p id="rfc.section.8.4.1.p.4">Note that the VService does not contain phone numbers. VService information is not stored into the DHT by the ViPR server. It is stored locally on the ViPR server and used to support the validation protocol.</p>
<p><a href="#sec-xml-vservice">Section 10.1</a> defines the XML schema for the object included in the Publish request.</p>
<p id="rfc.section.8.4.1.p.6">The SIP URI is constructed as follows:</p>
<p></p>

<ol>
<li>The scheme MUST be sip.</li>
<li>The user part MUST be an identifier which is unique to this agent and is identical for all instances of that call agent. For example, if a call agent consists of two servers for purposes availability, and either can be used, the user part will be identical in the SIP URI published by each server.</li>
<li>The domain part MUST be the domain associated with this call agent, and MUST match certificates that the domain can obtain.</li>
<li>There MUST be a port and it MUST be the port on which incoming SIP invites can be received.</li>
<li>There MUST be an maddr URI parameter, and it MUST contain the IP address or hostname of the instance of the call agent server.</li>
<li>The transport URI parameter MUST be present and MUST be TCP.</li>
</ol>
<p id="rfc.section.8.4.1.p.8">There will be one or more URI per each instance of the call agent. The IP address in the URI MUST be a publicly reachable one.  If the call agent is to be reached through a border element, the IP address and port on the border element MUST be used here.</p>
<p id="rfc.section.8.4.1.p.9">The use of the IP address in the maddr parameter allows the system to operate without DNS support.</p>
<p id="rfc.section.8.4.1.p.10">An example document for a VService on the public DHT is:</p>
<div id="#rfc.figure.7"></div>
<div id="#fig-example-vpub"></div>
<pre>

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;service-description
xmlns="http://www.cisco.com/namespaces/saf-uc" id="has7gg"
xmlns:vt="http://www.cisco.com/namespaces/viprtrunk"
schemaVersion="1.0"&gt;
&lt;tns:vservice xmlns:tns="http://www.cisco.com/namespaces/viprtrunk"&gt;
 &lt;tns:DHTname&gt;Quetzalcoatl&lt;/tns:DHTname&gt;
 &lt;tns:DIDCount&gt;3670&lt;/tns:DIDCount&gt;
 &lt;tns:domain&gt;example.com&lt;/tns:domain&gt;
 &lt;tns:whitelist&gt;
   &lt;tns:domain&gt;example.com&lt;/tns:domain&gt;
   &lt;tns:domain&gt;foo.edu&lt;/tns:domain&gt;
 &lt;/tns:whitelist&gt;
 &lt;tns:route&gt;
   &lt;tns:SIPURI&gt;
sip:17ahhs7zpaksux6z5==@example.com:2371;maddr=1.2.3.4;transport=tcp
   &lt;/tns:SIPURI&gt;
 &lt;/tns:route&gt;
 &lt;/tns:vservice&gt;
&lt;/service-description&gt;

</pre>
<p id="rfc.section.8.4.1.p.11">The ViPR client SHOULD publish each ViPR trunk service to both its primary and backup ViPR server, for purposes of HA.</p>
<h1 id="rfc.section.8.4.2">
<a href="#rfc.section.8.4.2">8.4.2.</a> ViPR Number Service</h1>
<p id="rfc.section.8.4.2.p.1">The ViPR number service is used to publish the numbers that are associated with the VService. It is published as a separate service due to the differing state requirements associated with the numbers.  For the VService, the ViPR server stores the information and does not actually publish it into the DHT. For ViPR number service, the ViPR server immediately writes the data into the DHT and doesn't actually store it locally. The ViPR server does not refresh the data in the DHT on its own, nor does it withdraw the data from the DHT when the client disconnects. The ViPR client is responsible for refreshing the data in the DHT by periodically refreshing each of its numbers in each DHT. The numbers in the DHT have a configurable expiration. Consequently, the ViPR client has to refresh the data prior to the expiration. There is no way in VAP to remove a number from the DHT; it is merely left to expire.</p>
<p id="rfc.section.8.4.2.p.2">The ViPR client SHOULD publish each service to both its primary and backup ViPR server, for purposes of HA. Next, the client constructs a ViPR number service advertisement. Unlike VService advertisements, which utilize an XML object in the ServiceContent attribute, number services utilize only VAP attributes. The Publish message will contain a ServiceIdentity attribute and a CalledNum attribute. The VServiceID of the ServiceIdentity attribute indicates the VService for this number, and is used by the ViPR server to determine which DHT to publish into. The CalledNum attribute contains the number to be published into the DHT. The ServiceVersion attribute is not present.</p>
<h1 id="rfc.section.8.5">
<a href="#rfc.section.8.5">8.5.</a> Updating the VService</h1>
<p id="rfc.section.8.5.p.1">A client can change the VService information at any time.  Typically, changes in the black or white list will require an updated VService publication, as will changes in the set of servers listening for incoming SIP traffic.</p>
<p id="rfc.section.8.5.p.2">To update a VService, the client modifies its service description, and creates a new Publish request. This request is first formed as described in <a href="#message_structure">Section 4</a>. This request MUST contain the ServiceIdentity attribute, identifying the service to be modified. The request MUST also contain the ServiceContent attributes, containing the relevant information for the service.</p>
<p id="rfc.section.8.5.p.3">The request MUST contain a ServiceVersion attribute. That version number MUST be at least one higher than the version number in the previous publication for the same service (as identified by service ID, subservice ID and instance).</p>
<p id="rfc.section.8.5.p.4">If the response was an error response and was of type 472, it means that the client didn't increment the sequence number. More likely, it indicates that the client has inadvertently forgotten the version number of the service and gotten out of sync with the server. The client SHOULD choose a new instance ID for this service, unregister, reconnect, re-register, and republish.</p>
<p id="rfc.section.8.5.p.5">If the response was an error response and was of type 474, it means that the client sent a Publish request on a TCP connection but had not yet registered. If the client hadn't registered, it MUST now do so. If it had registered, there has been some kind of synchronization error.  The client SHOULD generate an alarm. Then, it MUST generate a new register (without the Client-Handle).</p>
<p id="rfc.section.8.5.p.6">If the response was an error response and was of type 400, it means that the client did not construct the request properly. The client MUST NOT retry unless it changes the content or set of attributes in the request to match the requirements defined here.</p>
<p id="rfc.section.8.5.p.7">If a client is no longer capable of receiving SIP requests at the URI it previously published, it should remove its VService by sending an Unpublish request.</p>
<h1 id="rfc.section.8.6">
<a href="#rfc.section.8.6">8.6.</a> Uploading VCRs</h1>
<p id="rfc.section.8.6.p.1">When the call agent initiates or receives a call that goes towards the PSTN, whether it be through a PSTN gateway or through a SIP trunk to a service provider, the call agent MUST send an UploadVCR request to its primary server ViPR server. It SHOULD send its terminating UploadVCRs to its secondary ViPR server, and SHOULD NOT send its originating UploadVCRs to its secondary. The UploadVCR request is first constructed like any other VAP request. This means it will contain the USERNAME, REALM, and MESSAGE-INTEGRITY attributes.</p>
<p id="rfc.section.8.6.p.2">In addition, it MUST contain a CallingNum, CalledNum, StartTime and StopTime attribute. The CallDirection attribute is set as described in <a href="#sec-calld">Section 10.3.14</a>.</p>
<p id="rfc.section.8.6.p.3">The UploadVCR request MUST contain a ServiceIdentity attribute. The serviceID is 100, the subservice ID is 3 (ViPR number service) and the VService ID must identify the VService for which this UploadVCR is associated. The instance is arbitrary and are ignored by the ViPR server.</p>
<p id="rfc.section.8.6.p.4">If the response was an error response and was of type 474, it means that the client sent a UploadVCR request on a TCP connection but had not yet registered and had not yet sent a VService publication with a VServiceID matching that of the UploadVCR. If the client hadn't registered and published a matching VService, it MUST now do so. If it had, there has been some kind of synchronization error. The client SHOULD generate an alarm. Then, it MUST disconnect, generate a new register (without the Client-Handle) and a new VService publication.</p>
<p id="rfc.section.8.6.p.5">If the response was an error response and was of type 400, it means that the client did not construct the request properly. The client MUST NOT retry unless it changes the content or set of attributes in the request to match the requirements defined here.</p>
<h1 id="rfc.section.8.7">
<a href="#rfc.section.8.7">8.7.</a> Subscribing to Number Service</h1>
<p id="rfc.section.8.7.p.1">In order to learn about validated numbers, a ViPR client MUST subscribe for the ViPR Number Service. The client should subscribe to just its primary ViPR server.</p>
<p id="rfc.section.8.7.p.2">To create a subscription, the client creates a Subscribe request.  The request is formed as described in <a href="#message_structure">Section 4</a>. It MUST NOT be sent if the client has not previously generated a successful Register request on this connection.</p>
<p id="rfc.section.8.7.p.3">Each initial Subscribe request MUST omit the SubscriptionID attribute; that attribute is only used when withdrawing a subscription. The client MUST include a ServiceIdentity attribute in the request. The service ID MUST be 101, the subserviceID MUST be 3, the VServiceID MUST be the VServiceID for the VService from which learned numbers are desired, and the instance value MUST be all ones.  This will cause the client to receive notifications upon validated numbers learned as a consequence of an UploadVCR for that VService.</p>
<h1 id="rfc.section.8.8">
<a href="#rfc.section.8.8">8.8.</a> Unsubscribing to Services</h1>
<p id="rfc.section.8.8.p.1">A client MAY terminate a subscription at any time. To do that, it sends an Unsubscribe request. This request MUST contain the SubscriptionID attribute identifying the subscription to be terminated. Note that this unsubscription will affect only the subscription identified by the subscription ID. Other subscriptions will continue to be in effect.</p>
<p id="rfc.section.8.8.p.2">The client MAY generate additional Unsubscribe requests while the transactions for previous Subscribe, Publish or Unpublish requests are in progress. By definition a client can only Unsubscribe a subscription for which it had already received a successful response to a Subscribe request that created the subscription.</p>
<p id="rfc.section.8.8.p.3">If the response was an error response and was of type 474, it means that the client sent a Subscribe request on a TCP connection but had not yet registered. If the client hadn't registered, it MUST now do so. If it had registered, there has been some kind of synchronization error. The client SHOULD generate an alarm. Then, it MUST generate a new register (without the Client-Handle).</p>
<p id="rfc.section.8.8.p.4">If the response was an error response and was of type 476, it means that the client sent an Unsubscribe request for a subscription which does not exist. The client SHOULD generate an alarm, since a synchronization error has occurred. It should however proceed as if the withdrawal was successful.</p>
<p id="rfc.section.8.8.p.5">If the response was an error response and was of type 400, it means that the client did not construct the request properly. The client MUST NOT retry unless it changes the content or set of attributes in the request to match the requirements defined here.</p>
<h1 id="rfc.section.8.9">
<a href="#rfc.section.8.9">8.9.</a> Receiving Notify</h1>
<p id="rfc.section.8.9.p.1">The ViPR server will generate a Notify request when a new number and route are learned. It will send this Notify request to all clients which have subscribed to the corresponding VService.</p>
<p id="rfc.section.8.9.p.2">Once the client has received a successful response to its Subscribe request, the client MUST be prepared to receive Notify requests on the TCP connection to its ViPR server. When the client receives a Notify request, it searches for the SubscriptionID attribute in the request.  This informs the client of the subscription that this notification is associated with. If this subscriptionID is known to the client, it proceeds. Otherwise, it MUST generate a Notify error response with a 476 response code in an ERROR-RESPONSE attribute. When this occurs, there has been a synchronization error between the client and server in the set of valid subscriptions. This event SHOULD be alarmed, and the contents of the Notify not used.</p>
<p id="rfc.section.8.9.p.3">The Notify request will contain a ServiceIdentity attribute and a ServiceContent attribute, in addition to the standard authentication attributes and the SubscriptionID attribute. The ViPR client must verify that the ServiceIdentity has service 100, subservice 3. It looks at the instance value, and checks that the topmost 64 bits of the instance contain a VServiceID that matches one for which the ViPR client is currently interested in learning about. The ViPR client then extracts the contents of the ServiceContent attribute. This will be an XML object, formatted as described below.</p>
<p id="rfc.section.8.9.p.4">The client SHOULD store the phone number, SIP URI and Ticket. When receiving a future call to that phone number, it SHOULD send a SIP INVITE request to the SIP URI and include the ticket in an X-Cisco-ViPR-Ticket header field.</p>
<h1 id="rfc.section.8.10">
<a href="#rfc.section.8.10">8.10.</a> Receiving PublishRevoke</h1>
<p id="rfc.section.8.10.p.1">The PublishRevoke method is defined only for the VService, not for the Number Service. The ViPR server will send a PublishRevoke for a VService if the corresponding DHT is no longer available. The request will contain the ServiceIdentity attribute, which indicates the specific VService and instance that are being withdrawn. If these correspond to a known VService, the client should consider that service deactivated, and periodically try to republish it.</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> ViPR Server Procedures</h1>
<h1 id="rfc.section.9.1">
<a href="#rfc.section.9.1">9.1.</a> Connection Establishment</h1>
<p id="rfc.section.9.1.p.1">The ViPR server MUST be prepared to receive incoming TCP or TLS connections on a configure port. Whether or not TCP or TLS is used, is a configured property of that port.</p>
<h1 id="rfc.section.9.2">
<a href="#rfc.section.9.2">9.2.</a> Registration </h1>
<p id="rfc.section.9.2.p.1">The purpose of registrations is to create VAP client objects, which represent a VAP connection and contain the state described in <a href="#sec-state">Section 6</a>, and then link those with a TCP connection.  Each VAP connection can be considered a client object, linked to one and only one TCP connection at a time.</p>
<p id="rfc.section.9.2.p.2">The first request that the server will receive over the TCP connection will be a Register request. This request is first processed as described in <a href="#sec-responders">Section 5.3</a>. Assuming those procedures succeed, the server checks for the Client-Handle attribute in the Register request. If present, the server checks if it currently has a client state object with that handle. If the client object was already bound to another TCP connection, that other TCP connection MUST be closed by the server, and then the new TCP connection MUST be bound to the client object.</p>
<p id="rfc.section.9.2.p.3">If the Register request had a Client-Handle attribute, but there were no client objects with that handle, the server MUST generate an error response and MUST include an ERROR-CODE attribute with a response code of 471. This is due to a state synchronization error between the client and server. The server SHOULD generate an alarm.</p>
<p id="rfc.section.9.2.p.4">If the Register did not have a Client-Handle attribute, it is a request to create a client object. The server examines the Protocol-Version attribute from the request. If the major version indicated in the attribute is higher than the version supported by the server, the server MUST reject the Register request with an error response and include an ERROR-CODE attribute with a response code of 478. That error response MUST include a Protocol-Version attribute that contains the major and minor protocol versions supported by the server.</p>
<p id="rfc.section.9.2.p.5">Next, the server MUST create a new client object, and allocate a new Client-Handle for it. The Client-Handle MUST be unique amongst all other Client-Handles known to this server, across all clients that are connected to it.</p>
<p id="rfc.section.9.2.p.6">If the registration succeeds, the server sends a success response.  This response MUST include the Client-Handle attribute containing the handle created by the server. The response MUST include a Keepalive attribute, indicating the time in milliseconds that the server will need to see traffic from the client in order to continue to maintain the client object.</p>
<h1 id="rfc.section.9.3">
<a href="#rfc.section.9.3">9.3.</a> Unregistration</h1>
<p id="rfc.section.9.3.p.1">The client can gracefully disconnect by using an Unregister request.</p>
<p id="rfc.section.9.3.p.2">If the server receives an Unregister request on a TCP connection, it first looks for the client object bound to that connection. If there is no client object bound to it, it means that the client has sent an Unregister request prior to registering, or there has been some kind of synchronization error. The server MUST respond with an error response, and MUST include an ERROR-CODE attribute with a response code of 474.</p>
<p id="rfc.section.9.3.p.3">Otherwise, if the client object is known to the server, it MUST generate a success response. Once it does, the server MUST destroy the client, its associated subscriptions, and published VService instances. It then sets a timer equal to thirty seconds. If the client has not closed the TCP connection bound to this client object, the server MUST close the TCP connection.</p>
<p id="rfc.section.9.3.p.4">If, as a consequence of the deletion of those VService instances, there are no longer any instances left for a VService, that VService and its associated data (BlackWhite, DHT, numberCount) are removed.</p>
<p id="rfc.section.9.3.p.5">Note that unregistration does not ever remove VCRs.</p>
<h1 id="rfc.section.9.4">
<a href="#rfc.section.9.4">9.4.</a> Publication</h1>
<p id="rfc.section.9.4.p.1">Behavior depends on whether the publication is for the VService or the ViPR number service.</p>
<p id="rfc.section.9.4.p.2">The ViPR server extracts the ServiceIdentity attribute. If the value is not one of the following:</p>
<p></p>

<ol>
<li>ServiceID is 101 and SubserviceID is 3.</li>
<li>ServiceID is 101 and SubserviceID is 4</li>
</ol>
<p id="rfc.section.9.4.p.4">the ViPR server sends a 400 response.</p>
<h1 id="rfc.section.9.4.1">
<a href="#rfc.section.9.4.1">9.4.1.</a> VService</h1>
<p id="rfc.section.9.4.1.p.1">If the Publish request is for service 100, sub-service 4, it indicates that this was for the VService. The ViPR server first looks for the client object bound to that connection. If there is no client object bound to it, it means that the client has sent a Publish request prior to registering, or there has been some kind of synchronization error. The server MUST respond with an error response, and MUST include an ERROR-CODE attribute with a response code of 474.</p>
<p id="rfc.section.9.4.1.p.2">The ViPR server extracts the contents of the ServiceContent attribute. This will be an XML object structured as defined in <a href="#sec-xml-vservice">Section 10.1</a>. It also extracts the VServiceID and Instance values from the ServiceIdentity attribute.</p>
<p id="rfc.section.9.4.1.p.3">First, the ViPR server checks if it has any VService objects with the VServiceID from the publish.</p>
<p></p>

<ul>
<li>If it does, it replaces the BlackWhite, numberCount, domain, and DHTName parameters of that VService with the ones from the publish. Next, it checks to see if the instance is currently an instance associated with that VService:</li>
<li><ul>
<li>If it is, the route elements for that instance are replaced with the route values from the publish.</li>
<li>If it is not, a new instance object is created, associated with the client and the VService, and is linked with the route values from the publish.</li>
</ul></li>
<li>If it does not, it creates a new VService object, and associates it with the values of the BlackWhite, numberCount, domain, and DHTName parameters of the VService. Next, it creates a new instance, associates it with the VService, The route values from the publish are associated with that instance.</li>
</ul>
<p id="rfc.section.9.4.1.p.5">ViPR server sends a Publish success response. The ViPR server looks for all other ViPR services in the same DHT as the one from this Publish, it sums up their numberCounts, and includes that value in the "current" field of the Quota attribute in the Publish response. Since there is a limit on the count of the numbers that can be published into the DHT, this mechanism allows the ViPR server to inform the clients about the total usage across all clients of this ViPR server. Note further, that since the ViPR server itself does not have local memory of the numbers it stored into the DHT, the ViPR server cannot determine how many numbers have been placed into the DHT for a particular VService. That information is known only to the client. That is why the client informs the ViPR server of how many numbers it has published as part of the VService publication.</p>
<p id="rfc.section.9.4.1.p.6">The ViPR server places its configured per-DHT limit for that DHT into the "limit" field in the Quota attribute in the Publish response. This tells the clients the maximum count of phone numbers which can be published.</p>
<p id="rfc.section.9.4.1.p.7">The ViPR server includes a DHTLifetime attribute in the response.  This attribute indicates the amount of time that data will remain in the DHT prior to be expunged. This is a configured property of the DHT.</p>
<h1 id="rfc.section.9.4.2">
<a href="#rfc.section.9.4.2">9.4.2.</a> ViPR Number Service</h1>
<p id="rfc.section.9.4.2.p.1">If the server receives a Publish request for service 100, sub-service 3, it indicates that this was for the ViPR Number Service. The ViPR server first looks for the client object bound to that connection. If there is no client object bound to it, it means that the client has sent a Publish request prior to registering, or there has been some kind of synchronization error. The ViPR server MUST respond with an error response, and MUST include an ERROR-CODE attribute with a response code of 474. The ViPR server extracts the VServiceID from the ServiceIdentity attribute. It checks that, for that VServiceID, there is a VService object currently being stored.  If not, the ViPR server MUST respond with an error response, and MUST include an ERROR-CODE attribute with a response code of 474.</p>
<p id="rfc.section.9.4.2.p.2">Next, the ViPR server extracts the number from the CalledNum attribute. The ViPR server extracts the DHT from the VService object associated with the VServiceID from the Publish. For the number, the ViPR server takes the number and treats it as an ASCII string, called the suffix seed.</p>
<p id="rfc.section.9.4.2.p.3">Next, the ViPR server generates two additional strings. The first is formed by taking the suffix seed, and prepending the string "COPY1". The second is formed by taking the suffix seed and prepending the string "COPY2".</p>
<p id="rfc.section.9.4.2.p.4">Each of the three values is passed through the SHA-1 hash function, producing 160 bits. The least significant 128 bits of this are taken. Those 128 bits, for each of the three values, form the Resource-ID against which a STORE is to be performed. Three separate stores are performed in order to provide security in the DHT. Each store operation writes an object into the DHT whose value is a dictionary (or map) entry.</p>
<p id="rfc.section.9.4.2.p.5">Conceptually:</p>
<div id="#rfc.figure.8"></div>
<pre>
Store(Resource-ID, object)
</pre>
<p id="rfc.section.9.4.2.p.6">Where Resource-ID is the 128 bit Resource-ID computed above. The stored object is a dictionary entry which has a key and a value:</p>
<div id="#rfc.figure.9"></div>
<pre>
Object = {key,value}
</pre>
<p id="rfc.section.9.4.2.p.7">Here, the key is formed by taking the peerID of the storing node in hex format, without the "0x", appending a "+", followed by the VServiceID in hex format, without the "0x". For example, if a peer with peerID 0x8e60f5fab753037f64ab6c53947fd532 receives a Publish with a VServiceID of 0x7eeb6a7036478351, the resulting key is:</p>
<div id="#rfc.figure.10"></div>
<pre>
8e60f5fab753037f64ab6c53947fd532+7eeb6a7036478351
</pre>
<p id="rfc.section.9.4.2.p.8">Both parts of this key are important. Using the peerID of the node performing the store basically segments the keyspace of the dictionary so that no two peers ever store using the same key.  Indeed, the responsible node will verify the signature over the stored data and check the peerID against the value of the key, to make sure that a conflict does not take place. The usage of the VService allows for a single ViPR server to service multiple call agents, and to ensure that numbers published by one call agent (using one VServiceID) do not clobber or step on numbers published by another call agent (using a different VServiceID). The responsible node does not verify or check the VServiceID.</p>
<p id="rfc.section.9.4.2.p.9">In this version of the protocol, only one of the three stored objects is read. Three are stored to allow an enhancement in the future, which will read all three and use a simple voting algorithm to handle inconsistencies in the results. In this way, if a malicious node returns no result or fakes the result, as long as the remaining two results are retrieved, the validation process can continue. This means that the compromise of a single node has, with only extremely low probability (order Log(N)/N where N is the number of nodes in the ring) of being able to disrupt validation against a number.</p>
<p id="rfc.section.9.4.2.p.10">The value of the dictionary entry is a sequence of TLV attributes, with the same format used by VAP. In this case, it is a single attribute, the peerID attribute. This attribute is populated with the peerID of the ViPR server in the DHT into which the STORE is being performed. The reason for using the TLV construct is to provide extensibility in the contents of the DHT. In the future, if needed, new ViPR nodes can add additional data, each with a specific attribute type. Older nodes will ignore any unknown attributes and go right for the peerID attribute, while newer ones can process the new and old attributes.</p>
<p id="rfc.section.9.4.2.p.11">The Store operations are paced into the DHT at a fixed rate. The ViPR server maintains a queue. This queue is filled with store requests. The ViPR server services that queue at a fixed, provisioned rate, the Store Rate Limit. When serviced, the next Store operation in the queue is serviced. Because transactions from clients are pipelined, there can only be as many Store operations in the queue as there are simultaneously connected clients, times three (three Stores per Publish, one Publish at a timer per client). The Publish is then responded to with a success response. Note that, a success response is not sent until all three Store operations have been performed. If there is a failure due to inability to store into the DHT, the server returns a 481 error response. Note that a ViPR server cannot disambiguate the first Publish for a service and an updated Publish. It performs identical processing for each.</p>
<p id="rfc.section.9.4.2.p.12">Note further that, the DHT itself will replicate each of the three stored values, producing a total of nine copies of each number into the DHT.</p>
<h1 id="rfc.section.9.5">
<a href="#rfc.section.9.5">9.5.</a> Unpublish</h1>
<p id="rfc.section.9.5.p.1">The ViPR client can only Unpublish for the VService.</p>
<p id="rfc.section.9.5.p.2">The ViPR server extracts the VServiceID and instance from the ServiceIdentity in the Unpublish. It checks to see if there is an instance with that ID associated with the VService with that VServiceID. If there is, it removes the instance object and its associated SIPURI. If, as a consequence, there are no longer any instances associated with the VService, it deletes the VService object and its associated attributes.</p>
<h1 id="rfc.section.9.6">
<a href="#rfc.section.9.6">9.6.</a> Subscribe</h1>
<p id="rfc.section.9.6.p.1">If the server receives a Subscribe request on a connection, it first looks for the client object bound to that connection. If there is no client object bound to it, it means that the client has sent a Subscribe request prior to registering, or there has been some kind of synchronization error. The server MUST respond with an error response, and MUST include an ERROR-CODE attribute with a response code of 474.</p>
<p id="rfc.section.9.6.p.2">The ViPR server checks that the ServiceIdentity from the request.  If verifies that the ServiceID is 101 and the SubServiceID is 3. Any other combination causes the server to return a 400 response. The subscription is to the VServiceID identified in the ServiceIdentity attribute.</p>
<p id="rfc.section.9.6.p.3">If the ServiceIdentity is valid, the server MUST create a new subscription object. It MUST allocate a SubscriptionID for this subscription. This ID MUST be unique across all SubscriptionIDs associated with this client. The subscription MUST be linked with the client object. It is not permitted for there to be multiple subscriptions from a client with identical VServices since each subscription is for a unique service/subservice/VServiceID/instance, the ViPR server can hash these to get a 32 bit SubscriptionID, or assign them sequentially and store the associations.</p>
<p id="rfc.section.9.6.p.4">The ViPR server then checks the VServiceID from the ServiceIdentity attribute. The ViPR server adds a subscription object to the client object, and associates it with a SubscriptionID and the VServiceID which is being watched.</p>
<p id="rfc.section.9.6.p.5">The server then generates a success response to the Subscribe request. It MUST include the SubscriptionID attribute in the response, identifying this subscription.</p>
<h1 id="rfc.section.9.7">
<a href="#rfc.section.9.7">9.7.</a> Unsubscribe</h1>
<p id="rfc.section.9.7.p.1">If the server receives an Unsubscribe request on a connection, it first looks for the client object bound to that connection. If there is no client object bound to it, it means that the client has sent an Unsubscribe request prior to registering, or there has been some kind of synchronization error. The server MUST respond with an error response, and MUST include an ERROR-CODE attribute with a response code of 474.</p>
<p id="rfc.section.9.7.p.2">Next, the server extracts the SubscriptionID attribute from the request. If it contains a SubscriptionID not known to the server, there has been a synchronization error. The server MUST reject the Unsubscribe request with an error response and MUST include an ERROR-CODE attribute with a value of 476.</p>
<p id="rfc.section.9.7.p.3">Assuming the SubscriptionID is known, the server MUST remove the subscription object from the client object, and destroy it. The server will therefore no longer send notifications associated with this subscription. The server MUST respond to the Unsubscribe request with a success response.</p>
<h1 id="rfc.section.9.8">
<a href="#rfc.section.9.8">9.8.</a> UploadVCR</h1>
<p id="rfc.section.9.8.p.1">The ViPR server first processes the request like any other VAP request, specifically it will perform the message integrity check and follow associated procedures.</p>
<p id="rfc.section.9.8.p.2">If the UploadVCR was received on a TCP connection but the client had not yet registered over that connection, it is an error and the ViPR server returns a 474. If the client had registered, but the VServiceID from the ServiceIdentity doesn't match a known VService, the UploadVCR is rejected with a 474.</p>
<p id="rfc.section.9.8.p.3">Otherwise, the ViPR server extracts the CallDirection, StartTime, StopTime, CallingNum and CalledNum attributes, and stores them.  Further processing depends on whether it was an originating or terminating UploadVCR.</p>
<h1 id="rfc.section.9.8.1">
<a href="#rfc.section.9.8.1">9.8.1.</a> Originating</h1>
<p id="rfc.section.9.8.1.p.1">Once stored, the ViPR server starts timer Tv. Tv is selected as a random number, in seconds, starting from 30 and ending at the maximum validation time, which is a configured parameter of the ViPR Server for the DHT associated with the VService. The validation request - which includes the VCR - is stored until that timer fires.  The validation request includes the details from the UploadVCR (calling, called numbers, start and stop time), along with the VService associated with the UploadVCR.</p>
<p id="rfc.section.9.8.1.p.2">When the timer fires, the ViPR server examines the called party number. This number will be a plus followed by N digits. Using this number, it forms a lookup key K. K is equal to the least significant 128 bits of the SHA1 hash of the called party number in string form, including the + sign. Next, the ViPR server extracts VService associated with the VCR. It checks to see if this VService is currently being published. If so, it performs a lookup into the DHT using key K. Each DHT node has a queue on read transactions. These lookups are queued because the node has, per-DHT, a limit on the rate at which it will perform read requests.</p>
<p id="rfc.section.9.8.1.p.3">Once the lookup request comes to the top of the queue and it can be serviced, the resulting fetch will be a result, a no-match, or a timeout. If there is a no-match or timeout, ViPR server processing is complete.</p>
<p id="rfc.section.9.8.1.p.4">If there is a result, the ViPR server will now have all of the dictionary entries associated with the Resource-ID. Each dictionary entry is a key and a value. The key is the concatenation of a peerID and VServiceID, and the value is a set of TLV attributes. The ViPR server parses each dictionary entry as a sequence of TLV attributes, and extracts the first TLV value whose type is peerID (type 0x2008).  From this, the ViPR server obtains a set of {peerID, VServiceID}s.</p>
<p id="rfc.section.9.8.1.p.5">The ViPR server SHOULD perform validation, using the validation protocol <a href="#VIPR-PVP">[VIPR-PVP]</a>. A ViPR server MAY use any algorithm of its choosing to determine whether a number should be validated once, many times, or not at all. When the ViPR server is satisfied that a number has been sufficiently validated, it SHOULD send a Notify. Furthermore, during validation, the ViPR server SHOULD compare the domain of the learned number with the blacklist for the VService associated with the matching VCR. If the domain is on the blacklist or not on the whitelist, a Notify SHOULD NOT be sent.</p>
<p id="rfc.section.9.8.1.p.6">If a Notify is to be sent as a consequence of a validation success, the ViPR server looks to see if there is currently a subscription from a client whose VServiceID matches the one from the VCR that triggered the validation that is causing the notification.  For each matching one, it sends a Notify message. The ServiceContent in the Notify contains a ValInfo XML containing the SIPURI and ticket learned from the validation. It also contains the full E.164 number of the called number which validated.</p>
<h1 id="rfc.section.9.8.2">
<a href="#rfc.section.9.8.2">9.8.2.</a> Terminating</h1>
<p id="rfc.section.9.8.2.p.1">When the ViPR server receives a terminating UploadVCR, it stores the information, awaiting the receipt of a validation query. This information MUST be stored for a minimum whose value is a configured property of the DHT.</p>
<h1 id="rfc.section.9.9">
<a href="#rfc.section.9.9">9.9.</a> Sending Notify</h1>
<p id="rfc.section.9.9.p.1">The ViPR server MUST NOT send a Notify until it had already sent a response to the Subscribe message that created the subscription, for which the Notify is being sent.</p>
<p id="rfc.section.9.9.p.2">When a Notify is to be sent, it must contain the SubscriptionID attribute associated with the subscription on which the notification is being sent. This will differ for each client that is subscribed.</p>
<p id="rfc.section.9.9.p.3">The Notify MUST contain the ServiceIdentity attribute, containing service 100, subservice 3, a VServiceID for the VService on which the number was learned, and an instance ID whose instance is all ones. The content of the ServiceContent attribute is an XML document, which is the scrubbed document from the ValExchange response. An example document is:</p>
<div id="#rfc.figure.11"></div>
<div id="#fig-notify-xml"></div>
<pre>
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;valinfo xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:noNamespaceSchemaLocation="valinfo.xsd"&gt;
 &lt;number&gt;+17325552496&lt;/number&gt;
 &lt;ticket&gt;7hasd88a7sd6a6d7989xkk8g7a6sdq78ekaz&lt;/ticket&gt;
 &lt;route&gt;
   &lt;SIPURI&gt;
     sip:17ahhs$7zpaksux6z5==@example.com:2371;maddr=1.2.3.4
   &lt;/SIPURI&gt;
 &lt;/route&gt;
 &lt;route&gt;
   &lt;SIPURI&gt;
     sip:17ahhs$7zpaksux6z5==@example.com:2371;maddr=1.2.3.5
   &lt;/SIPURI&gt;
 &lt;/route&gt;
&lt;/valinfo&gt;
</pre>
<h1 id="rfc.section.9.10">
<a href="#rfc.section.9.10">9.10.</a> Sending PublishRevoke</h1>
<p id="rfc.section.9.10.p.1">The ViPR server is only permitted to PublishRevoke the VService; it cannot withdraw Number Service publications. It should PublishRevoke published VServices when the corresponding DHT is no longer available.  If this should happen, the ViPR server sends a PublishRevoke for each VService that was published which utilized the DHT which is no longer available. That PublishRevoke MUST include a ServiceIdentity attribute indicating the VServiceID and instanceID of the PublishRevoke service.  Furthermore, it SHOULD include a ServiceContent attribute with the corresponding service description; this is used strictly for diagnostic purposes and is not needed by the client. Once sent, the ViPR server removes that instance of that VServiceID from its internal state.</p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> Syntax Details</h1>
<h1 id="rfc.section.10.1">
<a href="#rfc.section.10.1">10.1.</a> <a href="#sec-xml-vservice" id="sec-xml-vservice">XML Schema for VService</a>
</h1>
<p id="rfc.section.10.1.p.1">This document is included in publications for the ViPR service.  Note its target namespace.</p>
<div id="#rfc.figure.12"></div>
<div id="#fig-vservice-xmlschema"></div>
<pre>
&lt;?xml version="1.0" encoding="utf-8"?&gt;

&lt;xs:schema xmlns="http://www.cisco.com/namespaces/saf-uc"
 attributeFormDefault="unqualified" elementFormDefault="qualified"
 targetNamespace="http://www.cisco.com/namespaces/saf-uc"
 xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
 &lt;xs:element name="service-description"&gt;
   &lt;xs:complexType&gt;
     &lt;xs:choice&gt;
&lt;xs:element name="vservice"&gt;
  &lt;xs:complexType&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element name="DHTname" type="xs:string" /&gt;
      &lt;xs:element name="DIDCount" type="xs:integer" /&gt;
      &lt;xs:element minOccurs="1" maxOccurs="1" name="domain"
        type="xs:string" /&gt;
      &lt;xs:choice minOccurs="0" maxOccurs="1"&gt;
        &lt;xs:element
          xmlns:q1="http://www.cisco.com/namespaces/viprtrunk"
          name="blacklist" type="q1:whiteOrBlackList" /&gt;
        &lt;xs:element
          xmlns:q2="http://www.cisco.com/namespaces/viprtrunk"
          name="whitelist" type="q2:whiteOrBlackList" /&gt;
      &lt;/xs:choice&gt;
      &lt;xs:sequence minOccurs="1" maxOccurs="unbounded"&gt;
        &lt;xs:element
          xmlns:q1="http://www.cisco.com/namespaces/viprtrunk"
          name="route" type="q1:routeType" /&gt;
      &lt;/xs:sequence&gt;
      &lt;xs:any minOccurs="0" maxOccurs="unbounded"
        namespace="##other"
        processContents="lax" /&gt;
    &lt;/xs:sequence&gt;
  &lt;/xs:complexType&gt;
&lt;/xs:element&gt;
     &lt;/xs:choice&gt;
     &lt;xs:attribute name="schemaVersion" type="xs:string"
       use="required" /&gt;
     &lt;xs:attribute name="id" type="xs:string" use="required" /&gt;
   &lt;/xs:complexType&gt;
 &lt;/xs:element&gt;
&lt;xs:complexType name="whiteOrBlackList"&gt;
   &lt;xs:sequence minOccurs="1" maxOccurs="unbounded"&gt;
     &lt;xs:element name="domain" type="xs:string" /&gt;
   &lt;/xs:sequence&gt;
 &lt;/xs:complexType&gt;
 &lt;xs:complexType name="routeType"&gt;
   &lt;xs:sequence&gt;
     &lt;xs:element minOccurs="1" maxOccurs="unbounded" name="SIPURI"
       type="xs:string" /&gt;
     &lt;xs:any minOccurs="0" maxOccurs="unbounded"
       namespace="##other" /&gt;
   &lt;/xs:sequence&gt;
 &lt;/xs:complexType&gt;
&lt;/xs:schema&gt;
</pre>
<h1 id="rfc.section.10.2">
<a href="#rfc.section.10.2">10.2.</a> XML Schema for ValInfo</h1>
<p id="rfc.section.10.2.p.1">This document is passed from the terminating ViPR server to the originating, containing the ticket, routes and number which was validated. The originating ViPR server verifies this and passes it to the client in VService notifications.</p>
<div id="#rfc.figure.13"></div>
<div id="#fig-valinfo-xmlschema"></div>
<pre>
&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;xs:schema elementFormDefault="qualified"
   xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
 &lt;xs:element name="valinfo"&gt;
   &lt;xs:complexType&gt;
     &lt;xs:sequence minOccurs="0" maxOccurs="unbounded"&gt;
       &lt;xs:element minOccurs="1" maxOccurs="1" name="number"
         type="xs:string" /&gt;
       &lt;xs:element minOccurs="1" maxOccurs="1" name="ticket"
         type="xs:string" /&gt;
       &lt;xs:element minOccurs="1" maxOccurs="unbounded" name="route"
         type="routeType" /&gt;
       &lt;xs:any minOccurs="0" /&gt;
     &lt;/xs:sequence&gt;
   &lt;/xs:complexType&gt;
 &lt;/xs:element&gt;
 &lt;xs:complexType name="routeType"&gt;
   &lt;xs:sequence&gt;
     &lt;xs:element minOccurs="1" maxOccurs="unbounded" name="SIPURI"
       type="xs:string" /&gt;
     &lt;xs:any minOccurs="0" maxOccurs="unbounded"
       namespace="##other" /&gt;
   &lt;/xs:sequence&gt;
 &lt;/xs:complexType&gt;
&lt;/xs:schema&gt;
</pre>
<h1 id="rfc.section.10.3">
<a href="#rfc.section.10.3">10.3.</a> <a href="#attribute_details" id="attribute_details">VAP Attributes</a>
</h1>
<p id="rfc.section.10.3.p.1">This section enumerates the attributes used by VAP. The attribute names and corresponding types are:</p>
<div id="#rfc.figure.14"></div>
<div id="#fig-vapatts"></div>
<pre>

Attribute Name                  Type
--------------                  ----
USERNAME                        0x0006
MESSAGE-INTEGRITY               0x0008
REALM                           0x0014
ERROR-CODE                      0x0009
Client-Name                     0x1001
Client-Handle                   0x1002
Protocol-Version                0x1003
Client-Label                    0x1005
Keepalive                       0x1006
ServiceIdentity                 0x1007
ServiceVersion                  0x100b
ServiceContent                  0x100c
SubscriptionID                  0x100e
CallDirection                   0x2001
StartTime                       0x2002
StopTime                        0x2003
CallingNum                      0x2004
CalledNum                       0x2005
peerID                          0x2008
Quota                           0x200a
DHTLifetime                     0x200b

</pre>
<h1 id="rfc.section.10.3.1">
<a href="#rfc.section.10.3.1">10.3.1.</a> USERNAME</h1>
<p id="rfc.section.10.3.1.p.1">The USERNAME attribute is used for authentication. It identifies the shared secret used in the message integrity check. Consequently, the USERNAME MUST be included in any request that contains the MESSAGE-INTEGRITY attribute.</p>
<p id="rfc.section.10.3.1.p.2">The value of USERNAME is a variable length opaque value of UTF-8 characters. Note that, as described above, if the USERNAME is not a multiple of four bytes it is padded for encoding into the VAP message, in which case the attribute length represents the length of the USERNAME prior to padding.</p>
<h1 id="rfc.section.10.3.2">
<a href="#rfc.section.10.3.2">10.3.2.</a> REALM</h1>
<p id="rfc.section.10.3.2.p.1">The REALM attribute is present in requests and responses. It contains text which meets the grammar for "realm" as described in RFC 3261 <a href="#RFC3261">[RFC3261]</a>, and will thus contain a quoted string (including the quotes).</p>
<p id="rfc.section.10.3.2.p.2">The value of this attribute MUST always be "ViPR".</p>
<h1 id="rfc.section.10.3.3">
<a href="#rfc.section.10.3.3">10.3.3.</a> <a href="#sec-mi" id="sec-mi">MESSAGE-INTEGRITY</a>
</h1>
<p id="rfc.section.10.3.3.p.1">The MESSAGE-INTEGRITY attribute contains an HMAC-SHA1 <a href="#RFC2104">[RFC2104]</a> of the message. The MESSAGE-INTEGRITY attribute can be present in any message type. Since it uses the SHA1 hash, the HMAC will be 20 bytes. The text used as input to HMAC is the message, including the header, up to and including the attribute preceding the MESSAGE-INTEGRITY attribute. That text is then padded with zeroes so as to be a multiple of 64 bytes. The MESSAGE-INTEGRITY attribute MUST be the last attribute in the message.</p>
<p id="rfc.section.10.3.3.p.2">The 16-byte key for MESSAGE-INTEGRITY HMAC is formed by taking the MD5 hash of the result of concatenating the following five fields: (1) The username, with any quotes and trailing nulls removed, (2) A single colon, (3) The realm, with any quotes and trailing nulls removed, (4) A single colon, and (5) The password, with any trailing nulls removed. Note that the password itself never appears in the message.</p>
<p id="rfc.section.10.3.3.p.3">Since the hash is computed over the entire message, it includes the length field from the message header. This length indicates the length of the entire message, including the MESSAGE-INTEGRITY attribute itself. Consequently, the MESSAGE-INTEGRITY attribute MUST be inserted into the message as the last attribute (with dummy content) prior to the computation of the integrity check. Once the computation is performed, the value of the attribute can be filled in. This ensures the length has the correct value when the hash is performed.</p>
<h1 id="rfc.section.10.3.4">
<a href="#rfc.section.10.3.4">10.3.4.</a> ERROR-CODE</h1>
<p id="rfc.section.10.3.4.p.1">The ERROR-CODE attribute is present in error responses. It is a numeric value in the range of 100 to 699 plus a textual reason phrase encoded in UTF-8, and is consistent in its code assignments and semantics with <a href="#RFC3261">[RFC3261]</a> and <a href="#RFC2616">[RFC2616]</a>. The reason phrase is meant for user consumption (typically freeform fields in alarms and logs), and can be anything appropriate for the response code. Recommended reason phrases for the defined response codes are presented below.</p>
<p id="rfc.section.10.3.4.p.2">To facilitate processing, the class of the error code (the hundreds digit) is encoded separately from the rest of the code.</p>
<div id="#rfc.figure.15"></div>
<div id="#fig-error-syntax"></div>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   0                     |Class|     Number    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Reason Phrase (variable)                                ..
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.10.3.4.p.3">The class represents the hundreds digit of the response code. The value MUST be between 1 and 6. The number represents the response code modulo 100, and its value MUST be between 0 and 99.</p>
<p id="rfc.section.10.3.4.p.4">If the reason phrase has a length that is not a multiple of four bytes, it is padded for encoding into the message, in which case the attribute length represents the length of the entire ERROR-CODE attribute (including the reason phrase) prior to padding.</p>
<p id="rfc.section.10.3.4.p.5">The following response codes, along with their recommended reason phrases (in brackets) are defined at this time:</p>
<p></p>

<dl>
<dt>400 (Bad Request):</dt>
<dd style="margin-left: 8">The request was malformed. The requestor should not retry the request without modification from the previous attempt.</dd>
<dt>431 (Integrity Check Failure):</dt>
<dd style="margin-left: 8">The request contained a MESSAGE-INTEGRITY attribute, but the HMAC failed verification. This could be a sign of a potential attack, or misconfiguration of the password .</dd>
<dt>436 (Unknown Username):</dt>
<dd style="margin-left: 8">The username was not known. This was likely due to a misconfiguration.</dd>
<dt>471 (Bad Client Handle):</dt>
<dd style="margin-left: 8">The client handle provided in the Register request is not known.</dd>
<dt>472 (Version Number Too Low):</dt>
<dd style="margin-left: 8">The client published a service whose version was lower than the currently held one by the server.</dd>
<dt>474 (Unregistered):</dt>
<dd style="margin-left: 8">The client tried an operation, such as publish or subscribe, but it has not yet registered.</dd>
<dt>476 (Unknown Subscription):</dt>
<dd style="margin-left: 8">The referenced subscription does not exist.</dd>
<dt>477 (Already Registered):</dt>
<dd style="margin-left: 8">The client tried an initial Register request, but it is already registered.</dd>
<dt>478 (Unsupported Protocol Version):</dt>
<dd style="margin-left: 8">The server does not support the protocol version requested by the client.</dd>
<dt>481 (Publication Failed):</dt>
<dd style="margin-left: 8">The publication was attempted but could not be performed due to an error reaching the DHT. The client should try again.</dd>
</dl>
<h1 id="rfc.section.10.3.5">
<a href="#rfc.section.10.3.5">10.3.5.</a> Client-Name</h1>
<p id="rfc.section.10.3.5.p.1">The Client-Name attribute is included the Register request. It contains a textual description, in UTF-8, of the software being used by the client, including manufacturer and version number. The attribute has no impact on operation of the protocol, and serves only as a tool for diagnostic and debugging purposes. The value of Client-Name is variable length. If the value of Client-Name is not a multiple of four bytes, it is padded for encoding into the VAP message, in which case the attribute length represents the length of the attribute prior to padding. However, it MUST be less than 255 characters and MUST be at least one character long.</p>
<p id="rfc.section.10.3.5.p.2">It is RECOMMENDED that it be constructed as:</p>
<div id="#rfc.figure.16"></div>
<pre>

&lt;vendor&gt;/&lt;product&gt;/&lt;version&gt;/&lt;hostname or IP&gt;

</pre>
<p id="rfc.section.10.3.5.p.3">Where version includes major, minor and build.</p>
<h1 id="rfc.section.10.3.6">
<a href="#rfc.section.10.3.6">10.3.6.</a> Client-Handle</h1>
<p id="rfc.section.10.3.6.p.1">This attribute has a 32 bit value, representing an unsigned integer to be used as the client handle.</p>
<h1 id="rfc.section.10.3.7">
<a href="#rfc.section.10.3.7">10.3.7.</a> Protocol-Version</h1>
<p id="rfc.section.10.3.7.p.1">This attribute is 32 bits, consisting of two 16-bit unsigned integers, representing the major and minor version numbers of the protocol:</p>
<div id="#rfc.figure.17"></div>
<div id="#fig-version-att"></div>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Major Version               | Minor Version                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<h1 id="rfc.section.10.3.8">
<a href="#rfc.section.10.3.8">10.3.8.</a> Client-Label</h1>
<p id="rfc.section.10.3.8.p.1">This attribute is a UTF-8 string, which MUST be between 1 and 255 characters. It is not used by this specification.</p>
<h1 id="rfc.section.10.3.9">
<a href="#rfc.section.10.3.9">10.3.9.</a> Keepalive</h1>
<p id="rfc.section.10.3.9.p.1">This attribute is a 32 bit unsigned integer, representing the number of milliseconds that the server will retain client state after the last message from the client has been received.</p>
<h1 id="rfc.section.10.3.10">
<a href="#rfc.section.10.3.10">10.3.10.</a> ServiceIdentity</h1>
<p id="rfc.section.10.3.10.p.1">The format of the ServiceIdentity attribute is:</p>
<div id="#rfc.figure.18"></div>
<div id="#fig-serviceidentity"></div>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Service ID                 | Subservice ID               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      VServiceID (most significant)                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      VServiceID (2nd most significant)                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Instance (3rd significant)                                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|      Instance (least significant)                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.10.3.10.p.2">The value of serviceID must always be 101. A Subservice value of 4 indicates VService publications. A subservice value of 3 indicates number publications.</p>
<h1 id="rfc.section.10.3.11">
<a href="#rfc.section.10.3.11">10.3.11.</a> ServiceVersion</h1>
<p id="rfc.section.10.3.11.p.1">The ServiceVersion field is a 32 bit unsigned integer. It contains the version number for the service advertised in the Publish request. It always increments by at least one for each change in the service.</p>
<h1 id="rfc.section.10.3.12">
<a href="#rfc.section.10.3.12">10.3.12.</a> ServiceContent</h1>
<p id="rfc.section.10.3.12.p.1">The ServiceContent is the actual content of the service definition. It is an arbitrary number of bytes. If the number of bytes of content are not a multiple of four, the content is padded with arbitrary data so that it is a multiple of four. The value of the length field of the attribute is the length prior to padding.</p>
<p id="rfc.section.10.3.12.p.2">The ServiceContent MUST be less than 32k, despite the fact that the length field of the attribute itself would allow content up to 64k.</p>
<h1 id="rfc.section.10.3.13">
<a href="#rfc.section.10.3.13">10.3.13.</a> SubscriptionID</h1>
<p id="rfc.section.10.3.13.p.1">The SubscriptionID is present in successful responses to Subscribe and in Unsubscribe messages. It contains an identifier for the subscription. It is a unique handle, unique within all subscriptions between the client and this server. It is an unsigned 32 bit integer. It is also present in Notify and Withdraw requests.</p>
<h1 id="rfc.section.10.3.14">
<a href="#rfc.section.10.3.14">10.3.14.</a> <a href="#sec-calld" id="sec-calld">CallDirection</a>
</h1>
<p id="rfc.section.10.3.14.p.1">This attribute is a 32 bit unsigned integer. A value of 0 indicates a received call. A value of 1 indicates a sent call. Other values are reserved and not valid in this version of the protocol.</p>
<h1 id="rfc.section.10.3.15">
<a href="#rfc.section.10.3.15">10.3.15.</a> StartTime</h1>
<p id="rfc.section.10.3.15.p.1">The start and is a 64 bit NTP time value. The start time is measured in the following way:</p>
<p></p>

<ol>
<li>For calls sent to the PSTN (i.e., originated by this call agent), the start time is measured from the instant of the receipt of the call acceptance message indicating that the called party answered the call. For SIP, this would correspond to receipt of the 200 OK to the original SIP INVITE.</li>
<li>For calls received from the PSTN, (i.e., received by this call agent), the start time is measured from the instant of transmission of the call acceptance message towards the PSTN, indicating that the called party answered the call. For SIP, this would correspond to transmission of the 200 OK to the original SIP INVITE.</li>
</ol>
<h1 id="rfc.section.10.3.16">
<a href="#rfc.section.10.3.16">10.3.16.</a> StopTime Attribute</h1>
<p id="rfc.section.10.3.16.p.1">The stop time is a 64 bit NTP value and is measured in the following way:</p>
<p></p>

<ol>
<li>For the call agent which terminates the call, it corresponds to the transmission of the call termination message towards the PSTN. For SIP, this corresponds to the transmission of a SIP BYE request.</li>
<li>For the call agent which receives the termination, it corresponds to the receipt of the call termination message from the PSTN. For SIP this corresponds to the receipt of a SIP BYE request.</li>
</ol>
<h1 id="rfc.section.10.3.17">
<a href="#rfc.section.10.3.17">10.3.17.</a> CallingNum Attribute</h1>
<p id="rfc.section.10.3.17.p.1">The calling party number MUST be expressed in fully qualified E.164 format, and the attribute is a string with variable length.</p>
<p id="rfc.section.10.3.17.p.2">The calling party number is complicated. This is because this value is often munged and modified by the PSTN as it traverses the network. Fortunately, ViPR does not depend on it being delivered or being correct, but when it is delivered it improves security. Its presence is also needed for validating numbers which connect to multiple users, such that multiple calls to that number are often in progress at the same time. For example, 800 numbers.</p>
<p id="rfc.section.10.3.17.p.3">For the originating call agent, the value is the E.164 number of calling party number delivered to the PSTN. For the terminating call agent, the value is E.164 normalized value of the caller ID received from the PSTN. This will require that national numbers delivered over a PRI are normalized to include their country code.</p>
<h1 id="rfc.section.10.3.18">
<a href="#rfc.section.10.3.18">10.3.18.</a> CalledNum Attribute</h1>
<p id="rfc.section.10.3.18.p.1">The called party number MUST be expressed in fully qualified E.164 format, and it is represented in the attribute as a string with variable length. The following rules apply for computation of the called party number:</p>
<p id="rfc.section.10.3.18.p.2">For the call agent which initiates the call, the called party number is the E.164 number, including the leading plus, of the target of the call. Of course, this may not (and is probably not) the same as the digit sequence dialed by the calling party. The originating call agent MUST normalize this number to E.164 format based on its local dialing rules.</p>
<p id="rfc.section.10.3.18.p.3">For the call agent which receives the call, the called party number is the E.164 number, including the leading plus, of the target of the call. Of course, this may not (and is probably not), the same as the called party number as delivered by the PSTN. It is likely that country codes, for example, are omitted from the message delivered by the PSTN. It is the responsibility of the terminating call agent to reconstruct the E.164 number of the called party.</p>
<h1 id="rfc.section.10.3.19">
<a href="#rfc.section.10.3.19">10.3.19.</a> Quota Attribute</h1>
<p id="rfc.section.10.3.19.p.1">This attribute consists of two 32 bit values. The first is the quota limit, which is the total number of numbers that can be published by this and other call agents attached to this ViPR server into this DHT. The second is the current total number of numbers being published by this and other call agents attached to this ViPR server into this DHT. If the current value is less than the quota value, everything is fine. Once it exceeds it, the DHT is likely to begin dropping entries and the admin needs to reduce the number of numbers being published.</p>
<h1 id="rfc.section.10.3.20">
<a href="#rfc.section.10.3.20">10.3.20.</a> DHTLifetime Attribute</h1>
<p id="rfc.section.10.3.20.p.1">This attribute is a 32 bit unsigned integer. It indicates the number of seconds that data written into the DHT will remain in the DHT prior to being expunged.</p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> Security Considerations</h1>
<h1 id="rfc.section.11.1">
<a href="#rfc.section.11.1">11.1.</a> Outsider Attacks</h1>
<p id="rfc.section.11.1.p.1">VAP prevents against traditional outsider attacks by means of TLS along with password-based digest authentication. That mechanism MUST be implemented by clients and servers and SHOULD be used.</p>
<h1 id="rfc.section.11.2">
<a href="#rfc.section.11.2">11.2.</a> Insider Attacks</h1>
<p id="rfc.section.11.2.p.1">Of much more concern are attacks whereby the client is authenticated, but it misuses the VAP connection to attack the overall system.</p>
<p id="rfc.section.11.2.p.2">The principal attack to be considered is where an attacker injects false numbers by sending Publish requests for the number service containing numbers that the client doesn't own. This attack is the fundamental security problem that ViPR overall addresses with the validation mechanism, and so that attack is handled outside of VAP.</p>
<p id="rfc.section.11.2.p.3">Another potential attack is a flooding attack where a client sends a large amount of numbers into the DHT. This attack is prevented by the distributed quota mechanism within the ViPR RELOAD usage, and thus prevented outside of VAP. Similarly, an attacker might try to DOS the ViPR network by sending a large volume of reads or writes into the DHT. This is prevented by means of the rate control mechanisms enforced by the ViPR server.</p>
<h1 id="rfc.section.12">
<a href="#rfc.section.12">12.</a> IANA Considerations</h1>
<p id="rfc.section.12.p.1">There are no IANA considerations associated with this specification.</p>
<h1 id="rfc.references">
<a href="#rfc.references">13.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">13.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3261">[RFC3261]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, <a>Schulzrinne, H.</a>, <a>Camarillo, G.</a>, <a>Johnston, A.</a>, <a>Peterson, J.</a>, <a>Sparks, R.</a>, <a>Handley, M.</a> and <a>E. Schooler</a>, "<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>", RFC 3261, June 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5389">[RFC5389]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, <a>Mahy, R.</a>, <a>Matthews, P.</a> and <a>D. Wing</a>, "<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>", RFC 5389, October 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC0791">[RFC0791]</b></td>
<td class="top">
<a title="University of Southern California (USC)/Information Sciences Institute">Postel, J.</a>, "<a href="http://tools.ietf.org/html/rfc791">Internet Protocol</a>", STD 5, RFC 791, September 1981.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2617">[RFC2617]</b></td>
<td class="top">
<a href="mailto:john@math.nwu.edu" title="Northwestern University, Department of Mathematics">Franks, J.</a>, <a href="mailto:pbaker@verisign.com" title="Verisign Inc.">Hallam-Baker, P.M.</a>, <a href="mailto:jeff@AbiSource.com" title="AbiSource, Inc.">Hostetler, J.L.</a>, <a href="mailto:lawrence@agranat.com" title="Agranat Systems, Inc.">Lawrence, S.D.</a>, <a href="mailto:paulle@microsoft.com" title="Microsoft Corporation">Leach, P.J.</a>, <a title="Netscape Communications Corporation">Luotonen, A.</a> and <a href="mailto:stewart@OpenMarket.com" title="Open Market, Inc.">L. Stewart</a>, "<a href="http://tools.ietf.org/html/rfc2617">HTTP Authentication: Basic and Digest Access Authentication</a>", RFC 2617, June 1999.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2104">[RFC2104]</b></td>
<td class="top">
<a href="mailto:hugo@watson.ibm.com" title="IBM, T.J. Watson Research Center">Krawczyk, H.</a>, <a href="mailto:mihir@cs.ucsd.edu" title="University of California at San Diego, Dept of Computer Science and Engineering">Bellare, M.</a> and <a href="mailto:canetti@watson.ibm.com" title="IBM T.J. Watson Research Center">R. Canetti</a>, "<a href="http://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>", RFC 2104, February 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2616">[RFC2616]</b></td>
<td class="top">
<a href="mailto:fielding@ics.uci.edu" title="Department of Information and Computer Science">Fielding, R.</a>, <a href="mailto:jg@w3.org" title="World Wide Web Consortium">Gettys, J.</a>, <a href="mailto:mogul@wrl.dec.com" title="Compaq Computer Corporation">Mogul, J.</a>, <a href="mailto:frystyk@w3.org" title="World Wide Web Consortium">Frystyk, H.</a>, <a href="mailto:masinter@parc.xerox.com" title="Xerox Corporation">Masinter, L.</a>, <a href="mailto:paulle@microsoft.com" title="Microsoft Corporation">Leach, P.</a> and <a href="mailto:timbl@w3.org" title="World Wide Web Consortium">T. Berners-Lee</a>, "<a href="http://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a>", RFC 2616, June 1999.</td>
</tr>
<tr>
<td class="reference"><b id="VIPR-PVP">[VIPR-PVP]</b></td>
<td class="top">
<a>Rosenberg, J.R.</a>, <a>Jennings, C.</a> and <a>M. Petit-Huguenin</a>, "<a href="http://tools.ietf.org/html/draft-rosenberg-dispatch-vipr-pvp-03">The Public Switched Telephone Network (PSTN) Validation Protocol (PVP)</a>", Internet-Draft draft-rosenberg-dispatch-vipr-pvp-03, October 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">13.2.</a> Informative References</h1>
<table><tbody><tr>
<td class="reference"><b id="VIPR-OVERVIEW">[VIPR-OVERVIEW]</b></td>
<td class="top">
<a>Rosenberg, J.R.</a>, <a>Jennings, C.</a> and <a>M. Petit-Huguenin</a>, "<a href="http://tools.ietf.org/html/draft-rosenberg-dispatch-vipr-overview-04">Verification Involving PSTN Reachability: Requirements and Architecture Overview</a>", Internet-Draft draft-rosenberg-dispatch-vipr-overview-04, October 2010.</td>
</tr></tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> Release notes</h1>
<p id="rfc.section.Appendix A.p.1">This section must be removed before publication as an RFC.</p>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> Modifications between rosenberg-03 and rosenberg-02</h1>
<p></p>

<ul>
<li>Nits.</li>
<li>Shorter I-Ds references.</li>
<li>Added terminology section.</li>
<li>Changed figures to fit in the page width.</li>
<li>Change reference from RFC 2401 to RFC 2104</li>
<li>Removed cut &amp; paste error from STUN.</li>
<li>Fixed some invalid lists.</li>
<li>Section 9.1: Removed mutual authentication to be consistent with 5.1.</li>
<li>Fixed the text for the creation of the resource name in 9.4.2, to be consistent with -reload-usage.</li>
<li>Fixed example to really contain hexadecimal.</li>
</ul>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Cullen Jennings</span> 
	  <span class="n hidden">
		<span class="family-name">Jennings</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco</span>
	<span class="adr">
	  <span>170 West Tasman Drive</span>
<span>MS: SJC-21/2</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">CA</span> 
		<span class="code">95134</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">Phone: +1 408 421-9990</span>

<span class="vcardline">EMail: <a href="mailto:fluffy@cisco.com">fluffy@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Jonathan Rosenberg</span> 
	  <span class="n hidden">
		<span class="family-name">Rosenberg</span>
	  </span>
	</span>
	<span class="org vcardline">jdrosen.net</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality">Monmouth</span>,  
		<span class="region">NJ</span> 
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:jdrosen@jdrosen.net">jdrosen@jdrosen.net</a></span>

<span class="vcardline">URI: <a href="http://www.jdrosen.net">http://www.jdrosen.net</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Marc Petit-Huguenin</span> 
	  <span class="n hidden">
		<span class="family-name">Petit-Huguenin</span>
	  </span>
	</span>
	<span class="org vcardline">Stonyfish</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:marc@stonyfish.com">marc@stonyfish.com</a></span>

  </address>
</div>

</body>
</html>