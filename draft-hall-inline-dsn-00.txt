

  INTERNET-DRAFT                                             Eric A. Hall 
  Document: draft-hall-inline-dsn-00.txt                       April 2004 
  Expires: October, 2004                                                  
  Category: Standards-Track                                               
      
      
                   SMTP Service Extension for Inline DSNs 
      
      
     Status of this Memo 
      
     This document is an Internet-Draft and is in full conformance with 
     all provisions of Section 10 of RFC 2026. 
      
     Internet-Drafts are working documents of the Internet Engineering 
     Task Force (IETF), its areas, and its working groups. Note that 
     other groups may also distribute working documents as Internet-
     Drafts. 
      
     Internet-Drafts are draft documents valid for a maximum of six 
     months and may be updated, replaced, or obsoleted by other 
     documents at any time. It is inappropriate to use Internet-Drafts 
     as reference material or to cite them other than as "work in 
     progress." 
      
     The list of current Internet-Drafts can be accessed at 
     http://www.ietf.org/ietf/1id-abstracts.txt 
      
     The list of Internet-Draft Shadow Directories can be accessed at 
     http://www.ietf.org/shadow.html. 
      
      
     Copyright Notice 
      
     Copyright (C) The Internet Society (2003).  All Rights Reserved. 
      
      
     Abstract 
      
     This memo describes a mechanism for the negotiation and transfer 
     of per-recipient notification responses in SMTP. 
      
   
   
  Internet Draft       draft-hall-inline-dsn-00.txt          April 2004 
   
   
      
     Table of Contents 
      
     1.   Introduction..............................................2 
     2.   Prerequisites and Terminology.............................3 
     3.   The INLINE-DSN SMTP Service Extension.....................3 
     4.   The INLINE-DSN Keyword....................................4 
     5.   The INLINE-DSN Command Extension..........................4 
     6.   The 352 and 353 Response Codes............................4 
       6.1.  The 352 Response Code..................................4 
       6.2.  The 353 Response Code..................................5 
     7.   Usage Examples............................................6 
       7.1.  One Failure, One Success...............................6 
       7.2.  Total Failure..........................................6 
       7.3.  Mixed-Mode.............................................7 
     8.   Security Considerations...................................7 
     9.   Normative References......................................8 
     10.  Informative References....................................8 
     Author's Address...............................................8 
     Acknowledgments................................................8 
     Full Copyright Statement.......................................8 
      
      
  1.      Introduction 
      
     The Simple Mail Transfer Protocol (SMTP) [RFC2821] currently uses 
     a single response code to indicate whether or not an email message 
     [RFC2822] has been accepted. This response code applies to the 
     message data specifically, and therefore applies to all of the 
     message's recipients collectively, regardless of the number of 
     recipients which may have been specified in the envelope or their 
     individual preferences. 
      
     However, it has become common practice for different recipients to 
     have their own content filters, and a single response code is not 
     sufficiently granular to accurately reflect these differences. For 
     example, some users may suffer under policy rules which require 
     them to refuse email messages that contain certain words, while 
     other users may be required to accept all messages regardless of 
     content. But since the current SMTP model only allows a single 
     response code for any given message, the only legitimate way to 
     accommodate these differences is for all messages to be accepted 
     so that they can be examined off-line, with one or more failure 
     notification messages eventually being returned to the original 
     sender whenever a message is rejected. This process introduces a 
     significant burden on the recipient server, which must create, 
   
  Hall                  I-D Expires: October 2004             [page 2] 
  Internet Draft       draft-hall-inline-dsn-00.txt          April 2004 
   
   
     queue, and transfer each of the notification messages. Simply put, 
     it would be much more efficient for the recipient system to be 
     able to refuse email messages on a per-recipient basis while the 
     transfer session was still active, thus moving the failure 
     processing tasks to the sending system. 
      
     This specification is intended to provide that service. This is 
     achieved through the definition of an SMTP service extension which 
     is used to advertise support for this service, a command extension 
     to the MAIL verb which indicates that a client wishes to use the 
     service, a set of unique response codes for use when the service 
     is active, and behavioral rules which implementations are required 
     to follow when the service has been activated. 
      
  2.      Prerequisites and Terminology 
      
     Readers of this document are expected to be familiar with the 
     specifications for SMTP (RFC 2821), command pipelining (STD 60) 
     [STD60], and enhanced status codes (RFC 2034) [RFC2034]. 
      
     The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL 
     NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" 
     in this document are to be interpreted as described in RFC 2119 
     [RFC2119]. 
      
  3.      The INLINE-DSN SMTP Service Extension 
      
     The extension is defined as follows: 
      
        a.  the name of the SMTP service extension is INLINE-DSN; 
      
        b.  the EHLO keyword value associated with the extension is 
            INLINE-DSN; 
      
        c.  the INLINE-DSN EHLO keyword has no parameters; 
      
        d.  an INLINE-DSN extension is defined for the MAIL FROM 
            command; 
      
        e.  the INLINE-DSN command extension to the MAIL FROM command 
            has no parameters; 
      
        f.  no additional commands are extended; 
      
        g.  no new verbs are defined by this extension; 
      
   
  Hall                  I-D Expires: October 2004             [page 3] 
  Internet Draft       draft-hall-inline-dsn-00.txt          April 2004 
   
   
        h.  the 352 and 353 response codes are defined for use when the 
            INLINE-DSN extension has been activated; and, 
      
        i.  the next section specifies how support for the extension 
            affects the behavior of a server and client SMTP. 
      
  4.      The INLINE-DSN Keyword 
      
     The presence of the INLINE-DSN keyword in the EHLO greeting 
     response indicates that the server supports this extension. No 
     parameters are defined for this keyword. 
      
     Servers which offer this service MUST support the command 
     pipelining extension defined in [STD60], and SHOULD support the 
     extended status codes defined in [RFC2034]. 
      
  5.      The INLINE-DSN Command Extension 
      
     Clients indicate that they wish to use the INLINE-DSN extension by 
     providing INLINE-DSN as an extension to the MAIL FROM command. 
      
     Clients MUST NOT transmit this command extension unless the server 
     has advertised support for the INLINE-DSN service extension in the 
     EHLO greeting response. 
      
     No parameters are defined for this command extension. 
      
  6.      The 352 and 353 Response Codes 
      
  6.1.    The 352 Response Code 
      
     The 352 response code is used by a server to indicate that the 
     mailbox address specified in the associated RCPT TO command 
     appears to be valid, but its validity will not be confirmed until 
     after the message data has been transferred. 
      
     Servers MUST NOT generate the 352 response code for this purpose 
     unless the client has used the INLINE-DSN command extension to the 
     MAIL FROM command during the current envelope exchange. 
      
     Clients which receive the 352 response code MUST be prepared for 
     the recipient to be declared as invalid after the message data has 
     been transferred. 
      
   
  Hall                  I-D Expires: October 2004             [page 4] 
  Internet Draft       draft-hall-inline-dsn-00.txt          April 2004 
   
   
      
  6.2.    The 353 Response Code 
      
     The 353 response code is used by a server to indicate that the 
     message data (as transferred with the DATA or BDAT commands, among 
     other possibilities) appears to be valid, but that one or more of 
     the recipients may refuse the message. When this response code is 
     returned, absolute response codes for each of the recipients which 
     were earlier acknowledged with a 352 response code during the 
     envelope exchange MUST be provided, and must be provided in the 
     order in which they were originally accepted. Once all of the 
     recipient-specific response codes have been returned, the end of 
     the sequence MUST be indicated with a 250 response code. Each of 
     these response codes MUST be returned as independent responses 
     (one per line, or one per multi-line response, as necessary). 
      
     Each of the recipient-specific responses MUST use the syntax rules 
     associated with the canonical definition of that response code. 
     For example, if a server needs to use the 551 response code to 
     indicate that a recipient has relocated to another address, that 
     particular response MUST include the destination mailbox address, 
     as per the syntax rules defined in RFC 2821. 
      
     Servers SHOULD include the appropriate enhanced status code with 
     each of the per-recipient responses, as defined in [RFC2034]. 
      
     If the entire message was accepted or refused by every recipient, 
     the 353 response code and the subordinate responses MAY be 
     substituted with a single response code which reflects the global 
     outcome. For example, if all of the recipients accepted the email 
     message, then a single 250 response code MAY be returned in lieu 
     of generating a 353 response code, the per-recipient response 
     codes and the final 250 response code. 
      
     Servers MUST NOT generate the 353 response code for this purpose 
     unless the server has already used the 352 response code during 
     the current envelope exchange. 
      
     Clients which receive the 353 response code MUST be prepared to 
     receive recipient-specific response codes for each of the 
     recipients which had earlier returned 352 response codes during 
     the current envelope exchange. 
      
   
  Hall                  I-D Expires: October 2004             [page 5] 
  Internet Draft       draft-hall-inline-dsn-00.txt          April 2004 
   
   
      
  7.      Usage Examples 
      
  7.1.    One Failure, One Success 
      
     The following dialog illustrates a message with two recipients, 
     one of which refuses the content, the other of which accepts: 
      
        S: <waits for connection on TCP port 25> 
        C: <opens connection> 
        S: 220 server.example.net 
        C: EHLO client.example.com 
        S: 250-server.example.net Hello there 
        S: 250-INLINE-DSN 
        S: 250-PIPELINING 
        S: 250 ENHANCEDSTATUSCODES 
         
        C: MAIL FROM:<sender@example.com> INLINE-DSN 
        S: 250 okay 
        C: RCPT TO:<fighter@example.net> 
        S: 352 recipient looks okay but wait for confirmation 
        C: RCPT TO:<lover@example.net> 
        S: 352 recipient looks okay but wait for confirmation 
         
        C: DATA 
        S: 354 go ahead 
        C: <sends data> 
        C: <crlf>.<crlf> 
        S: 353 data looks okay but wait for confirmation 
        S: 550 5.6.0 <fighter@example.net> refuses the content 
        S: 250 2.1.5 <lover@example.net> accepts the content 
        S: 250 data accepted by some recipients 
      
  7.2.    Total Failure 
      
     The following dialog illustrates a message with two recipients, 
     both of which refuse to accept the message (note that this example 
     only shows the envelope and data exchange): 
      
        C: MAIL FROM:<sender@example.com> INLINE-DSN 
        S: 250 okay 
        C: RCPT TO:<fighter@example.net> 
        S: 352 recipient looks okay but wait for confirmation 
        C: RCPT TO:<lover@example.net> 
        S: 352 recipient looks okay but wait for confirmation 
         
   
  Hall                  I-D Expires: October 2004             [page 6] 
  Internet Draft       draft-hall-inline-dsn-00.txt          April 2004 
   
   
        C: DATA 
        S: 354 go ahead 
        C: <sends data> 
        C: <crlf>.<crlf> 
        S: 550 5.6.0 data refused by all recipients 
      
     Since the message contents were refused by all of the recipients, 
     the data transfer was simply rejected, and it was unnecessary for 
     the server to generate per-recipient responses. 
      
  7.3.    Mixed-Mode 
      
     The following dialog illustrates a transfer that incorporates 
     historical response codes as well as the 352 response code (note 
     that this example only shows the envelope and data exchange): 
      
        C: MAIL FROM:<sender@example.com> INLINE-DSN 
        S: 250 okay 
        C: RCPT TO:<postmaster@example.net> 
        S: 250 this recipient accepts all messages 
        C: RCPT TO:<fighter@example.net> 
        S: 352 recipient looks okay but wait for confirmation 
        C: RCPT TO:<lover@example.net> 
        S: 352 recipient looks okay but wait for confirmation 
        C: RCPT TO:<old-user@example.net> 
        S: 550 this recipient no longer exists 
         
        C: DATA 
        S: 354 go ahead 
        C: <sends data> 
        C: <crlf>.<crlf> 
        S: 353 data looks okay but wait for confirmation 
        S: 550 5.6.0 <fighter@example.net> refuses the content 
        S: 250 2.1.5 <lover@example.net> accepts the content 
        S: 250 data accepted by some users 
      
     Note that the postmaster and old-user mailboxes were not itemized 
     in the deferred responses, since they were not deferred during the 
     envelope exchange. 
      
  8.      Security Considerations 
      
     TBD 
      
   
  Hall                  I-D Expires: October 2004             [page 7] 
  Internet Draft       draft-hall-inline-dsn-00.txt          April 2004 
   
   
      
  9.      Normative References 
      
          [RFC2119]     Bradner, S., "Key words for use in RFCs to 
                         Indicate Requirement Levels", BCP 14, RFC 
                         2119, March 1997. 
      
          [RFC2034]     Freed, N., "SMTP Service Extension for 
                         Returning Enhanced Error Codes", RFC 2034, 
                         October 1996. 
      
          [RFC2821]     Klensin, J., "Simple Mail Transfer Protocol", 
                         RFC 2821, April 2001. 
      
          [STD60]       Freed, N., "SMTP Service Extension for Command 
                         Pipelining", STD 60, RFC 2920, September 2000. 
      
  10.     Informative References 
      
          [RFC2822]     Resnick, P., "Internet Message Format", RFC 
                         2822, April 2001. 
      
      
  Author's Address 
      
     Eric A. Hall 
     ehall@ehsco.com 
      
      
  Acknowledgments 
      
     Funding for the RFC editor function is currently provided by the 
     Internet Society. 
      
     Portions of this document were funded by VeriSign Labs. 
      
     The first version of this specification was co-authored by Andrew 
     Newton of VeriSign Labs, and subsequent versions continue to be 
     developed with his active participation. Edward Lewis and Peter 
     Gietz also contributed significant feedback to this specification 
     in the later stages of its developments. 
      
      
  Full Copyright Statement 
      
     Copyright (C) The Internet Society (2003). All Rights Reserved. 
      
   
  Hall                  I-D Expires: October 2004             [page 8] 
  Internet Draft       draft-hall-inline-dsn-00.txt          April 2004 
   
   
     This document and translations of it may be copied and furnished 
     to others, and derivative works that comment on or otherwise 
     explain it or assist in its implementation may be prepared, 
     copied, published and distributed, in whole or in part, without 
     restriction of any kind, provided that the above copyright notice 
     and this paragraph are included on all such copies and derivative 
     works. However, this document itself may not be modified in any 
     way, such as by removing the copyright notice or references to the 
     Internet Society or other Internet organizations, except as needed 
     for the purpose of developing Internet standards in which case the 
     procedures for copyrights defined in the Internet Standards 
     process must be followed, or as required to translate it into 
     languages other than English. 
      
     The limited permissions granted above are perpetual and will not 
     be revoked by the Internet Society or its successors or assigns. 
      
     This document and the information contained herein is provided on 
     an "AS IS" basis and THE INTERNET SOCIETY AND THE INTERNET 
     ENGINEERING TASK FORCE DISCLAIMS ALL WARRANTIES, EXPRESS OR 
     IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF 
     THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED 
     WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. 
      
   
  Hall                  I-D Expires: October 2004             [page 9] 

