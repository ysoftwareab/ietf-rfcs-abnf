<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Protocol Support for High Availability IKEv2/IPsec</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Protocol Support for High Availability IKEv2/IPsec">
<meta name="keywords" content="Internet-Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">R. Singh, Ed.</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">G. Kalyani</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">Cisco</td></tr>
<tr><td class="header">Expires: April 14, 2011</td><td class="header">Y. Nir</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Check Point</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">D. Zhang</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Huawei</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">October 11, 2010</td></tr>
</table></td></tr></table>
<h1><br />Protocol Support for High Availability IKEv2/IPsec<br />draft-ietf-ipsecme-ipsecha-protocol-01</h1>

<h3>Abstract</h3>

<p> IKEv2 and IPsec protocols are widely used for deploying VPN. 
            In order to make such VPN highly available, more scalable and failure-prone, these VPNs are implemented as IKEv2/IPsec Highly Available (HA) cluster.
            But there are many issues in IKEv2/IPsec HA cluster. The draft  "IPsec Cluster Problem Statement" enumerates all the issues encountered in
            IKEv2/IPsec HA cluster environment.
</p>
<p> This document proposes an extension to IKEv2 protocol to solve main issues of "IPsec Cluster Problem Statement" in Hot Standby cluster 
            and gives implementation advice for other issues. The main issues to be solved are: </p>
<ul class="text">
<li> IKEv2 Message Id synchronization : This is done by syncing up expected send and receive message Id values with the peer and updating the 
            values at the newly active cluster member after the failover. 
</li>
<li> IPsec Replay Counter synchronization : This is done by syncing up bumped up outgoing SA replay counters values with peer and updating the values
            at the newly active cluster member after the failover. 
</li>
</ul><p>
    
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on April 14, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#anchor3">3.</a>&nbsp;
Issues solved from IPsec Cluster Problem Statement<br />
<a href="#sync_problem">4.</a>&nbsp;
IKEv2/IPsec SA Counter Synchronization Problem <br />
<a href="#anchor4">5.</a>&nbsp;
IKEv2/IPsec SA Counter Synchronization Solution<br />
<a href="#sync_payload">6.</a>&nbsp;
IKEv2/IPsec synchronization notification payloads<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">6.1.</a>&nbsp;
IKEV2_MESSAGE_ID_SYNC_SUPPORTED<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">6.2.</a>&nbsp;
IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">6.3.</a>&nbsp;
IKEV2_MESSAGE_ID_SYNC<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">6.4.</a>&nbsp;
IPSEC_REPLAY_COUNTER_SYNC<br />
<a href="#anchor9">7.</a>&nbsp;
Details of implementation<br />
<a href="#anchor10">8.</a>&nbsp;
Step-by-Step details<br />
<a href="#Security">9.</a>&nbsp;
Security Considerations<br />
<a href="#anchor11">10.</a>&nbsp;
Interaction with other drafts<br />
<a href="#anchor12">11.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor13">12.</a>&nbsp;
Acknowledgements<br />
<a href="#history">13.</a>&nbsp;
Change Log<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">13.1.</a>&nbsp;
Draft  -01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">13.2.</a>&nbsp;
Draft  -00<br />
<a href="#rfc.references1">14.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">14.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">14.2.</a>&nbsp;
Informative References<br />
<a href="#Examples">Appendix&nbsp;A.</a>&nbsp;
IKEv2 Message Id examples<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p> IKEv2 is used for deploying IPsec-based VPNs. In order to make such VPN highly available, more scalable and failure-prone, these VPNs are implemented as 
              IKEv2/IPsec Highly Available (HA) cluster. But there are many issues in IKEv2/IPsec HA cluster. The draft  "IPsec Cluster Problem Statement"
              enumerates all the issues encountered in IKEv2/IPsec HA cluster. 
</p>
<p> In case of Hot Standby cluster implementation of IKEv2/IPsec based VPNs, the IKEv2/IPsec session gets established with the peer and the 
              active member of cluster. After that, the active member syncs/updates the IKE/IPsec SA state to the standby member of the cluster. This 
              primary SA state sync-up is done on SA bring up and/or rekey. Doing SA state synchronization/updation between active and peer member 
              for each IKE and IPsec message standby cluster is very costly, so normally its done periodically. So, when "failover" event happens in the 
              cluster, first "failover' is detected by the standby member and then it becomes active member and it takes considerable time. During the time
              of failover and standby member becoming newly active member, the peer is unaware of failover and keeps sending IKE request and IPsec packets 
              to the cluster which is allowed as per IKEv2 and IPsec windowing feature. Now, newly active member after coming up finds the mismtach in IKE message 
              Id's and IPsec replay counters. Please see <a class='info' href='#sync_problem'>Section&nbsp;4<span> (</span><span class='info'>IKEv2/IPsec SA Counter Synchronization Problem </span><span>)</span></a> for more details. 
</p>
<p> This document proposes an extension to IKEv2 protocol to solve main issues of IKE message id sync and IPsec SA replay counter sync and gives 
              implementation advice for others. Here is summary of solutions provided in this document:  
</p>
<p> IKEv2 Message Id synchronization :This is done by syncing up expected send and receive message Id values with the peer and updating the 
            values at the newly active cluster member after the failover. 
</p>
<p> IPsec Replay Counter synchronization : This is done by syncing up bumped up outgoing SA replay counters values with peer and updating the values
            at the newly active cluster member after the failover 
</p>
<p> Though this document describes the IKEv2 message Id sync and IPsec replay counter synchronization in context of IPsec HA cluster, 
              the solution provided is genetic and can be used in other scenarios where IKEv2 message Id sync or IPsec SA replay counters sync is required.
</p>
<p> While some IPsec HA implementation suffers from IKEv2 message Id synchronization problem, some other implementation 
              suffers from IPsec replay counter  synchronization. Both of these problem are handled separately, using separate notify for
              each problem. This provides the flexibility of implementing IKEv2 message Id synchronization or IPsec replay counter synchronization or both.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in
          <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement             Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].
</p>
<p> "SA Counter SYNC Request" is the information exchange request defined in this document to synchronize the 
                 IKEv2/IPsec SA counter information between member of the cluster and the peer. 
</p>
<p> "SA Counter SYNC Response" is the information exchange response defined in this document to synchronize 
                 the IKEv2/IPsec SA counter information between member of the cluster and the peer. 
</p>
<p> Below are the terms taken from  <a class='info' href='#IPsec Cluster Problem Statement'>[IPsec Cluster Problem Statement]<span> (</span><span class='info'>Nir, Y., &ldquo;IPsec Cluster Problem Statement,&rdquo; July&nbsp;2010.</span><span>)</span></a> with added information 
                in context of this document. 
</p>
<p> "Hot Standby Cluster", or "HS Cluster" is a cluster where only one of  the members is active at any one time. 
                 This member is also referred  to as the "active", whereas the other(s) are referred to as "standbys".  
                  VRRP ([RFC5798]) is one method of building such a cluster. The goal of Hot Standby Cluster is that it
                  creates illusion of single virtual gateway to the peer(s). 
</p>
<p> "Active Member" is the primary member in the Hot Standby cluster. It is responsible for forwarding packets
                for the virtual gateway. 
</p>
<p> "Standby Member" is the primary backup router. The member takes control i.e. becomes active member after
                 the "failover" event. 
</p>
<p> "Peer" is the IKEv2/IPsec endpoint which establishes VPN connection with Hot Standby cluster. The Peer 
                 knows Hot Standby Cluster by single cluster's IP address. In case of "failover", the standby member of the
                 cluster becomes active, so the peer normally doesn't notice that "failover" has occurred in the cluster. 
</p>
<p> "Multiple failover" is the situation when in a cluster with three or more nodes failover happens in rapid succession.
                 The protocol and implementation must be able to handle multiple failover i.e. able to handle  new failover even if 
                 they are still processing the old failover. 
</p>
<p> "Simultaneous failover" is the situation when in a cluster the failover happens at the both ends at the same time. 
                  The protocol and implementation must be able to handle simultaneous failover. 
</p>
<p> The generic term IKEv2/IPsec SA counters is used throughout. By IKEv2 SA counter stands for IKEv2 message ids
                  and IPsec SA counter stands for IPsec SA replay counters which are used to provide optional anti-replay feature. 
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Issues solved from IPsec Cluster Problem Statement</h3>

<p>  IPsec Cluster Problem Statement defines the problems encountered in IPsec Clusters.
      . The problems along with their section names as given in the statement are as follows. 
</p>
<ul class="text">
<li>   3.2.  Lots of Long Lived State 
</li>
<li>  3.3.  IKE Counters
</li>
<li>  3.4.  Outbound SA Counters
</li>
<li> 3.5.  Inbound SA Counters
</li>
<li>  3.6.  Missing Synch Messages
</li>
<li>  3.7.  Simultaneous use of IKE and IPsec SAs by Different
           Members    
<ul class="text">
<li>   3.7.1.  Outbound SAs using counter modes
</li>
</ul>
     
</li>
<li>   3.8.  Different IP addresses for IKE and IPsec
</li>
<li>  3.9.  Allocation of SPIs
</li>
</ul><p>
    
</p>
<p> This document solves the main issues using the protocol extension,
 and provides implementation advice for other issues, given as follows.

</p>
<ul class="text">
<li>3.2 This section mentions that  there's lots of state that needs to be synchronized. 
If state is not synchronized, it's not really an interesting cluster - failover will be just like a 
reboot, so the issue need not be solved with protocol extensions. 
</li>
<li>3.3, 3.4,3.5, and 3.6 are solved by this document. Please see <a class='info' href='#sync_problem'>Section&nbsp;4<span> (</span><span class='info'>IKEv2/IPsec SA Counter Synchronization Problem </span><span>)</span></a>, 
     for more details. 
</li>
<li>3.7 is  the problem to be solved while building clusters.  
        However,  the peers should be mandated to accept multiple parallel SAs for 3.7.1 
</li>
<li> 3.8 can be solved by using IKEv2 Redirect Mechanism [RFC-5685].
</li>
<li>3.9 is the problem about avoiding collision of same SPI's among the cluster members. This 
is outside the scope of the document since this has to be solved within the context of the cluster and
not with the peer.
</li>
</ul><p>

</p>
<p> 
</p>
<a name="sync_problem"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
IKEv2/IPsec SA Counter Synchronization Problem </h3>

<p>  IKEv2 RFC states that "An IKE endpoint MUST NOT exceed the peer's stated window size for
        transmitted IKE requests".
</p>
<p>As per the protocol, all IKEv2 packets follows request-response paradigm. 
        The initiator of an IKEv2 request MUST retransmit the request, until it has received a response from the peer.
        IKEv2 introduces a windowing mechanism that allows multiple requests to be outstanding at a given point of time, but mandates
        that the sender window does not move until the oldest message sent from one peer to another is acknowledged.
        Loss of even a single packet leads to repeated re-transmissions followed by an IKEv2 SA teardown if the re-transmissions are unacknowledged.
</p>
<p> IPsec Hot Standby Cluster is required to ensure that in case of failover of active member, the standby member becomes active immediately.
        The standby member is expected to have the exact values of message id fields of active member before failover.
        Even with the best efforts to update the message Id values from active to standby member, the values at standby 
        member can be stale due to following reasons:

        </p>
<ul class="text">
<li> Standby member is unaware of the last message that was received and acknowledged by the 
          older active member as failover could have happened before the standby could be updated.
</li>
<li> Standby member does not have information about on-going unacknowledged requests of active member before the failover event.
              So after failover event when standby member becomes active, it can not re-transmit those requests.
</li>
</ul><p>
         
</p>
<p> 
</p>
<p> When a standby member takes over as the active member, it would start the message id ranges from previously updated values.
        This would make it reject requests from the peer, since the values would be stale.
        As a sender, the standby member may end up reusing a stale message id which will cause the peer to drop the request.
        Eventually there is a high probability of the IKEv2 and corresponding IPsec SAs getting torn down simply because of a 
        transitory message id mis-match and re-transmission of requests.  This is not a desirable feature of HA. Even after updating 
        standby member periodically the cluster can loose IKE and so all IPsec SA due to message id i.e. SA counter mismatch. 
</p>
<p>Similar issue is observed in IPsec counters also if anti-replay protection/ESN is implemented. Even with the best efforts of syncing the ESP and AH SA counter numbers from
active to stand by member , there is a chance that the stand-by member would have stale counter values. The standby member would then send the stale counter numbers.
The peer would reject/drop such packets since in case of anti-replay protection feature, duplicate use of counters are not allowed. In case of IPsec it is OK to skip 
some counter values and start with the higher counter values.
</p>
<p>Hence a mechanism is required in HA to ensure that the standby member has correct values of message Id values and IPsec counters, 
        so that sessions are not torn down just because of mismatching counters.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
IKEv2/IPsec SA Counter Synchronization Solution</h3>

<p>When the standby member becomes the active member after failover event in the cluster, the standby member 
        would send an authenticated IKEv2 request to the peer to send its values of SA counters.
</p>
<p> The standby member would then update its values of SA counters and then start sending/receiving the requests.
</p>
<p> First, the peer MUST negotiate its ability to support IKEv2 message Id synchronization information with active member of the cluster by sending
             the IKEV2_MESSAGE_ID_SYNC_SUPPORTED notification in IKE_AUTH exchange. 
</p>
<p> Similarly to support IPsec replay counter synchronization, the peer MUST negotiate its ability to support IPsec replay counter synchronization 
             with active member of the cluster by sending IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED notification in IKE_AUTH exchange. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Peer                                                  Active Member
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
HDR, SK {IDi, [CERT], [CERTREQ], [IDr], AUTH,
  N[IKEV2_MESSAGE_ID_SYNC_SUPPORTED],
  N[IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED],
  SAi2, TSi, TSr} ----------&gt;

&lt;---------- HDR, SK {IDr, [CERT+], [CERTREQ+], AUTH,
                 N[IKEV2_MESSAGE_ID_SYNC_SUPPORTED],
                 N[IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED], SAr2, TSi, TSr}

</pre></div>
<p> When peer and active member both support SA counter synchronization, the active member MUST sync/update SA counter 
               synchronization capability to the standby member after the establishment of the IKE SA . So that standby member is aware of 
               the capability and can use it when it becomes the active member after failover event.
</p>
<p>  After failover event, when the standby member becomes the active member, it has to request the peer for the SA counters.
                Standby member would initiate the SYNC Request with an INFORMATIONAL exchange with message Id zero containing the notify 
                 IKEV2_MESSAGE_ID_SYNC or  IPSEC_REPLAY_COUNTER_SYNC or both 
                 depending on whether the synchronization needs to be done for IKEv2 message Ids, IPsec replay counters, or both. 
</p>
<p> The initiator of IKEv2 message Id sync request sends its expected send and receive message Id values and "failover count" in
               IKEV2_MESSAGE_ID_SYNC notify. The responder of the request compares the received values with the available local values.
               The higher among both is selected and sent as sync response with notify IKEV2_MESSAGE_ID_SYNC. The initiator now updates 
               send and receive IKEv2 message Ids to the values received in sync response and can start normal IKEv2 message exchange. 
</p>
<p>    The initiator of IPsec replay counter sync sends bumped outgoing IPsec SA reply counter value and "failover count" in 
               IPSEC_REPLAY_COUNTER_SYNC notify. The responder of the request updates its incoming IPsec SA counter values
               and sends its bumped outgoing IPsec SA replay counter value in sync response with IPSEC_REPLAY_COUNTER_SYNC. The 
               initiator now updates its incoming IPsec SA counter to values received in sync response and can start normal IPsec data traffic. 
</p>
<p>  Both the notify types IKEV2_MESSAGE_ID_SYNC and IPSEC_REPLAY_COUNTER_SYNC contain Nonce Data
             in the payload to avoid DOS attack due to replay of SA counter sync request/response. The Nonce are defined per notify and MUST 
             be validated. The Nonce data sent in response MUST match with nonce data sent by newly-active member in  request. If nonce data received in 
             response does not match with nonce data sent in request, the standby i.e. newly-active member MUST discard this response, 
             and normal IKEv2 behavior of re-transmitting the request and waiting for genuine reply from the peer SHOULD follow, 
             before tearing down the SA because of re-transmits. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Standby [Newly Active] Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
HDR, SK {N[IKEV2_MESSAGE_ID_SYNC ],
               N[IPSEC_REPLAY_COUNTER_SYNC]} --------&gt;

             &lt;--------- HDR, SK {N[IKEV2_MESSAGE_ID_SYNC ],
               N[IPSEC_REPLAY_COUNTER_SYNC]}

</pre></div>
<a name="sync_payload"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
IKEv2/IPsec synchronization notification payloads</h3>

<p>Below are the new notify and payload types that are defined 
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
IKEV2_MESSAGE_ID_SYNC_SUPPORTED</h3>

<p>IKEV2_MESSAGE_ID_SYNC_SUPPORTED:  This notify is included in the IKE_AUTH request/response to indicate 
     support for IKEv2 message Id synchronization mechanism described in this document. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |C|  RESERVED   |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Protocol ID(=0)| SPI Size (=0) |      Notify Message Type      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p> The 'Next Payload', 'Payload Length', 'Protocol ID', 'SPI Size', and 'Notify Message Type'
           fields are the same as described in Section 3 of <a class='info' href='#RFC5996'>[RFC5996]<span> (</span><span class='info'>Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;Internet Key Exchange Protocol: IKEv2,&rdquo; September&nbsp;2010.</span><span>)</span></a>.  
            The 'SPI Size' field MUST be set  to 0 to indicate that the SPI is not present in this message.  
            The 'Protocol ID' MUST be set to 0, since the notification is not specific to a particular security association. 
      
            'Payload Length' field is set to the length in octets of the entire payload, including 
             the generic payload header.  The 'Notify Message Type' field is set to indicate the 
            IKEV2_MESSAGE_ID_SYNC_SUPPORTED payload. 
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED</h3>

<p>IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED:  This notify is included in the IKE_AUTH request/response to indicate 
     support for IPsec SA replay counter synchronization mechanism described in this document. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |C|  RESERVED   |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Protocol ID(=0)| SPI Size (=0) |      Notify Message Type      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p> The 'Next Payload', 'Payload Length', 'Protocol ID', 'SPI Size', and 'Notify Message Type'
           fields are the same as described in Section 3 of <a class='info' href='#RFC5996'>[RFC5996]<span> (</span><span class='info'>Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;Internet Key Exchange Protocol: IKEv2,&rdquo; September&nbsp;2010.</span><span>)</span></a>.  
            The 'SPI Size' field MUST be set  to 0 to indicate that the SPI is not present in this message.  
            The 'Protocol ID' MUST be set to 0, since the notification is not specific to a particular security association. 
      
            'Payload Length' field is set to the length in octets of the entire payload, including 
             the generic payload header.  The 'Notify Message Type' field is set to indicate the 
            IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED payload. 
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
IKEV2_MESSAGE_ID_SYNC</h3>

<p> IKEV2_MESSAGE_ID_SYNC :  This payload type is defined to sync the IKEv2 message Ids among
             newly-active [standby] member and the peer. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |    RESERVED   |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Failover count                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Nonce Data                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             EXPECTED_SEND_REQ_MESSAGE_ID       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             EXPECTED_RECV_REQ_MESSAGE_ID        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div>
<p> It contains the following data.</p>
<ul class="text">
<li> Failover count (4 octets) : The failover count within the cluster, it increases with each failover event in HA cluster. 
</li>
<li>  Nonce Data (4 octets)  :   The random nonce data. It should be sent same in the SYNC Request and Response.
             The nonce data is used to counter the replay of IKEV2_MESSAGE_ID_SYNC response by the attacker. 
</li>
<li> EXPECTED_SEND_REQ_MESSAGE_ID (4 octets) : This MUST be present only if protocol ID is IKE. 
            This field is used by the sender of this notify,  to indicate the message Id it will use in the next request, 
             that it will send to the other side peer. 
</li>
<li> EXPECTED_RECV_REQ_MESSAGE_ID (4 octets) : This field is used by the sender of this notify,
              to indicate the message Id it can accept in the next request, received from the other side peer.
</li>
</ul><p> 
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
IPSEC_REPLAY_COUNTER_SYNC</h3>

<p> IPSEC_REPLAY_COUNTER_SYNC:  This payload type is defined to sync the IPsec SA replay counters among
             newly-active [standby] member and the peer. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Payload  |ESN| RESERVED   |         Payload Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Failover count                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Outgoing IPsec SA  counter                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p> It contains the following data.</p>
<ul class="text">
<li> ESN (1 bit) : The ESN bit MUST be ON if IPsec SA were established with Extended Sequence Numbers. 
</li>
<li> Failover count (4 octets) : The failover count within the cluster, it increases with each failover event in HA cluster. 
</li>
<li> Outgoing IPsec SA  counter (4 octets or 8 octect) : The outgoing IPsec SA counter is the bumped-up outgoing IPsec SA
             replay counter value considering ALL Child SA under the IKEv2 SA. The size of outgoing IPsec SA counter depends on ESN bit.
             If ESN bit is ON, it is size of 8 octets else it is 4 octets. 
</li>
</ul><p> 
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Details of implementation</h3>

<p> The message Id used IKEV2_MESSAGE_ID_SYNC exchange MUST be zero so that it is not validated
   upon receipt as per IKEv2 windowing. Message Id zero MUST be permitted only for informational exchange that would have
   NOTIFY of type IKEV2_MESSAGE_ID_SYNC. If any INFORMATIONAL exchange uses the message Id Zero,
   without having this Notify, then such packets MUST be discarded upon decryption and INVALID_SYNTAX notify SHOULD be sent.
   No other payloads are allowed in this Informational exchange. Whenever IKEV2_MESSAGE_ID_SYNC or
   IPSEC_REPLAY_COUNTER_SYNC notify is received with invalid failover count or nonce data, the event SHOULD be logged. 
</p>
<p>    The standby member can initiate the synchronization of IKEv2 Message Id's    </p>
<ul class="text">
<li>  When it receives the bad IKEv2/IPsec packet. The 'bad" IKEv2/IPsec packet means a packet outside receive window.
</li>
<li> When it has to send an IKEv2/IPsec packet after failover event.
</li>
<li>  It has just got the control from active member and would require to update the values before-hand,
        so that it need not start this exchange at the time of sending/receiving the request.
</li>
</ul><p>
      
</p>
<p>    The standby member can initiate the synchronization of IPsec SA Counters     </p>
<ul class="text">
<li>  If there is traffic using the IPsec SA in the recent past and there could be stale replay counter at standby member
</li>
</ul><p>
      
</p>
<p> Since there can be many sessions at Standby member, and sending exchanges from all of the
        sessions can cause throttling, the standby member can choose to initiate the exchange when it has to
        send or receive the request. Thus the trigger to initiate this exchange depends on the requirement/discretion
        of the standby member.
</p>
<p> The member which has not announced its capability  IKEV2_MESSAGE_ID_SYNC_SUPPORTED
            MUST NOT send/receive  the notify IKEV2_MESSAGE_ID_SYNC.
</p>
<p> The member which has not announced its capability  IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED
            MUST NOT send/receive the notify IPSEC_REPLAY_COUNTER_SYNC.
</p>
<p> If a peer gets IKEV2_MESSAGE_ID_SYNC or  IPSEC_REPLAY_COUNTER_SYNC request even though it did not announce its capability in 
            IKE_AUTH exchange,  then it MUST ignore this message. 
</p>
<p> If any of the Notify or the SYNC request/response is malformed, then it is treated as INVALID_SYNTAX message.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Step-by-Step details</h3>

<p>
The step by step details of the synchronization of IKE message Id  is as follows.

 </p>
<ul class="text">
<li> Active member and peer device establish the session . They announce the capability to sync the counter info 
by sending  IKEV2_MESSAGE_ID_SYNC_SUPPORTED notify in IKE_AUTH Exchange.
</li>
<li> Active member dies and Stand-by member takes over.
 Standby Member sends its own idea of the IKE Message ID (its side) to peer in an INFORMATIONAL message exchange with 
 message Id zero. 
</li>
<li> The peer first authenticates the message and then validates that failover count. The peer will compare the received values
       with the values available locally and finally picks the higher value. It then updates its message Id's with the higher values and 
       also propose the same in Response.
</li>
<li>The peer should not wait for pending response  while responding with this message Id values.
 For example if window size is 5 and peer window is 3-7  and if peer has sent requests 3, 4,5,6,7 and 
but got response only for 4,5,6,7 but not 3 then  it should send the EXPECTED_SEND_REQ_MESSAGE_ID as 
8 and should not wait for response of 3 anymore.
</li>
<li>  The peer should not wait for pending request also. For example if window size is 5 and 
 peer window is 3-7  and if peer has received requests 4,5,6,7 but not 3 then  it should send the
EXPECTED_RECV_REQ_MESSAGE_ID as 8 and should not wait for 3 anymore.
</li>
</ul><p>

</p>
<p> There is corner case with "failover count' and multiple failover. What if "failover count" is not updated on a member, and next "failover" happened,
      then "failover count" is updated on other side but not on this member. [[ This need to be discussed on mailing list. ]]  
</p>
<a name="Security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Security Considerations</h3>

<p>
There can be two types of DOS attacks.

 </p>
<ul class="text">
<li>  Replay of Message SYNC Request.
   This is countered by "failover count", since synchronization starts after failover event and each member of the cluster is aware of failover event.
   The receiver of sync request should verify and maintain failover count. If a peer again receives a sync request with same "failover count', it can safely
   safely discard the request if it has received valid request/response from other side peer after sync exchange. The peer can send the cached response 
   for sync request till it has not received valid request/response from other side peer or failover count has not increased. 
</li>
<li> Replay of Message SYNC Response.
   This is countered by sending the NONCE data along with the sync notify. The same  NONCE 
    data has to be returned in response.  Thus the standby member can accept the reply only for the current request.
   After it receives the valid response, it MUST NOT process same response again and MUST discard the response.

</li>
</ul><p>   


</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Interaction with other drafts</h3>

<p>
         The primary assumption of IKEv2/IPsec SA Counter Synchronization proposal is IKEv2 SA has been established between 
          active member of Hot Standby Cluster and peer, after that the failover event occurred and now standby member 
          has "become" active. It also assumes the IKEv2 SA state was synced between active and standby member of the 
          Hot Standby Cluster before the failover event.

 </p>
<ul class="text">
<li>  Session Resumption. 
          Session resumption assumes that peer i.e. client or initiator detects the need to re-establish the session. In 
          IKEv2/IPsec SA counter synchronization, standby member which becomes active i.e. gateway or responder
          detects the need to synchronize the SA counter after the failover event. 
          Also in Hot Standby Cluster, peer establishes the IKEv2/IPsec session with single cluster's IP address, so peer normally does
          not detect the event of failover in the cluster until standby member took very long to become active and IKEv2 SA times out via
          liveness check. So, session resumption and SA counter synchronization after failover are mutually exclusive.
</li>
<li> This document describes the operation of tightly coupled clusters, which are the common way of building IPsec clusters.
          In these clusters, all members appear to the peer as one gateway, specifically they share a single IP address.
          High availability can also be provided by loosely coupled clusters (for lack of a better term), which are a group of gateways
          that do not share an IP address and do not synchronize state. 
          In this architecture, the client can use Session Resumption to fail-over from one cluster member to another. Specifically this requires:
       
<ul class="text">
<li>Support of session resumption on peers and gateways.
</li>
<li>A common session resumption ticket format on all gateways (not currently standardized).
</li>
<li>Configuration on the peers of the group of gateways that constitute the cluster.
</li>
</ul>
    
</li>
<li> Redirect.
         Redirect mechanism for load-balancing can be used during init (IKE_SA_INIT) and auth (IKE_AUTH) and after session 
         establishment. While SA counter sync is used after IKE SA has been established and failover event has occurred.
         So it is mutually exclusive with redirect during init and auth. The redirect after session established is used for timed
         or planned shutdown/maintenance. The failover event can not be detected on active member beforehand and so using 
         redirect after session establishment is not possible in case of failover. So, Redirect and SA counter synchronization 
         after failover are mutually exclusive.
    
</li>
<li> Crash detection. 
         Solves the similar problem where peer detect that cluster member has crashed based on a token. It is mutually exclusive with HA with SA counter sync.
    
</li>
</ul><p>   


</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
IANA Considerations</h3>

<p>
        This document  introduces four new IKEv2 Notification Message types as
        described in Section 6.The new Notify Message Types must be assigned values between 16396 and 40959.
   </p>
<ul class="text">
<li> IKEV2_MESSAGE_ID_SYNC_SUPPORTED. 
</li>
<li> IPSEC_REPLAY_COUNTER_SYNC_SUPPORTED. 
</li>
<li> IKEV2_MESSAGE_ID_SYNC. 
</li>
<li> IPSEC_REPLAY_COUNTER_SYNC.
</li>
</ul><p>
    
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Acknowledgements</h3>

<p>  We would like to thank Pratima Sethi and Frederic Detienne for their reviews comments and valuable suggestions
              for initial version of the document.  
</p>
<p>  We would also like to thank following people (in alphabetical order) for their review comments and valuable 
             suggestions:  Dan Harkins, Paul Hoffman, Steve Kent, Tero Kivinen, David McGrew, Pekka Riikonen, and Yaron Sheffar. 
</p>
<a name="history"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
Change Log</h3>

<p> This section lists all the changes in this document. 
</p>
<p> NOTE TO RFC EDITOR: Please remove this section before publication.
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13.1"></a><h3>13.1.&nbsp;
Draft  -01</h3>

<p> Added "Multiple and Simultaneous failover' scenarios.
</p>
<p> Now document provides a mechanism to sync either IKEv2 message or IPsec replay counter or both to cater different types of implementations. 
</p>
<p> HA cluster's "failover count' is used to encounter replay of sync requests by attacker. 
</p>
<p> The sync of IPsec SA replay counter optimized to to have just one global bumped-up outgoing IPsec SA counter of ALL Child SAs under an IKEv2 SA. 
</p>
<p> The examples added for IKEv2 message Id sync to provide more clarity. 
</p>
<p> Some edits as per comments on mailing list to enhance clarity. 
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13.2"></a><h3>13.2.&nbsp;
Draft  -00</h3>

<p> Version 00 is identical to draft-kagarigi-ipsecme-ikev2-windowsync-04, started as WG 
              document.
</p>
<p> Added IPSECME WG HA design team members as authors. 
</p>
<p> Added comment in Introduction to discuss the window sync process on WG mailing list to solve some concerns. 
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>14.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="IPsec Cluster Problem Statement">[IPsec Cluster Problem Statement]</a></td>
<td class="author-text">Nir, Y., &ldquo;IPsec Cluster Problem Statement,&rdquo; July&nbsp;2010.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement
            Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5996">[RFC5996]</a></td>
<td class="author-text">Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;<a href="http://tools.ietf.org/html/rfc5996">Internet Key Exchange Protocol: IKEv2</a>,&rdquo; RFC&nbsp;5996, September&nbsp;2010 (<a href="http://tools.ietf.org/id/draft-ietf-IPsecme-ikev2bis">TXT</a>, <a href="http://tools.ietf.org/html/draft-ietf-IPsecme-ikev2bis">HTML</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>14.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC5685">[RFC5685]</a></td>
<td class="author-text">Devarapalli, V. and K. Weniger, &ldquo;<a href="http://tools.ietf.org/html/rfc5685">Redirect Mechanism for IKEv2</a>,&rdquo; RFC&nbsp;5685, November&nbsp;2009 (<a href="http://www.ietf.org/rfc/rfc5685.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc5685.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc5685.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5723">[RFC5723]</a></td>
<td class="author-text">Sheffer, Y. and H. Tschofenig, &ldquo;<a href="http://tools.ietf.org/html/rfc5723">IKEv2 Session Resumption</a>,&rdquo; RFC&nbsp;5723, January&nbsp;2010 (<a href="http://www.ietf.org/rfc/rfc5723.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc5723.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc5723.xml">XML</a>).</td></tr>
</table>

<a name="Examples"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
IKEv2 Message Id examples</h3>

<p>

Below are the examples to illustrate how the IKEv2 message Id values are synced.
The notation used to denote EXPECTED_SEND_REQ_MESSAGE_ID and  EXPECTED_RECV_REQ_MESSAGE_ID
on a member is (EXPECTED_SEND_REQ_MESSAGE_ID, EXPECTED_RECV_REQ_MESSAGE_ID). 
</p>
<p> Normal  failover - Example 1
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Standby [Newly Active] Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Request SYNC (2, 3) --------&gt;

                          Peer has values as (4, 5) so it sends
             &lt; -------------( 4, 5) Response SYNC

</pre></div>
<p> Normal  failover - Example 2
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

Standby [Newly Active] Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Request SYNC (2, 5) --------&gt;

                          Peer has values as (2, 4) so it sends
             &lt; -------------( 5, 4) Response SYNC

</pre></div>
<p>  Simultaneous  failover 
</p>
<p>In case of simultaneous failover, both the sides send the SYNC request, but whichever side has the higher value will be
eventually synced.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Standby [Newly Active] Member                            Peer
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

request SYNC (4,4)     -----&gt;

                 &lt;-------------- request SYNC (5,5)

    response SYNC (5,5)    ----&gt;

               &lt;--------  response SYNC (5,5)

</pre></div>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Raj Singh (Editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Divyashree Chambers, B Wing, O'Shaugnessy Road</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bangalore, Karnataka  560025</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">India</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+91 80 4301 3320</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:rsj@cisco.com">rsj@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Kalyani Garigipati</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Divyashree Chambers, B Wing, O'Shaugnessy Road</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bangalore, Karnataka  560025</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">India</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+91 80 4426 4831</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:kagarigi@cisco.com">kagarigi@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Yoav Nir</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Check Point Software Technologies Ltd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5 Hasolelim st.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tel Aviv  67897</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Israel</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ynir@checkpoint.com">ynir@checkpoint.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dacheng Zhang</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Huawei Technologies Ltd.</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:zhangdacheng@huawei.com">zhangdacheng@huawei.com</a></td></tr>
</table>
</body></html>
