<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Using HMAC-authenticated Encryption in the Cryptographic Message Syntax (CMS)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Using HMAC-authenticated Encryption in the Cryptographic Message Syntax (CMS)">
<meta name="keywords" content="Internet-Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">S/MIME Working Group</td><td class="header">P. Gutmann</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">University of Auckland</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">May 17, 2010</td></tr>
<tr><td class="header">Expires: November 18, 2010</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Using HMAC-authenticated Encryption in the Cryptographic Message Syntax (CMS)<br />draft-gutmann-cms-hmac-enc-01.txt</h1>

<h3>Abstract</h3>

<p>

This document specifies the conventions for using HMAC-authenticated
encryption with the Cryptographic Message Syntax (CMS)
authenticated-enveloped-data content type.  This mirrors the use of HMAC
combined with an encryption algorithm that's already employed in IPsec,
SSL/TLS, and SSH, which is widely supported in existing crypto libraries and
hardware, and has been extensively analysed by the crypto community.

      
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on November 18, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#introduction">1.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#mustshouldmay">1.1.</a>&nbsp;
Conventions Used in This Document<br />
<a href="#usecase">2.</a>&nbsp;
Background<br />
<a href="#overview">3.</a>&nbsp;
CMS Encrypt-and-Authenticate Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#overview_rationale">3.1.</a>&nbsp;
Rationale<br />
<a href="#enc-auth">4.</a>&nbsp;
CMS Encrypt-and-Authenticate <br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#processing">4.1.</a>&nbsp;
Encrypt-and-Authenticate Message Processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#processing-rationale">4.2.</a>&nbsp;
Rationale<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#test-vectors">4.3.</a>&nbsp;
Test Vectors<br />
<a href="#smimecaps">5.</a>&nbsp;
SMIMECapabilities Attribute<br />
<a href="#security">6.</a>&nbsp;
Security Considerations<br />
<a href="#iana">7.</a>&nbsp;
IANA Considerations<br />
<a href="#rfc.references1">8.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">8.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">8.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="introduction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>

This document specifies the conventions for using HMAC-authenticated
encryption with the Cryptographic Message Syntax (CMS)
authenticated-enveloped-data content type.  This mirrors the use of HMAC
combined with an encryption algorithm that's already employed in IPsec,
SSL/TLS, and SSH, which is widely supported in existing crypto libraries and
hardware, and has been extensively analysed by the crypto community.

      
</p>
<a name="mustshouldmay"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
Conventions Used in This Document</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
          "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described
          in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="usecase"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Background</h3>

<p>

Integrity-protected encryption is a standard feature of session-oriented
security protocols like IPsec <a class='info' href='#IPsec'>[IPsec]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>,
SSH <a class='info' href='#SSH'>[SSH]<span> (</span><span class='info'>Ylonen, T. and C. Lonvick, &ldquo;The Secure Shell (SSH) Transport Layer Protocol,&rdquo; Janaury&nbsp;2006.</span><span>)</span></a>, and SSL/TLS <a class='info' href='#TLS'>[TLS]<span> (</span><span class='info'>Dierks, T. and E. Rescorla, &ldquo;The Transport Layer Security (TLS) Protocol Version 1.2,&rdquo; August&nbsp;2008.</span><span>)</span></a>, but until recently
wasn't available for message-based security protocols like CMS, although PGP
added a form of integrity protection by encrypting a SHA-1 hash of the message
alongside the message contents to provide authenticate-and-encrypt protection
<a class='info' href='#OpenPGP'>[OpenPGP]<span> (</span><span class='info'>Callas, J., Donnerhacke, L., Hal, H., Shaw, D., and R. Thayer, &ldquo;OpenPGP Message Format,&rdquo; November&nbsp;2007.</span><span>)</span></a>.  Usability studies have shown that users expect
encryption to provide integrity protection <a class='info' href='#Garfinkel'>[Garfinkel]<span> (</span><span class='info'>Garfinkel, S., &ldquo;Design Principles and Patterns for Computer Systems That Are Simultaneously Secure and Usable,&rdquo; May&nbsp;2005.</span><span>)</span></a>,
creating cognitive dissonance problems when the security mechanisms don't in
fact provide this assurance.

      
</p>
<p>

This document applies the same encrypt-and-authenticate mechanism already
employed in IPsec, SSH, and SSL/TLS, to CMS (technically some of these
actually use authenticate-and-encrypt rather than encrypt-and-authenticate,
since what's authenticated is the plaintext and not the ciphertext).  This
mechanism is widely supported in existing crypto libraries and hardware, and
has been extensively analysed by the crypto community.

      
</p>
<a name="overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
CMS Encrypt-and-Authenticate Overview</h3>

<p>

Conventional CMS encryption uses a content encryption key (CEK) to encrypt a
message payload.  Authenticated encryption requires two keys, one for
encryption and a second one for authentication.  Like other mechanisms that
use authenticated encryption, this document employs a pseudorandom function
(PRF) to convert a single block of keying material into the two keys required
for encryption and authentication.  This converts the standard CMS encryption
operation:

        </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     KEK( CEK ) || CEK( data )
</pre></div><p>


into:

        </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     KEK( master_secret ) || HMAC( encrypt( data ) )
</pre></div><p>


where the HMAC and encryption keys are derived from the master_secret via:

        </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     HMAC-K := PRF( master_secret, "authentication" );
     CEK-K := PRF( master_secret, "encryption" );
</pre></div><p>


      
</p>
<a name="overview_rationale"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Rationale</h3>

<p>

There are several possible means of deriving the two keys required for the
encrypt-and-authenticate process from the single key normally provided by the
key exchange or key transport mechanisms.  Several of these however have
security or practical issues.  For example any mechanism that uses the single
exchanged key in its entirety for encryption (using, perhaps, PRF( key ) as
the HMAC key) can be converted back to unauthenticated data by removing the
outer HMAC layer and rewriting the CMS envelope back to plain EnvelopedData or
EncryptedData.  By applying the PRF intermediate step, any attempt at a
rollback attack will result in a decryption failure.

      
</p>
<p>

The option chosen here, the use of a PRF to derive the necessary sets of
keying material from a master secret, is well-established through its use in
IPsec, SSH, and SSL/TLS, and is widely supported in both crypto libraries and
in encryption hardware.

      
</p>
<p>

The PRF used is PBKDF2 because its existing use in CMS makes it the most
obvious candidate for such a function.  If in the future a universal PRF, for
example the proposed HKDF, is adopted, this can be substituted for PBKDF2 by
specifying it in the prfAlgo field covered in <a class='info' href='#enc-auth'>Section&nbsp;4<span> (</span><span class='info'>CMS Encrypt-and-Authenticate </span><span>)</span></a>.

      
</p>
<p>

The resulting processing operations consist of a combination of the operations
used for the existing CMS content types EncryptedData and AuthenticatedData,
allowing them to be implemented relatively simply using existing code.

      
</p>
<a name="enc-auth"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
CMS Encrypt-and-Authenticate </h3>

<p>

The encrypt-and-authenticate mechanism is implemented within the existing CMS
RecipientInfo framework by defining a new pseudo-algorithm type authEnc which
is used in place of the existing single-purpose encrypt-only or HMAC-only
algorithm.  This pseudo-algorithm is used as a key container for the master
secret from which the encryption and authentication keys are derived.  Thus
instead of using the RecipientInfo to communicate (for example) an AES or
HMAC-SHA1 key, it communicates an authEnc keying value from which the required
AES encryption and HMAC-SHA1 authentication keys are derived.

      
</p>
<p>

The authEnc pseudo-algorithm comes in two forms, one providing 128 bits of
keying material and one providing 256 bits:

        </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     id-smime OBJECT IDENTIFIER ::= { iso(1) member-body(2)
                us(840) rsadsi(113549) pkcs(1) pkcs9(9) 16 }

     id-alg  OBJECT IDENTIFIER ::= { id-smime 3 }

     id-alg-authEnc-128 OBJECT IDENTIFIER ::= { id-alg 15 }
     id-alg-authEnc-256 OBJECT IDENTIFIER ::= { id-alg 16 }
</pre></div><p>


The algorithm parameters are:

        </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     AuthEncParams ::= SEQUENCE {
         prfAlgo   [0] AlgorithmIdentifier DEFAULT PBKDF2,
         encAlgo       AlgorithmIdentifier,
         hmacAlgo      AlgorithmIdentifier
         }
</pre></div><p>


      
</p>
<p>
        </p>
<blockquote class="text">
<p>prfAlgo is the PRF algorithm used to convert the authEnc value into
		the encryption and MAC keys.  The default PRF is PBKDF2
		<a class='info' href='#PBKDF2'>[PBKDF2]<span> (</span><span class='info'>Kaliski, B., &ldquo;PKCS #5: Password-Based Cryptography Specification,&rdquo; September&nbsp;2000.</span><span>)</span></a>.
</p>
<p>encAlgo is the encryption algorithm and associated parameters to be
		used to encrypt the content.
</p>
<p>hmacAlgo is the HMAC algorithm and associated parameters to be used
		to authenticate/integrity-protect the content.
</p>
</blockquote><p>
      
</p>
<a name="processing"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Encrypt-and-Authenticate Message Processing</h3>

<p>

The randomly-generated authEnc key to be communicated via the RecipientInfo(s)
is converted to separate encryption and authentication keys and applied to the
encrypt-and-authenticate process as follows.  The notation
"PRF( key, salt, iterations )" is used to denote an application of the PRF to
the given keying value and salt, for the given number of iterations:

      
</p>
<p>
        </p>
<ol class="text">
<li>The HMAC algorithm key is derived from the authEnc key via:
          <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
          HMAC-K ::= PRF( authEnc_key, "authentication", 1 );
</pre></div>
</li>
<li>The encryption algorithm key is derived from the authEnc key via:
          <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
          Enc-K ::= PRF( authEnc_key, "encryption", 1 );
</pre></div>
</li>
<li>The data is processed as described in <a class='info' href='#AuthEnv'>[AuthEnv]<span> (</span><span class='info'>Housley, R., &ldquo;Cryptographic Message Syntax (CMS) Authenticated-Enveloped-Data Content Type,&rdquo; November&nbsp;2007.</span><span>)</span></a>,
		  and specifically since the mechanisms used are a union of
		  EncryptedData and AuthenticatedData, as per <a class='info' href='#CMS'>[CMS]<span> (</span><span class='info'>Housley, R., &ldquo;Cryptographic Message Syntax (CMS),&rdquo; September&nbsp;2009.</span><span>)</span></a>.
		  The EncryptedData processing is applied first and then the
		  AuthenticatedData processing is applied to the result, so that the
		  nesting is:
          <div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
          HMAC( encrypt( content ) );
</pre></div>
</li>
</ol><p>
      
</p>
<a name="processing-rationale"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Rationale</h3>

<p>

The authEnc pseudo-algorithm has two "key sizes" rather than the
one-size-fits-all that the PRF impedance-matching would provide.  This is done
to address real-world experience from use of AES keys where users demanded
AES-256 alongside AES-128 because of some perception that the former was
"twice as good" as the latter.  Providing an option for keys that go to 11
avoids potential user acceptance problems when someone notices that the
authEnc pseudo-key has "only" 128 bits when they expect their AES keys to be
256 bits long.

        
</p>
<p>

Using a fixed-length key rather than making it a user-selectable parameter is
done for the same reason as AES' quantised key lengths: there's no benefit to
allowing, say, 137-bit keys over basic 128- and 256-bit lengths, it adds
unnecessary complexity, and if the lengths are user-defined then there'll
always be someone who wants keys that go up to 12.  Providing a choice of two
commonly-used lengths gives users the option of choosing a "better" key size
should they feel the need, while not overloading the system with unneeded
flexibility.

        
</p>
<p>

Apart from the extra step added to key management, all of the processing is
already specified as part of the definition of the standard CMS content-types
Encrypted/EnvelopedData and AuthenticatedData.  This significantly simplifies
both the specification and the implementation task, as no new
content-processing mechanisms are introduced.

        
</p>
<a name="test-vectors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Test Vectors</h3>

<p>

The following test vectors may be used to verify an implementation of
HMAC-authenticated encryption.  This represents a text string encrypted and
authenticated using the password "Password" via CMS PasswordRecipientInfo.
The encryption algorithm used is triple DES, whose short block size (compared
to AES) makes it easier to corrupt arbitrary bytes for testing purposes within
the self-healing CBC mode which will result in correct decryption but a failed
MAC check.

        
</p>
<p>
        </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   0  227: SEQUENCE {
   3   11:   OBJECT IDENTIFIER authEnvelopedData
                               (1 2 840 113549 1 9 16 1 23)
  16  211:   [0] {
  19  208:     SEQUENCE {
  22    1:       INTEGER 0
  25   97:       SET {
  27   95:         [3] {
  29    1:           INTEGER 0
  32   27:           [0] {
  34    9:             OBJECT IDENTIFIER pkcs5PBKDF2
                                         (1 2 840 113549 1 5 12)
  45   14:             SEQUENCE {
  47    8:               OCTET STRING B9 2B 0A 27 E2 18 EE CC
  57    2:               INTEGER 2000
         :               }
         :             }
  61   35:           SEQUENCE {
  63   11:             OBJECT IDENTIFIER pwriKEK
                                         (1 2 840 113549 1 9 16 3 9)
  76   20:             SEQUENCE {
  78    8:               OBJECT IDENTIFIER des-EDE3-CBC
                                           (1 2 840 113549 3 7)
  88    8:               OCTET STRING 82 42 45 76 64 C3 EC AE
         :               }
         :             }
  98   24:           OCTET STRING
         :             32 30 75 13 74 DA 48 AD 7B 12 93 56 80 30 99 83
         :             8D DC B9 F5 CF 00 CD A4
         :           }
         :         }
 124   82:       SEQUENCE {
 126    9:         OBJECT IDENTIFIER data (1 2 840 113549 1 7 1)
 137   51:         SEQUENCE {
 139   11:           OBJECT IDENTIFIER authEnc128
                                       (1 2 840 113549 1 9 16 3 15)
 152   36:           SEQUENCE {
 154   20:             SEQUENCE {
 156    8:               OBJECT IDENTIFIER des-EDE3-CBC
                                           (1 2 840 113549 3 7)
 166    8:               OCTET STRING 86 60 D4 78 D7 8F 2C 13
         :               }
 176   12:             SEQUENCE {
 178    8:               OBJECT IDENTIFIER hmacSHA (1 3 6 1 5 5 8 1 2)
 188    0:               NULL
         :               }
         :             }
         :           }
 190   16:         [0] 6F 46 3F 60 69 D7 13 B5 73 9E 8A 7D 51 B1 80 C6
         :         }
 208   20:       OCTET STRING
         :         DC 4C 18 3D 46 2E 9C 7C 5D 2A A3 07 C6 BF AE 09
         :         F2 B6 84 5D
         :       }
         :     }
         :   }
</pre></div><p>

        
</p>
<a name="smimecaps"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
SMIMECapabilities Attribute</h3>

<p>

An S/MIME client SHOULD announce the set of cryptographic functions that it
supports by using the S/MIME capabilities attribute <a class='info' href='#SMIME'>[SMIME]<span> (</span><span class='info'>Ramsdell, B. and S. Turner, &ldquo;Secure/Multipurpose Internet Mail Extensions (S/MIME) Version 3.2 Message Specification,&rdquo; January&nbsp;2010.</span><span>)</span></a>.
If the client wishes to indicate support for HMAC-authenticated encryption,
the capabilities attribute MUST contain the authEnc128 and/or authEnc256 OID
specified above with algorithm parameters of NULL.  Other parameters such as
the HMAC and encryption algorithms are specified in the standard manner, for
example through their own SMIMECapabilities attributes or by mutual agreement.

      
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>

Unlike other CMS authenticated-data mechanisms like SignedData and
AuthenticatedData, AuthEnv's primary transformation isn't authentication but
encryption, so that AuthEnvData may decrypt successfully (in other words the
primary data transformation present in the mechanism will succeed) but the
secondary function of authentication using the MAC value that follows the
encrypted data could still fail.  This can lead to a situation in which an
implementation might output decrypted data before it reaches and verifies the
MAC value.  In other words decryption is performed inline and the result is
available immediately, while the authentication result isn't available until
all of the content has been processed.  If the implementation prematurely
provides data to the user and later comes back to inform them that the earlier
data was, in retrospect, tainted, this may cause users to act prematurely on
the tainted data.

        
</p>
<p>

This situation could occur in a streaming implementation where
data has to be made available as soon as possible (so the initial plaintext is
emitted before the final ciphertext and MAC value are read), or one where the
quantity of data involved rules out buffering the recovered plaintext until
the MAC value can be read and verified.  In addition an implementation that
tries to be overly helpful may treat missing non-payload trailing data as
non-fatal, allowing an attacker to truncate the data somewhere before the MAC
value and thereby defeat the data authentication.  This is complicated even
further by the fact that an implementation may not be able to determine, when
it encounters truncated data, whether the remainder (including the MAC value)
will arrive presently (a non-failure) or whether it's been truncated by an
attacker and should therefore be treated as a MAC failure.  (Note that this
same issue affects other types of data authentication like signed and MACd
data as well, since an over-optimistic implementation may return data to the
user before checking for a verification failure is possible).

        
</p>
<p>

The exact solution to these issues is somewhat implementation-specific, with
some suggested mitigations being as follows: Implementations should buffer the
entire message if possible and verify the MAC before performing any
decryption.  If this isn't possible due to streaming or message-size
constraints, implementations should consider breaking long messages into a
sequence of smaller ones, each of which can be processed atomically as above.
If even this isn't possible implementations should make obvious to the caller
or user that an authentication failure has occurred and the
previously-returned or output data shouldn't be used.  Finally, any
data-formatting problem such as obviously truncated data or missing trailing
data should be treated as a MAC verification failure even if the rest of the
data was processed correctly.

      
</p>
<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA Considerations</h3>

<p>

This document contains two algorithm identifiers defined by the SMIME Working
Group Registrar in an arc delegated by RSA to the SMIME Working Group: iso(1)
member-body(2) us(840) rsadsi(113549) pkcs(1) pkcs-9(9) smime(16) modules(0).
No action by IANA is necessary for this document or any anticipated updates.

      
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="AuthEnv">[AuthEnv]</a></td>
<td class="author-text">Housley, R., &ldquo;<a href="http://tools.ietf.org/html/rfc5083">Cryptographic Message Syntax (CMS) Authenticated-Enveloped-Data Content Type</a>,&rdquo; RFC&nbsp;5083, November&nbsp;2007 (<a href="http://www.ietf.org/rfc/rfc5083.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="CMS">[CMS]</a></td>
<td class="author-text">Housley, R., &ldquo;<a href="http://tools.ietf.org/html/rfc5652">Cryptographic Message Syntax (CMS)</a>,&rdquo; RFC&nbsp;5652, September&nbsp;2009 (<a href="http://www.ietf.org/rfc/rfc5652.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="PBKDF2">[PBKDF2]</a></td>
<td class="author-text">Kaliski, B., &ldquo;<a href="http://tools.ietf.org/html/rfc2898">PKCS #5: Password-Based Cryptography Specification</a>,&rdquo; RFC&nbsp;2898, September&nbsp;2000 (<a href="http://www.ietf.org/rfc/rfc2898.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text">Bradner, S., &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SMIME">[SMIME]</a></td>
<td class="author-text">Ramsdell, B. and S. Turner, &ldquo;<a href="http://tools.ietf.org/html/rfc5751">Secure/Multipurpose Internet Mail Extensions (S/MIME) Version 3.2 Message Specification</a>,&rdquo; RFC&nbsp;5751, January&nbsp;2010 (<a href="http://www.ietf.org/rfc/rfc5751.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="Garfinkel">[Garfinkel]</a></td>
<td class="author-text">Garfinkel, S., &ldquo;Design Principles and Patterns for Computer Systems That Are Simultaneously Secure and Usable,&rdquo; May&nbsp;2005.</td></tr>
<tr><td class="author-text" valign="top"><a name="IPsec">[IPsec]</a></td>
<td class="author-text">Kent, S. and K. Seo, &ldquo;<a href="http://tools.ietf.org/html/rfc4301">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;4301, December&nbsp;2005 (<a href="http://www.ietf.org/rfc/rfc4301.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="OpenPGP">[OpenPGP]</a></td>
<td class="author-text">Callas, J., Donnerhacke, L., Hal, H., Shaw, D., and R. Thayer, &ldquo;<a href="http://tools.ietf.org/html/rfc4880">OpenPGP Message Format</a>,&rdquo; RFC&nbsp;4880, November&nbsp;2007 (<a href="http://www.ietf.org/rfc/rfc4880.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SSH">[SSH]</a></td>
<td class="author-text">Ylonen, T. and C. Lonvick, &ldquo;<a href="http://tools.ietf.org/html/rfc4253">The Secure Shell (SSH) Transport Layer Protocol</a>,&rdquo; RFC&nbsp;4253, Janaury&nbsp;2006 (<a href="http://www.ietf.org/rfc/rfc4253.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="TLS">[TLS]</a></td>
<td class="author-text">Dierks, T. and E. Rescorla, &ldquo;<a href="http://tools.ietf.org/html/rfc5246">The Transport Layer Security (TLS) Protocol Version 1.2</a>,&rdquo; RFC&nbsp;5246, August&nbsp;2008 (<a href="http://www.ietf.org/rfc/rfc5246.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Peter Gutmann</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">University of Auckland</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Department of Computer Science</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">New Zealand</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:pgut001@cs.auckland.ac.nz">pgut001@cs.auckland.ac.nz</a></td></tr>
</table>
</body></html>
