<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Tunnelling of Explicit Congestion
    Notification</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Tunnelling of Explicit Congestion
    Notification">
<meta name="keywords" content="Congestion Control and Management, Congestion Notification, Information Security, Tunnelling, Encapsulation &amp; Decapsulation, Protocol, ECN, IPsec">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Transport Area Working Group</td><td class="header">B. Briscoe</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">BT</td></tr>
<tr><td class="header">Updates: <a href='http://tools.ietf.org/html/rfc3168'>3168</a>, <a href='http://tools.ietf.org/html/rfc4301'>4301</a>, <a href='http://tools.ietf.org/html/rfc4774'>4774</a></td><td class="header">July 30, 2010</td></tr>
<tr><td class="header">(if&nbsp;approved)</td><td class="header">&nbsp;</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">&nbsp;</td></tr>
<tr><td class="header">Expires: January 31, 2011</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Tunnelling of Explicit Congestion
    Notification<br />draft-ietf-tsvwg-ecn-tunnel-09</h1>

<h3>Abstract</h3>

<p>This document redefines how the explicit congestion notification
      (ECN) field of the IP header should be constructed on entry to and exit
      from any IP in IP tunnel. On encapsulation it updates RFC3168 to bring
      all IP in IP tunnels (v4 or v6) into line with RFC4301 IPsec ECN
      processing. On decapsulation it updates both RFC3168 and RFC4301 to add
      new behaviours for previously unused combinations of inner and outer
      header. The new rules ensure the ECN field is correctly propagated
      across a tunnel whether it is used to signal one or two severity levels
      of congestion, whereas before only one severity level was supported.
      Tunnel endpoints can be updated in any order without affecting
      pre-existing uses of the ECN field, thus ensuring backward
      compatibility. Nonetheless, operators wanting to support two severity
      levels (e.g. for pre-congestion notification&mdash;PCN) can require
      compliance with this new specification. A thorough analysis of the
      reasoning for these changes and the implications is included. In the
      unlikely event that the new rules do not meet a specific need, RFC4774
      gives guidance on designing alternate ECN semantics and this document
      extends that to include tunnelling issues.
</p>
<h3>Status of This Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on January 31, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#ecntun_Introduction">1.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Scope">1.1.</a>&nbsp;
Scope<br />
<a href="#ecntun_Reqs_Language">2.</a>&nbsp;
Terminology<br />
<a href="#ecntun_Existing_RFCs">3.</a>&nbsp;
Summary of Pre-Existing RFCs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Existing_Ingress">3.1.</a>&nbsp;
Encapsulation at Tunnel Ingress<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Existing_Egress">3.2.</a>&nbsp;
Decapsulation at Tunnel Egress<br />
<a href="#ecntun_ECN_Tunnel_Rules">4.</a>&nbsp;
New ECN Tunnelling Rules<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Default_Ingress_Behaviour">4.1.</a>&nbsp;
Default Tunnel Ingress Behaviour<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Default_Egress_Behaviour">4.2.</a>&nbsp;
Default Tunnel Egress Behaviour<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Encap_Modes">4.3.</a>&nbsp;
Encapsulation Modes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Single_Decap_Mode">4.4.</a>&nbsp;
Single Mode of Decapsulation<br />
<a href="#ecntun_RFC_Changes">5.</a>&nbsp;
Updates to Earlier RFCs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Changes_RFC4301">5.1.</a>&nbsp;
Changes to RFC4301 ECN processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Changes_RFC3168">5.2.</a>&nbsp;
Changes to RFC3168 ECN processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Motivate_Changes">5.3.</a>&nbsp;
Motivation for Changes<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Motivate_Encap">5.3.1.</a>&nbsp;
Motivation for Changing Encapsulation<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Motivate_Decap">5.3.2.</a>&nbsp;
Motivation for Changing Decapsulation<br />
<a href="#ecntun_Backward_Compatibility">6.</a>&nbsp;
Backward Compatibility<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor1">6.1.</a>&nbsp;
Non-Issues Updating Decapsulation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">6.2.</a>&nbsp;
Non-Update of RFC4301 IPsec Encapsulation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">6.3.</a>&nbsp;
Update to RFC3168 Encapsulation<br />
<a href="#ecntun_Design_Principles">7.</a>&nbsp;
Design Principles for Alternate ECN Tunnelling Semantics<br />
<a href="#ecntun_IANA">8.</a>&nbsp;
IANA Considerations (to be removed on publication):<br />
<a href="#ecntun_Security_Considerations">9.</a>&nbsp;
Security Considerations<br />
<a href="#ecntun_Conclusions">10.</a>&nbsp;
Conclusions<br />
<a href="#ecntun_Acknowledgements">11.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">12.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">12.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">12.2.</a>&nbsp;
Informative References<br />
<a href="#ecntun_Early_History">Appendix&nbsp;A.</a>&nbsp;
Early ECN Tunnelling RFCs<br />
<a href="#ecntun_Design_Constraints">Appendix&nbsp;B.</a>&nbsp;
Design Constraints<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Security_Constraints">B.1.</a>&nbsp;
Security Constraints<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Ctrl_Constraints">B.2.</a>&nbsp;
Control Constraints<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ecntun_Mgmt_Constraints">B.3.</a>&nbsp;
Management Constraints<br />
<a href="#ecntun_Tunnel_Contribution">Appendix&nbsp;C.</a>&nbsp;
Contribution to Congestion across a Tunnel<br />
<a href="#ecntun_Compromise">Appendix&nbsp;D.</a>&nbsp;
Compromise on Decap with ECT(1) Inner and ECT(0) Outer<br />
<a href="#anchor6">Appendix&nbsp;E.</a>&nbsp;
Open Issues<br />
</p>
<br clear="all" />

<h3>Request to the RFC Editor (to be removed on publication):</h3>

<p>In the RFC index, RFC3168 should be identified as an update to
      RFC2003. RFC4301 should be identified as an update to RFC3168.
</p>
<h3>Changes from previous drafts (to be removed by the RFC Editor)</h3>

<p>Full text differences between IETF draft versions are available at
      &lt;http://tools.ietf.org/wg/tsvwg/draft-ietf-tsvwg-ecn-tunnel/&gt;, and
      between earlier individual draft versions at
      &lt;http://www.briscoe.net/pubs.html#ecn-tunnel&gt;</p>
<blockquote class="text"><dl>
<dt>From ietf-08 to ietf-09 (current):</dt>
<dd>Added change log
          entry for -07 to -08 that was previously omitted.
<ul class="text">
<li>Changes to standards action text:
<ul class="text">
<li>Added RFC4774 to 'Updates:' header (the draft always has
                  extended the advice in RFC4774 (BCP124) which said very
                  little about tunnels. The GENART reviewer merely pointed out
                  that the header did not highlight this fact.)
</li>
</ul>
</li>
<li>Editorial changes:
<ul class="text">
<li>Abstract: s/providing backward compatibility./thus
                  ensuring backward compatibility./
</li>
<li>Moved PCN-related text motivating changes to
                  decapsulation from "Default Tunnel Egress Behaviour" (<a class='info' href='#ecntun_Default_Egress_Behaviour'>Section&nbsp;4.2<span> (</span><span class='info'>Default Tunnel Egress Behaviour</span><span>)</span></a>) to "Motivation
                  for Changing Decapsulation" (<a class='info' href='#ecntun_Motivate_Decap'>Section&nbsp;5.3.2<span> (</span><span class='info'>Motivation for Changing Decapsulation</span><span>)</span></a>) where it was merged with
                  existing similar text.
</li>
<li>In the non-normative Design Principles avoided using
                  words in lower case where they were in contexts that might
                  make them confusable with upper case RFC2119 normative
                  language.
</li>
<li>Added Stephen Hanna and Ben Campbell to acks and
                  corrected spelling of Agarwal.
</li>
<li>Deleted endnote discussing corner case with IKEv2 manual
                  keying (identified as "to be removed before publication
                  following SecDir review").
</li>
<li>Deleted Appendices D &amp; E on why existing ingress
                  &amp; egress tunnelling behavour impede PCN and the endnotes
                  that referred to them (identified as "to be removed before
                  publication").
</li>
<li>Various minor corrections pointed out by reviewers.
</li>
</ul>
</li>
</ul>
</dd>
<dt>From ietf-07 to ietf-08:</dt>
<dd>
            
<ul class="text">
<li>Changes to standards actions:
<ul class="text">
<li><a class='info' href='#ecntun_ECN_Tunnel_Rules'>Section&nbsp;4<span> (</span><span class='info'>New ECN Tunnelling Rules</span><span>)</span></a>: Changed
                  non-RFC2119 phrase 'NOT RECOMMENDED' to 'SHOULD be avoided',
                  wrt alternate ECN tunnelling schemes.
</li>
<li><a class='info' href='#ecntun_Default_Egress_Behaviour'>Section&nbsp;4.2<span> (</span><span class='info'>Default Tunnel Egress Behaviour</span><span>)</span></a>: Used
                  upper-case in 'Alarms SHOULD be rate-limited'.
</li>
<li><a class='info' href='#ecntun_Design_Principles'>Section&nbsp;7<span> (</span><span class='info'>Design Principles for Alternate ECN Tunnelling Semantics</span><span>)</span></a>: Made bullet
                  #1 in the decapsulation guidelines for alternate schemes
                  more precise. Also changed any upper-case keywords in this
                  informative section to lower case.
</li>
</ul>
</li>
<li>Editorial changes:
<ul class="text">
<li>Changed copyright notice to allow for pre-5378
                  material.
</li>
<li>Shifted supporting text intended for deletion on
                  publication into editorial comments.
</li>
<li>Explained how to read the decapsulation matrices in their
                  captions.
</li>
<li>Minor clarifications throughout.
</li>
</ul>
</li>
</ul>
          
</dd>
<dt>From ietf-06 to ietf-07:</dt>
<dd>
            
<ul class="text">
<li>Emphasised that this is the opposite of a fork in the RFC
              series.
</li>
<li>Altered <a class='info' href='#ecntun_RFC_Changes'>Section&nbsp;5<span> (</span><span class='info'>Updates to Earlier RFCs</span><span>)</span></a> to focus on
              updates to implementations of earlier RFCs, rather than on
              updates to the text of the RFCs.
</li>
<li>Removed potential loop-holes in normative text that
              implementers might have used to claim compliance without
              implementing normal mode. Highlighted the deliberate distinction
              between "MUST implement" and "SHOULD use" normal mode.
</li>
<li>Added question for Security Directorate reviewers on whether
              to mention a corner-case concerning manual keying of IPsec
              tunnels.
</li>
<li>Minor clarifications, updated references and updated
              acks.
</li>
<li>Marked two appendices about PCN motivations for removal
              before publication.
</li>
</ul>
          
</dd>
<dt>From ietf-05 to ietf-06:</dt>
<dd>
            
<ul class="text">
<li>Minor textual clarifications and corrections.
</li>
</ul>
          
</dd>
<dt>From ietf-04 to ietf-05:</dt>
<dd>
            
<ul class="text">
<li>Functional changes:
<ul class="text">
<li><a class='info' href='#ecntun_Default_Egress_Behaviour'>Section&nbsp;4.2<span> (</span><span class='info'>Default Tunnel Egress Behaviour</span><span>)</span></a>: ECT(1)
                  outer with Not-ECT inner: reverted to forwarding as Not-ECT
                  (as in RFC3168 &amp; RFC4301), rather than dropping.
</li>
<li>Altered rationale in bullet 3 of <a class='info' href='#ecntun_Motivate_Decap'>Section&nbsp;5.3.2<span> (</span><span class='info'>Motivation for Changing Decapsulation</span><span>)</span></a> to justify this.
</li>
<li>Distinguished alarms for dangerous and invalid
                  combinations and allowed combinations that are valid in some
                  tunnel configurations but dangerous in others to be alarmed
                  at the discretion of the implementer and/or operator.
</li>
<li>Altered advice on designing alternate ECN tunnelling
                  semantics to reflect the above changes.
</li>
</ul>
</li>
<li>Textual changes:
<ul class="text">
<li>Changed "Future non-default schemes" to "Alternate ECN
                  Tunnelling Semantics" throughout.
</li>
<li>Cut down Appendix D and Appendix E for brevity.
</li>
<li>A number of clarifying edits &amp; updated refs.
</li>
</ul>
</li>
</ul>
          
</dd>
<dt>From ietf-03 to ietf-04:</dt>
<dd>
            
<ul class="text">
<li>Functional changes: none
</li>
<li>Structural changes:
<ul class="text">
<li>Added "Open Issues" appendix
</li>
</ul>
</li>
<li>Textual changes:
<ul class="text">
<li>Section title: "Changes from Earlier RFCs" -&gt; "Updates
                  to Earlier RFCs"
</li>
<li>Emphasised that change on decap to previously unused
                  combinations will propagate PCN encoding.
</li>
<li>Acknowledged additional reviewers and updated
                  references
</li>
</ul>
</li>
</ul>
          
</dd>
<dt>From ietf-02 to ietf-03:</dt>
<dd>
            
<ul class="text">
<li>Functional changes:
<ul class="text">
<li>Corrected errors in recap of previous RFCs, which wrongly
                  stated the different decapsulation behaviours of RFC3168
                  &amp; RFC4301 with a Not-ECT inner header. This also
                  required corrections to the "Changes from Earlier RFCs" and
                  the Motivations for these changes.
</li>
<li>Mandated that any future standards action SHOULD NOT use
                  the ECT(0) codepoint as an indication of congestion, without
                  giving strong reasons.
</li>
<li>Added optional alarm when decapsulating ECT(1) outer,
                  ECT(0), but noted it would need to be disabled for
                  2-severity level congestion (e.g. PCN).
</li>
</ul>
</li>
<li>Structural changes: 
<ul class="text">
<li>Removed Document Roadmap which merely repeated the
                  Contents (previously Section 1.2).
</li>
<li>Moved "Changes from Earlier RFCs" (<a class='info' href='#ecntun_RFC_Changes'>Section&nbsp;5<span> (</span><span class='info'>Updates to Earlier RFCs</span><span>)</span></a>) before <a class='info' href='#ecntun_Backward_Compatibility'>Section&nbsp;6<span> (</span><span class='info'>Backward Compatibility</span><span>)</span></a> on Backward
                  Compatibility and internally organised both by RFC, rather
                  than by ingress then egress.
</li>
<li>Moved motivation for changing existing RFCs (<a class='info' href='#ecntun_Motivate_Changes'>Section&nbsp;5.3<span> (</span><span class='info'>Motivation for Changes</span><span>)</span></a>) to after the changes
                  are specified.
</li>
<li>Moved informative "Design Principles for Future
                  Non-Default Schemes" after all the normative sections.
</li>
<li>Added <a class='info' href='#ecntun_Early_History'>Appendix&nbsp;A<span> (</span><span class='info'>Early ECN Tunnelling RFCs</span><span>)</span></a> on early
                  history of ECN tunnelling RFCs.
</li>
<li>Removed specialist appendix on "Relative Placement of
                  Tunnelling and In-Path Load Regulation" (Appendix D in the
                  -02 draft)
</li>
<li>Moved and updated specialist text on "Compromise on Decap
                  with ECT(1) Inner and ECT(0) Outer" from Security
                  Considerations to <a class='info' href='#ecntun_Compromise'>Appendix&nbsp;D<span> (</span><span class='info'>Compromise on Decap with ECT(1) Inner and ECT(0) Outer</span><span>)</span></a>
</li>
</ul>
</li>
<li>Textual changes:
<ul class="text">
<li>Simplified vocabulary for non-native-english speakers
</li>
<li>Simplified Introduction and defined regularly used terms
                  in an expanded Terminology section.
</li>
<li>More clearly distinguished statically configured tunnels
                  from dynamic tunnel endpoint discovery, before explaining
                  operating modes.
</li>
<li>Simplified, cut-down and clarified throughout
</li>
<li>Updated references.
</li>
</ul>
</li>
</ul>
          
</dd>
<dt>From ietf-01 to ietf-02:</dt>
<dd>
            
<ul class="text">
<li>Scope reduced from any encapsulation of an IP packet to
              solely IP in IP tunnelled encapsulation. Consequently changed
              title and removed whole section 'Design Guidelines for New
              Encapsulations of Congestion Notification' (to be included in a
              future companion informational document).
</li>
<li>Included a new normative decapsulation rule for ECT(0) inner
              and ECT(1) outer that had previously only been outlined in the
              non-normative appendix 'Comprehensive Decapsulation Rules'.
              Consequently:
<ul class="text">
<li>The Introduction has been completely re-written to
                  motivate this change to decapsulation along with the
                  existing change to encapsulation.
</li>
<li>The tentative text in the appendix that first proposed
                  this change has been split between normative standards text
                  in <a class='info' href='#ecntun_ECN_Tunnel_Rules'>Section&nbsp;4<span> (</span><span class='info'>New ECN Tunnelling Rules</span><span>)</span></a> and Appendix D,
                  which explains specifically why this change would streamline
                  PCN. New text on the logic of the resulting decap rules
                  added.
</li>
</ul>
</li>
<li>If inner/outer is Not-ECT/ECT(0), changed decapsulation to
              propagate Not-ECT rather than drop the packet; and added
              reasoning.
</li>
<li>Considerably restructured: 
<ul class="text">
<li>"Design Constraints" analysis moved to an appendix (<a class='info' href='#ecntun_Design_Constraints'>Appendix&nbsp;B<span> (</span><span class='info'>Design Constraints</span><span>)</span></a>);
</li>
<li>Added <a class='info' href='#ecntun_Existing_RFCs'>Section&nbsp;3<span> (</span><span class='info'>Summary of Pre-Existing RFCs</span><span>)</span></a> to summarise
                  relevant existing RFCs;
</li>
<li>Structured <a class='info' href='#ecntun_ECN_Tunnel_Rules'>Section&nbsp;4<span> (</span><span class='info'>New ECN Tunnelling Rules</span><span>)</span></a> and
                  <a class='info' href='#ecntun_Backward_Compatibility'>Section&nbsp;6<span> (</span><span class='info'>Backward Compatibility</span><span>)</span></a> into
                  subsections.
</li>
<li>Added tables to sections on old and new rules, for
                  precision and comparison.
</li>
<li>Moved <a class='info' href='#ecntun_Design_Principles'>Section&nbsp;7<span> (</span><span class='info'>Design Principles for Alternate ECN Tunnelling Semantics</span><span>)</span></a> on
                  Design Principles to the end of the section specifying the
                  new default normative tunnelling behaviour. Rewritten and
                  shifted text on identifiers and in-path load regulators to
                  Appendix B.1 [deleted in revision -03].
</li>
</ul>
</li>
</ul>
          
</dd>
<dt>From ietf-00 to ietf-01:</dt>
<dd>
            
<ul class="text">
<li>Identified two additional alarm states in the decapsulation
              rules (<a class='info' href='#ecntun_Tab_IP_IP_Decapsulation'>Figure&nbsp;4<span> (</span><span class='info'>New IP in IP Decapsulation Behaviour</span><span>)</span></a>) if
              ECT(X) in outer and inner contradict each other.
</li>
<li>Altered Comprehensive Decapsulation Rules (Appendix D) so
              that ECT(0) in the outer no longer overrides ECT(1) in the
              inner. Used the term 'Comprehensive' instead of 'Ideal'. And
              considerably updated the text in this appendix.
</li>
<li>Added Appendix D.1 (removed again in a later revision) to
              weigh up the various ways the Comprehensive Decapsulation Rules
              might be introduced. This replaces the previous contradictory
              statements saying complex backwards compatibility interactions
              would be introduced while also saying there would be no
              backwards compatibility issues.
</li>
<li>Updated references.
</li>
</ul>
          
</dd>
<dt>From briscoe-01 to ietf-00:</dt>
<dd>
            
<ul class="text">
<li>Re-wrote <a class='info' href='#ecntun_Tunnel_Contribution'>Appendix&nbsp;C<span> (</span><span class='info'>Contribution to Congestion across a Tunnel</span><span>)</span></a> giving
              much simpler technique to measure contribution to congestion
              across a tunnel.
</li>
<li>Added discussion of backward compatibility of the ideal
              decapsulation scheme in Appendix D
</li>
<li>Updated references. Minor corrections &amp; clarifications
              throughout.
</li>
</ul>
          
</dd>
<dt>From briscoe-00 to briscoe-01:</dt>
<dd>
            
<ul class="text">
<li>Related everything conceptually to the uniform and pipe
              models of RFC2983 on Diffserv Tunnels, and completely removed
              the dependence of tunnelling behaviour on the presence of any
              in-path load regulation by using the [1 - Before] [2 - Outer]
              function placement concepts from RFC2983;
</li>
<li>Added specific cases where the existing standards limit new
              proposals, particularly Appendix E;
</li>
<li>Added sub-structure to Introduction (Need for
              Rationalisation, Roadmap), added new Introductory subsection on
              "Scope" and improved clarity;
</li>
<li>Added Design Guidelines for New Encapsulations of Congestion
              Notification;
</li>
<li>Considerably clarified the Backward Compatibility section
              (<a class='info' href='#ecntun_Backward_Compatibility'>Section&nbsp;6<span> (</span><span class='info'>Backward Compatibility</span><span>)</span></a>);
</li>
<li>Considerably extended the Security Considerations section
              (<a class='info' href='#ecntun_Security_Considerations'>Section&nbsp;9<span> (</span><span class='info'>Security Considerations</span><span>)</span></a>);
</li>
<li>Summarised the primary rationale much better in the
              conclusions;
</li>
<li>Added numerous extra acknowledgements;
</li>
<li>Added Appendix E. "Why resetting CE on encapsulation harms
              PCN", <a class='info' href='#ecntun_Tunnel_Contribution'>Appendix&nbsp;C<span> (</span><span class='info'>Contribution to Congestion across a Tunnel</span><span>)</span></a>.
              "Contribution to Congestion across a Tunnel" and Appendix D.
              "Ideal Decapsulation Rules";
</li>
<li>Re-wrote Appendix B [deleted in a later revision], explaining
              how tunnel encapsulation no longer depends on in-path
              load-regulation (changed title from "In-path Load Regulation" to
              "Non-Dependence of Tunnelling on In-path Load Regulation"), but
              explained how an in-path load regulation function must be
              carefully placed with respect to tunnel encapsulation (in a new
              sub-section entitled "Dependence of In-Path Load Regulation on
              Tunnelling").
</li>
</ul>
          
</dd>
</dl></blockquote>

<a name="ecntun_Introduction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>Explicit congestion notification (ECN <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a>)
      allows a forwarding element (e.g. a router) to notify the onset of
      congestion without having to drop packets. Instead it can explicitly
      mark a proportion of packets in the 2-bit ECN field in the IP header
      (<a class='info' href='#ecntun_ECN_Codepoints'>Table&nbsp;1<span> (</span><span class='info'>Recap of Codepoints of the ECN Field [RFC3168] in the IP Header</span><span>)</span></a> recaps the ECN codepoints).
</p>
<p>The outer header of an IP packet can encapsulate one or more IP
      headers for tunnelling. A forwarding element using ECN to signify
      congestion will only mark the immediately visible outer IP header. When
      a tunnel decapsulator later removes this outer header, it follows rules
      to propagate congestion markings by combining the ECN fields of the
      inner and outer IP header into one outgoing IP header.
</p>
<p>This document updates those rules for IPsec <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>
      and non-IPsec <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a> tunnels to add new behaviours
      for previously unused combinations of inner and outer header. It also
      updates the tunnel ingress behaviour of RFC3168 to match that of
      RFC4301. The updated rules are backward compatible with RFC4301 and
      RFC3168 when interworking with any other tunnel endpoint complying with
      any earlier specification.
</p>
<p>When ECN and its tunnelling was defined in RFC3168, only the minimum
      necessary changes to the ECN field were propagated through tunnel
      endpoints&mdash;just enough for the basic ECN mechanism to work. This
      was due to concerns that the ECN field might be toggled to communicate
      between a secure site and someone on the public Internet&mdash;a covert
      channel. This was because a mutable field like ECN cannot be protected
      by IPsec's integrity mechanisms&mdash;it has to be able to change as it
      traverses the Internet.
</p>
<p>Nonetheless, the latest IPsec architecture <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>
      considered a bandwidth limit of 2 bits per packet on a covert channel
      made it a manageable risk. Therefore, for simplicity, an RFC4301 ingress
      copied the whole ECN field to encapsulate a packet. It dispensed with
      the two modes of RFC3168, one which partially copied the ECN field, and
      the other which blocked all propagation of ECN changes.
</p>
<p>Unfortunately, this entirely reasonable sequence of standards actions
      resulted in a perverse outcome; non-IPsec tunnels (RFC3168) blocked the
      2-bit covert channel, while IPsec tunnels (RFC4301) did not&mdash;at
      least not at the ingress. At the egress, both IPsec and non-IPsec
      tunnels still partially restricted propagation of the full ECN
      field.
</p>
<p>The trigger for the changes in this document was the introduction of
      pre-congestion notification (PCN <a class='info' href='#RFC5670'>[RFC5670]<span> (</span><span class='info'>Eardley, P., &ldquo;Metering and Marking Behaviour of PCN-Nodes,&rdquo; November&nbsp;2009.</span><span>)</span></a>) to the IETF
      standards track. PCN needs the ECN field to be copied at a tunnel
      ingress and it needs four states of congestion signalling to be
      propagated at the egress, but pre-existing tunnels only propagate three
      in the ECN field.
</p>
<p>This document draws on currently unused (CU) combinations of inner
      and outer headers to add tunnelling of four-state congestion signalling
      to RFC3168 and RFC4301. Operators of tunnels who specifically want to
      support four states can require that all their tunnels comply with this
      specification. However, this is not a fork in the RFC series. It is an
      update that can be deployed first by those that need it, and
      subsequently by all tunnel endpoint implementations (RFC4301, RFC3168,
      RFC2481, RFC2401, RFC2003), which can safely be updated to this new
      specification as part of general code maintenance. This will gradually
      add support for four congestion states to the Internet. Existing three
      state schemes will continue to work as before.
</p>
<p>In fact, this document is the opposite of a fork. At the same time as
      supporting a fourth state, the opportunity has been taken to draw
      together divergent ECN tunnelling specifications into a single
      consistent behaviour, harmonising differences such as perverse covert
      channel treatment. Then any tunnel can be deployed unilaterally, and it
      will support the full range of congestion control and management schemes
      without any modes or configuration. Further, any host or router can
      expect the ECN field to behave in the same way, whatever type of tunnel
      might intervene in the path.
</p>
<a name="ecntun_Scope"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
Scope</h3>

<p>This document only concerns wire protocol processing of the ECN
        field at tunnel endpoints and makes no changes or recommendations
        concerning algorithms for congestion marking or congestion
        response.
</p>
<p>This document specifies common ECN field processing at
        encapsulation and decapsulation for any IP in IP tunnelling, whether
        IPsec or non-IPsec tunnels. It applies irrespective of whether IPv4 or
        IPv6 is used for either of the inner and outer headers. It applies for
        packets with any destination address type, whether unicast or
        multicast. It applies as the default for all Diffserv per-hop
        behaviours (PHBs), unless stated otherwise in the specification of a
        PHB (but <a class='info' href='#ecntun_ECN_Tunnel_Rules'>Section&nbsp;4<span> (</span><span class='info'>New ECN Tunnelling Rules</span><span>)</span></a> strongly deprecates
        such exceptions). It is intended to be a good trade off between
        somewhat conflicting security, control and management
        requirements.
</p>
<p><a class='info' href='#RFC2983'>[RFC2983]<span> (</span><span class='info'>Black, D., &ldquo;Differentiated Services and Tunnels,&rdquo; October&nbsp;2000.</span><span>)</span></a> is a comprehensive primer on
        differentiated services and tunnels. Given ECN raises similar issues
        to differentiated services when interacting with tunnels, useful
        concepts introduced in RFC2983 are used throughout, with brief recaps
        of the explanations where necessary.
</p>
<a name="ecntun_Reqs_Language"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in RFC 2119 <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<p><a class='info' href='#ecntun_ECN_Codepoints'>Table&nbsp;1<span> (</span><span class='info'>Recap of Codepoints of the ECN Field [RFC3168] in the IP Header</span><span>)</span></a> recaps the names of the ECN
      codepoints <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a>.
</p><br /><hr class="insert" />
<a name="ecntun_ECN_Codepoints"></a>
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="center"><col align="left"><col align="left">
<tr><th align="center">Binary codepoint</th><th align="left">Codepoint name</th><th align="left">Meaning</th></tr>
<tr>
<td align="center">00</td>
<td align="left">Not-ECT</td>
<td align="left">Not ECN-capable transport</td>
</tr>
<tr>
<td align="center">01</td>
<td align="left">ECT(1)</td>
<td align="left">ECN-capable transport</td>
</tr>
<tr>
<td align="center">10</td>
<td align="left">ECT(0)</td>
<td align="left">ECN-capable transport</td>
</tr>
<tr>
<td align="center">11</td>
<td align="left">CE</td>
<td align="left">Congestion experienced</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Table 1: Recap of Codepoints of the ECN Field [RFC3168] in the IP Header&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Further terminology used within this document:</p>
<blockquote class="text"><dl>
<dt>Encapsulator:</dt>
<dd>The tunnel endpoint function that adds
          an outer IP header to tunnel a packet (also termed the 'ingress
          tunnel endpoint' or just the 'ingress' where the context is
          clear).
</dd>
<dt>Decapsulator:</dt>
<dd>The tunnel endpoint function that
          removes an outer IP header from a tunnelled packet (also termed the
          'egress tunnel endpoint' or just the 'egress' where the context is
          clear).
</dd>
<dt>Incoming header:</dt>
<dd>The header of an arriving packet
          before encapsulation.
</dd>
<dt>Outer header:</dt>
<dd>The header added to encapsulate a
          tunnelled packet.
</dd>
<dt>Inner header:</dt>
<dd>The header encapsulated by the outer
          header.
</dd>
<dt>Outgoing header:</dt>
<dd>The header constructed by the
          decapsulator using logic that combines the fields in the outer and
          inner headers.
</dd>
<dt>Copying ECN:</dt>
<dd>On encapsulation, setting the ECN field
          of the new outer header to be a copy of the ECN field in the
          incoming header.
</dd>
<dt>Zeroing ECN:</dt>
<dd>On encapsulation, clearing the ECN field
          of the new outer header to Not-ECT (<tt>00</tt>).
</dd>
<dt>Resetting ECN:</dt>
<dd>On encapsulation, setting the ECN field
          of the new outer header to be a copy of the ECN field in the
          incoming header except the outer ECN field is set to the ECT(0)
          codepoint if the incoming ECN field is CE.
</dd>
</dl></blockquote>

<a name="ecntun_Existing_RFCs"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Summary of Pre-Existing RFCs</h3>

<p>This section is informative not normative, as it recaps pre-existing
      RFCs. Earlier relevant RFCs that were either experimental or incomplete
      with respect to ECN tunnelling (RFC2481, RFC2401 and RFC2003) are
      briefly outlined in <a class='info' href='#ecntun_Early_History'>Appendix&nbsp;A<span> (</span><span class='info'>Early ECN Tunnelling RFCs</span><span>)</span></a>. The question
      of whether tunnel implementations used in the Internet comply with any
      of these RFCs is not discussed.
</p>
<a name="ecntun_Existing_Ingress"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Encapsulation at Tunnel Ingress</h3>

<p>At the encapsulator, the controversy has been over whether to
        propagate information about congestion experienced on the path so far
        into the outer header of the tunnel.
</p>
<p>Specifically, RFC3168 says that, if a tunnel fully supports ECN
        (termed a 'full-functionality' ECN tunnel in <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a>), the encapsulator must not copy a CE marking from
        the inner header into the outer header that it creates. Instead the
        encapsulator must set the outer header to ECT(0) if the ECN field is
        marked CE in the arriving IP header. We term this 'resetting' a CE
        codepoint.
</p>
<p>However, the new IPsec architecture in <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>
        reverses this rule, stating that the encapsulator must simply copy the
        ECN field from the incoming header to the outer header.
</p>
<p>RFC3168 also provided a Limited Functionality mode that turns off
        ECN processing over the scope of the tunnel by setting the outer
        header to Not-ECT (<tt>00</tt>). Then such packets
        will be dropped to indicate congestion rather than marked with ECN.
        This is necessary for the ingress to interwork with legacy
        decapsulators (<a class='info' href='#RFC2481'>[RFC2481]<span> (</span><span class='info'>Ramakrishnan, K. and S. Floyd, &ldquo;A Proposal to add Explicit Congestion Notification (ECN) to IP,&rdquo; January&nbsp;1999.</span><span>)</span></a>, <a class='info' href='#RFC2401'>[RFC2401]<span> (</span><span class='info'>Kent, S. and R. Atkinson, &ldquo;Security Architecture for the Internet Protocol,&rdquo; November&nbsp;1998.</span><span>)</span></a>
        and <a class='info' href='#RFC2003'>[RFC2003]<span> (</span><span class='info'>Perkins, C., &ldquo;IP Encapsulation within IP,&rdquo; October&nbsp;1996.</span><span>)</span></a>) that do not propagate ECN markings
        added to the outer header. Otherwise such legacy decapsulators would
        throw away congestion notifications before they reached the transport
        layer.
</p>
<p>Neither Limited Functionality mode nor Full Functionality mode are
        used by an RFC4301 IPsec encapsulator, which simply copies the
        incoming ECN field into the outer header. An earlier key-exchange
        phase ensures an RFC4301 ingress will not have to interwork with a
        legacy egress that does not support ECN.
</p>
<p>These pre-existing behaviours are summarised in <a class='info' href='#ecntun_Tab_IP_IP_Encapsulation_Pre'>Figure&nbsp;1<span> (</span><span class='info'>IP in IP Encapsulation: Recap of Pre-existing Behaviours</span><span>)</span></a>.
</p><br /><hr class="insert" />
<a name="ecntun_Tab_IP_IP_Encapsulation_Pre"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>+-----------------+-----------------------------------------------+
| Incoming Header |             Outgoing Outer Header             |
| (also equal to  +---------------+---------------+---------------+
| Outgoing Inner  |  RFC3168 ECN  |  RFC3168 ECN  | RFC4301 IPsec |
|     Header)     |    Limited    |     Full      |               |
|                 | Functionality | Functionality |               |
+-----------------+---------------+---------------+---------------+
|    Not-ECT      |   Not-ECT     |   Not-ECT     |   Not-ECT     |
|     ECT(0)      |   Not-ECT     |    ECT(0)     |    ECT(0)     |
|     ECT(1)      |   Not-ECT     |    ECT(1)     |    ECT(1)     |
|       CE        |   Not-ECT     |    ECT(0)     |      CE       |
+-----------------+---------------+---------------+---------------+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: IP in IP Encapsulation: Recap of Pre-existing Behaviours&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
</p>
<a name="ecntun_Existing_Egress"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Decapsulation at Tunnel Egress</h3>

<p>RFC3168 and RFC4301 specify the decapsulation behaviour summarised
        in <a class='info' href='#ecntun_Tab_IP_IP_Decapsulation_Pre'>Figure&nbsp;2<span> (</span><span class='info'>IP in IP Decapsulation; Recap of Pre-existing Behaviour</span><span>)</span></a>. The ECN field
        in the outgoing header is set to the codepoint at the intersection of
        the appropriate incoming inner header (row) and incoming outer header
        (column).
</p><br /><hr class="insert" />
<a name="ecntun_Tab_IP_IP_Decapsulation_Pre"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>         +---------+------------------------------------------------+
         |Incoming |            Incoming Outer Header               |
         |   Inner +---------+------------+------------+------------+
         |  Header | Not-ECT | ECT(0)     | ECT(1)     |     CE     |
         +---------+---------+------------+------------+------------+
RFC3168-&gt;| Not-ECT | Not-ECT |Not-ECT     |Not-ECT     |   drop     |
RFC4301-&gt;| Not-ECT | Not-ECT |Not-ECT     |Not-ECT     |Not-ECT     |
         |  ECT(0) |  ECT(0) | ECT(0)     | ECT(0)     |     CE     |
         |  ECT(1) |  ECT(1) | ECT(1)     | ECT(1)     |     CE     |
         |    CE   |      CE |     CE     |     CE     |     CE     |
         +---------+---------+------------+------------+------------+
</pre></div>
<p style='text-align: center'>In pre-existing RFCs, the ECN field in the outgoing
          header was set to the codepoint at the intersection of the
          appropriate incoming inner header (row) and incoming outer header
          (column).
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: IP in IP Decapsulation; Recap of Pre-existing Behaviour&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The behaviour in the table derives from the logic given in RFC3168
        and RFC4301, briefly recapped as follows:</p>
<ul class="text">
<li>On decapsulation, if the inner ECN field is Not-ECT the outer
            is ignored. RFC3168 (but not RFC4301) also specified that the
            decapsulator must drop a packet with a Not-ECT inner and CE in the
            outer.
</li>
<li>In all other cases, if the outer is CE, the outgoing ECN field
            is set to CE, but otherwise the outer is ignored and the inner is
            used for the outgoing ECN field.
</li>
</ul><p>Section 9.2.2 of RFC3168 also made it an auditable event for
        an IPsec tunnel "if the ECN Field is changed inappropriately within an
        IPsec tunnel...". Inappropriate changes were not specifically
        enumerated. RFC4301 did not mention inappropriate ECN changes.
</p>
<a name="ecntun_ECN_Tunnel_Rules"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
New ECN Tunnelling Rules</h3>

<p>The standards actions below in <a class='info' href='#ecntun_Default_Ingress_Behaviour'>Section&nbsp;4.1<span> (</span><span class='info'>Default Tunnel Ingress Behaviour</span><span>)</span></a> (ingress encapsulation) and
      <a class='info' href='#ecntun_Default_Egress_Behaviour'>Section&nbsp;4.2<span> (</span><span class='info'>Default Tunnel Egress Behaviour</span><span>)</span></a> (egress decapsulation)
      define new default ECN tunnel processing rules for any IP packet (v4 or
      v6) with any Diffserv codepoint.
</p>
<p>If these defaults do not meet a particular requirement, an alternate
      ECN tunnelling scheme can be introduced as part of the definition of an
      alternate congestion marking scheme used by a specific Diffserv PHB (see
      &sect;5 of <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a> and <a class='info' href='#RFC4774'>[RFC4774]<span> (</span><span class='info'>Floyd, S., &ldquo;Specifying Alternate Semantics for the Explicit Congestion Notification (ECN) Field,&rdquo; November&nbsp;2006.</span><span>)</span></a>).
      When designing such alternate ECN tunnelling schemes, the principles in
      <a class='info' href='#ecntun_Design_Principles'>Section&nbsp;7<span> (</span><span class='info'>Design Principles for Alternate ECN Tunnelling Semantics</span><span>)</span></a> should be followed. However,
      alternate ECN tunnelling schemes SHOULD be avoided whenever possible as
      the deployment burden of handling exceptional PHBs in implementations of
      all affected tunnels should not be underestimated. There is no
      requirement for a PHB definition to state anything about ECN tunnelling
      behaviour if the default behaviour in the present specification is
      sufficient.
</p>
<a name="ecntun_Default_Ingress_Behaviour"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Default Tunnel Ingress Behaviour</h3>

<p>Two modes of encapsulation are defined here; a REQUIRED `normal
        mode' and a `compatibility mode', which is for backward compatibility
        with tunnel decapsulators that do not understand ECN. Note that these
        are modes of the ingress tunnel endpoint only, not the whole tunnel.
        <a class='info' href='#ecntun_Encap_Modes'>Section&nbsp;4.3<span> (</span><span class='info'>Encapsulation Modes</span><span>)</span></a> explains why two modes are
        necessary and specifies the circumstances in which it is sufficient to
        solely implement normal mode.
</p>
<p>Whatever the mode, an encapsulator forwards the inner header
        without changing the ECN field.
</p>
<p>In normal mode an encapsulator compliant with this specification
        MUST construct the outer encapsulating IP header by copying the 2-bit
        ECN field of the incoming IP header. In compatibility mode it clears
        the ECN field in the outer header to the Not-ECT codepoint (the IPv4
        header checksum also changes whenever the ECN field is changed). These
        rules are tabulated for convenience in <a class='info' href='#ecntun_Tab_IP_IP_Encapsulation'>Figure&nbsp;3<span> (</span><span class='info'>New IP in IP Encapsulation Behaviours</span><span>)</span></a>.
</p><br /><hr class="insert" />
<a name="ecntun_Tab_IP_IP_Encapsulation"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>+-----------------+-------------------------------+
| Incoming Header |     Outgoing Outer Header     |
| (also equal to  +---------------+---------------+
| Outgoing Inner  | Compatibility |    Normal     |
|     Header)     |     Mode      |     Mode      |
+-----------------+---------------+---------------+
|    Not-ECT      |   Not-ECT     |   Not-ECT     |
|     ECT(0)      |   Not-ECT     |    ECT(0)     |
|     ECT(1)      |   Not-ECT     |    ECT(1)     |
|       CE        |   Not-ECT     |      CE       |
+-----------------+---------------+---------------+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: New IP in IP Encapsulation Behaviours&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
</p>
<a name="ecntun_Default_Egress_Behaviour"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Default Tunnel Egress Behaviour</h3>

<p>To decapsulate the inner header at the tunnel egress, a compliant
        tunnel egress MUST set the outgoing ECN field to the codepoint at the
        intersection of the appropriate incoming inner header (row) and outer
        header (column) in <a class='info' href='#ecntun_Tab_IP_IP_Decapsulation'>Figure&nbsp;4<span> (</span><span class='info'>New IP in IP Decapsulation Behaviour</span><span>)</span></a>
        (the IPv4 header checksum also changes whenever the ECN field is
        changed). There is no need for more than one mode of decapsulation, as
        these rules cater for all known requirements.
</p><br /><hr class="insert" />
<a name="ecntun_Tab_IP_IP_Decapsulation"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>         +---------+------------------------------------------------+
         |Incoming |            Incoming Outer Header               |
         |   Inner +---------+------------+------------+------------+
         |  Header | Not-ECT | ECT(0)     | ECT(1)     |     CE     |
         +---------+---------+------------+------------+------------+
         | Not-ECT | Not-ECT |Not-ECT(!!!)|Not-ECT(!!!)|   drop(!!!)|
         |  ECT(0) |  ECT(0) | ECT(0)     | ECT(1)     |     CE     |
         |  ECT(1) |  ECT(1) | ECT(1) (!) | ECT(1)     |     CE     |
         |    CE   |      CE |     CE     |     CE(!!!)|     CE     |
         +---------+---------+------------+------------+------------+
</pre></div>
<p style='text-align: center'>The ECN field in the outgoing header is set to the
          codepoint at the intersection of the appropriate incoming inner
          header (row) and incoming outer header (column). Currently unused
          combinations are indicated by '(!!!)' or '(!)'
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: New IP in IP Decapsulation Behaviour&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>This table for decapsulation behaviour is derived from the
        following logic:</p>
<ul class="text">
<li>If the inner ECN field is Not-ECT the decapsulator MUST NOT
            propagate any other ECN codepoint onwards. This is because the
            inner Not-ECT marking is set by transports that use drop as an
            indication of congestion and would not understand or respond to
            any other ECN codepoint <a class='info' href='#RFC4774'>[RFC4774]<span> (</span><span class='info'>Floyd, S., &ldquo;Specifying Alternate Semantics for the Explicit Congestion Notification (ECN) Field,&rdquo; November&nbsp;2006.</span><span>)</span></a>.
            Specifically:
<ul class="text">
<li>If the inner ECN field is Not-ECT and the outer ECN field
                is CE the decapsulator MUST drop the packet.
</li>
<li>If the inner ECN field is Not-ECT and the outer ECN field
                is Not-ECT, ECT(0) or ECT(1) the decapsulator MUST forward the
                outgoing packet with the ECN field cleared to Not-ECT.
</li>
</ul>
</li>
<li>In all other cases where the inner supports ECN, the
            decapsulator MUST set the outgoing ECN field to the more severe
            marking of the outer and inner ECN fields, where the ranking of
            severity from highest to lowest is CE, ECT(1), ECT(0), Not-ECT.
            This in no way precludes cases where ECT(1) and ECT(0) have the
            same severity;
</li>
<li>Certain combinations of inner and outer ECN fields cannot
            result from any transition in any current or previous ECN
            tunneling specification. These currently unused (CU) combinations
            are indicated in <a class='info' href='#ecntun_Tab_IP_IP_Decapsulation'>Figure&nbsp;4<span> (</span><span class='info'>New IP in IP Decapsulation Behaviour</span><span>)</span></a>
            by '(!!!)' or '(!)', where '(!!!)' means the combination is CU and
            always potentially dangerous, while '(!)' means it is CU and
            possibly dangerous. In these cases, particularly the more
            dangerous ones, the decapsulator SHOULD log the event and MAY also
            raise an alarm.<br />
<br />
Just because the
            highlighted combinations are currently unused, does not mean that
            all the other combinations are always valid. Some are only valid
            if they have arrived from a particular type of legacy ingress, and
            dangerous otherwise. Therefore an implementation MAY allow an
            operator to configure logging and alarms for such additional
            header combinations known to be dangerous or CU for the particular
            configuration of tunnel endpoints deployed at run-time. <br />
<br />
Alarms SHOULD be rate-limited so that the
            anomalous combinations will not amplify into a flood of alarm
            messages. It MUST be possible to suppress alarms or logging, e.g.
            if it becomes apparent that a combination that previously was not
            used has started to be used for legitimate purposes such as a new
            standards action.
</li>
</ul>

<p>The above logic allows for ECT(0) and ECT(1) to both represent the
        same severity of congestion marking (e.g. "not congestion marked").
        But it also allows future schemes to be defined where ECT(1) is a more
        severe marking than ECT(0), in particular enabling the simplest
        possible encoding for PCN <a class='info' href='#I-D.ietf-pcn-3-in-1-encoding'>[I&#8209;D.ietf&#8209;pcn&#8209;3&#8209;in&#8209;1&#8209;encoding]<span> (</span><span class='info'>Briscoe, B., Moncaster, T., and M. Menth, &ldquo;Encoding 3 PCN-States in the IP header using a single DSCP,&rdquo; July&nbsp;2010.</span><span>)</span></a> (see <a class='info' href='#ecntun_Motivate_Decap'>Section&nbsp;5.3.2<span> (</span><span class='info'>Motivation for Changing Decapsulation</span><span>)</span></a>). Treating ECT(1) as either the same
        as ECT(0) or as a higher severity level is explained in the discussion
        of the ECN nonce <a class='info' href='#RFC3540'>[RFC3540]<span> (</span><span class='info'>Spring, N., Wetherall, D., and D. Ely, &ldquo;Robust Explicit Congestion Notification (ECN) Signaling with Nonces,&rdquo; June&nbsp;2003.</span><span>)</span></a> in <a class='info' href='#ecntun_Security_Considerations'>Section&nbsp;9<span> (</span><span class='info'>Security Considerations</span><span>)</span></a>, which in turn refers to
        <a class='info' href='#ecntun_Compromise'>Appendix&nbsp;D<span> (</span><span class='info'>Compromise on Decap with ECT(1) Inner and ECT(0) Outer</span><span>)</span></a>.
</p>
<a name="ecntun_Encap_Modes"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Encapsulation Modes</h3>

<p><a class='info' href='#ecntun_Default_Ingress_Behaviour'>Section&nbsp;4.1<span> (</span><span class='info'>Default Tunnel Ingress Behaviour</span><span>)</span></a> introduces two
        encapsulation modes, normal mode and compatibility mode, defining
        their encapsulation behaviour (i.e. header copying or zeroing
        respectively). Note that these are modes of the ingress tunnel
        endpoint only, not the tunnel as a whole.
</p>
<p>To comply with this specification, a tunnel ingress MUST at least
        implement `normal mode'. Unless it will never be used with legacy
        tunnel egress nodes (RFC2003, RFC2401 or RFC2481 or the limited
        functionality mode of RFC3168), an ingress MUST also implement
        `compatibility mode' for backward compatibility with tunnel egresses
        that do not propagate explicit congestion notifications <a class='info' href='#RFC4774'>[RFC4774]<span> (</span><span class='info'>Floyd, S., &ldquo;Specifying Alternate Semantics for the Explicit Congestion Notification (ECN) Field,&rdquo; November&nbsp;2006.</span><span>)</span></a>.
</p>
<p>We can categorise the way that an ingress tunnel endpoint is paired
        with an egress as either static or dynamically discovered:</p>
<blockquote class="text"><dl>
<dt>Static:</dt>
<dd>Tunnel endpoints paired together by prior
            configuration. <br />
Some implementations of
            encapsulator might always be statically deployed, and constrained
            to never be paired with a legacy decapsulator (RFC2003, RFC2401 or
            RFC2481 or the limited functionality mode of RFC3168). In such a
            case, only normal mode needs to be implemented.<br />
<br />
For instance, RFC4301-compatible IPsec tunnel
            endpoints invariably use IKEv2 <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> for key
            exchange, which was introduced alongside RFC4301. Therefore both
            endpoints of an RFC4301 tunnel can be sure that the other end is
            RFC4301-compatible, because the tunnel is only formed after IKEv2
            key management has completed, at which point both ends will be
            RFC4301-compliant by definition. Therefore an IPsec tunnel ingress
            does not need compatibility mode, as it will never interact with
            legacy ECN tunnels. To comply with the present specification, it
            only needs to implement the required normal mode, which is
            identical to the pre-existing RFC4301 behaviour.
</dd>
<dt>Dynamic Discovery:</dt>
<dd>Tunnel endpoints paired together
            by some form of tunnel endpoint discovery, typically finding an
            egress on the path taken by the first packet.<br />
This specification does not require or recommend
            dynamic discovery and it does not define how dynamic negotiation
            might be done, but it recognises that proprietary tunnel endpoint
            discovery protocols exist. It therefore sets down some constraints
            on discovery protocols to ensure safe interworking.<br />
<br />
If dynamic tunnel endpoint discovery might pair
            an ingress with a legacy egress (RFC2003, RFC2401 or RFC2481 or
            the limited functionality mode of RFC3168), the ingress MUST
            implement both normal and compatibility mode. If the tunnel
            discovery process is arranged to only ever find a tunnel egress
            that propagates ECN (RFC3168 full functionality mode, RFC4301 or
            this present specification), then a tunnel ingress can be
            compliant with the present specification without implementing
            compatibility mode.<br />
<br />
While a compliant
            tunnel ingress is discovering an egress, it MUST send packets in
            compatibility mode in case the egress it discovers is a legacy
            egress. If, through the discovery protocol, the egress indicates
            that it is compliant with the present specification, with RFC4301
            or with RFC3168 full functionality mode, the ingress can switch
            itself into normal mode. If the egress denies compliance with any
            of these or returns an error that implies it does not understand a
            request to work to any of these ECN specifications, the tunnel
            ingress MUST remain in compatibility mode.
</dd>
</dl></blockquote>

<p>If an ingress claims compliance with this specification it MUST NOT
        permanently disable ECN processing across the tunnel (i.e. only using
        compatibility mode). It is true that such a tunnel ingress is at least
        safe with the ECN behaviour of any egress it may encounter, but it
        does not meet the central aim of this specification: introducing ECN
        support to tunnels.
</p>
<p>Instead, if the ingress knows that the egress does support
        propagation of ECN (full functionality mode of RFC3168 or RFC4301 or
        the present specification), it SHOULD use normal mode, in order to
        support ECN where possible. Note that this section started by saying
        an ingress "MUST implement "normal mode, while it has just said an
        ingress "SHOULD use" normal mode. This distinction is deliberate, to
        allow the mode to be turned off in exceptional circumstances but to
        ensure all implementations make normal mode available.
</p>
<p>
          </p>
<blockquote class="text"><dl>
<dt>Implementation note:</dt>
<dd>If a compliant node is the
            ingress for multiple tunnels, a mode setting will need to be
            stored for each tunnel ingress. However, if a node is the egress
            for multiple tunnels, none of the tunnels will need to store a
            mode setting, because a compliant egress only needs one mode.
</dd>
</dl></blockquote><p>
        
</p>
<a name="ecntun_Single_Decap_Mode"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Single Mode of Decapsulation</h3>

<p>A compliant decapsulator only needs one mode of operation. However,
        if a compliant egress is implemented to be dynamically discoverable,
        it may need to respond to discovery requests from various types of
        legacy tunnel ingress. This specification does not define how dynamic
        negotiation might be done by (proprietary) discovery protocols, but it
        sets down some constraints to ensure safe interworking.
</p>
<p>Through the discovery protocol, a tunnel ingress compliant with the
        present specification might ask if the egress is compliant with the
        present specification, with RFC4301 or with RFC3168 full functionality
        mode. Or an RFC3168 tunnel ingress might try to negotiate to use
        limited functionality or full functionality mode <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a>. In all these cases, a decapsulating tunnel egress
        compliant with this specification MUST agree to any of these requests,
        since it will behave identically in all these cases.
</p>
<p>If no ECN-related mode is requested, a compliant tunnel egress MUST
        continue without raising any error or warning, because its egress
        behaviour is compatible with all the legacy ingress behaviours that do
        not negotiate capabilities.
</p>
<p>A compliant tunnel egress SHOULD raise a warning alarm about any
        requests to enter modes it does not recognise but, for 'forward
        compatibility' with standards actions possibly defined after it was
        implemented, it SHOULD continue operating.
</p>
<a name="ecntun_RFC_Changes"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Updates to Earlier RFCs</h3>

<a name="ecntun_Changes_RFC4301"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Changes to RFC4301 ECN processing</h3>

<p>
          </p>
<blockquote class="text"><dl>
<dt>Ingress:</dt>
<dd>An RFC4301 IPsec encapsulator is not
            changed at all by the present specification. It uses the normal
            mode of the present specification, which defines packet
            encapsulation identically to RFC4301.
</dd>
<dt>Egress:</dt>
<dd>An RFC4301 egress will need to be updated to
            the new decapsulation behaviour in <a class='info' href='#ecntun_Tab_IP_IP_Decapsulation'>Figure&nbsp;4<span> (</span><span class='info'>New IP in IP Decapsulation Behaviour</span><span>)</span></a>, in order to comply
            with the present specification. However, the changes are backward
            compatible; combinations of inner and outer that result from any
            protocol defined in the RFC series so far are unaffected. Only
            combinations that have never been used have been changed,
            effectively adding new behaviours to RFC4301 decapsulation without
            altering existing behaviours. The following specific updates have
            been made:
<ul class="text">
<li>The outer, not the inner, is propagated when the outer is
                ECT(1) and the inner is ECT(0);
</li>
<li>A packet with Not-ECT in the inner and an outer of CE is
                dropped rather than forwarded as Not-ECT;
</li>
<li>Certain combinations of inner and outer ECN field have been
                identified as currently unused. These can trigger logging
                and/or raise alarms.
</li>
</ul>
</dd>
<dt>Modes:</dt>
<dd>RFC4301 tunnel endpoints do not need modes
            and are not updated by the modes in the present specification.
            Effectively an RFC4301 IPsec ingress solely uses the REQUIRED
            normal mode of encapsulation, which is unchanged from RFC4301
            encapsulation. It will never need the OPTIONAL compatibility mode
            as explained in <a class='info' href='#ecntun_Encap_Modes'>Section&nbsp;4.3<span> (</span><span class='info'>Encapsulation Modes</span><span>)</span></a>.
</dd>
</dl></blockquote><p>
        
</p>
<a name="ecntun_Changes_RFC3168"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Changes to RFC3168 ECN processing</h3>

<p>
          </p>
<blockquote class="text"><dl>
<dt>Ingress:</dt>
<dd>On encapsulation, the new rule in <a class='info' href='#ecntun_Tab_IP_IP_Encapsulation'>Figure&nbsp;3<span> (</span><span class='info'>New IP in IP Encapsulation Behaviours</span><span>)</span></a> that a normal mode
            tunnel ingress copies any ECN field into the outer header updates
            the full functionality behaviour of an RFC3168 ingress.
            Nonetheless, the new compatibility mode encapsulates packets
            identically to the limited functionality mode of an RFC3168
            ingress.
</dd>
<dt>Egress:</dt>
<dd>An RFC3168 egress will need to be updated to
            the new decapsulation behaviour in <a class='info' href='#ecntun_Tab_IP_IP_Decapsulation'>Figure&nbsp;4<span> (</span><span class='info'>New IP in IP Decapsulation Behaviour</span><span>)</span></a>, in order to comply
            with the present specification. However, the changes are backward
            compatible; combinations of inner and outer that result from any
            protocol defined in the RFC series so far are unaffected. Only
            combinations that have never been used have been changed,
            effectively adding new behaviours to RFC3168 decapsulation without
            altering existing behaviours. The following specific updates have
            been made:
<ul class="text">
<li>The outer, not the inner, is propagated when the outer is
                ECT(1) and the inner is ECT(0);
</li>
<li>Certain combinations of inner and outer ECN field have been
                identified as currently unused. These can trigger logging
                and/or raise alarms.
</li>
</ul>
</dd>
<dt>Modes:</dt>
<dd>An RFC3168 ingress will need to be updated if
            it is to comply with the present specification, whether or not it
            implemented the optional full functionality mode of RFC3168.
            <br />
RFC3168 defined a (required) limited
            functionality mode and an (optional) full functionality mode for a
            tunnel. In RFC3168, modes applied to both ends of the tunnel,
            while in the present specification, modes are only used at the
            ingress&mdash;a single egress behaviour covers all cases. <br />
<br />
The normal mode of encapsulation is an update to
            the encapsulation behaviour of the full functionality mode of an
            RFC3168 ingress. The compatibility mode of encapsulation is
            identical to the encapsulation behaviour of the limited
            functionality mode of an RFC3168 ingress, except it is optional.
            <br />
<br />
The constraints on how tunnel discovery
            protocols set modes in <a class='info' href='#ecntun_Encap_Modes'>Section&nbsp;4.3<span> (</span><span class='info'>Encapsulation Modes</span><span>)</span></a> and
            <a class='info' href='#ecntun_Single_Decap_Mode'>Section&nbsp;4.4<span> (</span><span class='info'>Single Mode of Decapsulation</span><span>)</span></a> are an update to
            RFC3168, but they are unlikely to require code changes as they
            document existing safe practice.
</dd>
</dl></blockquote><p>
        
</p>
<a name="ecntun_Motivate_Changes"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Motivation for Changes</h3>

<p>An overriding goal is to ensure the same ECN signals can mean the
        same thing whatever tunnels happen to encapsulate an IP packet flow.
        This removes gratuitous inconsistency, which otherwise constrains the
        available design space and makes it harder to design networks and new
        protocols that work predictably.
</p>
<a name="ecntun_Motivate_Encap"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.1"></a><h3>5.3.1.&nbsp;
Motivation for Changing Encapsulation</h3>

<p>The normal mode in <a class='info' href='#ecntun_ECN_Tunnel_Rules'>Section&nbsp;4<span> (</span><span class='info'>New ECN Tunnelling Rules</span><span>)</span></a>
          updates RFC3168 to make all IP in IP encapsulation of the ECN field
          consistent&mdash;consistent with the way both RFC4301 IPsec <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> and IP in MPLS or MPLS in MPLS encapsulation
          <a class='info' href='#RFC5129'>[RFC5129]<span> (</span><span class='info'>Davie, B., Briscoe, B., and J. Tay, &ldquo;Explicit Congestion Marking in MPLS,&rdquo; January&nbsp;2008.</span><span>)</span></a> construct the ECN field.
</p>
<p>Compatibility mode has also been defined so that a non-RFC4301
          ingress can still switch to using drop across a tunnel for backwards
          compatibility with legacy decapsulators that do not propagate ECN
          correctly.
</p>
<p>The trigger that motivated this update to RFC3168 encapsulation
          was a standards track proposal for pre-congestion notification (PCN
          <a class='info' href='#RFC5670'>[RFC5670]<span> (</span><span class='info'>Eardley, P., &ldquo;Metering and Marking Behaviour of PCN-Nodes,&rdquo; November&nbsp;2009.</span><span>)</span></a>). PCN excess rate marking only works
          correctly if the ECN field is copied on encapsulation (as in RFC4301
          and RFC5129); it does not work if ECN is reset (as in RFC3168). This
          is because PCN excess rate marking depends on the outer header
          revealing any congestion experienced so far on the whole path, not
          just since the last tunnel ingress.
</p>
<p>PCN allows a network operator to add flow admission and
          termination for inelastic traffic at the edges of a Diffserv domain,
          but without any per-flow mechanisms in the interior and without the
          generous provisioning typical of Diffserv, aiming to significantly
          reduce costs. The PCN architecture <a class='info' href='#RFC5559'>[RFC5559]<span> (</span><span class='info'>Eardley, P., &ldquo;Pre-Congestion Notification (PCN) Architecture,&rdquo; June&nbsp;2009.</span><span>)</span></a> states
          that RFC3168 IP in IP tunnelling of the ECN field cannot be used for
          any tunnel ingress in a PCN domain. Prior to the present
          specification, this left a stark choice between not being able to
          use PCN for inelastic traffic control or not being able to use the
          many tunnels already deployed for Mobile IP, VPNs and so forth.
</p>
<p>The present specification provides a clean solution to this
          problem, so that network operators who want to use both PCN and
          tunnels can specify that every tunnel ingress in a PCN region must
          comply with this latest specification.
</p>
<p>Rather than allow tunnel specifications to fragment further into
          one for PCN, one for IPsec and one for other tunnels, the
          opportunity has been taken to consolidate the diverging
          specifications back into a single tunnelling behaviour. Resetting
          ECN was originally motivated by a covert channel concern that has
          been deliberately set aside in RFC4301 IPsec. Therefore the reset
          behaviour of RFC3168 is an anomaly that we do not need to keep.
          Copying ECN on encapsulation is anyway simpler than resetting. So,
          as more tunnel endpoints comply with this single consistent
          specification, encapsulation will be simpler as well as more
          predictable.
</p>
<p><a class='info' href='#ecntun_Design_Constraints'>Appendix&nbsp;B<span> (</span><span class='info'>Design Constraints</span><span>)</span></a> assesses whether
          copying rather than resetting CE on ingress will cause any
          unintended side-effects, from the three perspectives of security,
          control and management. In summary this analysis finds that:</p>
<ul class="text">
<li>From the control perspective either copying or resetting
              works for existing arrangements, but copying has more potential
              for simplifying control and resetting breaks at least one
              proposal already on the standards track.
</li>
<li>From the management and monitoring perspective copying is
              preferable.
</li>
<li>From the traffic security perspective (enforcing congestion
              control, mitigating denial of service etc) copying is
              preferable.
</li>
<li>From the information security perspective resetting is
              preferable, but the IETF Security Area now considers copying
              acceptable given the bandwidth of a 2-bit covert channel can be
              managed.
</li>
</ul><p>Therefore there are two points against resetting CE on
          ingress while copying CE causes no significant harm.
</p>
<a name="ecntun_Motivate_Decap"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.2"></a><h3>5.3.2.&nbsp;
Motivation for Changing Decapsulation</h3>

<p>The specification for decapsulation in <a class='info' href='#ecntun_ECN_Tunnel_Rules'>Section&nbsp;4<span> (</span><span class='info'>New ECN Tunnelling Rules</span><span>)</span></a> fixes three problems with the
          pre-existing behaviours of both RFC3168 and RFC4301:
</p>
<p></p>
<ol class="text">
<li>The pre-existing rules prevented the introduction of
              alternate ECN semantics to signal more than one severity level
              of congestion <a class='info' href='#RFC4774'>[RFC4774]<span> (</span><span class='info'>Floyd, S., &ldquo;Specifying Alternate Semantics for the Explicit Congestion Notification (ECN) Field,&rdquo; November&nbsp;2006.</span><span>)</span></a>, <a class='info' href='#RFC5559'>[RFC5559]<span> (</span><span class='info'>Eardley, P., &ldquo;Pre-Congestion Notification (PCN) Architecture,&rdquo; June&nbsp;2009.</span><span>)</span></a>. The four states of the 2-bit ECN field
              provide room for signalling two severity levels in addition to
              not-congested and not-ECN-capable states. But, the pre-existing
              rules assumed that two of the states (ECT(0) and ECT(1)) are
              always equivalent. This unnecessarily restricts the use of one
              of four codepoints (half a bit) in the IP (v4 &amp; v6) header.
              The new rules are designed to work in either case; whether
              ECT(1) is more severe than or equivalent to ECT(0).<br />
<br />
As explained in <a class='info' href='#ecntun_Security_Constraints'>Appendix&nbsp;B.1<span> (</span><span class='info'>Security Constraints</span><span>)</span></a>, the original reason for
              not forwarding the outer ECT codepoints was to limit the covert
              channel across a decapsulator to 1 bit per packet. However, now
              that the IETF Security Area has deemed that a 2-bit covert
              channel through an encapsulator is a manageable risk, the same
              should be true for a decapsulator.<br />
<br />
As
              well as being useful for general future-proofing, this problem
              is immediately pressing for standardisation of pre-congestion
              notification (PCN), which uses two severity levels of
              congestion. If a congested queue used ECT(1) in the outer header
              to signal more severe congestion than ECT(0), the pre-existing
              decapsulation rules would have thrown away this congestion
              signal, preventing tunnelled traffic from ever knowing that it
              should reduce its load.<br />
<br />
Before the
              present specification was written, the PCN working group had to
              consider a number of wasteful or convoluted work-rounds to this
              problem. Without wishing to disparage the ingenuity of these
              work-rounds, none were chosen for the standards track because
              they were either somewhat wasteful, imprecise or complicated.
              Instead a baseline PCN encoding was specified <a class='info' href='#RFC5696'>[RFC5696]<span> (</span><span class='info'>Moncaster, T., Briscoe, B., and M. Menth, &ldquo;Baseline Encoding and Transport of Pre-Congestion Information,&rdquo; November&nbsp;2009.</span><span>)</span></a> that supported only one severity level of
              congestion but allowed space for these work-rounds as
              experimental extensions.<br />
<br />
But by far the
              simplest approach is that taken by the current specification:
              just to remove the covert channel blockages from tunnelling
              behaviour&mdash;now deemed unnecessary anyway. Then network
              operators that want to support two congestion severity-levels
              for PCN can specify that every tunnel egress in a PCN region
              must comply with this latest specification. Having taken this
              step, the simplest possible encoding for PCN with two severity
              levels of congestion <a class='info' href='#I-D.ietf-pcn-3-in-1-encoding'>[I&#8209;D.ietf&#8209;pcn&#8209;3&#8209;in&#8209;1&#8209;encoding]<span> (</span><span class='info'>Briscoe, B., Moncaster, T., and M. Menth, &ldquo;Encoding 3 PCN-States in the IP header using a single DSCP,&rdquo; July&nbsp;2010.</span><span>)</span></a> can be used.<br />
<br />
Not only does this make two congestion
              severity-levels available for PCN, but also for other potential
              uses of the extra ECN codepoint (e.g. <a class='info' href='#VCP'>[VCP]<span> (</span><span class='info'>Xia, Y., Subramanian, L., Stoica, I., and S. Kalyanaraman, &ldquo;One more bit is enough,&rdquo; 2005.</span><span>)</span></a>).
</li>
<li>Cases are documented where a middlebox (e.g. a firewall)
              drops packets with header values that were currently unused (CU)
              when the box was deployed, often on the grounds that anything
              unexpected might be an attack. This tends to bar future use of
              CU values. The new decapsulation rules specify optional logging
              and/or alarms for specific combinations of inner and outer
              header that are currently unused. The aim is to give
              implementers a recourse other than drop if they are concerned
              about the security of CU values. It recognises legitimate
              security concerns about CU values but still eases their future
              use. If the alarms are interpreted as an attack (e.g. by a
              management system) the offending packets can be dropped. But
              alarms can be turned off if these combinations come into regular
              use (e.g. through a future standards action).
</li>
<li>While reviewing currently unused combinations of inner and
              outer, the opportunity was taken to define a single consistent
              behaviour for the three cases with a Not-ECT inner header but a
              different outer. RFC3168 and RFC4301 had diverged in this
              respect and even their common behaviours had never been
              justified.<br />
<br />
None of these combinations
              should result from Internet protocols in the RFC series, but
              future standards actions might put any or all of them to good
              use. Therefore it was decided that a decapsulator must forward a
              Not-ECT inner unchanged when the arriving outer is ECT(0) or
              ECT(1). But for safety it must drop a combination of Not-ECT
              inner and CE outer. Then, if some unfortunate misconfiguration
              resulted in a congested router marking CE on a packet that was
              originally Not-ECT, drop would be the only appropriate signal
              for the egress to propagate&mdash;the only signal a
              non-ECN-capable transport (Not-ECT) would understand. <br />
<br />
It may seem contradictory that the same
              argument has not been applied to the ECT(1) codepoint, given it
              is being proposed as an intermediate level of congestion in a
              scheme progressing through the IETF <a class='info' href='#I-D.ietf-pcn-3-in-1-encoding'>[I&#8209;D.ietf&#8209;pcn&#8209;3&#8209;in&#8209;1&#8209;encoding]<span> (</span><span class='info'>Briscoe, B., Moncaster, T., and M. Menth, &ldquo;Encoding 3 PCN-States in the IP header using a single DSCP,&rdquo; July&nbsp;2010.</span><span>)</span></a>. Instead, a
              decapsulator must forward a Not-ECT inner unchanged when its
              outer is ECT(1). The rationale for not dropping this CU
              combination is to ensure it will be usable if needed in the
              future. If any misconfiguration led to ECT(1) congestion signals
              with a Not-ECT inner, it would not be disastrous for the tunnel
              egress to suppress them, because the congestion should then
              escalate to CE marking, which the egress would drop, thus at
              least preventing congestion collapse.
</li>
</ol><p>Problems 2 &amp; 3 alone would not warrant a change to
          decapsulation, but it was decided they are worth fixing and making
          consistent at the same time as decapsulation code is changed to fix
          problem 1 (two congestion severity-levels).
</p>
<a name="ecntun_Backward_Compatibility"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Backward Compatibility</h3>

<p>A tunnel endpoint compliant with the present specification is
      backward compatible when paired with any tunnel endpoint compliant with
      any previous tunnelling RFC, whether RFC4301, RFC3168 (see <a class='info' href='#ecntun_Existing_RFCs'>Section&nbsp;3<span> (</span><span class='info'>Summary of Pre-Existing RFCs</span><span>)</span></a>) or the earlier RFCs summarised in
      <a class='info' href='#ecntun_Early_History'>Appendix&nbsp;A<span> (</span><span class='info'>Early ECN Tunnelling RFCs</span><span>)</span></a> (RFC2481, RFC2401 and RFC2003).
      Each case is enumerated below.
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Non-Issues Updating Decapsulation</h3>

<p>At the egress, this specification only augments the per-packet
        calculation of the ECN field (RFC3168 and RFC4301) for combinations of
        inner and outer headers that have so far not been used in any IETF
        protocols.
</p>
<p>Therefore, all other things being equal, if an RFC4301 IPsec egress
        is updated to comply with the new rules, it will still interwork with
        any RFC4301 compliant ingress and the packet outputs will be identical
        to those it would have output before (fully backward compatible).
</p>
<p>And, all other things being equal, if an RFC3168 egress is updated
        to comply with the same new rules, it will still interwork with any
        ingress complying with any previous specification (both modes of
        RFC3168, both modes of RFC2481, RFC2401 and RFC2003) and the packet
        outputs will be identical to those it would have output before (fully
        backward compatible).
</p>
<p>A compliant tunnel egress merely needs to implement the one
        behaviour in <a class='info' href='#ecntun_ECN_Tunnel_Rules'>Section&nbsp;4<span> (</span><span class='info'>New ECN Tunnelling Rules</span><span>)</span></a> with no
        additional mode or option configuration at the ingress or egress nor
        any additional negotiation with the ingress. The new decapsulation
        rules have been defined in such a way that congestion control will
        still work safely if any of the earlier versions of ECN processing are
        used unilaterally at the encapsulating ingress of the tunnel (any of
        RFC2003, RFC2401, either mode of RFC2481, either mode of RFC3168,
        RFC4301 and this present specification).
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Non-Update of RFC4301 IPsec Encapsulation</h3>

<p>An RFC4301 IPsec ingress can comply with this new specification
        without any update and it has no need for any new modes, options or
        configuration. So, all other things being equal, it will continue to
        interwork identically with any egress it worked with before (fully
        backward compatible).
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Update to RFC3168 Encapsulation</h3>

<p>The encapsulation behaviour of the new normal mode copies the ECN
        field whereas RFC3168 full functionality mode reset it. However, all
        other things being equal, if RFC3168 ingress is updated to the present
        specification, the outgoing packets from any tunnel egress will still
        be unchanged. This is because all variants of tunnelling at either end
        (RFC4301, both modes of RFC3168, both modes of RFC2481, RFC2401,
        RFC2003 and the present specification) have always propagated an
        incoming CE marking through the inner header and onward into the
        outgoing header, whether the outer header is reset or copied.
        Therefore, If the tunnel is considered as a black box, the packets
        output from any egress will be identical with or without an update to
        the ingress. Nonetheless, if packets are observed within the black box
        (between the tunnel endpoints), CE markings copied by the updated
        ingress will be visible within the black box, whereas they would not
        have been before. Therefore, the update to encapsulation can be termed
        'black-box backwards compatible' (i.e. identical unless you look
        inside the tunnel).
</p>
<p>This specification introduces no new backward compatibility issues
        when a compliant ingress talks with a legacy egress, but it has to
        provide similar safeguards to those already defined in RFC3168.
        RFC3168 laid down rules to ensure that an RFC3168 ingress turns off
        ECN (limited functionality mode) if it is paired with a legacy egress
        (RFC 2481, RFC2401 or RFC2003), which would not propagate ECN
        correctly. The present specification carries forward those rules
        (<a class='info' href='#ecntun_Encap_Modes'>Section&nbsp;4.3<span> (</span><span class='info'>Encapsulation Modes</span><span>)</span></a>). It uses compatibility mode
        whenever RFC3168 would have used limited functionality mode, and their
        per-packet behaviours are identical. Therefore, all other things being
        equal, an ingress using the new rules will interwork with any legacy
        tunnel egress in exactly the same way as an RFC3168 ingress (still
        black-box backward compatible).
</p>
<a name="ecntun_Design_Principles"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Design Principles for Alternate ECN Tunnelling Semantics</h3>

<p>This section is informative not normative.
</p>
<p>&sect;5 of RFC3168 permits the Diffserv codepoint (DSCP)<a class='info' href='#RFC2474'>[RFC2474]<span> (</span><span class='info'>Nichols, K., Blake, S., Baker, F., and D. Black, &ldquo;Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers,&rdquo; December&nbsp;1998.</span><span>)</span></a> to 'switch in' alternative behaviours for marking
      the ECN field, just as it switches in different per-hop behaviours
      (PHBs) for scheduling. <a class='info' href='#RFC4774'>[RFC4774]<span> (</span><span class='info'>Floyd, S., &ldquo;Specifying Alternate Semantics for the Explicit Congestion Notification (ECN) Field,&rdquo; November&nbsp;2006.</span><span>)</span></a> gives best current
      practice for designing such alternative ECN semantics and very briefly
      mentions in section 5.4 that tunnelling needs to be considered. The
      guidance below complements and extends RFC4774, giving additional
      guidance on designing any alternate ECN semantics that would also
      require alternate tunnelling semantics.
</p>
<p>The overriding guidance is: "Avoid designing alternate ECN tunnelling
      semantics, if at all possible." If a scheme requires tunnels to
      implement special processing of the ECN field for certain DSCPs, it will
      be hard to guarantee that every implementer of every tunnel will have
      added the required exception or that operators will have ubiquitously
      deployed the required updates. It is unlikely a single authority is even
      aware of all the tunnels in a network, which may include tunnels set up
      by applications between endpoints, or dynamically created in the
      network. Therefore it is highly likely that some tunnels within a
      network or on hosts connected to it will not implement the required
      special case.
</p>
<p>That said, if a non-default scheme for tunnelling the ECN field is
      really required, the following guidelines might prove useful in its
      design:</p>
<blockquote class="text"><dl>
<dt>On encapsulation in any alternate scheme:</dt>
<dd>
            
<ol class="text">
<li>The ECN field of the outer header ought to be cleared to
              Not-ECT (<tt>00</tt>) unless it is guaranteed
              that the corresponding tunnel egress will correctly propagate
              congestion markings introduced across the tunnel in the outer
              header.
</li>
<li>If it has established that ECN will be correctly propagated,
              an encapsulator ought to also copy incoming congestion
              notification into the outer header. The general principle here
              is that the outer header should reflect congestion accumulated
              along the whole upstream path, not just since the tunnel ingress
              (<a class='info' href='#ecntun_Mgmt_Constraints'>Appendix&nbsp;B.3<span> (</span><span class='info'>Management Constraints</span><span>)</span></a> on management and
              monitoring explains).<br />
<br />
In some
              circumstances (e.g. pseudowires, PCN), the whole path is divided
              into segments, each with its own congestion notification and
              feedback loop. In these cases, the function that regulates load
              at the start of each segment will need to reset congestion
              notification for its segment. Often the point where congestion
              notification is reset will also be located at the start of a
              tunnel. However, the resetting function can be thought of as
              being applied to packets after the encapsulation
              function&mdash;two logically separate functions even though they
              might run on the same physical box. Then the code module doing
              encapsulation can keep to the copying rule and the load
              regulator module can reset congestion, without any code in
              either module being conditional on whether the other is
              there.
</li>
</ol>
          
</dd>
<dt>On decapsulation in any new scheme:</dt>
<dd>
            
<ol class="text">
<li>If the arriving inner header is Not-ECT it implies the
              transport will not understand other ECN codepoints. If the outer
              header carries an explicit congestion marking, the alternate
              scheme would be expected to drop the packet&mdash;the only
              indication of congestion the transport will understand. If the
              alternate scheme recommends forwarding rather than dropping such
              a packet, it will need to clearly justify this decision. If the
              inner is Not-ECT and the outer carries any other ECN codepoint
              that does not indicate congestion, the alternate scheme can
              forward the packet, but probably only as Not-ECT.
</li>
<li>If the arriving inner header is other than Not-ECT, the ECN
              field that the alternate decapsulation scheme forwards ought to
              reflect the more severe congestion marking of the arriving inner
              and outer headers.
</li>
<li>Any alternate scheme will need to define a behaviour for all
              combinations of inner and outer headers, even those that would
              not be expected to result from standards known at the time and
              even those that would not be expected from the tunnel ingress
              paired with the egress at run-time. Consideration should be
              given to logging such unexpected combinations and raising an
              alarm, particularly if there is a danger that the invalid
              combination implies congestion signals are not being propagated
              correctly. The presence of currently unused combinations may
              represent an attack, but the new scheme should try to define a
              way to forward such packets, at least if a safe outgoing
              codepoint can be defined.<br />
<br />
Raising an
              alarm allows a management system to decide whether the anomaly
              is indeed an attack, in which case it can decide to drop such
              packets. This is a preferable approach to hard-coded discard of
              packets that seem anomalous today, but may be needed tomorrow in
              future standards actions.
</li>
</ol>
          
</dd>
</dl></blockquote>

<a name="ecntun_IANA"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
IANA Considerations (to be removed on publication):</h3>

<p>This memo includes no request to IANA.
</p>
<a name="ecntun_Security_Considerations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Security Considerations</h3>

<p><a class='info' href='#ecntun_Security_Constraints'>Appendix&nbsp;B.1<span> (</span><span class='info'>Security Constraints</span><span>)</span></a> discusses the security
      constraints imposed on ECN tunnel processing. The new rules for ECN
      tunnel processing (<a class='info' href='#ecntun_ECN_Tunnel_Rules'>Section&nbsp;4<span> (</span><span class='info'>New ECN Tunnelling Rules</span><span>)</span></a>) trade-off
      between information security (covert channels) and traffic security
      (congestion monitoring &amp; control). Ensuring congestion markings are
      not lost is itself an aspect of security, because if we allowed
      congestion notification to be lost, any attempt to enforce a response to
      congestion would be much harder.
</p>
<p>Security issues in unlikely but possible scenarios:</p>
<blockquote class="text"><dl>
<dt>Tunnels intersecting Diffserv regions with alternate ECN semantics:</dt>
<dd>If
          alternate congestion notification semantics are defined for a
          certain Diffserv PHB, the scope of the alternate semantics might
          typically be bounded by the limits of a Diffserv region or regions,
          as envisaged in <a class='info' href='#RFC4774'>[RFC4774]<span> (</span><span class='info'>Floyd, S., &ldquo;Specifying Alternate Semantics for the Explicit Congestion Notification (ECN) Field,&rdquo; November&nbsp;2006.</span><span>)</span></a> (e.g. the pre-congestion
          notification architecture <a class='info' href='#RFC5559'>[RFC5559]<span> (</span><span class='info'>Eardley, P., &ldquo;Pre-Congestion Notification (PCN) Architecture,&rdquo; June&nbsp;2009.</span><span>)</span></a>). The inner
          headers in tunnels crossing the boundary of such a Diffserv region
          but ending within the region can potentially leak the external
          congestion notification semantics into the region, or leak the
          internal semantics out of the region. <a class='info' href='#RFC2983'>[RFC2983]<span> (</span><span class='info'>Black, D., &ldquo;Differentiated Services and Tunnels,&rdquo; October&nbsp;2000.</span><span>)</span></a>
          discusses the need for Diffserv traffic conditioning to be applied
          at these tunnel endpoints as if they are at the edge of the Diffserv
          region. Similar concerns apply to any processing or propagation of
          the ECN field at the endpoints of tunnels with one end inside and
          the other outside the domain. <a class='info' href='#RFC5559'>[RFC5559]<span> (</span><span class='info'>Eardley, P., &ldquo;Pre-Congestion Notification (PCN) Architecture,&rdquo; June&nbsp;2009.</span><span>)</span></a> gives
          specific advice on this for the PCN case, but other definitions of
          alternate semantics will need to discuss the specific security
          implications in each case.
</dd>
<dt>ECN nonce tunnel coverage:</dt>
<dd>The new decapsulation rules
          improve the coverage of the ECN nonce <a class='info' href='#RFC3540'>[RFC3540]<span> (</span><span class='info'>Spring, N., Wetherall, D., and D. Ely, &ldquo;Robust Explicit Congestion Notification (ECN) Signaling with Nonces,&rdquo; June&nbsp;2003.</span><span>)</span></a>
          relative to the previous rules in RFC3168 and RFC4301. However,
          nonce coverage is still not perfect, as this would have led to a
          safety problem in another case. Both are corner-cases, so discussion
          of the compromise between them is deferred to <a class='info' href='#ecntun_Compromise'>Appendix&nbsp;D<span> (</span><span class='info'>Compromise on Decap with ECT(1) Inner and ECT(0) Outer</span><span>)</span></a>.
</dd>
<dt>Covert channel not turned off:</dt>
<dd>A legacy (RFC3168)
          tunnel ingress could ask an RFC3168 egress to turn off ECN
          processing as well as itself turning off ECN. An egress compliant
          with the present specification will agree to such a request from a
          legacy ingress, but it relies on the ingress always sending Not-ECT
          in the outer. If the egress receives other ECN codepoints in the
          outer it will process them as normal, so it will actually still copy
          congestion markings from the outer to the outgoing header. Referring
          for example to <a class='info' href='#ecntun_Fig_IPsec_Tunnel_Scenario'>Figure&nbsp;5<span> (</span><span class='info'>IPsec Tunnel Scenario</span><span>)</span></a>
          (<a class='info' href='#ecntun_Security_Constraints'>Appendix&nbsp;B.1<span> (</span><span class='info'>Security Constraints</span><span>)</span></a>), although the tunnel
          ingress 'I' will set all ECN fields in outer headers to Not-ECT, 'M'
          could still toggle CE or ECT(1) on and off to communicate covertly
          with 'B', because we have specified that 'E' only has one mode
          regardless of what mode it says it has negotiated. We could have
          specified that 'E' should have a limited functionality mode and
          check for such behaviour. But we decided not to add the extra
          complexity of two modes on a compliant tunnel egress merely to cater
          for an historic security concern that is now considered
          manageable.
</dd>
</dl></blockquote>

<a name="ecntun_Conclusions"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Conclusions</h3>

<p>This document allows tunnels to propagate an extra level of
      congestion severity. It uses previously unused combinations of inner and
      outer header to augment the rules for calculating the ECN field when
      decapsulating IP packets at the egress of IPsec (RFC4301) and non-IPsec
      (RFC3168) tunnels.
</p>
<p>This document also updates the ingress tunnelling encapsulation of
      RFC3168 ECN to bring all IP in IP tunnels into line with the new
      behaviour in the IPsec architecture of RFC4301, which copies rather than
      resets the ECN field when creating outer headers.
</p>
<p>The need for both these updated behaviours was triggered by the
      introduction of pre-congestion notification (PCN) onto the IETF
      standards track. Operators wanting to support PCN or other alternate ECN
      schemes that use an extra severity level can require that their tunnels
      comply with the present specification. This is not a fork in the RFC
      series, it is an update that can be deployed first by those that need
      it, and subsequently by all tunnel endpoint implementations during
      general code maintenance. It is backward compatible with all previous
      tunnelling behaviours, so existing single severity level schemes will
      continue to work as before, but support for two severity levels will
      gradually be added to the Internet.
</p>
<p>The new rules propagate changes to the ECN field across tunnel
      end-points that previously blocked them to restrict the bandwidth of a
      potential covert channel. Limiting the channel's bandwidth to 2 bits per
      packet is now considered sufficient.
</p>
<p>At the same time as removing these legacy constraints, the
      opportunity has been taken to draw together diverging tunnel
      specifications into a single consistent behaviour. Then any tunnel can
      be deployed unilaterally, and it will support the full range of
      congestion control and management schemes without any modes or
      configuration. Further, any host or router can expect the ECN field to
      behave in the same way, whatever type of tunnel might intervene in the
      path. This new certainty could enable new uses of the ECN field that
      would otherwise be confounded by ambiguity.
</p>
<a name="ecntun_Acknowledgements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Acknowledgements</h3>

<p>Thanks to David Black for his insightful reviews and patient
      explanations of better ways to think about function placement and
      alarms. Thanks to David and to Anil Agarwal for pointing out cases where
      it is safe to forward CU combinations of headers. Also thanks to Arnaud
      Jacquet for the idea for <a class='info' href='#ecntun_Tunnel_Contribution'>Appendix&nbsp;C<span> (</span><span class='info'>Contribution to Congestion across a Tunnel</span><span>)</span></a>.
      Thanks to Gorry Fairhurst, Teco Boot, Michael Menth, Bruce Davie, Toby
      Moncaster, Sally Floyd, Alfred H&ouml;nes, Gabriele Corliano, Ingemar
      Johansson and Philip Eardley for their thoughts and careful review
      comments, and to Stephen Hanna and Ben Campbell respectively for
      conducting the Security Directorate and General Area reviews.
</p>
<p>Bob Briscoe is partly funded by Trilogy, a research project
      (ICT-216372) supported by the European Community under its Seventh
      Framework Programme. The views expressed here are those of the author
      only.
</p>
<h3>Comments Solicited (to be removed by the RFC Editor):</h3>

<p>Comments and questions are encouraged and very welcome. They can be
      addressed to the IETF Transport Area working group mailing list
      &lt;tsvwg@ietf.org&gt;, and/or to the authors.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2003">[RFC2003]</a></td>
<td class="author-text"><a href="mailto:perk@watson.ibm.com">Perkins, C.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2003">IP Encapsulation within IP</a>,&rdquo; RFC&nbsp;2003, October&nbsp;1996 (<a href="http://www.rfc-editor.org/rfc/rfc2003.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2003.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2003.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3168">[RFC3168]</a></td>
<td class="author-text">Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;<a href="http://tools.ietf.org/html/rfc3168">The Addition of Explicit Congestion Notification (ECN) to IP</a>,&rdquo; RFC&nbsp;3168, September&nbsp;2001 (<a href="http://www.rfc-editor.org/rfc/rfc3168.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4301">[RFC4301]</a></td>
<td class="author-text">Kent, S. and K. Seo, &ldquo;<a href="http://tools.ietf.org/html/rfc4301">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;4301, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4301.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-pcn-3-in-1-encoding">[I-D.ietf-pcn-3-in-1-encoding]</a></td>
<td class="author-text">Briscoe, B., Moncaster, T., and M. Menth, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-pcn-3-in-1-encoding-03.txt">Encoding 3 PCN-States in the IP header using a single DSCP</a>,&rdquo; draft-ietf-pcn-3-in-1-encoding-03 (work in progress), July&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-pcn-3-in-1-encoding-03.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2401">[RFC2401]</a></td>
<td class="author-text"><a href="mailto:kent@bbn.com">Kent, S.</a> and <a href="mailto:rja@corp.home.net">R. Atkinson</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2401">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;2401, November&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2401.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2401.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2401.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2474">[RFC2474]</a></td>
<td class="author-text"><a href="mailto:kmn@cisco.com">Nichols, K.</a>, <a href="mailto:slblake@torrentnet.com">Blake, S.</a>, <a href="mailto:fred@cisco.com">Baker, F.</a>, and <a href="mailto:black_david@emc.com">D. Black</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2474">Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers</a>,&rdquo; RFC&nbsp;2474, December&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2474.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2474.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2474.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2481">[RFC2481]</a></td>
<td class="author-text"><a href="mailto:kkrama@research.att.com">Ramakrishnan, K.</a> and <a href="mailto:floyd@ee.lbl.gov">S. Floyd</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2481">A Proposal to add Explicit Congestion Notification (ECN) to IP</a>,&rdquo; RFC&nbsp;2481, January&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2481.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2481.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2481.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2983">[RFC2983]</a></td>
<td class="author-text">Black, D., &ldquo;<a href="http://tools.ietf.org/html/rfc2983">Differentiated Services and Tunnels</a>,&rdquo; RFC&nbsp;2983, October&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2983.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3540">[RFC3540]</a></td>
<td class="author-text">Spring, N., Wetherall, D., and D. Ely, &ldquo;<a href="http://tools.ietf.org/html/rfc3540">Robust Explicit Congestion Notification (ECN) Signaling with Nonces</a>,&rdquo; RFC&nbsp;3540, June&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3540.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4306">[RFC4306]</a></td>
<td class="author-text">Kaufman, C., &ldquo;<a href="http://tools.ietf.org/html/rfc4306">Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4306, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4306.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4774">[RFC4774]</a></td>
<td class="author-text">Floyd, S., &ldquo;<a href="http://tools.ietf.org/html/rfc4774">Specifying Alternate Semantics for the Explicit Congestion Notification (ECN) Field</a>,&rdquo; BCP&nbsp;124, RFC&nbsp;4774, November&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4774.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5129">[RFC5129]</a></td>
<td class="author-text">Davie, B., Briscoe, B., and J. Tay, &ldquo;<a href="http://tools.ietf.org/html/rfc5129">Explicit Congestion Marking in MPLS</a>,&rdquo; RFC&nbsp;5129, January&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5129.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5559">[RFC5559]</a></td>
<td class="author-text">Eardley, P., &ldquo;<a href="http://tools.ietf.org/html/rfc5559">Pre-Congestion Notification (PCN) Architecture</a>,&rdquo; RFC&nbsp;5559, June&nbsp;2009 (<a href="http://www.rfc-editor.org/rfc/rfc5559.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5670">[RFC5670]</a></td>
<td class="author-text">Eardley, P., &ldquo;<a href="http://tools.ietf.org/html/rfc5670">Metering and Marking Behaviour of PCN-Nodes</a>,&rdquo; RFC&nbsp;5670, November&nbsp;2009 (<a href="http://www.rfc-editor.org/rfc/rfc5670.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5696">[RFC5696]</a></td>
<td class="author-text">Moncaster, T., Briscoe, B., and M. Menth, &ldquo;<a href="http://tools.ietf.org/html/rfc5696">Baseline Encoding and Transport of Pre-Congestion Information</a>,&rdquo; RFC&nbsp;5696, November&nbsp;2009 (<a href="http://www.rfc-editor.org/rfc/rfc5696.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="VCP">[VCP]</a></td>
<td class="author-text">Xia, Y., Subramanian, L., Stoica, I., and S. Kalyanaraman, &ldquo;<a href="http://doi.acm.org/10.1145/1080091.1080098">One more bit is enough</a>,&rdquo; Proc. SIGCOMM'05, ACM CCR&nbsp;35(4)37--48, 2005 (<a href="http://conferences.sigcomm.org/sigcomm/2005/paper-XiaSub.pdf">PDF</a>).</td></tr>
</table>

<a name="ecntun_Early_History"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Early ECN Tunnelling RFCs</h3>

<p>IP in IP tunnelling was originally defined in <a class='info' href='#RFC2003'>[RFC2003]<span> (</span><span class='info'>Perkins, C., &ldquo;IP Encapsulation within IP,&rdquo; October&nbsp;1996.</span><span>)</span></a>. On encapsulation, the incoming header was
      copied to the outer and on decapsulation the outer was simply discarded.
      Initially, IPsec tunnelling <a class='info' href='#RFC2401'>[RFC2401]<span> (</span><span class='info'>Kent, S. and R. Atkinson, &ldquo;Security Architecture for the Internet Protocol,&rdquo; November&nbsp;1998.</span><span>)</span></a> followed the
      same behaviour.
</p>
<p>When ECN was introduced experimentally in <a class='info' href='#RFC2481'>[RFC2481]<span> (</span><span class='info'>Ramakrishnan, K. and S. Floyd, &ldquo;A Proposal to add Explicit Congestion Notification (ECN) to IP,&rdquo; January&nbsp;1999.</span><span>)</span></a>, legacy (RFC2003 or RFC2401) tunnels would have
      discarded any congestion markings added to the outer header, so RFC2481
      introduced rules for calculating the outgoing header from a combination
      of the inner and outer on decapsulation. RC2481 also introduced a second
      mode for IPsec tunnels, which turned off ECN processing (Not-ECT) in the
      outer header on encapsulation because an RFC2401 decapsulator would
      discard the outer on decapsulation. For RFC2401 IPsec this had the
      side-effect of completely blocking the covert channel.
</p>
<p>In RFC2481 the ECN field was defined as two separate bits. But when
      ECN moved from the experimental to the standards track <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a>, the ECN field was redefined as four
      codepoints. This required a different calculation of the ECN field from
      that used in RFC2481 on decapsulation. RFC3168 also had two modes; a
      'full functionality mode' that restricted the covert channel as much as
      possible but still allowed ECN to be used with IPsec, and another that
      completely turned off ECN processing across the tunnel. This 'limited
      functionality mode' both offered a way for operators to completely block
      the covert channel and allowed an RFC3168 ingress to interwork with a
      legacy tunnel egress (RFC2481, RFC2401 or RFC2003).
</p>
<p>The present specification includes a similar compatibility mode to
      interwork safely with tunnels compliant with any of these three earlier
      RFCs. However, unlike RFC3168, it is only a mode of the ingress, as
      decapsulation behaviour is the same in either case.
</p>
<a name="ecntun_Design_Constraints"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
Design Constraints</h3>

<p>Tunnel processing of a congestion notification field has to meet
      congestion control and management needs without creating new information
      security vulnerabilities (if information security is required). This
      appendix documents the analysis of the tradeoffs between these factors
      that led to the new encapsulation rules in <a class='info' href='#ecntun_Default_Ingress_Behaviour'>Section&nbsp;4.1<span> (</span><span class='info'>Default Tunnel Ingress Behaviour</span><span>)</span></a>.
</p>
<a name="ecntun_Security_Constraints"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.1"></a><h3>B.1.&nbsp;
Security Constraints</h3>

<p>Information security can be assured by using various end to end
        security solutions (including IPsec in transport mode <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>), but a commonly used scenario involves the
        need to communicate between two physically protected domains across
        the public Internet. In this case there are certain management
        advantages to using IPsec in tunnel mode solely across the publicly
        accessible part of the path. The path followed by a packet then
        crosses security 'domains'; the ones protected by physical or other
        means before and after the tunnel and the one protected by an IPsec
        tunnel across the otherwise unprotected domain. The scenario in <a class='info' href='#ecntun_Fig_IPsec_Tunnel_Scenario'>Figure&nbsp;5<span> (</span><span class='info'>IPsec Tunnel Scenario</span><span>)</span></a> will be used where
        endpoints 'A' and 'B' communicate through a tunnel. The tunnel ingress
        'I' and egress 'E' are within physically protected edge domains, while
        the tunnel spans an unprotected internetwork where there may be 'men
        in the middle', M.
</p><br /><hr class="insert" />
<a name="ecntun_Fig_IPsec_Tunnel_Scenario"></a>

<p style='text-align: center'>
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>     physically       unprotected     physically
 &lt;-protected domain-&gt;&lt;--domain--&gt;&lt;-protected domain-&gt;
 +------------------+            +------------------+
 |                  |      M     |                  |
 |    A--------&gt;I=========&gt;==========&gt;E--------&gt;B   |
 |                  |            |                  |
 +------------------+            +------------------+
                &lt;----IPsec secured----&gt;
                        tunnel
</pre></div>
<p style='text-align: center'>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: IPsec Tunnel Scenario&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>IPsec encryption is typically used to prevent 'M' seeing messages
        from 'A' to 'B'. IPsec authentication is used to prevent 'M'
        masquerading as the sender of messages from 'A' to 'B' or altering
        their contents. 'I' can use IPsec tunnel mode to allow 'A' to
        communicate with 'B', but impose encryption to prevent 'A' leaking
        information to 'M'. Or 'E' can insist that 'I' uses tunnel mode
        authentication to prevent 'M' communicating information to 'B'.
</p>
<p>Mutable IP header fields such as the ECN field (as well as the
        TTL/Hop Limit and DS fields) cannot be included in the cryptographic
        calculations of IPsec. Therefore, if 'I' copies these mutable fields
        into the outer header that is exposed across the tunnel it will have
        allowed a covert channel from 'A' to M that bypasses its encryption of
        the inner header. And if 'E' copies these fields from the outer header
        to the inner, even if it validates authentication from 'I', it will
        have allowed a covert channel from 'M' to 'B'.
</p>
<p>ECN at the IP layer is designed to carry information about
        congestion from a congested resource towards downstream nodes.
        Typically a downstream transport might feed the information back
        somehow to the point upstream of the congestion that can regulate the
        load on the congested resource, but other actions are possible (see
        <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a> &sect;6). In terms of the above unicast
        scenario, ECN effectively intends to create an information channel
        (for congestion signalling) from 'M' to 'B' (for 'B' to feed back to
        'A'). Therefore the goals of IPsec and ECN are mutually incompatible,
        requiring some compromise.
</p>
<p>With respect to using the DS or ECN fields as covert channels,
        &sect;5.1.2 of RFC4301 says, "controls are provided to manage the
        bandwidth of this channel". Using the ECN processing rules of RFC4301,
        the channel bandwidth is two bits per datagram from 'A' to 'M' and one
        bit per datagram from 'M' to 'A' (because 'E' limits the combinations
        of the 2-bit ECN field that it will copy). In both cases the covert
        channel bandwidth is further reduced by noise from any real congestion
        marking. RFC4301 implies that these covert channels are sufficiently
        limited to be considered a manageable threat. However, with respect to
        the larger (6b) DS field, the same section of RFC4301 says not copying
        is the default, but a configuration option can allow copying "to allow
        a local administrator to decide whether the covert channel provided by
        copying these bits outweighs the benefits of copying". Of course, an
        administrator considering copying of the DS field has to take into
        account that it could be concatenated with the ECN field giving an 8b
        per datagram covert channel.
</p>
<p>For tunnelling the 6b Diffserv field two conceptual models have had
        to be defined so that administrators can trade off security against
        the needs of traffic conditioning <a class='info' href='#RFC2983'>[RFC2983]<span> (</span><span class='info'>Black, D., &ldquo;Differentiated Services and Tunnels,&rdquo; October&nbsp;2000.</span><span>)</span></a>:</p>
<blockquote class="text"><dl>
<dt>The uniform model:</dt>
<dd>where the Diffserv field is
            preserved end-to-end by copying into the outer header on
            encapsulation and copying from the outer header on
            decapsulation.
</dd>
<dt>The pipe model:</dt>
<dd>where the outer header is
            independent of that in the inner header so it hides the Diffserv
            field of the inner header from any interaction with nodes along
            the tunnel.
</dd>
</dl></blockquote>

<p>However, for ECN, the new IPsec security architecture in RFC4301
        only standardised one tunnelling model equivalent to the uniform
        model. It deemed that simplicity was more important than allowing
        administrators the option of a tiny increment in security, especially
        given not copying congestion indications could seriously harm
        everyone's network service.
</p>
<a name="ecntun_Ctrl_Constraints"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.2"></a><h3>B.2.&nbsp;
Control Constraints</h3>

<p>Congestion control requires that any congestion notification marked
        into packets by a resource will be able to traverse a feedback loop
        back to a function capable of controlling the load on that resource.
        To be precise, rather than calling this function the data source, it
        will be called the Load Regulator. This allows for exceptional cases
        where load is not regulated by the data source, but usually the two
        terms will be synonymous. Note the term "a function <em>capable of</em> controlling the load" deliberately
        includes a source application that doesn't actually control the load
        but ought to (e.g. an application without congestion control that uses
        UDP).
</p><br /><hr class="insert" />
<a name="ecntun_Fig_Tunnel_Scenario"></a>

<p style='text-align: center'>
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
 A---&gt;R---&gt;I=========&gt;M=========&gt;E--------&gt;B

</pre></div>
<p style='text-align: center'>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: Simple Tunnel Scenario&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>A similar tunnelling scenario to the IPsec one just described will
        now be considered, but without the different security domains, because
        the focus now shifts to whether the control loop and management
        monitoring work (<a class='info' href='#ecntun_Fig_Tunnel_Scenario'>Figure&nbsp;6<span> (</span><span class='info'>Simple Tunnel Scenario</span><span>)</span></a>).
        If resources in the tunnel are to be able to explicitly notify
        congestion and the feedback path is from 'B' to 'A', it will certainly
        be necessary for 'E' to copy any CE marking from the outer header to
        the inner header for onward transmission to 'B', otherwise congestion
        notification from resources like 'M' cannot be fed back to the Load
        Regulator ('A'). But it does not seem necessary for 'I' to copy CE
        markings from the inner to the outer header. For instance, if resource
        'R' is congested, it can send congestion information to 'B' using the
        congestion field in the inner header without 'I' copying the
        congestion field into the outer header and 'E' copying it back to the
        inner header. 'E' can still write any additional congestion marking
        introduced across the tunnel into the congestion field of the inner
        header.
</p>
<p>All this shows that 'E' can preserve the control loop irrespective
        of whether 'I' copies congestion notification into the outer header or
        resets it.
</p>
<p>That is the situation for existing control arrangements but,
        because copying reveals more information, it would open up
        possibilities for better control system designs. For instance,
        resetting CE marking on encapsulation breaks the standards track PCN
        congestion marking scheme <a class='info' href='#RFC5670'>[RFC5670]<span> (</span><span class='info'>Eardley, P., &ldquo;Metering and Marking Behaviour of PCN-Nodes,&rdquo; November&nbsp;2009.</span><span>)</span></a>. It ends up
        removing excessive amounts of traffic unnecessarily. Whereas copying
        CE markings at ingress leads to the correct control behaviour.
</p>
<a name="ecntun_Mgmt_Constraints"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.3"></a><h3>B.3.&nbsp;
Management Constraints</h3>

<p>As well as control, there are also management constraints.
        Specifically, a management system may monitor congestion markings in
        passing packets, perhaps at the border between networks as part of a
        service level agreement. For instance, monitors at the borders of
        autonomous systems may need to measure how much congestion has
        accumulated so far along the path, perhaps to determine between them
        how much of the congestion is contributed by each domain.
</p>
<p>In this document the baseline of congestion marking (or the
        Congestion Baseline) is defined as the source of the layer that
        created (or most recently reset) the congestion notification field.
        When monitoring congestion it would be desirable if the Congestion
        Baseline did not depend on whether packets were tunnelled or not.
        Given some tunnels cross domain borders (e.g. consider M in <a class='info' href='#ecntun_Fig_Tunnel_Scenario'>Figure&nbsp;6<span> (</span><span class='info'>Simple Tunnel Scenario</span><span>)</span></a> is monitoring a border),
        it would therefore be desirable for 'I' to copy congestion accumulated
        so far into the outer headers, so that it is exposed across the
        tunnel.
</p>
<p>For management purposes it might be useful for the tunnel egress to
        be able to monitor whether congestion occurred across a tunnel or
        upstream of it. Superficially it appears that copying congestion
        markings at the ingress would make this difficult, whereas it was
        straightforward when an RFC3168 ingress reset them. However, <a class='info' href='#ecntun_Tunnel_Contribution'>Appendix&nbsp;C<span> (</span><span class='info'>Contribution to Congestion across a Tunnel</span><span>)</span></a> gives a simple and precise
        method for a tunnel egress to infer the congestion level introduced
        across a tunnel. It works irrespective of whether the ingress copies
        or resets congestion markings.
</p>
<a name="ecntun_Tunnel_Contribution"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.C"></a><h3>Appendix C.&nbsp;
Contribution to Congestion across a Tunnel</h3>

<p>This specification mandates that a tunnel ingress determines the ECN
      field of each new outer tunnel header by copying the arriving header.
      Concern has been expressed that this will make it difficult for the
      tunnel egress to monitor congestion introduced only along a tunnel,
      which is easy if the outer ECN field is reset at a tunnel ingress
      (RFC3168 full functionality mode). However, in fact copying CE marks at
      ingress will still make it easy for the egress to measure congestion
      introduced across a tunnel, as illustrated below.
</p>
<p>Consider 100 packets measured at the egress. Say it measures that 30
      are CE marked in the inner and outer headers and 12 have additional CE
      marks in the outer but not the inner. This means packets arriving at the
      ingress had already experienced 30% congestion. However, it does not
      mean there was 12% congestion across the tunnel. The correct calculation
      of congestion across the tunnel is p_t = 12/(100-30) = 12/70 = 17%. This
      is easy for the egress to measure. It is simply the proportion of
      packets not marked in the inner header (70) that have a CE marking in
      the outer header (12). This technique works whether the ingress copies
      or resets CE markings, so it can be used by an egress that is not sure
      which RFC the ingress complies with.
</p>
<p><a class='info' href='#ecntun_Fig_Tunnel_Contrib'>Figure&nbsp;7<span> (</span><span class='info'>Tunnel Marking of Packets Already Marked at Ingress</span><span>)</span></a> illustrates this in
      a combinatorial probability diagram. The square represents 100 packets.
      The 30% division along the bottom represents marking before the ingress,
      and the p_t division up the side represents marking introduced across
      the tunnel.
</p><br /><hr class="insert" />
<a name="ecntun_Fig_Tunnel_Contrib"></a>

<p>
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>     ^ outer header marking
     |
100% +-----+---------+       The large square
     |     |         |       represents 100 packets
     | 30  |         |
     |     |         |   p_t = 12/(100-30)
 p_t +     +---------+       = 12/70
     |     |   12    |       = 17%
   0 +-----+---------+---&gt;
     0    30%       100%  inner header marking</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;7: Tunnel Marking of Packets Already Marked at Ingress&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
</p>
<a name="ecntun_Compromise"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.D"></a><h3>Appendix D.&nbsp;
Compromise on Decap with ECT(1) Inner and ECT(0) Outer</h3>

<p>A packet with an ECT(1) inner and an ECT(0) outer should never arise
      from any known IETF protocol. Without giving a reason, RFC3168 and
      RFC4301 both say the outer should be ignored when decapsulating such a
      packet. This appendix explains why it was decided not to change this
      advice.
</p>
<p>In summary, ECT(0) always means 'not congested' and ECT(1) may imply
      the same <a class='info' href='#RFC3168'>[RFC3168]<span> (</span><span class='info'>Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;The Addition of Explicit Congestion Notification (ECN) to IP,&rdquo; September&nbsp;2001.</span><span>)</span></a> or it may imply a higher
      severity congestion signal <a class='info' href='#RFC4774'>[RFC4774]<span> (</span><span class='info'>Floyd, S., &ldquo;Specifying Alternate Semantics for the Explicit Congestion Notification (ECN) Field,&rdquo; November&nbsp;2006.</span><span>)</span></a>, <a class='info' href='#I-D.ietf-pcn-3-in-1-encoding'>[I&#8209;D.ietf&#8209;pcn&#8209;3&#8209;in&#8209;1&#8209;encoding]<span> (</span><span class='info'>Briscoe, B., Moncaster, T., and M. Menth, &ldquo;Encoding 3 PCN-States in the IP header using a single DSCP,&rdquo; July&nbsp;2010.</span><span>)</span></a>, depending on the
      transport in use. Whether they mean the same or not, at the ingress the
      outer should have started the same as the inner and only a broken or
      compromised router could have changed the outer to ECT(0).
</p>
<p>The decapsulator can detect this anomaly. But the question is, should
      it correct the anomaly by ignoring the outer, or should it reveal the
      anomaly to the end-to-end transport by forwarding the outer?
</p>
<p>On balance, it was decided that the decapsulator should correct the
      anomaly, but log the event and optionally raise an alarm. This is the
      safe action if ECT(1) is being used as a more severe marking than
      ECT(0), because it passes the more severe signal to the transport.
      However, it is not a good idea to hide anomalies, which is why an
      optional alarm is suggested. It should be noted that this anomaly may be
      the result of two changes to the outer: a broken or compromised router
      within the tunnel might be erasing congestion markings introduced
      earlier in the same tunnel by a congested router. In this case, the
      anomaly would be losing congestion signals, which needs immediate
      attention.
</p>
<p>The original reason for defining ECT(0) and ECT(1) as equivalent was
      so that the data source could use the ECN nonce <a class='info' href='#RFC3540'>[RFC3540]<span> (</span><span class='info'>Spring, N., Wetherall, D., and D. Ely, &ldquo;Robust Explicit Congestion Notification (ECN) Signaling with Nonces,&rdquo; June&nbsp;2003.</span><span>)</span></a> to detect if congestion signals were being
      erased. However, in this case, the decapsulator does not need a nonce to
      detect any anomalies introduced within the tunnel, because it has the
      inner as a record of the header at the ingress. Therefore, it was
      decided that the best compromise would be to give precedence to solving
      the safety issue over revealing the anomaly, because the anomaly could
      at least be detected and dealt with internally.
</p>
<p>Superficially, the opposite case where the inner and outer carry
      different ECT values, but with an ECT(1) outer and ECT(0) inner, seems
      to require a similar compromise. However, because that case is reversed,
      no compromise is necessary; it is best to forward the outer whether the
      transport expects the ECT(1) to mean a higher severity than ECT(0) or
      the same severity. Forwarding the outer either preserves a higher value
      (if it is higher) or it reveals an anomaly to the transport (if the two
      ECT codepoints mean the same severity).
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.E"></a><h3>Appendix E.&nbsp;
Open Issues</h3>

<p>The new decapsulation behaviour defined in <a class='info' href='#ecntun_Default_Egress_Behaviour'>Section&nbsp;4.2<span> (</span><span class='info'>Default Tunnel Egress Behaviour</span><span>)</span></a> adds support for
      propagation of 2 severity levels of congestion. However transports have
      no way to discover whether there are any legacy tunnels on their path
      that will not propagate 2 severity levels. It would have been nice to
      add a feature for transports to check path support, but this remains an
      open issue that will have to be addressed in any future standards action
      to define an end-to-end scheme that requires 2-severity levels of
      congestion. PCN avoids this problem because it is only for a controlled
      region, so all legacy tunnels can be upgraded by the same operator that
      deploys PCN.
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bob Briscoe</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">BT</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">B54/77, Adastral Park</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Martlesham Heath</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ipswich  IP5 3RE</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">UK</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+44 1473 645196</td></tr>
<tr><td class="author" align="right">EMail:&nbsp;</td>
<td class="author-text"><a href="mailto:bob.briscoe@bt.com">bob.briscoe@bt.com</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://bobbriscoe.net/">http://bobbriscoe.net/</a></td></tr>
</table>
</body></html>
