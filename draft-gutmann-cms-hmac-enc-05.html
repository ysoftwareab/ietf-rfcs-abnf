<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Using MAC-authenticated Encryption in the Cryptographic Message Syntax (CMS)</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Conventions Used in This Document">
<link href="#rfc.section.2" rel="Chapter" title="2 Background">
<link href="#rfc.section.3" rel="Chapter" title="3 CMS Encrypt-and-Authenticate Overview">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Rationale">
<link href="#rfc.section.4" rel="Chapter" title="4 CMS Encrypt-and-Authenticate ">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Encrypt-and-Authenticate Message Processing">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Rationale">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Test Vectors">
<link href="#rfc.section.5" rel="Chapter" title="5 SMIMECapabilities Attribute">
<link href="#rfc.section.6" rel="Chapter" title="6 Security Considerations">
<link href="#rfc.section.7" rel="Chapter" title="7 IANA Considerations">
<link href="#rfc.section.8" rel="Chapter" title="8 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="9 References">
<link href="#rfc.references.1" rel="Chapter" title="9.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="9.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document specifies the conventions for using MAC-authenticated encryption with the Cryptographic Message Syntax (CMS) authenticated-enveloped-data content type.  This mirrors the use of a MAC combined with an encryption algorithm that's already employed in IPsec, SSL/TLS, and SSH, which is widely supported in existing crypto libraries and hardware, and has been extensively analysed by the crypto community.  " />
  <meta name="description" content="This document specifies the conventions for using MAC-authenticated encryption with the Cryptographic Message Syntax (CMS) authenticated-enveloped-data content type.  This mirrors the use of a MAC combined with an encryption algorithm that's already employed in IPsec, SSL/TLS, and SSH, which is widely supported in existing crypto libraries and hardware, and has been extensively analysed by the crypto community.  " />
  <meta name="keywords" content="Internet-Draft" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">S/MIME Working Group</td>
<td class="right">P. Gutmann</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">University of Auckland</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">June 22, 2011</td>
</tr>
<tr>
<td class="left">Expires: December 24, 2011</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Using MAC-authenticated Encryption in the Cryptographic Message Syntax (CMS)<br />
  <span class="filename">draft-gutmann-cms-hmac-enc-05.txt</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document specifies the conventions for using MAC-authenticated encryption with the Cryptographic Message Syntax (CMS) authenticated-enveloped-data content type.  This mirrors the use of a MAC combined with an encryption algorithm that's already employed in IPsec, SSL/TLS, and SSH, which is widely supported in existing crypto libraries and hardware, and has been extensively analysed by the crypto community.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on December 24, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Conventions Used in This Document</a>
</li>
<li>2.   <a href="#rfc.section.2">Background</a>
</li>
<li>3.   <a href="#rfc.section.3">CMS Encrypt-and-Authenticate Overview</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Rationale</a>
</li>
<li>4.   <a href="#rfc.section.4">CMS Encrypt-and-Authenticate </a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Encrypt-and-Authenticate Message Processing</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Rationale</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Test Vectors</a>
</li>
<li>5.   <a href="#rfc.section.5">SMIMECapabilities Attribute</a>
</li>
<li>6.   <a href="#rfc.section.6">Security Considerations</a>
</li>
<li>7.   <a href="#rfc.section.7">IANA Considerations</a>
</li>
<li>8.   <a href="#rfc.section.8">Acknowledgements</a>
</li>
<li>9.   <a href="#rfc.references">References</a>
</li>
<li>9.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>9.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">This document specifies the conventions for using MAC-authenticated encryption with the Cryptographic Message Syntax (CMS) authenticated-enveloped-data content type.  This mirrors the use of a MAC combined with an encryption algorithm that's already employed in IPsec, SSL/TLS, and SSH, which is widely supported in existing crypto libraries and hardware, and has been extensively analysed by the crypto community.  </p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#mustshouldmay" id="mustshouldmay">Conventions Used in This Document</a>
</h1>
<p id="rfc.section.1.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#usecase" id="usecase">Background</a>
</h1>
<p id="rfc.section.2.p.1">Integrity-protected encryption is a standard feature of session-oriented security protocols like <a href="#IPsec">[IPsec]</a>, <a href="#SSH">[SSH]</a>, and <a href="#TLS">[TLS]</a>, but until recently wasn't available for message-based security protocols like CMS, although <a href="#OpenPGP">[OpenPGP]</a> added a form of integrity protection by encrypting a SHA-1 hash of the message alongside the message contents to provide authenticate-and-encrypt protection.  Usability studies have shown that users expect encryption to provide integrity protection <a href="#Garfinkel">[Garfinkel]</a>, creating cognitive dissonance problems when the security mechanisms don't in fact provide this assurance.  </p>
<p id="rfc.section.2.p.2">This document applies the same encrypt-and-authenticate mechanism already employed in IPsec, SSH, and SSL/TLS, to CMS (technically some of these actually use authenticate-and-encrypt rather than encrypt-and-authenticate, since what's authenticated is the plaintext and not the ciphertext).  This mechanism is widely supported in existing crypto libraries and hardware, and has been extensively analysed by the crypto community <a href="#EncryptThenAuth">[EncryptThenAuth]</a>.  </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#overview" id="overview">CMS Encrypt-and-Authenticate Overview</a>
</h1>
<div id="#rfc.figure.1"></div>
<pre>
    KEK( CEK ) || CEK( data )
        </pre>
<div id="#rfc.figure.2"></div>
<pre>
    KEK( master_secret ) || MAC( CEK( data ) )
        </pre>
<div id="#rfc.figure.3"></div>
<pre>
    MAC-K := PRF( master_secret, "authentication" );
    CEK-K := PRF( master_secret, "encryption" );
        </pre>
<p id="rfc.section.3.p.1">Conventional CMS encryption uses a content encryption key (CEK) to encrypt a message payload.  Authenticated encryption requires two keys, one for encryption and a second one for authentication.  Like other mechanisms that use authenticated encryption, this document employs a pseudorandom function (PRF) to convert a single block of keying material into the two keys required for encryption and authentication.  This converts the standard CMS encryption operation: </p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#overview_rationale" id="overview_rationale">Rationale</a>
</h1>
<p id="rfc.section.3.1.p.1">There are several possible means of deriving the two keys required for the encrypt-and-authenticate process from the single key normally provided by the key exchange or key transport mechanisms.  Several of these however have security or practical issues.  For example any mechanism that uses the single exchanged key in its entirety for encryption (using, perhaps, PRF( key ) as the MAC key) can be converted back to unauthenticated data by removing the outer MAC layer and rewriting the CMS envelope back to plain EnvelopedData or EncryptedData.  By applying the PRF intermediate step, any attempt at a rollback attack will result in a decryption failure.  </p>
<p id="rfc.section.3.1.p.2">The option chosen here, the use of a PRF to derive the necessary sets of keying material from a master secret, is well-established through its use in IPsec, SSH, and SSL/TLS, and is widely supported in both crypto libraries and in encryption hardware.  </p>
<p id="rfc.section.3.1.p.3">The PRF used is PBKDF2 because its existing use in CMS makes it the most obvious candidate for such a function.  If in the future a universal PRF, for example <a href="#HKDF">[HKDF]</a>, is adopted then this can be substituted for PBKDF2 by specifying it in the prfAlgorithm field covered in <a href="#enc-auth">Section 4</a>.  </p>
<p id="rfc.section.3.1.p.4">The resulting processing operations consist of a combination of the operations used for the existing CMS content types EncryptedData and AuthenticatedData, allowing them to be implemented relatively simply using existing code.  </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#enc-auth" id="enc-auth">CMS Encrypt-and-Authenticate </a>
</h1>
<p id="rfc.section.4.p.1">The encrypt-and-authenticate mechanism is implemented within the existing CMS RecipientInfo framework by defining a new pseudo-algorithm type authEnc which is used in place of a monolithic encrypt and hash algorithm.  The RecipientInfo is used as a key container for the master secret used by the pseudo-algorithm from which the encryption and authentication keys for existing single-purpose encrypt-only and MAC-only algorithms are derived.  Thus instead of using the RecipientInfo to communicate (for example) an AES or HMAC-SHA1 key, it communicates an authEnc keying value from which the required AES encryption and HMAC-SHA1 authentication keys are derived.  </p>
<div id="#rfc.figure.4"></div>
<pre>
    id-smime OBJECT IDENTIFIER ::= { iso(1) member-body(2)
                us(840) rsadsi(113549) pkcs(1) pkcs9(9) 16 }

    id-alg  OBJECT IDENTIFIER ::= { id-smime 3 }

    id-alg-authEnc-128 OBJECT IDENTIFIER ::= { id-alg 15 }
    id-alg-authEnc-256 OBJECT IDENTIFIER ::= { id-alg 16 }
        </pre>
<div id="#rfc.figure.5"></div>
<pre>
    AuthEncParams ::= SEQUENCE {
        prfAlgorithm   [0] AlgorithmIdentifier DEFAULT PBKDF2,
        encAlgorithm       AlgorithmIdentifier,
        macAlgorithm       AlgorithmIdentifier
        }
        </pre>
<p id="rfc.section.4.p.2">The authEnc pseudo-algorithm comes in two forms, one conveying 128 bits of keying material and one conveying 256 bits: </p>
<p></p>

<ul class="empty">
<li>prfAlgorithm is the PRF algorithm used to convert the authEnc value into the encryption and MAC keys.  The default PRF is <a href="#PBKDF2">[PBKDF2]</a> (which in turn has a default PRF algorithm of HMAC-SHA1).</li>
<li>encAlgorithm is the encryption algorithm and associated parameters to be used to encrypt the content.</li>
<li>macAlgorithm is the MAC algorithm and associated parameters to be used to authenticate/integrity-protect the content.</li>
</ul>

<p> </p>
<p id="rfc.section.4.p.4">When the PRF AlgorithmIdentifier is used to specify a PRF other than the default PBKDF2-with-HMAC-SHA1 one, the salt parameter MUST be an empty (zero- length) string and the iterationCount MUST be one, since these values aren't used in the PRF process. In their encoded form, these two parameters have the value 08 00 02 01 01.  </p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#processing" id="processing">Encrypt-and-Authenticate Message Processing</a>
</h1>
<p id="rfc.section.4.1.p.1">The randomly-generated authEnc key to be communicated via the RecipientInfo(s) is converted to separate encryption and authentication keys and applied to the encrypt-and-authenticate process as follows.  The notation "PRF( key, salt, iterations )" is used to denote an application of the PRF to the given keying value and salt, for the given number of iterations: </p>
<div id="#rfc.figure.6"></div>
<pre>
        MAC-K ::= PRF( authEnc_key, "authentication", 1 );
          </pre>
<div id="#rfc.figure.7"></div>
<pre>
        Enc-K ::= PRF( authEnc_key, "encryption", 1 );
          </pre>
<div id="#rfc.figure.8"></div>
<pre>
        MAC( contentEncrAlgoID || encrypt( content ) );
          </pre>
<div id="#rfc.figure.9"></div>
<pre>
        MAC( contentEncrAlgoID || encrypt( content ) || authAttr );
          </pre>
<p></p>

<ol>
<li>The MAC algorithm key is derived from the authEnc key via: </li>
<li>The encryption algorithm key is derived from the authEnc key via: </li>
<li>The data is processed as described in <a href="#AuthEnv">[AuthEnv]</a>, and specifically since the mechanisms used are a union of EncryptedData and AuthenticatedData, as per <a href="#CMS">[CMS]</a>.  The one exception to this is that the EncryptedContentInfo.ContentEncryptionAlgorithmIdentifier data is MACed before the encrypted content is MAced.  The EncryptedData processing is applied to the data first and then the AuthenticatedData processing is applied to the result, so that the nesting is: </li>
<li>If authenticated attributes are present then they are encoded as described in <a href="#AuthEnv">[AuthEnv]</a> and MACed after the encrypted content, so that the processing is: </li>
</ol>

<p> </p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#processing-rationale" id="processing-rationale">Rationale</a>
</h1>
<p id="rfc.section.4.2.p.1">When choosing between encrypt-and-authenticate and authenticate-and-encrypt the more secure option is encrypt-and-authenticate.  There has been extensive analysis of this in the literature, the best coverage is probably <a href="#EncryptThenAuth">[EncryptThenAuth]</a>.  </p>
<p id="rfc.section.4.2.p.2">The EncryptedContentInfo.ContentEncryptionAlgorithmIdentifier is the SEQUENCE containing the id-alg-authEnc-128/id-alg-authEnc-256 OBJECT IDENTIFIER and its associated AuthEncParams.  This data is MACed exactly as encoded, without any attempt to re-code it into a canonical form like DER.  </p>
<p id="rfc.section.4.2.p.3">The EncryptedContentInfo.ContentEncryptionAlgorithmIdentifier must be protected alongside the encrypted content otherwise an attacker could manipulate the encrypted data indirectly by manipulating the encryption algorithm parameters, which wouldn't be detected through MACing the encrypted content alone.  For example by changing the encryption IV it's possible to modify the results of the decryption after the encrypted data has been verified via a MAC check.  </p>
<p id="rfc.section.4.2.p.4">The authEnc pseudo-algorithm has two "key sizes" rather than the one-size-fits-all that the PRF impedance-matching would provide.  This is done to address real-world experience in the use of AES keys where users demanded AES-256 alongside AES-128 because of some perception that the former was "twice as good" as the latter.  Providing an option for keys that go to 11 avoids potential user acceptance problems when someone notices that the authEnc pseudo-key has "only" 128 bits when they expect their AES keys to be 256 bits long.  </p>
<p id="rfc.section.4.2.p.5">Using a fixed-length key rather than making it a user-selectable parameter is done for the same reason as AES' quantised key lengths: there's no benefit to allowing, say, 137-bit keys over basic 128- and 256-bit lengths, it adds unnecessary complexity, and if the lengths are user-defined then there'll always be someone who wants keys that go up to 12.  Providing a choice of two commonly-used lengths gives users the option of choosing a "better" key size should they feel the need, while not overloading the system with unneeded flexibility.  </p>
<div id="#rfc.figure.10"></div>
<pre>
    PBKDF2-params ::= SEQUENCE {
        salt OCTET STRING,
        iterationCount INTEGER (1..MAX),
        prf AlgorithmIdentifier {{PBKDF2-PRFs}}
                                DEFAULT algid-hmacWithSHA1
        }
          </pre>
<p id="rfc.section.4.2.p.6">The use of the PRF AlgorithmIdentifier presents some problems because it's usually not specified in a manner that allows it to be easily used as a straight KDF.  For example PBKDF2 has parameters: </p>
<p id="rfc.section.4.2.p.7">Specifying a MAC key size gets a bit tricky, most MAC algorithms have some de facto standard key size and for HMAC algorithms this is usually the same as the hash output size.  For example for HMAC-MD5 it's 128 bits, for HMAC-SHA1 it's 160 bits, and for HMAC-SHA256 it's 256 bits.  Other MAC algorithms also have de facto standard key sizes, for example for AES-based MACs it's the AES key size, 128 bits for AES-128 and 256 bits for AES-256.  This situation makes it difficult to specify the key size in a normative fashion since it's dependent on the algorithm type that's being used.  If there is any ambiguity over which key size should be used then it's recommended that the size be specified explicitly in the macAlgorithm AlgorithmIdentifier.  </p>
<p id="rfc.section.4.2.p.8">As with other uses of PRFs for cryto impedance matching in protocols like IPsec, SSL/TLS and SSH, the amount of input to the PRF generally doesn't match the amount of output.  The general philosophical implications of this are covered in various analyses of the properties and uses of PRFs.  If you're worried about this then you can try and approximately match the authEnc "key size" to the key size of the encryption algorithm being used, although even there a perfect match for algorithms like Blowfish (448 bits) or RC5 (832 bits) is going to be difficult.  </p>
<p id="rfc.section.4.2.p.9">Apart from the extra step added to key management, all of the processing is already specified as part of the definition of the standard CMS content-types Encrypted/EnvelopedData and AuthenticatedData.  This significantly simplifies both the specification and the implementation task, as no new content-processing mechanisms are introduced.  </p>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#test-vectors" id="test-vectors">Test Vectors</a>
</h1>
<p id="rfc.section.4.3.p.1">The following test vectors may be used to verify an implementation of MAC-authenticated encryption.  This represents a text string encrypted and authenticated using the password "Password" via CMS PasswordRecipientInfo.  The encryption algorithm used is triple DES, whose short block size (compared to AES) makes it easier to corrupt arbitrary bytes for testing purposes within the self-healing CBC mode which will result in correct decryption but a failed MAC check.  </p>
<p id="rfc.section.4.3.p.2">The test data has the following characteristics: </p>
<p></p>

<ul class="empty">
<li>version is set to 0.</li>
<li>originatorInfo isn't needed and is omitted.</li>
<li>recipientInfos uses passwordRecipientInfo to allow easy testing with a fixed text string.</li>
<li>authEncryptedContentInfo uses the authEnc128 pseudo-algorithm with a key of 128 bits used to derive triple DES and HMAC-SHA1 keys.</li>
<li>authAttrs aren't used and are omitted.</li>
<li>mac is the 20-byte HMAC-SHA1 MAC value.</li>
<li>unauthAttrs aren't used and are omitted.</li>
</ul>

<p> </p>
<div id="#rfc.figure.11"></div>
<pre>
   0  227: SEQUENCE {
   3   11:   OBJECT IDENTIFIER authEnvelopedData
                               (1 2 840 113549 1 9 16 1 23)
  16  211:   [0] {
  19  208:     SEQUENCE {
  22    1:       INTEGER 0
  25   97:       SET {
  27   95:         [3] {
  29    1:           INTEGER 0
  32   27:           [0] {
  34    9:             OBJECT IDENTIFIER pkcs5PBKDF2
                                         (1 2 840 113549 1 5 12)
  45   14:             SEQUENCE {
  47    8:               OCTET STRING B7 EB 23 A7 6B D2 05 16
  57    2:               INTEGER 5000
         :               }
         :             }
  61   35:           SEQUENCE {
  63   11:             OBJECT IDENTIFIER pwriKEK
                                         (1 2 840 113549 1 9 16 3 9)
  76   20:             SEQUENCE {
  78    8:               OBJECT IDENTIFIER des-EDE3-CBC
                                           (1 2 840 113549 3 7)
  88    8:               OCTET STRING 66 91 02 45 6B 73 BB 99
         :               }
         :             }
  98   24:           OCTET STRING
         :             30 A3 7A B5 D8 F2 87 50 EC 41 04 AE 89 99 26 F0
         :             2E AE 4F E3 F3 52 2B A3
         :           }
         :         }
 124   82:       SEQUENCE {
 126    9:         OBJECT IDENTIFIER data (1 2 840 113549 1 7 1)
 137   51:         SEQUENCE {
 139   11:           OBJECT IDENTIFIER authEnc128
                                       (1 2 840 113549 1 9 16 3 15)
 152   36:           SEQUENCE {
 154   20:             SEQUENCE {
 156    8:               OBJECT IDENTIFIER des-EDE3-CBC
                                           (1 2 840 113549 3 7)
 166    8:               OCTET STRING D2 D0 81 71 4D 3D 9F 11
         :               }
 176   12:             SEQUENCE {
 178    8:               OBJECT IDENTIFIER hmacSHA (1 3 6 1 5 5 8 1 2)
 188    0:               NULL
         :               }
         :             }
         :           }
 190   16:         [0] 3A C6 06 61 41 5D 00 7D 11 35 CD 69 E1 56 CA 10
         :         }
 208   20:       OCTET STRING
         :         33 65 E8 F0 F3 07 06 86 1D A8 47 2C 6D 3A 1D 94
         :         21 40 64 7E
         :       }
         :     }
         :   }
        </pre>
<p></p>
<div id="#rfc.figure.12"></div>
<pre>
-----BEGIN PKCS7-----
MIHjBgsqhkiG9w0BCRABF6CB0zCB0AIBADFho18CAQCgGwYJKoZIhvcNAQUMMA4ECLfrI6dr
0gUWAgITiDAjBgsqhkiG9w0BCRADCTAUBggqhkiG9w0DBwQIZpECRWtzu5kEGDCjerXY8odQ
7EEEromZJvAurk/j81IrozBSBgkqhkiG9w0BBwEwMwYLKoZIhvcNAQkQAw8wJDAUBggqhkiG
9w0DBwQI0tCBcU09nxEwDAYIKwYBBQUIAQIFAIAQOsYGYUFdAH0RNc1p4VbKEAQUM2Xo8PMH
BoYdqEcsbTodlCFAZH4=
-----END PKCS7-----
        </pre>
<p></p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#smimecaps" id="smimecaps">SMIMECapabilities Attribute</a>
</h1>
<p id="rfc.section.5.p.1">An S/MIME client SHOULD announce the set of cryptographic functions that it supports by using the S/MIME capabilities attribute <a href="#SMIME">[SMIME]</a>.  If the client wishes to indicate support for MAC-authenticated encryption, the capabilities attribute MUST contain the authEnc128 and/or authEnc256 OID specified above with algorithm parameters ABSENT.  The other algorithms used in the authEnc algorithm such as the MAC and encryption algorithm are selected based on the presence of these algorithms in the SMIMECapabilities or by mutual agreement.  </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.6.p.1">Unlike other CMS authenticated-data mechanisms like SignedData and AuthenticatedData, AuthEnv's primary transformation isn't authentication but encryption, so that AuthEnvData may decrypt successfully (in other words the primary data transformation present in the mechanism will succeed) but the secondary function of authentication using the MAC value that follows the encrypted data could still fail.  This can lead to a situation in which an implementation might output decrypted data before it reaches and verifies the MAC value.  In other words decryption is performed inline and the result is available immediately, while the authentication result isn't available until all of the content has been processed.  If the implementation prematurely provides data to the user and later comes back to inform them that the earlier data was, in retrospect, tainted, this may cause users to act prematurely on the tainted data.  </p>
<p id="rfc.section.6.p.2">This situation could occur in a streaming implementation where data has to be made available as soon as possible (so that the initial plaintext is emitted before the final ciphertext and MAC value are read), or one where the quantity of data involved rules out buffering the recovered plaintext until the MAC value can be read and verified.  In addition an implementation that tries to be overly helpful may treat missing non-payload trailing data as non-fatal, allowing an attacker to truncate the data somewhere before the MAC value and thereby defeat the data authentication.  This is complicated even further by the fact that an implementation may not be able to determine, when it encounters truncated data, whether the remainder (including the MAC value) will arrive presently (a non-failure) or whether it's been truncated by an attacker and should therefore be treated as a MAC failure.  (Note that this same issue affects other types of data authentication like signed and MACd data as well, since an over-optimistic implementation may return data to the user before checking for a verification failure is possible).  </p>
<p id="rfc.section.6.p.3">The exact solution to these issues is somewhat implementation-specific, with some suggested mitigations being as follows: Implementations should buffer the entire message if possible and verify the MAC before performing any decryption.  If this isn't possible due to streaming or message-size constraints then implementations should consider breaking long messages into a sequence of smaller ones, each of which can be processed atomically as above.  If even this isn't possible then implementations should make obvious to the caller or user that an authentication failure has occurred and that the previously-returned or output data shouldn't be used.  Finally, any data-formatting problem such as obviously truncated data or missing trailing data should be treated as a MAC verification failure even if the rest of the data was processed correctly.  </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#iana" id="iana">IANA Considerations</a>
</h1>
<p id="rfc.section.7.p.1">This document contains two algorithm identifiers defined by the SMIME Working Group Registrar in an arc delegated by RSA to the SMIME Working Group: iso(1) member-body(2) us(840) rsadsi(113549) pkcs(1) pkcs-9(9) smime(16) modules(0).  No action by IANA is necessary for this document or any anticipated updates.  </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#ack" id="ack">Acknowledgements</a>
</h1>
<p id="rfc.section.8.p.1">The author would like to thank Jim Schaad and the members of the S/MIME mailing list for their feedback on this document.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">9.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">9.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="1">[1]</b></td>
<td class="top">
<a>Housley, R</a>, "<a href="http://tools.ietf.org/html/rfc5652">Cryptographic Message Syntax (CMS)</a>", RFC 5652, September 2009.</td>
</tr>
<tr>
<td class="reference"><b id="2">[2]</b></td>
<td class="top">
<a>Housley, R</a>, "<a href="http://tools.ietf.org/html/rfc5083">Cryptographic Message Syntax (CMS) Authenticated-Enveloped-Data Content Type</a>", RFC 5083, November 2007.</td>
</tr>
<tr>
<td class="reference"><b id="3">[3]</b></td>
<td class="top">
<a title="RSA Laboratories">Kaliski, B</a>, "<a href="http://tools.ietf.org/html/rfc2898">PKCS #5: Password-Based Cryptography Specification</a>", RFC 2898, September 2000.</td>
</tr>
<tr>
<td class="reference"><b id="4">[4]</b></td>
<td class="top">
<a title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="5">[5]</b></td>
<td class="top">
<a title="Brute Squad Labs">Ramsdell, B</a> and <a title="IECA, Inc">S Turner</a>, "<a href="http://tools.ietf.org/html/rfc5751">Secure/Multipurpose Internet Mail Extensions (S/MIME) Version 3.2 Message Specification</a>", RFC 5751, January 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">9.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="1">[1]</b></td>
<td class="top">
<a title="IBM Research">Krawczyk, H</a> and <a title="Nokia Research Center">P Eronen</a>, "<a href="http://tools.ietf.org/html/rfc5869">HMAC-based Extract-and-Expand Key Derivation Function (HKDF)</a>", RFC 5869, May 2010.</td>
</tr>
<tr>
<td class="reference"><b id="2">[2]</b></td>
<td class="top">
<a title="IBM Research">Krawczyk, H</a>, "<a>The Order of Encryption and Authentication for Protecting Communications (or: How Secure Is SSL?)</a>", Springer-Verlag LNCS 2139, August 2001.</td>
</tr>
<tr>
<td class="reference"><b id="3">[3]</b></td>
<td class="top">
<a title="PGP Corporation">Callas, J</a>, <a title="IKS GmbH">Donnerhacke, L</a>, <a title="PGP Corporation">Hal, H</a>, <a>Shaw, D</a> and <a>R Thayer</a>, "<a href="http://tools.ietf.org/html/rfc4880">OpenPGP Message Format</a>", RFC 4880, November 2007.</td>
</tr>
<tr>
<td class="reference"><b id="4">[4]</b></td>
<td class="top">
<a title="SSH Communications Security Corp">Ylonen, T</a> and <a title="Cisco Systems, Inc">C Lonvick</a>, "<a href="http://tools.ietf.org/html/rfc4253">The Secure Shell (SSH) Transport Layer Protocol</a>", RFC 4253, January 2006.</td>
</tr>
<tr>
<td class="reference"><b id="5">[5]</b></td>
<td class="top">
<a title="Independent">Dierks, T</a> and <a title="RTFM, Inc">E Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5246">The Transport Layer Security (TLS) Protocol Version 1.2</a>", RFC 5246, August 2008.</td>
</tr>
<tr>
<td class="reference"><b id="6">[6]</b></td>
<td class="top">
<a title="BBN Technologies">Kent, S</a> and <a title="BBN Technologies">K Seo</a>, "<a href="http://tools.ietf.org/html/rfc4301">Security Architecture for the Internet Protocol</a>", RFC 4301, December 2005.</td>
</tr>
<tr>
<td class="reference"><b id="7">[7]</b></td>
<td class="top">
<a title="Massachusetts Institute of Technology">Garfinkel, S</a>, "<a>Design Principles and Patterns for Computer Systems That Are Simultaneously Secure and Usable</a>", May 2005.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Peter Gutmann</span> 
	  <span class="n hidden">
		<span class="family-name">Gutmann</span>
	  </span>
	</span>
	<span class="org vcardline">University of Auckland</span>
	<span class="adr">
	  <span>Department of Computer Science</span>

	  <span class="vcardline">
		<span class="locality">University of Auckland</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">New Zealand</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:pgut001@cs.auckland.ac.nz">pgut001@cs.auckland.ac.nz</a></span>

  </address>
</div>

</body>
</html>