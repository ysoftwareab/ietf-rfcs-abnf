<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Support for Sieve in Internet Message Access Protocol (IMAP4)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Support for Sieve in Internet Message Access Protocol (IMAP4)">
<meta name="keywords" content="IMAP, Sieve, email, filtering">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Sieve Working Group</td><td class="header">B. Leiba</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Huawei Technologies</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">January 26, 2010</td></tr>
<tr><td class="header">Expires: July 30, 2010</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Support for Sieve in Internet Message Access Protocol (IMAP4)<br />draft-ietf-sieve-imap-sieve-00</h1>

<h3>Abstract</h3>

<p>
            Sieve defines an email filtering language that can, in
            principle, plug into any point in the processing of an email
            message.  As defined in the base specification, it plugs into
            mail delivery.  This document defines how Sieve can plug into
            points in the IMAP protocol where messages are created or changed,
            adding the option of user-defined or installation-defined
            filtering (or, with Sieve extensions, features such as notifications).
          
</p>
<h3>Note</h3>

<p>
            This document defines extensions to IMAP and Sieve.
            It is the work of the Sieve Working Group, but had previously been in the
            lemonade mailing list, as draft-ietf-lemonade-imap-sieve.
            </p>
<ol class="text">
<li>Discussion of this document should be taken to the Sieve mailing list at
               mailto:sieve@ietf.org
            
</li>
<li>Subscription requests can be sent to
               mailto:sieve@ietf.org?body=subscribe (send an
               email message with the word "subscribe" in the body).
            
</li>
<li>A WWW archive of back messages is available at
               http://www.ietf.org/mail-archive/web/sieve/index.html
            
</li>
<li>Older messages, which were posted to the lemonade mailing list, are archived at
               http://www.ietf.org/mail-archive/web/lemonade/index.html
            
</li>
</ol><p>
          
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on July 30, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#intro">1.</a>&nbsp;
Introduction<br />
<a href="#overview">1.1.</a>&nbsp;
Overview<br />
<a href="#conventions">1.2.</a>&nbsp;
Conventions used in this document<br />
<br />
<a href="#imapspec">2.</a>&nbsp;
The IMAP "IMAPSieve" Extension<br />
<a href="#capability">2.1.</a>&nbsp;
The "IMAPSieve" Capability String<br />
<a href="#oldfunc">2.2.</a>&nbsp;
Existing IMAP Functions Affected by IMAPSieve<br />
<a href="#imapappend">2.2.1.</a>&nbsp;
The IMAP APPEND Command<br />
<a href="#imapmultiappend">2.2.2.</a>&nbsp;
The IMAP MULTIAPPEND Command<br />
<a href="#imapcopy">2.2.3.</a>&nbsp;
The IMAP COPY Command<br />
<a href="#imapflags">2.2.4.</a>&nbsp;
Changes to IMAP Message Flags<br />
<a href="#imapannotate">2.2.5.</a>&nbsp;
New or Changed IMAP Message Annotations<br />
<a href="#newfunc">2.3.</a>&nbsp;
New Functions Defined by IMAPSieve<br />
<a href="#metadata-def">2.3.1.</a>&nbsp;
Changes to Metadata<br />
<br />
<a href="#sieveactions">3.</a>&nbsp;
Applicable Sieve Actions and Interactions<br />
<a href="#action-implicitkeep">3.1.</a>&nbsp;
The Implicit Keep<br />
<a href="#action-keep">3.2.</a>&nbsp;
The Keep Action<br />
<a href="#action-fileinto">3.3.</a>&nbsp;
The Fileinto Action<br />
<a href="#action-redirect">3.4.</a>&nbsp;
The Redirect Action<br />
<a href="#action-reject">3.5.</a>&nbsp;
The Reject Action<br />
<a href="#action-discard">3.6.</a>&nbsp;
The Discard Action<br />
<a href="#action-notify">3.7.</a>&nbsp;
The Notify Action<br />
<a href="#action-addheader">3.8.</a>&nbsp;
The Addheader and Deleteheader Actions<br />
<a href="#action-imapflags">3.9.</a>&nbsp;
The Setflag, Deleteflag, and Removeflag Actions<br />
<a href="#action-vacation">3.10.</a>&nbsp;
The Vacation Action<br />
<a href="#action-spamtest">3.11.</a>&nbsp;
Spamtest<br />
<a href="#env-imapcause">3.12.</a>&nbsp;
New Sieve Environment Item: cause<br />
<a href="#env-imapmailbox">3.13.</a>&nbsp;
New Sieve Environment Item: mailbox<br />
<a href="#env-imapnewflags">3.14.</a>&nbsp;
New Sieve Environment Item: changedflags<br />
<a href="#env-imapnewannotations">3.15.</a>&nbsp;
New Sieve Environment Item: changedannotations<br />
<a href="#tests">3.16.</a>&nbsp;
Interaction With Sieve Tests (Comparisons)<br />
<br />
<a href="#examples">4.</a>&nbsp;
Examples<br />
<br />
<a href="#security">5.</a>&nbsp;
Security Considerations<br />
<br />
<a href="#iana">6.</a>&nbsp;
IANA Considerations<br />
<a href="#iana-1">6.1.</a>&nbsp;
Registration of imapsieve extension<br />
<a href="#iana-2">6.2.</a>&nbsp;
Registration of environment item: cause<br />
<a href="#iana-3">6.3.</a>&nbsp;
Registration of environment item: mailbox<br />
<a href="#iana-4">6.4.</a>&nbsp;
Registration of environment item: changedflags<br />
<a href="#iana-5">6.5.</a>&nbsp;
Registration of environment item: changedannotations<br />
<a href="#iana-6">6.6.</a>&nbsp;
Registration of IMAP METADATA mailbox entry name<br />
<a href="#iana-7">6.7.</a>&nbsp;
Registration of IMAP METADATA server entry name<br />
<br />
<a href="#rfc.references1">7.</a>&nbsp;
References<br />
<a href="#rfc.references1">7.1.</a>&nbsp;
Normative References<br />
<a href="#rfc.references2">7.2.</a>&nbsp;
Non-Normative References<br />
<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<a name="overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
Overview</h3>

<p>
              Some applications have a need to apply <a class='info' href='#Sieve'>[Sieve]<span> (</span><span class='info'>Guenther, P., Ed. and T. Showalter, Ed., &ldquo;Sieve: An Email Filtering Language,&rdquo; January&nbsp;2008.</span><span>)</span></a>
              filters in situations other than initial mail delivery.  This
              is especially true in diverse service environments, such as
              when the client is sporadically connected, is connected through
              a high-latency or high-cost channel, or is on a limited-function
              device.  For such clients, it may be very important, for higher
              performance and reliability, to take advantage of server capabilities,
              including those provided by Sieve filtering (and Sieve extensions,
              such as <a class='info' href='#Notify'>[Notify]<span> (</span><span class='info'>Melnikov, A., Ed., Leiba, B., Ed., Segmuller, W., and T. Martin, &ldquo;Sieve Email Filtering: Extension for Notifications,&rdquo; January&nbsp;2009.</span><span>)</span></a>).
            
</p>
<p>
              This specification defines extensions to <a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol - Version 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a>
              to support the invocation of Sieve scripts at times when the
              IMAP server creates new messages, or modifies existing ones.
              It also defines how Sieve scripts will process these invocations.
              Support for IMAPSieve requires support for <a class='info' href='#Metadata'>[Metadata]<span> (</span><span class='info'>Daboo, C., &ldquo;The IMAP METADATA Extension,&rdquo; February&nbsp;2009.</span><span>)</span></a>
              as well, since the latter is used to associate scripts with IMAP
              mailboxes.
            
</p>
<p>
              <a class='info' href='#comment.anchor1'>[anchor1]<span> (</span><span class='info'>General note: Sieve was designed to work at final delivery, and makes many assumptions about the context.  Will those assumptions break this environment without our realizing it fully?</span><span>)</span></a><a name='anchor1'></a>
            
</p>
<p>
              <a class='info' href='#comment.anchor2'>[anchor2]<span> (</span><span class='info'>Note about identity: We might want to use Sieve to impose fine-grained access controls. In final delivery, there's no identity for the “filer”. Here, there is: the logged-in IMAP user. How do we get at that identity?</span><span>)</span></a><a name='anchor2'></a>
            
</p>
<a name="conventions"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.2"></a><h3>1.2.&nbsp;
Conventions used in this document</h3>

<p>
              The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
              "SHOULD", "SHOULD NOT", "MAY", and "OPTIONAL" in this document are to
              be interpreted as described in <a class='info' href='#Keywds'>[Keywds]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
            
</p>
<a name="imapspec"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
The IMAP "IMAPSieve" Extension</h3>

<a name="capability"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
The "IMAPSieve" Capability String</h3>

<p>
              An IMAP server advertises support for this extension through the
              capability string "IMAPSieve" (the string is not case-sensitive,
              and is shown here with this capitalization for readability).
              A server that advertises IMAPSieve is claiming to be in
              compliance with this specification in all aspects.
            
</p>
<p>
              Implementations that support IMAPSieve MUST also support <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a>,
              because the latter defines an important way for Sieve scripts to test
              the conditions under which they have been invoked.  Notwithstanding this requirement,
              scripts that use IMAPSieve must include BOTH capability strings in their required lists.
            
</p>
<a name="oldfunc"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Existing IMAP Functions Affected by IMAPSieve</h3>

<p>
              The subsections below describe in detail the IMAP commands and
              situations on which IMAPSieve has an effect.
              Not all Sieve actions make sense in the case of messages
              affected by IMAP commands.
              See <a class='info' href='#sieveactions'>Section&nbsp;3<span> (</span><span class='info'>Applicable Sieve Actions and Interactions</span><span>)</span></a> for details.
            
</p>
<p>
              It's important to note that since the base Sieve specification (see <a class='info' href='#Sieve'>[Sieve]<span> (</span><span class='info'>Guenther, P., Ed. and T. Showalter, Ed., &ldquo;Sieve: An Email Filtering Language,&rdquo; January&nbsp;2008.</span><span>)</span></a>)
              and its extensions define functions for scripts that are invoked during
              initial mail delivery, those function definitions are necessarily tailored to
              and limited by that context.  This document extends those function definitions
              for use during IMAP events.  By nature of that, Sieve functions, in this
              extended context, may behave somewhat differently, though their extended
              behaviour will still be consistent with the functions' goals.
            
</p>
<p>
              If more than one message is affected at the same time,
              each message triggers the execution of a Sieve script separately.
              The scripts MAY be run in parallel.
            
</p>
<a name="imapappend"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2.1"></a><h3>2.2.1.&nbsp;
The IMAP APPEND Command</h3>

<p>
                A message may be added to a mailbox through the IMAP APPEND
                command.  In a server that advertises IMAPSieve, new messages
                added in this way MUST trigger the execution of a Sieve script,
                subject to the settings defined through Metadata
                (see <a class='info' href='#metadata-def'>Section&nbsp;2.3.1<span> (</span><span class='info'>Changes to Metadata</span><span>)</span></a>).
              
</p>
<a name="imapmultiappend"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2.2"></a><h3>2.2.2.&nbsp;
The IMAP MULTIAPPEND Command</h3>

<p>
                If the IMAP server supports the IMAP <a class='info' href='#MultiAppend'>[MultiAppend]<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - MULTIAPPEND Extension,&rdquo; March&nbsp;2003.</span><span>)</span></a>
                extension, messages may be added to a mailbox through the IMAP MULTIAPPEND
                command.  In a server that advertises IMAPSieve, new messages
                added in this way MUST trigger the execution of a Sieve script,
                as with the APPEND command, also subject to the settings
                defined through Metadata.
              
</p>
<a name="imapcopy"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2.3"></a><h3>2.2.3.&nbsp;
The IMAP COPY Command</h3>

<p>
                One or more messages may be added to a mailbox through the IMAP COPY
                command.  In a server that advertises IMAPSieve, new messages
                added in this way MUST trigger the execution of a Sieve script,
                subject to the settings defined through Metadata.
              
</p>
<a name="imapflags"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2.4"></a><h3>2.2.4.&nbsp;
Changes to IMAP Message Flags</h3>

<p>
                One or more existing messages can have their flags changed
                in a number of ways, including:
                </p>
<ul class="text">
<li>The FETCH command (may cause the \Seen flag to be set).
</li>
<li>The STORE command (may cause the \Answered, \Deleted,
                    \Draft, \Flagged, and \Seen flags to be set or reset,
                    and may cause keywords to be set or reset).
</li>
<li>The invocation of a Sieve script on an existing message,
                  where the Sieve implementation supports the
                  <a class='info' href='#IMAP4Flags'>[IMAP4Flags]<span> (</span><span class='info'>Melnikov, A., &ldquo;Sieve Mail Filtering Language: IMAP flag Extension,&rdquo; January&nbsp;2008.</span><span>)</span></a> extension
                  and the script uses one of the actions defined in that extension.
                  
</li>
</ul><p>
                In a server that advertises IMAPSieve, messages whose flags
                are changed in any way (except as explained in the next sentence)
                MUST trigger the execution of a Sieve script,
                subject to the settings defined through Metadata.
                The exception is that in order to avoid script loops,
                flag changes that are made as a result of a script that was
                itself invoked because of flag changes SHOULD NOT result in
                another script invocation.  In any case, implementations MUST
                take steps to avoid such loops.
              
</p>
<p>
                For flag-change events, the Sieve script will see the message flags
                as they are AFTER the changes.
              
</p>
<a name="imapannotate"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2.5"></a><h3>2.2.5.&nbsp;
New or Changed IMAP Message Annotations</h3>

<p>
                <a class='info' href='#comment.anchor3'>[anchor3]<span> (</span><span class='info'>Sieve has no way to get the annotations, so is there really value in being told about annotation changes here? Maybe push that into a sieve-annotations extension later.</span><span>)</span></a><a name='anchor3'></a>
              
</p>
<p>
                If the IMAP server supports the <a class='info' href='#Annotate'>[Annotate]<span> (</span><span class='info'>Daboo, C. and R. Gellens, &ldquo;IMAP ANNOTATE Extension,&rdquo; June&nbsp;2008.</span><span>)</span></a> extension,
                one or more existing messages can have annotations added or changed
                through the ANNOTATE command.
                In a server that advertises IMAPSieve, messages getting new or
                changed annotations MUST trigger the execution of a Sieve script,
                subject to the settings defined through Metadata.
              
</p>
<p>
                For annotation-change events, the Sieve script will see the message annotations
                as they are AFTER the changes.
              
</p>
<a name="newfunc"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
New Functions Defined by IMAPSieve</h3>

<a name="metadata-def"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3.1"></a><h3>2.3.1.&nbsp;
Changes to Metadata</h3>

<p>
                Support for IMAPSieve requires support for <a class='info' href='#Metadata'>[Metadata]<span> (</span><span class='info'>Daboo, C., &ldquo;The IMAP METADATA Extension,&rdquo; February&nbsp;2009.</span><span>)</span></a>
                as well, since the latter is used to associate scripts with IMAP
                mailboxes.
              
</p>
<p>
                When an applicable event occurs on an IMAP mailbox, if there is an
                IMAP metadata entry named "/IMAPSieve/Script" for the mailbox, that entry
                is used.  If there is not, but there is an IMAP metadata entry named
                "/IMAPSieve/Script" for the server, that entry is used (providing a way
                to define a global script for all mailboxes on a server).  If neither entry
                exists, then no script will be invoked.
              
</p>
<p>
                If an "/IMAPSieve/Script" metadata entry was selected above,
                the shared value of that metadata name (its "value.shared" attribute) MUST
                be the name of the Sieve script that will be invoked in response to
                the IMAP event OR the name of another metadata entry, the name prefixed
                with "metadata:" (such as "metadata:/IMAPSieve/ScriptContents"), that
                contains the actual script in its value.shared attribute.
                Note that only the value.shared attribute is used; any value.priv
                attributes are ignored.
              
</p>
<p>
                This specifies the mechanism for "activating" a script for
                a given mailbox (or for all mailboxes), but does not specify a
                mechanism for creating, storing, or validating the script.  Implementations
                MAY use <a class='info' href='#Manage'>[Manage]<span> (</span><span class='info'>Melnikov, A., Ed. and T. Martin, &ldquo;A Protocol for Remotely Managing Sieve Scripts,&rdquo; January&nbsp;2009.</span><span>)</span></a> to acomplish this, using the PUTSCRIPT command
                to store the script without using the SETACTIVE command to activate it.
                In any case, the script name that is specified in the /IMAPSieve/Script metadata
                entry is in a form that depends upon how the server handles the storing of
                Sieve scripts.
              
</p>
<p>
                Only one Sieve script may currently be defined per mailbox, eliminating the
                complexity and possible ambiguity involved with coordinating the 
                results of multiple scripts.  Any sub-filtering is done in the 
                Sieve script.  For example, if it's only necessary to deal with
                flag changes, but not with new messages appended or copied, the
                Sieve script will still be invoked for all events, and the script
                is responsible for checking the event type.
              
</p>
<p>
                The possibility is open for an extensions to add support for multiple
                scripts -- for example, per-client scripts on a multi-client user's inbox,
                or per-user scripts on a mailbox that is shared among users.
              
</p>
<p>
                Because this metadata name is associated with the mailbox, 
                there can (and it's expected that there will) be different scripts
                associated with events for different mailboxes.  Indeed, most
                mailboxes will probably invoke no script at all.
              
</p>
<a name="sieveactions"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Applicable Sieve Actions and Interactions</h3>

<p>
            Since some Sieve actions relate specifically to the delivery of
            mail, not all actions make sense when the messages are created
            by other means or when changes are made to data associated with
            existing messages.  This section describes how actions in the base
            Sieve specification, and those in extensions known at this writing,
            relate to this specification.
          
</p>
<p>
            In addition to what is specified here, interactions noted
            in the individual specifications apply, and must be considered.
          
</p>
<a name="action-implicitkeep"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
The Implicit Keep</h3>

<p>
              For all cases that fall under IMAPSieve, the implicit keep
              means that the message is treated as it would have been if no
              Sieve script were run.  For APPEND, MULTIAPPEND and COPY, the
              message is stored into the target mailbox normally.  For flag
              or annotation changes, the message is left in the mailbox.
            
</p>
<a name="action-keep"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
The Keep Action</h3>

<p>
              The keep action is applicable in all cases that fall under IMAPSieve.
              Its behaviour is as described for implicit keep, in <a class='info' href='#action-implicitkeep'>Section&nbsp;3.1<span> (</span><span class='info'>The Implicit Keep</span><span>)</span></a>.
            
</p>
<a name="action-fileinto"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
The Fileinto Action</h3>

<p>
              If the Sieve implementation supports the fileinto action,
              that action is applicable in all cases that fall under IMAPSieve.
              If the <a class='info' href='#Copy'>[Copy]<span> (</span><span class='info'>Degener, J., &ldquo;Sieve Extension: Copying Without Side Effects,&rdquo; October&nbsp;2004.</span><span>)</span></a> extension is available and
              the :copy option is specified, the implicit keep is retained;
              otherwise, fileinto cancels the implicit keep, as specified in
              the base Sieve specification.
            
</p>
<p>
              For APPEND, MULTIAPPEND, and COPY, the message is stored into the
              fileinto mailbox IN ADDITION TO the original target mailbox.  For flag
              or annotation changes, the message is COPIED into the fileinto mailbox,
              without removing the original.
            
</p>
<p>
              If a keep action is NOT also in effect,
              the original message is then marked with the \Deleted
              flag (and a flag-change Sieve script is NOT invoked).
              The implementation MAY then expunge the original message
              (WITHOUT expunging other messages in the mailbox),
              or it MAY choose to have expunges batched, or done by a user.
              If the server does the expunge, the effect is as though a client had flagged the message and done
              a UID EXPUNGE (see <a class='info' href='#UIDPlus'>[UIDPlus]<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - UIDPLUS Extension,&rdquo; December&nbsp;2005.</span><span>)</span></a>) on the affected message(s) only.
              Handling it this way
              allows clients to handle messages consistently, and avoids hidden
              changes that might invalidate their message caches.
            
</p>
<a name="action-redirect"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
The Redirect Action</h3>

<p>
              <a class='info' href='#comment.anchor4'>[anchor4]<span> (</span><span class='info'>Redirect assumes message can be submitted as is – not a valid assumption in this context.  What do we do if the decision is “redirect” and there's not enough information to do it?  Also, some have been concerned about, say, a flag change that has the Sieve effect of forwarding the message somewhere. Perhaps we should just forbid redirect.</span><span>)</span></a><a name='anchor4'></a>
            
</p>
<p>
              The redirect action is applicable in all cases that fall under IMAPSieve.
              It causes the message to be sent, as specified in the base Sieve
              specification, to the designated address.
              If the <a class='info' href='#Copy'>[Copy]<span> (</span><span class='info'>Degener, J., &ldquo;Sieve Extension: Copying Without Side Effects,&rdquo; October&nbsp;2004.</span><span>)</span></a> extension is available and
              the :copy option is specified, the implicit keep is retained;
              otherwise, redirect cancels the implicit keep, as specified in
              the base Sieve specification.
            
</p>
<p>
              For APPEND, MULTIAPPEND, and COPY, the message is stored into
              the target mailbox in addition to being redirected.  For flag
              or annotation changes, the message remains in its original mailbox.
            
</p>
<p>
              If a keep action is NOT also in effect,
              the original message is then marked with the \Deleted
              flag (and a flag-change Sieve script is NOT invoked).
              The implementation MAY then expunge the original message
              (WITHOUT expunging other messages in the mailbox),
              or it MAY choose to have expunges batched, or done by a user.
              If the server does the expunge, the effect is as though a client had flagged the message and done
              a UID EXPUNGE (see <a class='info' href='#UIDPlus'>[UIDPlus]<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - UIDPLUS Extension,&rdquo; December&nbsp;2005.</span><span>)</span></a>) on the affected message(s) only.
              Handling it this way
              allows clients to handle messages consistently, and avoids hidden
              changes that might invalidate their message caches.
            
</p>
<a name="action-reject"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5"></a><h3>3.5.&nbsp;
The Reject Action</h3>

<p>
              The reject action is NOT applicable to any case that falls under IMAPSieve.
              Its use MUST result in an error condition that will terminate the Sieve script.
            
</p>
<a name="action-discard"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.6"></a><h3>3.6.&nbsp;
The Discard Action</h3>

<p>
              The discard action is applicable in all cases that fall under IMAPSieve.
              For APPEND, MULTIAPPEND, and COPY, the message is first stored
              into the target mailbox.
              If an explicit keep action is also in effect,
              the discard action now does nothing.  Otherwise,
              the original message is then marked with the \Deleted
              flag (and a flag-change Sieve script is NOT invoked).
              The implementation MAY then expunge the original message
              (WITHOUT expunging other messages in the mailbox),
              or it MAY choose to have expunges batched, or done by a user.
              If the server does the expunge, the effect is as though a client had flagged the message and done
              a UID EXPUNGE (see <a class='info' href='#UIDPlus'>[UIDPlus]<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol (IMAP) - UIDPLUS Extension,&rdquo; December&nbsp;2005.</span><span>)</span></a>) on the affected message(s) only.
              Handling it this way
              allows clients to handle messages consistently, and avoids hidden
              changes that might invalidate their message caches.
            
</p>
<a name="action-notify"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.7"></a><h3>3.7.&nbsp;
The Notify Action</h3>

<p>
              If the <a class='info' href='#Notify'>[Notify]<span> (</span><span class='info'>Melnikov, A., Ed., Leiba, B., Ed., Segmuller, W., and T. Martin, &ldquo;Sieve Email Filtering: Extension for Notifications,&rdquo; January&nbsp;2009.</span><span>)</span></a> extension is available, the
              notify action is applicable in all cases that fall under IMAPSieve.
              The result is that the requested notification is sent, and that
              the message is otherwise handled as it would normally have been.
            
</p>
<a name="action-addheader"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.8"></a><h3>3.8.&nbsp;
The Addheader and Deleteheader Actions</h3>

<p>
              <a class='info' href='#comment.anchor5'>[anchor5]<span> (</span><span class='info'>Should editheader be allowed to change header fields that aren't saved in place, such as for redirect or fileinto?  Editheader would still have to be banned for “keep”, but not otherwise.</span><span>)</span></a><a name='anchor5'></a>
            
</p>
<p>
              Even if the <a class='info' href='#EditHeader'>[EditHeader]<span> (</span><span class='info'>Degener, J. and P. Guenther, &ldquo;Sieve Email Filtering: Editheader Extension,&rdquo; August&nbsp;2008.</span><span>)</span></a> extension is available,
              since messages in IMAP mailboxes are immutable these actions
              are NOT applicable.  
              Use of these MUST result in an error condition that will terminate the Sieve script.
              Explanation:  Using them for flag or annotation changes
              to existing messages would cause the message to be changed.
              Using them for APPEND, MULTIAPPEND, and COPY would cause unexpected
              differences in the stored copy as compared to what the client
              expected, and would make the client's message cache invalid unexpectedly.
            
</p>
<a name="action-imapflags"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.9"></a><h3>3.9.&nbsp;
The Setflag, Deleteflag, and Removeflag Actions</h3>

<p>
                <a class='info' href='#comment.anchor6'>[anchor6]<span> (</span><span class='info'>Should this just require imap4flags?  Some implementors have said they wouldn't bother with it without the ability to manipulate flags. And what values of flags does it see -- before or after the change? If it changes them, can it see the originals? Can it reset changes?</span><span>)</span></a><a name='anchor6'></a>
              
</p>
<p>
              If the <a class='info' href='#IMAP4Flags'>[IMAP4Flags]<span> (</span><span class='info'>Melnikov, A., &ldquo;Sieve Mail Filtering Language: IMAP flag Extension,&rdquo; January&nbsp;2008.</span><span>)</span></a> extension is available,
              the actions associated with it are all applicable to any case that falls under IMAPSieve.
              It is worth noting also that the "hasflag" test that is defined in
              the IMAP4Flags extension might be particularly useful in scripts triggered
              by flag changes ("hasflag" will see the new, changed flags).
              The flag changes behave as though a client had
              made the change.
            
</p>
<p>
              As explained above, in order to avoid script loops
              flag changes that are made as a result of a script that was
              itself invoked because of flag changes SHOULD NOT result in
              another script invocation.  In any case, implementations MUST
              take steps to avoid such loops.
            
</p>
<a name="action-vacation"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.10"></a><h3>3.10.&nbsp;
The Vacation Action</h3>

<p>
              Even if the <a class='info' href='#Vacation'>[Vacation]<span> (</span><span class='info'>Showalter, T. and N. Freed, Ed., &ldquo;Sieve Email Filtering:  Vacation Extension,&rdquo; January&nbsp;2008.</span><span>)</span></a> extension is available,
              the vacation action is NOT applicable to any case that falls under IMAPSieve.
              Its use MUST result in an error condition that will terminate the Sieve script.
            
</p>
<a name="action-spamtest"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.11"></a><h3>3.11.&nbsp;
Spamtest</h3>

<p>
              <a class='info' href='#Spamtest'>[Spamtest]<span> (</span><span class='info'>Daboo, C., &ldquo;Sieve Email Filtering: Spamtest and Virustest Extensions,&rdquo; January&nbsp;2008.</span><span>)</span></a>
              <a class='info' href='#comment.anchor7'>[anchor7]<span> (</span><span class='info'>We need to say something about the spamtest/virustest extension.  We need to be able to scan appended messages. And we can't use headers to communicate spam status, because the message is immutable.  What should we say here?</span><span>)</span></a><a name='anchor7'></a>
            
</p>
<a name="env-imapcause"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.12"></a><h3>3.12.&nbsp;
New Sieve Environment Item: cause</h3>

<p>
              Implementations MAY invoke different Sieve scripts for the different
              conditions described in this document (append, copy, flag changes,
              annotation changes).  If the actions to be taken are common, and the
              implementation supports the <a class='info' href='#Include'>[Include]<span> (</span><span class='info'>Daboo, C. and A. Stone, &ldquo;SIEVE Email Filtering: Include Extension,&rdquo; July&nbsp;2009.</span><span>)</span></a> extension,
              the common script code can be included as specified there.
            
</p>
<p>
              It may be preferable, though, to use a single script for all these
              conditions.  To support that, the implementation MUST set the <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a> item
              "cause", which contains the name of the
              action that caused the script to be invoked.  Its value is one of
              the following:
              </p>
<ul class="text">
<li>APPEND (for invocations resulting from APPEND or MULTIAPPEND)
</li>
<li>COPY (for invocations resulting from COPY)
</li>
<li>FLAG (for invocations resulting from flag changes)
</li>
<li>ANNOTATE (for invocations resulting from new or changed annotations)
</li>
</ul><p>
            
</p>
<a name="env-imapmailbox"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.13"></a><h3>3.13.&nbsp;
New Sieve Environment Item: mailbox</h3>

<p>
              The implementation MUST set the <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a> item
              "mailbox" to the name of the mailbox that
              the affected message is in, in the case of existing messages, or
              is targeted to be stored into, in the case of new messages.
              The value of this item is fixed when the script begins, and,
              in particular, MUST NOT change as a result of any action, such as
              "fileinto".
            
</p>
<a name="env-imapnewflags"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.14"></a><h3>3.14.&nbsp;
New Sieve Environment Item: changedflags</h3>

<p>
              If the <a class='info' href='#IMAP4Flags'>[IMAP4Flags]<span> (</span><span class='info'>Melnikov, A., &ldquo;Sieve Mail Filtering Language: IMAP flag Extension,&rdquo; January&nbsp;2008.</span><span>)</span></a> extension is available,
              AND the script was invoked because of flag changes to an existing message,
              the implementation MUST set the <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a> item
              "changedflags" to the name(s) of the flag(s) that have changed.
              If the script was not invoked because of flag changes, the value of this item
              MUST be the empty string.  The script will not know from this item
              whether the flags have been set or reset, but it can use the "hasflag"
              test to determine the current value.  See example 2 in <a class='info' href='#examples'>Section&nbsp;4<span> (</span><span class='info'>Examples</span><span>)</span></a>
              for an example of how this might be used.
            
</p>
<a name="env-imapnewannotations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.15"></a><h3>3.15.&nbsp;
New Sieve Environment Item: changedannotations</h3>

<p>
              If the <a class='info' href='#Annotate'>[Annotate]<span> (</span><span class='info'>Daboo, C. and R. Gellens, &ldquo;IMAP ANNOTATE Extension,&rdquo; June&nbsp;2008.</span><span>)</span></a> extension is available,
              AND the script was invoked because of annotation changes to an existing message,
              the implementation MUST set the <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a> item
              "changedannotations" to the name(s) of the annotation(s) that have changed.
              If the script was not invoked because of annotation changes, the value of this item
              MUST be the empty string.  
            
</p>
<a name="tests"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.16"></a><h3>3.16.&nbsp;
Interaction With Sieve Tests (Comparisons)</h3>

<p>
              This extension does not affect the operation of any tests or comparisons.
            
</p>
<a name="examples"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Examples</h3>

<p>
            Example 1:<br />

            If a new message is added to the "ActionItems" mailbox, a
            copy is sent to the address "actionitems@example.com".
            </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  require ["copy", "environment"];

  if anyof (environment :is "cause" "APPEND",
            environment :is "cause" "COPY")  {
      if environment :is "mailbox" "ActionItems" {
          redirect :copy "actionitems@example.com";
      }
  }
</pre></div><p>

          
</p>
<p>
            Example 2:<br />

            If the script is called for any message with the \Flagged
            flag set (tested through the <a class='info' href='#IMAP4Flags'>[IMAP4Flags]<span> (</span><span class='info'>Melnikov, A., &ldquo;Sieve Mail Filtering Language: IMAP flag Extension,&rdquo; January&nbsp;2008.</span><span>)</span></a> extension),
            a notification is sent using the <a class='info' href='#Notify'>[Notify]<span> (</span><span class='info'>Melnikov, A., Ed., Leiba, B., Ed., Segmuller, W., and T. Martin, &ldquo;Sieve Email Filtering: Extension for Notifications,&rdquo; January&nbsp;2009.</span><span>)</span></a> extension.
            No notification will be sent, though, if we're called with an
            existing message that already had that flag set.
            </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  require ["notify", "imap4flags", "variables", "environment"];

  if environment :matches "mailbox" "*" {
      set "mailbox" "${1}";
  }

  if allof (hasflag "\\Flagged",
            not environment :contains "changedflags" "\\Flagged") {
      notify :message "Important message in ${mailbox}";
  }
</pre></div><p>

          
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Security Considerations</h3>

<p>
            It is possible to introduce script processing loops by having
            a Sieve script that is triggered by flag changes use the actions
            defined in the <a class='info' href='#IMAP4Flags'>[IMAP4Flags]<span> (</span><span class='info'>Melnikov, A., &ldquo;Sieve Mail Filtering Language: IMAP flag Extension,&rdquo; January&nbsp;2008.</span><span>)</span></a> extension.
            Implementations MUST take steps to prevent such loops.
            One way to avoid this problem is that if a script
            is invoked by flag changes, and that script further changes
            the flags, those flag changes SHOULD NOT trigger a Sieve script
            invocation.
          
</p>
<p>
            Other security considerations are discussed in 
            <a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;Internet Message Access Protocol - Version 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a>, and <a class='info' href='#Sieve'>[Sieve]<span> (</span><span class='info'>Guenther, P., Ed. and T. Showalter, Ed., &ldquo;Sieve: An Email Filtering Language,&rdquo; January&nbsp;2008.</span><span>)</span></a>,
            as well as in some of the other extension documents.
          
</p>
<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
IANA Considerations</h3>

<a name="iana-1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Registration of imapsieve extension</h3>

<p>
              The following template specifies the IANA registration of the
              Sieve extension specified in this document:
            
</p>
<p>
              To: iana@iana.org
              <br />

              Subject: Registration of new Sieve extension
              <br />

              Capability name: imapsieve
              <br />

              Description: Add Sieve processing for IMAP events. 
              
              <br />

              RFC number: this RFC
              <br />

              Contact address: Barry Leiba &lt;barryleiba@computer.org&gt;
            
</p>
<p>
              This information should be added to the list of sieve extensions
              given on http://www.iana.org/assignments/sieve-extensions.
            
</p>
<a name="iana-2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Registration of environment item: cause</h3>

<p>
              The following template specifies the IANA registration of a
              sieve environment item specified in this document:
            
</p>
<p>
              To: iana@iana.org
              <br />

              Subject: Registration of new Sieve environment item
              <br />

              Item name: cause
              <br />

              Description: 
              The name of the action that caused the script to be invoked.
              Its value is one of the following:
              </p>
<ul class="text">
<li>APPEND (for invocations resulting from APPEND or MULTIAPPEND)
</li>
<li>COPY (for invocations resulting from COPY)
</li>
<li>FLAG (for invocations resulting from flag changes)
</li>
<li>ANNOTATE (for invocations resulting from new or changed annotations)
</li>
</ul><p>
              <br />

              RFC number: this RFC
              <br />

              Contact address:
              <br />

              &nbsp; &nbsp; Barry Leiba &lt;barryleiba@computer.org&gt;
            
</p>
<p>
              This information should be added to the list of sieve environment
              item names given in the <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a> extension.
            
</p>
<a name="iana-3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Registration of environment item: mailbox</h3>

<p>
              The following template specifies the IANA registration of a
              sieve environment item specified in this document:
            
</p>
<p>
              To: iana@iana.org
              <br />

              Subject: Registration of new Sieve environment item
              <br />

              Item name: mailbox
              <br />

              Description: 
              The name of the mailbox that
              the affected message is in, in the case of existing messages, or
              is targeted to be stored into, in the case of new messages.
              The value of this item is fixed when the script begins, and,
              in particular, MUST NOT change as a result of any action, such as
              "fileinto".
              <br />

              RFC number: this RFC
              <br />

              Contact address:
              <br />

              &nbsp; &nbsp; Barry Leiba &lt;barryleiba@computer.org&gt;
            
</p>
<p>
              This information should be added to the list of sieve environment
              item names given in the <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a> extension.
            
</p>
<a name="iana-4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
Registration of environment item: changedflags</h3>

<p>
              The following template specifies the IANA registration of a
              sieve environment item specified in this document:
            
</p>
<p>
              To: iana@iana.org
              <br />

              Subject: Registration of new Sieve environment item
              <br />

              Item name: changedflags
              <br />

              Description: 
              If the script was invoked because of flag changes to an existing message,
              this contains the name(s) of the flag(s) that have changed.
              Otherwise, the value of this item MUST be the empty string.
              <br />

              RFC number: this RFC
              <br />

              Contact address:
              <br />

              &nbsp; &nbsp; Barry Leiba &lt;barryleiba@computer.org&gt;
            
</p>
<p>
              This information should be added to the list of sieve environment
              item names given in the <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a> extension.
            
</p>
<a name="iana-5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.5"></a><h3>6.5.&nbsp;
Registration of environment item: changedannotations</h3>

<p>
              The following template specifies the IANA registration of a
              sieve environment item specified in this document:
            
</p>
<p>
              To: iana@iana.org
              <br />

              Subject: Registration of new Sieve environment item
              <br />

              Item name: changedannotations
              <br />

              Description: 
              If the script was invoked because of annotation changes to an existing message,
              this contains the name(s) of the annotation(s) that have changed.
              Otherwise, the value of this item MUST be the empty string.  
              <br />

              RFC number: this RFC
              <br />

              Contact address:
              <br />

              &nbsp; &nbsp; Barry Leiba &lt;barryleiba@computer.org&gt;
            
</p>
<p>
              This information should be added to the list of sieve environment
              item names given in the <a class='info' href='#Environment'>[Environment]<span> (</span><span class='info'>Freed, N., &ldquo;Sieve Email Filtering: Environment Extension,&rdquo; May&nbsp;2008.</span><span>)</span></a> extension.
            
</p>
<a name="iana-6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.6"></a><h3>6.6.&nbsp;
Registration of IMAP METADATA mailbox entry name</h3>

<p>
              The following template specifies the IANA registration of an
              IMAP METADATA entry name specified in this document:
            
</p>
<p>
              To: iana@iana.org
              <br />

              Subject: IMAP METADATA Registration
              <br />

              Please register the following IMAP METADATA item:
              <br />

              [x] Entry &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ ] Attribute
              <br />

              [x] Mailbox &nbsp; &nbsp; &nbsp; &nbsp; [ ] Server
              <br />

              Name: /IMAPSieve/Script
              <br />

              Description: 
              This entry name is used to define mailbox metadata associated
              with IMAPSieve events for the associated mailbox.  Specifically,
              this specifies the Sieve script that will be invoked when IMAP events
              occur on the specified mailbox.
              <br />

              Content-type: text/plain; charset=utf-8
              <br />

              RFC number: this RFC
              <br />

              Contact person: Barry Leiba
              <br />

              Contact email: barryleiba@computer.org
            
</p>
<p>
              This information should be added to the list of IMAP METADATA
              item names given in the <a class='info' href='#Metadata'>[Metadata]<span> (</span><span class='info'>Daboo, C., &ldquo;The IMAP METADATA Extension,&rdquo; February&nbsp;2009.</span><span>)</span></a> extension.
            
</p>
<a name="iana-7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.7"></a><h3>6.7.&nbsp;
Registration of IMAP METADATA server entry name</h3>

<p>
              The following template specifies the IANA registration of an
              IMAP METADATA entry name specified in this document:
            
</p>
<p>
              To: iana@iana.org
              <br />

              Subject: IMAP METADATA Registration
              <br />

              Please register the following IMAP METADATA item:
              <br />

              [x] Entry &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ ] Attribute
              <br />

              [ ] Mailbox &nbsp; &nbsp; &nbsp; &nbsp; [x] Server
              <br />

              Name: /IMAPSieve/Script
              <br />

              Description: 
              This entry name is used to define metadata associated globally
              with IMAPSieve events for the associated server.  Specifically,
              this specifies the Sieve script that will be invoked when IMAP events
              occur on any mailbox in the server that does not have its own mailbox-level
              /IMAPSieve/Script entry.
              <br />

              Content-type: text/plain; charset=utf-8
              <br />

              RFC number: this RFC
              <br />

              Contact person: Barry Leiba
              <br />

              Contact email: barryleiba@computer.org
            
</p>
<p>
              This information should be added to the list of IMAP METADATA
              item names given in the <a class='info' href='#Metadata'>[Metadata]<span> (</span><span class='info'>Daboo, C., &ldquo;The IMAP METADATA Extension,&rdquo; February&nbsp;2009.</span><span>)</span></a> extension.
            
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>7.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="Annotate">[Annotate]</a></td>
<td class="author-text">Daboo, C. and R. Gellens, &ldquo;<a href="http://tools.ietf.org/html/rfc5257">IMAP ANNOTATE Extension</a>,&rdquo; RFC&nbsp;5257, June&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="Copy">[Copy]</a></td>
<td class="author-text">Degener, J., &ldquo;<a href="http://tools.ietf.org/html/rfc3894">Sieve Extension: Copying Without Side Effects</a>,&rdquo; RFC&nbsp;3894, October&nbsp;2004.</td></tr>
<tr><td class="author-text" valign="top"><a name="Environment">[Environment]</a></td>
<td class="author-text">Freed, N., &ldquo;<a href="http://tools.ietf.org/html/rfc5183">Sieve Email Filtering: Environment Extension</a>,&rdquo; RFC&nbsp;5183, May&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="IMAP">[IMAP]</a></td>
<td class="author-text">Crispin, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3501">Internet Message Access Protocol - Version 4rev1</a>,&rdquo; RFC&nbsp;3501, March&nbsp;2003.</td></tr>
<tr><td class="author-text" valign="top"><a name="IMAP4Flags">[IMAP4Flags]</a></td>
<td class="author-text">Melnikov, A., &ldquo;<a href="http://tools.ietf.org/html/rfc5232">Sieve Mail Filtering Language: IMAP flag Extension</a>,&rdquo; RFC&nbsp;5232, January&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="Keywds">[Keywds]</a></td>
<td class="author-text">Bradner, S., &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; RFC&nbsp;2119, March&nbsp;1997.</td></tr>
<tr><td class="author-text" valign="top"><a name="Metadata">[Metadata]</a></td>
<td class="author-text">Daboo, C., &ldquo;<a href="http://tools.ietf.org/html/rfc5464">The IMAP METADATA Extension</a>,&rdquo; RFC&nbsp;5464, February&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="MultiAppend">[MultiAppend]</a></td>
<td class="author-text">Crispin, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3502">Internet Message Access Protocol (IMAP) - MULTIAPPEND Extension</a>,&rdquo; RFC&nbsp;3502, March&nbsp;2003.</td></tr>
<tr><td class="author-text" valign="top"><a name="Sieve">[Sieve]</a></td>
<td class="author-text">Guenther, P., Ed. and T. Showalter, Ed., &ldquo;<a href="http://tools.ietf.org/html/rfc5228">Sieve: An Email Filtering Language</a>,&rdquo; RFC&nbsp;5228, January&nbsp;2008.</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>7.2.&nbsp;Non-Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="EditHeader">[EditHeader]</a></td>
<td class="author-text">Degener, J. and P. Guenther, &ldquo;<a href="http://tools.ietf.org/html/rfc5293">Sieve Email Filtering: Editheader Extension</a>,&rdquo; RFC&nbsp;5293, August&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="Include">[Include]</a></td>
<td class="author-text">Daboo, C. and A. Stone, &ldquo;SIEVE Email Filtering: Include Extension,&rdquo; work in progress,&nbsp;http://tools.ietf.org/html/draft-ietf-sieve-include, July&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="Manage">[Manage]</a></td>
<td class="author-text">Melnikov, A., Ed. and T. Martin, &ldquo;A Protocol for Remotely Managing Sieve Scripts,&rdquo; RFC editor queue,&nbsp;http://tools.ietf.org/html/draft-ietf-sieve-managesieve, January&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="Notify">[Notify]</a></td>
<td class="author-text">Melnikov, A., Ed., Leiba, B., Ed., Segmuller, W., and T. Martin, &ldquo;<a href="http://tools.ietf.org/html/rfc5435">Sieve Email Filtering: Extension for Notifications</a>,&rdquo; RFC&nbsp;5435, January&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="Spamtest">[Spamtest]</a></td>
<td class="author-text">Daboo, C., &ldquo;<a href="http://tools.ietf.org/html/rfc5235">Sieve Email Filtering: Spamtest and Virustest Extensions</a>,&rdquo; RFC&nbsp;5235, January&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="UIDPlus">[UIDPlus]</a></td>
<td class="author-text">Crispin, M., &ldquo;<a href="http://tools.ietf.org/html/rfc4315">Internet Message Access Protocol (IMAP) - UIDPLUS Extension</a>,&rdquo; RFC&nbsp;4315, December&nbsp;2005.</td></tr>
<tr><td class="author-text" valign="top"><a name="Vacation">[Vacation]</a></td>
<td class="author-text">Showalter, T. and N. Freed, Ed., &ldquo;<a href="http://tools.ietf.org/html/rfc5230">Sieve Email Filtering:  Vacation Extension</a>,&rdquo; RFC&nbsp;5230, January&nbsp;2008.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Barry Leiba</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Huawei Technologies</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 646 827 0648</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:barryleiba@computer.org">barryleiba@computer.org</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://internetmessagingtechnology.org/">http://internetmessagingtechnology.org/</a></td></tr>
</table>
</body></html>
