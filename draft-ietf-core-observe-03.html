<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Observing Resources in CoAP</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Background">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Protocol Overview">
<link href="#rfc.section.1.3" rel="Chapter" title="1.3 Design Philosophy">
<link href="#rfc.section.1.4" rel="Chapter" title="1.4 Conformance Requirements">
<link href="#rfc.section.2" rel="Chapter" title="2 Options">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Observe">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 Max-OFE">
<link href="#rfc.section.3" rel="Chapter" title="3 Client-side Requirements">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Request">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Notifications">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Caching">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Reordering">
<link href="#rfc.section.4" rel="Chapter" title="4 Server-side Requirements">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Request">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Notifications">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Caching">
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 Reordering">
<link href="#rfc.section.4.5" rel="Chapter" title="4.5 Retransmission">
<link href="#rfc.section.5" rel="Chapter" title="5 Intermediaries">
<link href="#rfc.section.6" rel="Chapter" title="6 Block-wise Transfers">
<link href="#rfc.section.7" rel="Chapter" title="7 Discovery">
<link href="#rfc.section.8" rel="Chapter" title="8 Security Considerations">
<link href="#rfc.section.9" rel="Chapter" title="9 IANA Considerations">
<link href="#rfc.section.10" rel="Chapter" title="10 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="11 References">
<link href="#rfc.references.1" rel="Chapter" title="11.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="11.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Examples">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 Proxying">
<link href="#rfc.appendix.Appendix%20A.2" rel="Chapter" title="Appendix A.2 Block-wise Transfer">
<link href="#rfc.appendix.Appendix%20B" rel="Chapter" title="Appendix B Modeling Resources to Tailor Notifications">
<link href="#rfc.appendix.Appendix%20C" rel="Chapter" title="Appendix C Changelog">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="CoAP is a RESTful application protocol for constrained nodes and networks. The state of a resource on a CoAP server can change over time. This document specifies a simple protocol extension for CoAP that gives clients the ability to observe such changes." />
  <meta name="description" content="CoAP is a RESTful application protocol for constrained nodes and networks. The state of a resource on a CoAP server can change over time. This document specifies a simple protocol extension for CoAP that gives clients the ability to observe such changes." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">CoRE Working Group</td>
<td class="right">K. Hartke</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Universitaet Bremen TZI</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">Z. Shelby, Ed.</td>
</tr>
<tr>
<td class="left">Expires: May 03, 2012</td>
<td class="right">Sensinode</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">October 31, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Observing Resources in CoAP<br />
  <span class="filename">draft-ietf-core-observe-03</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>CoAP is a RESTful application protocol for constrained nodes and networks. The state of a resource on a CoAP server can change over time. This document specifies a simple protocol extension for CoAP that gives clients the ability to observe such changes.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on May 03, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Background</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">Protocol Overview</a>
</li>
<li>1.3.   <a href="#rfc.section.1.3">Design Philosophy</a>
</li>
<li>1.4.   <a href="#rfc.section.1.4">Conformance Requirements</a>
</li>
<li>2.   <a href="#rfc.section.2">Options</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">Observe</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">Max-OFE</a>
</li>
<li>3.   <a href="#rfc.section.3">Client-side Requirements</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Request</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Notifications</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Caching</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Reordering</a>
</li>
<li>4.   <a href="#rfc.section.4">Server-side Requirements</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Request</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Notifications</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Caching</a>
</li>
<li>4.4.   <a href="#rfc.section.4.4">Reordering</a>
</li>
<li>4.5.   <a href="#rfc.section.4.5">Retransmission</a>
</li>
<li>5.   <a href="#rfc.section.5">Intermediaries</a>
</li>
<li>6.   <a href="#rfc.section.6">Block-wise Transfers</a>
</li>
<li>7.   <a href="#rfc.section.7">Discovery</a>
</li>
<li>8.   <a href="#rfc.section.8">Security Considerations</a>
</li>
<li>9.   <a href="#rfc.section.9">IANA Considerations</a>
</li>
<li>10.   <a href="#rfc.section.10">Acknowledgements</a>
</li>
<li>11.   <a href="#rfc.references">References</a>
</li>
<li>11.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>11.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Examples</a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">Proxying</a>
</li>
<li>Appendix A.2.   <a href="#rfc.appendix.Appendix%20A.2">Block-wise Transfer</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.Appendix%20B">Modeling Resources to Tailor Notifications</a>
</li>
<li>Appendix C.   <a href="#rfc.appendix.Appendix%20C">Changelog</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#background" id="background">Background</a>
</h1>
<p><a href="#I-D.ietf-core-coap">CoAP</a> <cite title="NONE">[I-D.ietf-core-coap]</cite> is an Application Protocol for Constrained Nodes/Networks. It is intended to provide <a href="#REST">RESTful services</a> <cite title="NONE">[REST]</cite> not unlike <a href="#RFC2616">HTTP</a> <cite title="NONE">[RFC2616]</cite> while reducing the complexity of implementation as well as the size of packets exchanged in order to make these services useful in a highly constrained network of themselves highly constrained nodes.</p>
<p id="rfc.section.1.1.p.2">The communication model of REST is that of a client exchanging resource representations with an origin server. The origin server is the definitive source for representations of the resources in its namespace. A client interested in a resource sends a request to the origin server that returns a response with a representation that is current at the time of the request.</p>
<p id="rfc.section.1.1.p.3">This model does not work well when a client is interested in having a current representation of a resource over a period of time.  Existing approaches from the HTTP world, such as repeated polling or <a href="#RFC6202">long-polls</a> <cite title="NONE">[RFC6202]</cite>, generate significant complexity and/or overhead and thus are less applicable in the constrained CoAP world.</p>
<p id="rfc.section.1.1.p.4">The protocol specified in this document extends the CoAP core protocol with a mechanism to push resource representations from servers to interested clients, while still keeping the properties of REST.</p>
<p id="rfc.section.1.1.p.5">Note that there is no intention for this mechanism to solve the full set of problems that the existing HTTP solutions solve, to replace publish/subscribe networks that solve a much more general problem <a href="#RFC5989">[RFC5989]</a>, or to enable general two-way communication between clients and servers <a href="#I-D.ietf-hybi-thewebsocketprotocol">[I-D.ietf-hybi-thewebsocketprotocol]</a>.</p>
<h1 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> <a href="#overview" id="overview">Protocol Overview</a>
</h1>
<p id="rfc.section.1.2.p.1">The protocol is based on the well-known <a href="#GOF">observer design pattern</a> <cite title="NONE">[GOF]</cite>.</p>
<p id="rfc.section.1.2.p.2">In this design pattern, components, called <em>observers</em>, register at a specific, known provider, called the <em>subject</em>, that they are interested in being notified whenever the subject undergoes a change in state. The subject is responsible for administering its list of registered observers. If multiple subjects are of interest, an observer must register separately for all of them. The pattern is typically used when a clean separation between related components is required, such as data storage and user interface.</p>
<div id="#rfc.figure.1"></div>
<div id="#design-pattern"></div>
<pre>
Observer           Subject
   |                  |
   |     Register     |
   +-----------------&gt;|
   |                  |
   |   Notification   |
   |&lt;-----------------+
   |                  |
   |   Notification   |
   |&lt;-----------------+
   |                  |
   |   Notification   |
   |&lt;-----------------+
   |                  |
</pre>
<p id="rfc.section.1.2.p.3">The observer design pattern is realized in CoAP as follows: </p>

<dl>
<dt>Subject:</dt>
<dd style="margin-left: 8">In the context of CoAP, the subject is a resource in the namespace of a CoAP server. The state of the resource can change over time, ranging from infrequent updates to continuous state transformations.</dd>
<dt>Observer:</dt>
<dd style="margin-left: 8">An observer is a CoAP client that is interested in the current state of the resource at any given time.</dd>
<dt>Registration:</dt>
<dd style="margin-left: 8">A client registers its interest by sending an extended GET request to the server. In addition to returning a representation of the target resource, this request causes the server to add the client to the list of observers of the resource.</dd>
<dt>Notification:</dt>
<dd style="margin-left: 8">Whenever the state of a resource changes, the server notifies each client registered as observer for the resource. Each notification is an additional CoAP response sent by the server in reply to the GET request and includes a complete representation of the new resource state.</dd>
</dl>

<p> </p>
<p><a href="#example">Figure 2</a> shows an example of a CoAP client registering and receiving three notifications: the first upon registration and then two when the state of the resource changes.  Registration request and notifications are identified by the presence of the Observe Option defined in this document. Notifications also echo the token specified by the client in the request, so the client can easily correlate them to the request.</p>
<div id="#rfc.figure.2"></div>
<div id="#example"></div>
<pre>
Client              Server
   |                  |
   | GET /temperature |
   |  Observe: 0      |  (registration)
   |    Token: 0x4a   |
   +-----------------&gt;|
   |                  |
   |   2.05 Content   |
   |  Observe: 12     |  (notification of the current state)
   |    Token: 0x4a   |
   |  Payload: 22.9 C |
   |&lt;-----------------+
   |                  |
   |   2.05 Content   |
   |  Observe: 44     |  (notification upon a state change)
   |    Token: 0x4a   |
   |  Payload: 22.8 C |
   |&lt;-----------------+
   |                  |
   |   2.05 Content   |
   |  Observe: 60     |  (notification upon a state change)
   |    Token: 0x4a   |
   |  Payload: 23.1 C |
   |&lt;-----------------+
   |                  |
</pre>
<p id="rfc.section.1.2.p.5">The client is removed from the list of observers when it is no longer interested in the observed resource. The server can determine the client's continued interest from the client's acknowledgement of confirmable notifications. If a client wants to receive notifications after it has been removed from the list of observers, it needs to register again. The client can determine that it's still on the list of observers from the fact that it receives notifications. The protocol includes clear rules for what to do when a client does not receive a notification for some time, or a server does not receive acknowledgements.</p>
<h1 id="rfc.section.1.3">
<a href="#rfc.section.1.3">1.3.</a> <a href="#design-philosophy" id="design-philosophy">Design Philosophy</a>
</h1>
<p id="rfc.section.1.3.p.1">The protocol builds on the architectural elements of REST: a server that is responsible for the state and representation of the resources in its namespace, a client that is responsible for keeping the application state, and the stateless exchange of resource representations. (A server needs to keep track of the observers though, similar to how HTTP servers need to keep track of the TCP connections from their clients.) The protocol enables high scalability and efficiency through the support of caches and intermediaries that multiplex the interest of multiple clients in the same resource into a single association.</p>
<p id="rfc.section.1.3.p.2">The server is the authority for determining under what conditions resources change their state and how often observers are notified.  The protocol does not offer explicit means for setting up triggers, thresholds or other conditions; it is up to the server to expose observable resources that change their state in a way that is meaningful for the application. Resources can be parameterized to achieve similar effects though; see <a href="#modeling-resources">Appendix Appendix B</a> for examples.</p>
<p id="rfc.section.1.3.p.3">Since bandwidth is in short supply in constrained environments, servers must adapt the rate of notifications to each client. This implies that a client cannot rely on observing every single state a resource goes through. Instead, the protocol is designed on the principle of <em>eventual consistency</em>: it guarantees that if the resource does not undergo a new change in state, eventually all observers will have a current representation of the last resource state.</p>
<h1 id="rfc.section.1.4">
<a href="#rfc.section.1.4">1.4.</a> <a href="#conformance" id="conformance">Conformance Requirements</a>
</h1>
<p id="rfc.section.1.4.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">RFC 2119</a> <cite title="NONE">[RFC2119]</cite>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#option" id="option">Options</a>
</h1>
<div id="#rfc.table.1"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="right">No.</th>
<th class="left">C/E</th>
<th class="left">Name</th>
<th class="left">Format</th>
<th class="left">Length</th>
<th class="left">Default</th>
</tr></thead>
<tbody>
<tr>
<td class="right">10</td>
<td class="left">Elective</td>
<td class="left">Observe</td>
<td class="left">uint</td>
<td class="left">0-2 B</td>
<td class="left">(none)</td>
</tr>
<tr>
<td class="right">14</td>
<td class="left">Elective</td>
<td class="left">Max-OFE</td>
<td class="left">uint</td>
<td class="left">0-4 B</td>
<td class="left">0</td>
</tr>
</tbody>
</table>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> <a href="#option-observe" id="option-observe">Observe</a>
</h1>
<p id="rfc.section.2.1.p.1">The Observe Option, when present, modifies the GET method so it does not only retrieve a representation of the current state of the resource identified by the request URI, but also requests the server to add the client to the list of observers of the resource. The exact semantics are defined in the sections below. The value of the option in a request MUST be zero on transmission and MUST be ignored on reception.</p>
<p id="rfc.section.2.1.p.2">In a response, the Observe Option identifies the message as a notification, which implies that the client has been added to the list of observers and that the server will notify the client of further changes to the resource state. The option's value is a sequence number that can be used for reordering detection (see <a href="#client-reordering">Section 3.4</a> and <a href="#server-reordering">Section 4.4</a>). It is encoded as a variable-length unsigned integer as defined in <a href="#I-D.ietf-core-coap">Appendix A of RFC XXXX</a> <cite title="NONE">[I-D.ietf-core-coap]</cite>.</p>
<p id="rfc.section.2.1.p.3">Since the Observe Option is elective, a GET request that includes the Observe Option will automatically fall back to a normal GET request if the server does not support the protocol specified in this document.</p>
<p id="rfc.section.2.1.p.4">The Observe Option MUST NOT occur more than once in a request or response.</p>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> <a href="#option-max-ofe" id="option-max-ofe">Max-OFE</a>
</h1>
<p id="rfc.section.2.2.p.1">The freshness of a notification for caching purposes is determined by the Max-Age Option. However, a server may want to enable a cache to continue to optimistically use a cached representation even when the freshness indicated by the Max-Age Option has expired (see <a href="#client-caching">Section 3.3</a> and <a href="#server-caching">Section 4.3</a>).</p>
<p id="rfc.section.2.2.p.2">The time span for which this optimism is justified is under control of the server: it can use the Max-OFE Option to indicate a desired "optimistic freshness extension". This is also a promise by the server that it intends to send another notification within this time period. The exact semantics are defined in the sections below. The value of this option is a time span in seconds, measured from the time of expiry of Max-Age. The option is elective and defaults to zero (which means that no optimistic freshness extension is granted).</p>
<p id="rfc.section.2.2.p.3">The Max-OFE Option MUST NOT occur more than once in a response.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#client" id="client">Client-side Requirements</a>
</h1>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#client-request" id="client-request">Request</a>
</h1>
<p id="rfc.section.3.1.p.1">A client can register its interest in a resource by issuing a GET request that includes an empty Observe Option. If the server returns a 2.xx response that includes an Observe Option as well, the server has added the client successfully to the list of observers of the target resource and the client will be notified of changes to the resource state for as long as the server can assume the client's interest.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#client-notifications" id="client-notifications">Notifications</a>
</h1>
<p id="rfc.section.3.2.p.1">Notifications are additional responses sent by the server in reply to the GET request. Each notification includes an Observe Option with a sequence number (see <a href="#client-reordering">Section 3.4</a>), a Token Option that matches the token specified by the client in the GET request, and a payload in the same representation format as the initial response.</p>
<p id="rfc.section.3.2.p.2">A notification can be confirmable or non-confirmable (i.e. sent in a confirmable or non-confirmable message). If a client does not recognize the token in a confirmable notification, it MUST NOT acknowledge the message and SHOULD reject it with a RST message.  Otherwise, the client MUST acknowledge the message with an ACK message as usual.</p>
<p id="rfc.section.3.2.p.3">An acknowledgement signals to the server that the client is alive and interested in receiving further notifications; if the server does not receive an acknowledgement in reply to a confirmable notification, it will assume that the client is no longer interested and will eventually remove it from the list of observers.</p>
<p id="rfc.section.3.2.p.4">Notifications will have a 2.05 (Content) response code in most cases. They may also have a 2.03 (Valid) response code, if the client includes an ETag Option in its request (see <a href="#client-caching">Section 3.3</a>). In the event that the state of an observed resource is changed in a way that would cause a normal GET request to return an error (for example, when the resource is deleted), the server will send a notification with an error response code (4.xx/5.xx) and empty the list of observers of the resource.</p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#client-caching" id="client-caching">Caching</a>
</h1>
<p id="rfc.section.3.3.p.1">As notifications are just additional responses, notifications partake in caching as defined by <a href="#I-D.ietf-core-coap">Section 5.6 of RFC XXXX</a> <cite title="NONE">[I-D.ietf-core-coap]</cite>. Both the freshness model and the validation model are supported. The freshness model also serves as the model for the client to determine if it's still on the list of observers or if it needs to re-register its interest in the resource.</p>
<p id="rfc.section.3.3.p.2">A client MAY store a notification like a response in its cache and use a stored response/notification that is fresh without contacting the origin server. A notification is considered fresh while its age is not greater than its Max-Age and if it has not been invalidated by a newer notification or as the result of a request.</p>
<p id="rfc.section.3.3.p.3">Ideally, the server will provide a new notification exactly when the freshness of the latest notification expires. This may not always be possible though, due to network latency and/or resources that change their state in unpredictable intervals. In this case, the client MAY optimistically use a stale (non-fresh) notification while the notification's age is not greater than Max-Age plus Max-OFE and the notification has not been invalidated.</p>
<p id="rfc.section.3.3.p.4">If the client does not receive a notification before Max-Age plus Max-OFE expires, the client can assume it has been removed from the list of observers (e.g., due to a loss of server state). In this case, it needs to re-register by issuing a new GET request with an Observe Option.</p>
<p id="rfc.section.3.3.p.5">To make sure it has a fresh representation and/or it is on the list of observers, a client MAY issue another GET request with an Observe Option at any time. The new GET request SHOULD specify a new token to avoid ambiguity. It is RECOMMENDED that the client does not issue the request before the Max-Age of the latest notification expires (i.e.  while it still has a fresh notification).</p>
<p id="rfc.section.3.3.p.6">When a client has one or more notifications stored, it can use the ETag Option in its request to give the server an opportunity to select a stored response to be used. The client MAY include an ETag Option for each stored response that is applicable. It needs to keep those responses in the cache until it is no longer interested in receiving notifications for the target resource or it issues a new GET request with a new set of entity-tags. When the observed resource changes its state to a representation identified by one of the ETag Options, the server can send a 2.03 (Valid) notification instead of a 2.05 (Content) notification.</p>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> <a href="#client-reordering" id="client-reordering">Reordering</a>
</h1>
<p id="rfc.section.3.4.p.1">Messages that carry notifications can arrive in a different order than they were sent. Since the goal is eventual consistency (see <a href="#design-philosophy">Section 1.3</a>), a client can safely skip a notification that arrives later than a newer notification. For this purpose, the server sets the value of the Observe Option in each notification to a sequence number.</p>
<p id="rfc.section.3.4.p.2">A client MAY treat a notification as outdated (not fresh) under the following condition:</p>
<div id="#rfc.figure.3"></div>
<pre>
(V1 - V2) % (2**16) &lt; (2**15)    and    T2 &lt; (T1 + (2**14))
</pre>
<p id="rfc.section.3.4.p.3">where V1 is the value of the Observe Option of the latest valid notification received, V2 the value of the Observe Option of the present notification, T1 a client-local timestamp of the latest valid notification received (in seconds), and T2 a client-local timestamp of the present notification.</p>
<p></p>

<dl>
<dt>Design Note:</dt>
<dd style="margin-left: 8">The first condition essentially verifies that V2 &gt; V1 holds in 16-bit <a href="#RFC1982">sequence number arithmetic</a> <cite title="NONE">[RFC1982]</cite>. The second condition checks that the time expired between the two incoming messages is not so large that the sequence number might have wrapped around and the first check is therefore invalid. (In other words, after about 2**14 seconds elapse without any notification, the client does not need to check the sequence numbers in order to assume an incoming notification is new.) The constants of 2**14 and 2**15 are non-critical, as is the even speed or precision of the clock involved.</dd>
</dl>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#server" id="server">Server-side Requirements</a>
</h1>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#server-request" id="server-request">Request</a>
</h1>
<p id="rfc.section.4.1.p.1">A GET request that includes an Observe Option requests the server not only to return a representation of the resource identified by the request URI, but also to add the client to the list of observers of the target resource. If no error occurs, the server MUST return a response with the representation of the current resource state and MUST notify the client of subsequent changes to the state as long as the client is on the list of observers.</p>
<p id="rfc.section.4.1.p.2">A server that is unable or unwilling to add the client to the list of observers of the target resource MAY silently ignore the Observe Option and process the GET request as usual. The resulting response MUST NOT include an Observe Option, the absence of which signals to the client that it will not be notified of changes to the resource state and, e.g., needs to poll the resource instead.</p>
<p id="rfc.section.4.1.p.3">If the client is already on the list of observers, the server MUST NOT add it a second time but MUST replace or update the existing entry. If the server receives a GET request that does not include an Observe Option, it MUST remove the client from the list of observers.</p>
<p id="rfc.section.4.1.p.4">Two requests relate to the same list entry if both the request URI and the source of the requests match. The source of a request is determined by the security mode used (see <a href="#I-D.ietf-core-coap">Section 10 of RFC XXXX</a> <cite title="NONE">[I-D.ietf-core-coap]</cite>): With NoSec, it is determined by the source IP address and UDP port number.  With other security modes, the source is also determined by the security context. Message IDs and Token Options MUST NOT be taken into account.</p>
<p id="rfc.section.4.1.p.5">Any request with a method other than GET MUST NOT have a direct effect on a list of observers of a resource. However, such a request can have the indirect consequence of causing the server to send an error notification which affects the list of observers (e.g., when a DELETE request is successful and an observed resource no longer exists).</p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#server-notifications" id="server-notifications">Notifications</a>
</h1>
<p id="rfc.section.4.2.p.1">A client is notified of a resource state change by an additional response sent by the server in reply to the GET request. Each such notification response MUST include an Observe Option and MUST echo the token specified by the client in the GET request. If there are multiple clients, the order in which they are notified is not defined; the server is free to use any method to determine the order.</p>
<p id="rfc.section.4.2.p.2">A notification SHOULD have a 2.05 (Content) or 2.03 (Valid) response code. However, in the event that the state of a resource changes in a way that would cause a normal GET request to return an error (for example, if the resource is deleted), the server SHOULD notify the client by sending a notification with an appropriate error response code (4.xx/5.xx) and MUST empty the list of observers of the resource.</p>
<p id="rfc.section.4.2.p.3">The representation format/media type used in a notification MUST be the same format used in the initial response to the GET request. If the server is unable to continue sending notifications in this format, it SHOULD send a 5.00 (Internal Server Error) notification and MUST empty the list of observers of the resource.</p>
<p id="rfc.section.4.2.p.4">A notification can be sent as a confirmable or a non-confirmable message. The message type used is typically application-dependent and MAY be determined by the server for each notification individually.  For example, for resources that change in a somewhat predictable or regular fashion, notifications can be sent in non-confirmable messages; for resources that change infrequently, notifications can be sent in confirmable messages. The server can combine these two approaches depending on the frequency of state changes and the importance of individual notifications.</p>
<p id="rfc.section.4.2.p.5">The acknowledgement of a confirmable notification implies the client's continued interest in being notified. If the client rejects a confirmable notification with a RST message, the server MUST remove the client from the list of observers.</p>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#server-caching" id="server-caching">Caching</a>
</h1>
<p id="rfc.section.4.3.p.1">The Max-Age Option of a notification SHOULD be set to a value that indicates when the server will send the next notification. For example, if the server sends a notification every 30 seconds, a Max-Age Option with value 30 should be included. The server MAY send a new notification before Max-Age ends. The server SHOULD also include a Max-OFE Option so the client can continue to use a notification in case the next notification arrives a bit later due to network latency. If the client does not receive a new notification before Max-Age plus Max-OFE ends, it will assume that it was removed from the list of observers (e.g., due to a loss of server state) and may issue a new GET request to re-register its interest.</p>
<p id="rfc.section.4.3.p.2">It may not always be possible to predict when the server will send the next notification, for example, when a resource does not change its state in regular intervals. In this case, the server SHOULD set Max-Age to a good approximation and Max-OFE to a time span for which the server is willing to keep the client in the list of observers.</p>
<p id="rfc.section.4.3.p.3">Setting the values for Max-Age and Max-OFE is a trade-off between increased usage of bandwidth and the risk of stale information.  Smaller values lead to more notifications and more GET requests, while greater values result in network or device failures being detect later and data becoming stale.</p>
<p id="rfc.section.4.3.p.4">When the observed resource changes its state and the origin server is about to send a 2.05 (Content) notification, then, whenever that notification has an entity-tag in the set of entity-tags specified by the client, it MAY send a 2.03 (Valid) response with an appropriate ETag Option instead. The server MUST NOT assume that the recipient has any response stored other than those identified by the entity-tags in the most recent GET request.</p>
<h1 id="rfc.section.4.4">
<a href="#rfc.section.4.4">4.4.</a> <a href="#server-reordering" id="server-reordering">Reordering</a>
</h1>
<p id="rfc.section.4.4.p.1">Because messages can get reordered, the client needs a way to determine if a notification arrived later than a newer notification.  For this purpose, the server MUST set the value of the Observe Option in each notification to the 16 least-significant bits of a strictly increasing sequence number. The sequence number MAY start at any value. The server MUST NOT reuse the same option value with the same client, token and resource within approximately 2**16 seconds (roughly 18.2 hours).</p>
<p></p>

<dl>
<dt>Implementation Note:</dt>
<dd style="margin-left: 8">A simple implementation that satisfies the requirements is to use a timestamp (in seconds) provided by the device's clock, or a 16-bit unsigned integer variable that is incremented every second and wraps around every 2**16 seconds. It is not necessary that the clock reflects the correct local time or that it ticks exactly every second. Note that, on average, a server cannot send more than one notification per second per client, token and resource.</dd>
</dl>
<h1 id="rfc.section.4.5">
<a href="#rfc.section.4.5">4.5.</a> <a href="#server-retransmission" id="server-retransmission">Retransmission</a>
</h1>
<p id="rfc.section.4.5.p.1">In CoAP, confirmable messages are retransmitted in exponentially increasing intervals for a certain number of attempts until they are acknowledged by the client. In the context of observing a resource, it is undesirable to continue transmitting the representation of a resource state when the state has changed in the meantime.</p>
<p id="rfc.section.4.5.p.2">When a server is in the process of delivering a confirmable notification and is waiting for an acknowledgement, and it wants to notify the client of a state change using a new confirmable message, it MUST stop retransmitting the old notification and SHOULD attempt to deliver the new notification with the number of attempts remaining from the old notification. When the last attempt to retransmit a confirmable message with a notification for a resource times out, the server SHOULD remove the client from the list of observers and MAY additionally remove the client from the lists of observers of all resources in its namespace.</p>
<p id="rfc.section.4.5.p.3">The server SHOULD use a number of retransmit attempts (MAX_RETRANSMIT) such that removing a client from the list of observers before Max-Age plus Max-OFE ends is avoided.</p>
<p id="rfc.section.4.5.p.4">A server MAY choose to skip a notification if it knows that it will send another notification soon (e.g., when the state is changing frequently). Similarly, it MAY choose to send a notification more than once. For example, when state changes occur in bursts, the server can skip some notifications, send notifications in non-confirmable messages, and make sure that the client observes the latest state change after the burst by repeating the last notification in a confirmable message.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#intermediary" id="intermediary">Intermediaries</a>
</h1>
<p id="rfc.section.5.p.1">A client may be interested in a resource in the namespace of an origin server that is reached through one or more CoAP-to-CoAP intermediaries.  In this case, the client registers its interest with the first intermediary towards the origin server, acting as if it was communicating with the origin server itself as specified in <a href="#client">Section 3</a>. It is the task of this intermediary to provide the client with a current representation of the target resource and send notifications upon changes to the target resource state, much like an origin server as specified in <a href="#server">Section 4</a>.</p>
<p id="rfc.section.5.p.2">To perform this task, the intermediary SHOULD make use of the protocol specified in this document, taking the role of the client and registering its own interest in the target resource with the next hop.  If the next hop does not return a response with an Observe Option, the intermediary MAY resort to polling the next hop, or MAY itself return a response without an Observe Option. Note that the communication between each pair of hops is independent, i.e. each hop in the server role MUST determine individually how many notifications to send, of which type, and so on, MUST generate its own values for the Observe Option, and MUST set the values of the Max-Age Option and Max-OFE Option according to the age of the local current representation.</p>
<p id="rfc.section.5.p.3">Because a client (or an intermediary in the client role) can only be once in the list of observers of a resource at a server (or an intermediary in the server role) &#8212; as it makes no sense to observe the same resource multiple times &#8212; an intermediary MUST observe a resource only once, even if there are multiple clients for which it observes the resource.</p>
<p id="rfc.section.5.p.4">Note that an intermediary is not required to have a client to observe a resource; an intermediary MAY observe a resource, for instance, just to keep its own cache up to date.</p>
<p id="rfc.section.5.p.5">See <a href="#examples-proxying">Appendix Appendix A.1</a> for examples.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#block" id="block">Block-wise Transfers</a>
</h1>
<p id="rfc.section.6.p.1">Resources observed by clients may be larger than can be comfortably processed or transferred in one CoAP message. CoAP provides a block-wise transfer mechanism to address this problem <a href="#I-D.ietf-core-block">[I-D.ietf-core-block]</a>. The following rules apply to the combination of block-wise transfers with notifications.</p>
<p id="rfc.section.6.p.2">As with basic GET transfers, the client can indicate its desired block size in a Block2 Option in the GET request. If the server supports block-wise transfers, it SHOULD take note of the block size for all notifications/responses resulting from the GET request (until the client is removed from the list of observers or the server receives a new GET request from the client).</p>
<p id="rfc.section.6.p.3">When sending a 2.05 (Content) notification, the server always sends all blocks of the representation, suitably sequenced by its congestion control mechanism, even if only some of the blocks have changed with respect to a previous value. The server performs the block-wise transfer by making use of the Block2 Option in each block. When reassembling representations that are transmitted in multiple blocks, the client MUST NOT combine blocks carrying different Observe Option values, or blocks that have been received more than approximately 2**14 seconds apart.</p>
<p id="rfc.section.6.p.4">See <a href="#examples-block">Appendix Appendix A.2</a> for an example.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#discovery" id="discovery">Discovery</a>
</h1>
<p id="rfc.section.7.p.1">A <a href="#RFC5988">web link</a> <cite title="NONE">[RFC5988]</cite> to a resource accessible by the CoAP protocol MAY indicate that the server encourages the observation of this resource by including the target attribute "obs".  This is particularly useful in <a href="#I-D.ietf-core-link-format">link-format documents</a> <cite title="NONE">[I-D.ietf-core-link-format]</cite>.</p>
<p id="rfc.section.7.p.2">This target attribute is used as a flag, and thus it has no value component &#8212; a value given for the attribute MUST NOT be given for this version of the specification and MUST be ignored if present. The target attribute "obs" MUST NOT be given more than once for this version of the specification. </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.8.p.1">The security considerations of <a href="#I-D.ietf-core-coap">RFC XXXX</a> <cite title="NONE">[I-D.ietf-core-coap]</cite> apply.</p>
<p id="rfc.section.8.p.2">Note that the considerations about amplification attacks are somewhat amplified when observing resources. In NoSec mode, a server MUST therefore strictly limit the number of notifications that it sends between receiving acknowledgements that confirm the actual interest of the client in the data; i.e., any notifications sent in non-confirmable messages MUST be interspersed with confirmable messages. (An attacker may still spoof the acknowledgements if the confirmable messages are sufficiently predictable.)</p>
<p id="rfc.section.8.p.3">As with any protocol that creates state, attackers may attempt to exhaust the resources that the server has available for maintaining the list of observers for each resource. Servers MAY want to access-control this creation of state. As degraded behavior, the server can always fall back to processing the request as a normal GET request (without an Observe Option) if it is unwilling or unable to add a client to the list of observers of a resource, including if system resources are exhausted or nearing exhaustion.</p>
<p id="rfc.section.8.p.4">Intermediaries MUST be careful to ensure that notifications cannot be employed to create a loop. A simple way to break any loops is to employ caches for forwarding notifications in intermediaries.</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a>
</h1>
<p id="rfc.section.9.p.1">The following entries are added to the CoAP Option Numbers registry:</p>
<div id="#rfc.table.2"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="right">Number</th>
<th class="left">Name</th>
<th class="left">Reference</th>
</tr></thead>
<tbody>
<tr>
<td class="right">10</td>
<td class="left">Observe</td>
<td class="left">[RFCXXXX]</td>
</tr>
<tr>
<td class="right">14</td>
<td class="left">Max-OFE</td>
<td class="left">[RFCXXXX]</td>
</tr>
</tbody>
</table>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> <a href="#acknowledgements" id="acknowledgements">Acknowledgements</a>
</h1>
<p id="rfc.section.10.p.1">Carsten Bormann was an original author of this draft and is acknowledged for significant contribution to this document.</p>
<p id="rfc.section.10.p.2">Thanks to Daniele Alessandrelli, Jari Arkko, Peter Bigot, Angelo Castellani, Gilbert Clark, Esko Dijk, Brian Frank, Salvatore Loreto and Charles Palmer for helpful comments and discussions that have shaped the document.</p>
<p id="rfc.section.10.p.3">Klaus Hartke was funded by the Klaus Tschira Foundation.</p>
<h1 id="rfc.references">
<a href="#rfc.references">11.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">11.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5988">[RFC5988]</b></td>
<td class="top">
<a>Nottingham, M.</a>, "<a href="http://tools.ietf.org/html/rfc5988">Web Linking</a>", RFC 5988, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-core-coap">[I-D.ietf-core-coap]</b></td>
<td class="top">
<a>Shelby, Z</a>, <a>Hartke, K</a>, <a>Bormann, C</a> and <a>B Frank</a>, "<a href="http://tools.ietf.org/html/draft-ietf-core-coap-08">Constrained Application Protocol (CoAP)</a>", Internet-Draft draft-ietf-core-coap-08, October 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-core-block">[I-D.ietf-core-block]</b></td>
<td class="top">
<a>Bormann, C</a> and <a>Z Shelby</a>, "<a href="http://tools.ietf.org/html/draft-ietf-core-block-04">Blockwise transfers in CoAP</a>", Internet-Draft draft-ietf-core-block-04, July 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">11.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC1982">[RFC1982]</b></td>
<td class="top">
<a href="mailto:kre@munnari.OZ.AU" title="University of Melbourne, Computer Science">Elz, R.</a> and <a href="mailto:randy@psg.com" title="RGnet, Inc.">R. Bush</a>, "<a href="http://tools.ietf.org/html/rfc1982">Serial Number Arithmetic</a>", RFC 1982, August 1996.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2616">[RFC2616]</b></td>
<td class="top">
<a href="mailto:fielding@ics.uci.edu" title="Department of Information and Computer Science">Fielding, R.</a>, <a href="mailto:jg@w3.org" title="World Wide Web Consortium">Gettys, J.</a>, <a href="mailto:mogul@wrl.dec.com" title="Compaq Computer Corporation">Mogul, J.</a>, <a href="mailto:frystyk@w3.org" title="World Wide Web Consortium">Frystyk, H.</a>, <a href="mailto:masinter@parc.xerox.com" title="Xerox Corporation">Masinter, L.</a>, <a href="mailto:paulle@microsoft.com" title="Microsoft Corporation">Leach, P.</a> and <a href="mailto:timbl@w3.org" title="World Wide Web Consortium">T. Berners-Lee</a>, "<a href="http://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a>", RFC 2616, June 1999.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5989">[RFC5989]</b></td>
<td class="top">
<a>Roach, A.B.</a>, "<a href="http://tools.ietf.org/html/rfc5989">A SIP Event Package for Subscribing to Changes to an HTTP Resource</a>", RFC 5989, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6202">[RFC6202]</b></td>
<td class="top">
<a>Loreto, S.</a>, <a>Saint-Andre, P.</a>, <a>Salsano, S.</a> and <a>G. Wilkins</a>, "<a href="http://tools.ietf.org/html/rfc6202">Known Issues and Best Practices for the Use of Long Polling and Streaming in Bidirectional HTTP</a>", RFC 6202, April 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-hybi-thewebsocketprotocol">[I-D.ietf-hybi-thewebsocketprotocol]</b></td>
<td class="top">
<a>Fette, I</a> and <a>A Melnikov</a>, "<a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-17">The WebSocket protocol</a>", Internet-Draft draft-ietf-hybi-thewebsocketprotocol-17, September 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-core-link-format">[I-D.ietf-core-link-format]</b></td>
<td class="top">
<a>Shelby, Z</a>, "<a href="http://tools.ietf.org/html/draft-ietf-core-link-format-09">CoRE Link Format</a>", Internet-Draft draft-ietf-core-link-format-09, November 2011.</td>
</tr>
<tr>
<td class="reference"><b id="REST">[REST]</b></td>
<td class="top">
<a title="University of California, Irvine">Fielding, R.</a>, "<a>Architectural Styles and the Design of Network-based Software Architectures</a>", 2000.</td>
</tr>
<tr>
<td class="reference"><b id="GOF">[GOF]</b></td>
<td class="top">
<a>Gamma, E.</a>, <a>Helm, R.</a>, <a>Johnson, R.</a> and <a>J. Vlissides</a>, "<a>Design Patterns: Elements of Reusable Object-Oriented Software</a>", Addison-Wesley, Reading, MA, USA, November 1994.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> <a href="#examples" id="examples">Examples</a>
</h1>
<div id="#rfc.figure.4"></div>
<div id="#example-1"></div>
<pre>
      Observed   CLIENT  SERVER     Actual
  t   State         |      |         State
      ____________  |      |  ____________
  1                 |      |
  2    unknown      |      |       18.5 C
  3                 +-----&gt;|                  Header: GET 0x43011633
  4                 | GET  |                   Token: 0x4a
  5                 |      |                Uri-Path: temperature
  6                 |      |                 Observe: 0
  7                 |      |
  8                 |      |
  9   ____________  |&lt;-----+                  Header: 2.05 0x64451633
 10                 | 2.05 |                   Token: 0x4a
 11    18.5 C       |      |                 Observe: 9
 12                 |      |                 Max-Age: 15
 13                 |      |                 Max-OFE: 60
 14                 |      |                 Payload: "18.5 C"
 15                 |      |
 16                 |      |  ____________
 17   ____________  |&lt;-----+                  Header: 2.05 0x54457b50
 18                 | 2.05 |       19.2 C      Token: 0x4a
 19    19.2 C       |      |                 Observe: 17
 20                 |      |                 Max-Age: 15
 21                 |      |                 Max-OFE: 60
 22                 |      |                 Payload: "19.2 C"
 23                 |      |
</pre>
<div id="#rfc.figure.5"></div>
<div id="#example-2"></div>
<pre>
      Observed   CLIENT  SERVER     Actual
  t   State         |      |         State
      ____________  |      |  ____________
 24                 |      |
 25    19.2 C       |      |       19.2 C
 26                 |      |
 27                 |      |
 28                 |      |  ____________
 29                 | X----+                  Header: 2.05 0x54457b51
 30                 | 2.05 |       19.7 C      Token: 0x4a
 31                 |      |                 Observe: 29
 32   ____________  |      |                 Max-Age: 15
 33                 |      |                 Max-OFE: 60
 34    19.2 C       |      |                 Payload: "19.7 C"
 35   (optimistic)  |      |
 36                 |      |  ____________
 37   ____________  |&lt;-----+                  Header: 2.05 0x55457b52
 38                 | 2.05 |       18.9 C      Token: 0x4a
 39    18.9 C       |      |                 Observe: 37
 40                 |      |                    ETag: 0x78797a7a79
 41                 |      |                 Max-Age: 15
 42                 |      |                 Max-OFE: 60
 43                 |      |                 Payload: "18.9 C"
 44                 |      |
</pre>
<div id="#rfc.figure.6"></div>
<div id="#example-3"></div>
<pre>
      Observed   CLIENT  SERVER     Actual
  t   State         |      |         State
      ____________  |      |  ____________
 45                 |      |
 46    18.9 C       |      |       18.9 C
 47                 |      |
 48                 |      |  ____________
 49                 |    CRASH
 50                 |
 51                 |
 52   ____________  |
 53                 |
 54    18.9 C       |
 55   (optimistic)  |
 56                 |
  :                 :
111                 |
112   ____________  |
113                 |
114    18.9 C       |
115   (invalid)     |
116                 |
</pre>
<div id="#rfc.figure.7"></div>
<div id="#example-4"></div>
<pre>
      Observed   CLIENT  SERVER     Actual
  t   State         |      |         State
      ____________  |      |  ____________
117                 |      |
118    18.9 C       |      |       18.0 C
119   (invalid)     +-----&gt;|                  Header: GET 0x44011634
120                 | GET  |                   Token: 0xf9
121                 |      |                Uri-Path: temperature
122                 |      |                 Observe: 0
123                 |      |                    ETag: 0x78797a7a79
124                 |      |
125                 |      |
126   ____________  |&lt;-----+                  Header: 2.05 0x64451634
127                 | 2.05 |                   Token: 0xf9
128    18.0 C       |      |                 Observe: 126
129                 |      |                 Max-Age: 15
130                 |      |                 Max-OFE: 60
131                 |      |                 Payload: "18.0 C"
132                 |      |
133                 |      |  ____________
134   ____________  |&lt;-----+                  Header: 2.03 0x5543aa0c
135                 | 2.03 |       18.9 C      Token: 0xf9
136    18.9 C       |      |                 Observe: 134
137                 |      |                    ETag: 0x78797a7a79
138                 |      |                 Max-Age: 15
139                 |      |                 Max-OFE: 60
140                 |      |
</pre>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> <a href="#examples-proxying" id="examples-proxying">Proxying</a>
</h1>
<div id="#rfc.figure.8"></div>
<div id="#example-5"></div>
<pre>
CLIENT  PROXY  SERVER
   |      |      |
   |      +-----&gt;|     Header: GET 0x44015fb8
   |      | GET  |      Token: 0x1a
   |      |      |   Uri-Host: sensor.example
   |      |      |   Uri-Path: status
   |      |      |    Observe: 0
   |      |      |
   |      |&lt;-----+     Header: 2.05 0x64455fb8
   |      | 2.05 |      Token: 0x1a
   |      |      |    Observe: 42
   |      |      |    Max-Age: 60
   |      |      |    Max-OFE: 60
   |      |      |    Payload: "ready"
   |      |      |
   +-----&gt;|      |     Header: GET 0x42011633
   | GET  |      |      Token: 0x9a
   |      |      |  Proxy-Uri: coap://sensor.example/status
   |      |      |
   |&lt;-----+      |     Header: 2.05 0x62451633
   | 2.05 |      |      Token: 0x9a
   |      |      |    Max-Age: 53
   |      |      |    Payload: "ready"
   |      |      |
   |      |&lt;-----+     Header: 2.05 0x544505fc0
   |      | 2.05 |      Token: 0x1a
   |      |      |    Observe: 135
   |      |      |    Max-Age: 60
   |      |      |    Max-OFE: 60
   |      |      |    Payload: "busy"
   |      |      |
   +-----&gt;|      |     Header: GET 0x42011634
   | GET  |      |      Token: 0x9b
   |      |      |  Proxy-Uri: coap://sensor.example/status
   |      |      |
   |&lt;-----+      |     Header: 2.05 0x62451634
   | 2.05 |      |      Token: 0x9b
   |      |      |    Max-Age: 49
   |      |      |    Payload: "busy"
   |      |      |
</pre>
<div id="#rfc.figure.9"></div>
<div id="#example-6"></div>
<pre>
CLIENT  PROXY  SERVER
   |      |      |
   +-----&gt;|      |     Header: GET 0x43011635
   | GET  |      |      Token: 0x6a
   |      |      |  Proxy-Uri: coap://sensor.example/status
   |      |      |    Observe: 0
   |      |      |
   |&lt;- - -+      |     Header: 0x60001635
   |      |      |
   |      +-----&gt;|     Header: GET 0x4401af90
   |      | GET  |      Token: 0xaa
   |      |      |   Uri-Host: sensor.example
   |      |      |   Uri-Path: status
   |      |      |    Observe: 0
   |      |      |
   |      |&lt;-----+     Header: 2.05 0x6445af90
   |      | 2.05 |      Token: 0xaa
   |      |      |    Observe: 67
   |      |      |    Max-Age: 60
   |      |      |    Max-OFE: 60
   |      |      |    Payload: "ready"
   |      |      |
   |&lt;-----+      |     Header: 2.05 0x4445af94
   | 2.05 |      |      Token: 0x6a
   |      |      |    Observe: 17346
   |      |      |    Max-Age: 60
   |      |      |    Max-OFE: 60
   |      |      |    Payload: "ready"
   |      |      |
   +- - -&gt;|      |     Header: 0x6000af94
   |      |      |
   |      |&lt;-----+     Header: 2.05 0x54455a20
   |      | 2.05 |      Token: 0xaa
   |      |      |    Observe: 157
   |      |      |    Max-Age: 60
   |      |      |    Max-OFE: 60
   |      |      |    Payload: "busy"
   |      |      |
   |&lt;-----+      |     Header: 2.05 0x5445af9b
   | 2.05 |      |      Token: 0x6a
   |      |      |    Observe: 17436
   |      |      |    Max-Age: 60
   |      |      |    Max-OFE: 60
   |      |      |    Payload: "busy"
   |      |      |
</pre>
<h1 id="rfc.appendix.Appendix A.2">
<a href="#rfc.appendix.Appendix%20A.2">Appendix A.2.</a> <a href="#examples-block" id="examples-block">Block-wise Transfer</a>
</h1>
<div id="#rfc.figure.10"></div>
<div id="#example-7"></div>
<pre>
CLIENT  SERVER
   |      |
   +-----&gt;|     Header: GET 0x43011636
   | GET  |      Token: 0xfb
   |      |   Uri-Path: status-icon
   |      |    Observe: 0
   |      |
   |&lt;-----+     Header: 2.05 0x65451636
   | 2.05 |      Token: 0xfb
   |      |     Block2: 0/1/128
   |      |    Observe: 62354
   |      |    Max-Age: 60
   |      |    Max-OFE: 60
   |      |    Payload: [128 bytes]
   |      |
   |&lt;-----+     Header: 2.05 0x5545af9c
   | 2.05 |      Token: 0xfb
   |      |     Block2: 1/0/128
   |      |    Observe: 62354
   |      |    Max-Age: 60
   |      |    Max-OFE: 60
   |      |    Payload: [27 bytes]
   |      |
   |&lt;-----+     Header: 2.05 0x5545af9d
   | 2.05 |      Token: 0xfb
   |      |     Block2: 0/1/128
   |      |    Observe: 62444
   |      |    Max-Age: 60
   |      |    Max-OFE: 60
   |      |    Payload: [128 bytes]
   |      |
   |&lt;-----+     Header: 2.05 0x5545af9e
   | 2.05 |      Token: 0xfb
   |      |     Block2: 1/0/128
   |      |    Observe: 62444
   |      |    Max-Age: 60
   |      |    Max-OFE: 60
   |      |    Payload: [27 bytes]
   |      |
</pre>
<h1 id="rfc.appendix.Appendix B">
<a href="#rfc.appendix.Appendix%20B">Appendix B.</a> <a href="#modeling-resources" id="modeling-resources">Modeling Resources to Tailor Notifications</a>
</h1>
<p id="rfc.section.Appendix B.p.1">A server may want to provide notifications that respond to very specific conditions on some state. This is best done by modeling the resources that the server exposes according to these needs.</p>
<p id="rfc.section.Appendix B.p.2">For example, for a CoAP server with an attached temperature sensor,</p>

<ul>
<li>the server could, in the simplest form, expose a resource &lt;http://server/temperature&gt; that changes its state every second to the current temperature measured by the sensor;</li>
<li>the server could, however, also expose a resource &lt;http://server/temperature/felt&gt; that changes its state to "cold" when the temperature drops below a preconfigured threshold, and to "warm" when the temperature exceeds a second, higher threshold;</li>
<li>the server could expose a parameterized resource &lt;http://server/temperature/critical?above=45&gt; that changes its state to the current temperature if the temperature exceeds the specified value, and changes its state to "OK" when the temperature drops below; or</li>
<li>the server could expose a parameterized resource &lt;http://server/temperature?query=select+avg(temperature)+from+Sensor.window:time(30sec)&gt; that accepts expressions of arbitrary complexity and changes its state accordingly.</li>
</ul>
<p id="rfc.section.Appendix B.p.3">In any case, the client is notified about the current state of the resource whenever the state of the appropriately modeled resource changes. By designing resources that change their state on certain conditions, it is possible to notify the client only when these conditions occur instead of continuously supplying it with information it doesn't need. With parametrized resources, this is not limited to conditions defined by the server, but can be extended to arbitrarily complex conditions defined by the client. Thus, the server designer can choose exactly the right level of complexity for the application envisioned and devices used, and is not constrained to a "one size fits all" mechanism built into the protocol.</p>
<h1 id="rfc.appendix.Appendix C">
<a href="#rfc.appendix.Appendix%20C">Appendix C.</a> <a href="#changelog" id="changelog">Changelog</a>
</h1>
<p id="rfc.section.Appendix C.p.1">Changes from ietf-02 to ietf-03: </p>

<ul>
<li>Separated client-side and server-side requirements.</li>
<li>Fixed uncertainty if client is still in the list of observers by introducing a liveliness model based on Max-Age and a new option called Max-OFE (#174).</li>
<li>Simplified the text on message reordering (#129).</li>
<li>Clarified requirements for intermediaries.</li>
<li>Clarified the combination of block-wise transfers with notifications (#172).</li>
<li>Updated examples to show how the state observed by the client becomes eventually consistent with the actual state on the server.</li>
<li>Added examples for parameterization of observable resource.</li>
</ul>

<p> </p>
<p id="rfc.section.Appendix C.p.2">Changes from ietf-01 to ietf-02: </p>

<ul>
<li>Removed the requirement of periodic refreshing (#126).</li>
<li>The new "Observe" Option replaces the "Lifetime" Option.</li>
<li>Introduced a new mechanism to detect message reordering.</li>
<li>Changed 2.00 (OK) notifications to 2.05 (Content) notifications.</li>
</ul>

<p> </p>
<p id="rfc.section.Appendix C.p.3">Changes from ietf-00 to ietf-01: </p>

<ul>
<li>Changed terminology from "subscriptions" to "observation relationships" (#33).</li>
<li>Changed the name of the option to "Lifetime".</li>
<li>Clarified establishment of observation relationships.</li>
<li>Clarified that an observation is only identified by the URI of the observed resource and the identity of the client (#66).</li>
<li>Clarified rules for establishing observation relationships (#68).</li>
<li>Clarified conditions under which an observation relationship is terminated.</li>
<li>Added explanation on how clients can terminate an observation relationship before the lifetime ends (#34).</li>
<li>Clarified that the overriding objective for notifications is eventual consistency of the actual and the observed state (#67).</li>
<li>Specified how a server needs to deal with clients not acknowledging confirmable messages carrying notifications (#69).</li>
<li>Added a mechanism to detect message reordering (#35).</li>
<li>Added an explanation of how notifications can be cached, supporting both the freshness and the validation model (#39, #64).</li>
<li>Clarified that non-GET requests do not affect observation relationships, and that GET requests without "Lifetime" Option affecting relationships is by design (#65).</li>
<li>Described interaction with block-wise transfers (#36).</li>
<li>Added Resource Discovery section (#99).</li>
<li>Added IANA Considerations.</li>
<li>Added Security Considerations (#40).</li>
<li>Added examples (#38).</li>
</ul>

<p> </p>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Klaus Hartke</span> 
	  <span class="n hidden">
		<span class="family-name">Hartke</span>
	  </span>
	</span>
	<span class="org vcardline">Universitaet Bremen TZI</span>
	<span class="adr">
	  <span>Postfach 330440</span>

	  <span class="vcardline">
		<span class="locality">Bremen</span>,  
		<span class="region"></span>
		<span class="code">D-28359</span>
	  </span>
	  <span class="country-name vcardline">Germany</span>
	</span>
	<span class="vcardline">Phone: +49-421-218-63905</span>

<span class="vcardline">EMail: <a href="mailto:hartke@tzi.org">hartke@tzi.org</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Zach Shelby</span> editor
	  <span class="n hidden">
		<span class="family-name">Shelby</span>
	  </span>
	</span>
	<span class="org vcardline">Sensinode</span>
	<span class="adr">
	  <span>Kidekuja 2</span>

	  <span class="vcardline">
		<span class="locality">Vuokatti</span>,  
		<span class="region"></span>
		<span class="code">88600</span>
	  </span>
	  <span class="country-name vcardline">Finland</span>
	</span>
	<span class="vcardline">Phone: +358407796297</span>

<span class="vcardline">EMail: <a href="mailto:zach@sensinode.com">zach@sensinode.com</a></span>

  </address>
</div>

</body>
</html>