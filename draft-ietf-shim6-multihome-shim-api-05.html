<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Socket Application Program
    Interface (API) for Multihoming Shim</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Socket Application Program
    Interface (API) for Multihoming Shim">
<meta name="keywords" content="SHIM6, HIP, identifier/locator split">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">SHIM6 Working Group</td><td class="header">M. Komu</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">HIIT</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">M. Bagnulo</td></tr>
<tr><td class="header">Expires: August 26, 2008</td><td class="header">UC3M</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">K. Slavov</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">S. Sugimoto, Ed.</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Ericsson</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">February 23, 2008</td></tr>
</table></td></tr></table>
<h1><br />Socket Application Program
    Interface (API) for Multihoming Shim<br />draft-ietf-shim6-multihome-shim-api-05</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on August 26, 2008.</p>

<h3>Abstract</h3>

<p>This document specifies a socket API for the multihoming shim
      layer.  The API aims to enable interactions between the
      applications and the multihoming shim layer for advanced locator
      management and access to information about failure detection and
      path exploration.
</p>
<p>This document is based on an assumption that a multihomed host
      is equipped with a conceptual sublayer (here after "shim")
      inside the IP layer that maintains mappings between identifiers
      and locators.  Examples of the shim are SHIM6 and HIP.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#sec-system-overview">3.</a>&nbsp;
System Overview<br />
<a href="#sec-requirements">4.</a>&nbsp;
Requirements<br />
<a href="#sec-shim-socket-options">5.</a>&nbsp;
Socket Options for Multihoming Shim Layer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">5.1.</a>&nbsp;
SHIM_ASSOCIATED<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">5.2.</a>&nbsp;
SHIM_DONTSHIM<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">5.3.</a>&nbsp;
SHIM_HOT_STANDBY<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">5.4.</a>&nbsp;
SHIM_PATHEXPLORE<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">5.5.</a>&nbsp;
SHIM_LOC_LOCAL_PREF<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">5.6.</a>&nbsp;
SHIM_LOC_PEER_PREF<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">5.7.</a>&nbsp;
SHIM_LOC_LOCAL_RECV<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">5.8.</a>&nbsp;
SHIM_LOC_PEER_RECV<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">5.9.</a>&nbsp;
SHIM_LOC_LOCAL_SEND<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">5.10.</a>&nbsp;
SHIM_LOC_PEER_SEND<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">5.11.</a>&nbsp;
SHIM_LOCLIST_LOCAL<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">5.12.</a>&nbsp;
SHIM_LOCLIST_PEER<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">5.13.</a>&nbsp;
SHIM_APP_TIMEOUT<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">5.14.</a>&nbsp;
SHIM_DEFERRED_CONTEXT_SETUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">5.15.</a>&nbsp;
Error Handling<br />
<a href="#sec-access-to-locinfo">6.</a>&nbsp;
Ancillary Data for Multihoming Shim<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">6.1.</a>&nbsp;
Get Locator Information from Incoming Packet<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">6.2.</a>&nbsp;
Specify Locator Information for Outgoing Packet<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-feedback">6.3.</a>&nbsp;
Notification from Application to Multihoming Shim<br />
<a href="#sec-data-structures">7.</a>&nbsp;
Data Structures<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor20">7.1.</a>&nbsp;
Placeholder for Locator Information<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">7.2.</a>&nbsp;
Path Exploration Parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-feedback-info">7.3.</a>&nbsp;
Feedback Information<br />
<a href="#sec-implications-for-legacyapi">8.</a>&nbsp;
Implications for Existing Socket API Extensions<br />
<a href="#anchor22">9.</a>&nbsp;
Resolving Conflicts with Preference Values<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor23">9.1.</a>&nbsp;
Implicit Forking<br />
<a href="#sec-discussion">10.</a>&nbsp;
Discussion<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">10.1.</a>&nbsp;
Naming at Socket Layer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">10.2.</a>&nbsp;
Additional Requirements from Application<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor26">10.3.</a>&nbsp;
Issues of Header Conversion among Different Address Family<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor27">10.4.</a>&nbsp;
Handling of Unknown Locator Provided by Application<br />
<a href="#anchor28">11.</a>&nbsp;
Changes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor29">11.1.</a>&nbsp;
Changes from version 00 to version 01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor30">11.2.</a>&nbsp;
Changes from version 01 to version 02<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor31">11.3.</a>&nbsp;
Changes from version 02 to version 03<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor32">11.4.</a>&nbsp;
Changes from version 03 to version 04<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor33">11.5.</a>&nbsp;
Changes from version 04 to version 05<br />
<a href="#anchor34">12.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor35">13.</a>&nbsp;
Security Considerations<br />
<a href="#anchor36">14.</a>&nbsp;
Conclusion<br />
<a href="#anchor37">15.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">16.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">16.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">16.2.</a>&nbsp;
Informative References<br />
<a href="#anchor40">Appendix&nbsp;A.</a>&nbsp;
Context Forking<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>HIP and SHIM6 have a commonality in their protocol design
      separation of identifier and locator (hereafter
      identifier/locator separation).  Both protocols aim to solve
      problems that are specific to multihoming environment in a host
      centric approach.  In these protocols, a sub-layer within the IP
      layer maintains mappings of identifiers and locators.
</p>
<p>The shim layer is useful in a sense that the IP layer can
      maintain the mapping of an identifier to corresponding locators.
      Under a multihomed environment, typically, a host has more than
      one IP address at a time.  During a given transaction, a host
      may be required to switch the IP address used for the
      communication to another IP address to preserve the
      communication.  The protocol stack should take care of isolating the upper layer
      from disruption by the address update.  The shim layer can make this
      locator update transparent to the upper layer protocols.
</p>
<p>In a system which is based on identifier/locator separation,
      upper layer protocols are expected to deal with identifiers for
      establishing and handling the communications.  If an application
      wants to have a multihoming support by the shim layer, the IP
      addresses specified as source and destination addresses must be
      identifiers.  However, this does not necessarily mean that
      applications are prohibited to choose specific locators in its
      communication.  It may be useful for applications, in some
      situation, to specify a preferred locator for the flow.
</p>
<p>This document recommends that the identifier/locator
      adaptation is done only once inside the network stack of a host.
      That is, if multiple shim sublayers exist at the IP layer, any
      one of them should be applied exclusively for a given flow.
</p>
<p>As this document specifies socket API, it is written so that
      the contents are in line with Posix standard <a class='info' href='#POSIX'>[POSIX]<span> (</span><span class='info'>, &ldquo;IEEE Std. 1003.1-2001 Standard for Information 	  Technology -- Portable Operating System Interface 	  (POSIX). Open group Technical Standard: Base Specifications, 	  Issue 6, http://www.opengroup.org/austin,&rdquo; December&nbsp;2001.</span><span>)</span></a> as much as possible.  The API specified in this
      document defines how to use ancillary data (aka cmsg) to access
      locator information with recvmsg() and/or sendmsg() I/O calls.
      Definition of API is presented in C language and data types
      follow Posix format; intN_t means a singed integer of exactly N
      bits (e.g. int16_t) and uintN_t means an unsigned integer of
      exactly N bits (e.g. uint32_t).
</p>
<p>The target readers of this document are application
      programmers who develop application software which may benefit
      greatly from multihomed environment.  In addition, this document
      should be of interest for the developers of a given shim
      protocol, as the shim layer should provide the interface to the
      application.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>This section provides terminology used in this document.
      Basically most of the terms used in this document are taken from
      the following documents:<br />
<br />


      </p>
<ul class="text">
<li>SHIM6 Protocol Specification<a class='info' href='#I-D.ietf-shim6-proto'>[I&#8209;D.ietf&#8209;shim6&#8209;proto]<span> (</span><span class='info'>Bagnulo, M. and E. Nordmark, &ldquo;Level 3 multihoming shim protocol,&rdquo; October&nbsp;2007.</span><span>)</span></a>
</li>
<li>HIP Architecture<a class='info' href='#RFC4423'>[RFC4423]<span> (</span><span class='info'>Moskowitz, R. and P. Nikander, &ldquo;Host Identity Protocol (HIP) Architecture,&rdquo; May&nbsp;2006.</span><span>)</span></a>
</li>
<li>Reachability Protocol (REAP)<a class='info' href='#I-D.ietf-shim6-failure-detection'>[I&#8209;D.ietf&#8209;shim6&#8209;failure&#8209;detection]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration Protocol for IPv6  Multihoming,&rdquo; January&nbsp;2008.</span><span>)</span></a>
</li>
</ul><p>
      <br />
<br />


      In this document, the term "IP" refers to both IPv4 and IPv6,
      unless the protocol version is specifically mentioned.  The
      followings are definitions of the terms that are frequently used
      in this document:<br />
<br />

 
      </p>
<ul class="text">
<li>Endpoint Identifier (EID) - An identifier used by the
	application to specify the endpoint of a given communication.
	Applications may handle EID in various ways such as
	long-lived connections, callbacks, and referrals<a class='info' href='#I-D.ietf-shim6-app-refer'>[I&#8209;D.ietf&#8209;shim6&#8209;app&#8209;refer]<span> (</span><span class='info'>Nordmark, E., &ldquo;Shim6 Application Referral Issues,&rdquo; July&nbsp;2005.</span><span>)</span></a>.

	
<ul class="text">
<li>In the case of SHIM6, an identifier called an ULID serves
	  as an EID.  An ULID is chosen from locators available on the
	  host.
</li>
<li>In the case of HIP, an identifier which specifies
	  communication endpoints is derived from the public key of
	  the host, which is called a Host Identifier.  For the sake
	  of backward compatibility of the socket API, the Host
	  Identifier is represented in a form of hash of public key.
	  
</li>
</ul>
	
</li>
<li>Locator - An IP address actually used to deliver IP
	packets.  Locators should be present in the source and
	destination fields of the IP header of a packet on the wire.
	
<ul class="text">
<li>List of Locators - A list of locators associated with an
	  EID.  There are two lists of locators stored in a given
	  context, one is associated with the local EID and the other
	  is associated with the remote EID.  As defined in <a class='info' href='#I-D.ietf-shim6-proto'>[I&#8209;D.ietf&#8209;shim6&#8209;proto]<span> (</span><span class='info'>Bagnulo, M. and E. Nordmark, &ldquo;Level 3 multihoming shim protocol,&rdquo; October&nbsp;2007.</span><span>)</span></a>, the list of locators
	  associated with an EID 'A' can be denoted as Ls(A).
</li>
<li>Preferred Locator - The (source/destination) locator
	  currently used to send packets within a given context.  As
	  defined in <a class='info' href='#I-D.ietf-shim6-proto'>[I&#8209;D.ietf&#8209;shim6&#8209;proto]<span> (</span><span class='info'>Bagnulo, M. and E. Nordmark, &ldquo;Level 3 multihoming shim protocol,&rdquo; October&nbsp;2007.</span><span>)</span></a>, the
	  preferred locator of a host 'A' is denoted as Lp(A).
</li>
</ul>
	
</li>
<li>Shim - A conceptual (sub-)layer inside the IP Layer which
	maintains mappings of EIDs and locators.  An EID can be
	associated with more than one locators at a time when the host
	is multihomed.  The term 'shim' does not refer to a specific
	protocol but refers to the conceptual sublayer inside the IP
	layer.
</li>
<li>identifier/locator adaptation - An adaptation performed at
	the shim layer between EIDs and locators within a given
	context.  The adaptation may end up re-writing the source and
	destination addresses of the IP packet.  In the outbound
	packet processing, the EID pair is converted to the associated
	locator pair, while the locator pair is converted to the EID
	pair in the inbound packet processing.
</li>
<li>Context - State information shared by a given pair of
	peers, which stores a binding between the EIDs and associated
	locators.  The context is maintained at the shim layer.
</li>
<li>Reachability Detection - A procedure to check reachability
	between a given locator pair.
</li>
<li>Path - A sequence of routers that an IP packet goes through
	to reach the destination.
</li>
<li>Path Exploration - A procedure to explore available paths
	for a given set of locator pairs.
</li>
<li>Outage - An incident that prevents IP packets to flow from
	the source locator to the destination locator.  When there is
	an outage, it means that there is no reachability between a
	given locator pair.  The outage can be caused by various
	reasons, such as shortage of network resources, congestion,
	and human error (faulty operation).
</li>
<li>Working Address Pair - An address pair is said to be
	working if the packet containing the first address from the
	pair as source address and the second address from the pair as
	destination address can safely travel from the source to the
	destination.  If the reachability is confirmed in both
	directions, the address pairs is said to be bi-directional.
	Otherwise, it's unidirectional.
</li>
<li>Reachability Protocol (REAP) - A protocol for detecting
	failure and exploring reachability in a multihomed
	environment.  REAP is defined in <a class='info' href='#I-D.ietf-shim6-failure-detection'>[I&#8209;D.ietf&#8209;shim6&#8209;failure&#8209;detection]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration Protocol for IPv6  Multihoming,&rdquo; January&nbsp;2008.</span><span>)</span></a>.
</li>
</ul><p>
      
</p>
<a name="sec-system-overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
System Overview</h3>

<p><a class='info' href='#fig-system-overview'>Figure&nbsp;1<span> (</span><span class='info'>System overview</span><span>)</span></a> illustrates the system
      overview.  The shim layer and REAP component exist inside the IP
      layer.  Applications can use the socket API defined in this
      document to interface the shim layer and transport layer for
      locator management and failure detection and path
      exploration.
</p>
<p>It is also possible that the shim layer interacts with
      transport layers, but the interactions are outside the scope of
      this document.
</p><br /><hr class="insert" />
<a name="fig-system-overview"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                     +------------------------+
                     |       Application      |
                     +------------------------+
                        ^                 ^
           ~~~~~~~~~~~~~|~Socket Interface|~~~~~~~~~~~~~~
                        |                 v
            +-----------|------------------------------+
            |           |  Transport Layer             |
            +-----------|------------------------------+
                  ^     |
    +-------------|-----|-------------------------------------+
    |             v     v                                     |
    |   +-----------------------------+       +----------+    |  IP
    |   |            Shim             |&lt;-----&gt;|   REAP   |    | Layer
    |   +-----------------------------+       +----------+    |
    |                       ^                      ^          |
    +-----------------------|----------------------|----------+
                            v                      v
            +------------------------------------------+
            |                Link Layer                |
            +------------------------------------------+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: System overview&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="sec-requirements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Requirements</h3>

<p>The following is the list of requirements from the
      application perspective:
      
      
      
      </p>
<ul class="text">
<li>Locator management.  The shim layer selects a pair of
	locators for sending IP packets within a given context.  The
	selection is made by taking miscellaneous conditions into
	account such as reachability of the path, application's
	preference, and characteristics of path.  From the
	application's perspective:

	
<ul class="text">
<li>It should be possible to obtain the lists of locators of
	  a given context: Ls(local) and Ls(remote).
</li>
<li>It should be possible to obtain the preferred locators of
	  a given context: Lp(local) and Lp(remote).
</li>
</ul>
	
</li>
<li>Notification from the application to the shim layer about
	the status of the communication.  Note that the notification
	is made in an event based manner.  There are mainly two
	aspects of the feedback that application or upper layer
	protocol may provide for the shim layer, positive and negative
	feedbacks [NOTE: These feedbacks are mentioned in <a class='info' href='#I-D.ietf-shim6-failure-detection'>[I&#8209;D.ietf&#8209;shim6&#8209;failure&#8209;detection]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration Protocol for IPv6  Multihoming,&rdquo; January&nbsp;2008.</span><span>)</span></a>]:
	
	
<ul class="text">
<li>Positive feedback could be given by the application or
	  upper layer protocol (e.g. TCP) to the shim layer informing
	  that the communication is going well.
</li>
<li>Negative feedback could be given by the application or
	  upper layer protocol (e.g. TCP) to the shim layer informing
	  that the communication status is not satisfactory.  TCP
	  could detect a problem when it does not receive expected ACK
	  from the peer.  ICMP error messages delivered to the upper
	  layer protocol could be a clue for application to detect
	  potential problems.  REAP module may be triggered by these
	  negative feedbacks and invoke procedure of path
	  exploration.
</li>
</ul>
	
</li>
<li>Feedback from application to shim layer.  The application
	should be able to inform the shim layer of the timeout values
	for detecting failures, for sending keepalives, for starting
	the exploration procedure.  In particular, the application
	should be able to suppress the keepalives.
	
</li>
<li>Hot-standby.  The application may request the shim layer
	for hot-standby capabilities.  In this case, alternative paths
	are known to be working before a failure is detected.  Hence
	it is possible for the host to immediately replace the current
	locator pair with an alternative locator pair.  Hot-standby
	may allow applications to achieve better failover.
	
</li>
<li>Eagerness of locator exploration.  The application should
	be able to inform the shim layer how aggressive it wants REAP
	mechanism to perform path exploration (e.g. specifying the
	number of concurrent attempts of discovering working locator
	pair) when an outage occurs on the path between the currently
	selected locator pair.
</li>
<li>Providing locator information to application.  The
	application should be able to obtain information about the
	locator pair which was actually used to send or receive the
	packet.
	
<ul class="text">
<li>For inbound traffic, the application may be interested in
	  the locator pair which was actually used to receive the
	  packet.
	  
</li>
<li>For outbound traffic, the application may be interested
	  in the locator pair which was actually used to transmit the
	  packet.
</li>
</ul>
	In this way, the application may have additional control on
	the locator management.  For example, the application can
	verify if its preference of locator is actually applied to the
	flow or not.
	
</li>
<li>The application should be able to specify if it wants to
	defer the context setup or if it wants context establishment
	to be started immediately in case there is no available
	context.  With deferred context setup, there should be no
	additional delay imposed by context establishment in
	initiation of communication.
</li>
<li>Turn on/off shim.  The application should be able to
	request to turn on/off the multihoming support by the shim
	layer:
	
<ul class="text">
<li>Apply shim.  The application should be able to explicitly
	  request the shim layer to apply multihoming support.
</li>
<li>Don't apply shim.  The application should be able to
	  request the shim layer not to apply the multihoming support
	  but to apply normal IP processing at the IP layer.
</li>
</ul>
	
</li>
<li>The application should be able to know if the communication
	is now served by the shim layer or not.
</li>
<li>The application should be able to access locator
	information regardless of its address family.  In other words,
	no matter whether the target locator is IPv4 or IPv6, the
	application should be able to use common interface to access
	the locator information.
</li>
</ul><p>	
    
</p>
<a name="sec-shim-socket-options"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Socket Options for Multihoming Shim Layer</h3>

<p>In this section, socket options that are specific to multihomed
      shim are defined.
</p>
<p><a class='info' href='#tab-shim-socket-options'>Table&nbsp;1<span> (</span><span class='info'>Socket options for multihoming shim</span><span>)</span></a> provides a list of
      the socket options that are specific to multihoming shim layer.
      These socket options can be used by either getsockopt() or
      setsockopt() system call for a given socket.  All of these
      socket options are defined at level SOL_SHIM.
</p>
<p>The first column of <a class='info' href='#tab-shim-socket-options'>Table&nbsp;1<span> (</span><span class='info'>Socket options for multihoming shim</span><span>)</span></a>
      gives the name of the option.  The second and third columns
      indicate whether the option can be handled by getsockopt()
      and/or setsockopt(), respectively.  The fourth column provides a
      brief description of the socket option.  The fifth column shows
      the type of data structure specified along with the socket
      option.  By default, the data structure type is an integer.
</p><br /><hr class="insert" />
<a name="tab-shim-socket-options"></a>
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left"><col align="left"><col align="left"><col align="left">
<tr><th align="left">optname</th><th align="left">get</th><th align="left">set</th><th align="left">description</th><th align="left">dtype</th></tr>
<tr>
<td align="left">SHIM_ASSOCIATED</td>
<td align="left">o</td>
<td align="left">&nbsp;</td>
<td align="left">Check if the socket is associated with any shim context or
	not.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_DONTSHIM</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Request the shim layer not to apply any multihoming support
	for the communication.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_HOT_STANDBY</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Request the shim layer to prepare a hot-standby connection
	(in addition to the current path).</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_PREF</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the preferred locator on the local side for the
	context associated with the socket.</td>
<td align="left">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_PREF</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the preferred locator on the remote side for the
	context associated with the socket.</td>
<td align="left">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_RECV</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Request for the destination locator of the received IP
	packet.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_RECV</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Request for the source locator of the received IP
	packet.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_SEND</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Request use of specific locator as source locator of
	outgoing IP packets.</td>
<td align="left">*2</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_SEND</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Request use of specific locator as destination locator of
	outgoing IP packets.</td>
<td align="left">*2</td>
</tr>
<tr>
<td align="left">SHIM_LOCLIST_LOCAL</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set a list of locators associated with the local
	EID.</td>
<td align="left">*3</td>
</tr>
<tr>
<td align="left">SHIM_LOCLIST_PEER</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set a list of locators associated with the peer's
	EID.</td>
<td align="left">*3</td>
</tr>
<tr>
<td align="left">SHIM_APP_TIMEOUT</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Inform the shim layer of a timeout value for detecting
	failure.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_PATHEXPLORE</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Specify behavior of path exploration and failure
	detection.</td>
<td align="left">*4</td>
</tr>
<tr>
<td align="left">SHIM_CONTEXT_DEFERRED_SETUP</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Specify if the context setup can be deferred or not.</td>
<td align="left">int</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Table 1: Socket options for multihoming shim&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>*1: Pointer to a shim_locator which is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p>*2: Pointer to shim_locator data structure.
</p>
<p>*3: Pointer to an array of shim_locator.
</p>
<p>*4: Pointer to a shim_pathexplore which is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p><a class='info' href='#fig-socket-api-model'>Figure&nbsp;2<span> (</span><span class='info'>System model of socket API with shim layer</span><span>)</span></a> illustrates how the
      shim specific socket options fit into the system model of socket
      API.  In the figure, it can be seen that the shim layer and the
      additional protocol components (IPv4 and IPv6) below the shim
      layer are new to the system model.  As previously mentioned, all
      the shim specific socket options are defined at SOL_SHIM level.
      This design choice brings the following advantages:<br />
<br />


      </p>
<ol class="text">
<li>It is assured that the existing socket API continue to work
	at the layer above the shim layer.  That is, those legacy API
	deal with 'identifier' aspect of the IP addresses.
</li>
<li>With newly defined socket options for the shim layer, the
	application obtains additional control on locator
	management.
</li>
<li>The shim specific socket options are not specific to any
	address family (IPPROTO_IP or IPPROTO_IPV6) or any transport
	protocol (IPPROTO_TCP or IPPROTO_UDP).
</li>
</ol><p>

      
</p><br /><hr class="insert" />
<a name="fig-socket-api-model"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                         s1 s2      s3 s4
                          |  |       |  |
         +----------------|--|-------|--|----------------+
         |             +-------+   +-------+             |
         | IPPROTO_TCP |  TCP  |   |  UDP  |             |
         |             +-------+   +-------+             |
         |                |   \     /   |                |
         |                |    -----    |                |
         |                |   /     \   |                |
         |              +------+   +------+              |
         |   IPPROTO_IP | IPv4 |   | IPv6 | IPPROTO_IPV6 |
         |              +------+   +------+              |
         |                  \         /             SOL_SOCKET
         |          +--------\-------/--------+          |
         | SOL_SHIM |          shim           |          |
         |          +--------/-------\--------+          |
         |                  /         \                  |
         |              +------+   +------+              |
         |              | IPv4 |   | IPv6 |              |
         |              +------+   +------+              |
         |                  |          |                 |
         +------------------|----------|-----------------+
                            |          |
                          IPv4       IPv6
                        Datagram   Datagram

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: System model of socket API with shim layer&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
SHIM_ASSOCIATED</h3>

<p>The SHIM_ASSOCIATED option can be used to check whether the
	socket is associated with any shim context or not.
</p>
<p>This option is particularly meaningful in a case where the
	locator information of the received IP packet does not tell
	whether the identifier/locator adaptation is performed or not.
	Note that the EID pair and locator pair may be identical in
	some case.
</p>
<p>This option can be specified by getsockopt().  Thus, the
	option is read-only and the result (0 or 1) is set in the
	option value (the fourth argument of getsockopt()).
</p>
<p>Data type of the option value is integer.  The option value
	indicates presence of shim context.  A returned value 1 means
	that the socket is associated with a certain shim context at
	the shim layer, while a return value 0 indicates that there is
	no context associated with the socket.
</p>
<p>For example, the option can be used by the application as
	follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int optlen = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_ASSOCIATED, &amp;optval, &amp;optlen);
</pre></div>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
SHIM_DONTSHIM</h3>

<p>The SHIM_DONTSHIM option can be used to request the shim
	layer to not apply the multihoming support for the
	communication established over the socket.
</p>
<p>Data type of the option value is integer.  The option value
	indicates whether the multihoming shim support is deprecated
	or not.  The option value is binary (0 or 1).  By default, the
	value is set to 0, meaning that the shim layer applies
	identifier/locator adaptation for the communication.  In order
	to disable the socket option, the application should call
	setsockopt() with optval set as 0.
</p>
<p>For example, the option can be disabled by the application
	as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 0;

    setsockopt(fd, SOL_SHIM, SHIM_DONTSHIM, &amp;optval, sizeof(optval));
</pre></div>
<p>For example, the option value can be checked by the
	application as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_DONTSHIM, &amp;optval, &amp;len);
</pre></div>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
SHIM_HOT_STANDBY</h3>

<p>The SHIM_HOT_STANDBY option can be used to check if the
	shim layer uses hot-standby connection or not for the
	communication established over the socket.  Hot-standby
	connection is another working locator pair than the current
	locator pair.  Hence this option is effective only when there
	is a shim context associated with the socket.
</p>
<p>Data type of the option value is integer.
</p>
<p>The option value can be set by setsockopt().
</p>
<p>The option value can be read by getsockopt().
</p>
<p>By default, the value is set to 0, meaning that hot-standby
	connection is disabled.
</p>
<p>For example, the option can be activated by the application
	as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 1;

    setsockopt(fd, SOL_SHIM, SHIM_HOT_STANDBY, &amp;optval,
               sizeof(optval));
</pre></div>
<p>For example, the option value can be checked by the
	application as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_HOT_STANDBY, &amp;optval, &amp;len);
</pre></div>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
SHIM_PATHEXPLORE</h3>

<p>This option can be used to specify behavior of path
	exploration to be carried out.  Path exploration is a
	procedure to find an alternative locator pair when the host
	finds any problem with current locator pair.  A message used
	for finding an alternative locator pair is called a Probe
	message and it is sent per locator pair.  Default value is
	defined for Initial Probe Timeout (0.5 seconds) and Initial
	Probe (4 times) in the REAP specification.
</p>
<p>The option is effective only when there is a shim context
	associated with the socket.
</p>
<p>Data type of the option value is a pointer to the buffer
	where a set of information for path exploration is stored.
	The data structure is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p>By default, the option value is set as NULL, meaning that
	the option is disabled.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>For example, the parameters for the path exploration can be
	set as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim6_pathexplore pe;

    pe.pe_probenum = 4;        /* times */
    pe.pe_keepaliveto = 10;    /* seconds */
    pe.pe_initprobeto = 500;   /* milliseconds */
    pe.pe_reserved = 0;

    setsockopt(fd, SOL_SHIM, SHIM_PATHEXPLORE, &amp;pe, sizeof(pe));
</pre></div>
<p>For example, the parameters for the path exploration can be
	read as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim6_pathexplore pe;
    int len;

    len = sizeof(pe);

    getsockopt(fd, SOL_SHIM, SHIM_PATHEXPLORE, &amp;pe, &amp;len);
</pre></div>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.5"></a><h3>5.5.&nbsp;
SHIM_LOC_LOCAL_PREF</h3>

<p>The SHIM_LOC_LOCAL_PREF option can be used to read or set
	preferred locator on local side within a given context.  Hence
	this option is effective only when there is a shim context
	associated with the socket.
</p>
<p>Data type of the option value is a pointer to the specific
	data structure which stores the locator information.  The data
	structure is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p>By default, the option value is set as NULL, meaning that
	the option is disabled.
</p>
<p>The preferred locator can be set by setsockopt().
	Verification of the locator shall be done by the shim layer
	before updating the preferred locator.
</p>
<p>The preferred locator can be read by getsockopt().
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR will be returned when the
	validation of the specified locator failed.
</p>
<p>For example, a preferred locator can be set as follows.  It
	should be noted that some members of the shim_locator
	(lc_ifidx and lc_flags) are ignored in the write
	operation.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator lc;
    struct in6_addr ip6;

    /* ...set the locator (ip6)... */

    bzero(&amp;lc, sizeof(shim_locator));
    lc.lc_family = AF_INET6;  /* IPv6 */
    lc.lc_ifidx = 0;
    lc.lc_flags = 0;
    lc.lc_preference = 255;
    memcpy(lc.lc_addr, &amp;ip6, sizeof(in6_addr));

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_PREF, &amp;lc,
               sizeof(optval));
</pre></div>
<p>For example, the preferred locator of the context can be
	read by application as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator lc;
    int len;

    len = sizeof(lc);

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_PREF, &amp;lc, &amp;len);
</pre></div>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.6"></a><h3>5.6.&nbsp;
SHIM_LOC_PEER_PREF</h3>

<p>The SHIM_LOC_PEER_PREF option can be used to read or set
	preferred locator on peer side within a given context.  Hence
	this option is effective only when there is a shim context
	associated with the socket.
</p>
<p>Data type of the option value is a pointer to the specific
	data structure which stores the locator information.  The data
	structure is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p>By default, the option value is set as NULL, meaning that
	the option is disabled.
</p>
<p>The preferred locator can be set by setsockopt().
	Necessary verification of the locator shall be done by the
	shim layer before updating the preferred locator.
</p>
<p>The preferred locator can be read by getsockopt().
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR will be returned when the
	validation of the specified locator failed.
</p>
<p>For example, a preferred locator can be set as follows.  It
	should be noted that some members of the shim_locator
	(lc_ifidx and lc_flags) are ignored in the write
	operation.
</p>
<p>The usage of the option is same as that of
	SHIM_LOC_LOCAL_PREF.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.7"></a><h3>5.7.&nbsp;
SHIM_LOC_LOCAL_RECV</h3>

<p>The SHIM_LOC_LOCAL_RECV option can be used to request the
	shim layer to store the destination locator of the received IP
	packet in an ancillary data object which can be accessed by
	recvmsg().  Hence this option is effective only when there is
	a shim context associated with the socket.
</p>
<p>Data type of the option value is integer. The option value
	should be binary (0 or 1).  By default, the option value is
	set to 0, meaning that the option is disabled.
</p>
<p>The option value can be set by setsockopt().
</p>
<p>The option value can be read by getsockopt().
</p>
<p>See <a class='info' href='#sec-access-to-locinfo'>Section&nbsp;6<span> (</span><span class='info'>Ancillary Data for Multihoming Shim</span><span>)</span></a> for the
	procedure to access locator information stored in the
	ancillary data objects.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>For example, the option can be activated by the application
	as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 1;

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, &amp;optval,
               sizeof(optval));
</pre></div>
<p>For example, the option value can be checked by the
	application as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, &amp;optval, &amp;len);
</pre></div>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.8"></a><h3>5.8.&nbsp;
SHIM_LOC_PEER_RECV</h3>

<p>The SHIM_LOC_PEER_RECV option can be used to request the
	shim layer to store the source locator of the received IP
	packet in an ancillary data object which can be accessed by
	recvmsg().  Hence this option is effective only when there is
	a shim context associated with the socket.
</p>
<p>Data type of the option value is integer. The option value
	should be binary (0 or 1).  By default, the option value is
	set to 0, meaning that the option is disabled.
</p>
<p>The option value can be set by setsockopt().
</p>
<p>The option value can be read by getsockopt().
</p>
<p>See <a class='info' href='#sec-access-to-locinfo'>Section&nbsp;6<span> (</span><span class='info'>Ancillary Data for Multihoming Shim</span><span>)</span></a> for the
	procedure to access locator information stored in the
	ancillary data objects.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>The usage of the option is same as that of
	SHIM_LOC_LOCAL_RECV option.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.9"></a><h3>5.9.&nbsp;
SHIM_LOC_LOCAL_SEND</h3>

<p>The SHIM_LOC_LOCAL_SEND option can be used to request the
	shim layer to use specific locator for the source locator of
	IP packets to be sent from the socket.  Hence this option is
	effective only when there is a shim context associated with
	the socket.
</p>
<p>Data type of option value is pointer to shim_locator data
	structure.
</p>
<p>The local locator can be specified by setsockopt()
	providing a valid locator which is stored in a shim_locator
	data structure.  When a zero-filled locator is specified,
	pre-existing setting of local locator is deactivated.
</p>
<p>The local locator specified can be obtained by
	getsockopt().  The locator can be obtained from the option
	value.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR when invalid locator is
	specified.
</p>
<p>For example, a preferred local locator can be specified as
	follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator locator;
    struct in6_addr ia6;

    /* an IPv6 address preferred for the source locator is copied
       to the parameter ia6 */

    memset(&amp;locator, 0, sizeof(locator));

    /* fill shim_locator data structure */
    locator.lc_family = AF_INET6;
    locator.lc_ifidx = 1;
    locator.lc_flags = 0;
    locator.lc_preference = 0;
    memcpy(&amp;locator.lc_addr, &amp;ia6, sizeof(ia6));

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_SEND, &amp;locator,
               sizeof(locator));
</pre></div>
<p>For example, a preferred local locator can be read as
	follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator locator;

    memset(&amp;locator, 0, sizeof(locator));

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_SEND, &amp;locator,
               sizeof(locator));

    /* check locator */
</pre></div>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.10"></a><h3>5.10.&nbsp;
SHIM_LOC_PEER_SEND</h3>

<p>The SHIM_LOC_PEER_SEND option can be used to request the
	shim layer to use specific locator for the destination locator
	of IP packets to be sent from the socket.  Hence this option
	is effective only when there is a shim context associated with
	the socket.
</p>
<p>Data type of option value is pointer to shim_locator data
	structure.
</p>
<p>The remote locator can be specified by setsockopt()
	providing a valid locator which is stored in a shim_locator
	data structure.  When a zero-filled locator is specified,
	pre-existing setting of remote locator is deactivated.
</p>
<p>The remote locator specified can be obtained by
	getsockopt().  The locator can be obtained from the option
	value.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR when invalid locator is
	specified.
</p>
<p>The usage of the option is as the same as that of
	SHIM_LOC_LOCAL_SEND option.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.11"></a><h3>5.11.&nbsp;
SHIM_LOCLIST_LOCAL</h3>

<p>The SHIM_LOCLIST_LOCAL option can be used to read or set
	the locator list associated with the local EID of the shim
	context associated with the socket.  Hence this option is
	effective only when there is a shim context associated with
	the socket.
</p>
<p>Data type of option value is pointer to the buffer where a
	locator list is stored.  See <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a> for the data structure for
	storing the locator information.  By default, the option value
	is set as NULL, meaning that the option is disabled.
</p>
<p>The locator list can be read by getsockopt().  Note that
	the size of the buffer pointed by optval argument should be
	large enough to store an array of locator information.  The
	number of the locator information is not known beforehand.
</p>
<p>The locator list can be set by setsockopt().  The buffer
	pointed by optval argument should contain an array of locator
	list.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR will be returned when the
	validation of the specified locator failed.
</p>
<p>For example, a list of locators to be associated with the
	local EID can be specified as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator locators[SHIM_MAX_LOCATORS];
    struct sockaddr_in *sin;
    struct sockaddr_in6 *sin6;

    memset(locators, 0, sizeof(locators));

    ...

    /* obtain local IP addresses from local interfaces */

    ...

    /* first locator (an IPv6 address) */
    locators[0].lc_family = AF_INET6;
    locators[0].lc_ifidx = 0;
    locators[0].lc_flags = 0;
    locators[0].lc_preference = 1;
    memcpy(&amp;locators[0].lc_addr, &amp;sa6-&gt;sin6_addr,
           sizeof(sa6-&gt;sin6_addr));

    ...

    /* second locator (an IPv4 address) */
    locators[1].lc_family = AF_INET;
    locators[1].lc_ifidx = 0;
    locators[1].lc_flags = 0;
    locators[1].lc_preference = 0;
    memcpy(&amp;locators[1].lc_addr, &amp;sa-&gt;sin_addr, sizeof(sa-&gt;sin_addr));

    setsockopt(fd, SOL_SHIM, SHIM_LOCLIST_LOCAL, locators,
               sizeof(locators));
</pre></div>
<p>For example, a list of locators that are associated with the
	local EID can be obtained as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator locators[SHIM_MAX_LOCATORS];

    memset(locators, 0, sizeof(locators));

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, locators,
               sizeof(locators));

    /* parse locators */
    ...

</pre></div>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.12"></a><h3>5.12.&nbsp;
SHIM_LOCLIST_PEER</h3>

<p>The SHIM_LOCLIST_PEER option can be used to read or set the
	locator list associated with the peer EID of the shim context
	associated with the socket.  Hence this option is effective
	only when there is a shim context associated with the
	socket.
</p>
<p>Data type of option value is pointer to the buffer where a
	locator list is stored.  See <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a> for the data structure for
	storing the locator information.  By default, the option value
	is set as NULL, meaning that the option is disabled.
</p>
<p>The locator list can be read by getsockopt().  Note that
	the size of the buffer pointed by optval argument should be
	large enough to store an array of locator information.  The
	number of the locator information is not known beforehand.
</p>
<p>The locator list can be set by setsockopt().  The buffer
	pointed by optval argument should contain an array of locator
	list.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR will be returned when the
	validation of the specified locator failed.
</p>
<p>The usage of the option is same as that of
	SHIM_LOCLIST_LOCAL.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.13"></a><h3>5.13.&nbsp;
SHIM_APP_TIMEOUT</h3>

<p>The SHIM_APP_TIMEOUT option indicates timeout value for
	application to detect failure.  Hence this option is effective
	only when there is a shim context associated with the
	socket.
</p>
<p>Data type of the option value is integer.  The value
	indicates the period of timeout in seconds to send a REAP
	Keepalive message since the last outbound traffic.  By
	default, the option value is set as 0, meaning that the option
	is disabled.  When the option is disabled, the REAP mechanism
	follows its default value of Send Timeout value as specified
	in <a class='info' href='#I-D.ietf-shim6-failure-detection'>[I&#8209;D.ietf&#8209;shim6&#8209;failure&#8209;detection]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration Protocol for IPv6  Multihoming,&rdquo; January&nbsp;2008.</span><span>)</span></a>
</p>
<p>If the timeout value specified is longer than the Send
	Timeout configured in the REAP component, the REAP Keepalive
	message should be suppressed.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>For example, a specific timeout value can be configured by
	the application as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 15; /* 15 seconds */

    setsockopt(fd, SOL_SHIM, SHIM_APP_TIMEOUT, &amp;optval,
               sizeof(optval));
</pre></div>
<p>For example, the option value namely the period of timeout
	can be checked by the application as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_APP_TIMEOUT, &amp;optval, &amp;len);
</pre></div>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.14"></a><h3>5.14.&nbsp;
SHIM_DEFERRED_CONTEXT_SETUP</h3>

<p>The SHIM_DEFERRED_CONTEXT_SETUP option indicates how
	initiation of context setup is made in terms of timing (before
	or after) the initial communication flow.  Deferred context
	means that the establishment of context does not put
	additional delay for an initial transaction.
</p>
<p>Data type for the option value is integer.  The option
	value should binary (0 or 1).  By default, the value is set as
	1, meaning that the context setup is deferred.  In order to
	disable the option, the application should call setsockopt()
	with option value set as 0.
</p>
<p>However, it should be noted that in some case, deferred
	context setup is not possible; given EID is non-routable
	address and there is no way to transmit any IP packet unless
	there is a context providing the locators.  In such case,
	context should be established prior to the communication.
</p>
<p>For example, the option can be disabled by the application
	as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 0;

    setsockopt(fd, SOL_SHIM, SHIM_DEFERRED_CONTEXT_SETUP,
               &amp;optval, sizeof(optval));
</pre></div>
<p>For example, the option value can be checked by the
	application as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_DEFERRED_CONTEXT_SETUP,
               &amp;optval, &amp;len);
</pre></div>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.15"></a><h3>5.15.&nbsp;
Error Handling</h3>

<p>If successful, getsockopt() and setsockopt() return 0;
	otherwise, the functions return -1 and set errno to indicate
	error.
</p>
<p>The followings are errno codes newly defined for some shim
	specific socket options indicating that the getsockopt() or
	setsockopt() finished incompletely:<br />
<br />


	</p>
<blockquote class="text"><dl>
<dt>EINVALIDLOCATOR</dt>
<dd>This
	  indicates that at least one of the necessary validations
	  inside the shim layer for the specified locator has failed.
	  In case of SHIM6, there are two kinds of verifications
	  required for security reasons prior to sending an IP packet
	  to the peer's new locator; one is return routability (check
	  if the peer is actually willing to receive data with the
	  specified locator) and the other is verifications based on
	  given crypto identifier mechanisms <a class='info' href='#RFC3972'>[RFC3972]<span> (</span><span class='info'>Aura, T., &ldquo;Cryptographically Generated Addresses (CGA),&rdquo; March&nbsp;2005.</span><span>)</span></a>,
	  <a class='info' href='#I-D.ietf-shim6-hba'>[I&#8209;D.ietf&#8209;shim6&#8209;hba]<span> (</span><span class='info'>Bagnulo, M., &ldquo;Hash Based Addresses (HBA),&rdquo; December&nbsp;2007.</span><span>)</span></a>.
</dd>
</dl></blockquote><p>

	
</p>
<a name="sec-access-to-locinfo"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Ancillary Data for Multihoming Shim</h3>

<p>In this section, definition and usage of the ancillary data
      which is specific to multihoming shim are provided.
</p>
<p>As defined in Posix standard, sendmsg() and recvmsg() take
      msghdr structure as its argument and they can additionally
      handle control information along with data.  <a class='info' href='#fig-msghdr'>Figure&nbsp;3<span> (</span><span class='info'>msghdr structure</span><span>)</span></a> shows the msghdr structure which is
      defined in &lt;sys/socket.h>.  msg_control member holds a
      pointer to the buffer where the shim specific ancillary data
      objects can be stored in addition to other ancillary data
      objects.
</p><br /><hr class="insert" />
<a name="fig-msghdr"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     struct msghdr {
             caddr_t msg_name;       /* optional address */
             u_int   msg_namelen;    /* size of address */
             struct  iovec *msg_iov; /* scatter/gather array */
             u_int   msg_iovlen;     /* # elements in msg_iov */
             caddr_t msg_control;    /* ancillary data, see below */
             u_int   msg_controllen; /* ancillary data buffer len */
             int     msg_flags;      /* flags on received message */
     };
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: msghdr structure&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The buffer pointed from the msg_control member of the msghdr
      structure may contain a locator information which is a single
      locator and it should be possible to process them with the
      existing macros defined in Posix and <a class='info' href='#RFC3542'>[RFC3542]<span> (</span><span class='info'>Stevens, W., Thomas, M., Nordmark, E., and T. Jinmei, &ldquo;Advanced Sockets Application Program Interface (API) 	  for IPv6,&rdquo; May&nbsp;2003.</span><span>)</span></a>.
      Each cmsghdr{} should be followed by data which stores a single
      locator.
</p>
<p>In case of non-connected socket, msg_name member stores the
      socket address of the peer which should be considered as an
      identifier rather than a locator. The locator of the peer node
      should be retrieved by SHIM_LOC_PEER_RECV as specified
      below.
</p>
<p><a class='info' href='#tab-shim-ancillary-data'>Table&nbsp;2<span> (</span><span class='info'>Shim specific ancillary data</span><span>)</span></a> is a list of the
      shim specific ancillary data which can be used for recvmsg() or
      sendmsg().  In any case, SOL_SHIM must be set as cmsg_level.
</p><br /><hr class="insert" />
<a name="tab-shim-ancillary-data"></a>
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left"><col align="left"><col align="left">
<tr><th align="left">cmsg_type</th><th align="left">sendmsg()</th><th align="left">recvmsg()</th><th align="left">cmsg_data[]</th></tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_RECV</td>
<td align="left">&nbsp;</td>
<td align="left">o</td>
<td align="left">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_RECV</td>
<td align="left">&nbsp;</td>
<td align="left">o</td>
<td align="left">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_SEND</td>
<td align="left">o</td>
<td align="left">&nbsp;</td>
<td align="left">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_SEND</td>
<td align="left">o</td>
<td align="left">&nbsp;</td>
<td align="left">*1</td>
</tr>
<tr>
<td align="left">SHIM_FEEDBACK</td>
<td align="left">o</td>
<td align="left">&nbsp;</td>
<td align="left">shim_feedback{}</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Table 2: Shim specific ancillary data&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>*1: cmsg_data[] should include padding (if necessary) and a
      single sockaddr_in{}/sockaddr_in6{}.
</p>
<p>It should be noted that the above ancillary data can only be
      handled in UDP and raw sockets, not in TCP sockets because there
      is no one-to-one mapping of send/receive operations and the TCP
      segments being transmitted/received.
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Get Locator Information from Incoming Packet</h3>

<p>Application can get locator information from the received
	IP packet by specifying the shim specific socket options for
	the socket.  When SHIM_LOC_LOCAL_RECV and/or
	SHIM_LOC_PEER_RECV socket options are set, the application can
	retrieve local and/or remote locator from the ancillary
	data.
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Specify Locator Information for Outgoing Packet</h3>

<p>Application can specify the locators to be used for
	transmitting an IP packet by sendmsg().  When ancillary data
	of cmsg_type SHIM_LOC_LOCAL_SEND and/or SHIM_LOC_PEER_SEND are
	specified, the application can explicitly specify source
	and/or destination locators to be used for the communication
	over the socket.
</p>
<p>In addition, the application can specify the outgoing
	interface by SHIM_IF_SEND ancillary data.  The ancillary data
	should contain the interface identifier of the physical
	interface over which the application expects the packet to be
	transmitted.
</p>
<p>Note that the effect is limited to the datagram transmitted
	by the sendmsg().
</p>
<p>If the specified locator pair seems to be valid, the shim
	layer overrides the locator of the IP packet as requested.
</p>
<p>An error EINVALIDLOCATOR will be returned when validation
	of the specified locator failed.
</p>
<a name="sec-feedback"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Notification from Application to Multihoming Shim</h3>

<p>Application may provide feedback to the shim layer about
	the communication status.  Such feedback is particularly
	useful for the shim layer in the absence of REAP mechanism to
	monitor the reachability status of currently used locator pair
	in a given shim context.
</p>
<p>The notification can be made by sendmsg() specifying a new
	ancillary data called SHIM_FEEDBACK.  The ancillary data can
	be handled by specifying SHIM_FEEDBACK option in
	cmsg_type.
</p>
<p>An error ENOENT will be returned when there is no context
	associated with the socket.
</p>
<p>See <a class='info' href='#sec-feedback-info'>Section&nbsp;7.3<span> (</span><span class='info'>Feedback Information</span><span>)</span></a> for details of the
	data structure to be used.  Note that this specification does
	not specify the exact behavior of the shim layer when a
	feedback information is given by an application.
</p>
<a name="sec-data-structures"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Data Structures</h3>

<p>In this section, data structures specifically defined for the
      multihoming shim layer are introduced.  Those data structure are
      either used as a parameter for setsockopt()/getsockopt() (as
      mentioned in <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Layer</span><span>)</span></a>) or a
      parameter for ancillary data to be processed by
      sendmsg()/recvmsg() (as mentioned in <a class='info' href='#sec-access-to-locinfo'>Section&nbsp;6<span> (</span><span class='info'>Ancillary Data for Multihoming Shim</span><span>)</span></a>).
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Placeholder for Locator Information</h3>

<p>As defined in <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Layer</span><span>)</span></a>, the
	SHIM_LOC_LOCAL_PREF, SHIM_LOC_PEER_PREF, SHIM_LOCLIST_LOCAL,
	and SHIM_LOCLIST_PEER socket options need to handle one or
	more locator information.  Locator information includes not
	only the locator itself but also additional information about
	the locator which is useful for locator management.  A new
	data structure is defined to serve as a placeholder for the
	locator information.
</p>
<p><a class='info' href='#fig-shim-locator'>Figure&nbsp;4<span> (</span><span class='info'>shim locator structure</span><span>)</span></a> illustrates the data
	structure called shim_locator which stores a locator
	information.

	<br /><hr class="insert" />
<a name="fig-shim-locator"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     struct shim_locator {
             uint8_t   lc_family;     /* address family */
             uint8_t   lc_ifidx;      /* interface index */
             uint8_t   lc_flags;      /* flags */
             uint8_t   lc_preference; /* preference value */
             uint8_t   lc_addr[16];   /* address data */
     };
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: shim locator structure&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


	</p>
<blockquote class="text"><dl>
<dt>lc_family</dt>
<dd>Address
	  family of the locator (e.g. AF_INET, AF_INET6).  It is
	  required that the parameter contains non-zero value
	  indicating the exact address family of the locator.
</dd>
<dt>lc_ifidx</dt>
<dd>Interface
	  index of the network interface to which the locator is
	  assigned.  This field should be valid only in read
	  (getsockopt()) operation.
</dd>
<dt>lc_flags</dt>
<dd>Each bit of
	  the flags represents a specific characteristics of the
	  locator.  HBA is defined as 0x01.  CGA is defined as 0x02.
	  The other bits are TBD.
</dd>
<dt>lc_preference</dt>
<dd>Indicates preference of the locator.  The
	  preference is represented by integer.
</dd>
<dt>lc_addr</dt>
<dd>Contains the
	  locator.  For the cases where a locator whose size is
	  smaller than 16 bytes, encoding rule should be provided for
	  each locator of a given address family.  For instance, in
	  case of AF_INET (IPv4), the first 4 bytes of lc_addr should
	  contain the IPv4 address.
</dd>
</dl></blockquote><p>
	
</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
Path Exploration Parameter</h3>

<p>As defined in <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Layer</span><span>)</span></a>,
	SHIM_PATHEXPLORE allows application to set or read the
	parameters for path exploration and failure detection.  A new
	data structure called shim_pathexplore is defined to store the
	necessary parameters.  <a class='info' href='#fig-path-explore'>Figure&nbsp;5<span> (</span><span class='info'>path explore structure</span><span>)</span></a>
	illustrates the data structure.  The data structure can be
	used by getsockopt() or setsockopt() as an argument.

	<br /><hr class="insert" />
<a name="fig-path-explore"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     struct shim_pathexplore {
             uint8_t   pe_probenum;      /* # of initial probe */
             uint8_t   pe_keepaliveto;   /* Keepalive Timeout */
             uint16_t  pe_initprobeto;   /* Initial Probe Timeout */
             uint32_t  pe_reserved;      /* reserved */
     };
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: path explore structure&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


	</p>
<blockquote class="text"><dl>
<dt>pe_probenum</dt>
<dd>
	    
	    Indicates the number of initial probe messages to be sent.
	    Default value of this parameter should follow what is
	    specified in <a class='info' href='#I-D.ietf-shim6-failure-detection'>[I&#8209;D.ietf&#8209;shim6&#8209;failure&#8209;detection]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration Protocol for IPv6  Multihoming,&rdquo; January&nbsp;2008.</span><span>)</span></a>.
	  
</dd>
<dt>pe_keepaliveto</dt>
<dd>
	    
	    Indicates timeout value for detecting a failure when the
	    host does not receive any packets for a certain period of
	    time while there is outbound traffic.  When the timer
	    expires, path exploration procedure will be carried out by
	    sending a REAP Probe message.  Default value of this
	    parameter should follow what is specified in <a class='info' href='#I-D.ietf-shim6-failure-detection'>[I&#8209;D.ietf&#8209;shim6&#8209;failure&#8209;detection]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration Protocol for IPv6  Multihoming,&rdquo; January&nbsp;2008.</span><span>)</span></a>.
	  
</dd>
<dt>pe_initprobeto</dt>
<dd>
	    
	    Indicates retransmission timer of REAP Probe message in
	    milliseconds.  Note that this timer is applied before
	    exponential back-off is started.  A REAP Probe message for
	    the same locator pair may be retransmitted.  Default value
	    of this parameter should follow what is specified in <a class='info' href='#I-D.ietf-shim6-failure-detection'>[I&#8209;D.ietf&#8209;shim6&#8209;failure&#8209;detection]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration Protocol for IPv6  Multihoming,&rdquo; January&nbsp;2008.</span><span>)</span></a>.
	  
</dd>
<dt>pe_reserved</dt>
<dd>
	    
	    A reserved field for future extension.  By default, the
	    field should be initialized with zero.
	  
</dd>
</dl></blockquote><p>
	
</p>
<a name="sec-feedback-info"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
Feedback Information</h3>

<p>As mentioned in <a class='info' href='#sec-feedback'>Section&nbsp;6.3<span> (</span><span class='info'>Notification from Application to Multihoming Shim</span><span>)</span></a>, applications
	can inform the shim layer about the status of unicast
	reachability of the locator pair currently in use.  The
	feedback information can be handled by using ancillary data
	called SHIM_FEEDBACK.  A new data structure named
	shim_feedback is illustrated in <a class='info' href='#fig-feedback-info'>Figure&nbsp;6<span> (</span><span class='info'>feedback information structure</span><span>)</span></a>).

	<br /><hr class="insert" />
<a name="fig-feedback-info"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     struct shim_feedback {
             uint8_t   fb_direction;    /* direction of traffic */
             uint8_t   fb_indicator;    /* indicator (1-3) */
             uint16_t  fb_reserved;     /* reserved */
     };
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: feedback information structure&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


	</p>
<blockquote class="text"><dl>
<dt>direction</dt>
<dd>
	    
	    Indicates direction of reachability between a locator pair
	    in question.  A value 0 indicates outbound and a value 1
	    indicates inbound.
	  
</dd>
<dt>indicator</dt>
<dd>
	    
	    A value indicating the degree of satisfaction of a
	    unidirectional reachability for a given locator pair.
	  
	    
<ul class="text">
<li>0: Default value.  Whenever this value is specified
	      the feedback information must not be processed by the
	      shim layer.
</li>
<li>1: Unable to connect.  There is no unidirectional
	      reachability between the locator pair in question.
</li>
<li>2: Unsatisfactory.  The application is not satisfied
	      with the unidirectional reachability between the locator
	      pair in question.
</li>
<li>3: Satisfactory.  There is satisfactory
	      unidirectional reachability between the locator pair in
	      question.
</li>
</ul>
	  
</dd>
<dt>reserved</dt>
<dd>
	    
	    Reserved field.  Must be ignored by the receiver.
	  
</dd>
</dl></blockquote><p>

	
</p>
<a name="sec-implications-for-legacyapi"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Implications for Existing Socket API Extensions</h3>

<p>Some of the socket options defined in this document have some
      overlapping with existing socket API and care should be made for
      the usage not to confuse the features.
</p>
<p>The socket options for requesting specific locators to be
      used for a given transaction (SHIM_LOC_LOCAL_PREF and
      SHIM_LOC_PEER_PREF) are semantically similar to the existing
      socket API (IPV6_PKTINFO).  The socket options for obtaining the
      locator information from the received IP packet
      (SHIM_LOC_LOCAL_RECV and SHIM_LOC_PEER_RECV) are semantically
      similar to the existing socket API (IP_RECVDSTADDR and
      IPV6_PKTINFO).
</p>
<p>In IPv4, application can obtain the destination IP address of
      the received IP packet (IP_RECVDSTADDR).  If the shim layer
      performs identifier/locator adaptation for the received packet,
      the destination EID should be stored in the ancillary data
      (IP_RECVDSTADDR).
</p>
<p>In IPv6, <a class='info' href='#RFC3542'>[RFC3542]<span> (</span><span class='info'>Stevens, W., Thomas, M., Nordmark, E., and T. Jinmei, &ldquo;Advanced Sockets Application Program Interface (API) 	  for IPv6,&rdquo; May&nbsp;2003.</span><span>)</span></a> defines that IPV6_PKTINFO
      can be used to specify source IPv6 address and the outgoing
      interface for outgoing packets, and retrieve destination IPv6
      address and receiving interface for incoming packets.  This
      information is stored in ancillary data being IPV6_PKTINFO
      specified as cmsg_type.  Existing socket API should continue to
      work above the shim layer, that is, the IP addresses handled in
      IPV6_PKTINFO should be EIDs, not the locators.
</p>
<p>Baseline is that the above existing socket API
      (IP_RECVDSTADDR and IPV6_PKTINFO) is assumed to work above the
      multihoming shim layer.  In other words, the IP addresses those
      socket options deal with are EIDs rather than locators.
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Resolving Conflicts with Preference Values</h3>

<p>Since the multihoming shim API allows application to specify
      preference value for the context which is associated with the
      socket instance, there may be a conflict with preference values
      specified by different applications.  For instance, application
      A and B may establish communication over the same EID pair while
      each application have different preference in their choice of
      local locator.
</p>
<p>SHIM6 supports a notion of forking context in which a context
      is split when there is a conflict with preference values
      specified by multiple applications.  Thus, context forking can
      simply resolve the conflicting situation which may be caused by
      the use of socket options for multihoming shim layer.
</p>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.1"></a><h3>9.1.&nbsp;
Implicit Forking</h3>

<p>Socket options defined in <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Layer</span><span>)</span></a> may cause conflicting
	situation when the target context is shared by multiple
	applications.  In such case, socket handler and the
	multihoming shim layer should react as follows; socket handler
	should inform the shim layer that context forking is required.
	In SHIM6, when a context is forked, an unique identifier
	called Forked Instance Identifier (FII) is assigned to the
	newly forked context.  The forked context is then exclusively
	associated with the socket through which non-default
	preference value was specified.  The forked context is
	maintained by the multihoming shim layer during the lifetime
	of associated socket instance.  When the socket is closed, the
	multihoming shim layer SHOULD delete associated context.  In
	this way, garbage collection can be carried out to cleanup
	unused forked contexts.  Upon garbage collection, every forked
	context SHOULD be checked if there is no socket (process)
	associated with the context.  If there is none, the forked
	context should be deleted.  When a forked context is torn
	down, SHIM6 should notify the peer about the deletion of
	forked context.
</p>
<p>As opposed to socket options, context forking MUST NOT be
	triggered by any use of ancillary data that are specific to
	multihoming shim defined in <a class='info' href='#sec-access-to-locinfo'>Section&nbsp;6<span> (</span><span class='info'>Ancillary Data for Multihoming Shim</span><span>)</span></a>.
</p>
<a name="sec-discussion"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Discussion</h3>

<p>In this section, open issues are introduced.
</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1"></a><h3>10.1.&nbsp;
Naming at Socket Layer</h3>

<p>getsockname() and getpeername() system calls are used to
	obtain the 'name' of endpoint which is actually a pair of IP
	address and port number assigned to a given socket.
	getsockname() is used when an application wants to obtain the
	local IP address and port number assigned for a given socket
	instance.  getpeername() is used when an application wants to
	obtain the remote IP address and port number.
</p>
<p>The above is based on a traditional system model of the
	socket API where an IP address is expected to play both the
	role of identifier and the role of locator.
</p>
<p>In a system model where a shim layer exists inside the IP
	layer, both getsockname() and getpeername() deal with
	identifiers, namely EIDs.  In this sense, the shim layer
	serves to (1) hide locators and (2) provide access to the
	identifier for the application over the legacy socket
	APIs.
</p>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2"></a><h3>10.2.&nbsp;
Additional Requirements from Application</h3>

<p>At the moment, it is not certain if following requirements
	are common in all the multihomed environments (SHIM6 and HIP).
	These are mainly identified during discussions made on SHIM6
	WG mailing list.
	
	</p>
<ul class="text">
<li>The application should be able to set preferences for the
	  locators, local and remote one and also to the preferences
	  of the local locators that will be passed to the peer.
</li>
</ul><p>
	
</p>
<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.3"></a><h3>10.3.&nbsp;
Issues of Header Conversion among Different Address Family</h3>

<p>The shim layer performs identifier/locator adaptation.
	Therefore, in some case, the whole IP header can be replaced
	with new IP header of a different address family
	(e.g. conversion from IPv4 to IPv6 or vice versa).  Hence,
	there is an issue how to make the conversion with minimum
	impact.  Note that this issue is common in other protocol
	conversion such as SIIT<a class='info' href='#RFC2765'>[RFC2765]<span> (</span><span class='info'>Nordmark, E., &ldquo;Stateless IP/ICMP Translation Algorithm (SIIT),&rdquo; February&nbsp;2000.</span><span>)</span></a>.
</p>
<p>As addressed in SIIT specification, some of the features
	(IPv6 routing headers, hop-by-hop extension headers, or
	destination headers) from IPv6 are not convertible to IPv4.
	In addition, notion of source routing is not exactly the same
	in IPv4 and IPv6.  Hence, there is certain limitation in
	protocol conversion between IPv4 and IPv6.
</p>
<p>The question is how should the shim layer behave when it is
	face with limitation problem of protocol conversion. Should we
	introduce new error something like ENOSUITABLELOCATOR ?
</p>
<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.4"></a><h3>10.4.&nbsp;
Handling of Unknown Locator Provided by Application</h3>

<p>There might be a case where application provides the shim
	layer new locator with the SHIM_LOC_*_PREF socket options or
	SHIM_LOC_*_SEND ancillary data.  Then there is a question how
	should the shim layer treat the new locator informed by the
	application.
</p>
<p>In principle, locator information are exchanged by the shim
	protocol.  However, there might be a case where application
	acquires information about the locator and prefers to use it
	for its communication.
</p>
<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Changes</h3>

<a name="anchor29"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.1"></a><h3>11.1.&nbsp;
Changes from version 00 to version 01</h3>

<p>The followings are changes from version 00 to version 01:
	</p>
<ul class="text">
<li>Define shim_locator{} data type which is a placeholder for
	  locator.
</li>
<li>Define shim_pathexplore{} data type in which a set of
	  REAP parameters are stored.
</li>
<li>Remove descriptions about "stickiness" of socket options.
</li>
<li>Deprecate SHIM_IF_RECV and SHIM_IF_SEND socket options.
</li>
<li>Give default value and how to disable given socket
	  option.
</li>
</ul><p>
	
</p>
<a name="anchor30"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.2"></a><h3>11.2.&nbsp;
Changes from version 01 to version 02</h3>

<p>The followings are changes from version 01 to version 02:
	</p>
<ul class="text">
<li>Add section describing context forking.
</li>
<li>Rephrase conclusion section.
</li>
<li>Separate normative references from informative
	  references.
</li>
<li>Remove texts from discussion section that are not
	  relevant to the contents of the document.
</li>
<li>Add section describing change history (this section).
</li>
</ul><p>
	
</p>
<a name="anchor31"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.3"></a><h3>11.3.&nbsp;
Changes from version 02 to version 03</h3>

<p>The followings are changes from version 02 to version 03:
	</p>
<ul class="text">
<li>Add an Appendix section describing the issue of context
	  forking.
</li>
</ul><p>
	
</p>
<a name="anchor32"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.4"></a><h3>11.4.&nbsp;
Changes from version 03 to version 04</h3>

<p>The followings are changes from version 03 to version 04:
	</p>
<ul class="text">
<li>Updated reference.
</li>
<li>Correct typo and grammatical errors.
</li>
</ul><p>
	
</p>
<a name="anchor33"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11.5"></a><h3>11.5.&nbsp;
Changes from version 04 to version 05</h3>

<p>The followings are changes from version 04 to version 05:
	</p>
<ul class="text">
<li>Added definition of SHIM_FEEDBACK ancillary data.
</li>
<li>Added an example of code using the SHIM_LOCLIST_LOCAL
</li>
<li>Added SHIM_LOC_LOCAL_SEND and SHIM_LOC_PEER_SEND socket
	  options.
</li>
</ul><p>
	
</p>
<a name="anchor34"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
IANA Considerations</h3>

<p>This document contains no IANA consideration.
</p>
<a name="anchor35"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
Security Considerations</h3>

<p>This document does not specify any security mechanism for the
      shim layer.  Fundamentally, the shim layer has a potential to
      impose security threats, as it changes the source and/or
      destination IP addresses of the IP packet being sent or
      received.  Therefore, the basic assumption is that the security
      mechanism defined in each protocol of the shim layer is strictly
      applied.
</p>
<a name="anchor36"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
Conclusion</h3>

<p>In this document, the Application Program Interface (API) for
      multihoming shim layer is specified.  The socket API allows
      applications to have additional control of the locator
      management and interface to the REAP mechanism inside the
      multihoming shim layer.
</p>
<p>Socket options for multihoming shim layer can be used by
      getsockopt() and/or setsockopt() system calls.  Besides,
      applications can use some ancillary data that are specific to
      multihoming shim layer to get locator from received packet or to
      set locator for outgoing packet.
</p>
<p>From an architectural point of view, the socket API provides
      extends the existing socket API framework in the face of
      ID/Locator separation.  With regard to API that relate to IP
      address management, it is assured that existing socket API
      continue to work above the shim layer dealing with identifiers,
      while multihoming shim API deals with locators.
</p>
<a name="anchor37"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15"></a><h3>15.&nbsp;
Acknowledgments</h3>

<p>Authors would like to thank Jari Arkko who participated in
      the discussion that lead to the first version of this document,
      and Tatuya Jinmei who thoroughly reviewed the early version of
      this draft and provided detailed comments on socket API related
      issues.  Thomas Henderson provided valuable comments especially
      from HIP perspectives.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.16"></a><h3>16.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>16.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-shim6-failure-detection">[I-D.ietf-shim6-failure-detection]</a></td>
<td class="author-text">Arkko, J. and I. Beijnum, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-failure-detection-10.txt">Failure Detection and Locator Pair Exploration Protocol for IPv6  Multihoming</a>,&rdquo; draft-ietf-shim6-failure-detection-10 (work in progress), January&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-failure-detection-10.txt">TXT</a>, <a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-failure-detection-10.pdf">PDF</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-shim6-proto">[I-D.ietf-shim6-proto]</a></td>
<td class="author-text">Bagnulo, M. and E. Nordmark, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-proto-09.txt">Level 3 multihoming shim protocol</a>,&rdquo; draft-ietf-shim6-proto-09 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-proto-09.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="POSIX">[POSIX]</a></td>
<td class="author-text">&ldquo;<a href="http://www.opengroup.org/austin">IEEE Std. 1003.1-2001 Standard for Information
	  Technology -- Portable Operating System Interface
	  (POSIX). Open group Technical Standard: Base Specifications,
	  Issue 6, http://www.opengroup.org/austin</a>,&rdquo; December&nbsp;2001.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3542">[RFC3542]</a></td>
<td class="author-text">Stevens, W., Thomas, M., Nordmark, E., and T. Jinmei, &ldquo;<a href="http://tools.ietf.org/html/rfc3542">Advanced Sockets Application Program Interface (API)
	  for IPv6</a>,&rdquo; RFC&nbsp;3542, May&nbsp;2003 (<a href="ftp://ftp.isi.edu/in-notes/rfc3542.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4423">[RFC4423]</a></td>
<td class="author-text">Moskowitz, R. and P. Nikander, &ldquo;<a href="http://tools.ietf.org/html/rfc4423">Host Identity Protocol (HIP) Architecture</a>,&rdquo; RFC&nbsp;4423, May&nbsp;2006 (<a href="ftp://ftp.isi.edu/in-notes/rfc4423.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>16.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-shim6-app-refer">[I-D.ietf-shim6-app-refer]</a></td>
<td class="author-text">Nordmark, E., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-app-refer-00.txt">Shim6 Application Referral Issues</a>,&rdquo; draft-ietf-shim6-app-refer-00 (work in progress), July&nbsp;2005 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-app-refer-00.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-shim6-hba">[I-D.ietf-shim6-hba]</a></td>
<td class="author-text">Bagnulo, M., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-hba-05.txt">Hash Based Addresses (HBA)</a>,&rdquo; draft-ietf-shim6-hba-05 (work in progress), December&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-hba-05.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2765">[RFC2765]</a></td>
<td class="author-text">Nordmark, E., &ldquo;<a href="http://tools.ietf.org/html/rfc2765">Stateless IP/ICMP Translation Algorithm (SIIT)</a>,&rdquo; RFC&nbsp;2765, February&nbsp;2000 (<a href="ftp://ftp.isi.edu/in-notes/rfc2765.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3972">[RFC3972]</a></td>
<td class="author-text">Aura, T., &ldquo;<a href="http://tools.ietf.org/html/rfc3972">Cryptographically Generated Addresses (CGA)</a>,&rdquo; RFC&nbsp;3972, March&nbsp;2005 (<a href="ftp://ftp.isi.edu/in-notes/rfc3972.txt">TXT</a>).</td></tr>
</table>

<a name="anchor40"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Context Forking</h3>

<p>In this section, an issue concerning context forking and its
      relation to the multihoming shim API are discussed.
</p>
<p>SHIM6 supports a notion of context forking.  A peer may
      decide to fork a context for certain reason (e.g. upper layer
      protocol prefers to use different locator pair than the one
      defined in available context).  The procedure of forking context
      is done similar to the normal context establishment, performing
      the 4-way message exchange.  A peer who has decided to fork a
      context initiates the context establishment.  Hereafter, we call
      this peer initiator.
</p>
<p>Once the forked context is established between the peers, on
      the initiator side, it is possible to apply forked context to
      the packet flow since the system maintains an association
      between the forked context and the socket owned by the
      application that has requested the context forking.  How this
      association is maintained is implementation specific issue.
      However, on the responder side, there is a question on how the
      outbound packet can be multiplexed by the shim layer.  Since
      there are more than one SHIM6 contexts that match with the ULID
      pair of the packet flow.  There is a need to differentiate
      packet flows not only by the ULID pairs but some other
      information and associate a given packet flow with specific
      context.
</p>
<p><a class='info' href='#fig-context-forking'>Figure&nbsp;7<span> (</span><span class='info'>context forking</span><span>)</span></a> gives an example of a
      scenario where two communicating peers fork a context.
      Initially, there has been a single transaction between the
      peers, by the application 1 (App1).  Accordingly, another
      transaction is started, by application 2 (App2).  Both of the
      transactions are made based the same ULID pair.  The first
      context pair (Ctx1) is established for the transaction of App1.
      Given the requests from App2, the shim layer on Peer 1 decides
      to fork a context.  Accordingly, a forked context (Ctx2) is
      established between the peers, which should be exclusively
      applied to the transaction of App2.  Ideally, multiplexing and
      demultiplexing of packet flows that relate to App1 and App2
      should be done as illustrated in <a class='info' href='#fig-context-forking'>Figure&nbsp;7<span> (</span><span class='info'>context forking</span><span>)</span></a>.  However, as mentioned earlier,
      on the responder side, there is a problem with multiplexing the
      outbound packet flows of App1 and App2.

      <br /><hr class="insert" />
<a name="fig-context-forking"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Peer 1                                     Peer 2
         (initiator)                                (responder)

    +----+         +----+                      +----+         +----+
    |App1|         |App2|                      |App1|         |App2|
    +----+         +----+                      +----+         +----+
      |^             |^                          ^|             ^|
      v|             v|                          |v             |v
 -----S1-------------S2-----                -----S1-------------S2-----
      ||             ||                          ||             ||
      ||             ||                          ||             ||

     Ctx1           Ctx2                        Ctx1           Ctx2
 ULID:&lt;A1,B1&gt;   ULID:&lt;A1,B1&gt;                ULID:&lt;B1,A1&gt;    ULID:&lt;B1,A1&gt;
 Loc: &lt;A1,B2&gt;   Loc: &lt;A1,B3&gt;                Loc: &lt;B2,A1&gt;    Loc: &lt;B3,A1&gt;
 FII: 0         FII: 100                    FII: 0          FII: 100

      |^             |^                          ^|             ^|
      ||             ||                          ||             ||
      ||             ||                          ||             ||
      \..............||........................../|             ||
       \.............||.........................../             ||
                     ||                                         ||
                     \|........................................./|
                      \........................................../
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;7: context forking&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

      
</p>
<p>To overcome the problem mentioned above, there are some
      solutions.
</p>
<p>One viable approach is to let the system implicitly maintain
      an association between the socket and the associated context by
      keeping the record of inbound packet processing.  That is, the
      system stores the information about the context on which the
      inbound packet flow was demultiplexed.  The information
      comprises the ULID pair and FII of the context and is stored in
      the socket instance.  Later, the system can use the information
      to identify the associated context in outbound packet
      processing.  This approach should be feasible as far as there is
      bi-directional user traffic.
</p>
<p>Another viable approach is to extend SHIM6 protocol by adding
      capability of exchanging additional information to identify the
      packet flow from others which needs to be handled by a newly
      forked context.  The information exchange can be done during the
      context establishment.  The initiator appends 5 tuple of the
      packet flow to be handled by the newly forked context.  Note
      that the additional information provided by the 5 tuple are
      source and destination port numbers and upper layer protocol.
      The information is later used by the shim layer to multiplex the
      outbound packet flow on the responder side.
</p>
<p>The socket options for multihoming shim can be used by the
      application to trigger the context forking in implicit manner.
      The peer becomes an initiator in the establishment of the forked
      context.  Once the forked context is established between the
      peers, application on each end can influence the preference on
      context by utilizing the multihoming shim API.
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Miika Komu</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Helsinki Institute for Information
      Technology</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tammasaarenkatu 3</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Helsinki</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358503841531</td></tr>
<tr><td class="author" align="right">Fax:&nbsp;</td>
<td class="author-text">+35896949768</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:miika@iki.fi">miika@iki.fi</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.hiit.fi/">http://www.hiit.fi/</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Marcelo Bagnulo</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Universidad Carlos III de
      Madrid</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Av. Universidad 30</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Leganes  28911</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">SPAIN</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+34 91 6248837</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:marcelo@it.uc3m.es">marcelo@it.uc3m.es</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://it.uc3m.es/marcelo">http://it.uc3m.es/marcelo</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Kristian Slavov</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ericsson Research
      Nomadiclab</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hirsalantie 11</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jorvas  FI-02420</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 9 299 3286</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:kristian.slavov@ericsson.com">kristian.slavov@ericsson.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shinta Sugimoto (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nippon Ericsson K.K.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Koraku Mori Building</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1-4-14, Koraku, Bunkyo-ku</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tokyo  112-0004</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Japan</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+81 3 3830 2241</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:shinta.sugimoto@ericsson.com">shinta.sugimoto@ericsson.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
