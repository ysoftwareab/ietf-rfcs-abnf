<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Outgoing Packet Routing with MP-TCP</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Outgoing Packet Routing with MP-TCP">
<meta name="keywords" content="template">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Internet Engineering Task Force</td><td class="header">M. Handley</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">C. Raiciu</td></tr>
<tr><td class="header">Intended status: Experimental</td><td class="header">University College London</td></tr>
<tr><td class="header">Expires: April 23, 2010</td><td class="header">M. Bagnulo</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Universidad Carlos III de Madrid</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">October 20, 2009</td></tr>
</table></td></tr></table>
<h1><br />Outgoing Packet Routing with MP-TCP<br />draft-handley-mptcp-routing-00.txt</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on April 23, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>
	Multipath TCP extends the TCP protocol to allow multiple paths
	to be used simultaneously for the same TCP connection.  The
	different paths are typically provided using multiple IP
	addresses for the same end system, each address taken from a
	subnet that is routed differently.  In this document we
	describe a set of conventions for how to ensure that outgoing
	packets are routed in a manner consistent with the network
	topology and constraints on use of that topology such as those
	imposed by ingress filtering on IP address prefixes.
      
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Requirements Language<br />
<a href="#intro">2.</a>&nbsp;
Introduction<br />
<a href="#multiaddress">3.</a>&nbsp;
Multi-addressed Hosts<br />
<a href="#ideal">4.</a>&nbsp;
Idealized Host Routing Model<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">4.1.</a>&nbsp;
Interaction with NATs<br />
<a href="#routing">5.</a>&nbsp;
MP-TCP Interaction with Host Routing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#active">5.1.</a>&nbsp;
TCP Active End-System Behaviour<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">5.2.</a>&nbsp;
Passive Open of MP-TCP Subflows<br />
<a href="#anchor4">6.</a>&nbsp;
Example Scenarios<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">6.1.</a>&nbsp;
Multi-interface Host<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">6.2.</a>&nbsp;
Single-interface Host at Multihomed Site<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">6.2.1.</a>&nbsp;
Different Next-hop Routers<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">6.2.2.</a>&nbsp;
Single Next-hop Router<br />
<a href="#anchor9">7.</a>&nbsp;
IPv6 Considerations<br />
<a href="#Security">8.</a>&nbsp;
Security Considerations<br />
<a href="#rfc.references1">9.</a>&nbsp;
Normative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Requirements Language</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
        "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
        document are to be interpreted as described in <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [1].
</p>
<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Introduction</h3>

<p>
	<a class='info' href='#I-D.ford-mptcp-multiaddressed'>Multipath
	TCP<span> (</span><span class='info'>Ford, A., Raiciu, C., and M. Handley, &ldquo;TCP Extensions for Multipath Operation with Multiple Addresses,&rdquo; March&nbsp;2010.</span><span>)</span></a> [2] is an extension to the regular TCP protocol to
	allow multiple subflows to be established between the same pair of
	end systems, and for a single TCP connection to stripe its
	data across these subflows.  The intended benefits are
	improved performance, robustness, and pooling of network
	capacity.  In principle there are many ways to identify and
	distinguish the packets of these subflows, and to guide them
	towards different paths through the network.  One simple way
	to do this is to use multiple IP addresses at each endpoint.
      
</p>
<p>
	If a host is on a multi-homed network, or if it has multiple
	interfaces (e.g. 3G and WiFi on a smart phone), then each of
	these addresses can be routed via a different network provider
	giving path diversity.  For incoming traffic to the
	multi-addressed host, conventional IP routing will guide
	packets to the correct network link.  For outgoing traffic
	however, destination-based routing by itself is insufficient
	to ensure that packets are sent over the appropriate paths.
	Not only could this reduce the diversity of paths available,
	but ingress filtering by ISPs may cause inappropriately routed
	packets to be dropped.  This document describes a set of
	conventions that multipath-capable end-systems can follow to
	maximize the probability that packets reach their destination
	and to ensure that multiple paths can in fact be utilized.
      
</p>
<p>
	In the sections that follow, we will assume a particular model
	for how an end-system routing table should function.  This is
	both a strawman and an idealized model, and it is not
	necessarily expected that hosts will directly implement this
	model.  The intent though is to describe what we believe to be
	reasonable behavior rather than how to implement this
	behavior. 
      
</p>
<a name="multiaddress"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Multi-addressed Hosts</h3>

<p>
	Consider a host that has more than one network interface and
	that wishes to send and receive regular TCP flows over these
	interfaces.  To be able to receive packets on all of these
	interfaces, they are given IP addresses from different IP
	subnets.  These subnets will be advertised via IP routing so
	that they are reachable by the host's intended correspondents.
      
</p>
<p>
	For outgoing packets a host typically has a host routing table
	that defines which prefixes should be routed via each possible
	next hop router, and the choice of next hop router then
	determines the network interface used to reach that router.
	For a multi-addressed host this can be problematic.  For the
	sake of example, consider the following network topology:
      
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  ____R1____ {            }
 /a1         {            }
A            { Internet   }------ B
 \____R2_____{            }
  a2         {            }
</pre></div>
<p>
	Host A is directly multihomed to two ISPs, and is given
	address a1 by one ISP and a2 by the second ISP.  Such a
	scenario might occur when A is a smart phone connected
	simultaneously via a 3G network and via WiFi.  It is
	communicating with server B which has a single network link and a
	single IP address.  
      
</p>
<p>
	If A initiates a TCP connection to B, A's IP stack will choose
	the next hop router based on the best path to B as determined
	by the host routing table (often this will be via a default
	route).  If the application does not bind the local IP
	address, then if R1 is chosen as the next hop router then
	address a1 will be used as the source address for this
	connection, otherwise a2 will be used.  Under such
	circumstances, the TCP connection functions correctly.
      
</p>
<p>
        If B initiates a TCP connection to A and sends the SYN to
        address a1, then routing will route the incoming packet via R1
        and hence to a1.  If A's best route to B is via R1, then there
        is no problem.  However, if A's best route to B is via R2,
        then what happens next depends on the host stack
        implementation.  Two common models are in use:
      
</p>
<p>
	</p>
<ul class="text">
<li>
	    If A implements a strong host model, the connection will be
	    rejected because the incoming packet arrived on the
	    incorrect network interface.
	  
</li>
<li>
	    If A implements a weak host model, the connection will be
	    accepted and the SYN/ACK from A to be will be sent via
	    router R2, but with source address a1.  As this address
	    does not come from the address prefix allocated by ISP 2,
	    then there is a good chance that ISP 2 will drop the
	    packet in its ingress filter, believing the source address
	    to be spoofed.
	  
</li>
</ul><p>
      
</p>
<p>
	Clearly neither of these behaviors is desirable.  As a result,
	configurations such as that shown above are generally not
	configured unless it is expected that host A will only act in
	the role of a client.
      
</p>
<p>
	Unfortunately the configuration shown above is also the
	simplest case where Multipath TCP, using multiple addresses to
	distinguish its subflows, will gain any significant benefit.
	Not only must the configuration above work for a TCP flow that
	successfully negotiates multipath capability, but also it must
	work for regular TCP flows to and from that multi-addressed
	host.
      
</p>
<p>
	In fact, for Multipath TCP to be effective, even as a client,
	modifications to the local host routing mechanism will be
	needed.  Even if A initiates two subflows with B, addressed
	using a1 and a2 respectively, if the operating system
	determines the next-hop router (R1 or R2) purely using the
	host routing table, then only one outgoing path to B will be
	used.  Suppose R1 is used.  Not only does this fail to
	load-balance across the two outgoing paths, packets from the
	a2 subflow risk being dropped as spoofed by ISP 1's ingress
	filters.
      
</p>
<p>
	To summarise: it does not make sense to configure current
	hosts with such an addressing scheme unless they are expected
	to only act as clients.  However, for Multipath TCP to be effective,
	such configurations will be necessary.  Thus hosts
	implementing Multipath TCP will need to also implement
	modifications to the local host routing mechanism, so as to
	avoid the undesirable scenario above.
      
</p>
<a name="ideal"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Idealized Host Routing Model</h3>

<p>
	The idealized host routing table assumed in this document
	changes the model described above for hosts implementing
	MP-TCP.  This model is also safe for hosts that do not
	implememt MP-TCP, so it may make sense to make it the default
	behavior on some operating systems, even if MP-TCP is not
	implemented or not configured.
      
</p>
<p>
	The main change is simple, and corresponds to common routing
	behavior found in routers: an MP-TCP host MAY have more than
	one host routing table entry for the same IP prefix (default
	is just a special case of a very short prefix), so long as
	they specify different next hop routers.  Each routing table
	entry MAY have an associated metric, where a lower metric
	indicates that routing table entry is preferred.
      
</p>
<p>
	Packets from multipath and non-multipath flows are forwarded
	identically.  The following procedure SHOULD be followed:
      
</p>
<p></p>
<ol class="text">
<li>
	  Identify the set of routing table entries that match the
	  destination address.  These main include default routes.  Of
	  these, eliminate all that do not have the longest prefix
	  length.
	
</li>
<li>
	  If no route matches, drop the packet and inform TCP of the
	  loss.  MP-TCP may be able to re-send the packet's data to a
	  different destination address.
	
</li>
<li>
	  If none of the routing table entries has a next hop on the
	  same IP subnet as the source address TCP put in the packet,
	  send the packet using the route with the lowest metric.
	
</li>
<li>
	  Otherwise at least one routing table entry has a next hop on
	  the same IP subnet as the packet's source address.  Of these
	  routes, send the packet using the route with the lowest
	  metric.
	
</li>
</ol>

<p>
	The motivation is that a packet should only ever be sent via a
	next hop that has a route to the destination, but where
	possible a packet should be sent via a subnet that is
	compatible with the source address in the packet.  Sometimes
	though it may not be possible to do this, and we discuss these
	cases below.
      
</p>
<p>
	An alternate behaviour for rule 3 is also acceptable, and
	corresponds to the strong host philsophy:
      
</p>
<p></p>
<ul class="text">
<li>
	  If none of the routing table entries has a next hop on the
	  same IP subnet as the source address TCP put in the packet,
	  drop the packet and inform TCP of the loss.
	
</li>
</ul>

<p>
	This alternative rule only affects behavior in a corner case
	that can be regarded as either misconfiguration or routing
	failure (depending on whether or not the host runs a dynamic
	routing protocol), and so does not substantially affect the
	overall behavior.
      
</p>
<p>
	This section has presented a strawman for how host routing
	should behave in an MP-TCP system.  This behavior is not
	intended to be definitive; other host behaviors can be devised
	that will have the same or similar effects when paired with a
	multipath transport protocol.  Rather, the intent of this
	section is to define baseline behavior within which we can
	then define how MP-TCP should behave.
      
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Interaction with NATs</h3>

<p>
	  The existence of Network Address Translators (NATs) in the
	  network does not change the forwarding behavior described
	  above.  However, if a NAT is present on one of the paths out
	  of a site, it is important that a subflow continues to
	  traverse that NAT for its entire lifetime, or else never
	  traverses that NAT at all.  Thus NATs provide an additional
	  constraint on the host routing rules:
	
</p>
<p>
	  The routing of an existing MP-TCP subflow should not be
	  affected by the subsequent establishment of additional
	  subflows to the same destination.
	
</p>
<a name="routing"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
MP-TCP Interaction with Host Routing</h3>

<p>
	Having defined a strawman for how host routing should behave
	in a MP-TCP system, we can now define how MP-TCP should interact
	with that host routing mechanism.  
      
</p>
<a name="active"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
TCP Active End-System Behaviour</h3>

<p>
	  When a regular TCP connection sends the first SYN packet to
	  a destination, the application can either bind the socket to
	  a local IP address or leave it unbound.  If it is bound, the
	  source address of the SYN is chosen by the application, and
	  the TCP session is subsequently bound to this IP address.
	  If the application leaves the source address unbound, the
	  TCP implementation typically looks at the routing table to
	  determine the next-hop router, and chooses its local IP
	  address to be the one from the subnet of the next-hop router.
	  The TCP session is then bound to this dynamically chosen
	  address, even if the host routing changes and packets are
	  subsequently sent from a different interface.
	
</p>
<p>
	  When a multipath TCP connection sends the first SYN packet
	  on the first subflow to a destination address, it SHOULD
	  follow precisely the same procedure as for a regular TCP
	  connection.  This applies to both bound and unbound sockets.
	
</p>
<p>
	  When a multipath TCP wishes to establish an additional
	  subflow to the same destination address, it MUST use a
	  either a different local IP address or a different port from
	  those of its existing subflows on that connection, otherwise
	  the new subflow cannot be distinguished from the existing
	  subflows. MP-TCP SHOULD choose a different source address, if one is
	  available, as this maximises the path diversity for incoming traffic.  
	
</p>
<p>
	  It might also be possible to establish an additional subflow
	  using an existing source address, so a different route
	  exists via a different nexthop router on that subnet.  Such
	  behavior is OPTIONAL, and requires additional state to be
	  held that binds a subflow to a particular next hop router.
	  The rules below assume a new source address is always used.
	
</p>
<p>
	  To establish a new subflow, MP-TCP will first examine the
	  host routing table to determine the set of routes to that
	  destination.  The same basic procedure is followed, similar to that
	  used by the host routing:
	
</p>
<p></p>
<ol class="text">
<li>
	      Identify the set of routing table entries that match the
	      destination address.  Of these eliminate all that do not
	      have the longest prefix length.
	    
</li>
<li>
	      If no route matches, the destination is currently
	      unreachable, and the attempt to establish a new subflow
	      fails.  The MP-TCP implementation SHOULD retry with a
	      different destination address if the other end has
	      indicated more than one.
	    
</li>
<li>
	      Take the set of local IP addresses already used by the
	      subflows of this connection to this destination address.
	      Eliminate from the remaining routing table entries those
	      where the next-hop router is on the same IP subnet as
	      any of these addresses.
	    
</li>
<li>
	      If no route remains, there are no more local addresses
	      to try to this destination address, and the attempt to
	      establish a new subflow fails.  The MP-TCP MAY retry
	      with a different destination address if the other end
	      has indicated more than one.
	    
</li>
<li>
	      Of the remaining routes, choose the one with the lowest
	      metric.  Bind the subflow to the host's local IP address
	      on the subnet of the next hop router from this route.
	    
</li>
</ol>

<p>
	  After a subflow has been established, the IP addresses it
	  uses are fixed.  The source address of all packets sent by
	  an established subflow is set by TCP, and the packets are
	  routed using the basic procedure in <a class='info' href='#ideal'>Section&nbsp;4<span> (</span><span class='info'>Idealized Host Routing Model</span><span>)</span></a>.
	
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Passive Open of MP-TCP Subflows</h3>

<p>
	  When a regular TCP passive listener receives a TCP SYN
	  packet, if it chooses to accept the connection, the
	  destination address in the SYN packet is bound to the
	  connection.  All subsequent packets the host sends on this
	  connection will use this IP address as the source address.
	  Routing for these outgoing packets is determined by the
	  usual unipath forwarding mechanisms.
	
</p>
<p>
	  An MP-TCP passive listener behaves in basically the same
	  way.  If the subflow is accepted, the destination address of
	  the incoming SYN packet binds the subflow to that address.
	  All subsequent packets on that subflow will be sent with
	  that source address.
	
</p>
<p>
	  With an active opener, the procedure in
	  <a class='info' href='#active'>Section&nbsp;5.1<span> (</span><span class='info'>TCP Active End-System Behaviour</span><span>)</span></a> ensures subflows are only
	  established with a source addresses for which there is an
	  active (i.e., longest prefix match) route that leaves via a
	  subnet with that source address.  In other words, additional
	  subflows will only be established when the host believes it
	  can use the source address in a way that (from its point of
	  view) is congruent with routing.
	
</p>
<p>
	  A passive listener does not have this luxury.  The
	  destination address of the incoming SYN packet determines
	  the local IP address bound to the subflow.  There are two
	  distinct cases to consider, depending on the addresses in
	  the SYN packet and the active routes on the listening host.
	
</p>
<p>
	  </p>
<ul class="text">
<li>
	      Congruent Routing: The incoming SYN binds the
	      connection to a local IP address, and there is an active
	      route back to the destination via a next-hop router on
	      that subnet.  In this case the host routing is congruent
	      with the local address chosen, so the forwarding rules
	      present no problem.
	    
</li>
<li>
	      Incongruent Routing: The incoming SYN binds the
	      connection to a local IP address, but there is no active
	      route back to the destination via any next-hop router on
	      that subnet.  If there is no route to the destination at
	      all, then the connection cannot be established. However,
	      if there is a route via some other subnet then the OS
	      has the option of using it, even though it knows the
	      routing is not congruent with the addressing.  This is
	      less than ideal: although the OS knows that incoming
	      packets can still reach it at the address in question,
	      it does not have the control it would wish over outgoing
	      packets, nor can it be sure that outgoing packets will
	      not be filtered by an ISP's ingress filtering.  If the
	      incoming SYN packet is attempting to establish a new
	      subflow on an existing MP-TCP connection that already
	      has a congruently routed and active subflow, then MP-TCP
	      SHOULD reject the new subflow, as the connection is
	      already functioning acceptably. If there is no congruent
	      active subflow, the OS has the option of either dropping
	      the connection or accepting it.  If the OS chooses to
	      accept the connection, it SHOULD also immediately
	      attempt to establish a second subflow using the correct
	      source address for the route to the destination.
	    
</li>
</ul><p>
	
</p>
<p>
	  Discussion: the non-congruent routing case might be
	  considered to be a case of misconfigured routing on the
	  host.  It would also be reasonable behavior to fail to
	  establish such TCP connections, multipath or otherwise.  If
	  the OS implementor chooses to allow such connections, then
	  it might also be reasonable to pin the connection to the
	  outgoing interface upon which the connection was
	  successfully established.  There is a strict tradeoff here
	  between fragility in the presence of NATs and the ability
	  for a host to re-route connections based on dynamic routing
	  information.  This problem is not specific to MP-TCP but
	  occurs with regular TCP too.  The behavior above chooses
	  neither to drop not to pin, and seems a reasonable
	  compromise in this tradeoff space.
	
</p>
<p>
	  Aside: depending on the final MP-TCP protocol spec, it may
	  be possible for an MP-TCP passive lister to send a SYN/ACK
	  from an IP address that is different from that in the
	  initial SYN, and for the client to correctly bind the
	  subflow to the TCP state.  If this is possible, it solves
	  the second scenario above.  However it raises security
	  questions, as it may make it simpler to hijack TCP sessions,
	  and so we do not currently recommend such behavior.
	
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Example Scenarios</h3>

<p>
	The forwarding rules and MP-TCP behavior described above can be
	applied, no matter what the configuration of the MP-TCP host.
	However, it is worth examining several specific scenarios that
	are likely to be common to examine how the routing can be
	applied.
      
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Multi-interface Host</h3>

<p>
	  A common scenario is one where a host has more than one
	  interface over which it can route to the destination.  This is
	  typified by a smart phone (or other wireless device) that has
	  both 3G and WiFi connectivity.  
	
</p>
<p>
	  In such a case, it is expected that each interface is given
	  a unique address from the subnet on which that interface
	  resides.  If each interface also has a route (of the same
	  longest prefix length) that allows the host to reach the
	  destination, then MP-TCP can be applied precisely as
	  described in <a class='info' href='#ideal'>Section&nbsp;4<span> (</span><span class='info'>Idealized Host Routing Model</span><span>)</span></a> and
	  <a class='info' href='#routing'>Section&nbsp;5<span> (</span><span class='info'>MP-TCP Interaction with Host Routing</span><span>)</span></a>.
	
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Single-interface Host at Multihomed Site</h3>

<p>
	  Another common usage scenario is where a host has only a
	  single interface, but it is located at a site that is
	  multihomed to more than one ISP.  For MP-TCP to balance
	  in-bound traffic across the access links, the multiple links
	  must be associated with different IP prefixes, and the hosts
	  within the site must have more than one IP address.  
	
</p>
<p>
	  There are two distinct scenarios to consider:
	
</p>
<p>
	  </p>
<ul class="text">
<li> Different next-hop IP routers on the host's LAN are
	      associated with each prefix.
</li>
<li> The same physical router on the host's LAN is
	      associated with all the prefixes.
</li>
</ul><p>
	
</p>
<p>
	  For simplicity, it is worth considering these two cases separately.
	
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.1"></a><h3>6.2.1.&nbsp;
Different Next-hop Routers</h3>

<p>
	    In this scenario the host has more than one IP address and
	    logically resides on more than one subnet.  It sees
	    different outgoing routers on each of these subnets.
	    These subnets behave as if they were different virtual
	    interfaces from the point of view of routing, then MP-TCP
	    can be applied precisely as described in
	    <a class='info' href='#ideal'>Section&nbsp;4<span> (</span><span class='info'>Idealized Host Routing Model</span><span>)</span></a> and <a class='info' href='#routing'>Section&nbsp;5<span> (</span><span class='info'>MP-TCP Interaction with Host Routing</span><span>)</span></a>.
	  
</p>
<p>
	    Although this scenario is quite limited, we believe it is
	    also very common.  For flexibility reasons, it appears
	    than many data centers consist of a hierarchical L2
	    switch fabric on which the servers and routers reside.
	  
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2.2"></a><h3>6.2.2.&nbsp;
Single Next-hop Router</h3>

<p>
	    In this scenario the host also has more than one IP
	    address and logically resides on more than one subnet.
	    However the topology is such that only a single physical
	    router is used to forward outgoing traffic.  The actual
	    routers used to connect to the organization's ISPs can be
	    multiple IP hops away from the MP-TCP-capable server.
	  
</p>
<p>
	    In such a scenario the host cannot itself directly control
	    the path taken by the outgoing traffic.  If such a host
	    naively uses the forwarding rules from
	    <a class='info' href='#ideal'>Section&nbsp;4<span> (</span><span class='info'>Idealized Host Routing Model</span><span>)</span></a> and <a class='info' href='#routing'>Section&nbsp;5<span> (</span><span class='info'>MP-TCP Interaction with Host Routing</span><span>)</span></a>, then
	    outgoing traffic will not be balanced across the outgoing
	    links, as it will all be forwarded within the site purely
	    on the destination address in the packets.  Perhaps worse,
	    it is possible that packets with an IP address from one
	    ISP are sent via the link from the other ISP, and that ISP
	    implements ingress filtering and discards the packets.
	  
</p>
<p>
	    We note that this scenario is actually worse with regular
	    TCP, as such a host cannot retry with a different address.
	    Thus such scenarios tend not to be configured in practice.
	    However, it is clearly desirable for such sites to be able
	    to take advantage of the benefits of MP-TCP; under such a
	    scenario regular TCP must also work well. A number of
	    possibilities seem to be available:
	  
</p>
<p>
	    </p>
<ul class="text">
<li>
		Deploy source-address-based routing within the site
		for outgoing traffic.  The normal MP-TCP host routing
		behavior can then be used.
	      
</li>
<li>
		Configure more than one virtual-router instance on the
		physical router.  From the host's point of view, the
		network then appears to be one with multiple routers,
		one for each subnet, so normal MP-TCP host routing
		behavior can be used.  It then becomes the router's
		responsibility to ensure that the packets reach the
		correct outgoing routers.  This is simple if the
		router is directly connected to the exit routes, or if
		MPLS is used within the site.  Tunneling might also be
		used to direct the traffic to the correct exit router.
	      
</li>
<li>
		Configure the hosts to tunnel their outgoing traffic
		to the exit routers.  These tunnels would appear as
		virtual interfaces, so the normal MP-TCP host routing
		behavior can be used over these virtual interfaces.
	      
</li>
<li>
		Use IP loose source routing to direct the traffic via
		the correct exit router.  This would require a
		configuration change on the hosts.  In addition, the
		LSRR option frequently causes traffic to be dropped in
		firewalls.  Thus if this option were used, it would be
		advisable for the site exit routers to strip the
		option before forwarding off-site.
	      
</li>
</ul><p>
	  
</p>
<p>
	    It is not yet clear whether some of these options are
	    preferable to others.  It is likely that different solutions
	    may make most sense at different sites.  Some sites might
	    even find it simplest to change the topology so that the
	    existing routers are on the same L2 infrastructure as the
	    MP-TCP hosts.
	  
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IPv6 Considerations</h3>

<p>
	The descriptions above are intended to be agnostic as to
	whether IPv4 or IPv6 is used.  However, IPv6 adds some
	additional complexity.
      
</p>
<p>
	In IPv6, router advertisement messages are sent using
	link-local IPv6 addresses.  Thus even though a host may have a
	globally routable address on an interface, and may know that
	this interface corresponds to a particular IPv6 subnet, the
	router's address in the host routing table is not useful to
	identify the subnet address and hence to determine the choice
	of the host's routable address.
      
</p>
<p>
	The solution to this problem is for the host to maintain a
	binding table that maps the router's host address to the
	subnet's routable prefix.  This binding table MAY be filled in
	when the host receives a router advertisement message from the
	router indicating the subnet prefix. 
      
</p>
<p>
	We note that this slightly overloads the purpose of a router
	advertisement message, to indicate that this router is a valid
	next hop for packets sourced from this prefix.  This does not
	seem to be a significant departure from current practice, but
	it is possible that it may change the outgoing routing on
	existing deployments.
      
</p>
<a name="Security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>
	This document discusses the binding of TCP and MP-TCP
	connections to IP addresses, which has the potential to change
	the way traffic is routed in networks.  This does not
	introduce any new security risks per-se, but any change to how
	traffic is routed might cause network administrators
	assumptions about where traffic flows to be incorrect.
	However, the traffic only flows via routers for which the
	hosts have route table entries, so the emphasis for
	administrators is to ensure that host routing is configured in
	a way that matches security assumptions.
      
</p>
<p>
	The use of network-based mechansims to route outgoing traffic
	might open up new avenues for attack.  This document does not
	discuss these mechanisms in sufficient detail to merit a
	discussion of their security or other properties here.
      
</p>
<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[1]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ford-mptcp-multiaddressed">[2]</a></td>
<td class="author-text">Ford, A., Raiciu, C., and M. Handley, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ford-mptcp-multiaddressed-03.txt">TCP Extensions for Multipath Operation with Multiple Addresses</a>,&rdquo; draft-ford-mptcp-multiaddressed-03 (work in progress), March&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ford-mptcp-multiaddressed-03.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Mark Handley</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">University College London</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Department of Computer Science</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Gower St.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">London  WC1E 6BT</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">UK</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+44 20 7679 7296</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:m.handley@cs.ucl.ac.uk">m.handley@cs.ucl.ac.uk</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Costin Raiciu</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">University College London</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Department of Computer Science</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Gower St.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">London  WC1E 6BT</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">UK</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+44 20 7679 3666</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:C.Raiciu@cs.ucl.ac.uk">C.Raiciu@cs.ucl.ac.uk</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Marcelo Bagnulo</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Universidad Carlos III de Madrid</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Av. Universidad 30</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Leganes, Madrid  28911</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Spain</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+34 91 6248814</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:marcelo@it.uc3m.es">marcelo@it.uc3m.es</a></td></tr>
</table>
</body></html>
