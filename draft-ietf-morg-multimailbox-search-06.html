<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>IMAP4 Multimailbox SEARCH Extension</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Conventions used in this document">
<link href="#rfc.section.2" rel="Chapter" title="2 New ESEARCH command">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 The ESEARCH response">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 Source options: specifying mailboxes to search">
<link href="#rfc.section.3" rel="Chapter" title="3 Examples">
<link href="#rfc.section.4" rel="Chapter" title="4 Formal Syntax">
<link href="#rfc.section.5" rel="Chapter" title="5 Security Considerations">
<link href="#rfc.section.6" rel="Chapter" title="6 IANA Considerations">
<link href="#rfc.section.7" rel="Chapter" title="7 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="8 References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="The IMAP4 specification allows the searching only of the selected mailbox.  A user often wants to search multiple mailboxes, and a client that wishes to support this must issue a series of SELECT and SEARCH commands, waiting for each to complete before moving on to the next.  This extension allows a client to search multiple mailboxes with one command, limiting the round-trips and waiting for various searches to complete, and not requiring disruption of the currently selected mailbox.  This also uses MAILBOX and TAG fields in ESEARCH responses, allowing a client to pipeline the searches if it chooses.  " />
  <meta name="description" content="The IMAP4 specification allows the searching only of the selected mailbox.  A user often wants to search multiple mailboxes, and a client that wishes to support this must issue a series of SELECT and SEARCH commands, waiting for each to complete before moving on to the next.  This extension allows a client to search multiple mailboxes with one command, limiting the round-trips and waiting for various searches to complete, and not requiring disruption of the currently selected mailbox.  This also uses MAILBOX and TAG fields in ESEARCH responses, allowing a client to pipeline the searches if it chooses.  " />
  <meta name="keywords" content="IMAP, email, search, multiple mailboxes, imapext" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Message ORGanization Working Group</td>
<td class="right">B. Leiba</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Huawei Technologies</td>
</tr>
<tr>
<td class="left">Updates: 4466 (if approved)</td>
<td class="right">A. Melnikov</td>
</tr>
<tr>
<td class="left">Intended status: Experimental Protocol</td>
<td class="right">Isode Limited</td>
</tr>
<tr>
<td class="left">Expires: August 14, 2011</td>
<td class="right">February 10, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">IMAP4 Multimailbox SEARCH Extension<br />
  <span class="filename">draft-ietf-morg-multimailbox-search-06</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>The IMAP4 specification allows the searching only of the selected mailbox.  A user often wants to search multiple mailboxes, and a client that wishes to support this must issue a series of SELECT and SEARCH commands, waiting for each to complete before moving on to the next.  This extension allows a client to search multiple mailboxes with one command, limiting the round-trips and waiting for various searches to complete, and not requiring disruption of the currently selected mailbox.  This also uses MAILBOX and TAG fields in ESEARCH responses, allowing a client to pipeline the searches if it chooses.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on August 14, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Conventions used in this document</a>
</li>
<li>2.   <a href="#rfc.section.2">New ESEARCH command</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">The ESEARCH response</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">Source options: specifying mailboxes to search</a>
</li>
<li>3.   <a href="#rfc.section.3">Examples</a>
</li>
<li>4.   <a href="#rfc.section.4">Formal Syntax</a>
</li>
<li>5.   <a href="#rfc.section.5">Security Considerations</a>
</li>
<li>6.   <a href="#rfc.section.6">IANA Considerations</a>
</li>
<li>7.   <a href="#rfc.section.7">Acknowledgements</a>
</li>
<li>8.   <a href="#rfc.references">References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">The IMAP4 specification allows the searching only of the selected mailbox.  A user often wants to search multiple mailboxes, and a client that wishes to support this must issue a series of SELECT and SEARCH commands, waiting for each to complete before moving on to the next.  The commands can't be pipelined, because the server might run them in parallel, and the untagged SEARCH responses could not then be distinguished from each other.  </p>
<p id="rfc.section.1.p.2">This extension allows a client to search multiple mailboxes with one command, and includes MAILBOX and TAG fields in the ESEARCH response, yielding the following advantages: </p>

<ul>
<li>A single command limits the number of round-trips needed to search a set of mailboxes.  </li>
<li>A single command eliminates the need to wait for one search to complete before starting the next.  </li>
<li>A single command allows the server to optimize the search, if it can.  </li>
<li>A command that is not dependent upon the selected mailbox eliminates the need to disrupt the selection state, or to open another IMAP connection.  </li>
<li>The MAILBOX and TAG fields in the responses allow a client to distinguish which responses go with which search (and which mailbox).  A client can safely pipeline these search commands without danger of confusion.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> Conventions used in this document</h1>
<p id="rfc.section.1.1.p.1">In examples, "C:" indicates lines sent by a client that is connected to a server.  "S:" indicates lines sent by the server to the client.  </p>
<p id="rfc.section.1.1.p.2">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119 <a href="#RFC2119">[RFC2119]</a>.  </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> New ESEARCH command</h1>
<p></p>

<dl>
<dt>Arguments:</dt>
<dd style="margin-left: 12">OPTIONAL source options<br> OPTIONAL result options<br> OPTIONAL charset specification (see <a href="#RFC2978">[RFC2978]</a>)<br> searching criteria (one or more) </dd>
<dt>Responses:</dt>
<dd style="margin-left: 12">REQUIRED untagged response: ESEARCH<br> </dd>
<dt>Result:</dt>
<dd style="margin-left: 12">OK - search completed<br> NO - error: cannot search that charset or criteria<br> BAD - command unknown or arguments invalid </dd>
</dl>

<p> </p>
<p id="rfc.section.2.p.2">This section defines a new ESEARCH command, which works similarly to the UID SEARCH command described in section 2.6.1 of <a href="#RFC4466">[RFC4466]</a> (initially described in section 6.4.4 of <a href="#RFC3501">[RFC3501]</a> and extended by <a href="#RFC4731">[RFC4731]</a>).  </p>
<p id="rfc.section.2.p.3">The ESEARCH command further extends searching by allowing for optional source and result options.  This document does not define any new result options (see Section 3.1 of <a href="#RFC4731">[RFC4731]</a>).  A server that supports this extension includes </p>
<p id="rfc.section.2.p.4">Because there has been confusion about this, it is worth pointing out that with ESEARCH, as with *any* SEARCH or UID SEARCH command, it MUST NOT be considered an error if the search terms include a range of message numbers that extends (or, in fact, starts) beyond the end of the mailbox.  For example, a client might want to establish a rolling window through the search results this way: </p>
<p id="rfc.section.2.p.5">C: tag1 UID ESEARCH FROM "frobozz" 1:100 </p>
<p id="rfc.section.2.p.6">...followed later by this: </p>
<p id="rfc.section.2.p.7">C: tag1 UID ESEARCH FROM "frobozz" 101:200 </p>
<p id="rfc.section.2.p.8">...and so on.  This tells the server to match only the first hundred messages in the mailbox the first time, the second hundred the second time, etc.  In fact, it might likely allow the server to optimize the search significantly.  In the above example, whether the mailbox contains 50 or 150 or 250 messages, neither of the search commands shown will result in an error.  It is up to the client to know when to stop moving its search window.  </p>
<p></p>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> The ESEARCH response</h1>
<p id="rfc.section.2.1.p.1">In response to an ESEARCH command, the server MUST return ESEARCH responses <a href="#RFC4731">[RFC4731]</a> (that is, not SEARCH responses).  Because message numbers are not useful for mailboxes that are not selected, the responses MUST contain information about UIDs, not message numbers.  This is true even if the source options specify that only the selected mailbox be searched.  </p>
<p id="rfc.section.2.1.p.2">Presence of a source option in absence of a result option implies the "ALL" result option (see Section 3.1 of <a href="#RFC4731">[RFC4731]</a>).  Note that this is not the same as the result from the SEARCH command described in the IMAP base protocol.  </p>
<p id="rfc.section.2.1.p.3">Source options describe which mailboxes must be searched for messages.  An ESEARCH command with source options does not affect which mailbox, if any, is currently selected, regardless of which mailboxes are searched.  </p>
<p id="rfc.section.2.1.p.4">For each mailbox satisfying the source options, a single ESEARCH response MUST be returned if any messages in that mailbox match the search criteria.  An ESEARCH response MUST NOT be returned for mailboxes that contain no matching messages.  This is true even when result options such as MIN, MAX, and COUNT are specified (see section 3.1 of <a href="#RFC4731">[RFC4731]</a>), and the values returned (lowest UID matched, highest UID matched, and number of messages matched, respectively) apply to the mailbox reported in that ESEARCH response.  </p>
<p id="rfc.section.2.1.p.5">Note that it is possible for an ESEARCH command to return *no* untagged responses (no ESEARCH responses at all), in the case that there are no matches to the search in any of the mailboxes that satisfy the source options.  Clients can detect this situation by finding the tagged OK response without having received any matching untagged ESEARCH responses.  </p>
<p id="rfc.section.2.1.p.6">Each ESEARCH response MUST contain the MAILBOX, TAG, and UIDVALIDITY correlators.  Correlators allow clients to issue several ESEARCH commands at once (pipelined).  If the SEARCHRES <a href="#RFC5182">[RFC5182]</a> extension is used in an ESEARCH command, that ESEARCH command MUST be executed by the server after all previous SEARCH/ESEARCH commands have completed, and before any subsequent SEARCH/ESEARCH commands are executed.  The server MAY perform consecutive ESEARCH commands in parallel as long as none of them use the SEARCHRES extension.  </p>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> Source options: specifying mailboxes to search</h1>
<p id="rfc.section.2.2.p.1">The source options, if present, MUST contain a mailbox specifier as defined in the IMAP NOTIFY extension <a href="#RFC5465">[RFC5465]</a>, section 6 (using the "filter-mailboxes" ABNF item), with the following differences: </p>

<ol>
<li>The "selected-delayed" specifier is not valid here.  </li>
<li>A "subtree-one" specifier is added.  The "subtree" specifier results in a search of the specified mailbox and all selectable mailboxes that are subordinate to it, through an indefinitely deep hierarchy.  The "subtree-one" specifier results in a search of the specified mailbox and all selectable child mailboxes, one hierarchy level down.  </li>
</ol>

<p> </p>
<p id="rfc.section.2.2.p.2">If "subtree" is specified, the server MUST defend against loops in the hierarchy (for example, those caused by recursive file-system links within the message store).  The server SHOULD do this by keeping track of the mailboxes that have been searched, and terminating the hierarchy traversal when a repeat is found.  If it can not do that, it MAY do it by limiting the hierarchy depth.  </p>
<p id="rfc.section.2.2.p.3">If the source options are not present, the value "selected" is assumed -- that is, only the currently selected mailbox is searched.  </p>
<p id="rfc.section.2.2.p.4">The "personal" source option is a particularly convenient way to search all of the current user's mailboxes.  Note that there is no way to use wildcard characters to search all mailboxes; the "mailboxes" source option does not do wildcard expansion.  </p>
<p id="rfc.section.2.2.p.5">If the source options include (or default to) "selected", the IMAP session MUST be in "selected" state.  If the source options specify other mailboxes and NOT "selected", then the IMAP session MUST be in either "selected" or "authenticated" state.  If the session is not in a correct state, the ESEARCH command MUST return a "BAD" result.  </p>
<p id="rfc.section.2.2.p.6">If the server supports the SEARCHRES <a href="#RFC5182">[RFC5182]</a> extension, then the "SAVE" result option is valid *only* if "selected" is specified or defaulted as the sole mailbox to be searched.  If any source option other than "selected" is specified, the ESEARCH command MUST return a "BAD" result.  </p>
<p id="rfc.section.2.2.p.7">If the server supports the CONTEXT=SEARCH and/or CONTEXT=SORT extension <a href="#RFC5267">[RFC5267]</a>, then the following additional rules apply: </p>

<ul>
<li>The CONTEXT return option (Section 4.2 of <a href="#RFC5267">[RFC5267]</a>) can be used with an ESEARCH command.  </li>
<li>If the UPDATE return option is used (Section 4.3 of <a href="#RFC5267">[RFC5267]</a>), it MUST apply ONLY to the the currently selected mailbox.  If UPDATE is used and there is no mailbox currently selected, the ESEARCH command MUST return a "BAD" result.  </li>
<li>The PARTIAL search return option (Section 4.4 of <a href="#RFC5267">[RFC5267]</a>) can be used and applies to each mailbox searched by the ESEARCH command.  </li>
</ul>

<p> </p>
<p id="rfc.section.2.2.p.8">If the server supports the ACL <a href="#RFC4314">[RFC4314]</a> extension, then the logged in user is required to have the 'r' right for each mailbox she wants to search.  In addition, any mailboxes that are not explicitly named (accessed through "personal" or "subtree", for example) are required to have the "l" right.  Mailboxes matching the source options for which the logged in user lacks sufficient rights MUST be ignored by the ESEARCH command processing.  In particular, ESEARCH responses MUST NOT be returned for those mailboxes.  </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#examples" id="examples">Examples</a>
</h1>
<p id="rfc.section.3.p.1">In the following example, note that two ESEARCH commands are pipelined, and that the server is running them in parallel, interleaving a response to the second search amid the responses to the first (watch the tags).  </p>
<p id="rfc.section.3.p.2">C: tag1 ESEARCH IN (mailboxes "folder1" subtree "folder2") unseen<br> C: tag2 ESEARCH IN (mailboxes "folder1" subtree-one "folder2") subject "chad"<br> S: * ESEARCH (TAG "tag1" MAILBOX "folder1" UIDVALIDITY 1) UID ALL 4001,4003,4005,4007,4009<br> S: * ESEARCH (TAG "tag2" MAILBOX "folder1" UIDVALIDITY 1) UID ALL 3001:3004,3788<br> S: * ESEARCH (TAG "tag1" MAILBOX "folder2/banana" UIDVALIDITY 503) UID ALL 3002,4004<br> S: * ESEARCH (TAG "tag1" MAILBOX "folder2/peach" UIDVALIDITY 3) UID ALL 921691<br> S: tag1 OK done<br> S: * ESEARCH (TAG "tag2" MAILBOX "folder2/salmon" UIDVALIDITY 1111111) UID ALL 50003,50006,50009,50012<br> S: tag2 OK done </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#syntax" id="syntax">Formal Syntax</a>
</h1>
<p id="rfc.section.4.p.1">The following syntax specification uses the Augmented Backus-Naur Form (ABNF) as described in <a href="#RFC5234">[RFC5234]</a>.  Terms not defined here are taken from <a href="#RFC3501">[RFC3501]</a>, <a href="#RFC5465">[RFC5465]</a>, or <a href="#RFC4466">[RFC4466]</a>.  </p>
<p></p>

<dl>
<dt>command-auth =/</dt>
<dd style="margin-left: 8">esearch<br> ; Update definition from IMAP base <a href="#RFC3501">[RFC3501]</a><br> ; Add new "esearch" command.  </dd>
<dt>command-select =/</dt>
<dd style="margin-left: 8">esearch<br> ; Update definition from IMAP base <a href="#RFC3501">[RFC3501]</a><br> ; Add new "esearch" command.  </dd>
<dt>filter-mailboxes-other =/</dt>
<dd style="margin-left: 8">("subtree-one" SP one-or-more-mailbox)<br> ; Update definition from IMAP Notify <a href="#RFC5465">[RFC5465]</a><br> ; Add new "subtree-one" selector.  </dd>
<dt>filter-mailboxes-selected =</dt>
<dd style="margin-left: 8">"selected"<br> ; Update definition from IMAP Notify <a href="#RFC5465">[RFC5465]</a><br> ; We forbid the use of "selected-delayed".  </dd>
<dt>one-correlator =</dt>
<dd style="margin-left: 8">("TAG" SP tag-string) / ("MAILBOX" SP astring) / ("UIDVALIDITY" SP nz-number)<br> ; Each correlator MUST appear exactly once </dd>
<dt>scope-option =</dt>
<dd style="margin-left: 8">scope-option-name [SP scope-option-value]<br> ; No options defined here.  Syntax for future extensions.  </dd>
<dt>scope-option-name =</dt>
<dd style="margin-left: 8">tagged-ext-label<br> ; No options defined here.  Syntax for future extensions.  </dd>
<dt>scope-option-value =</dt>
<dd style="margin-left: 8">tagged-ext-val<br> ; No options defined here.  Syntax for future extensions.  </dd>
<dt>scope-options =</dt>
<dd style="margin-left: 8">scope-option *(SP scope-option)<br> ; A given option may only appear once<br> ; No options defined here.  Syntax for future extensions.  </dd>
<dt>esearch =</dt>
<dd style="margin-left: 8">"ESEARCH" [SP esearch-source-opts]<br> [SP search-return-opts] SP search-program<br> </dd>
<dt>search-correlator =</dt>
<dd style="margin-left: 8">SP "(" one-correlator *(SP one-correlator) ")"<br> ; Updates definition in IMAP4 ABNF <a href="#RFC4466">[RFC4466]</a> </dd>
<dt>esearch-source-opts =</dt>
<dd style="margin-left: 8">"IN" SP "(" source-mbox [SP<br> "(" scope-options ")"] ")" </dd>
<dt>source-mbox =</dt>
<dd style="margin-left: 8">filter-mailboxes *(SP filter-mailboxes)<br> ; filter-mailboxes is defined in IMAP Notify <a href="#RFC5465">[RFC5465]</a><br> ; See updated definition of filter-mailboxes-other, above.<br> ; See updated definition of filter-mailboxes-selected, above.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.5.p.1">This new IMAP ESEARCH command allows a single command to search many mailboxes at once.  On the one hand, a client could do that by sending many IMAP SEARCH commands.  On the other hand, this makes it easier for a client to overwork a server, by sending a single command that results in an expensive search of tens of thousands of mailboxes.  Server implementations need to be aware of that, and provide mechanisms that prevent a client from adversely affecting other users.  Limitations on the number of mailboxes that may be searched in one command, and/or on the server resources that will be devoted to responding to a single client, are reasonable limitations for an implementation to impose.  </p>
<p id="rfc.section.5.p.2">Implementations MUST, of course, apply access controls appropriately, limiting a user's access to ESEARCH in the same way its access is limited for any other IMAP commands.  This extension has no data-access risks beyond what may be there in the unextended IMAP implementation.  </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#iana" id="iana">IANA Considerations</a>
</h1>
<div id="#rfc.figure.1"></div>
<pre>
            
   http://www.iana.org/assignments/imap4-capabilities
            
          </pre>
<p id="rfc.section.6.p.1">IMAP4 capabilities are registered by publishing a standards track or IESG approved experimental RFC.  The registry is currently located here: </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> Acknowledgements</h1>
<p id="rfc.section.7.p.1">The authors gratefully acknowledge feedback provided by Timo Sirainen, Peter Coates and Arnt Gulbrandsen.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">8.</a> References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2978">[RFC2978]</b></td>
<td class="top">
<a>Freed, N.</a> and <a>J. Postel</a>, "<a href="http://tools.ietf.org/html/rfc2978">IANA Charset Registration Procedures</a>", BCP 19, RFC 2978, October 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3501">[RFC3501]</b></td>
<td class="top">
<a>Crispin, M.</a>, "<a href="http://tools.ietf.org/html/rfc3501">INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1</a>", RFC 3501, March 2003.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4314">[RFC4314]</b></td>
<td class="top">
<a>Melnikov, A.</a>, "<a href="http://tools.ietf.org/html/rfc4314">IMAP4 Access Control List (ACL) Extension</a>", RFC 4314, December 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4466">[RFC4466]</b></td>
<td class="top">
<a>Melnikov, A.</a> and <a>C. Daboo</a>, "<a href="http://tools.ietf.org/html/rfc4466">Collected Extensions to IMAP4 ABNF</a>", RFC 4466, April 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4731">[RFC4731]</b></td>
<td class="top">
<a>Melnikov, A.</a> and <a>D. Cridland</a>, "<a href="http://tools.ietf.org/html/rfc4731">IMAP4 Extension to SEARCH Command for Controlling What Kind of Information Is Returned</a>", RFC 4731, November 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5182">[RFC5182]</b></td>
<td class="top">
<a>Melnikov, A.</a>, "<a href="http://tools.ietf.org/html/rfc5182">IMAP Extension for Referencing the Last SEARCH Result</a>", RFC 5182, March 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5234">[RFC5234]</b></td>
<td class="top">
<a>Crocker, D.</a> and <a>P. Overell</a>, "<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>", STD 68, RFC 5234, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5267">[RFC5267]</b></td>
<td class="top">
<a>Cridland, D.</a> and <a>C. King</a>, "<a href="http://tools.ietf.org/html/rfc5267">Contexts for IMAP4</a>", RFC 5267, July 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5465">[RFC5465]</b></td>
<td class="top">
<a>Gulbrandsen, A.</a>, <a>King, C.</a> and <a>A. Melnikov</a>, "<a href="http://tools.ietf.org/html/rfc5465">The IMAP NOTIFY Extension</a>", RFC 5465, February 2009.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Barry Leiba</span> 
	  <span class="n hidden">
		<span class="family-name">Leiba</span>
	  </span>
	</span>
	<span class="org vcardline">Huawei Technologies</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">Phone: +1 646 827 0648</span>

<span class="vcardline">EMail: <a href="mailto:barryleiba@computer.org">barryleiba@computer.org</a></span>

<span class="vcardline">URI: <a href="http://internetmessagingtechnology.org/">http://internetmessagingtechnology.org/</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Alexey Melnikov</span> 
	  <span class="n hidden">
		<span class="family-name">Melnikov</span>
	  </span>
	</span>
	<span class="org vcardline">Isode Limited</span>
	<span class="adr">
	  <span>5 Castle Business Village</span>
<span>36 Station Road</span>

	  <span class="vcardline">
		<span class="locality">Hampton</span>,  
		<span class="region">Middlesex</span> 
		<span class="code">TW12 2BX</span>
	  </span>
	  <span class="country-name vcardline">UK</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:Alexey.Melnikov@isode.com">Alexey.Melnikov@isode.com</a></span>

<span class="vcardline">URI: <a href="http://www.melnikov.ca/">http://www.melnikov.ca/</a></span>

  </address>
</div>

</body>
</html>