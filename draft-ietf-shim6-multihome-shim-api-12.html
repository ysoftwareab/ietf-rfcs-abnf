<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Socket Application Program
    Interface (API) for Multihoming Shim</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Socket Application Program
    Interface (API) for Multihoming Shim">
<meta name="keywords" content="SHIM6, HIP, identifier/locator split">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">SHIM6 Working Group</td><td class="header">M. Komu</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">HIIT</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">M. Bagnulo</td></tr>
<tr><td class="header">Expires: July 13, 2010</td><td class="header">UC3M</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">K. Slavov</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">S. Sugimoto, Ed.</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Ericsson</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">January 09, 2010</td></tr>
</table></td></tr></table>
<h1><br />Socket Application Program
    Interface (API) for Multihoming Shim<br />draft-ietf-shim6-multihome-shim-api-12</h1>

<h3>Abstract</h3>

<p>This document specifies sockets API extensions for the
      multihoming shim layer.  The API aims to enable interactions
      between applications and the multihoming shim layer for advanced
      locator management, and access to information about failure
      detection and path exploration.
</p>
<p>This document is based on an assumption that a multihomed
      host is equipped with a conceptual sub-layer (hereafter "shim")
      inside the IP layer that maintains mappings between identifiers
      and locators.  Examples of the shim are SHIM6 and HIP.
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on July 13, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#sec-system-overview">3.</a>&nbsp;
System Overview<br />
<a href="#sec-requirements">4.</a>&nbsp;
Requirements<br />
<a href="#sec-shim-socket-options">5.</a>&nbsp;
Socket Options for Multihoming Shim Sub-layer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">5.1.</a>&nbsp;
SHIM_ASSOCIATED<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">5.2.</a>&nbsp;
SHIM_DONTSHIM<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">5.3.</a>&nbsp;
SHIM_HOT_STANDBY<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">5.4.</a>&nbsp;
SHIM_PATHEXPLORE<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">5.5.</a>&nbsp;
SHIM_LOC_LOCAL_PREF<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">5.6.</a>&nbsp;
SHIM_LOC_PEER_PREF<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">5.7.</a>&nbsp;
SHIM_LOC_LOCAL_RECV<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">5.8.</a>&nbsp;
SHIM_LOC_PEER_RECV<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">5.9.</a>&nbsp;
SHIM_LOC_LOCAL_SEND<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">5.10.</a>&nbsp;
SHIM_LOC_PEER_SEND<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">5.11.</a>&nbsp;
SHIM_LOCLIST_LOCAL<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">5.12.</a>&nbsp;
SHIM_LOCLIST_PEER<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">5.13.</a>&nbsp;
SHIM_APP_TIMEOUT<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">5.14.</a>&nbsp;
SHIM_DEFERRED_CONTEXT_SETUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-socket-options-applicability">5.15.</a>&nbsp;
Applicability<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">5.16.</a>&nbsp;
Error Handling<br />
<a href="#sec-access-to-locinfo">6.</a>&nbsp;
Ancillary Data for Multihoming Shim Sub-layer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">6.1.</a>&nbsp;
Get Locator from Incoming Packet<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">6.2.</a>&nbsp;
Set Locator for Outgoing Packet<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-feedback">6.3.</a>&nbsp;
Notification from Application to Multihoming Shim Sub-layer<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-notification-shimtoapp">6.4.</a>&nbsp;
Notification from Multihoming Shim Sub-layer to Application<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-ancillary-data-applicability">6.5.</a>&nbsp;
Applicability<br />
<a href="#sec-data-structures">7.</a>&nbsp;
Data Structures<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor20">7.1.</a>&nbsp;
Placeholder for Locator Information<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">7.1.1.</a>&nbsp;
Handling Locator behind NAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor22">7.2.</a>&nbsp;
Path Exploration Parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-feedback-info">7.3.</a>&nbsp;
Feedback Information<br />
<a href="#sec-system-requirements">8.</a>&nbsp;
System Requirements<br />
<a href="#sec-implications-for-legacyapi">9.</a>&nbsp;
Relation to Existing Sockets API Extensions<br />
<a href="#anchor23">10.</a>&nbsp;
Operational Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">10.1.</a>&nbsp;
Conflict Resolution<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">10.2.</a>&nbsp;
Incompatiblility between IPv4 and IPv6<br />
<a href="#anchor26">11.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor27">12.</a>&nbsp;
Protocol Constants and Variables<br />
<a href="#anchor28">13.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor29">13.1.</a>&nbsp;
Treatment of Unknown Locator<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor30">13.1.1.</a>&nbsp;
Treatment of Unknown Source Locator<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor31">13.1.2.</a>&nbsp;
Treatment of Unknown Destination Locator<br />
<a href="#anchor32">14.</a>&nbsp;
Changes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor33">14.1.</a>&nbsp;
Changes from version 00 to version 01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor34">14.2.</a>&nbsp;
Changes from version 01 to version 02<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor35">14.3.</a>&nbsp;
Changes from version 02 to version 03<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor36">14.4.</a>&nbsp;
Changes from version 03 to version 04<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor37">14.5.</a>&nbsp;
Changes from version 04 to version 05<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor38">14.6.</a>&nbsp;
Changes from version 05 to version 06<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor39">14.7.</a>&nbsp;
Changes from version 06 to version 07<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor40">14.8.</a>&nbsp;
Changes from version 07 to version 08<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor41">14.9.</a>&nbsp;
Changes from version 08 to version 09<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor42">14.10.</a>&nbsp;
Changes from version 09 to version 10<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor43">14.11.</a>&nbsp;
Changes from version 10 to version 11<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor44">14.12.</a>&nbsp;
Changes from version 11 to version 12<br />
<a href="#anchor45">15.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">16.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">16.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">16.2.</a>&nbsp;
Informative References<br />
<a href="#anchor48">Appendix&nbsp;A.</a>&nbsp;
Context Forking<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>This document defines socket API extensions by which upper
      layer protocols may be informed about and control the way in
      which a multihoming shim sub-layer in the IP layer manages the
      dynamic choice of locators.  Initially it applies to SHIM6 and
      HIP, but it is defined generically.
</p>
<p>The role of the multihoming shim sub-layer (hereafter called
      "shim sub-layer" in this document) is to avoid impacts to upper
      layer protocols which may be caused when the endhost changes its
      attachment point to the Internet, for instance, in the case of
      rehoming event under the multihomed environment.  The key design
      of the shim sub-layer is to treat identifier and locator
      separately.  Identifiers are presented to upper layer protocols
      and used as communication endpoints.  Locators represent
      toplogical location of endhosts and are used to route packet
      from the source to the destiantion.  The shim sub-layer
      maintains mapping of identifiers and locators.
</p>
<p>Note that the shim sub-layer may conflict with other
      multihoming mechanisms such as SCTP and multipath TCP<a class='info' href='#I-D.ietf-shim6-applicability'>[I&#8209;D.ietf&#8209;shim6&#8209;applicability]<span> (</span><span class='info'>Abley, J., Bagnulo, M., and A. Garcia-Martinez, &ldquo;Applicability Statement for the Level 3 Multihoming 	  Shim Protocol (Shim6),&rdquo; November&nbsp;2009.</span><span>)</span></a>.  To avoid any conflict,
      only one of SHIM6 and HIP should be in use.
</p>
<p>In this document, syntax and semantics of the API are given
      in the same way as the Posix standard <a class='info' href='#POSIX'>[POSIX]<span> (</span><span class='info'>, &ldquo;IEEE Std. 1003.1-2001 Standard for Information 	  Technology -- Portable Operating System Interface 	  (POSIX). Open group Technical Standard: Base Specifications, 	  Issue 6, http://www.opengroup.org/austin,&rdquo; December&nbsp;2001.</span><span>)</span></a>.
      The API specifies how to use ancillary data (aka cmsg) to access
      the locator information with recvmsg() and/or sendmsg() I/O
      calls.  The API is described in C language and data types are
      defined in the Posix format; intN_t means a singed integer of
      exactly N bits (e.g. int16_t) and uintN_t means an unsigned
      integer of exactly N bits (e.g. uint32_t).
</p>
<p>The distinction between "connected" sockets and "unconnected"
      sockets is important when discussing the applicability of the
      socket API defined in this document.  A connected socket is
      bound to a given peer, whereas an unconnected socket is not
      bound to any specific peers.  A TCP socket becomes a connected
      socket when the TCP connection establishment is completed.  UDP
      sockets are unconnected, unless the application uses the
      connect() system call.
</p>
<p>The target readers of this document are application
      programmers who develop application software which may benefit
      greatly from multihomed environments.  In addition, this
      document aims to provide necessary information for developers of
      shim protocols to implement API for enabling advanced locator
      management.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>This section provides terminology used in this document.
      Basically most of the terms used in this document are taken from
      the following documents:<br />
<br />


      </p>
<ul class="text">
<li>SHIM6 Protocol Specification<a class='info' href='#RFC5533'>[RFC5533]<span> (</span><span class='info'>Bagnulo, M. and E. Nordmark, &ldquo;Level 3 multihoming shim protocol,&rdquo; June&nbsp;2009.</span><span>)</span></a>
</li>
<li>HIP Architecture<a class='info' href='#RFC4423'>[RFC4423]<span> (</span><span class='info'>Moskowitz, R. and P. Nikander, &ldquo;Host Identity Protocol (HIP) Architecture,&rdquo; May&nbsp;2006.</span><span>)</span></a>
</li>
<li>Reachability Protocol (REAP)<a class='info' href='#RFC5534'>[RFC5534]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration 	  Protocol for IPv6 Multihoming,&rdquo; June&nbsp;2009.</span><span>)</span></a>
</li>
</ul><p>
      <br />
<br />


      In this document, the term "IP" refers to both IPv4 and IPv6,
      unless the protocol version is specifically mentioned.  The
      following are definitions of terms frequently used in this
      document:<br />
<br />

 
      </p>
<ul class="text">
<li>Endpoint identifier (EID) - The identifier used by the
	application to specify the endpoint of a given communication.
	Applications may handle EIDs in various ways such as
	long-lived connections, callbacks, and referrals<a class='info' href='#I-D.ietf-shim6-app-refer'>[I&#8209;D.ietf&#8209;shim6&#8209;app&#8209;refer]<span> (</span><span class='info'>Nordmark, E., &ldquo;Shim6 Application Referral Issues,&rdquo; July&nbsp;2005.</span><span>)</span></a>.

	
<ul class="text">
<li>In the case of SHIM6, an identifier called a ULID serves
	  as an EID.  A ULID is chosen from locators available on the
	  host.
</li>
<li>In the case of HIP, an identifier called a Host
	  Identifier serves as an EID.  A Host Identifier is derived
	  from the public key of a given host.  For the sake of
	  backward compatibility with the sockets API, the Host
	  Identifier is represented in a form of hash of public key.
	  
</li>
<li>Note that the EID appears in the standard socket API as
	  an address, and does not appear in the extensions defined in
	  this document, which only concern locators.
</li>
</ul>
	
</li>
<li>Locator - The IP address actually used to deliver IP
	packets.  Locators are present in the source and destination
	fields of the IP header of a packet on the wire.  
<ul class="text">
<li>List of locators - A list of locators associated with
	    an EID.  There are two lists of locators stored in a given
	    context.  One is associated with the local EID and the
	    other is associated with the remote EID.  As defined in
	    <a class='info' href='#RFC5533'>[RFC5533]<span> (</span><span class='info'>Bagnulo, M. and E. Nordmark, &ldquo;Level 3 multihoming shim protocol,&rdquo; June&nbsp;2009.</span><span>)</span></a>, the list of locators associated
	    with an EID 'A' is denoted as Ls(A).
</li>
<li>Preferred locator - The (source/destination) locator
	    currently used to send packets within a given context.  As
	    defined in <a class='info' href='#RFC5533'>[RFC5533]<span> (</span><span class='info'>Bagnulo, M. and E. Nordmark, &ldquo;Level 3 multihoming shim protocol,&rdquo; June&nbsp;2009.</span><span>)</span></a>, the preferred locator
	    of a host 'A' is denoted as Lp(A).
</li>
<li>Unknown locator - Any locator that does not appear in
	    the locator list of the shim context associated with the
	    socket.  When there is no shim context associated with the
	    socket, any source and/or destination locator requested by
	    the application is considered to be unknown locator.
</li>
</ul>
	
</li>
<li>Shim - The conceptual sub-layer inside the IP layer which
	maintains mappings between EIDs and locators.  An EID can be
	associated with more than one locator at a time when the host
	is multihomed.  The term 'shim' does not refer to a specific
	protocol but refers to the conceptual sub-layer inside the IP
	layer.
</li>
<li>Identifier/locator adaptation - The adaptation performed at
	the shim sub-layer which may end up re-writing the source
	and/or destination addresses of an IP packet.  In the outbound
	packet processing, the EID pair is converted to the associated
	locator pair.  In the inbound packet processing, the locator
	pair is converted to the EID pair.
</li>
<li>Context - The state information shared by a given pair of
	peers, which stores a binding between the EID and associated
	locators.  Contexts are maintained by the shim sub-layer.
</li>
<li>Reachability detection - The procedure to check
	reachability between a given locator pair.
</li>
<li>Path - The sequence of routers that an IP packet goes
	through to reach the destination.
</li>
<li>Path exploration - The procedure to explore available paths
	for a given set of locator pairs.
</li>
<li>Outage - The incident that prevents IP packets to flow from
	the source locator to the destination locator.  When there is
	an outage, it means that there is no reachability between a
	given locator pair.  The outage may be caused by various
	reasons, such as shortage of network resources, congestion,
	and human error (faulty operation).
</li>
<li>Working address pair - The address pair is considered to be
	"working" if the packet can safely travel from the source to
	the destination where the packet contains the first address
	from the pair as the source address and the second address
	from the pair as the destination address.  If reachability is
	confirmed in both directions, the address pair is considered
	to be working bi-directionally.
</li>
<li>Reachability protocol (REAP) - The protocol for detecting
	failure and exploring reachability in a multihomed
	environment.  REAP is defined in <a class='info' href='#RFC5534'>[RFC5534]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration 	  Protocol for IPv6 Multihoming,&rdquo; June&nbsp;2009.</span><span>)</span></a>.
</li>
</ul><p>
      
</p>
<a name="sec-system-overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
System Overview</h3>

<p><a class='info' href='#fig-system-overview'>Figure&nbsp;1<span> (</span><span class='info'>System overview</span><span>)</span></a> illustrates the system
      overview.  The shim sub-layer and REAP component exist inside
      the IP layer.  Applications use the sockets API defined in this
      document to interface with the shim sub-layer and the transport
      layer for locator management, failure detection, and path
      exploration.
</p>
<p>It may also be possible that the shim sub-layer interacts
      with the transport layer, however, such an interaction is
      outside the scope of this document.
</p><br /><hr class="insert" />
<a name="fig-system-overview"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                     +------------------------+
                     |       Application      |
                     +------------------------+
                        ^                 ^
           ~~~~~~~~~~~~~|~Socket Interface|~~~~~~~~~~~~~~
                        |                 v
            +-----------|------------------------------+
            |           |  Transport Layer             |
            +-----------|------------------------------+
                  ^     |
    +-------------|-----|-------------------------------------+
    |             v     v                                     |
    |   +-----------------------------+       +----------+    |  IP
    |   |            Shim             |&lt;-----&gt;|   REAP   |    | Layer
    |   +-----------------------------+       +----------+    |
    |                       ^                      ^          |
    +-----------------------|----------------------|----------+
                            v                      v
            +------------------------------------------+
            |                Link Layer                |
            +------------------------------------------+

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: System overview&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="sec-requirements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Requirements</h3>

<p>The following is a list of requirements from applications:

      
      
      
      </p>
<ul class="text">
<li>Turn on/off shim.  An application should be able to request
	to turn on or turn off the multihoming support by the shim
	layer:

	
<ul class="text">
<li>Apply shim.  The application should be able to explicitly
	  request the shim sub-layer to apply multihoming support.
</li>
<li>Don't apply shim.  The application should be able to
	  request the shim sub-layer not to apply the multihoming
	  support but to apply normal IP processing at the IP
	  layer.
</li>
<li>Note that this function is also required by other types
	  of multihoming mechanisms such as SCTP and multipath TCP to
	  avoid potential conflict with the shim sub-layer.
</li>
</ul>
	
</li>
<li>Locator management.
	
<ul class="text">
<li>It should be possible to set preferred source and/or
          destination locator within a given context: Lp(local) and/or
          Lp(remote).
</li>
<li>It should be possible to get preferred source and/or
          destination locator within a given context: Lp(local) and/or
          Lp(remote).
</li>
<li>It should be possible to set a list of source and/or
	  destination locators within a given context: Ls(local) and
	  Ls(remote).
</li>
<li>It should be possible to get a list of source and/or
	  destination locators within a given context: Ls(local) and
	  Ls(remote).
</li>
</ul>
	
</li>
<li>Notification from applications to the shim sub-layer about
	the status of the communication.  The notification occurs in
	an event-based manner.  Applications and/or upper layer
	protocols may provide positive feedbacks or negative feedbacks
	to the shim sub-layer.  Note that these feedbacks are
	mentioned in
	<a class='info' href='#RFC5534'>[RFC5534]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration 	  Protocol for IPv6 Multihoming,&rdquo; June&nbsp;2009.</span><span>)</span></a>:
	
	
<ul class="text">
<li>Applications and/or upper layer protocols (e.g., TCP) may
	  provide positive feedbacks to the shim sub-layer informing
	  that the communication is going well.
</li>
<li>Applications and/or upper layer protocols (e.g., TCP) may
	  provide negative feedbacks to the shim sub-layer informing
	  that the communication status is not satisfactory.  TCP may
	  detect a problem when it does not receive any expected ACK
	  message from the peer.  Besides, a receipt of an ICMP error
	  message could be a clue for the application to detect
	  problems.  The REAP module may be triggered by these
	  negative feedbacks and invoke the path exploration
	  procedure.
</li>
</ul>

  	
</li>
<li>Feedback from applications to the shim sub-layer.
	Applications should be able to inform the shim sub-layer of
	the timeout values for detecting failures, sending keepalives,
	and starting the exploration procedure.  In particular,
	applications should be able to suppress keepalives.
	
</li>
<li>Hot-standby.  Applications may request the shim sub-layer
	for the hot-standby capability.  This means that, alternative
	paths are known to be working in advance of a failure
	detection.  In such a case, it is possible for the host to
	immediately replace the current locator pair with an
	alternative locator pair.
	
</li>
<li>Eagerness for locator exploration.  An application should
	be able to inform the shim sub-layer of how aggressively it
	wants the REAP mechanism to perform a path exploration (e.g.,
	by specifying the number of concurrent attempts of discovery
	of working locator pairs) when an outage occurs on the path
	between the locator pair in use.
</li>
<li>Providing locator information to applications.  An
	application should be able to obtain information about the
	locator pair which was actually used to send or receive the
	packet.  
<ul class="text">
<li>For inbound traffic, the application may be interested in
	  the locator pair which was actually used to receive the
	  packet.
	  
</li>
<li>For outbound traffic, the application may be interested
	  in the locator pair which was actually used to transmit the
	  packet.
</li>
</ul>

	In this way, applications may have additional control on the
	locator management.  For example, an application becomes able
	to verify if its preference for locator is actually applied to
	the flow or not.
	
</li>
<li>Applications should be able to specify if they want to
	defer the context setup, or if they want context establishment
	to be started immediately in the case where there is no
	available context.  A deferred context setup means that the
	initiation of communication should not be blocked to wait for
	completion of the context establishment.
</li>
<li>An application should be able to know if the communication
	is now being served by the shim sub-layer or not.
</li>
<li>An application should be able to use a common interface to
	access an IPv4 locator and an IPv6 locator.
</li>
</ul><p>	
    
</p>
<a name="sec-shim-socket-options"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Socket Options for Multihoming Shim Sub-layer</h3>

<p>In this section, socket options that are specific to the shim
      sub-layer are defined.
</p>
<p><a class='info' href='#tab-shim-socket-options'>Table&nbsp;1<span> (</span><span class='info'>Socket options for multihoming shim sub-layer</span><span>)</span></a> shows a list of the
      socket options that are specific to the shim sub-layer.  An
      application may use these socket options for a given socket
      either by the getsockopt() system call or by the setsockopt()
      system call.  All of these socket options are defined at level
      SOL_SHIM.
</p>
<p>The first column of <a class='info' href='#tab-shim-socket-options'>Table&nbsp;1<span> (</span><span class='info'>Socket options for multihoming shim sub-layer</span><span>)</span></a>
      gives the name of the option.  The second and third columns
      indicate whether the option can be handled by the getsockopt()
      system call and/or by the setsockopt() system call.  The fourth
      column provides a brief description of the socket option.  The
      fifth column shows the type of data structure specified along
      with the socket option.  By default, the data structure type is
      an integer.
</p><br /><hr class="insert" />
<a name="tab-shim-socket-options"></a>
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left"><col align="left"><col align="left"><col align="left">
<tr><th align="left">optname</th><th align="left">get</th><th align="left">set</th><th align="left">description</th><th align="left">dtype</th></tr>
<tr>
<td align="left">SHIM_ASSOCIATED</td>
<td align="left">o</td>
<td align="left">&nbsp;</td>
<td align="left">Get the parameter which indicates whether if the socket is
	associated with any shim context or not.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_DONTSHIM</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the parameter which indicates whether to employ
	  the multihoming support by the shim sub-layer or not.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_HOT_STANDBY</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the parameter to request the shim sub-layer to
	  prepare a hot-standby connection.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_PREF</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the preferred locator on the local side for the
	context associated with the socket.</td>
<td align="left">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_PREF</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the preferred locator on the remote side for the
	context associated with the socket.</td>
<td align="left">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_RECV</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the parameter which is used to request the shim
	sub-layer to store the destination locator of the received IP
	packet.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_RECV</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the parameter which is used to request the shim
	sub-layer to store the source locator of the received IP
	packet.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_SEND</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the source locator of outgoing IP packets.</td>
<td align="left">*2</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_SEND</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the destination locator of outgoing IP packets.</td>
<td align="left">*2</td>
</tr>
<tr>
<td align="left">SHIM_LOCLIST_LOCAL</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the list of locators associated with the local
	EID.</td>
<td align="left">*3</td>
</tr>
<tr>
<td align="left">SHIM_LOCLIST_PEER</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the list of locators associated with the peer's
	EID.</td>
<td align="left">*3</td>
</tr>
<tr>
<td align="left">SHIM_APP_TIMEOUT</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the timeout value for detecting failure.</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">SHIM_PATHEXPLORE</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set parameters for path exploration and failure
	  detection.</td>
<td align="left">*4</td>
</tr>
<tr>
<td align="left">SHIM_CONTEXT_DEFERRED_SETUP</td>
<td align="left">o</td>
<td align="left">o</td>
<td align="left">Get or set the parameter which indicates whether deferred
	  context setup is supported or not.</td>
<td align="left">int</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Table 1: Socket options for multihoming shim sub-layer&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>*1: Pointer to a shim_locator which is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p>*2: Pointer to shim_locator data structure.
</p>
<p>*3: Pointer to an array of shim_locator.
</p>
<p>*4: Pointer to a shim_pathexplore which is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p><a class='info' href='#fig-socket-api-model'>Figure&nbsp;2<span> (</span><span class='info'>System model of sockets API with shim sub-layer</span><span>)</span></a> illustrates how the
      shim specific socket options fit into the system model of socket
      API.  The figure shows that the shim sub-layer and the
      additional protocol components (IPv4 and IPv6) below the shim
      sub-layer are new to the system model.  As previously mentioned,
      all the shim specific socket options are defined at the SOL_SHIM
      level.  This design choice brings the following
      advantages:<br />
<br />


      </p>
<ol class="text">
<li>The existing sockets API continue to work at the layer
	above the shim sub-layer.  That is, those legacy API handle IP
	addresses as identifiers.
</li>
<li>With newly defined socket options for the shim sub-layer, the
	application obtains additional control of locator
	management.
</li>
<li>The shim specific socket options can be kept independent
	from address family (IPPROTO_IP or IPPROTO_IPV6) and transport
	protocol (IPPROTO_TCP or IPPROTO_UDP).
</li>
</ol><p>

      
</p><br /><hr class="insert" />
<a name="fig-socket-api-model"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                         s1 s2      s3 s4
                          |  |       |  |
         +----------------|--|-------|--|----------------+
         |             +-------+   +-------+             |
         | IPPROTO_TCP |  TCP  |   |  UDP  |             |
         |             +-------+   +-------+             |
         |                |   \     /   |                |
         |                |    -----    |                |
         |                |   /     \   |                |
         |              +------+   +------+              |
         |   IPPROTO_IP | IPv4 |   | IPv6 | IPPROTO_IPV6 |
         |              +------+   +------+              |
         |                  \         /             SOL_SOCKET
         |          +--------\-------/--------+          |
         | SOL_SHIM |          shim           |          |
         |          +--------/-------\--------+          |
         |                  /         \                  |
         |              +------+   +------+              |
         |              | IPv4 |   | IPv6 |              |
         |              +------+   +------+              |
         |                  |          |                 |
         +------------------|----------|-----------------+
                            |          |
                          IPv4       IPv6
                        Datagram   Datagram

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: System model of sockets API with shim sub-layer&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
SHIM_ASSOCIATED</h3>

<p>The SHIM_ASSOCIATED option is used to check whether the
	socket is associated with any shim context or not.
</p>
<p>This option is meaningful when the locator information of
	the received IP packet does not tell whether the
	identifier/locator adaptation is performed or not.  Note that
	the EID pair and the locator pair may be identical in some
	cases.
</p>
<p>This option can be specified by getsockopt().  Thus, the
	option is read-only and the result (0/1/2) is set in the
	option value (the fourth argument of getsockopt()).
</p>
<p>The data type of the option value is an integer.  The
	option value indicates the presence of shim context.  A return
	value 1 means that the socket is associated with a shim
	context at the shim sub-layer.  A return value 0 indicates
	that there is no shim context associated with the socket.  A
	return value 2 means that it is not known whether the socket
	is associated with a shim context or not, and this must be
	returned only when the socket is unconnected.  In other words,
	the returned value must be 0 or 1 when the socket is
	connected.
</p>
<p>For example, the option can be used by the application as
	follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int optlen = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_ASSOCIATED, &amp;optval, &amp;optlen);
</pre></div>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
SHIM_DONTSHIM</h3>

<p>The SHIM_DONTSHIM option is used to request the shim layer
	not to provide the multihoming support for the communication
	established over the socket.
</p>
<p>The data type of the option value is an integer, and it
	takes 0 or 1. An option value 0 means that the shim sub-layer
	is employed if available. An option value 1 means that the
	application does not want the shim sub-layer to provide the
	multihoming support for the communication established over the
	socket.
</p>
<p>Default value is set as 0, which means that the shim
	sub-layer performs identifier/locator adaptation if
	available.
</p>
<p>Any attempt to disable the multihoming shim support MUST be
	made by the application before the socket is connected. If an
	application makes such an attempt for a connected-socket, an
	error code EOPNOTSUPP MUST be returned.
</p>
<p>For example, an application can request the system not to
	apply the multihoming support as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 1;

    setsockopt(fd, SOL_SHIM, SHIM_DONTSHIM, &amp;optval, sizeof(optval));
</pre></div>
<p>For example, the application can check the option value as
	follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_DONTSHIM, &amp;optval, &amp;len);
</pre></div>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
SHIM_HOT_STANDBY</h3>

<p>The SHIM_HOT_STANDBY option is used to control the shim
	sub-layer whether to employ a hot-standby connection for the
	socket or not.  A hot-standby connection is an alternative
	working locator pair to the current locator pair.  This option
	is effective only when there is a shim context associated with
	the socket.
</p>
<p>The data type of the option value is an integer.
</p>
<p>The option value can be set by setsockopt().
</p>
<p>The option value can be read by getsockopt().
</p>
<p>By default, the value is set to 0, meaning that hot-standby
	connection is disabled.
</p>
<p>For example, an application can request establishment of a
	hot-standby connection by using the socket option as
	follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 1;

    setsockopt(fd, SOL_SHIM, SHIM_HOT_STANDBY, &amp;optval,
               sizeof(optval));
</pre></div>
<p>For example, an application can get the option value by
	using the socket option as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_HOT_STANDBY, &amp;optval, &amp;len);
</pre></div>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
SHIM_PATHEXPLORE</h3>

<p>The application may use this socket option to specify
	parameters concerning path exploration.  Path exploration is a
	procedure to find an alternative locator pair to the current
	locator pair.  As the REAP specification defines, a peer may
	send Probe messages to find an alternative locator pair.
</p>
<p>The option is effective only when there is a shim context
	associated with the socket.
</p>
<p>The data type of the option value is a pointer to the
	buffer where a set of information for path exploration is
	stored.  The data structure is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p>By default, the option value is set to NULL, meaning that
	the option is disabled.
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>For example, an application can set parameters for path
	exploration by using the socket option as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim6_pathexplore pe;

    pe.pe_probenum = 4;        /* times */
    pe.pe_keepaliveto = 10;    /* seconds */
    pe.pe_initprobeto = 500;   /* milliseconds */
    pe.pe_reserved = 0;

    setsockopt(fd, SOL_SHIM, SHIM_PATHEXPLORE, &amp;pe, sizeof(pe));
</pre></div>
<p>For example, an application can get parameters for path
	exploration by using the socket option as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim6_pathexplore pe;
    int len;

    len = sizeof(pe);

    getsockopt(fd, SOL_SHIM, SHIM_PATHEXPLORE, &amp;pe, &amp;len);
</pre></div>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.5"></a><h3>5.5.&nbsp;
SHIM_LOC_LOCAL_PREF</h3>

<p>The SHIM_LOC_LOCAL_PREF option is used to get or set
	preferred locator on local side within a given context.  Hence
	this option is effective only when there is a shim context
	associated with the socket.
</p>
<p>The data type of the option value is a pointer to a locator
	information data structure which is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p>By default, the option value is set to NULL, meaning that
	the option is disabled.
</p>
<p>The preferred locator can be set by setsockopt().  The shim
	sub-layer shall verify requested locator before it updating
	the preferred locator.
</p>
<p>An application can get the preferred locator by
	getsockopt().
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR is returned when the validation of
	the specified locator failed.
</p>
<p>For example, an application can set the preferred locator
	by using the socket option as follows.  Note that some members
	of the shim_locator (lc_ifidx and lc_flags) are ignored in the
	set operation.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator lc;
    struct in6_addr ip6;

    /* ...set the locator (ip6)... */

    memset(&amp;lc, 0, sizeof(shim_locator));
    lc.lc_family = AF_INET6;  /* IPv6 */
    lc.lc_ifidx = 0;
    lc.lc_flags = 0;
    lc.lc_preference = 255;
    memcpy(lc.lc_addr, &amp;ip6, sizeof(in6_addr));

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_PREF, &amp;lc,
               sizeof(optval));
</pre></div>
<p>For example, an application can get the preferred locator
	by using the socket option as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator lc;
    int len;

    len = sizeof(lc);

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_PREF, &amp;lc, &amp;len);
</pre></div>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.6"></a><h3>5.6.&nbsp;
SHIM_LOC_PEER_PREF</h3>

<p>The SHIM_LOC_PEER_PREF option is used to get or set
	preferred locator on peer side within a given context.  Hence
	this option is effective only when there is a shim context
	associated with the socket.
</p>
<p>The data type of the option value is a pointer to the
	locator information data structure which is defined in <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a>.
</p>
<p>By default, the option value is set to NULL, meaning that
	the option is disabled.
</p>
<p>The preferred locator can be set by setsockopt().  The shim
	sub-layer shall verify requested locator before it updating
	the preferred locator.
</p>
<p>An application can get the preferred locator by
	getsockopt().
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR is returned when the validation of
	the requested locator fails.
</p>
<p>The usage of the option is same as that of
	SHIM_LOC_LOCAL_PREF.  Note that some members of the
	shim_locator (lc_ifidx and lc_flags) are ignored in the set
	operation.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.7"></a><h3>5.7.&nbsp;
SHIM_LOC_LOCAL_RECV</h3>

<p>The SHIM_LOC_LOCAL_RECV option can be used to request the
	shim sub-layer to store the destination locator of the
	received IP packet in an ancillary data object which can be
	accessed by recvmsg().  Hence this option is effective only
	when there is a shim context associated with the socket.
</p>
<p>The data type of the option value is integer. The option
	value should be binary (0 or 1).  By default, the option value
	is set to 0, meaning that the option is disabled.
</p>
<p>An application can set the option value by
	setsockopt().
</p>
<p>An application can get the option value by
	getsockopt().
</p>
<p>See <a class='info' href='#sec-access-to-locinfo'>Section&nbsp;6<span> (</span><span class='info'>Ancillary Data for Multihoming Shim Sub-layer</span><span>)</span></a> for the
	procedure to access locator information stored in the
	ancillary data objects.
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>For example, an application can request the shim sub-layer
	to store destination locator by using the socket option as
	follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 1;

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, &amp;optval,
               sizeof(optval));
</pre></div>
<p>For example, an application can get the option value as
	follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, &amp;optval, &amp;len);
</pre></div>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.8"></a><h3>5.8.&nbsp;
SHIM_LOC_PEER_RECV</h3>

<p>The SHIM_LOC_PEER_RECV option is used to request the shim
	sub-layer to store the source locator of the received IP
	packet in an ancillary data object which can be accessed by
	recvmsg().  Hence this option is effective only when there is
	a shim context associated with the socket.
</p>
<p>The data type of the option value is integer. The option
	value should be binary (0 or 1).  By default, the option value
	is set to 0, meaning that the option is disabled.
</p>
<p>The option value can be set by setsockopt().
</p>
<p>The option value can be read by getsockopt().
</p>
<p>See <a class='info' href='#sec-access-to-locinfo'>Section&nbsp;6<span> (</span><span class='info'>Ancillary Data for Multihoming Shim Sub-layer</span><span>)</span></a> for the
	procedure to access locator information stored in the
	ancillary data objects.
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>The usage of the option is same as that of
	SHIM_LOC_LOCAL_RECV option.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.9"></a><h3>5.9.&nbsp;
SHIM_LOC_LOCAL_SEND</h3>

<p>The SHIM_LOC_LOCAL_SEND option is used to request the shim
	sub-layer to use a specific locator as the source locator for
	the IP packets to be sent from the socket.  Hence this option
	is effective only when there is a shim context associated with
	the socket.
</p>
<p>The data type of option value is pointer to shim_locator
	data structure.
</p>
<p>An application can set the local locator by setsockopt()
	providing a valid locator which is stored in a shim_locator
	data structure.  When a zero-filled locator is specified,
	pre-existing setting of local locator is inactivated.
</p>
<p>An application can get the local locator by
	getsockopt().
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR is returned when invalid locator
	is specified.
</p>
<p>For example, an application can request the shim sub-layer
	to use a specific local locator by using the socket option as
	follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator locator;
    struct in6_addr ia6;

    /* an IPv6 address preferred for the source locator is copied
       to the parameter ia6 */

    memset(&amp;locator, 0, sizeof(locator));

    /* fill shim_locator data structure */
    locator.lc_family = AF_INET6;
    locator.lc_ifidx = 1;
    locator.lc_flags = 0;
    locator.lc_preference = 0;
    memcpy(&amp;locator.lc_addr, &amp;ia6, sizeof(ia6));

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_SEND, &amp;locator,
               sizeof(locator));
</pre></div>
<p>For example, an application can get the preferred local
	locator by using the socket option as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator locator;

    memset(&amp;locator, 0, sizeof(locator));

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_SEND, &amp;locator,
               sizeof(locator));

    /* check locator */
</pre></div>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.10"></a><h3>5.10.&nbsp;
SHIM_LOC_PEER_SEND</h3>

<p>The SHIM_LOC_PEER_SEND option is used to request the shim
	sub-layer to use a specific locator for the destination
	locator of IP packets to be sent from the socket.  Hence this
	option is effective only when there is a shim context
	associated with the socket.
</p>
<p>The data type of the option value is a pointer to
	shim_locator data structure.
</p>
<p>An application can set the remote locator by setsockopt()
	providing a valid locator which is stored in a shim_locator
	data structure.  When a zero-filled locator is specified,
	pre-existing setting of remote locator is inactivated.
</p>
<p>An application can get the specified remote locator by
	getsockopt().
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR when invalid locator is
	specified.
</p>
<p>The usage of the option is as the same as that of
	SHIM_LOC_LOCAL_SEND option.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.11"></a><h3>5.11.&nbsp;
SHIM_LOCLIST_LOCAL</h3>

<p>The SHIM_LOCLIST_LOCAL option is used to get or set the
	locator list associated with the local EID of the shim context
	associated with the socket.  Hence this option is effective
	only when there is a shim context associated with the
	socket.
</p>
<p>The data type of the option value is a pointer to the
	buffer in which a locator list is stored.  See <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a> for the data structure for
	storing the locator information.  By default, the option value
	is set to NULL, meaning that the option is disabled.
</p>
<p>An application can get the locator list by getsockopt().
	Note that the size of the buffer pointed by optval argument
	should be large enough to store an array of locator
	information.  The number of the locator information is not
	known beforehand.
</p>
<p>The local locator list can be set by setsockopt().  The
	buffer pointed by optval argument should contain an array of
	locator list.
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR is returned when the validation of
	the specified locator failed.
</p>
<p>An error ETOOMANYLOCATORS is returned when the number of
	locators specified exceeds the limit (SHIM_MAX_LOCATORS).
</p>
<p>For example, an application can set a list of locators to
	be associated with the local EID by using the socket option as
	follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator locators[SHIM_MAX_LOCATORS];
    struct sockaddr_in *sin;
    struct sockaddr_in6 *sin6;

    memset(locators, 0, sizeof(locators));

    ...

    /* obtain local IP addresses from local interfaces */

    ...

    /* first locator (an IPv6 address) */
    locators[0].lc_family = AF_INET6;
    locators[0].lc_ifidx = 0;
    locators[0].lc_flags = 0;
    locators[0].lc_preference = 1;
    memcpy(&amp;locators[0].lc_addr, &amp;sa6-&gt;sin6_addr,
           sizeof(sa6-&gt;sin6_addr));

    ...

    /* second locator (an IPv4 address) */
    locators[1].lc_family = AF_INET;
    locators[1].lc_ifidx = 0;
    locators[1].lc_flags = 0;
    locators[1].lc_preference = 0;
    memcpy(&amp;locators[1].lc_addr, &amp;sa-&gt;sin_addr,
           sizeof(sa-&gt;sin_addr));

    setsockopt(fd, SOL_SHIM, SHIM_LOCLIST_LOCAL, locators,
               sizeof(locators));
</pre></div>
<p>For example, an application can get a list of locators that
	are associated with the local EID by using the socket option
	as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    struct shim_locator locators[SHIM_MAX_LOCATORS];

    memset(locators, 0, sizeof(locators));

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, locators,
               sizeof(locators));

    /* parse locators */
    ...

</pre></div>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.12"></a><h3>5.12.&nbsp;
SHIM_LOCLIST_PEER</h3>

<p>The SHIM_LOCLIST_PEER option is used to get or set the
	locator list associated with the peer EID of the shim context
	associated with the socket.  Hence this option is effective
	only when there is a shim context associated with the
	socket.
</p>
<p>The data type of the option value is a pointer to the
	buffer where a locator list is stored.  See <a class='info' href='#sec-data-structures'>Section&nbsp;7<span> (</span><span class='info'>Data Structures</span><span>)</span></a> for the data structure for
	storing the locator information.  By default, the option value
	is set to NULL, meaning that the option is disabled.
</p>
<p>An application can get the locator list by getsockopt().
	Note that the size of the buffer pointed by optval argument
	should be large enough to store an array of locator
	information.  The number of the locator information is not
	known beforehand.
</p>
<p>An application can set the locator list by setsockopt().
	The buffer pointed by optval argument should contain an array
	of locator list.
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>An error EINVALIDLOCATOR is returned when the validation of
	the specified locator failed.
</p>
<p>An error ETOOMANYLOCATORS is returned when the number of
	locators specified exceeds the limit (SHIM_MAX_LOCATORS).
</p>
<p>The usage of the option is same as that of
	SHIM_LOCLIST_LOCAL.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.13"></a><h3>5.13.&nbsp;
SHIM_APP_TIMEOUT</h3>

<p>The SHIM_APP_TIMEOUT option is used to get or set the
	timeout value for application to detect failure.  Hence this
	option is effective only when there is a shim context
	associated with the socket.
</p>
<p>The data type of the option value is an integer.  The value
	indicates the period of timeout in seconds to send a REAP
	Keepalive message since the last outbound traffic.  By
	default, the option value is set to 0, meaning that the option
	is disabled.  When the option is disabled, the REAP mechanism
	follows its default value of Send Timeout value as specified
	in <a class='info' href='#RFC5534'>[RFC5534]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration 	  Protocol for IPv6 Multihoming,&rdquo; June&nbsp;2009.</span><span>)</span></a>
</p>
<p>If the timeout value specified is longer than the Send
	Timeout configured in the REAP component, the REAP Keepalive
	message should be suppressed.
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>For example, an application can set the timeout value by
	using the socket option as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 15; /* 15 seconds */

    setsockopt(fd, SOL_SHIM, SHIM_APP_TIMEOUT, &amp;optval,
               sizeof(optval));
</pre></div>
<p>For example, an application can get the timeout value by
	using the socket option as follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_APP_TIMEOUT, &amp;optval, &amp;len);
</pre></div>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.14"></a><h3>5.14.&nbsp;
SHIM_DEFERRED_CONTEXT_SETUP</h3>

<p>The SHIM_DEFERRED_CONTEXT_SETUP option is used to specify
	whether to enable deferred context setup or not.  Deferred
	context setup means that the context is established in
	parallel with the data communication.  Note that SHIM6
	supports deferred context setup and HIP does not because EIDs
	in HIP (i.e., Host Identifiers) are non-routable.
</p>
<p>The data type for the option value is an integer.  The
	option value should be binary (0 or 1).  By default, the value
	is set to 1, meaning that the context setup is deferred.  In
	order to disable the option, the application should call
	setsockopt() with option value set to 0.
</p>
<p>Note that HIP does not support deferred context setup, by
	default.  When the application requests to enable deferred
	context setup in case of HIP, it may mean that the application
	allows the system to start TCP handshake even when there is no
	IPsec security association with the peer.  Such a usage of the
	SHIM_DEFERRED_CONTEXT_SETUP option should be considered as
	experimental and left for further study.
</p>
<p>For example, an application can disable the deferred
	context setup by using the socket option as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;

    optval = 0;

    setsockopt(fd, SOL_SHIM, SHIM_DEFERRED_CONTEXT_SETUP,
               &amp;optval, sizeof(optval));
</pre></div>
<p>For example, an application can get the option value as
	follows.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_DEFERRED_CONTEXT_SETUP,
               &amp;optval, &amp;len);
</pre></div>
<a name="sec-socket-options-applicability"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.15"></a><h3>5.15.&nbsp;
Applicability</h3>

<p>All the socket options for the shim sub-layer except for
	SHIM_HOT_STANDBY are applicable to both connected and
	unconnected sockets.  SHIM_HOT_STANDBY socket option is
	applicable only to connected sockets.  This is because the
	shim sub-layer cannot initiate context establishment to create
	a hot standby connection when the peer's IP address is not
	known until the application writes data to the unconnected
	socket.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.16"></a><h3>5.16.&nbsp;
Error Handling</h3>

<p>If successful, getsockopt() and setsockopt() return 0;
	otherwise, the functions return -1 and set errno to indicate
	an error.
</p>
<p>The following are new error values defined for some shim
	specific socket options indicating that the getsockopt() or
	setsockopt() finished incompletely:<br />
<br />


	</p>
<blockquote class="text"><dl>
<dt>EINVALIDLOCATOR</dt>
<dd>This
	  indicates that at least one of the necessary validations
	  inside the shim sub-layer for the specified locator has failed.
	  In case of SHIM6, there are two kinds of verifications
	  required for security reasons prior to sending an IP packet
	  to the peer's new locator; one is the return routability
	  (check if the peer is actually willing to receive data with
	  the specified locator) and the other one is the verification
	  based on crypto identifier mechanisms <a class='info' href='#RFC3972'>[RFC3972]<span> (</span><span class='info'>Aura, T., &ldquo;Cryptographically Generated Addresses (CGA),&rdquo; March&nbsp;2005.</span><span>)</span></a>, <a class='info' href='#RFC5535'>[RFC5535]<span> (</span><span class='info'>Bagnulo, M., &ldquo;Hash Based Addresses (HBA),&rdquo; June&nbsp;2009.</span><span>)</span></a>.
</dd>
</dl></blockquote><p>

	
</p>
<a name="sec-access-to-locinfo"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Ancillary Data for Multihoming Shim Sub-layer</h3>

<p>This section provides definitions of ancillary data to be
      used for locator management and notification from/to the shim
      sub-layer to/from application.
</p>
<p>When the application performs locator management by sendmsg()
      or recvmsg(), a member of the msghdr structure (given in
      <a class='info' href='#fig-msghdr'>Figure&nbsp;3<span> (</span><span class='info'>msghdr structure</span><span>)</span></a>) called msg_control holds a pointer
      to the buffer in which one ore more shim specific ancillary data
      objects may be stored.  An ancillary data object can store a
      single locator.  It should be possible to process the shim
      specific ancillary data object by the existing macros defined in
      the Posix standard and <a class='info' href='#RFC3542'>[RFC3542]<span> (</span><span class='info'>Stevens, W., Thomas, M., Nordmark, E., and T. Jinmei, &ldquo;Advanced Sockets Application Program Interface (API) 	  for IPv6,&rdquo; May&nbsp;2003.</span><span>)</span></a>.
</p><br /><hr class="insert" />
<a name="fig-msghdr"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     struct msghdr {
             caddr_t msg_name;       /* optional address */
             u_int   msg_namelen;    /* size of address */
             struct  iovec *msg_iov; /* scatter/gather array */
             u_int   msg_iovlen;     /* # elements in msg_iov */
             caddr_t msg_control;    /* ancillary data, see below */
             u_int   msg_controllen; /* ancillary data buffer len */
             int     msg_flags;      /* flags on received message */
     };
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: msghdr structure&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>In the case of unconnected socket, msg_name stores the socket
      address of the peer which should be considered to be an
      identifier rather than a locator.  SHIM_LOC_PEER_RECV should be
      used to get the locator of the peer node.
</p>
<p><a class='info' href='#tab-shim-ancillary-data'>Table&nbsp;2<span> (</span><span class='info'>Shim specific ancillary data</span><span>)</span></a> is a list of the
      shim specific ancillary data which can be used for locator
      management by recvmsg() or sendmsg().  In any case, the value of
      cmsg_level must be set as SOL_SHIM.
</p><br /><hr class="insert" />
<a name="tab-shim-ancillary-data"></a>
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="center"><col align="center"><col align="center">
<tr><th align="left">cmsg_type</th><th align="center">sendmsg()</th><th align="center">recvmsg()</th><th align="center">cmsg_data[]</th></tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_RECV</td>
<td align="center">&nbsp;</td>
<td align="center">o</td>
<td align="center">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_RECV</td>
<td align="center">&nbsp;</td>
<td align="center">o</td>
<td align="center">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_LOCAL_SEND</td>
<td align="center">o</td>
<td align="center">&nbsp;</td>
<td align="center">*1</td>
</tr>
<tr>
<td align="left">SHIM_LOC_PEER_SEND</td>
<td align="center">o</td>
<td align="center">&nbsp;</td>
<td align="center">*1</td>
</tr>
<tr>
<td align="left">SHIM_FEEDBACK</td>
<td align="center">o</td>
<td align="center">&nbsp;</td>
<td align="center">shim_feedback{}</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Table 2: Shim specific ancillary data&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>*1: cmsg_data[] includes a single sockaddr_in{} or
      sockaddr_in6{} and padding if necessary
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Get Locator from Incoming Packet</h3>

<p>An application can get locator information from the
	received IP packet by specifying the shim specific socket
	options for the socket.  When SHIM_LOC_LOCAL_RECV and/or
	SHIM_LOC_PEER_RECV socket options are set, the application can
	retrieve local and/or remote locator from the ancillary
	data.
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Set Locator for Outgoing Packet</h3>

<p>An application can specify the locators to be used for
	transmitting an IP packet by sendmsg().  When the ancillary
	data of cmsg_type SHIM_LOC_LOCAL_SEND and/or
	SHIM_LOC_PEER_SEND are specified, the application can
	explicitly specify the source and/or the destination locators
	to be used for the communication over the socket.
</p>
<p>Note that the effect is limited to the datagram transmitted
	by the sendmsg().
</p>
<p>If the specified locator pair is verified, the shim sub-layer
	overrides the locators of the IP packet.
</p>
<p>An error EINVALIDLOCATOR is returned when validation of the
	specified locator failed.
</p>
<a name="sec-feedback"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Notification from Application to Multihoming Shim Sub-layer</h3>

<p>An application may provide feedbacks to the shim sub-layer
	about the communication status.  Such feedbacks are
	particularly useful for the shim sub-layer in the absence of
	REAP mechanism to monitor the reachability status of the
	currently used locator pair in a given shim context.
</p>
<p>The notification can be made by sendmsg() specifying a new
	ancillary data called SHIM_FEEDBACK.  The ancillary data can
	be handled by specifying SHIM_FEEDBACK option in
	cmsg_type.
</p>
<p>An error ENOENT is returned when there is no context
	associated with the socket.
</p>
<p>See <a class='info' href='#sec-feedback-info'>Section&nbsp;7.3<span> (</span><span class='info'>Feedback Information</span><span>)</span></a> for details of the
	data structure to be used.
</p>
<p>It is outside the scope of this document how the shim
	sub-layer would react when a feedback is provided by an
	application.
</p>
<a name="sec-notification-shimtoapp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
Notification from Multihoming Shim Sub-layer to Application</h3>

<p>The shim sub-layer MAY provide notification about a locator
	change within a multihome shim context to applications that
	have concern with the context.  Such a notification may be
	useful, for example, for an application which is sensitive to
	the characteristics of the current path.  A locator change is
	caused when either of local or peer's locator (or both) is
	changed.  Note that locators discussed here are the ones that
	appear in the IP packet header, and not the ones that are
	included in the locator list.  A locator change may take place
	asynchronously.
</p>
<p>The notification is handled as an out-of-band data by the
	application.

	</p>
<ol class="text">
<li>Application calls the select() system call by setting
	  non-NULL value for the fourth argument.
</li>
<li>When there is a notification, the application reads
	  out-of-band data from the socket by calling recvmsg().
</li>
<li>The application checks the flag in the msghdr (msg_flags)
	  to see if there is any notification about locator change
	  delivered.  If the MSG_SHIM_LOCATOR_CHANGE flag is set,
	  application parses the chain of control message to read a
	  pair of ancillary data objects which contains the source
	  locator and the destination locator.  Note that the
	  direction of locator change is distinguished by the value of
	  cmsg_type; SHIM_LOC_*_RECV is used for inbound locator
	  change, and SHIM_LOC_*_SEND is used for outbound locator
	  change.
</li>
</ol><p>
	
</p>
<p>There is no restriction in terms of applicability of the
	notification about locator change.  The notification can be
	delivered to any type of socket (connected or unconnected,
	stream-oriented or datagram-oriented).
</p>
<a name="sec-ancillary-data-applicability"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.5"></a><h3>6.5.&nbsp;
Applicability</h3>

<p>All the ancillary data for the shim sub-layer is applicable
	to both connected and unconnected sockets.
</p>
<p>A care is needed when the SHIM_LOC_*_RECV socket option is
	used for stream-oriented sockets (e.g., TCP sockets) because
	there is no one-to-one mapping between a single send or
	receive operation and the data (e.g., a TCP segment) being
	received.  In other words, there is no gurantee that the
	locator(s) set in the SHIM_LOC_*_RECV ancillary data is
	identical to the locator(s) that appear in the IP packets
	received.  The shim sub-layer SHOULD provide the latest
	locator information to the application in response to the
	SHIM_LOC_*_RECV socket option.
	
</p>
<a name="sec-data-structures"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Data Structures</h3>

<p>This section data structures for the shim sub-layer.  These
      data structures are either used as a parameter for setsockopt()
      or getsockopt() (as mentioned in
      <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Sub-layer</span><span>)</span></a>) or as a parameter for
      ancillary data to be processed by sendmsg() or recvmsg() (as
      mentioned in <a class='info' href='#sec-access-to-locinfo'>Section&nbsp;6<span> (</span><span class='info'>Ancillary Data for Multihoming Shim Sub-layer</span><span>)</span></a>).
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Placeholder for Locator Information</h3>

<p>As defined in <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Sub-layer</span><span>)</span></a>, the
	SHIM_LOC_LOCAL_PREF, SHIM_LOC_PEER_PREF, SHIM_LOCLIST_LOCAL,
	and SHIM_LOCLIST_PEER socket options need to handle one or
	more locator information.  Locator information includes not
	only the locator itself but also additional information about
	the locator which is useful for locator management.  A new
	data structure is defined to serve as a placeholder for the
	locator information.
</p>
<p><a class='info' href='#fig-shim-locator'>Figure&nbsp;4<span> (</span><span class='info'>shim locator structure</span><span>)</span></a> illustrates the data
	structure called shim_locator which stores a locator
	information.

	<br /><hr class="insert" />
<a name="fig-shim-locator"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     struct shim_locator {
             uint8_t    lc_family;       /* address family */
             uint8_t    lc_proto;        /* protocol */
             uint16_t   lc_port;         /* port number */
             uint16_t   lc_flags;        /* flags */
             uint16_t   lc_pref;         /* preference value */
             uint32_t   lc_ifidx;        /* interface index */
             struct in6_addr lc_addr;    /* address */
     };
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: shim locator structure&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


	</p>
<blockquote class="text"><dl>
<dt>lc_family</dt>
<dd> Address
          family of the locator (e.g.  AF_INET, AF_INET6).  It is
          required that the parameter contains non-zero value
          indicating the exact address family of the locator.
</dd>
<dt>lc_proto</dt>
<dd>Internet
	  Protocol number for the protocol which is used to handle
	  locator behind NAT.  Typically, this value is set as UDP
	  (17) when the locator is a UDP encapsulation interface.
</dd>
<dt>lc_port</dt>
<dd>Port number
	  which is used for handling locator behind NAT.
</dd>
<dt>lc_flags</dt>
<dd>Each bit of
          the flags represents a specific characteristics of the
          locator.  Hash Based Address (HBA) is defined as 0x01.
          Cryptographically Generated Address (CGA) is defined as
          0x02.
</dd>
<dt>lc_pref</dt>
<dd>Preference of
          the locator.  The preference is represented by an
          integer.
</dd>
<dt>lc_ifidx</dt>
<dd>Interface
          index of the network interface to which the locator is
          assigned.  This field should be valid only in a read
          (getsockopt()) operation.
</dd>
<dt>lc_addr</dt>
<dd>Contains the
          locator.  In the case where a locator whose size is smaller
          than 16 bytes, an encoding rule should be provided for each
          locator of a given address family.  For instance, in case of
          AF_INET (IPv4), the locator should be in the format of an
          IPv4-mapped IPv6 address as defined in
          <a class='info' href='#RFC4291'>[RFC4291]<span> (</span><span class='info'>Hinden, R. and S. Deering, &ldquo;IP Version 6 Addressing Architecture,&rdquo; February&nbsp;2006.</span><span>)</span></a>.
</dd>
</dl></blockquote><p>
	
</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.1"></a><h3>7.1.1.&nbsp;
Handling Locator behind NAT</h3>

<p>Note that the locator information MAY contain a locator
	  behind a Network Address Translator (NAT).  Such a
	  situation may arise when the host is behind the NAT and uses
	  a local address as a source locator to communicate with the
	  peer.  Note that a NAT traversal mechanism for HIP is
	  defined, which allows HIP host to tunnel control and data
	  traffic over UDP<a class='info' href='#I-D.ietf-hip-nat-traversal'>[I&#8209;D.ietf&#8209;hip&#8209;nat&#8209;traversal]<span> (</span><span class='info'>Komu, M., Henderson, T., Tschofenig, H., Melen, J., and A. Keranen, &ldquo;Basic HIP Extensions for Traversal of Network Address 	    Translators,&rdquo; October&nbsp;2009.</span><span>)</span></a>.
	  Note also that the locator behind NAT is not necessarily an
	  IPv4 address but it can be an IPv6 address.  Below is an
	  example where the application sets a UDP encapsulation
	  interface as a source locator when sending IP packets.

	<br /><hr class="insert" />
<a name="fig-nat-locator-handling"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

       struct shim_locator locator;
       struct in6_addr ia6;

       /* copy the private IPv4 address to the ia6 as an IPv4-mapped
          IPv6 address */

       memset(&amp;locator, 0, sizeof(locator));

       /* fill shim_locator data structure */
       locator.lc_family = AF_INET;
       locator.lc_proto = IPPROTO_UDP;
       locator.lc_port = 50500;
       locator.lc_flags = 0;
       locator.lc_pref = 0;
       locator.lc_ifidx = 3;

       memcpy(&amp;locator.lc_addr, &amp;ia6, sizeof(ia6));

       setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_SEND, &amp;locator,
                  sizeof(locator));
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: Handling
	locator behind NAT&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

	  
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
Path Exploration Parameter</h3>

<p>As defined in <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Sub-layer</span><span>)</span></a>,
	SHIM_PATHEXPLORE allows application to set or read the
	parameters for path exploration and failure detection.  A new
	data structure called shim_pathexplore is defined to store the
	necessary parameters.  <a class='info' href='#fig-path-explore'>Figure&nbsp;6<span> (</span><span class='info'>path explore structure</span><span>)</span></a>
	illustrates the data structure.  The data structure can be
	passed to getsockopt() or setsockopt() as an argument.

	<br /><hr class="insert" />
<a name="fig-path-explore"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     struct shim_pathexplore {
             uint8_t   pe_probenum;      /* # of initial probe */
             uint8_t   pe_keepaliveto;   /* Keepalive Timeout */
             uint16_t  pe_initprobeto;   /* Initial Probe Timeout */
             uint32_t  pe_reserved;      /* reserved */
     };
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: path explore structure&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


	</p>
<blockquote class="text"><dl>
<dt>pe_probenum</dt>
<dd>
	    
	    Indicates the number of initial probe messages to be sent.
	    Default value of this parameter should follow what is
	    specified in <a class='info' href='#RFC5534'>[RFC5534]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration 	  Protocol for IPv6 Multihoming,&rdquo; June&nbsp;2009.</span><span>)</span></a>.
	  
</dd>
<dt>pe_keepaliveto</dt>
<dd>
	    
	    Indicates timeout value for detecting a failure when the
	    host does not receive any packets for a certain period of
	    time while there is outbound traffic.  When the timer
	    expires, path exploration procedure will be carried out by
	    sending a REAP Probe message.  Default value of this
	    parameter should follow what is specified in <a class='info' href='#RFC5534'>[RFC5534]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration 	  Protocol for IPv6 Multihoming,&rdquo; June&nbsp;2009.</span><span>)</span></a>.
	  
</dd>
<dt>pe_initprobeto</dt>
<dd>
	    
	    Indicates retransmission timer of REAP Probe message in
	    milliseconds.  Note that this timer is applied before
	    exponential back-off is started.  A REAP Probe message for
	    the same locator pair may be retransmitted.  Default value
	    of this parameter should follow what is specified in <a class='info' href='#RFC5534'>[RFC5534]<span> (</span><span class='info'>Arkko, J. and I. Beijnum, &ldquo;Failure Detection and Locator Pair Exploration 	  Protocol for IPv6 Multihoming,&rdquo; June&nbsp;2009.</span><span>)</span></a>.
	  
</dd>
<dt>pe_reserved</dt>
<dd>
	    
	    A reserved field for future extension.  By default, the
	    field should be initialized to zero.
	  
</dd>
</dl></blockquote><p>
	
</p>
<a name="sec-feedback-info"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
Feedback Information</h3>

<p>As mentioned in <a class='info' href='#sec-feedback'>Section&nbsp;6.3<span> (</span><span class='info'>Notification from Application to Multihoming Shim Sub-layer</span><span>)</span></a>, applications
	can inform the shim sub-layer about the status of unicast
	reachability of the locator pair currently in use.  The
	feedback information can be handled by using ancillary data
	called SHIM_FEEDBACK.  A new data structure named
	shim_feedback is illustrated in <a class='info' href='#fig-feedback-info'>Figure&nbsp;7<span> (</span><span class='info'>feedback information structure</span><span>)</span></a>.

	<br /><hr class="insert" />
<a name="fig-feedback-info"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     struct shim_feedback {
             uint8_t   fb_direction;    /* direction of traffic */
             uint8_t   fb_indicator;    /* indicator (1-3) */
             uint16_t  fb_reserved;     /* reserved */
     };
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;7: feedback information structure&nbsp;</b></font><br /></td></tr></table><hr class="insert" />


	</p>
<blockquote class="text"><dl>
<dt>direction</dt>
<dd>
	    
	    Indicates direction of reachability between a locator pair
	    in question.  A value 0 indicates outbound and a value 1
	    indicates inbound direction.
	  
</dd>
<dt>indicator</dt>
<dd>
	    
	    A value indicating the degree of satisfaction of a
	    unidirectional reachability for a given locator pair.
	  
	    
<ul class="text">
<li>0: Default value.  Whenever this value is specified
	      the feedback information must not be processed by the
	      shim sub-layer.
</li>
<li>1: Unable to connect.  There is no unidirectional
	      reachability between the locator pair in question.
</li>
<li>2: Unsatisfactory.  The application is not satisfied
	      with the unidirectional reachability between the locator
	      pair in question.
</li>
<li>3: Satisfactory.  There is satisfactory
	      unidirectional reachability between the locator pair in
	      question.
</li>
</ul>
	  
</dd>
<dt>reserved</dt>
<dd>
	    
	    Reserved field.  Must be ignored by the receiver.
	  
</dd>
</dl></blockquote><p>

	
</p>
<a name="sec-system-requirements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
System Requirements</h3>

<p>This section gives system requirements posed by the sockets
      API defined in this document.  There exist requirements for the
      system (kernel) to maintain the association between sockets and
      shim contexts.
</p>
<p>As addressed in <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Sub-layer</span><span>)</span></a>, all
      the socket options and ancillary data defined in this document
      except for the SHIM_HOT_STANDBY socket option are applicable to
      both connected and unconnected sockets.
</p>
<p>There are less system requirements to enable support for
      applications that use connected sockets.  This is because the
      kernel can maintain the association between a connected socket
      and a shim context in a static manner because a connected socket
      is bound to a source and destination IP addresses (identifiers).
      The kernel should be able to identify shim context associated
      with a connected socket by searching shim context keyed by the
      pair of source and destination identifiers.  However, this is
      not the case for unnconnected sockets.  The kernel needs to
      dynamically resolve association between an unconnected socket
      and a shim context, if any, upon packet processing.  As to
      outbound packet processing, the kernel needs to check if there
      is any shim context whose EID pair matches with the source and
      destination IP addresses of the user data originating from an
      unconnected socket.  If a matching context is found, the shim
      sub-layer performs packet processing taking the application's
      preference into account.  Note that the shim sub-layer should be
      able to backtrack the socket from which the user data was
      originated.  As to inbound packet processing, the shim sub-layer
      needs to check not only the IP header but also the transport
      layer protocol header to resolve the destination socket.  If the
      destination socket is resolved and it contains any values
      concerning the shim sub-layer socket options, the shim sub-layer
      processes the IP packet as requested (e.g., set locator
      information of received packet in the ancillary data).
      
</p>
<a name="sec-implications-for-legacyapi"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Relation to Existing Sockets API Extensions</h3>

<p>This section explains relation between the sockets API
      defined in this document and the existing sockets API
      extensions.
</p>
<p>As mentioned in <a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Sub-layer</span><span>)</span></a>, the
      basic assumption is that the existing sockets API continues to
      work above the shim sub-layer.  This means that, the existing
      sockets API deals with identifiers, and the sockets API defined
      in this document deals with locators.
</p>
<p>SHIM_LOC_LOCAL_PREF and SHIM_LOC_PEER_PREF socket options are
      semantically similar to the IPV6_PKTINFO socket API in the sense
      that both provide a means for application to set the source IP
      address of outbound IP packets.
</p>
<p>SHIM_LOC_LOCAL_RECV and SHIM_LOC_PEER_RECV socket options are
      semantically similar to the IP_RECVDSTADDR and IPV6_PKTINFO
      socket APIs in the sense that both provides a means for
      application to get the source and/or destination IP address of
      inbound IP packets.
</p>
<p>getsockname() and getpeername() enable application to get
      'name' of the communication endpoints which is represented by a
      pair of IP address and port number assigned to the socket.
      getsockname() gives IP address and port number assigned to the
      socket on the local side, and getpeername() gives IP address and
      port number of the peer side.
</p>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Operational Considerations</h3>

<p>This section gives operational considerations of the sockets
      API defined in this document.
</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1"></a><h3>10.1.&nbsp;
Conflict Resolution</h3>

<p>There may be a conflicting situation when different
	applications specify difference preference for the same shim
	context.  For instance, application A and B may establish
	communication with the same EID pair while both applications
	have different preference in their choice of local locator.
	The notion of context forking in SHIM6 can resolve the
	conflicting situation.
</p>
<p>Socket options defined in
	<a class='info' href='#sec-shim-socket-options'>Section&nbsp;5<span> (</span><span class='info'>Socket Options for Multihoming Shim Sub-layer</span><span>)</span></a> may cause conflicting
	situation when the target context is shared by multiple
	applications.  In such a case, the socket handler should
	inform the shim sub-layer that context forking is required.
	In SHIM6, when a context is forked, an unique identifier
	called Forked Instance Identifier (FII) is assigned to the
	newly forked context.  The forked context is then exclusively
	associated with the socket through which non-default
	preference value was specified.  The forked context is
	maintained by the shim sub-layer during the lifetime of
	associated socket instance.  When the socket is closed, the
	shim sub-layer SHOULD delete associated context.  When a
	forked context is torn down, the SHIM6 implementation should
	notify the peer about the deletion of forked context.
</p>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2"></a><h3>10.2.&nbsp;
Incompatiblility between IPv4 and IPv6</h3>

<p>The shim sub-layer performs identifier/locator adaptation.
	Therefore, in some cases, the whole IP header can be replaced
	with new IP header of a different address family
	(e.g. conversion from IPv4 to IPv6 or vice versa).  Hence,
	there is an issue how to make the conversion with minimum
	impact.  Note that this issue is common in other protocol
	conversion such as SIIT<a class='info' href='#RFC2765'>[RFC2765]<span> (</span><span class='info'>Nordmark, E., &ldquo;Stateless IP/ICMP Translation Algorithm (SIIT),&rdquo; February&nbsp;2000.</span><span>)</span></a>.
</p>
<p>As addressed in the SIIT specification, some of the
	features (IPv6 routing headers, hop-by-hop extension headers,
	or destination headers) from IPv6 are not convertible to IPv4.
	In addition, notion of source routing is not exactly the same
	in IPv4 and IPv6.  This means that an error may occur during
	the conversion of identifier and locator.  It is ffs exactly
	how the shim sub-layer should behave in such erroneous
	cases.
</p>
<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
IANA Considerations</h3>

<p>This document contains no IANA consideration.
</p>
<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Protocol Constants and Variables</h3>

<p>This section defines protocol constants and variables.
	</p>
<blockquote class="text"><dl>
<dt>SHIM_MAX_LOCATORS</dt>
<dd>The maximum number of the
	    locators to be included in a locator list.  32.
</dd>
</dl></blockquote><p>
      
</p>
<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
Security Considerations</h3>

<p>This section gives security considerations of the API defined
	in this document.
</p>
<a name="anchor29"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13.1"></a><h3>13.1.&nbsp;
Treatment of Unknown Locator</h3>

<p>When sending IP packets, application may request use of
        unknown locator for the source and/or destination locators.
        Note that treatment of unknown locator can be a subject of
        security considerations because use of invalid source and/or
        destination locator may cause redirection attack.
</p>
<a name="anchor30"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13.1.1"></a><h3>13.1.1.&nbsp;
Treatment of Unknown Source Locator</h3>

<p>The shim sub-layer checks if the requested locator is
	  available on any of the local interface.  If not, the shim
	  sub-layer MUST reject the request and return an error
	  message with the EINVALIDLOCATOR code to the application.
	  If the locator is confirmed to be available, the shim
	  sub-layer SHOULD initiate the procedure to update the
	  locator list.
</p>
<p>Use of the following socket options and ancillary data
	  may require treatment of unknown source locator:

	    </p>
<ul class="text">
<li>SHIM_LOC_LOCAL_SEND
</li>
<li>SHIM_LOC_LOCAL_PREF
</li>
<li>SHIM_LOC_LIST_LOCAL
</li>
</ul><p>

	  
</p>
<a name="anchor31"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13.1.2"></a><h3>13.1.2.&nbsp;
Treatment of Unknown Destination Locator</h3>

<p>If the shim sub-layer turns out to be SHIM6, the SHIM6
	  implementation MUST reject the request for using unknown
	  destination locator.
</p>
<p>If the shim sub-layer turns out to be HIP, the HIP
	  implementation MAY accept the request for using unknown
	  destination locator.
</p>
<p>Use of the following socket options and ancillary data
	  may require treatment of unknown destination locator:

	    </p>
<ul class="text">
<li>SHIM_LOC_PEER_SEND
</li>
<li>SHIM_LOC_PEER_PREF
</li>
<li>SHIM_LOC_LIST_PEER
</li>
</ul><p>

	  
</p>
<a name="anchor32"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
Changes</h3>

<a name="anchor33"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.1"></a><h3>14.1.&nbsp;
Changes from version 00 to version 01</h3>

<p>
	</p>
<ul class="text">
<li>Define shim_locator{} data type which is a placeholder for
	  locator.
</li>
<li>Define shim_pathexplore{} data type in which a set of
	  REAP parameters are stored.
</li>
<li>Remove descriptions about "stickiness" of socket options.
</li>
<li>Deprecate SHIM_IF_RECV and SHIM_IF_SEND socket options.
</li>
<li>Give default value and how to disable given socket
	  option.
</li>
</ul><p>
	
</p>
<a name="anchor34"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.2"></a><h3>14.2.&nbsp;
Changes from version 01 to version 02</h3>

<p>
	</p>
<ul class="text">
<li>Add section describing context forking.
</li>
<li>Rephrase conclusion section.
</li>
<li>Separate normative references from informative
	  references.
</li>
<li>Remove texts from discussion section that are not
	  relevant to the contents of the document.
</li>
<li>Add section describing change history (this section).
</li>
</ul><p>
	
</p>
<a name="anchor35"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.3"></a><h3>14.3.&nbsp;
Changes from version 02 to version 03</h3>

<p>
	</p>
<ul class="text">
<li>Add an Appendix section describing the issue of context
	  forking.
</li>
</ul><p>
	
</p>
<a name="anchor36"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.4"></a><h3>14.4.&nbsp;
Changes from version 03 to version 04</h3>

<p>
	</p>
<ul class="text">
<li>Updated reference.
</li>
<li>Correct typo and grammatical errors.
</li>
</ul><p>
	
</p>
<a name="anchor37"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.5"></a><h3>14.5.&nbsp;
Changes from version 04 to version 05</h3>

<p>
	</p>
<ul class="text">
<li>Added definition of SHIM_FEEDBACK ancillary data.
</li>
<li>Added an example of code using the SHIM_LOCLIST_LOCAL
</li>
<li>Added SHIM_LOC_LOCAL_SEND and SHIM_LOC_PEER_SEND socket
	  options.
</li>
</ul><p>
	
</p>
<a name="anchor38"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.6"></a><h3>14.6.&nbsp;
Changes from version 05 to version 06</h3>

<p>
	</p>
<ul class="text">
<li>Updated references.
</li>
</ul><p>
	
</p>
<a name="anchor39"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.7"></a><h3>14.7.&nbsp;
Changes from version 06 to version 07</h3>

<p>
	</p>
<ul class="text">
<li>Resolved editorial issues.
</li>
</ul><p>
	
</p>
<a name="anchor40"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.8"></a><h3>14.8.&nbsp;
Changes from version 07 to version 08</h3>

<p>No changes are made except for updates of the references.
</p>
<a name="anchor41"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.9"></a><h3>14.9.&nbsp;
Changes from version 08 to version 09</h3>

<p>
	  </p>
<ul class="text">
<li>Updated texts for Section 1 and Section 5 according to
	    the comments provided by Samu Varjonen.
</li>
<li>Made it clear that downgrading the multihoming shim
            support (i.e., specifying value 1 with the SHIM_DONTSHIM
            socket option) is only allowed before the socket is
            connected.
</li>
<li>Updated locator information (shim_locator{}) so that
            it can contain a locator behind NAT.
</li>
</ul><p>
	  
</p>
<a name="anchor42"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.10"></a><h3>14.10.&nbsp;
Changes from version 09 to version 10</h3>

<p>
  	  </p>
<ul class="text">
<li>Addressed applicability of socket options and ancillary
	      data for the shim sub-layer.
</li>
<li>Addressed system requirements.
</li>
<li>Removed unnecessary description about deprecated socket
	    option (SHIM_IF_RECV).
</li>
</ul><p>
	
</p>
<a name="anchor43"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.11"></a><h3>14.11.&nbsp;
Changes from version 10 to version 11</h3>

<p>
  	  </p>
<ul class="text">
<li>Added short descriptions about connected sockets and unconnected sockets.
</li>
<li>Relaxed applicability of the socket options.
</li>
<li>Relaxed applicability of the ancillary data.
</li>
<li>Added notification about locator change.
</li>
</ul><p>
	
</p>
<a name="anchor44"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.12"></a><h3>14.12.&nbsp;
Changes from version 11 to version 12</h3>

<p>
	  </p>
<ul class="text">
<li>Reflected comments from Brian Karpenter
</li>
<li>Reflected comments from Michael Scharf
</li>
</ul><p>
	
</p>
<a name="anchor45"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15"></a><h3>15.&nbsp;
Acknowledgments</h3>

<p>Authors would like to thank Jari Arkko who participated in
      the discussion that lead to the first version of this document,
      and Tatuya Jinmei who thoroughly reviewed the early version of
      this draft and provided detailed comments on sockets API related
      issues.  Thomas Henderson provided valuable comments especially
      from HIP perspectives.
</p>
<p>Authors sincerely thank to the following people for their
      help to improve this document: Samu Varjonen and Dmitriy
      Kuptsov.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.16"></a><h3>16.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>16.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="POSIX">[POSIX]</a></td>
<td class="author-text">&ldquo;<a href="http://www.opengroup.org/austin">IEEE Std. 1003.1-2001 Standard for Information
	  Technology -- Portable Operating System Interface
	  (POSIX). Open group Technical Standard: Base Specifications,
	  Issue 6, http://www.opengroup.org/austin</a>,&rdquo; December&nbsp;2001.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3542">[RFC3542]</a></td>
<td class="author-text">Stevens, W., Thomas, M., Nordmark, E., and T. Jinmei, &ldquo;<a href="http://tools.ietf.org/html/rfc3542">Advanced Sockets Application Program Interface (API)
	  for IPv6</a>,&rdquo; RFC&nbsp;3542, May&nbsp;2003 (<a href="ftp://ftp.isi.edu/in-notes/rfc3542.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4423">[RFC4423]</a></td>
<td class="author-text">Moskowitz, R. and P. Nikander, &ldquo;<a href="http://tools.ietf.org/html/rfc4423">Host Identity Protocol (HIP) Architecture</a>,&rdquo; RFC&nbsp;4423, May&nbsp;2006 (<a href="ftp://ftp.isi.edu/in-notes/rfc4423.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5533">[RFC5533]</a></td>
<td class="author-text">Bagnulo, M. and E. Nordmark, &ldquo;<a href="http://tools.ietf.org/html/rfc5533">Level 3 multihoming shim protocol</a>,&rdquo; RFC&nbsp;5533, June&nbsp;2009 (<a href="http://tools.ietf.org/rfc/rfc5533.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5534">[RFC5534]</a></td>
<td class="author-text">Arkko, J. and I. Beijnum, &ldquo;<a href="http://tools.ietf.org/html/rfc5534">Failure Detection and Locator Pair Exploration
	  Protocol for IPv6 Multihoming</a>,&rdquo; RFC&nbsp;5534, June&nbsp;2009 (<a href="http://tools.ietf.org/rfc/rfc5534.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>16.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-hip-nat-traversal">[I-D.ietf-hip-nat-traversal]</a></td>
<td class="author-text">Komu, M., Henderson, T., Tschofenig, H., Melen, J., and A. Keranen, &ldquo;<a href="http://tools.ietf.org/html/draft-ietf-hip-nat-traversal-09">Basic HIP Extensions for Traversal of Network Address
	    Translators</a>,&rdquo; Internet Draft&nbsp;draft-ietf-hip-nat-traversal-09, October&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-shim6-app-refer">[I-D.ietf-shim6-app-refer]</a></td>
<td class="author-text">Nordmark, E., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-app-refer-00.txt">Shim6 Application Referral Issues</a>,&rdquo; draft-ietf-shim6-app-refer-00 (work in progress), July&nbsp;2005 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-app-refer-00.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-shim6-applicability">[I-D.ietf-shim6-applicability]</a></td>
<td class="author-text">Abley, J., Bagnulo, M., and A. Garcia-Martinez, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-applicability-04.txt">Applicability Statement for the Level 3 Multihoming
	  Shim Protocol (Shim6)</a>,&rdquo; draft-ietf-shim6-applicability-04 (work in progress), November&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-applicability-04.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2765">[RFC2765]</a></td>
<td class="author-text">Nordmark, E., &ldquo;<a href="http://tools.ietf.org/html/rfc2765">Stateless IP/ICMP Translation Algorithm (SIIT)</a>,&rdquo; RFC&nbsp;2765, February&nbsp;2000 (<a href="ftp://ftp.isi.edu/in-notes/rfc2765.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3972">[RFC3972]</a></td>
<td class="author-text">Aura, T., &ldquo;<a href="http://tools.ietf.org/html/rfc3972">Cryptographically Generated Addresses (CGA)</a>,&rdquo; RFC&nbsp;3972, March&nbsp;2005 (<a href="ftp://ftp.isi.edu/in-notes/rfc3972.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4291">[RFC4291]</a></td>
<td class="author-text">Hinden, R. and S. Deering, &ldquo;<a href="http://tools.ietf.org/html/rfc4291">IP Version 6 Addressing Architecture</a>,&rdquo; RFC&nbsp;4291, February&nbsp;2006 (<a href="ftp://ftp.isi.edu/in-notes/rfc4291.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5535">[RFC5535]</a></td>
<td class="author-text">Bagnulo, M., &ldquo;<a href="http://tools.ietf.org/html/rfc5535">Hash Based Addresses (HBA)</a>,&rdquo; RFC&nbsp;5535, June&nbsp;2009 (<a href="http://tools.ietf.org/rfc/rfc5535.txt">TXT</a>).</td></tr>
</table>

<a name="anchor48"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Context Forking</h3>

<p>In this section, an issue concerning context forking and
        its relation to the multihoming shim API are discussed.
</p>
<p>SHIM6 supports a notion of context forking.  A peer may
        decide to fork a context for certain reason (e.g. upper layer
        protocol prefers to use different locator pair than the one
        defined in available context).  The procedure of forking
        context is done similar to the normal context establishment,
        performing the 4-way message exchange.  A peer who has decided
        to fork a context initiates the context establishment.
        Hereafter, we call this peer the "initiator".  The peer of the
        initiator is called the "responder".
</p>
<p>Once the forked context is established between the peers,
        on the initiator side, it is possible to apply forked context
        to the packet flow since the system maintains an association
        between the forked context and the socket owned by the
        application that has requested the context forking.  How this
        association is maintained is an implementation specific issue.
        However, on the responder side, there is a question how the
        outbound packet can be multiplexed by the shim sub-layer
        because there are more than one SHIM6 contexts that match with
        the ULID pair of the packet flow.  There is a need to
        differentiate packet flows not only by the ULID pairs but by
        some other information and associate a given packet flow with
        a specific context.
</p>
<p><a class='info' href='#fig-context-forking'>Figure&nbsp;8<span> (</span><span class='info'>context forking</span><span>)</span></a> gives an example of a
        scenario where two communicating peers fork a context.
        Initially, there has been a single transaction between the
        peers, by the application 1 (App1).  Accordingly, another
        transaction is started, by application 2 (App2).  Both of the
        transactions are made based on the same ULID pair.  The first
        context pair (Ctx1) is established for the transaction of
        App1.  Given the requests from App2, the shim sub-layer on
        Peer 1 decides to fork a context.  Accordingly, a forked
        context (Ctx2) is established between the peers, which should
        be exclusively applied to the transaction of App2.  Ideally,
        multiplexing and demultiplexing of packet flows that relate to
        App1 and App2 should be done as illustrated in
        <a class='info' href='#fig-context-forking'>Figure&nbsp;8<span> (</span><span class='info'>context forking</span><span>)</span></a>.  However, as mentioned
        earlier, the responder needs to multiplex outbound flows of
        App1 and App2 somehow.  Note that if a context forking occurs
        on the initiator side, a context forking needs to occur also
        on the responder side.

	<br /><hr class="insert" />
<a name="fig-context-forking"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Peer 1                                 Peer 2
         (initiator)                            (responder)

    +----+         +----+                  +----+         +----+
    |App1|         |App2|                  |App1|         |App2|
    +----+         +----+                  +----+         +----+
      |^             |^                      ^|             ^|
      v|             v|                      |v             |v
 -----S1-------------S2-----            -----S1-------------S2-----
      ||             ||                      ||             ||
      ||             ||                      ||             ||

     Ctx1           Ctx2                    Ctx1           Ctx2
 ULID:&lt;A1,B1&gt;   ULID:&lt;A1,B1&gt;            ULID:&lt;B1,A1&gt;    ULID:&lt;B1,A1&gt;
 Loc: &lt;A1,B2&gt;   Loc: &lt;A1,B3&gt;            Loc: &lt;B2,A1&gt;    Loc: &lt;B3,A1&gt;
 FII: 0         FII: 100                FII: 0          FII: 100

      |^             |^                      ^|             ^|
      ||             ||                      ||             ||
      ||             ||                      ||             ||
      \..............||....................../|             ||
       \.............||......................./             ||
                     ||                                     ||
                     \|...................................../|
                      \....................................../
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;8: context forking&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

	
</p>
<p>Any solution is needed to overcome the problem mentioned
        above.
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Miika Komu</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Helsinki Institute for Information
      Technology</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tammasaarenkatu 3</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Helsinki</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358503841531</td></tr>
<tr><td class="author" align="right">Fax:&nbsp;</td>
<td class="author-text">+35896949768</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:miika@iki.fi">miika@iki.fi</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.hiit.fi/">http://www.hiit.fi/</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Marcelo Bagnulo</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Universidad Carlos III de
      Madrid</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Av. Universidad 30</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Leganes  28911</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">SPAIN</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+34 91 6248837</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:marcelo@it.uc3m.es">marcelo@it.uc3m.es</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://it.uc3m.es/marcelo">http://it.uc3m.es/marcelo</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Kristian Slavov</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ericsson Research
      Nomadiclab</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hirsalantie 11</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jorvas  FI-02420</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 9 299 3286</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:kristian.slavov@ericsson.com">kristian.slavov@ericsson.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shinta Sugimoto (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nippon Ericsson K.K.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Koraku Mori Building</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1-4-14, Koraku, Bunkyo-ku</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tokyo  112-0004</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Japan</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+81 3 3830 2241</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:shinta@sfc.wide.ad.jp">shinta@sfc.wide.ad.jp</a></td></tr>
</table>
</body></html>
