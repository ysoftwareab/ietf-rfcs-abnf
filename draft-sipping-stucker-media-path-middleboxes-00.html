<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Analysis of Middlebox Interactions for Signaling Protocol Communication
      along the Media Path</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Analysis of Middlebox Interactions for Signaling Protocol Communication
      along the Media Path">
<meta name="keywords" content="I-D, Internet-Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">B. Stucker</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Nortel</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">H. Tschofenig</td></tr>
<tr><td class="header">Expires: May 15, 2008</td><td class="header">Nokia Siemens Networks</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">November 12, 2007</td></tr>
</table></td></tr></table>
<h1><br />Analysis of Middlebox Interactions for Signaling Protocol Communication
      along the Media Path<br />draft-sipping-stucker-media-path-middleboxes-00</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on May 15, 2008.</p>

<h3>Abstract</h3>

<p>Middleboxes are defined as any intermediary box performing functions apart from normal,
        standard functions of an IP router on the data path between a source host and destination
        host. Two such functions are network address translation and firewalling.
</p>
<p>When Application Layer Gateways, such as SIP entities, interact with NATs and
        firewalls, as described in the MIDCOM architecture, then problems may occur
        in the transport of media traffic when signaling protocol interaction takes place along the
        media path, as it is the case for recent key exchange proposals (such as DTLS-SRTP).
        This document highlights problems that may arise.
        Unfortunately, it is difficult for the end points to detect or predict problematic behavior
        and to determine whether the media path is reliably available for packet exchange. 
</p>
<p>This document aims to summarize the various sources and effects of NAT and firewall
        control, the reasons that they exist, and possible means of improving their behavior to
        allow protocols that rely upon signaling along the media path to operate effectively.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#terminology">2.</a>&nbsp;
Terminology<br />
<a href="#gating">3.</a>&nbsp;
Architecture<br />
<a href="#packet-filter">4.</a>&nbsp;
Packet Filtering<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">4.1.</a>&nbsp;
Protocol Interaction<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">4.1.1.</a>&nbsp;
Single-Stage Commit<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">4.1.2.</a>&nbsp;
Two-Stage Commit<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">4.2.</a>&nbsp;
Further Reading<br />
<a href="#nat-traversal">5.</a>&nbsp;
NAT Traversal<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">5.1.</a>&nbsp;
Protocol Interaction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">5.2.</a>&nbsp;
Further Reading<br />
<a href="#anchor8">6.</a>&nbsp;
Interactions between Media Path Signaling and Middlebox Behavior<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">6.1.</a>&nbsp;
Firewalling<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">6.2.</a>&nbsp;
NAT Traversal<br />
<a href="#anchor11">7.</a>&nbsp;
Preliminary Recommendations<br />
<a href="#security">8.</a>&nbsp;
Security Considerations<br />
<a href="#iana">9.</a>&nbsp;
IANA Considerations<br />
<a href="#acks">10.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">11.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">11.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">11.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>According to by RFC 3234 <a class='info' href='#RFC3234'>[RFC3234]<span> (</span><span class='info'>Carpenter, B. and S. Brim, &ldquo;Middleboxes: Taxonomy and Issues,&rdquo; February&nbsp;2002.</span><span>)</span></a> middleboxes are defined as any
        intermediary box performing functions apart from normal, standard functions of an IP router
        on the data path between a source host and destination host.
</p>
<p>In the context of SIP a SIP ALG may interact with a node along the media path to control
        network address translation, firewalling, and other functions. 
</p>
<p>
        </p>
<blockquote class="text">
<p> With firewall control packet filters are installed based on the SIP signaling
            interaction to implement a behavior of 'deny by default' in order to reduce the risk of
            unwanted traffic. This function is often referred to as 'gating'. Depending on the
            timing of the packet filter installation and the content of the packet filter signaling
            traffic along the media, such as DTLS-SRTP or ICE, may be treated in an unexpected way. 
</p>
<p>In cases where the middlebox is involved in overcoming unmanaged NAT traversal the case
            is similar. The key feature of this type of NAT traversal is a desire to overcome the
            possible lack of information about any <a class='info' href='#RFC4787'>[RFC4787]<span> (</span><span class='info'>Audet, F. and C. Jennings, &ldquo;Network Address Translation (NAT) Behavioral Requirements for Unicast UDP,&rdquo; January&nbsp;2007.</span><span>)</span></a> address and/or port
            mapping by a possibly unknown NAT device (server reflexive address and filtering
            properties). In particular, a NAT binding for an endpoint may not exist yet for the
            address and port identified in the endpoint's SDP. As such, a pilot packet sent by that
            endpoint behind the NAT is required to create the necessary mappings in the NAT for the
            media relay to deliver media destined for that endpoint. Until that pilot packet is
            received no media packets may be reliably forwarded to the endpoint by the relay. 
</p>
</blockquote><p>
      
</p>
<p> This document presents a summary of these two techniques, discusses their impact upon
        other protocols such as ICE and DTLS-SRTP, and proposes a set of recommendations to mitigate
        the effects of gating and latching on in-band negotiation mechanisms. 
</p>
<a name="terminology"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in
          <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<p>We use the terms filter, policy action (or action), policy rule(s), MIDCOM agent, and
        MIDCOM Policy Decision Point (PDP) as defined in <a class='info' href='#RFC3303'>[RFC3303]<span> (</span><span class='info'>Srisuresh, P., Kuthan, J., Rosenberg, J., Molitor, A., and A. Rayhan, &ldquo;Middlebox communication architecture and framework,&rdquo; August&nbsp;2002.</span><span>)</span></a>. The MIDCOM agent
        is co-located with a SIP ALG that comunicates with the firewall or the media relay.
</p>
<a name="gating"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Architecture</h3>

<p><a class='info' href='#architecture'>Figure&nbsp;1<span> (</span><span class='info'>Analysed Firewalling Architecture</span><span>)</span></a> shows the architecture that is being considered in this
        document with respect to firewall and NAT traversal using media relaying. The timing and
        directionality with which media packets are allowed to traverse a particular edge device is
        the subject of this investigation. The MIDCOM agent thereby pushes policy rules to the
        middlebox that allow or deny certain flows to bypass. Additionally, in case of media
        relaying it is important for the MIDCOM agent to adjust the signaling messages.
</p>
<p>
        <br /><hr class="insert" />
<a name="architecture"></a>
</p>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
             SIP     +-----------------+     SIP
 +-----+  Signaling  |     SIP ALG     |  Signaling  +-----+
 | UAC |&lt;-----------&gt;+-----------------+&lt;-----------&gt;| UAS |
 +-----+             |   MIDCOM Agent  |             +-----+
    ^                +-----------------+                ^
    |                         ^                         |
    |          Policy rule(s) | and NAT bindings        |
    |                         v                         |
    |      Media       +-------------+       Media      |
    +-----------------&gt;|  Middlebox  |&lt;-----------------+
                       +-------------+
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Analysed Firewalling Architecture&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

      
</p>
<p>The aspects of packet filtering are described in <a class='info' href='#packet-filter'>Section&nbsp;4<span> (</span><span class='info'>Packet Filtering</span><span>)</span></a> whereas NAT
        traversal is illustrated in <a class='info' href='#nat-traversal'>Section&nbsp;5<span> (</span><span class='info'>NAT Traversal</span><span>)</span></a>.
</p>
<a name="packet-filter"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Packet Filtering</h3>

<p><a class='info' href='#architecture'>Figure&nbsp;1<span> (</span><span class='info'>Analysed Firewalling Architecture</span><span>)</span></a> highlights the interaction between the MIDCOM agent and the
        middlebox. These two elements inspect call control signaling and media path packets and
        determine when packets from a given source to a given destination are allowed to flow
        between endpoints. It is common for the gate controller to be the local outbound proxy for a
        given SIP UA being gated. 
</p>
<p>The primary responsibility of the MIDCOM agent, which is co-located with a SIP entity, is
        to examine the call control signaling to determine the media addresses and ports used to
        define the media path between the gated device and the endpoint(s) with which it is
        corresponding. For SIP, this would correspond to the media addresses described within SDP
        after at least one full offer/answer exchange. 
</p>
<p>This information is used to create one or more packet filters that describe the expected
        media path(s) for the call. These packet filters are combined with an algorithmic
        determination, typically based on the state of the call, as to which direction(s) media
        packets are allowed to flow between the endpoints, if at all. The filter and the action that
        is being installed by the MIDCOM agent at the middlebox may change during the lifetime of a
        SIP signaling session, depending on the state of the call or on changes of the address and
        port information of one (or even both) of the end points.
</p>
<p>It is possible that the gate controller may not be able to establish an exact address or
        port for one endpoint involved in the call in which case it may wildcard the address and/or
        port for the source and/or destination endpoint in the packet flow filter. In such a case,
        the packet flow filter is considered to have matched against a given media packet for the
        wildcarded field. 
</p>
<p>Note that it is possible to specify the filter using wildcards, for example, if some end
        point address information is not known at a given point in time. Additonally, the default
        firewalling policy is subject to local configuration ('deny per default' vs. 'permit per
        default'). For a given SIP signaling sessions the policy at the MIDCOM agent might be very
        strict with respect to the packets that are allowed to flow in a particular direction. For
        example, packets may be allowed to flow in both directions, only in one direction for a
        specific media stream. No particular behavior can be assumed. 
</p>
<p>When a media session is destroyed (end of call, deleted from the session description,
        etc.), the MIDCOM agent removes policy rules created for that media session at the
        middlebox.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Protocol Interaction</h3>

<p>MIDCOM agents may employ a variety of models to determine when to change the status of a
          particular policy rule. This is especially true when a call is being established. For SIP,
          this would be when an early dialog is established between endpoints. Although there is the
          potential for a great deal of variability due to an intentional lack of specification,
          typically, one of two models is used by the MIDCOM agent to determine the state of a
          policy rule during call setup: single-stage and two-stage commit. The term 'commit' here
          refers to the point at which a policy rule is setup that allows media traffic to flow. For
          example, this would be the point at which packets for a media stream marked a=sendrecv in
          SDP was allowed to flow bi-directionally by the middlebox.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1.1"></a><h3>4.1.1.&nbsp;
Single-Stage Commit</h3>

<p>Single stage commit is commonly used when the MIDCOM agent is most involved only in
            firewalling. For SIP, MIDCOM agents use a single-stage commit model typically install
            policy rules for the call when the 200 OK to the INVITE is received in the case that the
            INVITE contained an SDP offer, or when the ACK is received if the initial offer was sent
            in the 200 OK itself.
</p>
<p>This model is often used to prevent media from being sent end-to-end prior to the call
            being established.
</p>
<p>
            <br /><hr class="insert" />
<a name="single-stage-commit"></a>
</p>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
            UAC Side        MIDCOM           UAS Side
UAC         Middlebox       Agent            Middlebox      UAS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    |            |                |                |            |
    | (1)  INVITE + SDP Offer     |                |            |
    |----------------------------&gt;| (2)  INVITE + SDP Offer     |
    |    c=IN IP4 47.0.0.1        |----------------------------&gt;|
    |    m=audio 49170 RTP/AVP 0  |    c=IN IP4 47.0.0.1        |
    |    a=sendrecv               |    m=audio 49170 RTP/AVP 0  |
    |            |                |    a=sendrecv               |
    |            |                |                |            |
    |            |                |     (3) 200 OK + SDP Answer |
    |            |                |&lt;----------------------------|
    |            |                |    c=IN IP4 47.0.0.2        |
    |            |                |    m=audio 36220 RTP/AVP 0  |
    |            |                |    a=sendrecv  |            |
    |            |                |                |            |
    |            | (5) Policy     | (4) Policy     |            |
    |            |&lt;---------------|---------------&gt;|            |
    |            |  Src: 47.0.0.2 | Src: 47.0.0.1  |            |
    |            |    port 36220  |   port 49170   |            |
    |            |  Dst: 47.0.0.1 | Dst: 47.0.0.2  |            |
    |            |    port 49170  |   port 36220   |            |
    |            |  sendrecv      | sendrecv       |            |
    |            |  action=permit | action=permit  |            |
    |            |                |                |            |
    |            |                |                |    RTP     |
    |&lt;=========================================================&gt;|
    |            |                |                |            |
    |    (6) 200 OK + SDP Answer  |                |            |
    |&lt;----------------------------|                |            |
    |  c=IN IP4 47.0.0.2          |                |            |
    |  m=audio 36220 RTP/AVP 0    |                |            |
    |  a=sendrecv                 |                |            |
    |            |                |                |            |
    |    (7)    ACK               |     (8)       ACK           |
    |----------------------------&gt;|----------------------------&gt;|
    |            |                |                |            |
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Example Single-stage Commit with SIP and SDP&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

          
</p>
<p>In the example above, policy is created in steps 4 and 5 to allow bi-directional media
            flow based on the SDP exchanged in steps 1 and 3. In this example, the MIDCOM agent
            installes the policies after the 200 OK to the INVITE arrives in step 3. With a
            firewalling policy of 'deny by default' media sent prior to steps 5 and 4 by the UAC or
            UAS is discarded by the middleboxes. 
</p>
<p>Noted that early media that arrives before the 200 OK would require special treatement
            since otherwise it would be dropped as well. 
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1.2"></a><h3>4.1.2.&nbsp;
Two-Stage Commit</h3>

<p>Two-stage commit is used when the MIDCOM agent also providers functionality, such as
            Quality of Service signaling that may require resources to reserved early on in the call
            establishment process before it is known if the call will be answered. An example of
            this would be where the MIDCOM agent is responsible for guaranteeing a minimum level of
            bandwidth along the media path. In this case an initial set of policies may be sent by
            the MIDCOM agent to the middlebox even though they are put into a pending state but
            trigger a resource reservation. Later, when the call is accepted, the gate controller
            may update the state of the policies to active them.
</p>
<p>
            <br /><hr class="insert" />
<a name="two-stage-commit"></a>
</p>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
            UAC Side        MIDCOM           UAS Side
UAC         Middlebox       Agent            Middlebox      UAS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 |            |                |                |            |
 | (1)  INVITE + SDP Offer     |                |            |
 |----------------------------&gt;| (2)  INVITE + SDP Offer     |
 |    c=IN IP4 47.0.0.1        |----------------------------&gt;|
 |    m=audio 49170 RTP/AVP 0  |    c=IN IP4 47.0.0.1        |
 |    a=sendrecv               |    m=audio 49170 RTP/AVP 0  |
 |            |                |    a=sendrecv               |
 |            |                |                |            |
 |            |                |     (3) 180 + SDP Answer    |
 |    (4) 180 + SDP Answer     |&lt;----------------------------|
 |&lt;----------------------------|    c=IN IP4 47.0.0.2        |
 |  c=IN IP4 47.0.0.2          |    m=audio 36220 RTP/AVP 0  |
 |  m=audio 36220 RTP/AVP 0    |    a=sendrecv               |
 |  a=sendrecv                 |                |            |
 |            |                |                |            |
 |            | (5) Policy     | (6) Policy     |            |
 |            |&lt;---------------|---------------&gt;|            |
 |            |  Src: 47.0.0.2 | Src: 47.0.0.1  |            |
 |            |    port 36220  |   port 49170   |            |
 |            |  Dst: 47.0.0.1 | Dst: 47.0.0.2  |            |
 |            |    port 49170  |   port 36220   |            |
 |            |  rule inactive | rule inactive  |            |
 |            |  action=permit | action=permit  |            |
 |            |                |                |            |
 |            |                |     (7)     200 OK          |
 |            |                |&lt;----------------------------|
 |            |                |                |            |
 |            | (9) UpdateGate | (8) UpdateGate |            |
 |            |&lt;---------------|---------------&gt;|            |
 |            |  G: sendrecv   | G: sendrecv    |            |
 |            |                |                |    RTP     |
 |&lt;=========================================================&gt;|
 |            |                |                |            |
 |    (10)   200 OK            |                |            |
 |&lt;----------------------------|                |            |
 |            |                |                |            |
 |    (11)   ACK               |     (12)      ACK           |
 |----------------------------&gt;|----------------------------&gt;|
 |            |                |                |            |
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Example Two-stage Commit with SIP and SDP&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

          
</p>
<p>In the example above, policies are created in steps 5 and 6 based off of the SDP sent
            in steps 1 and 3 in an initial inactive state (no packets are allowed to flow) despite
            the SDP indicating the media should be bi-directional. This interaction with the
            middlebox, however, triggers a QoS reservation to take place. Later, when the 200 OK to
            the INVITE comes in step 7, the policies are updated in steps 8 and 9 to indicate that
            packets should be allowed to flow bi-directionally. Although functionally equivalent to
            the single-stage commit example given earier in <a class='info' href='#single-stage-commit'>Figure&nbsp;2<span> (</span><span class='info'>Example Single-stage Commit with SIP and SDP</span><span>)</span></a>,
            other operations at the gate agent may have been performed simultaneously in steps 5 and
            6 that justifies the early explicit definition of the gates in an inactive state. The
            full usage of PRACK here is not shown for purposes of brevity.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Further Reading</h3>

<p>Packet filtering based on the approach described in this document has been described in a
          number of documents. Although the usage of this architecture can also be found on the
          Internet their behavior is largely specified only in documents that relate to IMS
          standardization. The behavior of the devices deployed on the Internet is therefore largely
          undocumented. Nevertheless, the following documents give the reader a better idea of the
          functionality and the signaling interaction. These documents may also specify an
          additional behavior in relation to how packet filtering is used when the MIDCOM agent is
          responsible for processing SIP/SDP call control signaling and the middlebox is responsible
          for a variety of activities beyond pure filtering. For example, it is common for
          middleboxes to exempt RTCP flows from being blocked even though the associated RTP flows
          are not allowed to flow in order to support RTCP signaling while a call is on hold. These
          references are given here for the reader to gather a better understanding of how this is
          mechanism is used in various forums and is non-exhaustive:
</p>
<p>
          </p>
<ol class="text">
<li>
              <a class='info' href='#TS-23-203'>3GPP, "TS 23.203: Policy and charging control
              architecture"<span> (</span><span class='info'>3GPP, &ldquo;Policy and charging control architecture,&rdquo; September&nbsp;2007.</span><span>)</span></a> [TS&#8209;23&#8209;203]
            
</li>
<li>
              <a class='info' href='#TS-29-214'>3GPP, "TS 29.214: Policy and charging control over Rx
                reference point"<span> (</span><span class='info'>3GPP, &ldquo;Policy and charging control over Rx reference point,&rdquo; September&nbsp;2007.</span><span>)</span></a> [TS&#8209;29&#8209;214]
            
</li>
<li>
              <a class='info' href='#TISPAN-ES-282-003'>ETSI TISPAN, "ES 282-003: Telecommunications and
                Internet converged Services and Protocols for Advanced Networking (TISPAN); Resource
                and Admission Control Sub-system (RACS); Functional Architecture"<span> (</span><span class='info'>ETSI, &ldquo;Telecommunications and Internet converged Services and Protocols for Advanced             Networking (TISPAN); Resource and Admission Control Sub-system (RACS); Functional             Architecture,&rdquo; June&nbsp;2006.</span><span>)</span></a> [TISPAN&#8209;ES&#8209;282&#8209;003]
            
</li>
<li>
              <a class='info' href='#PKT-SP-QOS-I01-070925'>Cablelabs, "PacketCable 2.0: Quality of Service
                Specification (PKT-SP-QOS-I01-070925)"<span> (</span><span class='info'>CableLabs, &ldquo;PacketCable 2.0: Quality of Service Specification,&rdquo; September&nbsp;2007.</span><span>)</span></a> [PKT&#8209;SP&#8209;QOS&#8209;I01&#8209;070925]
            
</li>
</ol><p>
        
</p>
<p>Note that different terms are used for the MIDCOM agent and the middlebox. For example,
          in an IMS context the MIDCOM agent would be part of the P-CSCF and PCRF elements or in
          TISPAN it would be part of the P-CSCF, A-RACF and SPDF that are involved in controlling
          gating operations. Many different elements perform the role of a middlebox: GSM GGSN, CDMA
          PDSN, SAE serving gateway, TISPAN A-BGF/C-BGF/I-BGF, PacketCable CMTS, etc. These
          functions may be present in the network in a unified or decomposed architecture.
</p>
<a name="nat-traversal"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
NAT Traversal</h3>

<p>One NAT traversal technique that is being used is based on media relay. As shown in <a class='info' href='#architecture'>Figure&nbsp;1<span> (</span><span class='info'>Analysed Firewalling Architecture</span><span>)</span></a> the MIDCOM agent that is being co-located with the SIP ALG
        functionality interacts with the middlebox that is also a NAT in order to request and
        allocate NAT bindings. A side effect of the interaction with a (double) NAT is that the
        media traffic is forced to traverse a certain NAT in both directions (also called media
        anchoring). 
</p>
<p>This architecture could be compared with a STUN relay <a class='info' href='#I-D.ietf-behave-turn'>[I&#8209;D.ietf&#8209;behave&#8209;turn]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; July&nbsp;2009.</span><span>)</span></a>
        that is being controlled by the MIDCOM agent rather than the end point itself. The
        motivation why this technique is being used in favor to other NAT traversal techniques is
        that clients do not have to support anything beyond RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> and
        network administrators can control and apply local policy to the relay binding process in a
        centralized manner. 
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Protocol Interaction</h3>

<p>The MIDCOM agent's role is to inspect call control signaling and update media address and
          port values based upon media relay binding information allocated with the middlebox/media
          relay. For SIP, this minimally involves updating the c= and m= lines in the SDP, although
          some implementations may update other elements of the SDP for various reasons. 
</p>
<p>Because the endpoints may not be able to gather a server reflexive address for their
          media streams, the MIDCOM agent employs the following algorithm to ensure that media can
          flow to the given endpoint:
</p>
<p>
          </p>
<ol class="text">
<li>Give the corresponding endpoint an address and port on the middlebox for them to send
              media to for the endpoint served by the MIDCOM agent.
</li>
<li>Give the served endpoint a different address and/or port on the middlebox for it to
              send media to for the corresponding endpoint.
</li>
<li>Use the address and port the corresponding endpoint supplies for media streams as the
              destination for packets sent to the middlebox by the served endpoint.
</li>
<li>Use the address and port of the first packet received from the served endpoint at the
              middlebox as the destination for packets sent to the middlebox by the corresponding
              endpoint.
</li>
</ol><p>
        
</p>
<p>An example of this algorithm is shown in <a class='info' href='#latching_callflow'>Figure&nbsp;4<span> (</span><span class='info'>Call Flow with SIP + SDP</span><span>)</span></a> using SIP and
          SDP. In this example the UAC is the endpoint served by the MIDCOM agent, which is also
          acting as a local outbound proxy, and the UAS is the corresponding endpoint.
</p>
<p>
          <br /><hr class="insert" />
<a name="latching_callflow"></a>
</p>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
            Media Relay   MIDCOM Agent and
UAC         Middlebox     Outbound Proxy                    UAS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 |             |               |                             |
 | (1)  INVITE + SDP Offer     |                             |
 |----------------------------&gt;|                             |
 |    c=IN IP4 10.0.0.1        |                             |
 |    m=audio 49170 RTP/AVP 0  |                             |
 |    a=sendrecv               |                             |
 |             |               |                             |
 |             | (2) Allocate  |                             |
 |             |&lt;------------- |                             |
 |             |               |                             |
 |             | (3) Response  |                             |
 |             |--------------&gt;|                             |
 |             | In: 47.0.0.3  | (4)  INVITE + SDP Offer     |
 |             |     50000     |----------------------------&gt;|
 |             | Out: 47.0.0.4 |    c=IN IP4 47.0.0.3        |
 |             |     50002     |    m=audio 50002 RTP/AVP 0  |
 |             |               |    a=sendrecv               |
 |             |               |                             |
 |             |               |     (5) 180 + SDP Answer    |
 |             | (6) Update    |&lt;----------------------------|
 |             |&lt;--------------|    c=IN IP4 47.0.0.2        |
 |             | Peer: 47.0.0.2|    m=audio 36220 RTP/AVP 0  |
 |             |       36220   |    a=sendrecv               |
 |  (7)  180 + SDP Answer      |                             |
 |&lt;----------------------------|                             |
 |  c=IN IP4 47.0.0.4          |                             |
 |  m=audio 50002 RTP/AVP 0    |                             |
 |  a=sendrecv                 |                             |
 |             |               |                             |
 |    (8)    200 OK            |     (8)    200 OK           |
 |&lt;----------------------------|&lt;----------------------------|
 |             |               |                             |
 |    (9)     ACK              |     (9)     ACK             |
 |----------------------------&gt;|----------------------------&gt;|
 |             |               |                             |
 |             |               |     (10)  UAS-RTP           |
 |             X&lt;============================================|
 |             |               |   Source: 47.0.0.2:36220    |
 | (11) UAC-RTP|               |   Dest:   47.0.0.3:50000    |
 |============&gt;|               |                             |
 | Source: 47.0.0.100:48650    |                             |
 | Dest: 47.0.0.4:50002        |                             |
 |             |               |     (12)  UAC-RTP           |
 |             |============================================&gt;|
 |             |               |   Source: 47.0.0.3:50000    |
 | (13) UAS-RTP                |   Dest:   47.0.0.2:36220    |
 |&lt;============|               |                             |
 | Source: 47.0.0.4:50002      |                             |
 | Dest:   47.0.0.100:48650    |                             |
 |             |               |                             |
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: Call Flow with SIP + SDP&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

        
</p>
<p>
          </p>
<ol class="text">
<li>UAC sends INVITE to local outbound proxy, which is also a MIDCOM agent, with an SDP
              offer.
</li>
<li>The MIDCOM agent looks at the signaling and determines that a NAT may be present (Via
              header address mismatch with observed source address, etc.). It asks the middlebox to
              allocate a media relay binding.
</li>
<li>The middlebox responds with a media relay binding that consists of an inbound
              address/port for media from the UAS, and an outbound address/port for media from the
              UAC.
</li>
<li>The MIDCOM agent updates the addresses in the SDP offer with the inbound address/port
              information from the middlebox/media relay binding response.
</li>
<li>The UAS responds with a 180 containing an SDP answer.
</li>
<li>The MIDCOM agent interacts with the middlebox to update the destination address/port
              information from the SDP answer for media to be sent to the UAS, and changes the
              addresses/ports in the SDP answer to the UAC with the outbound address/port
              information from the middlebox binding from step 3. Media can now flow to the UAS from
              the UAC at the middlebox/media relay.
</li>
<li>The UAC receives the SDP answer containing the media relay outbound address/port
              information.
</li>
<li>The UAS answers the INVITE with a 200 OK.
</li>
<li>The UAC acknowledges with an ACK.
</li>
<li>RTP for the UAS (which may have begun flowing prior to answer) flows to the
              middlebox, but the middlebox has no reliable address to relay the media to for the UAC
              yet. Media will typically be dropped.
</li>
<li>RTP arrives at the media relay on the inbound address/port from the UAC. The
              middlebox observes the source address and port of the arriving packet and completes
              the binding process. The source address and port of the media from the UAC is now the
              destination address/port for media arriving on the outbound port of the
              middlebox/media relay from the UAS.
</li>
<li>Media from the UAC is relayed to the UAS.
</li>
<li>Media from the UAS is relayed to the UAC. It is up to local policy at the media relay
              as to whether or not packets that had arrived from the UAS for the UAC are queued or
              dropped prior to the UAC's address/port information being updated in step 11.
</li>
</ol><p>
        
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Further Reading</h3>

<p>Although the described NAT traversal approach is used by a number of implementations to
          overcome incorrect address/port information in call control signaling from an endpoint
          behind a NAT, only one reference is known that describes the functionality in a
          standardized manner.
</p>
<p>
          </p>
<ol class="text">
<li>
              <a class='info' href='#TISPAN-ES-282-003'>ETSI TISPAN, "ES 282-003: Telecommunications and
                Internet converged Services and Protocols for Advanced Networking (TISPAN); Resource
                and Admission Control Sub-system (RACS); Functional Architecture"<span> (</span><span class='info'>ETSI, &ldquo;Telecommunications and Internet converged Services and Protocols for Advanced             Networking (TISPAN); Resource and Admission Control Sub-system (RACS); Functional             Architecture,&rdquo; June&nbsp;2006.</span><span>)</span></a> [TISPAN&#8209;ES&#8209;282&#8209;003]. The TISPAN
              Ia interface between the TISPAN BGF and SPDF is the relevant specification.
</li>
</ol><p>
        
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Interactions between Media Path Signaling and Middlebox Behavior</h3>

<p>This section points to the problems that occur when signaling exchanges are performed along
        the media path when middleboxes are present that behave in the way described in this
        document. 
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Firewalling</h3>

<p>The description in <a class='info' href='#packet-filter'>Section&nbsp;4<span> (</span><span class='info'>Packet Filtering</span><span>)</span></a> highlighted that the timing of the policy rule
          installation by the MIDCOM agent towards the middlebox has an impact on when and what
          media traffic is allowed to traverse.
</p>
<p> Hence, the middlebox prevents the exchange of packets in the media path until the
          session establishment signaling has reached a pre-configured milestone where the MIDCOM
          agent signals to the middlebox that packets are allowed to traverse in both directions.
          Prior to this, packets may be allowed to flow uni-directionally to satisfy certain service
          requirements or may be entirely blocked by the middlebox. For SIP <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>
          the typically milestone that must be reached is offer/answer exchange <a class='info' href='#RFC3264'>[RFC3264]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;An Offer/Answer Model with Session Description Protocol (SDP),&rdquo; June&nbsp;2002.</span><span>)</span></a> accompanied by an acknowledgement that the dialog has been accepted
          by the UAS (i.e., 200 OK to the INVITE). A concrete example of the impact can be found
          with the case of key exchange along the media path, as it is provided by DTLS-SRTP. Figure
          2 of <a class='info' href='#I-D.fischl-sipping-media-dtls'>[I&#8209;D.fischl&#8209;sipping&#8209;media&#8209;dtls]<span> (</span><span class='info'>Fischl, J., &ldquo;Datagram Transport Layer Security (DTLS) Protocol for Protection of Media  Traffic Established with the Session Initiation Protocol,&rdquo; July&nbsp;2007.</span><span>)</span></a> shows that the arrival of the SIP
          INVITE at the UAS triggers the DTLS handshake. This message would be blocked by the
          middlebox, as described in <a class='info' href='#packet-filter'>Section&nbsp;4<span> (</span><span class='info'>Packet Filtering</span><span>)</span></a> since the MIDCOM agent has not
          yet installed policy rules. The consequence is that the DTLS key exchange is delayed until
          the policy rules are installed and that media traffic that is sent before the DTLS
          exchange is completed may be dropped and the user experiences clippping.
</p>
<p> Unlike with the pilot packet used for NAT traversal, the bi-directional media path is
          established via the signaling path, not via packets sent along the media path. In some
          deployment models, RTCP is always available bi-directionally regardless of the installed
          policy rules. Obviously, this is not a property that can be guaranteed to be true in the
          future.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
NAT Traversal</h3>

<p>The described NAT traversal interaction prevents asynchronous exchange of packets in the
          media path until a pilot packet has been received by the middlebox from the endpoint being
          served. It can be employed for both the <a class='info' href='#RFC3264'>[RFC3264]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;An Offer/Answer Model with Session Description Protocol (SDP),&rdquo; June&nbsp;2002.</span><span>)</span></a> offerer and/or answerer.
          Therefore, in the worst case, both endpoints must generate a pilot packet towards each
          other to ensure a bi-directional media path exists. Any signaling on the media path that
          relies upon a uni-directional handshake in the reverse direction may not complete until
          media in the forward direction by the other endpoint. If signaling on the media path is
          required to complete prior to media generation the handshake may stall indefinitely.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Preliminary Recommendations</h3>

<p>The following preliminary recommendations are suggested:
</p>
<p>
        </p>
<blockquote class="text"><dl>
<dt>REC #1: </dt>
<dd>It is recommended that any protocol handshake on the media path
            ensure that a mechanism exists that causes both endpoints to send at least one packet in
            the forward direction as part of, or prior to, the handshake process. Retransmission of
            STUN connectivity checks (see <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>) as part of
            ICE <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a> is an example of such a mechanism that
            satisfies this recommendation.
</dd>
<dt>REC #2: </dt>
<dd>It is recommended that middleboxes present on the media path allow
            a nominal amount of traffic to be exchanged between endpoints to enable completion of
            media path signaling prior to the session being established. The amount of traffic
            necessary to complete the signaling between endpoints is expected to be orders of
            magnitude smaller than that of any sufficiently interesting fraudulent traffic.
</dd>
<dt>REC #3: </dt>
<dd>It is recommended that failure to complete signaling on the media
            path not automatically cause the session establishment to fail unless explicitly
            specified by one or more endpoints. A fallback scenario where signaling on the media
            path is retried after the session has been established is recommended.
</dd>
</dl></blockquote><p>
      
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>This document talks about security related functionality and the impact of one security
        mechanism, namely firewalling, to another one, namely key management for media security.
</p>
<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
IANA Considerations</h3>

<p>This document does not require actions by IANA.
</p>
<a name="acks"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Acknowledgements</h3>

<p>We would like to thank Steffen Fries, Dan Wing, Eric Rescorla, and Francois Audet for their
        input to this document. Furthermore, we would like to thank Jason Fischl, Guenther Horn,
        Thomas Belling, Jari Arkko, Cullen Jennings for the discussion input to this problem
      space.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3264">[RFC3264]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3264">An Offer/Answer Model with Session Description Protocol (SDP)</a>,&rdquo; RFC&nbsp;3264, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3264.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3303">[RFC3303]</a></td>
<td class="author-text">Srisuresh, P., Kuthan, J., Rosenberg, J., Molitor, A., and A. Rayhan, &ldquo;<a href="http://tools.ietf.org/html/rfc3303">Middlebox communication architecture and framework</a>,&rdquo; RFC&nbsp;3303, August&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3303.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.fischl-sipping-media-dtls">[I-D.fischl-sipping-media-dtls]</a></td>
<td class="author-text">Fischl, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-fischl-sipping-media-dtls-03.txt">Datagram Transport Layer Security (DTLS) Protocol for Protection of Media  Traffic Established with the Session Initiation Protocol</a>,&rdquo; draft-fischl-sipping-media-dtls-03 (work in progress), July&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-fischl-sipping-media-dtls-03.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-behave-rfc3489bis">[I-D.ietf-behave-rfc3489bis]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-rfc3489bis-18.txt">Session Traversal Utilities for (NAT) (STUN)</a>,&rdquo; draft-ietf-behave-rfc3489bis-18 (work in progress), July&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-rfc3489bis-18.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-behave-turn">[I-D.ietf-behave-turn]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-turn-16.txt">Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)</a>,&rdquo; draft-ietf-behave-turn-16 (work in progress), July&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-turn-16.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-mmusic-ice">[I-D.ietf-mmusic-ice]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>,&rdquo; draft-ietf-mmusic-ice-19 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="PKT-SP-QOS-I01-070925">[PKT-SP-QOS-I01-070925]</a></td>
<td class="author-text">CableLabs, &ldquo;<a href="http://www.cablelabs.com/specifications/PKT-SP-QOS-I01-070925.pdf">PacketCable 2.0: Quality of Service Specification</a>,&rdquo; September&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3234">[RFC3234]</a></td>
<td class="author-text">Carpenter, B. and S. Brim, &ldquo;<a href="http://tools.ietf.org/html/rfc3234">Middleboxes: Taxonomy and Issues</a>,&rdquo; RFC&nbsp;3234, February&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3234.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4347">[RFC4347]</a></td>
<td class="author-text">Rescorla, E. and N. Modadugu, &ldquo;<a href="http://tools.ietf.org/html/rfc4347">Datagram Transport Layer Security</a>,&rdquo; RFC&nbsp;4347, April&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4347.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4787">[RFC4787]</a></td>
<td class="author-text">Audet, F. and C. Jennings, &ldquo;<a href="http://tools.ietf.org/html/rfc4787">Network Address Translation (NAT) Behavioral Requirements for Unicast UDP</a>,&rdquo; BCP&nbsp;127, RFC&nbsp;4787, January&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4787.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="TISPAN-ES-282-003">[TISPAN-ES-282-003]</a></td>
<td class="author-text">ETSI, &ldquo;<a href="http://webapp.etsi.org/">Telecommunications and Internet converged Services and Protocols for Advanced
            Networking (TISPAN); Resource and Admission Control Sub-system (RACS); Functional
            Architecture</a>,&rdquo; June&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="TS-23-203">[TS-23-203]</a></td>
<td class="author-text">3GPP, &ldquo;<a href="http://www.3gpp.org/ftp/Specs/html-info/23203.htm">Policy and charging control architecture</a>,&rdquo; September&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="TS-29-214">[TS-29-214]</a></td>
<td class="author-text">3GPP, &ldquo;<a href="http://www.3gpp.org/ftp/Specs/html-info/29214.htm">Policy and charging control over Rx reference point</a>,&rdquo; September&nbsp;2007.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Brian Stucker</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nortel</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">2201 Lakeside</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Richardson, TX  75082</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:bstucker@nortel.com">bstucker@nortel.com</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.linkedin.com/in/bstucker">http://www.linkedin.com/in/bstucker</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hannes Tschofenig</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nokia Siemens Networks</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Otto-Hahn-Ring 6</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Munich, Bavaria  81739</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Germany</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Hannes.Tschofenig@nsn.com">Hannes.Tschofenig@nsn.com</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.tschofenig.com">http://www.tschofenig.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2007).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
