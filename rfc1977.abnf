new_ratio = db->in_count<<RATIO_SCALE_LOG;
hsize = 5003;
hshift = 4;
hsize = 9001;
hshift = 5;
hsize = 18013;
hshift = 6;
hsize = 35023;
hshift = 7;
maxmaxcode = MAXCODE(bits);
newlen = sizeof(*db) + (hsize-1)*(sizeof(db->dict[0]));

lens = db->lens;
db = 0;
db = (struct bsd_db*)kern_malloc(newlen);
lens = 0;
lens = (u_short*)kern_malloc((maxmaxcode+1)
                                                     * sizeof(*lens));
i = LAST+1;
i = hsize;
ent = proto;
wptr = &cp_buf[2];
slen = m->m_len;
rptr = mtod(m, u_char*);
n = m->m_next;
slen = n->m_len;
rptr = mtod(n, u_char*);
n = n->m_next;
c = *rptr++;
fcode = BSD_KEY(ent,c);
hval = BSD_HASH(ent,c,hshift);
dictp = &db->dict[hval];

ent = dictp->codem1+1;
disp = (hval == 0) ? 1 : hval;
dictp = &db->dict[hval];
ent = dictp->codem1+1;  /* found (prefix,suffix) */
dictp2 = &db->dict[max_ent+1];
ent = c;
rptr = dmsg->b_rptr+PPP_BUF_HEAD_INFO;
slen = dmsg->b_wptr - rptr;
dmsg = dmsg->b_cont;
rptr = dmsg->b_rptr;
c = *rptr++;
fcode = BSD_KEY(ent,c);
hval = BSD_HASH(ent,c,hshift);
dictp = &db->dict[hval];

ent = dictp->codem1+1;
disp = (hval == 0) ? 1 : hval;
dictp = &db->dict[hval];
ent = dictp->codem1+1;
dictp2 = &db->dict[max_ent+1];
ent = c;
rptr = cmsg->b_rptr;
i = 0;
explen = 2;
bp = cmsg;
cmsg = cmsg->b_cont;
rptr = cmsg->b_rptr;
i = (i << 8) + *rptr++;
explen = (msgdsize(cmsg)*db->ratio)/RATIO_SCALE;
explen = (msgdsize(cmsg)*3)/2;
explen = db->mru;

dmsg = dmsg1 = allocb(explen+PPP_BUF_HEAD_INFO, BPRI_HI);
wptr = dmsg1->b_wptr;

rptr9 = cmsg->b_wptr;
wptr0 = wptr;
explen = dmsg1->b_datap->db_lim - wptr;
oldcode = CLEAR;
bp = cmsg;
cmsg = cmsg->b_cont;
rptr = cmsg->b_rptr;
rptr9 = cmsg->b_wptr;
incode = accum >> tgtbitno;
i = msgdsize(cmsg);
wptr0 = wptr;
i = db->lens[oldcode];
explen = MAX(64,i+1);
bp = allocb(explen, BPRI_HI);
dmsg1 = bp;
wptr0 = wptr = dmsg1->b_wptr;
explen=dmsg1->b_datap->db_lim-wptr-(i+1);
p = (wptr += i);
finchar = oldcode;
i = db->lens[finchar = incode];
explen = MAX(64,i);
bp = allocb(explen, BPRI_HI);
dmsg1 = bp;
wptr0 = wptr = dmsg1->b_wptr;
explen = dmsg1->b_datap->db_lim-wptr-i;
p = (wptr += i);
dictp = &db->dict[db->dict[finchar].cptr];
finchar = dictp->f.hs.prefix;
fcode = BSD_KEY(oldcode,finchar);
hval = BSD_HASH(oldcode,finchar,db->hshift);
dictp = &db->dict[hval];
disp = (hval == 0) ? 1 : hval;
dictp = &db->dict[hval];
dictp2 = &db->dict[max_ent+1];
tgtbitno = 32-n_bits;
oldcode = incode;
