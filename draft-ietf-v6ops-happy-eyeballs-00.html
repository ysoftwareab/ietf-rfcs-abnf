<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Happy Eyeballs: Trending Towards Success with Dual-Stack Hosts</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Notational Conventions">
<link href="#rfc.section.3" rel="Chapter" title="3 Problem Statement">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 URIs and hostnames">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 IPv6 connectivity">
<link href="#rfc.section.4" rel="Chapter" title="4 Client Recommendations">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Dualstack behavior">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Implementation details">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Additional Considerations">
<link href="#rfc.section.4.3.1" rel="Chapter" title="4.3.1 Additional Network and Host Traffic">
<link href="#rfc.section.4.3.2" rel="Chapter" title="4.3.2 Abandon Non-Winning Connections">
<link href="#rfc.section.4.3.3" rel="Chapter" title="4.3.3 Flush or Expire Cache">
<link href="#rfc.section.4.3.4" rel="Chapter" title="4.3.4 Determining Address Type">
<link href="#rfc.section.4.3.5" rel="Chapter" title="4.3.5 Debugging and Troubleshooting">
<link href="#rfc.section.4.3.6" rel="Chapter" title="4.3.6 DNS Behavior">
<link href="#rfc.section.4.3.7" rel="Chapter" title="4.3.7 Middlebox Issues">
<link href="#rfc.section.4.3.8" rel="Chapter" title="4.3.8 Multiple Interfaces">
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 Content Provider Recommendations">
<link href="#rfc.section.4.5" rel="Chapter" title="4.5 Security Considerations">
<link href="#rfc.section.4.6" rel="Chapter" title="4.6 Acknowledgements">
<link href="#rfc.section.4.7" rel="Chapter" title="4.7 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="5 References">
<link href="#rfc.references.1" rel="Chapter" title="5.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="5.2 Informational References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document describes how a dual-stack client can determine the functioning path to a dual-stack server.  This provides a seamless user experience during initial deployment of dual-stack networks and during outages of IPv4 or outages of IPv6." />
  <meta name="description" content="This document describes how a dual-stack client can determine the functioning path to a dual-stack server.  This provides a seamless user experience during initial deployment of dual-stack networks and during outages of IPv4 or outages of IPv6." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">v6ops</td>
<td class="right">D. Wing</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">A. Yourtchenko</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">Cisco</td>
</tr>
<tr>
<td class="left">Expires: September 04, 2011</td>
<td class="right">March 03, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Happy Eyeballs: Trending Towards Success with Dual-Stack Hosts<br />
  <span class="filename">draft-ietf-v6ops-happy-eyeballs-00</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document describes how a dual-stack client can determine the functioning path to a dual-stack server.  This provides a seamless user experience during initial deployment of dual-stack networks and during outages of IPv4 or outages of IPv6.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on September 04, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Notational Conventions</a>
</li>
<li>3.   <a href="#rfc.section.3">Problem Statement</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">URIs and hostnames</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">IPv6 connectivity</a>
</li>
<li>4.   <a href="#rfc.section.4">Client Recommendations</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Dualstack behavior</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Implementation details</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Additional Considerations</a>
</li>
<li>4.3.1.   <a href="#rfc.section.4.3.1">Additional Network and Host Traffic</a>
</li>
<li>4.3.2.   <a href="#rfc.section.4.3.2">Abandon Non-Winning Connections</a>
</li>
<li>4.3.3.   <a href="#rfc.section.4.3.3">Flush or Expire Cache</a>
</li>
<li>4.3.4.   <a href="#rfc.section.4.3.4">Determining Address Type</a>
</li>
<li>4.3.5.   <a href="#rfc.section.4.3.5">Debugging and Troubleshooting</a>
</li>
<li>4.3.6.   <a href="#rfc.section.4.3.6">DNS Behavior</a>
</li>
<li>4.3.7.   <a href="#rfc.section.4.3.7">Middlebox Issues</a>
</li>
<li>4.3.8.   <a href="#rfc.section.4.3.8">Multiple Interfaces</a>
</li>
<li>4.4.   <a href="#rfc.section.4.4">Content Provider Recommendations</a>
</li>
<li>4.5.   <a href="#rfc.section.4.5">Security Considerations</a>
</li>
<li>4.6.   <a href="#rfc.section.4.6">Acknowledgements</a>
</li>
<li>4.7.   <a href="#rfc.section.4.7">IANA Considerations</a>
</li>
<li>5.   <a href="#rfc.references">References</a>
</li>
<li>5.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>5.2.   <a href="#rfc.references.2">Informational References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">In order to use HTTP successfully over IPv6, it is necessary that the user enjoys nearly identical performance as compared to IPv4.  A combination of today's applications, IPv6 tunneling and IPv6 service providers, and some of today's content providers all cause the user experience to suffer (<a href="#problem_statement">Section 3</a>). For IPv6, a content provider may ensure a positive user experience by using a DNS white list of IPv6 service providers who peer directly with them, e.g. <a href="#whitelist">[whitelist]</a>. However, this is not scalable to all service providers worldwide, nor is it scalable for other content providers to operate their own DNS white list.</p>
<p id="rfc.section.1.p.2">Instead, this document suggests a mechanism for applications to quickly determine if IPv6 or IPv4 is the most optimal to connect to a server. The suggestions in this document provide a user experience which is superior to connecting to ordered IP addresses which is helpful during the IPv6/IPv4 transition with dual stack hosts.</p>
<p id="rfc.section.1.p.3">This problem is described also in <a href="#RFC1671">[RFC1671]</a>: "The dual-stack code may get two addresses back from DNS; which does it use?  During the many years of transition the Internet will contain black holes. For example, somewhere on the way from IPng host A to IPng host B there will sometimes (unpredictably) be IPv4-only routers which discard IPng packets.  Also, the state of the DNS does not necessarily correspond to reality. A host for which DNS claims to know an IPng address may in fact not be running IPng at a particular moment; thus an IPng packet to that host will be discarded on delivery.  Knowing that a host has both IPv4 and IPng addresses gives no information about black holes. A solution to this must be proposed and it must not depend on manually maintained information.  (If this is not solved, the dual stack approach is no better than the packet translation approach.)"</p>
<p id="rfc.section.1.p.4">Following the procedures in this document, once a certain address family is successful, the application trends towards preferring that address family.  Thus, repeated use of the application DOES NOT cause repeated probes over both address families.</p>
<p id="rfc.section.1.p.5">While the application recommendations in this document are described in the context of HTTP clients ("web browsers"), it is also useful and applicable to other interactive applications.</p>
<p id="rfc.section.1.p.6">Code which implements some of the ideas described in this document has been made available <a href="#Perreault">[Perreault]</a> <a href="#Andrews">[Andrews]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Notational Conventions</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#problem_statement" id="problem_statement">Problem Statement</a>
</h1>
<p id="rfc.section.3.p.1">As discussed in more detail in <a href="#problem_uris">Section 3.1</a>, it is important that the same URI and hostname be used for IPv4 and IPv6.  Using separate namespaces causes namespace fragmentation and reduces the ability for users to share URIs and hostnames, and complicates printed material that includes the URI or hostname.</p>
<p id="rfc.section.3.p.2">As discussed in more detail in <a href="#problem_ipv6">Section 3.2</a>, IPv6 connectivity is sometimes broken entirely or slower than native IPv4 connectivity.</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#problem_uris" id="problem_uris">URIs and hostnames</a>
</h1>
<p id="rfc.section.3.1.p.1">URIs are often used between users to exchange pointers to content -- such as on social networks, email, instant messaging, or other systems.  Thus, production URIs and production hostnames containing references to IPv4 or IPv6 will only function if the other party is also using an application, OS, and a network that can access the URI or the hostname.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#problem_ipv6" id="problem_ipv6">IPv6 connectivity</a>
</h1>
<p id="rfc.section.3.2.p.1">When IPv6 connectivity is impaired, today's IPv6-capable web browsers incur many seconds of delay before falling back to IPv4. This harms the user's experience with IPv6, which will slow the acceptance of IPv6, because IPv6 is frequently disabled in its entirety on the end systems to improve the user experience.</p>
<p id="rfc.section.3.2.p.2">Reasons for such failure include no connection to the IPv6 Internet, broken 6to4 or Teredo tunnels, and broken IPv6 peering.</p>
<div id="#rfc.figure.1"></div>
<div id="#diagram_message_flow"></div>
<pre>
   DNS Server                  Client                  Server
       |                          |                       |
 1.    |&lt;--www.example.com A?-----|                       |
 2.    |&lt;--www.example.com AAAA?--|                       |
 3.    |---192.0.2.1-------------&gt;|                       |
 4.    |---2001:dba::1-----------&gt;|                       |
 5.    |                          |                       |
 6.    |                          |--TCP SYN, IPv6---&gt;X   |
 7.    |                          |--TCP SYN, IPv6---&gt;X   |
 8.    |                          |--TCP SYN, IPv6---&gt;X   |
 9.    |                          |                       |
 10.   |                          |--TCP SYN, IPv4-------&gt;|
 11.   |                          |&lt;-TCP SYN+ACK, IPv4----|
 12.   |                          |--TCP ACK, IPv4-------&gt;|
</pre>
<p id="rfc.section.3.2.p.3">The client obtains the IPv4 and IPv6 records for the server (1-4).  The client attempts to connect using IPv6 to the server, but the IPv6 path is broken (6-8), which consumes several seconds of time.  Eventually, the client attempts to connect using IPv4 (10) which succeeds.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Client Recommendations</h1>
<p id="rfc.section.4.p.1">To provide fast connections for users, clients should make connections quickly over various technologies, automatically tune itself to avoid flooding the network with unnecessary connections (i.e., for technologies that have not made successful connections), and occasionally flush its self-tuning.</p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#client_v6" id="client_v6">Dualstack behavior</a>
</h1>
<p id="rfc.section.4.1.p.1">If a TCP client supports IPv6 and IPv4 and is connected to IPv4 and IPv6 networks, it can perform the procedures described in this section.</p>
<div id="#rfc.figure.2"></div>
<div id="#diagram_message_flow_happy_1"></div>
<pre>
   DNS Server                  Client                  Server
       |                          |                       |
 1.    |&lt;--www.example.com A?-----|                       |
 2.    |&lt;--www.example.com AAAA?--|                       |
 3.    |---192.0.2.1-------------&gt;|                       |
 4.    |---2001:dba::1-----------&gt;|                       |
 5.    |                          |                       |
 6.    |                          |==TCP SYN, IPv6===&gt;X   |
 7.    |                          |--TCP SYN, IPv4-------&gt;|
 8.    |                          |&lt;-TCP SYN+ACK, IPv4----|
 9.    |                          |--TCP ACK, IPv4-------&gt;|
10.    |                          |==TCP SYN, IPv6===&gt;X   |
</pre>
<p id="rfc.section.4.1.p.2">In the diagram above, the client sends two TCP SYNs at the same time over IPv6 (6) and IPv4 (7).  In the diagram, the IPv6 path is broken but has little impact to the user because there is no long delay before using IPv4.  The IPv6 path is retried until the application gives up (10).</p>
<div id="#rfc.figure.3"></div>
<div id="#diagram_message_flow_happy_2"></div>
<pre>
   DNS Server                  Client                  Server
       |                          |                       |
 1.    |&lt;--www.example.com A?-----|                       |
 2.    |&lt;--www.example.com AAAA?--|                       |
 3.    |---192.0.2.1-------------&gt;|                       |
 4.    |---2001:dba::1-----------&gt;|                       |
 5.    |                          |                       |
 6.    |                          |==TCP SYN, IPv6=======&gt;|
 7.    |                          |--TCP SYN, IPv4-------&gt;|
 8.    |                          |&lt;=TCP SYN+ACK, IPv6====|
 9.    |                          |&lt;-TCP SYN+ACK, IPv4----|
10.    |                          |==TCP ACK, IPv6=======&gt;|
11.    |                          |--TCP ACK, IPv4-------&gt;|
12.    |                          |--TCP RST, IPv4-------&gt;|
</pre>
<p id="rfc.section.4.1.p.3">The diagram above shows a case where both IPv6 and IPv4 are working, and IPv4 is abandoned (12).</p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#client_v6_details" id="client_v6_details">Implementation details</a>
</h1>
<p id="rfc.section.4.2.p.1">This section details how to provide robust dual stack service for both IPv6 and IPv4, so that the user perceives very fast application response.</p>
<p id="rfc.section.4.2.p.2">The TCP client application is configured with one application-wide value of P.  A positive value indicates a preference for IPv6 and a negative value indicates a preference for IPv4. A value of 0 indicates equal weight, which means the A and AAAA queries and associated connection attempts will be sent as quickly as possible. The absolute value of P is the measure of a delay before initiating a DNS lookup and a connection attempt on the other address family. There are two P values maintained: one is application-wide and the other is specific per each destination (hostname and port).</p>
<p id="rfc.section.4.2.p.3">The algorithm attempts to delay the DNS query until it expects that address family will be necessary; that is, if the preference is towards IPv6, then AAAA will be queried immediately and the A query will be delayed.</p>
<p id="rfc.section.4.2.p.4">The TCP client application starts two concurrent execution flows (they will be referred to as "threads" but this reference does not imply the implementation detail of using the threading library, merely the property of mutual concurrency) in order to minimize the user-noticeable delay ("dead time") during the connection attempts:</p>

<dl>
<dt>thread 1: (IPv6)</dt>
<dd style="margin-left: 8"><ul>
<li>If P&lt;0, wait for absolute value of p*10 milliseconds</li>
<li>send DNS query for AAAA</li>
<li>wait until DNS response is received</li>
<li>Attempt to connect over IPv6 using TCP</li>
</ul></dd>
<dt>thread 2: (IPv4)</dt>
<dd style="margin-left: 8"><ul>
<li>if P&gt;0, wait for p*10 milliseconds</li>
<li>send DNS query for A</li>
<li>wait until DNS response is received</li>
<li>Attempt to connect over IPv4 using TCP</li>
</ul></dd>
</dl>
<p id="rfc.section.4.2.p.5">The first thread that succeeds returns the completed connection to the parent code and aborts the other thread (<a href="#abandon">Section 4.3.2</a>).</p>
<p id="rfc.section.4.2.p.6">After a connection is successful, we want to adjust the application-wide preference and the per-destination preference. The value of P is incremented (decremented) each time an IPv6 (IPv4) connection wins the race.. When a connection using the less-preferred address family is successful, it indicates the wrong address family was used and the value of P is halved:</p>

<ul>
<li>If P&gt;0 (indicating IPv6 is preferred over IPv4) and the first thread to finish was the IPv6 thread it indicates the IPv6 preference is correct and we need to re-enforce this by increasing the application-wide P value by 1. However, if the first thread to finish was the IPv4 thread it indicates an IPv6 connection problem occurred and we need to aggressively prefer IPv4 more by halving P and rounding towards 0.</li>
<li>If P&lt;0 (indicating IPv4 is preferred over IPv6) and the first thread to finish was the IPv4 thread it indicates the preference is correct and we need to re-enforce this gently by decreasing the application-wide P value by 1. However, if the first thread to finish was the IPv6 thread it indicates an IPv4 connection problem and we need to aggressively avoid IPv4 by halving P and rounding towards 0.</li>
<li>If P=0 (indicating equal preference), P is incremented by one if the first thread to complete was the IPv6 thread, or decremented by one if the first thread to complete was the IPv4 thread.</li>
</ul>

<p>After adjusting P, the resulting delay should never be larger than 4 seconds -- which is similar to the value used by many IPv6-capable TCP client applications to switch to an alternate A or AAAA record.</p>
<p></p>

<ul class="empty">
<li>Editor's Note 01: Proof of concept tests on fast networks show that even smaller value (around 0.5 seconds) may be practical. More extensive testing would be useful to find the best upper boundary that still ensures a good user experience.</li>
<li>Editor's Note 02:   A strict implementation of the above steps results in "P" being adjusted if there are no AAAA records or are no A records.  This is undesirable.  Thus, a future version of this specification is expected to recommend that "P" only be adjusted if there was both an A and AAAA record.  </li>
</ul>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> Additional Considerations</h1>
<p id="rfc.section.4.3.p.1">This section discusses considerations and requirements that are common to new technology deployment.</p>
<h1 id="rfc.section.4.3.1">
<a href="#rfc.section.4.3.1">4.3.1.</a> Additional Network and Host Traffic</h1>
<p id="rfc.section.4.3.1.p.1">Additional network traffic and additional server load is created due to these recommendations and mitigated by application-wide and per-destination timer adjustments. The procedures described in this document retain a quality user experience while transitioning from IPv4-only to dual stack.  The quality user experience benefits the user but to the detriment of the network and server that are serving the user.</p>
<h1 id="rfc.section.4.3.2">
<a href="#rfc.section.4.3.2">4.3.2.</a> <a href="#abandon" id="abandon">Abandon Non-Winning Connections</a>
</h1>
<p id="rfc.section.4.3.2.p.1">It is RECOMMENDED that the non-winning connections be abandoned, even though they could be used to download content. This is because some web sites provide HTTP clients with cookies (after logging in) that incorporate the client's IP address, or use IP addresses to identify users. If some connections from the same HTTP client are arriving from different IP addresses, such HTTP applications will break.  It's also important to abandon connections to avoid consuming server or middlebox (e.g., NAT) resources (file descriptors, memory, TCP control blocks) and avoid sending TCP or application-level keepalives on otherwise unused connections.</p>
<h1 id="rfc.section.4.3.3">
<a href="#rfc.section.4.3.3">4.3.3.</a> Flush or Expire Cache</h1>
<p id="rfc.section.4.3.3.p.1">Because every network has different characteristics (e.g., working or broken IPv6 connectivity) the IPv6/IPv4 preference value (P) SHOULD be reset to its default whenever the host is connected to a new network (<a href="#cx-osx">[cx-osx]</a>, <a href="#cx-win">[cx-win]</a>).  However, in some instances the application and the host are unaware the network connectivity has changed so it is RECOMMENDED that per-destination values expire after 10 minutes of inactivity.</p>
<h1 id="rfc.section.4.3.4">
<a href="#rfc.section.4.3.4">4.3.4.</a> Determining Address Type</h1>
<p id="rfc.section.4.3.4.p.1">For some transitional technologies such as a dual-stack host, it is easy for the application to recognize the native IPv6 address (learned via a AAAA query) and the native IPv4 address (learned via an A query). For other transitional technologies <a href="#RFC2766">[RFC2766]</a> it is impossible for the host to differentiate a transitional technology IPv6 address from a native IPv6 address (see Section 4.1 of <a href="#RFC4966">[RFC4966]</a>).  Replacement transitional technologies are attempting to bridge this gap. It is necessary for applications to distinguish between native and transitional addresses in order to provide the most seamless user experience.</p>
<p id="rfc.section.4.3.4.p.2">Application awareness of transitional technologies, if implemented, SHOULD provide a facility to give the preference only to native IPv6 addresses.  </p>
<h1 id="rfc.section.4.3.5">
<a href="#rfc.section.4.3.5">4.3.5.</a> Debugging and Troubleshooting</h1>
<p id="rfc.section.4.3.5.p.1">This mechanism is aimed at ensuring a reliable user experience regardless of connectivity problems affecting any single transport.  However, this naturally means that applications employing these techniques are by default less useful for diagnosing issues with any particular transport. To assist in that regard, the applications implementing the proposal in this document SHOULD also provide a mechanism to revert the behavior to that of a default provided by the operating system - the <a href="#RFC3484">[RFC3484]</a>.</p>
<p></p>

<ul class="empty">
<li>[[[ To be discussed. </li>
<li>Some sites may wish to be informed when the the hosts adjust their "P" value, in order to troubleshoot the underlying cause. To help these sites, a strawman proposal is to send a syslog message or other notification to an address that may be configured by a site administrator in a centralized fashion.  (The exact method TBD - DHCP option, domain name, etc.) This syslog message should be sent only first N times that the host expects to prefer IPv6 but has to use IPv4. I.e. the first N times it decreases the value of P. N - TBD.</li>
<li>]]]</li>
</ul>
<h1 id="rfc.section.4.3.6">
<a href="#rfc.section.4.3.6">4.3.6.</a> <a href="#dns_behavior" id="dns_behavior">DNS Behavior</a>
</h1>
<p id="rfc.section.4.3.6.p.1">Unique to DNS AAAA queries are the problems described in <a href="#RFC4074">[RFC4074]</a> which, if they still persist, require applications to perform an A query before the AAAA query. </p>

<ul class="empty"><li>[[Editor's Note 03: It is believed these defective DNS servers have long since been upgraded. If so, we can remove this section.]]</li></ul>
<h1 id="rfc.section.4.3.7">
<a href="#rfc.section.4.3.7">4.3.7.</a> Middlebox Issues</h1>
<p id="rfc.section.4.3.7.p.1">Some devices are known to exhibit what amounts to a bug, when the A and AAAA requests are sent back-to-back over the same 4-tuple, and drop one of the requests or replies <a href="#DNS-middlebox">[DNS-middlebox]</a>. However, in some cases fixing this behaviour may not be possible either due to the architectural limitations or due to the administrative constraints (location of the faulty device is unknown to the end hosts or not controlled by the end hosts). The algorithm described in this draft, in the case of this erroneous behaviour will eventually pace the queries such that this issue is will be avoided. The algorithm described in this draft also avoids calling the operating system's getaddrinfo() with "any", which should prevent the operating system from sending the A and AAAA queries on the same port.</p>
<p id="rfc.section.4.3.7.p.2">For the large part, these issues are believed to be fixed, in which case the getaddrinfo() with AF_UNSPEC as the address family in its hints.</p>
<h1 id="rfc.section.4.3.8">
<a href="#rfc.section.4.3.8">4.3.8.</a> Multiple Interfaces</h1>
<p id="rfc.section.4.3.8.p.1">Interaction of the suggestions in this document with multiple interfaces, and interaction with the MIF working group, is for further study.</p>
<h1 id="rfc.section.4.4">
<a href="#rfc.section.4.4">4.4.</a> Content Provider Recommendations</h1>
<p id="rfc.section.4.4.p.1">Content providers SHOULD provide both AAAA and A records for servers using the same DNS name for both IPv4 and IPv6.</p>
<h1 id="rfc.section.4.5">
<a href="#rfc.section.4.5">4.5.</a> <a href="#security_considerations" id="security_considerations">Security Considerations</a>
</h1>
<p id="rfc.section.4.5.p.1">[[Placeholder.]]</p>
<p id="rfc.section.4.5.p.2">See <a href="#abandon">Section 4.3.2</a>.</p>
<h1 id="rfc.section.4.6">
<a href="#rfc.section.4.6">4.6.</a> Acknowledgements</h1>
<p id="rfc.section.4.6.p.1">The mechanism described in this paper was inspired by Stuart Cheshire's discussion at the IAB Plenary at IETF72, the author's understanding of Safari's operation with SRV records, Interactive Connectivity Establishment (<a href="#RFC5245">ICE</a> <cite title="NONE">[RFC5245]</cite>), and the current IPv4/IPv6 behavior of SMTP mail transfer agents.</p>
<p id="rfc.section.4.6.p.2">Thanks to Fred Baker, Jeff Kinzli, Christian Kuhtz, and Iljitsch van Beijnum for fostering the creation of this document.</p>
<p id="rfc.section.4.6.p.3">Thanks to Scott Brim, Rick Jones, Stig Venaas, Erik Kline, Bjoern Zeeb for providing feedback on the document.</p>
<p id="rfc.section.4.6.p.4">Thanks to Javier Ubillos, Simon Perreault and Mark Andrews for the active feedback and the experimental work on the independent practical implementations that they created.</p>
<p id="rfc.section.4.6.p.5">Also the authors would like to thank the following individuals who participated in various email discussions on this topic: Mohacsi Janos, Pekka Savola, Ted Lemon, Carlos Martinez-Cagnazzo, Simon Perreault, Jack Bates,  Jeroen Massar, Fred Baker, Javier Ubillos, Teemu Savolainen, Scott Brim, Erik Kline, Cameron Byrne, Daniel Roesen, Guillaume Leclanche, Cameron Byrne, Mark Smith, Gert Doering, Martin Millnert, Tim Durack.  </p>
<h1 id="rfc.section.4.7">
<a href="#rfc.section.4.7">4.7.</a> IANA Considerations</h1>
<p id="rfc.section.4.7.p.1">This document has no IANA actions.</p>
<h1 id="rfc.references">
<a href="#rfc.references">5.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">5.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3484">[RFC3484]</b></td>
<td class="top">
<a>Draves, R.</a>, "<a href="http://tools.ietf.org/html/rfc3484">Default Address Selection for Internet Protocol version 6 (IPv6)</a>", RFC 3484, February 2003.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">5.2.</a> Informational References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC1671">[RFC1671]</b></td>
<td class="top">
<a href="mailto:brian@dxcoms.cern.ch" title="CERN, Communications Systems, Computing and Networks Division">Carpenter, B.</a>, "<a href="http://tools.ietf.org/html/rfc1671">IPng White Paper on Transition and Other Considerations</a>", RFC 1671, August 1994.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2766">[RFC2766]</b></td>
<td class="top">
<a href="mailto:george.tsirtsis@bt.com" title="Internet Futures">Tsirtsis, G.</a> and <a href="mailto:srisuresh@yahoo.com" title="Campio Communications">P. Srisuresh</a>, "<a href="http://tools.ietf.org/html/rfc2766">Network Address Translation - Protocol Translation (NAT-PT)</a>", RFC 2766, February 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4966">[RFC4966]</b></td>
<td class="top">
<a>Aoun, C.</a> and <a>E. Davies</a>, "<a href="http://tools.ietf.org/html/rfc4966">Reasons to Move the Network Address Translator - Protocol Translator (NAT-PT) to Historic Status</a>", RFC 4966, July 2007.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4074">[RFC4074]</b></td>
<td class="top">
<a>Morishita, Y.</a> and <a>T. Jinmei</a>, "<a href="http://tools.ietf.org/html/rfc4074">Common Misbehavior Against DNS Queries for IPv6 Addresses</a>", RFC 4074, May 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5245">[RFC5245]</b></td>
<td class="top">
<a>Rosenberg, J.</a>, "<a href="http://tools.ietf.org/html/rfc5245">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>", RFC 5245, April 2010.</td>
</tr>
<tr>
<td class="reference"><b id="whitelist">[whitelist]</b></td>
<td class="top">
<a>Google, </a>, "<a>Google IPv6 DNS Whitelist</a>", January 2009.</td>
</tr>
<tr>
<td class="reference"><b id="DNS-middlebox">[DNS-middlebox]</b></td>
<td class="top">
<a>Various, </a>, "<a>DNS middlebox behavior with multiple queries over same source port</a>", June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="cx-osx">[cx-osx]</b></td>
<td class="top">
<a>Adium, </a>, "<a>AIHostReachabilityMonitor</a>", June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="cx-win">[cx-win]</b></td>
<td class="top">
<a>Microsoft, </a>, "<a>NetworkChange.NetworkAvailabilityChanged Event</a>", June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="Perreault">[Perreault]</b></td>
<td class="top">
<a title="Viagenie">Perreault, S</a>, "<a>Happy Eyeballs in Erlang</a>", February 2011.</td>
</tr>
<tr>
<td class="reference"><b id="Andrews">[Andrews]</b></td>
<td class="top">
<a title="ISC">Andrews, M</a>, "<a>How to connect to a multi-homed server over TCP</a>", January 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Dan Wing</span> 
	  <span class="n hidden">
		<span class="family-name">Wing</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>170 West Tasman Drive</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">CA</span> 
		<span class="code">95134</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:dwing@cisco.com">dwing@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Andrew Yourtchenko</span> 
	  <span class="n hidden">
		<span class="family-name">Yourtchenko</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>De Kleetlaan, 7</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">Diegem</span> 
		<span class="code">B-1831</span>
	  </span>
	  <span class="country-name vcardline">Belgium</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ayourtch@cisco.com">ayourtch@cisco.com</a></span>

  </address>
</div>

</body>
</html>