<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Basic HIP Extensions for Traversal of
         Network Address Translators</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Basic HIP Extensions for Traversal of
         Network Address Translators">
<meta name="keywords" content="HIP, host identity protocol, host identity payload, NAT traversal, NAT traversal">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">HIP Working Group</td><td class="header">M. Komu</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">HIIT</td></tr>
<tr><td class="header">Intended status: Experimental</td><td class="header">T. Henderson</td></tr>
<tr><td class="header">Expires: January 15, 2009</td><td class="header">The Boeing Company</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">P. Matthews</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">(Unaffiliated)</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">H. Tschofenig</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Nokia Siemens Networks</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">A. Ker&auml;nen, Ed.</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Ericsson Research Nomadiclab</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">July 14, 2008</td></tr>
</table></td></tr></table>
<h1><br />Basic HIP Extensions for Traversal of
         Network Address Translators<br />draft-ietf-hip-nat-traversal-04.txt</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on January 15, 2009.</p>

<h3>Abstract</h3>

<p> The Host Identity Protocol (HIP) provides a new namespace that can be used for uniquely
            identifying hosts. Existing HIP experimental specifications do not specify protocol
            operations across Network Address Translators (NATs).
</p>
<p> This document specifies basic NAT traversal extensions for HIP. The HIP shim layer is located
            between the network and transport layer, the extensions can also provide a more
            general-purpose NAT traversal support for higher-layer networking applications. The
            extensions are based on the use of the The Interactive Connectivity Establishment (ICE)
            methodology to discover a working path between two end-hosts.


</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#sec:intro">1.</a>&nbsp;
Introduction<br />
<a href="#anchor1">2.</a>&nbsp;
Terminology<br />
<a href="#sec:protocol">3.</a>&nbsp;
Protocol Description<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:registration">3.1.</a>&nbsp;
Relay Registration<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:nat_transform">3.2.</a>&nbsp;
NAT Transformation Negotiation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:relay_bex">3.3.</a>&nbsp;
Base Exchange via HIP Relay<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">3.4.</a>&nbsp;
ICE Connectivity Checks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">3.5.</a>&nbsp;
NAT Keepalives<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:no_relay">3.6.</a>&nbsp;
Base Exchange without ICE Connectivity Checks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:no_udp">3.7.</a>&nbsp;
Base Exchange without UDP Encapsulation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:control_no_relay">3.8.</a>&nbsp;
Sending Control Messages using the Data Plane<br />
<a href="#sec:format">4.</a>&nbsp;
Packet Formats<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:udphip">4.1.</a>&nbsp;
HIP Control Packets<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:con_checks">4.2.</a>&nbsp;
Connectivity Checks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:keep-alive">4.3.</a>&nbsp;
Keepalives<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:rel-reg-params">4.4.</a>&nbsp;
Relay and Registration Parameters<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:locator_format">4.5.</a>&nbsp;
LOCATOR Parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:relay-hmac">4.6.</a>&nbsp;
RELAY_HMAC<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">4.7.</a>&nbsp;
Registration Types<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:udpesp">4.8.</a>&nbsp;
ESP Data Packets<br />
<a href="#anchor5">5.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">5.1.</a>&nbsp;
Privacy Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">5.2.</a>&nbsp;
Opportunistic Mode<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">5.3.</a>&nbsp;
Base Exchange Replay Protection for HIP Relay Server<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">5.4.</a>&nbsp;
Demuxing Different HIP Associations<br />
<a href="#anchor10">6.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor11">7.</a>&nbsp;
Contributors<br />
<a href="#anchor12">8.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">9.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">9.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">9.2.</a>&nbsp;
Informative References<br />
<a href="#sec:interoperability">Appendix&nbsp;A.</a>&nbsp;
IPv4-IPv6 Interoperability<br />
<a href="#anchor15">Appendix&nbsp;B.</a>&nbsp;
Base Exchange through a Rendezvous Server<br />
<a href="#anchor16">Appendix&nbsp;C.</a>&nbsp;
Document Revision History<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="sec:intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>HIP <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a> is defined as a protocol that runs directly over
            IPv4 or IPv6. This approach is known to have problems traversing NATs.
            A detailed description of HIP problems with traversing legacy middleboxes is documented
            in <a class='info' href='#I-D.irtf-hiprg-nat'>[I&#8209;D.irtf&#8209;hiprg&#8209;nat]<span> (</span><span class='info'>Stiemerling, M., &ldquo;NAT and Firewall Traversal Issues of Host Identity Protocol (HIP)  Communication,&rdquo; March&nbsp;2007.</span><span>)</span></a>. This document describes HIP extensions for the
            traversal of both Network Address Translator (NAT) and Network Address and Port Translator
            (NAPT) middleboxes. The document generally uses the term NAT to refer to these types of
             middleboxes.
</p>
<p>Currently deployed NAT devices do not operate consistently even though a recommended behavior is described
            in <a class='info' href='#RFC4787'>[RFC4787]<span> (</span><span class='info'>Audet, F. and C. Jennings, &ldquo;Network Address Translation (NAT) Behavioral Requirements for Unicast UDP,&rdquo; January&nbsp;2007.</span><span>)</span></a>. The HIP protocol extensions in this document make as few
            assumptions as possible about the behavior of the NAT devices so that NAT traversal will
            work even with legacy NAT devices. The purpose of these extensions is to allow two
            HIP-enabled hosts to communicate with each other even if one or both communicating hosts
            are in private address realms.
</p>
<p>Using the extensions defined in this draft, HIP end-hosts
            use the HIP control channel to communicate their current
            locators to each other to find a operational path for the
            ESP encapsulated data traffic. The hosts test connectivity
            between different locators and try to discover direct end-to-end path between the end-hosts.
            However, With some legacy NATs, utilizing the shortest path
            between two end hosts located behind NATs is not possible without relaying the traffic
            through a relay, such as a TURN server <a class='info' href='#RFC5128'>[RFC5128]<span> (</span><span class='info'>Srisuresh, P., Ford, B., and D. Kegel, &ldquo;State of Peer-to-Peer (P2P) Communication across Network Address Translators (NATs),&rdquo; March&nbsp;2008.</span><span>)</span></a>. As a
            consequence, the TURN server increases the roundtrip delay and may become a point of
            network congestion. With the extensions described in this document, hosts try to avoid
            the use the TURN server when possible. 
</p>
<p>This document defines new middlebox extensions to allow
            NAT traversal for HIP control plane. The HIP Relay
            extensions define mechanisms to forward HIP control
            plane. A distinction must be made here between a HIP
            rendezvous services <a class='info' href='#RFC5204'>[RFC5204]<span> (</span><span class='info'>Laganier, J. and L. Eggert, &ldquo;Host Identity Protocol (HIP) Rendezvous Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a>)
            and HIP Relay services. HIP rendezvous servers solve
            initial contact and mobility related problems in networks
            without NATs. HIP Relay servers solve the same problems, in
            addition to NAT traversal problems. HIP Relay servers can
            be used both in NATed and non-NATed networks. 
</p>
<p>Both rendezvous and relay services forward HIP control packets, but the main difference
            is that the rendezvous service forwards only the initial I1 packet of the base exchange
            while all other HIP control packets are sent directly between the communicating hosts.
            In contrast, the relay service relays all HIP control packets because NATs
	    can drop the packets otherwise <a class='info' href='#RFC5128'>[RFC5128]<span> (</span><span class='info'>Srisuresh, P., Ford, B., and D. Kegel, &ldquo;State of Peer-to-Peer (P2P) Communication across Network Address Translators (NATs),&rdquo; March&nbsp;2008.</span><span>)</span></a>.
</p>
<p>The basis for the connectivity checks is ICE <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>. 
</p>
<p><a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a> describes ICE as follows: 
</p>
<p>
            </p>
<blockquote class="text">
<p>"The Interactive Connectivity Establishment (ICE) methodology is a technique for
                  NAT traversal for UDP-based media streams (though ICE can be extended to handle
                  other transport protocols, such as TCP) established by the offer/answer model. ICE
                  is an extension to the offer/answer model, and works by including a multiplicity
                  of IP addresses and ports in SDP offers and answers, which are then tested for
                  connectivity by peer-to-peer connectivity checks. The IP addresses and ports
                  included in the SDP and the connectivity checks are performed using the revised
                  STUN specification <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>, now renamed to
                  Session Traversal Utilities for NAT." 
</p>
</blockquote><p>
         
</p>
<p>ICE for SIP is specified in <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a> and ICE for non-SIP
            protocols is specified in <a class='info' href='#I-D.rosenberg-mmusic-ice-nonsip'>[I&#8209;D.rosenberg&#8209;mmusic&#8209;ice&#8209;nonsip]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Guidelines for Usage of Interactive Connectivity Establishment (ICE) by non  Session Initiation Protocol (SIP) Protocols,&rdquo; July&nbsp;2008.</span><span>)</span></a>. 
</p>
<p>Two hosts communicate their locators to each other in the HIP base exchange. They are then paired with the
            locally operational address of the other endpoint and prioritized according local and recommended
            policies. These address sets are then tested sequentially based on the procedures specified
            in ICE. Both sides participate in the connectivity checks. The tests may also discover multiple
            operational address pairs but determine a single preferred address pair to be used for
            subsequent communication.
</p>
<p>In a nutshell, the extensions in this document defines:
</p>
<p>
            </p>
<ul class="text">
<li>encapsulatation of HIP packets in UDP
</li>
<li>UDP encapsulation of IPsec ESP packets
</li>
<li>registration extensions for HIP Relay services
</li>
<li>how the "offer" and "answer" are carried in the base exchange
</li>
<li>interaction with ICE connectivity messages
</li>
<li>backwards compatibility issues with rendezvous servers
</li>
<li>a number of optimizations (such when the ICE connectivity tests can be excluded)
</li>
</ul><p>
         
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p> The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD
            NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as
            described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>. 
</p>
<p>This document borrows terminology from <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a>, <a class='info' href='#RFC5206'>[RFC5206]<span> (</span><span class='info'>Nikander, P., Henderson, T., Vogt, C., and J. Arkko, &ldquo;End-Host Mobility and Multihoming with the Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a>, <a class='info' href='#RFC4423'>[RFC4423]<span> (</span><span class='info'>Moskowitz, R. and P. Nikander, &ldquo;Host Identity Protocol (HIP) Architecture,&rdquo; May&nbsp;2006.</span><span>)</span></a>, <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>, and <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>.
            Additionally, the following terms are used:
</p>
<p>
            </p>
<blockquote class="text"><dl>
<dt>
                  Rendezvous server:</dt>
<dd><br />
 A host
                  that forwards I1 packets to the Responder<br />
<br />

</dd>
<dt>HIP Relay:</dt>
<dd><br />
 A host that forwards all HIP
                  control packets between an Initiator and Responder<br />
<br />

</dd>
<dt>TURN server:</dt>
<dd><br />
 A server that forwards data
                  traffic between two end-hosts<br />
<br />

</dd>
<dt>Locator:</dt>
<dd><br />
 As defined in <a class='info' href='#RFC5206'>[RFC5206]<span> (</span><span class='info'>Nikander, P., Henderson, T., Vogt, C., and J. Arkko, &ldquo;End-Host Mobility and Multihoming with the Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a>:
                  "A name that controls how the packet
                  is routed through the network and demultiplexed by the end host. It may include a
                  concatenation of traditional network addresses such as an IPv6 address and
                  end-to-end identifiers such as an ESP SPI. It may also include transport port
                  numbers or IPv6 Flow Labels as demultiplexing context, or it may simply be a
                  network address." It should noticed that "address" is used in this
                  document as a synonym for locator.<br />
<br />

               
</dd>
<dt>HIP Relay:</dt>
<dd><br />
 LOCATOR (written in capital letters)
                  denotes a HIP control message parameter that bundles multiple locators together
                  <br />
<br />

</dd>
<dt>ICE Offer:</dt>
<dd><br />
 The Initiator's LOCATOR parameter
                  in HIP I2 control message.
</dd>
<dt>ICE Answer:</dt>
<dd><br />
 The Responder's LOCATOR parameter
	          in HIP R2 control message
</dd>
<dt>Transport address:</dt>
<dd><br />
 Transport layer port and
                  the corresponding IPv4/v6 address<br />
<br />

</dd>
<dt>Candidate:</dt>
<dd><br />
 A transport address that has not
                  been verified yet for reachability using ICE<br />
<br />

</dd>
<dt>Host candidate:</dt>
<dd><br />
 An IPv4 or IPv6 address of a
                  network interface of a host<br />
<br />

</dd>
<dt>Server reflexive transport candidate:</dt>
<dd><br />
 A
                  translated transport address of a host as observed by a HIP Relay or a STUN server<br />
<br />

</dd>
<dt>Peer reflexive transport candidate:</dt>
<dd><br />
 A
                  translated transport address of a host as observed by its peer<br />
<br />

</dd>
<dt>Relayed transport candidate:</dt>
<dd><br />
 A transport
                  address that exists on a TURN server. Packets that arrive
                  at this address are relayed towards the TURN client. 
</dd>
</dl></blockquote><p>
         
</p>
<a name="sec:protocol"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Protocol Description</h3>

<p> This section describes the normative behavior of the protocol extension. Examples of
            packet exchanges are provided for illustration purposes.
</p>
<a name="sec:registration"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Relay Registration</h3>

<p> HIP rendezvous servers operate in non-NATed
               environments and their use is described in
               <a class='info' href='#RFC5204'>[RFC5204]<span> (</span><span class='info'>Laganier, J. and L. Eggert, &ldquo;Host Identity Protocol (HIP) Rendezvous Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a>. This section specifies a new
               middlebox extension, called the HIP Relay, to perate in
               NATted environments. HIP Relay servers forward all HIP
               control packets between the Initiator and the Responder
               over UDP.
</p>
<p>End-hosts cannot use the HIP Relay service for forward
               ESP data plane. Instead, they use TURN servers
               <a class='info' href='#I-D.ietf-behave-turn'>[I&#8209;D.ietf&#8209;behave&#8209;turn]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; July&nbsp;2009.</span><span>)</span></a> for
               relaying the ESP traffic. A HIP end-host SHOULD register to a TURN
               server before registering to a HIP Relay to guarantee
               that the host can accept ESP traffic immediately after
               HIP Relay registration. 
</p>
<p> A HIP Relay MUST silently drop packets to a HIP Relay Client that has not previously
               registered with the HIP Relay. The registration process follows the generic
               registration extensions defined in <a class='info' href='#RFC5203'>[RFC5203]<span> (</span><span class='info'>Laganier, J., Koponen, T., and L. Eggert, &ldquo;Host Identity Protocol (HIP) Registration Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a> and is
               illustrated in <a class='info' href='#fig:reg'>Figure&nbsp;1<span> (</span><span class='info'>Example Registration to a HIP Relay</span><span>)</span></a>. 
</p><br /><hr class="insert" />
<a name="fig:reg"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
HIP                                                      HIP
Relay                                                    Relay
Client                                                   Server
  |   1. UDP(I1)                                           |
  +-------------------------------------------------------&gt;|
  |                                                        |
  |   2. UDP(R1(REG_INFO(RELAY_UDP_HIP)))                  |
  |&lt;-------------------------------------------------------+
  |                                                        |
  |   3. UDP(I2(REG_REQ(RELAY_UDP_HIP)))                   |
  +-------------------------------------------------------&gt;|
  |                                                        |
  |   4. UDP(R2(REG_RES(RELAY_UDP_HIP), REG_FROM))         |
  |&lt;-------------------------------------------------------+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Example Registration to a HIP Relay&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p> In step 1, the Relay Client (Initiator) starts the registration procedure by sending an I1 packet
               over UDP. It is RECOMMENDED that the Initiator selects a random port number from the ephemeral
               port range 49152-65535 for initiating a base exchange. However, the allocated port
               MUST be maintained until all of the corresponding HIP Associations are closed.
               Alternatively, a host MAY also use a single fixed port for initiating all outgoing
               connections. 
</p>
<p> In step 2, the Relay Server (Responder) lists the services that it supports in the R1 packet. The
               support for HIP-over-UDP relaying is denoted by the RELAY_UDP_HIP value. The R1 SHOULD not contain any
                NAT transform parameter.
</p>
<p> In step 3, the Initiator selects the services it registers for and lists them in the
               REG_REQ parameter. In this example, the Initiator registers for HIP Relay service. 
</p>
<p>In step 4, the Responder concludes the registration procedure with an R2 packet and
               acknowledges the registered services in the REG_RES parameter. The Responder
               denotes unsuccessful registrations in the REG_FAILED parameter in R2. The Responder
               also includes a REG_FROM parameter that contains the transport address of the client
               as observed by the Relay (Server Reflexive candidate). After the registration, the
               Initiator sends periodically NAT keepalives.
</p>
<p> There are different ways for an Initiator to learn it's publicly visible IP
               address and port that are referred to as the "server reflexive transport candidate"
               in this document. It is a local decision on how the end-host learnds the candidate, but
               either of the following methods is RECOMMENDED:
</p>
<p>
               </p>
<ul class="text">
<li>The Relay client may use STUN servers to detect the server reflexive locator,
                     as described in <a class='info' href='#RFC5128'>[RFC5128]<span> (</span><span class='info'>Srisuresh, P., Ford, B., and D. Kegel, &ldquo;State of Peer-to-Peer (P2P) Communication across Network Address Translators (NATs),&rdquo; March&nbsp;2008.</span><span>)</span></a>. 
</li>
<li>Alternatively, the Relay Client can learn it from the REG_FROM parameter when
                     registering to a Relay.
</li>
</ul><p>
            
</p>
<a name="sec:nat_transform"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
NAT Transformation Negotiation</h3>

<p>This section describes the usage of a new non-critical
               transform parameter type. The presence of the parameter
               in HIP base exchange means that the end-host supports
               ICE connectivity checks. As the parameter is
               non-critical, it can be ignored by an end-host which
               means that the host does not support or is not willing
               to use ICE connectivity checks.
</p>
<p>The NAT transform parameter applies to a base exchange
               between end-hosts, but currently does not apply to with
               a registration with a HIP Relay server. The NAT
               transform applies only to a base exchange with
               transport layer encapsulation and MUST not be included
               without transport layer encapsulation. The NAT transform
               negotiation in base exchange is illustrated in
               <a class='info' href='#fig:nat_transform'>Figure&nbsp;2<span> (</span><span class='info'>Negotiation of NAT Transforms</span><span>)</span></a>. 
</p><br /><hr class="insert" />
<a name="fig:nat_transform"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
Initiator                                                Responder
  | 1. UDP(I1)                                                   |
  +-------------------------------------------------------------&gt;|
  |                                                              |
  | 2. UDP(R1(.., NAT_TRANSFORM(list of transforms), ..))        |
  |&lt;-------------------------------------------------------------+
  |                                                              |
  | 3. UDP(I2(.., NAT_TRANSFORM(selected transform), LOCATOR..)) |
  +-------------------------------------------------------------&gt;|
  |                                                              |
  | 4. UDP(R2(.., LOCATOR, ..))                                  |
  |&lt;-------------------------------------------------------------+
  |                   ....                                       |
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Negotiation of NAT Transforms&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p> In step 1, the Initiator sends an I1 to the Responder. In step 2, the Responder
               responds with an R1. The R1 contains a list of transforms the Responder supports in
               NAT_TRANSFORM parameter as shown in <a class='info' href='#tbl:locator_transform'>Table&nbsp;1<span> (</span><span class='info'>Locator Transformations</span><span>)</span></a>. 
</p><br /><hr class="insert" />
<a name="tbl:locator_transform"></a>
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left">
<tr><th align="left">Transform Type</th><th align="left">Purpose</th></tr>
<tr>
<td align="left">RESERVED</td>
<td align="left">Reserved for future use</td>
</tr>
<tr>
<td align="left">ICE-STUN-UDP</td>
<td align="left">UDP encapsulated control and data traffic with ICE-based connectivity checks using
                  STUN messages</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Table 1: Locator Transformations&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p> In step 3, the Initiator sends an I2 that includes a NAT_TRANSFORM parameter. It
               contains the transform type selected by the Initiator from the list of transforms
               offered by the Responder. The I2 also includes the locators of the Initiator in a
               LOCATOR parameter. The locator parameter in I2 is the "ICE offer".
</p>
<p> In step 4, the Responder concludes the base exchange with an R2 packet. The
               Responder includes a LOCATOR parameter in the R2 packet. The locators parameter in R2
	       is the "ICE answer".
</p>
<a name="sec:relay_bex"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Base Exchange via HIP Relay</h3>

<p>This section describes how Initiator and Responder
               establish a base exchange through a HIP Relay. The NAT
               transform negotiation (denoted as NAT_TFM in the
               example) was described in previous section and shall
               not be repeated here. When a Relay receives an R1 or I2
               packet without the NAT transform packet, it drops it
               and sends a NOTIFY error message to the originator.
</p>
<p> It is RECOMMENDED that the Initiator sends an I1 packet encapsulated in UDP when it
               is destined to an IPv4 address of the Responder. Respectively, the Responder MUST
               respond to such an I1 packet with an R1 packet over the transport layer and using the
               same transport protocol. The rest of the base exchange, I2 and R2, MUST also use the
               same transport layer.
</p><br /><hr class="insert" />
<a name="fig:bex"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
I                            HIP Relay                          R
| 1. UDP(I1)                   |                                |
+-----------------------------&gt;| 2. UDP(I1(RELAY_FROM))         |
|                              +-------------------------------&gt;|
|                              |                                |
|                              | 3. UDP(R1(RELAY_TO, NAT_TFM))  |
| 4. UDP(R1(RELAY_TO),NAT_TFM) |&lt;-------------------------------+
|&lt;-----------------------------+                                |
|                              |                                |
| 5. UDP(I2(LOCATOR),NAT_TFM)  |                                |
+-----------------------------&gt;|  6. UDP(I2(LOCATOR,RELAY_FROM),|
|                              |       NAT_TFM)                 |
|                              +-------------------------------&gt;|
|                              |                                |
|                              | 7. UDP(R2(LOCATOR,RELAY_TO))   |
| 8. UDP(R2(LOCATOR,RELAY_TO)) |&lt;-------------------------------+
|&lt;-----------------------------+                                |
|                              |                                |
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Base Exchange via a HIP Relay&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p> In step 1 of <a class='info' href='#fig:bex'>Figure&nbsp;3<span> (</span><span class='info'>Base Exchange via a HIP Relay</span><span>)</span></a>, the Initiator sends an I1 packet over the
               transport layer to the HIT of the Responder. The source address is one of the
               locators of the host. The locators belonging to the end-hosts are referred as "host candidates"
               in this document. 
</p>
<p> In step 2, the HIP Relay receives the I1 packet at port HIPPORT. If the destination
               HIT belongs to a registered Responder, the Relay processes the packet. Otherwise, the
               Relay MUST drop the packet silently. The Relay appends a RELAY_FROM parameter to the
               I1 packet which contains the transport source address and port of the I1 as observed
               by the Relay. The Relay protects the I1 packet with RELAY_HMAC as described in <a class='info' href='#RFC5204'>[RFC5204]<span> (</span><span class='info'>Laganier, J. and L. Eggert, &ldquo;Host Identity Protocol (HIP) Rendezvous Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a>, except that the parameter type is different. The
               Relay changes the source and destination ports and IP addresses of the packet to
               match the values the Responder used when registering to the Relay, i.e., the reverse
               of the R2 used in the registration. The Relay MUST recalculate the transport checksum
               and forward the packet to the Responder.
</p>
<p> In step 3, the Responder receives the I1 packet. The Responder processes it
               according to the rules in <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a>. In addition, the
               Responder validates the RELAY_HMAC according to <a class='info' href='#RFC5204'>[RFC5204]<span> (</span><span class='info'>Laganier, J. and L. Eggert, &ldquo;Host Identity Protocol (HIP) Rendezvous Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a> and
               silently drops the packet if the validation fails. The Responder replies with an R1
               packet to which it includes a RELAY_TO parameter. The RELAY_TO parameter MUST contain
               same information as the RELAY_FROM parameter, i.e., the Initiator's transport address and the nonce, but
               the type of the parameter is different. The RELAY_TO parameter is not integrity
               protected by the signature of the R1 to allow pre-created R1 packets at the
               Responder. 
</p>
<p> In step 4, the Relay receives the R1 packet. The Relay drops the packet silently if
               the source HIT belongs to an unregistered host. The Relay MAY verify the signature of
               the R1 packet and drop it if the signature is invalid. Otherwise, the Relay rewrites
               the source address and port, and changes the destination address and port to match
               RELAY_TO information. Finally, the Relay recalculates transport checksum and forwards the packet. 
</p>
<p> In step 5, the Initiator receives the R1 packet and
                processes it according to <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a>. It
                replies with an I2 packet that uses the destination
                transport address of R1 as the source address and
                port. The I2 contains a LOCATOR parameter that lists
                all the ICE candidates (ICE offer) of the Initiator.
                The candidates are encoded using the format defined in
                <a class='info' href='#sec:locator_format'>Section&nbsp;4.5<span> (</span><span class='info'>LOCATOR Parameter</span><span>)</span></a>. The I2 packet
                MUST also contain the NAT transform parameter with
                ICE-STUN-UDP or some other transform selected because
                otherwise the Relay may drop the I2 packet.
	    
</p>
<p> In step 6, the Relay receives the I2 packet. The relay appends a RELAY_FROM and a
               RELAY_HMAC to the I2 packet as explained in the second step. 
</p>
<p> In step 7, the Responder receives the I2 packet and processes it according to <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a>. It replies with a R2 packet and includes a RELAY_TO
               parameter as explained in step three. The R2 packet includes a LOCATOR parameter that lists all
               the ICE candidates (ICE answer) of the Responder. The RELAY_TO parameter is protected by the HMAC. 
</p>
<p> In step 8, the Relay processes the R2 as described in step four. The Relay forwards
               the packet to the Responder. 
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
ICE Connectivity Checks</h3>

<p>The Responder completes the base exchange with the R2
               packet through the Relay. When Initiator successfully
               receives and processes the R2, both hosts have
               transitioned to ESTABLISHED state. However, the
               destination address the Initiator and Responder used
               for delivering base exchange packets belonged to the
               Relay as indicated by the RELAY_FROM and RELAY_TO
               parameters. Therefore, the address of the Relay MUST
               not be used for sending ESP traffic unless it was
               listed as a TURN server in the offer/answer. Instead,
               the Initiator and Responder MUST start ICE connectivity tests
               after they have transitioned to ESTABLISHED state after
               the base exchange when they do not have valid locator pair for ESP traffic and the NAT transform parameter
               was negotiated successfully.
           
</p>
<p>The ICE connectivity checks are defined in
              <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>. Section
              <a class='info' href='#sec:con_checks'>Section&nbsp;4.2<span> (</span><span class='info'>Connectivity Checks</span><span>)</span></a> defines the details of
              the STUN control packets. As a result of the ICE
              connectivity checks, ICE nominates a single transport
              address pair to be used if an operational address could
              be found. The end-hosts MUST use this address pair for the
              ESP traffic.
           
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5"></a><h3>3.5.&nbsp;
NAT Keepalives</h3>

<p>To prevent NAT state from expiring, communicating
               end-hosts hosts send periodically keepalives to each
               other. NAT Relays MUST not send any keepalives. An
               end-host MUST send keepalives every 15 seconds to
               refresh the UDP port mapping at the NAT(s) when the
               control or data channel is idle. To implement failure
               tolerance, an end-host SHOULD have shorter keepalive
               period.
</p>
<p>The keepalives are STUN Binding Indications if the
               hosts have agreed on NAT_TRANSFORM during the base
               exchange, or HIP NOTIFY messages otherwise. A HIP Relay
               MUST not forward NOTIFY messages.
            
</p>
<p>The communicating hosts MUST send keepalives to each
               other using the transport locators exchanged in the
               base exchange when they are in ESTABLISHED state. Also,
               the Initiator MUST send a NOTIFY message to the Relay
               to refresh the NAT state alive on the path between the
               Initiator and Relay when the Initiator has not received any
               response to its I1 or I2 from the Responder in 15
               seconds. The Relay MUST not forward the NOTIFY
               messages.
            
</p>
<a name="sec:no_relay"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.6"></a><h3>3.6.&nbsp;
Base Exchange without ICE Connectivity Checks</h3>

<p> In certain network environments, the ICE connectivity checks can be
	      omitted to reduce initial connection set up latency because base
	      exchange acts an implicit connectivity test itself. There are three
	      assumptions about such as environments. First, the Responder should
	      have a long-term, fixed locator in the network. Second, the Responder
	      should not have a HIP Relay configured for itself. Third, the
	      Initiator can reach the Responder by simply UDP encapsulating HIP and
	      ESP packets to the host. Detecting and configuring this particular
	      scenario is prone to administrative failure unless carefully planned.
	    
</p>
<p>In such a scenario, the Initiator sends an I1 packet
	      over UDP to the Responder. The Responder replies with a
	      R1 packet that does not contain the NAT transform
	      parameter. The Initiator receives the R1 packet and
	      determines from the absence of the NAT transform and
	      RELAY_TO parameters that ICE connectivity checks can be
	      omitted.  Finally, the hosts can start to use the
	      locators from the concluding I2 and R2 packets of the
	      base exchange for ESP without ICE connectivity
	      checks.
</p>
<a name="sec:no_udp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.7"></a><h3>3.7.&nbsp;
Base Exchange without UDP Encapsulation</h3>

<p>The Initiator MAY also try to establish a base exchange
	       with the Responder without UDP encapsulation. In such a
	       case, the Initiator sends first an I1 packet without
	       UDP encapsulation to the Responder. After 100 ms, the
	       Initiator MUST then send an UDP-encapsulated I1
	       packet. For retransmissions, the procedure is repeated.
	    
</p>
<p>The I1 packet may arrive directly at the
               Responder. When the recipient is the Responder, the
               proceduces in <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a> are followed
               for the rest of the base exchange. The Initiator may
               receive multiple R1 messages from the Responder, but upon
               receiving a valid R1 without UDP encapsulation, the
               Initiator MUST ignore further R1 messages with UDP
               encapsulation encapsulation. The end-hosts do not
               trigger ICE connectivity checks after the base exchange
               since the UDP encapsulation was excluded.
</p>
<p>The packet may also arrive at a HIP-capable
               middlebox. When the middlebox is a HIP rendezvous
               server and the Responder has successfully registered to
               the rendezvous service, the middlebox follows
               rendezvous procedures in <a class='info' href='#RFC5204'>[RFC5204]<span> (</span><span class='info'>Laganier, J. and L. Eggert, &ldquo;Host Identity Protocol (HIP) Rendezvous Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a>. If
               the middlebox is a HIP Relay server, it drops the I1
               packet silently.
</p>
<a name="sec:control_no_relay"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.8"></a><h3>3.8.&nbsp;
Sending Control Messages using the Data Plane</h3>

<p>The end-hosts MAY send control messages directly to each
            other using the transport address pair established for
            data channel without sending the control packets through the
            Relay. When a host does not get acknowledgements
            e.g. to an UPDATE or CLOSE message after a timeout based on
            local policies, the host SHOULD resend the packet through
            the Relay. This optimization requires further experimentation.
	 
</p>
<a name="sec:format"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Packet Formats</h3>

<p> The following subsections define the parameter and packet encodings. All values MUST be
            in network byte order. 
</p>
<a name="sec:udphip"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
HIP Control Packets</h3>
<br /><hr class="insert" />
<a name="fig:udphip"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        Source Port            |      Destination Port         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Length              |           Checksum            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       32 bits of zeroes                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                    HIP Header and Parameters                  ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: Format for UDP-encapsulated HIP Control Packets&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
               HIP control packets are encapsulated in UDP packets as defined in Section 2.2 of
               <a class='info' href='#RFC3948'>[RFC3948]<span> (</span><span class='info'>Huttunen, A., Swander, B., Volpe, V., DiBurro, L., and M. Stenberg, &ldquo;UDP Encapsulation of IPsec ESP Packets,&rdquo; January&nbsp;2005.</span><span>)</span></a>, "rules for encapsulating IKE messages" except for a different port number.
               <a class='info' href='#fig:udphip'>Figure&nbsp;4<span> (</span><span class='info'>Format for UDP-encapsulated HIP Control Packets</span><span>)</span></a> illustrates the encapsulation.
               The UDP header is followed by 32 zero bits that can be used to differentiate HIP control
               packets from ESP packets. The HIP header and parameters follow the conventions of
                  <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a> with the exception that the HIP header checksum
               MUST be zero. The HIP header checksum is zero for two reasons. First, the UDP header
               contains already a checksum. Second, the checksum definition in <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a> includes the IP addresses in the checksum
               calculation. The NATs unaware of HIP cannot recompute the HIP checksum after changing
               IP addresses. 
</p>
<p> A HIP Relay or a Responder without a relay MUST listen at transport port HIPPORT for
               incoming UDP-encapsulated HIP control packets. 
</p>
<a name="sec:con_checks"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Connectivity Checks</h3>

<p>The connectivity checks are performed using STUN Binding
            Requests. This section describes the details of the
            parameters in the STUN messages.
</p>
<p>The username is formed from the username fragments as
            defined in section 7.1.1.3 of
            <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>. The requests MUST
            use STUN short term credentials with HITs of the Initiator
            and Responder concatenated as a username fragment. The
            HITs are concatenated according to the Sort(HIT-I, HIT-R)
            algorithm defined in <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a> section
            6.5. The HIT username fragment MUST contain a UTF-8
            <a class='info' href='#RFC3629'>[RFC3629]<span> (</span><span class='info'>Yergeau, F., &ldquo;UTF-8, a transformation format of ISO 10646,&rdquo; November&nbsp;2003.</span><span>)</span></a> encoded sequence and MUST have
            been processed using SASLPrep <a class='info' href='#RFC4013'>[RFC4013]<span> (</span><span class='info'>Zeilenga, K., &ldquo;SASLprep: Stringprep Profile for User Names and Passwords,&rdquo; February&nbsp;2005.</span><span>)</span></a> as
            defined section 15.3 of
            <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>. The
            concatenated HIT pair MUST have a fixed size that is
            accomplished by including the leading zeroes for the HITs.
	 
</p>
<p>Drawing of HIP keys is defined in <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a> section 6.5 and drawing of ESP keys in
            <a class='info' href='#RFC5202'>[RFC5202]<span> (</span><span class='info'>Jokela, P., Moskowitz, R., and P. Nikander, &ldquo;Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP),&rdquo; April&nbsp;2008.</span><span>)</span></a> section 7.  Correspondingly, the
            hosts MUST draw symmetric keys for STUN according to
            <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a> section 6.5. The hosts draw the
            STUN keys after HIP keys, or after ESP keys if ESP
            transform was successfully negotiated in the base exchange.  The hosts
            draw two keys which they MUST use to generate the STUN
            password. As the STUN password is the same at both ends,
            the two drawn keys MUST be concatenated with the key for
            the greater HIT first. Section 15.4 of
            <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a> describes how
            hosts use the password for message integrity of STUN
            messages.
         
</p>
<p>The connectivity checks MUST contain
            PRIORITY attribute. They MAY contain USE-CANDIDATE
            attributes as defined in section 7.1.1.1 of
            <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>.
</p>
<p>The Initiator is always in the controller role during a
            base exchange. Hence, the ICE-CONTROLLED and
            ICE-CONTROLLING attributes are not needed and SHOULD NOT
            be used. When two hosts are initiating to each other
            simultaneously, HIP state machine detects it and assigns
            the host with the larger HIT as the Responder as explained
            in sections 4.4.2 and and 6.7 in <a class='info' href='#RFC5201'>[RFC5201]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a>.
	 
</p>
<a name="sec:keep-alive"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Keepalives</h3>

<p>The keepalives for HIP associations agreed that are NAT_TRANSFORM capable are STUN Binding Indications, as defined in
               <a class='info' href='#I-D.ietf-behave-rfc3489bis'>[I&#8209;D.ietf&#8209;behave&#8209;rfc3489bis]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for (NAT) (STUN),&rdquo; July&nbsp;2008.</span><span>)</span></a>. The source and destination ports are
               in the UDP header are the same as used for HIP (50500). However, in contrast to
               the UDP encapsulated HIP header, there non-ESP-marker between the UDP header and the
               STUN header is excluded. Keepalives MUST contain the FINGERPRINT STUN attribute but SHOULD NOT 
               contain any other STUN attributes and SHOULD NOT utilize any authentication mechanism. 
               STUN messages are demultiplexed from ESP and HIP control messages using the STUN markers,
               such as the magic cookie value and the FINGERPRINT attribute.
               
               
            
</p>
<p>
              Keepalives for aHIP associations that are not NAT_TRANSFORM capable are HIP control messages
              that have NOTIFY as the packet type. The NOTIFY messages do not contain any
              parameters.
            
</p>
<a name="sec:rel-reg-params"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Relay and Registration Parameters</h3>
<br /><hr class="insert" />
<a name="fig:reg_from"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Type              |             Length            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                            Address                            |
|                                                               |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Port              |           Transport           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Type        [ TBD by IANA:
              REG_FROM: (64010 = 2^16 - 2^11 + 2^9 + 10) ]

Length      20
Address     An IPv6 address or an IPv4 address in "IPv4-compatible
            IPv6 address" format
Port        Transport port number; zero when plain IP is used
Transport   Transport protocol type; zero for UDP
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: Format for REG_FROM parameter&nbsp;</b></font><br /></td></tr></table><hr class="insert" />
<br /><hr class="insert" />
<a name="fig:relay"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Type              |             Length            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                            Address                            |
|                                                               |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Port              |           Transport           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             Nonce                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Type        [ TBD by IANA:
              Critical parameters:
              RELAY_FROM: (63998 = 2^16 - 2^11 + 2^9 - 2)
              RELAY_TO:   (64002 = 2^16 - 2^11 + 2^9 + 2)

Length      24
Address     An IPv6 address or an IPv4 address in "IPv4-compatible
            IPv6 address" format
Port        Transport port number; zero when plain IP is used
Transport   Transport protocol type; zero for UDP
Nonce       A nonce assigned by the Relay server.
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: Format for the RELAY_FROM and RELAY_TO parameters&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p> Format for the REG_FROM parameter is shown in <a class='info' href='#fig:reg_from'>Figure&nbsp;5<span> (</span><span class='info'>Format for REG_FROM parameter</span><span>)</span></a>, and RELAY_FROM and RELAY_TO in <a class='info' href='#fig:relay'>Figure&nbsp;6<span> (</span><span class='info'>Format for the RELAY_FROM and RELAY_TO parameters</span><span>)</span></a>. Parameters are identical except for the type and nonce fields. 
</p>
<p>The nonce field is an experimental field for the
	       RELAY_FROM and RELAY_TO parameters. It allows the Relay
	       to have constant state towards the Initiators without
	       allowing the Responder to send R1 or R2 packets to
	       arbitrary hosts through the Relay.
</p>
<a name="sec:locator_format"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
LOCATOR Parameter</h3>

<p> The generic LOCATOR parameter format is the same as in <a class='info' href='#RFC5206'>[RFC5206]<span> (</span><span class='info'>Nikander, P., Henderson, T., Vogt, C., and J. Arkko, &ldquo;End-Host Mobility and Multihoming with the Host Identity Protocol,&rdquo; April&nbsp;2008.</span><span>)</span></a>. However, presenting ICE candidates requires a new
               locator type. The generic and NAT traversal specific locator parameters are illustrated in
                  <a class='info' href='#fig:locator'>Figure&nbsp;7<span> (</span><span class='info'>LOCATOR parameter</span><span>)</span></a>. 
</p><br /><hr class="insert" />
<a name="fig:locator"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Type              |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Traffic Type  |  Locator Type | Locator Length|  Reserved   |P|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Locator Lifetime                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            Locator                            |
|                                                               |
|                                                               |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
.                                                               .
.                                                               .
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Traffic Type  |  Loc Type = 2 | Locator Length|  Reserved   |P|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Locator Lifetime                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Transport Port            |  Transp. Proto|     Kind      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           Priority                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                              SPI                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            Locator                            |
|                                                               |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;7: LOCATOR parameter&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p> The individual fields in the LOCATOR parameter are described in <a class='info' href='#tbl:locator'>Table&nbsp;2<span> (</span><span class='info'>Fields of the LOCATOR parameter</span><span>)</span></a>. 
</p><br /><hr class="insert" />
<a name="tbl:locator"></a>
<table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left"><col align="left">
<tr><th align="left">Field</th><th align="left">Value(s)</th><th align="left">Purpose</th></tr>
<tr>
<td align="left">Type</td>
<td align="left">193</td>
<td align="left">Parameter type</td>
</tr>
<tr>
<td align="left">Length</td>
<td align="left">Variable</td>
<td align="left">Length in octets, excluding Type and Length fields and padding</td>
</tr>
<tr>
<td align="left">Traffic Type</td>
<td align="left">0-2</td>
<td align="left">Is the locator for HIP signaling (1), for ESP (2), or for both (0)</td>
</tr>
<tr>
<td align="left">Locator Type</td>
<td align="left">2</td>
<td align="left">"Transport address" locator type</td>
</tr>
<tr>
<td align="left">Locator Length</td>
<td align="left">7</td>
<td align="left">Length of the Locator field in 4-octet units</td>
</tr>
<tr>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">Reserved for future extensions</td>
</tr>
<tr>
<td align="left">Preferred (P) bit</td>
<td align="left">0</td>
<td align="left">Not used for transport address locators; MUST be ignored by the receiver.</td>
</tr>
<tr>
<td align="left">Locator Lifetime</td>
<td align="left">Variable</td>
<td align="left">Locator lifetime in seconds</td>
</tr>
<tr>
<td align="left">Transport Port</td>
<td align="left">Variable</td>
<td align="left">Transport layer port number</td>
</tr>
<tr>
<td align="left">Transport Protocol</td>
<td align="left">0</td>
<td align="left">0 for UDP</td>
</tr>
<tr>
<td align="left">Kind</td>
<td align="left">Variable</td>
<td align="left">0 for host, 1 for server reflexive, 2 for peer reflexive or 3 for relayed address</td>
</tr>
<tr>
<td align="left">Priority</td>
<td align="left">Variable</td>
<td align="left">Locator's priority as described in <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a></td>
</tr>
<tr>
<td align="left">SPI</td>
<td align="left">Variable</td>
<td align="left">SPI value which the host expects to see in incoming ESP packets that use this
                  locator</td>
</tr>
<tr>
<td align="left">Locator</td>
<td align="left">Variable</td>
<td align="left">IPv6 address or an "IPv4-compatible IPv6 address" format IPv4 address <a class='info' href='#RFC3513'>[RFC3513]<span> (</span><span class='info'>Hinden, R. and S. Deering, &ldquo;Internet Protocol Version 6 (IPv6) Addressing Architecture,&rdquo; April&nbsp;2003.</span><span>)</span></a>, obfuscated by XORing it with the owner's HIT</td>
</tr>
</table>
<br clear="all" />
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Table 2: Fields of the LOCATOR parameter&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="sec:relay-hmac"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
RELAY_HMAC</h3>

<p> The RELAY_HMAC parameter value has the TLV type 65520 (2^16 - 2^5 + 2^4). It has the
               same semantics as RVS_HMAC <a class='info' href='#RFC5204'>[RFC5204]<span> (</span><span class='info'>Laganier, J. and L. Eggert, &ldquo;Host Identity Protocol (HIP) Rendezvous Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a>. 
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7"></a><h3>4.7.&nbsp;
Registration Types</h3>

<p> The REG_INFO, REQ_REQ, REG_RESP and REG_FAILED parameters contain values for HIP
               Relay registration. The value for RELAY_UDP_HIP is 2. The value for RELAY_UDP_ESP is
               3. 
</p>
<a name="sec:udpesp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.8"></a><h3>4.8.&nbsp;
ESP Data Packets</h3>

<p>
               <a class='info' href='#RFC3948'>[RFC3948]<span> (</span><span class='info'>Huttunen, A., Swander, B., Volpe, V., DiBurro, L., and M. Stenberg, &ldquo;UDP Encapsulation of IPsec ESP Packets,&rdquo; January&nbsp;2005.</span><span>)</span></a> describes UDP encapsulation of
               the IPsec ESP transport and tunnel mode. On the wire,
               the HIP ESP packets do not differ from the transport
               mode ESP and thus the encapsulation of the HIP ESP
               packets is same as the UDP encapsulation transport mode
               ESP. However, the (semantic) difference to BEET mode
               ESP packets used by HIP is that IP header is not used
               in BEET integrity protection calculation.
</p>
<p> During the HIP base exchange, the two peers exchange parameters that enable them to
               define a pair of IPsec ESP security associations (SAs) as described in <a class='info' href='#RFC5202'>[RFC5202]<span> (</span><span class='info'>Jokela, P., Moskowitz, R., and P. Nikander, &ldquo;Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP),&rdquo; April&nbsp;2008.</span><span>)</span></a>. When two peers perform a UDP-encapsulated base
               exchange, they MUST define a pair of IPsec SAs that produces UDP-encapsulated ESP
               data traffic. 
</p>
<p> The management of encryption/authentication protocols and SPIs
                is defined in <a class='info' href='#RFC5202'>[RFC5202]<span> (</span><span class='info'>Jokela, P., Moskowitz, R., and P. Nikander, &ldquo;Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP),&rdquo; April&nbsp;2008.</span><span>)</span></a>. The UDP encapsulation format
                and processing of HIP ESP traffic is described in Section 6.1 of <a class='info' href='#RFC5202'>[RFC5202]<span> (</span><span class='info'>Jokela, P., Moskowitz, R., and P. Nikander, &ldquo;Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP),&rdquo; April&nbsp;2008.</span><span>)</span></a>. 
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Security Considerations</h3>

<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Privacy Considerations</h3>

<p> The locators are in XORed format in plain text in favor of inspection at
               HIP-aware middleboxes in the future. The current draft does not specify encrypted
               versions of LOCATORs even though it could be beneficial for privacy reasons. 
</p>
<p> It is possible that an Initiator or Responder may not want to reveal all of its
               locators to its peer. For example, a host may not want to reveal the internal
               topology of the private address realm and it discards host addresses. Such behavior
               creates non-optimal paths when the hosts are located behind the same NAT. Especially,
               this could be a problem with a legacy NAT that does not support routing from the
               private address realm back to itself through the outer address of the NAT. This
               scenario is referred to as the hairpin problem <a class='info' href='#RFC5128'>[RFC5128]<span> (</span><span class='info'>Srisuresh, P., Ford, B., and D. Kegel, &ldquo;State of Peer-to-Peer (P2P) Communication across Network Address Translators (NATs),&rdquo; March&nbsp;2008.</span><span>)</span></a>. With such a legacy NAT, the only option left
               would be to use a relayed transport address from a TURN server.
</p>
<p>As a consequence, a host may support locator-based
               privacy by leaving out the reflexive candidates. However, the trade-off in using
               only host candidates can produce suboptimal paths
               that can congest the TURN server.
               The use of HIP Relays or TURN Relays can be useful for protection against
               Denial-of-Service attacks. If a Responder reveals only its HIP Relay addresses and Relayed transport candidates
               to Initiators, the Initiators can only attack the relays that does
               not prevent the Responder from initiating new outgoing connections if a path around
               the relay exists. 
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Opportunistic Mode</h3>

<p> A HIP Relay server should have one address per Relay Client when a HIP Relay is serving
               more than one Relay Clients and supports opportunistic mode. Otherwise,
               it cannot be guaranteed that the Relay can deliver the I1 packet to the intended
               recipient. 
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Base Exchange Replay Protection for HIP Relay Server</h3>

<p>On certain scenarios, it is possible that an attacker,
	     or two attackers, can replay an earlier base exchange
	     through a Relay server by masquerading as the original
	     Initiator and Responder. The attack does not require the
	     attacker(s) to compromise the private key(s) of the attacked
	     host(s). However, Responder has to be disconnected from
	     the Relay in order to masquarade successfully as the Responder.
           
</p>
<p>The Relay can protect itself against Replay attacks by
              involving in the base exchange by introducing nonces
              that the end-hosts (Initiator and Responder) have to
              sign. The Relay MAY add ECHO_REQUEST_M parameters to the R1
              and I2 messages as described in
              <a class='info' href='#I-D.heer-hip-middle-auth'>[I&#8209;D.heer&#8209;hip&#8209;middle&#8209;auth]<span> (</span><span class='info'>Heer, T., Wehrle, K., and M. Komu, &ldquo;End-Host Authentication for HIP Middleboxes,&rdquo; February&nbsp;2009.</span><span>)</span></a> and drops the I2
              or R2 messages if the corresponding ECHO_RESPONSE_M
              parameters are not present.
           
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
Demuxing Different HIP Associations</h3>

<p> Section 5.1 of <a class='info' href='#RFC3948'>[RFC3948]<span> (</span><span class='info'>Huttunen, A., Swander, B., Volpe, V., DiBurro, L., and M. Stenberg, &ldquo;UDP Encapsulation of IPsec ESP Packets,&rdquo; January&nbsp;2005.</span><span>)</span></a> describes a security issue for the UDP
               encapsulation in the standard IP tunnel mode when two hosts behind different NATs
               have the same private IP address and initiate communication to the same Responder in
               the public Internet. The Responder cannot distinguish between two hosts, because
               security associations are based on the same inner IP addresses. 
</p>
<p> This issue does not exist with the UDP encapsulation of HIP ESP transport format
               because the Responder use HITs to distinguish between different Initiators. 
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
IANA Considerations</h3>

<p> This section is to be interpreted according to <a class='info' href='#RFC2434'>[RFC2434]<span> (</span><span class='info'>Narten, T. and H. Alvestrand, &ldquo;Guidelines for Writing an IANA Considerations Section in RFCs,&rdquo; October&nbsp;1998.</span><span>)</span></a>. 
</p>
<p> This draft currently uses a UDP port in the "Dynamic and/or Private Port" and HIPPORT.
            Upon publication of this document, IANA is requested to register a UDP port and the RFC
            editor is requested to change all occurrences of port HIPPORT to the port IANA has
            registered. The HIPPORT number 50500 should be used for initial experimentation. 
</p>
<p> This document updates the IANA Registry for HIP Parameter Types by assigning new HIP
            Parameter Type values for the new HIP Parameters: RELAY_FROM, RELAY_TO and REG_FROM
            (defined in <a class='info' href='#sec:rel-reg-params'>Section&nbsp;4.4<span> (</span><span class='info'>Relay and Registration Parameters</span><span>)</span></a>) and RELAY_HMAC (defined in 
            <a class='info' href='#sec:relay-hmac'>Section&nbsp;4.6<span> (</span><span class='info'>RELAY_HMAC</span><span>)</span></a>). NAT_TRANSFORM is also a new parameter.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Contributors</h3>

<p>This draft is a product of a design team which also included Marcelo Bagnulo and Jan Mel&eacute;n who
           both have made major contributions to this document.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Acknowledgments</h3>

<p>Thanks for Jonathan Rosenberg and the rest of the MMUSIC WG folks for the excellent
            work on ICE. In addition, the authors would like to thank Andrei Gurtov, Simon Schuetz, 
            Martin Stiemerling, Lars Eggert, Vivien Schmitt, Abhinav Pathak for their contributions and
            Tobias Heer, Teemu Koponen, Juhana Mattila, Jeffrey M. Ahrenholz, Thomas Henderson, Kristian Slavov,
            Janne Lindqvist, Pekka Nikander, Lauri Silvennoinen, Jukka Ylitalo, Juha Heinanen,
            Joakim Koskela, Samu Varjonen, Dan Wing and Jani Hautakorpi for their comments on this document. 
</p>
<p>Miika Komu is working in the Networking Research group at Helsinki Institute for
            Information Technology (HIIT). The InfraHIP project was funded by Tekes, Telia-Sonera,
            Elisa, Nokia, the Finnish Defence Forces, and Ericsson and Birdstep. 
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-behave-rfc3489bis">[I-D.ietf-behave-rfc3489bis]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-rfc3489bis-18.txt">Session Traversal Utilities for (NAT) (STUN)</a>,&rdquo; draft-ietf-behave-rfc3489bis-18 (work in progress), July&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-rfc3489bis-18.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-behave-turn">[I-D.ietf-behave-turn]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-turn-16.txt">Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)</a>,&rdquo; draft-ietf-behave-turn-16 (work in progress), July&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-turn-16.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-mmusic-ice">[I-D.ietf-mmusic-ice]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>,&rdquo; draft-ietf-mmusic-ice-19 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.rosenberg-mmusic-ice-nonsip">[I-D.rosenberg-mmusic-ice-nonsip]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-mmusic-ice-nonsip-01.txt">Guidelines for Usage of Interactive Connectivity Establishment (ICE) by non  Session Initiation Protocol (SIP) Protocols</a>,&rdquo; draft-rosenberg-mmusic-ice-nonsip-01 (work in progress), July&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-mmusic-ice-nonsip-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2434">[RFC2434]</a></td>
<td class="author-text"><a href="mailto:narten@raleigh.ibm.com">Narten, T.</a> and <a href="mailto:Harald@Alvestrand.no">H. Alvestrand</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2434">Guidelines for Writing an IANA Considerations Section in RFCs</a>,&rdquo; BCP&nbsp;26, RFC&nbsp;2434, October&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2434.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2434.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2434.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3513">[RFC3513]</a></td>
<td class="author-text">Hinden, R. and S. Deering, &ldquo;<a href="http://tools.ietf.org/html/rfc3513">Internet Protocol Version 6 (IPv6) Addressing Architecture</a>,&rdquo; RFC&nbsp;3513, April&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3513.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3629">[RFC3629]</a></td>
<td class="author-text">Yergeau, F., &ldquo;<a href="http://tools.ietf.org/html/rfc3629">UTF-8, a transformation format of ISO 10646</a>,&rdquo; STD&nbsp;63, RFC&nbsp;3629, November&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3629.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4013">[RFC4013]</a></td>
<td class="author-text">Zeilenga, K., &ldquo;<a href="http://tools.ietf.org/html/rfc4013">SASLprep: Stringprep Profile for User Names and Passwords</a>,&rdquo; RFC&nbsp;4013, February&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4013.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4423">[RFC4423]</a></td>
<td class="author-text">Moskowitz, R. and P. Nikander, &ldquo;<a href="http://tools.ietf.org/html/rfc4423">Host Identity Protocol (HIP) Architecture</a>,&rdquo; RFC&nbsp;4423, May&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4423.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5201">[RFC5201]</a></td>
<td class="author-text">Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;<a href="http://tools.ietf.org/html/rfc5201">Host Identity Protocol</a>,&rdquo; RFC&nbsp;5201, April&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5201.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5202">[RFC5202]</a></td>
<td class="author-text">Jokela, P., Moskowitz, R., and P. Nikander, &ldquo;<a href="http://tools.ietf.org/html/rfc5202">Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP)</a>,&rdquo; RFC&nbsp;5202, April&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5202.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5203">[RFC5203]</a></td>
<td class="author-text">Laganier, J., Koponen, T., and L. Eggert, &ldquo;<a href="http://tools.ietf.org/html/rfc5203">Host Identity Protocol (HIP) Registration Extension</a>,&rdquo; RFC&nbsp;5203, April&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5203.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5204">[RFC5204]</a></td>
<td class="author-text">Laganier, J. and L. Eggert, &ldquo;<a href="http://tools.ietf.org/html/rfc5204">Host Identity Protocol (HIP) Rendezvous Extension</a>,&rdquo; RFC&nbsp;5204, April&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5204.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5206">[RFC5206]</a></td>
<td class="author-text">Nikander, P., Henderson, T., Vogt, C., and J. Arkko, &ldquo;<a href="http://tools.ietf.org/html/rfc5206">End-Host Mobility and Multihoming with the Host Identity Protocol</a>,&rdquo; RFC&nbsp;5206, April&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5206.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.heer-hip-middle-auth">[I-D.heer-hip-middle-auth]</a></td>
<td class="author-text">Heer, T., Wehrle, K., and M. Komu, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-heer-hip-middle-auth-02.txt">End-Host Authentication for HIP Middleboxes</a>,&rdquo; draft-heer-hip-middle-auth-02 (work in progress), February&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-heer-hip-middle-auth-02.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.irtf-hiprg-nat">[I-D.irtf-hiprg-nat]</a></td>
<td class="author-text">Stiemerling, M., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-irtf-hiprg-nat-04.txt">NAT and Firewall Traversal Issues of Host Identity Protocol (HIP)  Communication</a>,&rdquo; draft-irtf-hiprg-nat-04 (work in progress), March&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-irtf-hiprg-nat-04.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3948">[RFC3948]</a></td>
<td class="author-text">Huttunen, A., Swander, B., Volpe, V., DiBurro, L., and M. Stenberg, &ldquo;<a href="http://tools.ietf.org/html/rfc3948">UDP Encapsulation of IPsec ESP Packets</a>,&rdquo; RFC&nbsp;3948, January&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc3948.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4787">[RFC4787]</a></td>
<td class="author-text">Audet, F. and C. Jennings, &ldquo;<a href="http://tools.ietf.org/html/rfc4787">Network Address Translation (NAT) Behavioral Requirements for Unicast UDP</a>,&rdquo; BCP&nbsp;127, RFC&nbsp;4787, January&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4787.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5128">[RFC5128]</a></td>
<td class="author-text">Srisuresh, P., Ford, B., and D. Kegel, &ldquo;<a href="http://tools.ietf.org/html/rfc5128">State of Peer-to-Peer (P2P) Communication across Network Address Translators (NATs)</a>,&rdquo; RFC&nbsp;5128, March&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5128.txt">TXT</a>).</td></tr>
</table>

<a name="sec:interoperability"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
IPv4-IPv6 Interoperability</h3>

<p>
Currently Relay Client and Server do not have to run any ICE connectivity
tests as described in <a class='info' href='#sec:no_relay'>Section&nbsp;3.6<span> (</span><span class='info'>Base Exchange without ICE Connectivity Checks</span><span>)</span></a>.  However, it could
be useful for IPv4-IPv6 interoperability when the Relay Server actually
includes both the NAT transform parameter and multiple locators in R2.
The interoperability benefit is that the Relay could support IPv4-based
Initiators and IPv6-based Responders by converting the network headers and
recalculating UDP checksums.

</p>
<p>
Such an approach is underspecified in this document currently. It is not yet
recommended because it may consume resources at the Relay and requires
also similar conversion support at the TURN relay for data packets.

</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
Base Exchange through a Rendezvous Server</h3>

<p>
This section describes handling for a scenario where Initiator looks
up the information of the Responder from DNS and discovers a RVS
record <a class='info' href='#RFC5204'>[RFC5204]<span> (</span><span class='info'>Laganier, J. and L. Eggert, &ldquo;Host Identity Protocol (HIP) Rendezvous Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a>. In such a case, the
Initiator uses its own HIP Relay to forward HIP traffic to the Rendezvous
server. The Initiator will send the I1 message using the its HIP Relay server
which will then forward it to the RVS server of the responder. The responder
will send the R1 packet directly to the Initiator's HIP Relay server and the
following I2 and R2 packets are also sent directly using the Relay.

</p>
<p>
In case the Initiator is not able to distinguish which records are RVS 
address records and which are Responders address records, then the Initiator 
SHOULD first try to contact the Responder directly and if none of the 
addresses is reachable it MAY try out them using its own HIP Relay as described 
in the above.

</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.C"></a><h3>Appendix C.&nbsp;
Document Revision History</h3>

<p>To be removed upon publication
</p><table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left" width="85%">
<tr><th align="left">Revision</th><th align="left">Comments</th></tr>
<tr>
<td align="left">draft-ietf-nat-traversal-00</td>
<td align="left">Initial version.</td>
</tr>
<tr>
<td align="left">draft-ietf-nat-traversal-01</td>
<td align="left">Draft based on RVS.</td>
</tr>
<tr>
<td align="left">draft-ietf-nat-traversal-02</td>
<td align="left">Draft based on Relay proxies and ICE concepts.</td>
</tr>
<tr>
<td align="left">draft-ietf-nat-traversal-03</td>
<td align="left">Draft based on STUN/ICE formats.</td>
</tr>
<tr>
<td align="left">draft-ietf-nat-traversal-04</td>
<td align="left">Issues 25-27,29-36</td>
</tr>
</table>
<br clear="all" />

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Miika Komu</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Helsinki Institute for Information Technology</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Metsanneidonkuja 4</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Espoo</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358503841531</td></tr>
<tr><td class="author" align="right">Fax:&nbsp;</td>
<td class="author-text">+35896949768</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:miika@iki.fi">miika@iki.fi</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.hiit.fi/">http://www.hiit.fi/</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Thomas Henderson</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">The Boeing Company</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.O. Box 3707</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Seattle, WA</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:thomas.r.henderson@boeing.com">thomas.r.henderson@boeing.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Philip Matthews</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">(Unaffiliated)</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:philip_matthews@magma.ca">philip_matthews@magma.ca</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hannes Tschofenig</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nokia Siemens Networks</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Linnoitustie 6</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Espoo  02600</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 (50) 4871445</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Hannes.Tschofenig@gmx.net">Hannes.Tschofenig@gmx.net</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.tschofenig.com">http://www.tschofenig.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ari Ker&auml;nen (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ericsson Research Nomadiclab</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hirsalantie 11</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">02420 Jorvas</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 9 2991</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ari.keranen@ericsson.com">ari.keranen@ericsson.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
