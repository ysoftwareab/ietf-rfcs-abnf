<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Revealing hosts sharing an IP address using TCP option</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology">
<link href="#rfc.section.3" rel="Chapter" title="3 Description">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Operation of Address Sharing Device">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Operation of the TCP Server">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Reusing the USER_HINT value">
<link href="#rfc.section.4" rel="Chapter" title="4 USER_HINT Option Format">
<link href="#rfc.section.5" rel="Chapter" title="5 Interaction with other TCP Options">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Option Space">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Multipath TCP (MPTCP)">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 Authentication Option (TCP-AO)">
<link href="#rfc.section.6" rel="Chapter" title="6 Interaction with TCP SYN Cookies">
<link href="#rfc.section.7" rel="Chapter" title="7 Security Considerations">
<link href="#rfc.section.8" rel="Chapter" title="8 Acknowledgements">
<link href="#rfc.section.9" rel="Chapter" title="9 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="10 References">
<link href="#rfc.references.1" rel="Chapter" title="10.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="10.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Change History">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 Changes from draft-wing-nat-reveal-option-01 to -02">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="When an IP address is shared among several subscribers -- with a NAT or with an application-level proxy -- it is impossible for the server to differentiate between different clients. Such differentiation is valuable in several scenarios. This memo describes a technique to differentiate TCP clients sharing an IP address. The proposed method uses a TCP option, which avoids altering the application-level payload and works well with SSL-protected connections." />
  <meta name="description" content="When an IP address is shared among several subscribers -- with a NAT or with an application-level proxy -- it is impossible for the server to differentiate between different clients. Such differentiation is valuable in several scenarios. This memo describes a technique to differentiate TCP clients sharing an IP address. The proposed method uses a TCP option, which avoids altering the application-level payload and works well with SSL-protected connections." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">A. Yourtchenko</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">D. Wing</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">cisco</td>
</tr>
<tr>
<td class="left">Expires: December 18, 2011</td>
<td class="right">June 16, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Revealing hosts sharing an IP address using TCP option<br />
  <span class="filename">draft-wing-nat-reveal-option-02</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>When an IP address is shared among several subscribers -- with a NAT or with an application-level proxy -- it is impossible for the server to differentiate between different clients. Such differentiation is valuable in several scenarios. This memo describes a technique to differentiate TCP clients sharing an IP address. The proposed method uses a TCP option, which avoids altering the application-level payload and works well with SSL-protected connections.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on December 18, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Terminology</a>
</li>
<li>3.   <a href="#rfc.section.3">Description</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Operation of Address Sharing Device</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Operation of the TCP Server</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Reusing the USER_HINT value</a>
</li>
<li>4.   <a href="#rfc.section.4">USER_HINT Option Format</a>
</li>
<li>5.   <a href="#rfc.section.5">Interaction with other TCP Options</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Option Space</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Multipath TCP (MPTCP)</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">Authentication Option (TCP-AO)</a>
</li>
<li>6.   <a href="#rfc.section.6">Interaction with TCP SYN Cookies</a>
</li>
<li>7.   <a href="#rfc.section.7">Security Considerations</a>
</li>
<li>8.   <a href="#rfc.section.8">Acknowledgements</a>
</li>
<li>9.   <a href="#rfc.section.9">IANA Considerations</a>
</li>
<li>10.   <a href="#rfc.references">References</a>
</li>
<li>10.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>10.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Change History</a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">Changes from draft-wing-nat-reveal-option-01 to -02</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">When clients are allocated unique, publicly-routable IPv4 addresses, it is easy to associate certain characteristics with their IP address.  For example, if an IP address sends a lot of spam, that IP address is classified by many public (and private) system as "a spammer". Such classification can cause email or other traffic from that IP address to be blocked, rate limited, challenged with a captcha, or to receive other treatment. Reputation systems of various sorts exist for a wide variety of services on the Internet including IMAP, HTTP, ssh -- often these systems will slow down or interfere with normal login attempts when a dictionary attack is detected. An IP address can be added to a multitude of 'reputation' systems. Some of these systems are distributed across the Internet, some are shared amongst consenting parties, and some are operated by individual enterprises or individual hosts. Further discussion of the impacts of address sharing can be found in <a href="#I-D.ietf-intarea-shared-addressing-issues">[I-D.ietf-intarea-shared-addressing-issues]</a>.</p>
<p id="rfc.section.1.p.2">With the exhaustion of the IPv4 address space, IPv4 addresses will be shared on a large scale. This sharing will persist long after IPv6 is ubiquitous -- in fact, IPv4 address sharing will persist until all content and services on the Internet are available over IPv6. Once all content and services are available over IPv6, an Internet service provider will no longer need to provide access to the IPv4 Internet.</p>
<p id="rfc.section.1.p.3">Until that time, both legitimate users and attackers will share IPv4 addresses. This IP address sharing means legitimate users will share the reputation of attackers.</p>
<p id="rfc.section.1.p.4">This document describes a TCP option which can be added by an address sharing device such as a NAT or an application-level proxy. This TCP option allows a TCP server to differentiate between the TCP clients sharing that IP address.</p>
<p id="rfc.section.1.p.5">An analysis of other techniques is available in <a href="#I-D.boucadair-intarea-nat-reveal-analysis">[I-D.boucadair-intarea-nat-reveal-analysis]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Terminology</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">RFC2119</a> <cite title="NONE">[RFC2119]</cite>.</p>
<p id="rfc.section.2.p.2">subscriber: the client accessing an address sharing device, who is responsible for the actions of their device(s). This might be an individual handset (with mobile devices), a home Internet connection, a small-medium business Internet connection, a University dormitory room, an individual employee of a company, or the company itself.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Description</h1>
<p id="rfc.section.3.p.1">This proposal defines one new TCP option, USER_HINT, to contain the TCP client's 16 bit identifier. This value might be the lower 16 bits of their IPv4 address, their VLAN ID, VRF ID, subscriber ID, or similar.  The address sharing device (NAT, application proxy) would add the TCP option to the TCP SYN packet. TCP options are treated outside of the TCP sequence space, so no modifications of either sequence or acknowledgement numbers are needed.</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> Operation of Address Sharing Device</h1>
<p id="rfc.section.3.1.p.1">The address sharing device inserts the USER_HINT option into the TCP SYN, as depicted below.&#160; If the TCP SYN already has a USER_HINT option present, it is ignored and over-written with the new value.</p>
<div id="#rfc.figure.1"></div>
<pre>
TCP CLIENT    proxy, NAT64, NAT44              TCP SERVER
----------    -------------------              ----------
    |                 |                              |
    |---TCP SYN------&gt;|                              |
    |                 |---TCP SYN, USER_HINT=12345--&gt;|
   ...               ...                            ...
</pre>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> Operation of the TCP Server</h1>
<p id="rfc.section.3.2.p.1">The TCP server identifies the client by combining the source IPv4 address in the IP header with the data in the USER_HINT option.&#160; This can be implemented by modifying the TCP stack to make the USER_HINT data available to the application via an API (e.g., via a socket option).</p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> Reusing the USER_HINT value</h1>
<p id="rfc.section.3.3.p.1">The USER_HINT value is only 16 bits, so is obviously not globally unique. Even when combined with the publicly-routable IP address, the additional 16 bits are still not guaranteed to uniquely identify a particular subscriber. Out of necessity, the numbering space will be re-used by some address sharing devices, especially address sharing devices that are sharing many users on one IP address. As with today's IPv4 addresses which are assigned by an ISP, deterministically associating the IPv4 address (or IPv4 address and USER_HINT) with a particular subscriber requires more than simply completing a TCP 3-way handshake. For example, over a single day, an address sharing device might serve tens of thousands of different subscribers from the same shared IP address, and thus it will need to rotate through the 16 bit USER_HINT space several times during the day. When doing so, the USER_HINT MUST NOT be re-used more often than every 2 minutes (a number chosen out of thin air); if an address sharing device needs to re-use a USER_HINT value more often than that, it should use additional IP addresses (to reduce how quickly the USER_HINT space is consumed on each address) or simply send TCP SYNs without USER_HINT until 2 minutes have elapsed. This 2 minute delay is necessary to allow the reputation system on a TCP server to differentiate between subscribers. For most implementations, the port sharing ratio (rather than a timer) is sufficient to meet this requirement.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> USER_HINT Option Format</h1>
<p id="rfc.section.4.p.1">The USER_HINT option is always 4 bytes long, with 16 bits of USER_HINT data</p>
<div id="#rfc.figure.2"></div>
<pre>
+--------+--------+-----------------------+
|xxxxxxxx|00000100|    USER_HINT data     |
+--------+--------+-----------------------+
Kind=TBD  Length=4
</pre>
<p id="rfc.section.4.p.2">User Hint option data: 16 bits.</p>
<p id="rfc.section.4.p.3">If this option is present, it differentiates between active TCP hosts sharing the same IP address. This field MUST only be sent in the initial connection request (i.e., in segments with the SYN control bit set), or in the first ACK if the server's SYN contained the USER_HINT option.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> Interaction with other TCP Options</h1>
<p id="rfc.section.5.p.1">This section details how USER_HINT functions in conjunction with other TCP options.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Option Space</h1>
<p id="rfc.section.5.1.p.1">As discussed in <a href="#I-D.ietf-mptcp-multiaddressed">Appendix A of Multipath TCP (MPTCP)</a> <cite title="NONE">[I-D.ietf-mptcp-multiaddressed]</cite>, there is a maximum of 40 bytes for TCP options, and a typical SYN (with MSS, window scale, SACK permitted, and timestamp options) leaves 16 bytes spare (if the options are word-aligned) or 21 bytes spare (if the options are not word-aligned).</p>
<p id="rfc.section.5.1.p.2">Thus, the 4 byte option proposed in this memo would not cause a problem with a typical TCP SYN.</p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> Multipath TCP (MPTCP)</h1>
<p id="rfc.section.5.2.p.1">If the TCP client supports <a href="#I-D.ietf-mptcp-multiaddressed">Multipath TCP (MPTCP)</a> <cite title="NONE">[I-D.ietf-mptcp-multiaddressed]</cite>, the client will include the Multipath Capable or Multipath Join options to the TCP SYN. The Multipath Capable (MP_CAPABLE) option consumes 12 bytes, so a SYN containing all of these options would fully consume the 40 byte SYN option space. The Multipath Join (MP_JOIN) can consumes 12 or 16 bytes, but it is only used after successful early exchange containing the MP_CAPABLE option. Thus, there is reason to include USER_HINT if MP_JOIN is present in the TCP SYN -- if the MP_JOIN is not valid, it will be rejected by the server without creating any state on the server. Furthermore, if a client TCP is multi-homed, the client's TCP connections will probably go through different address sharing devices and thus have different externally-visible IP addresses and different USER_HINT values. Thus, it is NOT RECOMMENDED to include the USER_HINT option if the TCP SYN contains the MP_JOIN option.</p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> Authentication Option (TCP-AO)</h1>
<p id="rfc.section.5.3.p.1">The USER_HINT option is incompatible with the <a href="#RFC5925">Authentication Option (TCP-AO)</a> <cite title="NONE">[RFC5925]</cite>, because TCP-AO provides integrity protection of the TCP SYN, including TCP options.  However, TCP-AO is already incompatible with address sharing, because TCP-AO provides integrity protection of the source IP address.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> Interaction with TCP SYN Cookies</h1>
<p><a href="#RFC4987">TCP SYN cookies</a> <cite title="NONE">[RFC4987]</cite> are commonly deployed to mitigate TCP SYN attacks, which have some side effects. The USER_HINT information in the TCP SYN provides the TCP server with additional information it can use when deciding if this TCP connection attempt should be answered with a SYN cookie or should be answered normally. In the event the TCP server does not (or cannot) store the USER_HINT data, the USER_HINT data can be re-established on the TCP server when the client's first ACK is sent. There is a slight risk, however, that the client's first ACK, as seen by the middlebox, might contain data. If it does contain data, adding another 4 bytes to the packet could cause MTU to be exceeded.</p>
<div id="#rfc.figure.3"></div>
<pre>
TCP CLIENT         proxy, NAT64, NAT44               TCP SERVER
----------         -------------------               ----------
    |                      |                              |
    |---TCP SYN-----------&gt;|                              |
1.  |                      |---TCP SYN, USER_HINT=12345--&gt;|
2.  |                      |&lt;--TCP SYNACK, USER_HINT=8988-|
3.  |&lt;--TCP SYNACK---------|                              |

    :                      :                              :

4a. |---TCP ACK (no data)-&gt;|                              |
4a. |                      |---TCP ACK, USER_HINT=8988---&gt;|
    |                      |                              |

    :                      :                              :

4b. |---TCP ACK (data)----&gt;|                              |
4b. |                      |---TCP ACK-------------------&gt;|

</pre>
<p id="rfc.section.6.p.2">The procedure is as follows:</p>
<p></p>

<ol>
<li>Upon receiving a TCP SYN containing the USER_HINT option, the TCP server MAY respond to a SYN containing USER_HINT with an ACK packet containing its own USER_HINT value. (Note: this ACK response will typically have the SYN bit set.) If the server does not include the USER_HINT in its ACK packet, processing stops.</li>
<li>The middlebox, upon seeing the USER_HINT in the ACK, records those 2 bytes, which are used in a later step.</li>
<li>The middlebox strips the USER_HINT from the ACK, so it is not received by the TCP client. The middlebox sends the TCP ACK, without its USER_HINT option, to the TCP client.</li>
<li>The TCP client responds normally, generating a TCP ACK.</li>
<li>The middlebox receives an ACK from the TCP client. This ACK will either contain:<ol style="list-style-type: lower-alpha">
<li>no data, which causes the middlebox to add the USER_HINT value (from step 2) to the TCP ACK</li>
<li>data, which causes the middlebox to simply forward the ACK packet. This is done to avoid MTU problems between the middlebox and the TCP server.</li>
</ol>
</li>
</ol>
<p id="rfc.section.6.p.4">State is required in the address sharing device to perform the steps described in this section. This isn't a disaster with stateful address sharing (e.g., NAPT). However, in an A+P-like system (e.g., <a href="#I-D.ymbk-aplusp">[I-D.ymbk-aplusp]</a>, <a href="#I-D.despres-intarea-4rd">[I-D.despres-intarea-4rd]</a>), the CPE would need to perform the USER_HINT function, which introduces additional security considerations (not yet discussed in this version of the document).</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> Security Considerations</h1>
<p id="rfc.section.7.p.1">An attacker might use this functionality to appear as if IP address sharing is occurring, in the hopes that a naive server will allow additional attack traffic. TCP servers and applications SHOULD NOT assume the mere presence of the functionality described in this paper indicates there are other (benign) users sharing the same IP address.</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Acknowledgements</h1>
<p id="rfc.section.8.p.1">Thanks to Anantha Ramaiah for the discussion.&#160; Thanks to Senthil Sivakumar for his review.</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> IANA Considerations</h1>
<p id="rfc.section.9.p.1">Assign a new TCP option number (kind value), USER_HINT.</p>
<h1 id="rfc.references">
<a href="#rfc.references">10.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">10.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5925">[RFC5925]</b></td>
<td class="top">
<a>Touch, J.</a>, <a>Mankin, A.</a> and <a>R. Bonica</a>, "<a href="http://tools.ietf.org/html/rfc5925">The TCP Authentication Option</a>", RFC 5925, June 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">10.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC4987">[RFC4987]</b></td>
<td class="top">
<a>Eddy, W.</a>, "<a href="http://tools.ietf.org/html/rfc4987">TCP SYN Flooding Attacks and Common Mitigations</a>", RFC 4987, August 2007.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-intarea-shared-addressing-issues">[I-D.ietf-intarea-shared-addressing-issues]</b></td>
<td class="top">
<a>Ford, M</a>, <a>Boucadair, M</a>, <a>Durand, A</a>, <a>Levis, P</a> and <a>P Roberts</a>, "<a href="http://tools.ietf.org/html/draft-ietf-intarea-shared-addressing-issues-05">Issues with IP Address Sharing</a>", Internet-Draft draft-ietf-intarea-shared-addressing-issues-05, March 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.boucadair-intarea-nat-reveal-analysis">[I-D.boucadair-intarea-nat-reveal-analysis]</b></td>
<td class="top">
<a>Boucadair, M</a>, <a>Touch, J</a>, <a>Levis, P</a> and <a>R Penno</a>, "<a href="http://tools.ietf.org/html/draft-boucadair-intarea-nat-reveal-analysis-04">Analysis of Solution Candidates to Reveal a Host Identifier in Shared Address Deployments</a>", Internet-Draft draft-boucadair-intarea-nat-reveal-analysis-04, September 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-mptcp-multiaddressed">[I-D.ietf-mptcp-multiaddressed]</b></td>
<td class="top">
<a>Ford, A</a>, <a>Raiciu, C</a>, <a>Handley, M</a> and <a>O Bonaventure</a>, "<a href="http://tools.ietf.org/html/draft-ietf-mptcp-multiaddressed-04">TCP Extensions for Multipath Operation with Multiple Addresses</a>", Internet-Draft draft-ietf-mptcp-multiaddressed-04, July 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ymbk-aplusp">[I-D.ymbk-aplusp]</b></td>
<td class="top">
<a>Bush, R</a>, "<a href="http://tools.ietf.org/html/draft-ymbk-aplusp-10">The A+P Approach to the IPv4 Address Shortage</a>", Internet-Draft draft-ymbk-aplusp-10, May 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.despres-intarea-4rd">[I-D.despres-intarea-4rd]</b></td>
<td class="top">
<a>Despres, R</a>, <a>Matsushima, S</a>, <a>Murakami, T</a> and <a>O Troan</a>, "<a href="http://tools.ietf.org/html/draft-despres-intarea-4rd-01">IPv4 Residual Deployment across IPv6-Service networks (4rd) ISP-NAT's made optional</a>", Internet-Draft draft-despres-intarea-4rd-01, March 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> Change History</h1>
<p id="rfc.section.Appendix A.p.1">[Note to RFC Editor: Please remove this section prior to publication.]</p>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> Changes from draft-wing-nat-reveal-option-01 to -02</h1>
<p></p>

<ul>
<li>Limit option value to 16 bits (which becomes 32 bits total with the 8 bit option number and 8 bit length)</li>
<li>described how USER_HINT can work successfully with Multipath TCP (MPTCP)'s options.</li>
<li>Better described operation with TCP SYN Cookies.</li>
<li>Renamed option from CX-ID to USER_HINT</li>
</ul>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Andrew Yourtchenko</span> 
	  <span class="n hidden">
		<span class="family-name">Yourtchenko</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>6a de Kleetlaan</span>

	  <span class="vcardline">
		<span class="locality">Diegem</span>,  
		<span class="region"></span>
		<span class="code">1831</span>
	  </span>
	  <span class="country-name vcardline">BE</span>
	</span>
	<span class="vcardline">Phone: +32 2 704 5494</span>

<span class="vcardline">EMail: <a href="mailto:ayourtch@cisco.com">ayourtch@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Dan Wing</span> 
	  <span class="n hidden">
		<span class="family-name">Wing</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>170 West Tasman Drive</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region"></span>
		<span class="code">CA 95134</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:dwing@cisco.com">dwing@cisco.com</a></span>

  </address>
</div>

</body>
</html>