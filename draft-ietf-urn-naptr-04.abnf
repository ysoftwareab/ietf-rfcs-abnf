service_field = [ [protocol] *("+" rs)]
protocol      = ALPHA *31ALPHANUM
rs            = ALPHA *31ALPHANUM
subst_expr   = delim-char  ere  delim-char  repl  delim-char  *flags
delim-char   = "/" / "!" / ... (Any non-digit or non-flag character other
                 than backslash '\'. All occurances of a delim_char in a
                 subst_expr must be the same character.)
ere          = POSIX Extended Regular Expression (see [13], section 2.8.4)
repl         = dns_str /  backref / repl dns_str  / repl backref
dns_str      = 1*DNS_CHAR 
backref      = "\" 1POS_DIGIT
flags        = "i" 
DNS_CHAR     = "-" / "0" / ... / "9" / "a" / ... / "z" / "A" / ... / "Z"
POS_DIGIT    = "1" / "2" / ... / "9"  ; 0 is not an allowed backref value
rewrite_flag = false;
terminal = false;
records = lookup(type=NAPTR, key); // get all NAPTR RRs for 'key'

        discard any records with an unknown value in the "flags" field.
        sort NAPTR records by "order" field and "preference" field
            (with "order" being more significant than "preference").
n_naptrs = number of NAPTR records in response.
curr_order = records[0].order;
max_order = records[n_naptrs-1].order;
        
newkey = rewrite(URN, naptr[j].replacement, naptr[j].regexp);
max_order = naptr[j].order;
terminal = true;
services = naptr[j].services;
addnl = any SRV and/or A records returned as additional info
                     for naptr[j].
key = newkey;
rewriteflag = true;
srvs = lookup(type=SRV, key);
