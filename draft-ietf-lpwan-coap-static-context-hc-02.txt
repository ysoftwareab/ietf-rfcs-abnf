



lpwan Working Group                                          A. Minaburo
Internet-Draft                                                    Acklio
Intended status: Informational                                L. Toutain
Expires: March 10, 2018          Institut MINES TELECOM ; IMT Atlantique
                                                      September 06, 2017


        LPWAN Static Context Header Compression (SCHC) for CoAP
               draft-ietf-lpwan-coap-static-context-hc-02

Abstract

   This draft defines the way SCHC header compression can be applied to
   CoAP headers.  CoAP header structure differs from IPv6 and UDP
   protocols since the CoAP Header is flexible header with a variable
   number of options themself of a variable length.  Another important
   difference is the asymmetry in the header information used for
   request and response messages.  This draft takes into account the
   fact that a thing can play the role of a CoAP client, a CoAP client
   or both roles.

Status of This Memo

   This Internet-Draft is submitted in full conformance with the
   provisions of BCP 78 and BCP 79.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF).  Note that other groups may also distribute
   working documents as Internet-Drafts.  The list of current Internet-
   Drafts is at https://datatracker.ietf.org/drafts/current/.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   This Internet-Draft will expire on March 10, 2018.

Copyright Notice

   Copyright (c) 2017 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to BCP 78 and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (https://trustee.ietf.org/license-info) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect



Minaburo & Toutain       Expires March 10, 2018                 [Page 1]

Internet-Draft           LPWAN CoAP compression           September 2017


   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

Table of Contents

   1.  Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   2
   2.  CoAP Compressing  . . . . . . . . . . . . . . . . . . . . . .   3
   3.  Compression of CoAP header fields . . . . . . . . . . . . . .   4
     3.1.  CoAP version field (2 bits) . . . . . . . . . . . . . . .   4
     3.2.  CoAP type field . . . . . . . . . . . . . . . . . . . . .   5
     3.3.  CoAP token length field . . . . . . . . . . . . . . . . .   5
     3.4.  CoAP code field . . . . . . . . . . . . . . . . . . . . .   6
     3.5.  CoAP Message ID field . . . . . . . . . . . . . . . . . .   8
     3.6.  CoAP Token field  . . . . . . . . . . . . . . . . . . . .   9
   4.  CoAP options  . . . . . . . . . . . . . . . . . . . . . . . .   9
     4.1.  CoAP option Content-format field. . . . . . . . . . . . .   9
     4.2.  CoAP option Accept field  . . . . . . . . . . . . . . . .  10
     4.3.  CoAP option Max-Age field, CoAP option Uri-Host and Uri-
           Port fields . . . . . . . . . . . . . . . . . . . . . . .  11
   5.  CoAP option Uri-Path and Uri-Query fields . . . . . . . . . .  11
     5.1.  CoAP option Proxy-URI and Proxy-Scheme fields . . . . . .  12
     5.2.  CoAP option ETag, If-Match, If-None-Match, Location-Path
           and Location-Query fields . . . . . . . . . . . . . . . .  13
   6.  Other RFCs  . . . . . . . . . . . . . . . . . . . . . . . . .  13
     6.1.  Block . . . . . . . . . . . . . . . . . . . . . . . . . .  13
     6.2.  Observe . . . . . . . . . . . . . . . . . . . . . . . . .  13
     6.3.  No-Response . . . . . . . . . . . . . . . . . . . . . . .  13
   7.  Protocol analysis . . . . . . . . . . . . . . . . . . . . . .  13
   8.  Examples of CoAP header compression . . . . . . . . . . . . .  14
     8.1.  Mandatory header with CON message . . . . . . . . . . . .  14
     8.2.  Complete exchange . . . . . . . . . . . . . . . . . . . .  16
   9.  Normative References  . . . . . . . . . . . . . . . . . . . .  17
   Authors' Addresses  . . . . . . . . . . . . . . . . . . . . . . .  18

1.  Introduction

   CoAP [rfc7252] is an implementation of the REST architecture for
   constrained devices.  Gateway between CoAP and HTTP can be easily
   built since both protocols uses the same address space (URL), caching
   mechanisms and methods.

   Nevertheless, if limited, the size of a CoAP header may be too large
   for LPWAN constraints and some compression may be needed to reduce
   the header size.





Minaburo & Toutain       Expires March 10, 2018                 [Page 2]

Internet-Draft           LPWAN CoAP compression           September 2017


   [I-D.toutain-lpwan-ipv6-static-context-hc] defines a header
   compression mechanism for LPWAN network based on a static context.
   The context is said static since the element values composing the
   context are not learned during the packet exchanges but are
   previously defined.  The context(s) is(are) known by both ends before
   transmission.

   A context is composed of a set of rules (contexts) that are
   referenced by Rule IDs (identifiers).  A rule contains an ordered
   list of the header fields containing a field ID (FID) and its
   position when repeated, a direction indicator (DI) (upstream,
   downstream and bidirectional) and some associated Target Values (TV)
   which are expected in the message header.  A Matching Operator (MO)
   is associated to each header field description.  The rule is selected
   if all the MOs fit the TVs.  In that case, a Compression
   Decompression Function (CDF) associated to each field defines the
   link between the compressed and decompressed value for each of the
   header fields.

This document describes how the rules can be applied to CoAP flows. Compression of the
CoAP header may be done in conjunction with the above layers or independantly.

2.  CoAP Compressing

   CoAP differs from IPv6 and UDP protocols on the following
   aspects:

   o  IPv6 and UDP are symmetrical protocols.  The same fields are found
      in the request and in the response, only location in the header
      may vary (e.g. source and destination fields).  A CoAP request is
      different from an response.  For example, the URI-path option is
      mandatory in the request and is not found in the response, request
      may contain an Accept option and the response a Content-format
      option.

      Even when a field is "symmetric" (i.e. found in both directions)
      the values carried are different.  For instance the Type field
      will contain a CON value in the request and a ACK or RST value in
      the response.  Exploiting the asymmetry in compression will allow
      to send no bit in the compressed request and a single bit in the
      answer.  Same behavior can be applied to the CoAP Code field (O.OX
      code are present in the request and Y.ZZ in the answer).

   o  CoAP also obeys to the client/server paradigm and the compression
      rate can be different if the request is issued from a LPWAN node
      or from an non LPWAN device.  For instance a Thing (ES) aware of
      LPWAN constraints can generate a 1 byte token, but a regular CoAP
      client will certainly send a larger token to the Thing.  SCHC



Minaburo & Toutain       Expires March 10, 2018                 [Page 3]

Internet-Draft           LPWAN CoAP compression           September 2017


      compression will not modify the values to offer a better
      compression rate.  Nevertheless a proxy placed before the
      compressor may change some field values to offer a better
      compression rate and maintain the necessary context for
      interoperability with existing CoAP implementations.

   o  In IPv6 and UDP header fields have a fixed size.  In CoAP, Token
      size may vary from 0 to 8 bytes, length is given by a field in the
      header.  More systematically, the CoAP options are described using
      the Type-Length-Value.  When applying SCHC header compression.

      By sending compressed field information following the rule order,
      SCHC offers a serialization/deserialization mechanism.  Since a
      field exists to indicate the token length there is no ambiguity.
      For options, the rule indicates also the expected options found
      the int CoAP header.  Therefore only the length is needed to
      recognise an option.  The length will be send using the same CoAP
      encoding (size less than 12 are directly sent, higher values uses
      the escape mechanisms defined by [rfc7252]).  Delta Type is
      omitted, the value will be recovered by the decompressor.  This
      reduce the option length of 4, 12 or 20 bits regarding the
      orignial size of the delta type encoding in the option.

   o  In CoAP headers a field can be duplicated several times, for
      instances, elements of an URI (path or queries) or accepted
      formats.  The position defined in a rule, associated to a Field
      ID, can be used to identify the proper element.

3.  Compression of CoAP header fields

   This section discusses of the compression of the different CoAP
   header fields.  These are just examples.  The compression should take
   into account the nature of the traffic and not only the field values.
   Next chapter will define some compression rules for some common
   exchanges.

3.1.  CoAP version field (2 bits)

   This field is bidirectional and can be elided during the SCHC
   compression, since it always contains the same value.  It appears
   only in first position.

   FID      Pos    DI    TV              MO             CDF
   ver      1      bi    1               equal          not-sent







Minaburo & Toutain       Expires March 10, 2018                 [Page 4]

Internet-Draft           LPWAN CoAP compression           September 2017


3.2.  CoAP type field

   This field can be managed bidirectionally or unidirectionally.Several
   strategies can be applied to this field regarding the values used:

   o  If the ES is a client or a Server and non confirmable message are
      used, the transmission of the Type field can be avoided:

      *  Pos is always 1,

      *  DI can either be "uplink" if the ES is a CoAP client or
         "downlink" if the ES is a CoAP server, or "bidirectional"

      *  TV is set to the value,

      *  MO is set to "equal"

      *  CDF is set to "not-sent".

   FID     Pos    DI    TV              MO             CDF
   type    1      bi    NON             equal          not-sent

   o  If the ES is either a client or a Server and confirmable message
      are used, the DI can be used to elide the type on the request and
      compress it to 1 bit on the response.  The example above shows the
      rule for a ES acting as a client, directions need to be reversed
      for a ES acting as a server.

   FID     Pos    DI    TV              MO             CDF
   type    1      up    CON             equal          not-sent
   type    1      dw    {0:ACK, 1:RST}  match-mapping  mapping-sent

   o  Otherwise if the ES is acting simultaneously as a client and a
      server and the rule handle these two traffics, Type field must be
      sent uncompressed.

   FID     Pos    DI    TV              MO             CDF
   type    1      bi                    ignore         send-value

3.3.  CoAP token length field

   This field is bi-directional.

   Several strategies can be applied to this field regarding the values:

   o  no token or a wellknown length, the transmission can be avoided.
      A special care must be taken, if CON messages are acknowledged




Minaburo & Toutain       Expires March 10, 2018                 [Page 5]

Internet-Draft           LPWAN CoAP compression           September 2017


      with an empty ACK message.  In that case the token is not always
      present.

   FID     Pos    DI    TV              MO             CDF
   TKL     1      bi    value           ignore         send-value

   o  If the length is changing from one message to an other, the Token
      Length field must be sent.  If the Token length can be limited,
      then only the least significant bits have to be sent.  The example
      below allows values between 0 and 3.

   FID    Pos    DI    TV              MO             CDF
   TKL    1      bi    0x0             MSB(2)         LSB(2)

   o  otherwise the field value has to be sent.

   FID     Pos    DI    TV              MO             CDF
   TKL     1      bi                    ignore         value-sent

3.4.  CoAP code field

   This field is bidirectional, but compression can be enhanced using
   DI.

   The CoAP Code field defines a tricky way to ensure compatibility with
   HTTP values.  Nevertheless only 21 values are defined by [rfc7252]
   compared to the 255 possible values.
























Minaburo & Toutain       Expires March 10, 2018                 [Page 6]

Internet-Draft           LPWAN CoAP compression           September 2017


                  +------+------------------------------+-----------+
                  | Code | Description                  | Mapping   |
                  +------+------------------------------+-----------+
                  | 0.00 |                              |  0x00     |
                  | 0.01 | GET                          |  0x01     |
                  | 0.02 | POST                         |  0x02     |
                  | 0.03 | PUT                          |  0x03     |
                  | 0.04 | DELETE                       |  0x04     |
                  | 0.05 | FETCH                        |  0x05     |
                  | 0.06 | PATCH                        |  0x06     |
                  | 0.07 | iPATCH                       |  0x07     |
                  | 2.01 | Created                      |  0x08     |
                  | 2.02 | Deleted                      |  0x09     |
                  | 2.03 | Valid                        |  0x0A     |
                  | 2.04 | Changed                      |  0x0B     |
                  | 2.05 | Content                      |  0x0C     |
                  | 4.00 | Bad Request                  |  0x0D     |
                  | 4.01 | Unauthorized                 |  0x0E     |
                  | 4.02 | Bad Option                   |  0x0F     |
                  | 4.03 | Forbidden                    |  0x10     |
                  | 4.04 | Not Found                    |  0x11     |
                  | 4.05 | Method Not Allowed           |  0x12     |
                  | 4.06 | Not Acceptable               |  0x13     |
                  | 4.12 | Precondition Failed          |  0x14     |
                  | 4.13 | Request Entity Too Large     |  0x15     |
                  | 4.15 | Unsupported Content-Format   |  0x16     |
                  | 5.00 | Internal Server Error        |  0x17     |
                  | 5.01 | Not Implemented              |  0x18     |
                  | 5.02 | Bad Gateway                  |  0x19     |
                  | 5.03 | Service Unavailable          |  0x1A     |
                  | 5.04 | Gateway Timeout              |  0x1B     |
                  | 5.05 | Proxying Not Supported       |  0x1C     |
                  +------+------------------------------+-----------+


                  Figure 1: Example of CoAP code mapping

   Figure 1 gives a possible mapping, it can be changed to add new codes
   or reduced if some values are never used by both ends.  It could
   efficiently be coded on 5 bits.

   Even if the number of code can be increase with other RFC,
   implementations may use a limited number of values, which can help to
   reduce the number of bits sent on the LPWAN.

   The number of code may vary over time, some new codes may be
   introduced or some applications use a limited number of values.




Minaburo & Toutain       Expires March 10, 2018                 [Page 7]

Internet-Draft           LPWAN CoAP compression           September 2017


   The client and the server do not use the same values.  This asymmetry
   can be exploited to reduce the size sent on the LPWAN.

   The field can be treated differently in upstream than in downstream.
   If the Thing is a client an entry can be set on the uplink message
   with a code matching for 0.0X values and another for downlink values
   for Y.ZZ codes.  It is the opposite if the thing is a server.

   If the ES always sends or receives requests with the same method, the
   Code field can be elided.  The entry below shows a rule for a client
   sending only GET request.

   FID     Pos    DI    TV              MO             CDF
   code    1      up    GET             equal          not-sent

   If the client may send different methods, a matching-list can be
   applied.  For table Figure 1, 3 bits are necessary, but it could be
   less if fewer methods are used.  Example below gives an example where
   the ES is a server and receives only GET and POST requests.

   FID     Pos    DI    TV              MO             CDF
   code    1      dw    {0:0.01, 1:0.02}match-mapping  mapping-sent

   The same approach can be applied to responses.

3.5.  CoAP Message ID field

   This field is bidirectional.

   Message ID is used for two purposes:

   o  To acknowledge a CON message with an ACK.

   o  To avoid duplicate messages.

   In LPWAN, since a message can be received by several radio gateway,
   some LPWAN technologies include a sequence number in L2 to avoid
   duplicate frames.  Therefore if the message does not need to be
   acknowledged (NON or RST message), the Message ID field can be
   avoided.

   FID     Pos    DI    TV              MO             CDF
   Mid     1      bi                    ignore         not-sent

   The decompressor must generate a value.

   [[Note; check id this field is not used by OSCOAP .]]




Minaburo & Toutain       Expires March 10, 2018                 [Page 8]

Internet-Draft           LPWAN CoAP compression           September 2017


   To optimize information sent on the LPWAN, shorter values may be used
   during the exchange, but Message ID values generated a common CoAP
   implementation will not take into account this limitation.  Before
   the compression, a proxy may be needed to reduce the size.

   FID     Pos    DI    TV              MO             CDF
   Mid     1      bi    0x0000          MSB(12)        LSB(4)

   Otherwise if no compression is possible, the field has to be sent

   FID     Pos    DI    TV              MO             CDF
   Mid     1      bi                    ignore         value-sent

3.6.  CoAP Token field

   This field is bi-directional.

   Token is used to identify transactions and varies from one
   transaction to another.  Therefore, it is usually necessary to send
   the value of the token field on the LPWAN network.  The optimization
   will occur by using small values.

   Common CoAP implementations may generate large tokens, even if
   shorter tokens could be used regarding the LPWAN characteristics.  A
   proxy may be needed to reduce the size of the token before
   compression.

   The size of the compress token sent is known by a combination of the
   Token Length field and the rule entry.  For instance, with the entry
   below:

   FID     Pos    DI    TV              MO             CDF
   tkl     1      bi    2               equal          not-sent
   token   1      bi    0x00            MSB(12)        LSB(4)

   The uncompressed token is 2 bytes long, but the compressed size will
   be 4 bits.

4.  CoAP options

4.1.  CoAP option Content-format field.

   This field is unidirectional and must not be set to bidirectional in
   a rule entry.  It is used only by the server to inform the client
   about of the payload type and is never found in client requests.






Minaburo & Toutain       Expires March 10, 2018                 [Page 9]

Internet-Draft           LPWAN CoAP compression           September 2017


   If single value is expected by the client, the TV contains that value
   and MO is set to "equal" and the CDF is set to "not-sent".  The
   examples below describe the rules for an ES acting as a server.

   FID     Pos    DI    TV              MO             CDF
   content 1      up    value           equal          not-sent

   If several possible value are expected by the client, a matching-list
   can be used.

   FID     Pos    DI    TV              MO             CDF
   content 1      up    {0:50,1:41}     match-mapping  mapping-sent

   Otherwise the value can be sent.The value-sent CDF in the compressor
   do not send the option type and the decompressor reconstruct it
   regarding the position in the rule.

   FID     Pos    DI    TV              MO             CDF
   content 1      up                    ignore         value-sent

4.2.  CoAP option Accept field

   This field is unidirectional and must not be set to bidirectional in
   a rule entry.  It is used only by the client to inform of the
   possible payload type and is never found in server response.

   The number of accept options is not limited and can vary regarding
   the usage.  To be selected a rule must contain the exact number about
   accept options with their positions.  Since the order in which the
   Accept value are sent, the position order can be modified.  The rule
   below

   FID     Pos    DI    TV              MO             CDF
   accept  1      up    41              egal           not-sent
   accept  2      up    50              egal           not-sent

   will be selected only if two accept options are in the CoAP header if
   this order.

   The rule below:

   FID     Pos    DI    TV              MO             CDF
   accept  0      up    41              egal           not-sent
   accept  0      up    50              egal           not-sent

   will accept a-only CoAP messages with 2 accept options, but the order
   will not influence the rule selection.  The decompression will
   reconstruct the header regarding the rule order.



Minaburo & Toutain       Expires March 10, 2018                [Page 10]

Internet-Draft           LPWAN CoAP compression           September 2017


   Otherwise a matching-list can be applied to the different values, in
   that case the order is important to recover the appropriate value and
   the position must be clearly indicate.

   FID     Pos    DI    TV              MO             CDF
   accept 1      up    {0:50,1:41}     match-mapping  mapping-sent
   accept 2      up    {0:50,1:61}     match-mapping  mapping-sent
   accept 3      up    {0:61,1:71}     match-mapping  mapping-sent

   Finally, the option can be explicitly sent.

   FID     Pos    DI    TV              MO             CDF
   accept  1      up                    ignore         value-sent

4.3.  CoAP option Max-Age field, CoAP option Uri-Host and Uri-Port
      fields

   This field is unidirectional and must not be set to bidirectional in
   a rule entry.  It is used only by the server to inform of the caching
   duration and is never found in client requests.

   If the duration is known by both ends, value can be elided on the
   LPWAN.

   A matching list can be used if some wellknown values are defined.

   Otherwise the option length and value can be sent on the LPWAN.

   [[note: we can reduce (or create a new option) the unit to minute,
   second is small for LPWAN ]]

5.  CoAP option Uri-Path and Uri-Query fields

   This fields are unidirectional and must not be set to bidirectional
   in a rule entry.  They are used only by the client to access to a
   specific resource and are never found in server response.

   The Matching Operator behavior has not changed, but the value must
   take a position value, if the entry is repeated :

   FID       Pos    DI    TV              MO             CDF
   URI-Path  1      up    foo             equal          not-sent
   URI-Path  2      up    bar             equal          not-sent

                         Figure 2: Position entry.

   For instance, the rule Figure 2 matches with /foo/bar, but not /bar/
   foo.



Minaburo & Toutain       Expires March 10, 2018                [Page 11]

Internet-Draft           LPWAN CoAP compression           September 2017


   When the length is not clearly indicated in the rule, the value
   length must be sent with the field data, which means for CoAP to send
   directly the CoAP option with length and value.

   For instance for a CoMi path /c/X6?k="eth0" the rule can be set to:

   FID       Pos    DI    TV              MO             CDF
   URI-Path  1      up    c               equal          not-sent
   URI-Path  2      up                    ignore         value-sent
   URI-Query 1      up    k=              MSB (16)       LSB

                      Figure 3: CoMi URI compression

   Figure 3 shows the parsing and the compression of the URI. where c is
   not sent.  The second element is sent with the length (i.e. 0x2 X 6)
   followed by the query option (i.e. 0x05 "eth0").

   A Mapping list can be used to reduce size of variable Paths or
   Queries.  In that case, to optimize the compression, several elements
   can be regrouped into a single entry.  Numbering of elements do not
   change, MO comparison is set with the first element of the matching.

   FID       Pos    DI    TV              MO             CDF
   URI-Path  1      up    {0:"/c/c",      equal          not-sent
                           1:"/c/d"
   URI-Path  3      up                    ignore         value-sent
   URI-Query 1      up    k=              MSB (16)       LSB

                      Figure 4: complex path example

   For instance, the following Path /foo/bar/variable/stable can leads
   to the rule defined Figure 4.

5.1.  CoAP option Proxy-URI and Proxy-Scheme fields

   These fields are unidirectional and must not be set to bidirectional
   in a rule entry.  They are used only by the client to access to a
   specific resource and are never found in server response.

   If the field value must be sent, TV is not set, MO is set to "ignore"
   and CDF is set to "value-sent.  A mapping can also be used.

   Otherwise the TV is set to the value, MO is set to "equal" and CDF is
   set to "not-sent"







Minaburo & Toutain       Expires March 10, 2018                [Page 12]

Internet-Draft           LPWAN CoAP compression           September 2017


5.2.  CoAP option ETag, If-Match, If-None-Match, Location-Path and
      Location-Query fields

   These fields are unidirectional.

   These fields values cannot be stored in a rule entry.  They must
   always be sent with the request.

   [[Can include OSCOAP Object security in that category ]]

6.  Other RFCs

6.1.  Block

   Block option should be avoided in LPWAN.  The minimum size of 16
   bytes can be incompatible with some LPWAN technologies.

   [[Note: do we recommand LPWAN fragmentation since the smallest value
   of 16 is too big?]]

6.2.  Observe

   [rfc7641] defines the Observe option.  The TV is not set, MO is set
   to "ignore" and the CDF is set to "value-sent".  SCHC does not limit
   the maximum size for this option (3 bytes).  To reduce the
   transmission size either the Thing implementation should limit the
   value increase or a proxy can be used limit the increase.

   Since RST message may be sent to inform a server that the client do
   not require Observe response, a rule must allow the transmission of
   this message.

6.3.  No-Response

   [rfc7967]  defines an No-Response option limiting the responses made
   by a server to a request.  If the value is not by both ends, then TV
   is set to this value, MO is set to "equal" and CDF is set to "not-
   sent".

   Otherwise, if the value is changing over time, TV is not set, MO is
   set to "ignore" and CDF to "value-sent".  A matching list can also be
   used to reduce the size.

7.  Protocol analysis







Minaburo & Toutain       Expires March 10, 2018                [Page 13]

Internet-Draft           LPWAN CoAP compression           September 2017


8.  Examples of CoAP header compression

8.1.  Mandatory header with CON message

   In this first scenario, the LPWAN compressor receives from outside
   client a POST message, which is immediately acknowledged by the
   Thing.  For this simple scenario, the rules are described Figure 5.

    rule id 1
   +-------------+------+---------+-------------+-----+----------------+
   | Field       |TV    |MO       |CDF          |dir  | Sent           |
   +=============+======+=========+=============+=====+================+
   |CoAP version | 01   |equal    |not-sent     |bi   |                |
   |CoAP Type    |      |ignore   |value-sent   |bi   |TT              |
   |CoAP TKL     | 0    |equal    |not-sent     |bi   |                |
   |CoAP Code    | ML1  |match-map|matching-sent|bi   |  CC CCC        |
   |CoAP MID     | 0000 |MSB(7 )  |LSB(9)       |bi   |         M-ID   |
   |CoAP Uri-Path| path |equal 1  |not-sent     |down |                |
   +-------------+------+---------+-------------+-----+----------------+

          Figure 5: CoAP Context to compress header without token

   The version and Token Length fields are elided.  Code has shrunk to 5
   bits using the matching list (as the one given Figure 1: 0.01 is
   value 0x01 and 2.05 is value 0x0c) Message-ID has shrunk to 9 bits to
   preserve alignment on byte boundary.  The most significant bit must
   be set to 0 through a CoAP proxy.  Uri-Path contains a single element
   indicated in the matching operator.

   Figure 6 shows the time diagram of the exchange.  A LPWAN Application
   Server sends a CON message.  Compression reduces the header sending
   only the Type, a mapped code and the least 9 significant bits of
   Message ID.  The receiver decompresses the header. .

   The CON message is a request, therefore the LC process to a dynamic
   mapping.  When the ES receives the ACK message, this will not
   initiate locally a message ID mapping since it is a response.  The LC
   receives the ACK and uncompressed it to restore the original value.
   Dynamic Mapping context lifetime follows the same rules as message ID
   duration.











Minaburo & Toutain       Expires March 10, 2018                [Page 14]

Internet-Draft           LPWAN CoAP compression           September 2017


                   End System               LPWA LC
                        |                     |
                        |        rule id=1    |<----------------------
                        |<--------------------| +-+-+--+----+--------+
  <-------------------- |  TTCC CCCM MMMM MMMM| |1|0| 4|0.01| 0x0034 |
 +-+-+--+----+--------+ |  0000 0010 0011 0100| |  0xb4   p    a   t |
 |1|0| 1|0.01| 0x0034 | |                     | |  h   |
 |  0xb4   p    a   t | |                     | +------+
 |  h   |               |                     |
 +------+               |                     |
                        |                     |
                        |                     |
----------------------->|       rule id=1     |
+-+-+--+----+--------+  |-------------------->|
|1|2| 0|2.05| 0x0034 |  |  TTCC CCCM MMMM MMMM|------------------------>
+-+-+--+----+--------+  |  1001 1000 0011 0100| +-+-+--+----+--------+
                        |                     | |1|2| 0|2.05| 0x0034 |
                        v                     v +-+-+--+----+--------+


                Figure 6: Compression with global addresses

   The message can be further optimized by setting some fields
   unidirectional, as described in Figure 7.  Note that Type is no more
   sent in the compressed format, Compressed Code size in not changed in
   that example (8 values are needed to code all the requests and 21 to
   code all the responses in the matching list Figure 1)

    rule id 1
   +-------------+------+---------+-------------+---+----------------+
   | Field       |TV    |MO       |CDF          |dir| Sent           |
   +=============+======+=========+=============+===+================+
   |CoAP version | 01   |equal    |not-sent     |bi |                |
   |CoAP Type    | CON  |equal    |not-sent     |dw |                |
   |CoAP Type    | ACK  |equal    |not-sent     |up |                |
   |CoAP TKL     | 0    |equal    |not-sent     |bi |                |
   |CoAP Code    | ML2  |match-map|mapping-sent |dw |CCCC C          |
   |CoAP Code    | ML3  |match-map|mapping-sent |up |CCCC C          |
   |CoAP MID     | 0000 |MSB(5)   |LSB(11)      |bi |       M-ID     |
   |CoAP Uri-Path| path |equal 1  |not-sent     |dw |                |
   +-------------+------+---------+-------------+---+----------------+

   ML1 = {CON : 0, ACK:1} ML2 = {POST:0, 2.04:1, 0.00:3}


          Figure 7: CoAP Context to compress header without token





Minaburo & Toutain       Expires March 10, 2018                [Page 15]

Internet-Draft           LPWAN CoAP compression           September 2017


8.2.  Complete exchange

   In that example, the Thing is using CoMi and sends queries for 2 SID.

     CON
     MID=0x0012     |                         |
     POST           |                         |
     Accept X       |                         |
     /c/k=AS        |------------------------>|
                    |                         |
                    |                         |
                    |<------------------------|  ACK MID=0x0012
                    |                         |  0.00
                    |                         |
                    |                         |
                    |<------------------------|   CON
                    |                         |   MID=0X0034
                    |                         |   Content-Format X
   ACK MID=0x0034   |------------------------>|
   0.00


    rule id 3
   +-------------+------+---------+-------------+---+----------------+
   | Field       |TV    |MO       |CDF          |dir| Sent           |
   +=============+======+=========+=============+===+================+
   |CoAP version | 01   |equal    |not-sent     |bi |                |
   |CoAP Type    | CON  |equal    |not-sent     |up |                |
   |CoAP Type    | ACK  |equal    |not-sent     |dw |                |
   |CoAP TKL     | 1    |equal    |not-sent     |bi |                |
   |CoAP Code    | POST |equal    |not-sent     |up |                |
   |CoAP Code    | 0.00 |equal    |not-sent     |dw |                |
   |CoAP MID     | 0000 |MSB(8)   |LSB          |bi |MMMMMMMM        |
   |CoAP Token   |      |ignore   |send-value   |up |TTTTTTTT        |
   |CoAP Uri-Path| /c   |equal 1  |not-sent     |dw |                |
   |CoAP Uri-query ML4  |equal 1  |not-sent     |dw |P               |
   |CoAP Content | X    |equal    |not-sent     |up |                |
   +-------------+------+---------+-------------+---+----------------+

    rule id 4
   +-------------+------+---------+-------------+---+----------------+
   | Field       |TV    |MO       |CDF          |dir| Sent           |
   +=============+======+=========+=============+===+================+
   |CoAP version | 01   |equal    |not-sent     |bi |                |
   |CoAP Type    | CON  |equal    |not-sent     |dw |                |
   |CoAP Type    | ACK  |equal    |not-sent     |up |                |
   |CoAP TKL     | 1    |equal    |not-sent     |bi |                |
   |CoAP Code    | 2.05 |equal    |not-sent     |dw |                |



Minaburo & Toutain       Expires March 10, 2018                [Page 16]

Internet-Draft           LPWAN CoAP compression           September 2017


   |CoAP Code    | 0.00 |equal    |not-sent     |up |                |
   |CoAP MID     | 0000 |MSB(8)   |LSB          |bi |MMMMMMMM        |
   |CoAP Token   |      |ignore   |send-value   |dw |TTTTTTTT        |
   |COAP Accept  | X    |equal    |not-sent     |dw |                |
   +-------------+------+---------+-------------+---+----------------+


   alternative rule:

    rule id 4
   +-------------+------+---------+-------------+---+----------------+
   | Field       |TV    |MO       |CDF          |dir| Sent           |
   +=============+======+=========+=============+===+================+
   |CoAP version | 01   |equal    |not-sent     |bi |                |
   |CoAP Type    | ML1  |match-map|match-sent   |bi |t               |
   |CoAP TKL     | 1    |equal    |not-sent     |bi |                |
   |CoAP Code    | ML2  |match-map|match-sent   |up | cc             |
   |CoAP Code    | ML3  |match-map|match-sent   |dw | cc             |
   |CoAP MID     | 0000 |MSB(8)   |LSB          |bi |MMMMMMMM        |
   |CoAP Token   |      |ignore   |send-value   |dw |TTTTTTTT        |
   |CoAP Uri-Path| /c   |equal 1  |not-sent     |dw |                |
   |CoAP Uri-query ML4  |equal 1  |not-sent     |dw |P               |
   |CoAP Content | X    |equal    |not-sent     |up |                |
   |COAP Accept  | x    |equal    |not-sent     |dw |                |
   +-------------+------+---------+-------------+---+----------------+

   ML1 {CON:0, ACK:1} ML2 {POST:0, 0.00: 1} ML3 {2.05:0, 0.00:1}
   ML4 {NULL:0, k=AS:1, K=AZE:2}


9.  Normative References

   [I-D.toutain-lpwan-ipv6-static-context-hc]
              Minaburo, A. and L. Toutain, "LPWAN Static Context Header
              Compression (SCHC) for IPv6 and UDP", draft-toutain-lpwan-
              ipv6-static-context-hc-00 (work in progress), September
              2016.

   [rfc7252]  Shelby, Z., Hartke, K., and C. Bormann, "The Constrained
              Application Protocol (CoAP)", RFC 7252,
              DOI 10.17487/RFC7252, June 2014,
              <https://www.rfc-editor.org/info/rfc7252>.

   [rfc7641]  Hartke, K., "Observing Resources in the Constrained
              Application Protocol (CoAP)", RFC 7641,
              DOI 10.17487/RFC7641, September 2015,
              <https://www.rfc-editor.org/info/rfc7641>.




Minaburo & Toutain       Expires March 10, 2018                [Page 17]

Internet-Draft           LPWAN CoAP compression           September 2017


   [rfc7967]  Bhattacharyya, A., Bandyopadhyay, S., Pal, A., and T.
              Bose, "Constrained Application Protocol (CoAP) Option for
              No Server Response", RFC 7967, DOI 10.17487/RFC7967,
              August 2016, <https://www.rfc-editor.org/info/rfc7967>.

Authors' Addresses

   Ana Minaburo
   Acklio
   2bis rue de la Chataigneraie
   35510 Cesson-Sevigne Cedex
   France

   Email: ana@ackl.io


   Laurent Toutain
   Institut MINES TELECOM ; IMT Atlantique
   2 rue de la Chataigneraie
   CS 17607
   35576 Cesson-Sevigne Cedex
   France

   Email: Laurent.Toutain@imt-atlantique.fr



























Minaburo & Toutain       Expires March 10, 2018                [Page 18]
