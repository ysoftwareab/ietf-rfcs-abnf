<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Encrypted Signaling Transport Modes for the Host Identity Protocol </title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology">
<link href="#rfc.section.3" rel="Chapter" title="3 Transport Mode Negotiation">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Mode Negotiation in the HIP Base Exchange">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Mode Negotiation After the HIP Base Exchange">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Error Notifications">
<link href="#rfc.section.4" rel="Chapter" title="4 HIP Messages on Encrypted Connections">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 ESP Mode">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 ESP-TCP Mode">
<link href="#rfc.section.5" rel="Chapter" title="5 Recovering from Failed Encrypted Connections">
<link href="#rfc.section.6" rel="Chapter" title="6 Host Mobility and Multihoming">
<link href="#rfc.section.7" rel="Chapter" title="7 Security Considerations">
<link href="#rfc.section.8" rel="Chapter" title="8 Acknowledgements">
<link href="#rfc.section.9" rel="Chapter" title="9 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="10 References">
<link href="#rfc.references.1" rel="Chapter" title="10.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="10.2 Informational References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Mobility and Multihoming Examples">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document specifies two transport modes for Host Identity Protocol (HIP) signaling messages that allow conveying them over encrypted connections initiated with the Host Identity Protocol. " />
  <meta name="description" content="This document specifies two transport modes for Host Identity Protocol (HIP) signaling messages that allow conveying them over encrypted connections initiated with the Host Identity Protocol. " />
  <meta name="keywords" content="HIP, Encrypted, Signaling" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">HIP Working Group</td>
<td class="right">A. Keranen</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Ericsson</td>
</tr>
<tr>
<td class="left">Intended status: Experimental Protocol</td>
<td class="right">March 10, 2011</td>
</tr>
<tr>
<td class="left">Expires: September 11, 2011</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Encrypted Signaling Transport Modes for the Host Identity Protocol <br />
  <span class="filename">draft-ietf-hip-over-hip-06</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document specifies two transport modes for Host Identity Protocol (HIP) signaling messages that allow conveying them over encrypted connections initiated with the Host Identity Protocol. </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on September 11, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Terminology</a>
</li>
<li>3.   <a href="#rfc.section.3">Transport Mode Negotiation</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Mode Negotiation in the HIP Base Exchange</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Mode Negotiation After the HIP Base Exchange</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Error Notifications</a>
</li>
<li>4.   <a href="#rfc.section.4">HIP Messages on Encrypted Connections</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">ESP Mode</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">ESP-TCP Mode</a>
</li>
<li>5.   <a href="#rfc.section.5">Recovering from Failed Encrypted Connections</a>
</li>
<li>6.   <a href="#rfc.section.6">Host Mobility and Multihoming</a>
</li>
<li>7.   <a href="#rfc.section.7">Security Considerations</a>
</li>
<li>8.   <a href="#rfc.section.8">Acknowledgements</a>
</li>
<li>9.   <a href="#rfc.section.9">IANA Considerations</a>
</li>
<li>10.   <a href="#rfc.references">References</a>
</li>
<li>10.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>10.2.   <a href="#rfc.references.2">Informational References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Mobility and Multihoming Examples</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">Host Identity Protocol (HIP) <a href="#RFC5201">[RFC5201]</a> signaling messages can be exchanged over plain IP using the protocol number reserved for this purpose, or over UDP using the UDP port reserved for HIP NAT traversal <a href="#RFC5770">[RFC5770]</a>. When two hosts perform a HIP base exchange, they set up an encrypted connection between them for data traffic, but continue to use plain IP or UDP for HIP signaling messages. </p>
<p id="rfc.section.1.p.2">This document defines how the encrypted connection can be used also for HIP signaling messages. Two different modes are defined: HIP over Encapsulating Security Payload (ESP) and HIP over TCP. The benefit of sending HIP messages over ESP is that all signaling traffic (including HIP headers) will be encrypted. If HIP messages are sent over TCP (which in turn is transported over ESP), TCP can handle also message fragmentation where needed. </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Terminology</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119 <a href="#RFC2119">[RFC2119]</a>. </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Transport Mode Negotiation</h1>
<p id="rfc.section.3.p.1">This section defines how support for different HIP signaling message transport modes is indicated and how the use of different modes is negotiated. </p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#sec:mode-neg" id="sec:mode-neg">Mode Negotiation in the HIP Base Exchange</a>
</h1>
<p id="rfc.section.3.1.p.1">A HIP host implementing this specification SHOULD indicate the modes it supports, and is willing to use, in the base exchange. The HIP signaling message transport mode negotiation is similar to HIP NAT traversal mode negotiation: first the Responder lists the supported modes in a HIP_TRANSPORT_MODE parameter (see <a href="#hip-transport-mode-fig">Figure 1</a>) in the R1 packet. The modes are listed in priority order; the more preferred mode(s) first. If the Initiator supports, and is willing to use, any of the modes proposed by the Responder, it selects one of the modes by adding a HIP_TRANSPORT_MODE parameter containing the selected mode to the I2 packet. Finally, if the Initiator selected one of the modes and the base exchange succeeds, hosts MUST use the selected mode for the following HIP signaling messages sent between them for the duration of the HIP association or until another mode is negotiated. </p>
<p id="rfc.section.3.1.p.2">If the Initiator cannot, or will not, use any of the modes proposed by the Responder, the Initiator SHOULD include an empty HIP_TRANSPORT_MODE parameter to the I2 packet to signal that it supports this extension but will not use any of the proposed modes. Depending on local policy, the Responder MAY either abort the base exchange or continue HIP signaling without using an encrypted connection, if there was no HIP_TRANSPORT_MODE parameter in I2 or the parameter was empty. If the Initiator selects a mode that the Responder does not support (and hence was not included in R1), the Responder MUST abort the base exchange. If the base exchange is aborted due to (possibly lack of) HIP_TRANSPORT_PARAMETER, the Responder SHOULD send a NO_VALID_HIP_TRANSPORT_MODE notification (see <a href="#sec:notify-types">Section 3.3</a>) to the Initiator.</p>
<div id="#rfc.figure.1"></div>
<div id="#hip-transport-mode-fig"></div>
<pre>

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Type              |             Length            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             Port              |           Mode ID #1          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Mode ID #2           |           Mode ID #3          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Mode ID #n           |             Padding           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Type     [ TBD by IANA; 7680 ]
Port     transport layer port number (or zero if not used)
Length   length in octets, excluding Type, Length, and Padding
Mode ID  defines the proposed or selected transport mode(s)

The following Mode IDs are defined:

    ID name   Value
    RESERVED    0
    DEFAULT     1
    ESP         2
    ESP-TCP     3
		</pre>
<p id="rfc.section.3.1.p.3">The mode DEFAULT indicates that the same transport mode (e.g., plain IP or UDP) that was used for the base exchange should be used for subsequent HIP signaling messages. In the ESP mode the messages are sent as such on the encrypted ESP connection and in the ESP-TCP mode TCP is used within the ESP tunnel. If a mode that uses a transport layer connection within the ESP tunnel (e.g., ESP-TCP) is offered, the Port field MUST contain the local port number the host will use for the connection. If none of the modes utilize a transport layer protocol, the Port field SHOULD be set to zero when the parameter is sent and ignored when received. The Port and Mode ID fields are encoded as unsigned integers using network byte order. </p>
<p id="rfc.section.3.1.p.4">The HIP_TRANSPORT_MODE parameter resides on the signed part of the HIP packets, and hence it is covered by the signatures of the R1, I2, and UPDATE packets. </p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#sec:neg-after-bex" id="sec:neg-after-bex">Mode Negotiation After the HIP Base Exchange</a>
</h1>
<p id="rfc.section.3.2.p.1">If a HIP hosts wants to change to a different transport mode (or start using a transport mode) some time after the base exchange, it sends a HIP UPDATE packet with a HIP_TRANSPORT_MODE parameter containing the mode(s) it would prefer to use. The host receiving the UPDATE SHOULD respond with an UPDATE packet containing the mode that is selected as in the negotiation during the base exchange. If the receiving host does not support, or is not willing to use, any of the listed modes, it SHOULD respond with an UPDATE packet where the HIP_TRANSPORT_MODE parameter contains only the currently used transport mode (even if that was not included in the previous UPDATE packet) and continue using that mode. </p>
<p id="rfc.section.3.2.p.2">Since the HIP_TRANSPORT_MODE parameter's type is not critical (as defined in Section 5.2.1 of <a href="#RFC5201">[RFC5201]</a>), a host not supporting this extension would simply reply with an acknowledgement UPDATE packet without a HIP_TRANSPORT_MODE parameter. In such a case, depending on local policy as in mode negotiation during the base exchange, the host that requested the new transport mode MAY close the HIP association. If the association is closed, the host closing the association SHOULD send a NO_VALID_HIP_TRANSPORT_MODE NOTIFY packet to the other host before closing the association. </p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#sec:notify-types" id="sec:notify-types">Error Notifications</a>
</h1>
<p id="rfc.section.3.3.p.1">During a HIP signaling transport mode negotiation, if a HIP_TRANSPORT_MODE parameter does not contain any mode the receiving host is willing to use, or a HIP_TRANSPORT_MODE parameter does not exist in a HIP packet where the receiving host expected to see it, the receiving host MAY send back a NOTIFY packet with a NOTIFICATION parameter <a href="#RFC5201">[RFC5201]</a> error type NO_VALID_HIP_TRANSPORT_MODE (value [TBD by IANA; 100]). The Notification Data field for the error notifications SHOULD contain the HIP header of the rejected packet. </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> HIP Messages on Encrypted Connections</h1>
<p id="rfc.section.4.p.1">This specification defines two different transport modes for sending HIP packets over encrypted ESP connections. These modes require that the ESP transport format <a href="#RFC5202">[RFC5202]</a> is negotiated to be used between the hosts. If the ESP transport format is not used, these modes MUST NOT be offered in the HIP_TRANSPORT_MODE parameter. If a HIP_TRANSPORT_MODE parameter containing an ESP transport mode is received but the ESP transport format is not used, a host MUST NOT select such a mode but act as specified in <a href="#sec:mode-neg">Section 3.1</a> (if performing a base exchange) or <a href="#sec:neg-after-bex">Section 3.2</a> (if performing an UPDATE) when no valid mode is offered. </p>
<p id="rfc.section.4.p.2">The ESP mode provides simple protection for all the signaling traffic and can be used as a generic replacement for the DEFAULT mode in cases where all signaling traffic should be encrypted. If the HIP messages may become so large that they would need to be fragmented, e.g., because of HIP certificates <a href="#I-D.ietf-hip-cert">[I-D.ietf-hip-cert]</a> or DATA messages <a href="#RFC6078">[RFC6078]</a>, it is RECOMMENDED to use the ESP-TCP mode which can handle message fragmentation at TCP level instead of relying on IP level fragmentation. </p>
<p id="rfc.section.4.p.3">When HIP NAT traversal <a href="#RFC5770">[RFC5770]</a> is used, the ESP and HIP packets are sent UDP-encapsulated. The use of different NAT traversal modes, and in particular UDP-encapsulation, is independent of the transport mode (as specified in this document) of HIP packets. However, when HIP packets are sent over an ESP connection, no additional UDP-encapsulation (i.e., within the ESP connection) for the HIP packets is needed and MUST NOT be used since the ESP packets are already UDP-encapsulated, if needed for NAT traversal. For example, if UDP-encapsulation is used as defined in <a href="#RFC5770">[RFC5770]</a>, and the ESP-TCP transport mode is used as defined in this document, the HIP packets are sent over IP, UDP, ESP, and TCP (in that order). </p>
<p id="rfc.section.4.p.4">HIP messages that result in changing or generating new keying material, i.e., the base exchange and re-keying UPDATE messages, MUST NOT be sent over the encrypted connection that is created using the keying material that is being changed, nor over an encrypted connection using the newly created keying material. </p>
<p id="rfc.section.4.p.5">It should be noted that when HIP messages are sent using an encrypted connection, on-path network elements (e.g., firewalls and HIP-aware NATs) that would normally see the HIP headers and contents of the un-encrypted parameters, cannot see any part of the messages unless they have access to the encryption keying material. The original HIP design made an explicit decision to expose some of this information to HIP-aware NATs. If an encrypted transport mode is used, only the base exchange, or update without encryption, is visible to such NATs. </p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> ESP Mode</h1>
<p id="rfc.section.4.1.p.1">If the ESP mode is selected in the base exchange, both hosts MUST listen for incoming HIP signaling messages and send outgoing messages on the encrypted connection. The ESP header's next header value for HIP messages sent over ESP MUST be set to HIP (139). </p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> ESP-TCP Mode</h1>
<p id="rfc.section.4.2.p.1">If the ESP-TCP mode is selected, the host with the larger HIT (calculated as defined in Section 6.5 of <a href="#RFC5201">[RFC5201]</a>) MUST start to listen for an incoming TCP connection on the encrypted connection (i.e., to the HIT of the host) on the port it used in the Port field of the transport mode parameter. The other host MUST create a TCP connection to that port and the host MAY use the port it sent in the transport mode parameter as the source port for the connection. Once the TCP connection is established, both hosts MUST listen for incoming HIP signaling messages and send the outgoing messages using the TCP connection. The ESP next header value for messages sent using the ESP-TCP mode TCP connections MUST be set to TCP (6). </p>
<p id="rfc.section.4.2.p.2">If the hosts are unable to create the TCP connection, the host that initiated the mode negotiation MUST restart the negotiation with UPDATE message and SHOULD NOT propose the ESP-TCP mode. If local policy does not allow using any other mode than ESP-TCP, the HIP association SHOULD be closed. The UPDATE or CLOSE message MUST be sent using the same transport mode that was used for negotiating the use of the ESP-TCP mode. </p>
<p id="rfc.section.4.2.p.3">Since TCP provides reliable transport, the HIP messages sent over TCP MUST NOT be retransmitted. Instead, a host SHOULD wait to detect that the TCP connection has failed to retransmit the packet successfully in a timely manner (such detection is platform- and policy-specific) before concluding that there is no response. </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#recovery" id="recovery">Recovering from Failed Encrypted Connections</a>
</h1>
<p id="rfc.section.5.p.1">If the encrypted connection fails for some reason, it can no longer be used for HIP signaling and the hosts SHOULD re-establish the connection using HIP messages that are sent outside of the encrypted connection. Hence, while listening for incoming HIP messages on the encrypted connection, hosts MUST still accept incoming HIP messages using the same transport method (e.g., UDP or plain IP) that was used for the base exchange. When responding to a HIP message sent outside of the encrypted connection, the response MUST be sent using the same transport method as the original message used. If encryption was previously used, hosts SHOULD send outside of the encrypted connection only HIP messages that are used to re-establish the encrypted connection. Especially, messages for which the policy is to send them only encrypted (e.g., DATA messages using an encrypted transport mode) MUST be sent only using the encrypted connection. Note that a policy MUST NOT prevent sending un-encrypted UPDATE messages used for re-establishing the encrypted connection, since that would prevent recovering from failed encrypted connections.</p>
<p id="rfc.section.5.p.2">The UPDATE messages used for re-establishing the encrypted connection MUST contain a HIP_TRANSPORT_MODE parameter and the negotiation proceeds as described in <a href="#sec:neg-after-bex">Section 3.2</a>. </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#mobility" id="mobility">Host Mobility and Multihoming</a>
</h1>
<p id="rfc.section.6.p.1">If a host obtains a new address, a new Security Association (SA) pair may be created for (or an existing SA pair may be moved to) the new address, as described in <a href="#RFC5206">[RFC5206]</a>. If the ESP or ESP-TCP transport mode is used, HIP signaling continues using the (new) SA pair and the same transport mode as before. </p>
<p id="rfc.section.6.p.2">With the ESP mode, the first mobility UPDATE message SHOULD be sent using the old SA and the following messages, including the response to the first UPDATE, SHOULD be sent using the new SAs. Retransmissions of the UPDATE messages use the same SA as the original message. If the ESP-TCP mode is used, the HIP signaling TCP connection is moved to the new SA pair like any other TCP connection. However, the mobility UPDATE messages SHOULD NOT be sent over the TCP connection, but using plain ESP like in the ESP mode, and consequently hosts MUST be prepared to receive UPDATE messages over plain ESP even if the ESP-TCP mode is used. </p>
<p id="rfc.section.6.p.3">In some cases the host may not be able to send the mobility UPDATE messages using the encrypted connection before it breaks. This results in a similar situation as if the encrypted connection had failed and the hosts need to re-negotiate the new addresses using un-encrypted UPDATE messages and possibly rendezvous <a href="#RFC5204">[RFC5204]</a> or HIP relay <a href="#RFC5770">[RFC5770]</a> servers. Also these UPDATE messages MUST contain the HIP_TRANSPORT_MODE parameter and perform the transport mode negotiation. </p>
<p id="rfc.section.6.p.4">Examples of the signaling flows with mobility and multihoming are shown in <a href="#mob-examples">Appendix Appendix A</a>. </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#sec-security" id="sec-security">Security Considerations</a>
</h1>
<p id="rfc.section.7.p.1">By exchanging the HIP messages over ESP connection, all HIP signaling data (after the base exchange but excluding keying material (re)negotiation and some of the mobility UPDATE messages) will be encrypted, but only if NULL encryption is not used. Thus, a host requiring confidentiality for the HIP signaling messages must check that encryption is negotiated to be used on the ESP connection. Moreover, the level of protection provided by the ESP transport modes depends on the selected ESP transform; see <a href="#RFC5202">[RFC5202]</a> and <a href="#RFC4303">[RFC4303]</a> for security considerations of the different ESP transforms. </p>
<p id="rfc.section.7.p.2">While this extension to HIP allows for negotiation of security features, there is no risk of downgrade attacks since the mode negotiation happens using signed (R1/I2 or UPDATE) packets and only after both hosts have been securely identified in the base exchange. If an attacker would attempt to change the modes listed in the HIP_TRANSPORT_MODE parameter, that would break the signatures and the base exchange (or update) would not complete. Furthermore, since both "secure" modes (ESP and ESP-TCP) defined in this document are equally secure, only possible downgrade attack would be to make both hosts accept the DEFAULT mode. If the local policy (of either host) requires using a secure mode, the base exchange or update would again simply fail (as described in <a href="#sec:mode-neg">Section 3.1</a>). </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#sec-acks" id="sec-acks">Acknowledgements</a>
</h1>
<p id="rfc.section.8.p.1">Thanks to Gonzalo Camarillo, Kristian Slavov, Tom Henderson, Miika Komu, Jan Melen, and Tobias Heer for reviews and comments. </p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#sec-iana" id="sec-iana">IANA Considerations</a>
</h1>
<p id="rfc.section.9.p.1">This section is to be interpreted according to <a href="#RFC5226">[RFC5226]</a>. </p>
<p id="rfc.section.9.p.2">This document updates the IANA Registry for HIP Parameter Types <a href="#RFC5201">[RFC5201]</a> by assigning new HIP Parameter Type value for the HIP_TRANSPORT_MODE parameter (defined in Section 3.1). </p>
<p id="rfc.section.9.p.3">The HIP_TRANSPORT_MODE parameter has 16-bit unsigned integer fields for different modes, for which IANA is to create and maintain a new sub-registry entitled "HIP Transport Modes" under the "Host Identity Protocol (HIP) Parameters" registry.  Initial values for the transport mode registry are given in <a href="#sec:mode-neg">Section 3.1</a>; future assignments are to be made through IETF Review or IESG Approval <a href="#RFC5226">[RFC5226]</a>.  Assignments consist of a transport mode identifier name and its associated value. </p>
<p id="rfc.section.9.p.4">This document also defines new HIP NOTIFICATION message type <a href="#RFC5201">[RFC5201]</a> NO_VALID_HIP_TRANSPORT_MODE in <a href="#sec:notify-types">Section 3.3</a>. </p>
<h1 id="rfc.references">
<a href="#rfc.references">10.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">10.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5201">[RFC5201]</b></td>
<td class="top">
<a>Moskowitz, R.</a>, <a>Nikander, P.</a>, <a>Jokela, P.</a> and <a>T. Henderson</a>, "<a href="http://tools.ietf.org/html/rfc5201">Host Identity Protocol</a>", RFC 5201, April 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5202">[RFC5202]</b></td>
<td class="top">
<a>Jokela, P.</a>, <a>Moskowitz, R.</a> and <a>P. Nikander</a>, "<a href="http://tools.ietf.org/html/rfc5202">Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP)</a>", RFC 5202, April 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5226">[RFC5226]</b></td>
<td class="top">
<a>Narten, T.</a> and <a>H. Alvestrand</a>, "<a href="http://tools.ietf.org/html/rfc5226">Guidelines for Writing an IANA Considerations Section in RFCs</a>", BCP 26, RFC 5226, May 2008.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">10.2.</a> Informational References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC4303">[RFC4303]</b></td>
<td class="top">
<a>Kent, S.</a>, "<a href="http://tools.ietf.org/html/rfc4303">IP Encapsulating Security Payload (ESP)</a>", RFC 4303, December 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5204">[RFC5204]</b></td>
<td class="top">
<a>Laganier, J.</a> and <a>L. Eggert</a>, "<a href="http://tools.ietf.org/html/rfc5204">Host Identity Protocol (HIP) Rendezvous Extension</a>", RFC 5204, April 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5206">[RFC5206]</b></td>
<td class="top">
<a>Nikander, P.</a>, <a>Henderson, T.</a>, <a>Vogt, C.</a> and <a>J. Arkko</a>, "<a href="http://tools.ietf.org/html/rfc5206">End-Host Mobility and Multihoming with the Host Identity Protocol</a>", RFC 5206, April 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5770">[RFC5770]</b></td>
<td class="top">
<a>Komu, M.</a>, <a>Henderson, T.</a>, <a>Tschofenig, H.</a>, <a>Melen, J.</a> and <a>A. Keranen</a>, "<a href="http://tools.ietf.org/html/rfc5770">Basic Host Identity Protocol (HIP) Extensions for Traversal of Network Address Translators</a>", RFC 5770, April 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6078">[RFC6078]</b></td>
<td class="top">
<a>Camarillo, G.</a> and <a>J. Melen</a>, "<a href="http://tools.ietf.org/html/rfc6078">Host Identity Protocol (HIP) Immediate Carriage and Conveyance of Upper-Layer Protocol Signaling (HICCUPS)</a>", RFC 6078, January 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-hip-cert">[I-D.ietf-hip-cert]</b></td>
<td class="top">
<a>Heer, T</a> and <a>S Varjonen</a>, "<a href="http://tools.ietf.org/html/draft-ietf-hip-cert-12">Host Identity Protocol Certificates</a>", Internet-Draft draft-ietf-hip-cert-12, March 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> <a href="#mob-examples" id="mob-examples">Mobility and Multihoming Examples</a>
</h1>
<p id="rfc.section.Appendix A.p.1">When changing interfaces due to mobility or multihoming, the hosts use HIP messages to notify the other host about the new address and to check that the host with the new address is still reachable. The following examples show the signaling performed during the address change in two different scenarios. Note that not all HIP parameters nor all the content of the parameters is shown in the examples. This section and the examples are not normative; for normative behavior, see previous sections. </p>
<p id="rfc.section.Appendix A.p.2">In the examples, the host A uses two different addresses (a1 and a2) while the host B has just a single address (b1). In the first example, make before break (<a href="#make-b4-break">Figure 2</a>), host A starts to use the new address but can still use the old address (due to multihoming) for signaling. In the second example, break before make (<a href="#break-b4-make">Figure 3</a>), host A loses the first address before obtaining the second address (e.g., due to mobility) and the mobility HIP signaling is done without the encrypted connection. </p>
<p id="rfc.section.Appendix A.p.3">The following notations are used in the examples:</p>
<p></p>

<ul>
<li>ESPx(y): data y sent encapsulated in ESP with SA x; if ESP-encapsulation is not used, the data is sent over plain IP or UDP</li>
<li>UPDATE(x,y,z): HIP UPDATE message <a href="#RFC5201">[RFC5201]</a> with parameters x,y,z</li>
<li>LOCATOR(x): HIP LOCATOR parameter <a href="#RFC5206">[RFC5206]</a> with locator x </li>
<li>ESP_INFO(x,y): HIP ESP_INFO parameter <a href="#RFC5202">[RFC5202]</a> with "old SPI" value x and "new SPI" value y</li>
<li>ACK, ECHO_REQ, and ECHO_RSP: HIP ACK, ECHO_REQUEST, and ECHO_RESPONSE parameters <a href="#RFC5201">[RFC5201]</a>
</li>
</ul>

<p> </p>
<div id="#rfc.figure.2"></div>
<div id="#make-b4-break"></div>
<pre>
 A                                                  B
                      ESP1(...)
a1 &lt;----------------------------------------------&gt; b1

     ESP1(UPDATE(LOCATOR(a2), ESP_INFO(0,SPI2a)))
a1 -----------------------------------------------&gt; b1

        (A and B create SAs a2 &lt;-&gt; b1 (ESP2)
         retransmissions of the first UPDATE
         happen over ESP1)

    ESP2(UPDATE(ACK, ESP_INFO(0,SPI2b), ECHO_REQ)))
a2 &lt;----------------------------------------------- b1

              ESP2(UPDATE(ACK, ECHO_RSP))
a2 -----------------------------------------------&gt; b1

                       ESP2(...)
a2 &lt;----------------------------------------------&gt; b1</pre>
<div id="#rfc.figure.3"></div>
<div id="#break-b4-make"></div>
<pre>
 A                                                  B
                       ESP1(...)
a1 &lt;----------------------------------------------&gt; b1
                (A moves from a1 to a2)

      UPDATE(LOCATOR(a2), ESP_INFO(SPI1a, SPI1a))
a2 -----------------------------------------------&gt; b1

      UPDATE(ACK, ECHO_REQ, ESP_INFO(SPI1b,SPI1b))
a2 &lt;----------------------------------------------- b1

                UPDATE(ACK, ECHO_RSP)
a2 -----------------------------------------------&gt; b1
         (A and B move ESP1 SAs to a2 &lt;-&gt; b1)

                       ESP1(...)
a2 &lt;----------------------------------------------&gt; b1</pre>
<p id="rfc.section.Appendix A.p.5">When the ESP-TCP mode is used, the signaling flows are similar since TCP is not used for the mobility UPDATE messages as described in <a href="#mobility">Section 6</a>. </p>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Ari Keranen</span> 
	  <span class="n hidden">
		<span class="family-name">Keranen</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson</span>
	<span class="adr">
	  <span>Hirsalantie 11</span>

	  <span class="vcardline">
		<span class="locality">02420 Jorvas</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Finland</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ari.keranen@ericsson.com">ari.keranen@ericsson.com</a></span>

  </address>
</div>

</body>
</html>