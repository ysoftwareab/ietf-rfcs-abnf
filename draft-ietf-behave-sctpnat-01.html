<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Stream Control Transmission Protocol (SCTP) Network Address Translation</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Stream Control Transmission Protocol (SCTP) Network Address Translation">
<meta name="keywords" content="Internet-Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">R. Stewart</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Researcher</td></tr>
<tr><td class="header">Intended status: BCP</td><td class="header">M. Tuexen</td></tr>
<tr><td class="header">Expires: August 20, 2009</td><td class="header">I. Ruengeler</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Muenster Univ. of Applied Sciences</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">February 16, 2009</td></tr>
</table></td></tr></table>
<h1><br />Stream Control Transmission Protocol (SCTP) Network Address Translation<br />draft-ietf-behave-sctpnat-01.txt</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on August 20, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>Stream Control Transmission Protocol <a class='info' href='#RFC4960'>[RFC4960]<span> (</span><span class='info'>Stewart, R., &ldquo;Stream Control Transmission Protocol,&rdquo; September&nbsp;2007.</span><span>)</span></a>
provides a reliable communications channel between two end-hosts in many
ways similar to TCP <a class='info' href='#RFC0793'>[RFC0793]<span> (</span><span class='info'>Postel, J., &ldquo;Transmission Control Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a>. With the widespread 
deployment of Network Address Translators (NAT), specialized code has been added 
to NAT for TCP that allows multiple hosts to reside behind a NAT and yet use only a
single globally unique IPv4 address, even when two hosts (behind a NAT) choose
the same port numbers for their connection. This additional code is sometimes
classified as Network Address and Port Translation or NAPT. To date, specialized
code for SCTP has NOT yet been added to most NATs so that only pure NAT is
available. The end result of this is that only one SCTP capable host can be
behind a NAT.
</p>
<p>This document describes an SCTP specific variant of NAT which provides
similar features of NAPT in the single point and multi-point traversal
scenario.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#conventions">2.</a>&nbsp;
Conventions<br />
<a href="#anchor2">3.</a>&nbsp;
Terminology<br />
<a href="#anchor3">4.</a>&nbsp;
SCTP NAT Traversal Scenarios<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">4.1.</a>&nbsp;
Single Point Traversal<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">4.2.</a>&nbsp;
Multi Point Traversal<br />
<a href="#anchor6">5.</a>&nbsp;
The SCTP specific variant of NAT<br />
<a href="#anchor7">6.</a>&nbsp;
Handling of internal port number collisions<br />
<a href="#anchor8">7.</a>&nbsp;
Handling of internal port number and verification tag collisions<br />
<a href="#anchor9">8.</a>&nbsp;
Handling of missing state<br />
<a href="#anchor10">9.</a>&nbsp;
Multi Point Traversal considerations<br />
<a href="#anchor11">10.</a>&nbsp;
Handling of fragmented SCTP packets<br />
<a href="#anchor12">11.</a>&nbsp;
Simplification for small NATs<br />
<a href="#anchor13">12.</a>&nbsp;
Various examples of NAT traversals<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">12.1.</a>&nbsp;
Single-homed client to single-homed server<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">12.2.</a>&nbsp;
Single-homed client to multi-homed server<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">12.3.</a>&nbsp;
Multihomed client and server<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">12.4.</a>&nbsp;
NAT loses its state<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">12.5.</a>&nbsp;
Peer-to-Peer Communication<br />
<a href="#anchor19">13.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor20">14.</a>&nbsp;
Security considerations<br />
<a href="#anchor21">15.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">16.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">16.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">16.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>Stream Control Transmission Protocol <a class='info' href='#RFC4960'>[RFC4960]<span> (</span><span class='info'>Stewart, R., &ldquo;Stream Control Transmission Protocol,&rdquo; September&nbsp;2007.</span><span>)</span></a>
provides a reliable communications channel between two end-hosts in many
ways similar to TCP <a class='info' href='#RFC0793'>[RFC0793]<span> (</span><span class='info'>Postel, J., &ldquo;Transmission Control Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a>. With the widespread 
deployment of Network Address Translators (NAT), specialized code has been added 
to NAT for TCP that allows multiple hosts to reside behind a NAT and yet use only a
single globally unique IPv4 address, even when two hosts (behind a NAT) choose
the same port numbers for their connection. This additional code is sometimes
classified as Network Address and Port Translation or NAPT. To date, specialized
code for SCTP has NOT yet been added to most NATs so that only true NAT is
available. The end result of this is that only one SCTP capable host can be
behind a NAT.
</p>
<p>This document proposes an SCTP specific variant NAT that provides the NAPT
functionality without changing SCTP port numbers. The authors feel it is
possible and desirable to make these changes for a number of reasons.
</p>
<ul class="text">
<li>It is desirable for SCTP internal end-hosts on multiple platforms to be able to share a
NAT's public IP address, much as TCP does today.
</li>
<li>If a NAT does not need to change any data within an SCTP packet it
will reduce the processing burden of NAT'ing SCTP by NOT 
needing to execute the CRC32c checksum required by SCTP.
</li>
<li>Not having to touch the IP payload makes the processing of ICMP
messages in NATs easier.
</li>
</ul><p>

</p>
<a name="conventions"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Conventions</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in
<a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Terminology</h3>

<p>For this discussion we will use several terms, which we 
will define and point out in a figure.
</p>
<ul class="text">
<li> Private-Address (Priv-Addr) - The private address 
that is known to
the internal host.
</li>
<li> Internal-Port (Int-Port) - The port number that is in use by the host holding
the Private-Address. Normally this is the port that will be translated
by the NAPT to a different port number.
</li>
<li> Internal-VTag (Int-VTag) - The Verification Tag that the internal host 
has chosen for its communication. The
VTag is a unique 32 bit tag that must accompany any incoming SCTP
packet for this association to the Private-Address.
</li>
<li> External-Address (Ext-Addr) - The address that an internal host 
is attempting to contact.
</li>
<li> External-Port (Ext-Port) - The port number of the peer process at
the External-Address.
</li>
<li> External-VTag (Ext-VTag) - The Verification Tag that the host holding
the External-Address has chosen for its communication. The
VTag is a unique 32 bit tag that must accompany any incoming
SCTP packet for this association to the External-Address.
</li>
<li> Public-Address (Pub-Addr) - The public address assigned to the NAT
box which it uses as a source address when sending packets towards
the External-Address.
</li>
</ul><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Internal Network      |         External Network
                        |
            Private     | Public                    External
+---------+ Address     | Address     /--\/--\      Address +---------+
|  SCTP   |          +-----+         /        \             |  SCTP   |
|end point|==========| NAT |======= | Internet | ========== |end point|
|    A    |          +-----+         \        /             |    B    |
+---------+ Internal    |             \--/\--/     External +---------+
 Internal      Port     |                             Port    External
   VTag                 |                                       VTag

</pre></div>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
SCTP NAT Traversal Scenarios</h3>

<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Single Point Traversal</h3>

<p>In this case, all packets in the SCTP association go through a
single NAT, as shown below:
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  Internal Network      |       External Network
                        |
+---------+             |               /--\/--\            +---------+
|  SCTP   |          +-----+           /        \           |  SCTP   |
|end point|==========| NAT |========= | Internet | =========|end point|
|    A    |          +-----+           \        /           |    B    |
+---------+             |               \--/\--/            +---------+
                        |
</pre></div><p>


</p>
<p>A variation of this case is shown below, i.e., multiple NATs in a
single path:
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
        Internal | External :: Internal | External
                 |          ::          |
+---------+      |          ::          |       /--\/--\    +---------+
|  SCTP   |   +-----+       ::       +-----+   /        \   |  SCTP   |
|end point|===| NAT |=======::=======| NAT |==| Internet |==|end point|
|    A    |   +-----+       ::       +-----+   \        /   |    B    |
+---------+      |          ::          |       \--/\--/    +---------+
                 |          ::          |
</pre></div><p>


</p>
<p>The two SCTP endpoints in this case can be either single-homed or
multi-homed. However, the important thing is that the NAT (or NATs) in
this case sees ALL the packets of the SCTP association.
</p>
<p> In this single point traversal scenario, we must acknowledge that
while one of the main benefits of SCTP multi-homing is redundant
paths, the NAT function represents a single point of failure in the
path of the SCTP multi-home association. However, the rest of the path
may still benefit from path diversity provided by SCTP
multi-homing.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Multi Point Traversal</h3>

<p>This case involves multiple NATs and each NAT only sees some of the
packets in the SCTP association. An example is shown below: 
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

         Internal       |      External
                     +------+             /---\/---\
+---------+  /=======|NAT A |=========\  /          \       +---------+
|  SCTP   | /        +------+          \/            \      |  SCTP   |
|end point|/       ...                 |   Internet   |=====|end point|
|    A    |\                            \            /      |    B    |
+---------+ \        +------+          / \          /       +---------+
             \=======|NAT B |=========/   \---\/---/
                     +------+
                        |
</pre></div><p>


</p>
<p>This case does NOT apply to a single-homed SCTP association (i.e.,
BOTH endpoints in the association use only one IP address). The
advantage here is that the existence of multiple NAT traversal points
can preserve the path diversity of a multi-homed association for the
entire path. This in turn can improve the robustness of the
communication.
</p>
<p>To make this work, however, all the NATs involved must recognize
the packets they see as belonging to the same SCTP association and
perform address translation in a consistent way. 
This may require that a pre-defined table of ports and addresses were
shared between the NATs. Other external management schemes that help
multiple NATs coordinate a multi-homed SCTP association could be
investigated.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
The SCTP specific variant of NAT</h3>

<p>In this section we assume that we have multiple SCTP capable hosts
behind a NAT which has one Public-Address. Furthermore we are
focusing in this section on the single point traversal scenario.
</p>
<p>The modification of SCTP packets sent to the public Internet is
easy. The source address of the packet has to be replaced with the
Public-Address. It may also be necessary to establish some
state in the NAT box to handle incoming packets, which is discussed
later.
</p>
<p>For SCTP packets coming from the public Internet the destination
address of the packets has to be replaced with the Private-Address
of the host the packet has to be delivered to. The lookup of the
Private-Address is based on the External-VTag, External-Port, External-Address,
Internal-VTag and the Internal-Port.
</p>
<p>For the SCTP NAT processing the NAT box has to maintain a table
of Internal-VTag, Internal-Port, Private-Address, External-VTag, External-Port
and External-Address. An entry in that table is called a NAT state
control block.
</p>
<p>The processing of outgoing SCTP packets containing an INIT-chunk
is described in the following figure. The scenario shown is valid for all 
message flows in this section.
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                        /--\/--\
+--------+           +-----+           /        \            +--------+
| Host A | &lt;-------&gt; | NAT | &lt;------&gt; | Internet | &lt;-------&gt; | Host B |
+--------+           +-----+           \         /           +--------+
                                        \--/\---/


             INIT[Initiate-Tag]
Priv-Addr:Int-Port ------&gt; Ext-Addr:Ext-Port
                  Ext-VTag=0

                   Create(Initiate-Tag,Internal-Port,Private-Address,
                          0,External-Port,External-Address)
                   Returns(NAT-State control block)

           Translate To:

                        INIT[Initiate-Tag]
           Pub-Addr:Int-Port ------&gt; Ext-Addr:Ext-Port
                            Ext-VTag=0
</pre></div><p>

It should be noted that normally a NAT control block will be created. However,
it is possible that there is already a NAT control block with the
same External-Address, External-Port, External-VTag, Internal-VTag but different
Private-Address. In this case the INIT SHOULD be dropped and an ABORT MAY
be sent back.
</p>
<p>The processing of outgoing SCTP packets containing no INIT-chunk
is described in the following figure.
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Priv-Addr:Int-Port ------&gt; Ext-Addr:Ext-Port
                  Ext-VTag


                            Translate To:

                            Pub-Addr:Int-Port ------&gt; Ext-Addr:Ext-Port
                                              Ext-VTag
</pre></div><p>


</p>
<p>The processing of incoming SCTP packets containing INIT-ACK chunks
is described in the following figure.
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                         INIT-ACK[Initiate-Tag]
                            Pub-Addr:Int-Port &lt;------ Ext-Addr:Ext-Port
                                              Int-VTag

           Lookup(Internal-VTag,Internal-Port,*,
                  0,External-Port,External-Address)
           Update(*, *, *, Initiate-Tag, *, *)

           Returns(NAT-State control block containing Private-Address)

               INIT-ACK[Initiate-Tag]
Priv-Addr:Int-Port &lt;------ Ext-Addr:Ext-Port
                   Int-VTag
</pre></div><p>

In the case Lookup fails, the SCTP packet is dropped. The Update routine
inserts the External-VTag (the Initiate-Tag of the INIT-ACK chunk) 
in the NAT state control block.
</p>
<p>The processing of incoming SCTP packets containing an ABORT or
SHUTDOWN-COMPLETE chunk with the T-Bit set is described in the following figure.
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                            Pub-Addr:Int-Port &lt;------ Ext-Addr:Ext-Port
                                              Ext-VTag

            Lookup(0, Internal-Port, *,External-VTag,
                   External-Port, External-Address)

            Returns(NAT-State control block containing Private-Address)

Priv-Addr:Int-Port &lt;------ Ext-Addr:Ext-Port
                   Ext-VTag
</pre></div><p>

</p>
<p>The processing of other incoming SCTP packets is described in the
following figure.
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                            Pub-Addr:Int-Port &lt;------ Ext-Addr:Ext-Port
                                              Int-VTag

              Lookup(Internal-VTag, Internal-Port, *,
                       *, External-Port, External-Address)

              Returns(NAT-State control block containing Local-Address)

Priv-Addr:Int-Port &lt;------ Ext-Addr:Ext-Port
                   Int-VTag
</pre></div><p>


</p>
<p>For an incoming packet containing an INIT-chunk a table lookup is made
only based on the addresses and port numbers. If an entry with an Internal-VTag
of zero is found, it is considered a match and the Internal-VTag is updated.
</p>
<p>This allows the handling of INIT-collision through NAT.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Handling of internal port number collisions</h3>

<p>There is one drawback of the SCTP specific variant of NAT compared
to a NAPT solution like the ones available for TCP. Consider the case
where two hosts in the Private-Address space want to set up an SCTP association
with the same server running on the same host in the Internet. This means
that the External-Port and the External-Address are the same. If they both
choose the same Internal-Port the server cannot distinguish both associations
based on the address and port numbers. For the server it looks like
the association is being restarted. To overcome this limitation the
client sends a NAT_SUPPORTED parameter in the INIT-chunk which is defined
as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Type = 0xC007         |          Length=4             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>When the server receives this parameter it will also use the
verification tag to look up the association. However, this will
make it impossible to restart such associations.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Handling of internal port number and verification tag collisions</h3>

<p>Consider the case where two hosts in the Private-Address space want to
set up an SCTP association with the same server running on the same host
in the Internet. This means that the External-Port and the External-Address
are the same. If they both choose the same Internal-Port and Internal-VTag, the
NAT box cannot distinguish incoming packets anymore. But this is very
unlikely. The Internal-VTags are chosen at random and if the Internal-Ports are
also chosen from the ephemeral port range at random this gives a 46 bit
random number which has to match.
In the TCP like NAPT case the NAT box can control the 16 bit Natted Port.
</p>
<p>However, in this unlikely event the NAT box MUST respond
to the INIT chunk by sending an ABORT chunk with the M-bit set.
The source address of the packet containing the ABORT chunk MUST
be the destination address of the SCTP packet containing the
INIT chunk.
The sender of the packet containing the INIT chunk MAY start
the association setup procedure after choosing a new initiate tag.
</p>
<p>The ABORT chunk defined in <a class='info' href='#RFC4960'>[RFC4960]<span> (</span><span class='info'>Stewart, R., &ldquo;Stream Control Transmission Protocol,&rdquo; September&nbsp;2007.</span><span>)</span></a> is therefore
extended by using the following format:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Type = 6    | Reserved  |M|T|           Length              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\                                                               \
/                   zero or more Error Causes                   /
\                                                               \
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>The following error cause with cause code 0x00B0 (Colliding NAT table entry)
SHOULD be included in the ABORT chunk:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Cause Code=0x00B0         |      Cause Length=Variable    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\                          INIT chunk                          /
/                                                              \
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Handling of missing state</h3>

<p>If the NAT box receives a packet for which the lookup procedure
does not find an entry in the NAT table, a packet containing an ERROR
packet is sent back with the M-bit set. 
The source address of the packet containing the ERROR chunk MUST
be the destination address of the incoming SCTP packet. The verification
tag is reflected.
</p>
<p>The ERROR chunk defined in <a class='info' href='#RFC4960'>[RFC4960]<span> (</span><span class='info'>Stewart, R., &ldquo;Stream Control Transmission Protocol,&rdquo; September&nbsp;2007.</span><span>)</span></a> is therefore
extended by using the following format:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Type = 9    | Reserved  |M|T|           Length              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\                                                               \
/                   zero or more Error Causes                   /
\                                                               \
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>The following error cause with cause code 0x00B1 (Missing NAT table entry)
SHOULD be included in the ERROR chunk:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Cause Code=0x00B1         |      Cause Length=Variable    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\                       Incoming Packet                        /
/                                                              \
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>If an end-point receives a packet with this ERROR chunk it MAY send
an SCTP packet with an ASCONF chunk containing an Add IP Address
parameter followed by a vtag parameter:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Parameter Type = 0xC008   |     Parameter Length = 16     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 ASCONF-Request Correlation ID                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   Internal Verification Tag                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   External Verification Tag                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>If the NAT box receives a packet for which it has no NAT table entry
and the packet contains an ASCONF chunk with a vtag parameter, the NAT
box MUST update its NAT table according to the verification tags in
the vtag parameter.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Multi Point Traversal considerations</h3>

<p>If a multi-homed SCTP end-point behind a NAT connects to a peer,
it first sets up the association single-homed. 
Then it adds each IP address using ASCONF chunks. The address to add
is the wildcard address and the lookup address also.
The ASCONF chunks SHOULD also contain a vtag parameter.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Handling of fragmented SCTP packets</h3>

<p>A NAT box MUST support IP reassembly of received fragmented
SCTP packets. The fragments may arrive in any order.
</p>
<p>When an SCTP packet has to be fragmented by the NAT box and
the IP header forbids fragmentation a corresponding ICMP packet SHOULD
be sent.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Simplification for small NATs</h3>

<p>Small NAT boxes, i.e. NAT boxes which only have to support a
small number of concurrent SCTP associations, MAY not take the
external address into account when processing packets. Therefore the
External-Address could also be removed from the NAT table.
</p>
<p>This simplification may make implementing a NAT box easier, however,
the collision probability is higher than using a mapping which takes
the external address into account.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Various examples of NAT traversals</h3>

<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12.1"></a><h3>12.1.&nbsp;
Single-homed client to single-homed server</h3>

<p>The internal client starts the association with the external
server via a four-way-handshake.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                        /--\/--\
+--------+           +-----+           /        \            +--------+
| Host A | &lt;-------&gt; | NAT | &lt;------&gt; | Internet | &lt;-------&gt; | Host B |
+--------+           +-----+           \         /           +--------+
                                        \--/\---/
       +---------+--------+-----------+----------+--------+-----------+
NAT    |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+--- -------+----------+--------+-----------+

Host A sends INIT:

   INIT[Initiate-Tag = 1234]
10.0.0.1:1 ------&gt; 100.0.0.1:2
        Ext-VTtag = 0

       NAT creates entry:
       +---------+--------+-----------+----------+--------+-----------+
NAT    |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |     0    |    2   | 100.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+

                                 INIT[Initiate-Tag = 1234]
                   101.0.0.1:1 ---------------------------&gt; 100.0.0.1:2
                                        Ext-VTtag = 0


                                 INIT-ACK[Initiate-Tag = 5678]
                   101.0.0.1:1 &lt;--------------------------- 100.0.0.1:2
                                         Int-VTag = 1234

NAT updates entry:
       +---------+--------+-----------+----------+--------+-----------+
NAT    |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |    5678  |    2   | 100.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+


INIT-ACK[Initiate-Tag = 5678]
10.0.0.1:1 &lt;------ 100.0.0.1:2
          Int-VTag = 1234

         COOKIE-ECHO
10.0.0.1:1 ------&gt; 100.0.0.1:2
       Ext-VTag = 5678

                                         COOKIE-ECHO
                   101.0.0.1:1 ---------------------------&gt; 100.0.0.1:2
                                       Ext-VTag = 5678


                                         COOKIE-ACK
                   101.0.0.1:1 &lt;--------------------------- 100.0.0.1:2
                                         Int-VTag = 1234

            COOKIE-ACK
10.0.0.1:1 &lt;------ 100.0.0.1:2
           Int-VTag = 1234
</pre></div>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12.2"></a><h3>12.2.&nbsp;
Single-homed client to multi-homed server</h3>

<p>The internal client is single-homed whereas the external server is
multi-homed. The server includes its addresses in the INIT-ACK chunk, 
which results in two NAT entries.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                                +--------+
                                /--\/--\      /-|Router 1| \
+------+          +-----+      /        \    /  +--------+  \  +------+
| Host | &lt;------&gt; | NAT | &lt;-&gt; | Internet | ==                ==| Host |
|   A  |          +-----+      \        /    \  +--------+  /  |   B  |
+------+                        \--/\--/      \-|Router 2|-/   +------+
                                                +--------+

       +---------+--------+-----------+----------+--------+-----------+
NAT    |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+--- -------+----------+--------+-----------+


 INIT[Initiate-Tag = 1234]
10.0.0.1:1 ---&gt; 100.0.0.1:2
       Ext-VTag = 0

       NAT creates entry:
       +---------+--------+-----------+----------+--------+-----------+
NAT    |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |     0    |    2   | 100.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+

                               INIT[Initiate-Tag = 1234]
                101.0.0.1:1 ------------------------------&gt; 100.0.0.1:2
                                      Ext-VTag = 0


                    INIT-ACK[Initiate-tag = 5678, IP-Addr = 100.1.0.1]
                101.0.0.1:1 &lt;------------------------------ 100.0.0.1:2
                                       Int-VTag = 1234

      NAT updates first entry and creates entry for second address:
       +---------+--------+-----------+----------+--------+-----------+
NAT    |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |    5678  |    2   | 100.0.0.1 |
       |  1234   |    1   |  10.0.0.1 |    5678  |    2   | 100.1.0.1 |
       +---------+--------+-----------+----------+--------+-----------+


INIT-ACK[Initiate-Tag = 5678]
10.0.0.1:1 &lt;--- 100.0.0.1:2
         Int-VTag = 1234

       COOKIE-ECHO
10.0.0.1:1 ---&gt; 100.0.0.1:2
       ExtVTag = 5678

                                     COOKIE-ECHO
                101.0.0.1:1 ------------------------------&gt; 100.0.0.1:2
                                     Ext-VTag = 5678


                                     COOKIE-ACK
                101.0.0.1:1 &lt;------------------------------ 100.0.0.1:2
                                     Int-VTag = 1234

          COOKIE-ACK
10.0.0.1:1 &lt;--- 100.0.0.1:2
         Int-VTag = 1234
</pre></div>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12.3"></a><h3>12.3.&nbsp;
Multihomed client and server</h3>

<p>

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                      +-------+
             /--------| NAT 1 |--------\       /--\/--\
+------+    /         +-------+         \     /        \     +--------+
| Host |====                             ====| Internet |====| Host B |
|   A  |    \         +-------+         /     \        /     +--------+
+------+     \--------| NAT 2 |--------/       \--/\--/
                      +-------+

       +---------+--------+-----------+----------+--------+-----------+
NAT 1  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+--- -------+----------+--------+-----------+

 INIT[Initiate-Tag = 1234]
10.0.0.1:1 --------&gt; 100.0.0.1:2
         Ext-VTag = 0

      NAT 1 creates entry:
       +---------+--------+-----------+----------+--------+-----------+
NAT 1  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |     0    |    2   | 100.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+


                                 INIT[Initiate-Tag = 1234]
                     101.0.0.1:1 -------------------------&gt; 100.0.0.1:2
                                         ExtVTag = 0


                     INIT-ACK[Initiate-Tag = 5678, IP-Addr = 100.1.0.1]
                     101.0.0.1:1 &lt;------------------------- 100.0.0.1:2
                                          Int-VTag = 1234

NAT 1 updates first entry and creates complete entry for second address:
       +---------+--------+-----------+----------+--------+-----------+
NAT 1  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |    5678  |    2   | 100.0.0.1 |
       |  1234   |    1   |  10.0.0.1 |    5678  |    2   | 100.1.0.1 |
       +---------+--------+-----------+----------+--------+-----------+


  INIT-ACK[Initiate-Tag = 5678]
10.0.0.1:1 &lt;---------100.0.0.1:2
            Int-VTag = 1234

          COOKIE-ECHO
10.0.0.1:1 --------&gt; 100.0.0.1:2
          Ext-VTag = 5678

                                         COOKIE-ECHO
                        101.0.0.1:1 ----------------------&gt; 100.0.0.1:2
                                         Ext-VTag = 5678


                                          COOKIE-ACK
                        101.0.0.1:1 &lt;---------------------- 100.0.0.1:2
                                         Int-VTag = 1234

            COOKIE-ACK
10.0.0.1:1 &lt;------- 100.0.0.1:2
           Int-VTag = 1234

Host A announces the second address

ASCONF [ADD-IP,INT-VTag=1234, Ext-VTag = 5678]
10.1.0.1:1 --------&gt; 100.1.0.1:2
         Ext-VTag = 5678

      NAT 2 creates complete entry:
       +---------+--------+-----------+----------+--------+-----------+
NAT 2  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.1.0.1 |    5678  |    2   | 100.1.0.1 |
       +---------+--------+-----------+----------+--------+-----------+


                  ASCONF [ADD-IP,Int-VTag=1234, Ext-VTag = 5678]
                     101.1.0.1:1 -------------------------&gt; 100.1.0.1:2
                                        Ext-VTag = 5678

                                            ASCONF-ACK
                     101.1.0.1:1 &lt;------------------------- 100.1.0.1:2
                                           Int-VTag = 1234

          ASCONF-ACK
10.1.0.1:1 &lt;----- 100.1.0.1:2
         Int-VTag = 1234
</pre></div>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12.4"></a><h3>12.4.&nbsp;
NAT loses its state</h3>

<p>Assocation is already established between Host A and Host B. 

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                         /--\/--\
+--------+              +-----+         /        \         +--------+
| Host A | &lt;----------&gt; | NAT | &lt;----&gt; | Internet | &lt;----&gt; | Host B |
+--------+              +-----+         \        /         +--------+
                                         \--/\--/

       +---------+--------+-----------+----------+--------+-----------+
NAT A  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |    5678  |    2   | 100.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+

The NAT loses its state and obtaines a new public address.


               DATA
10.0.0.1:1 ----------&gt; 100.0.0.1:2
            Ext-VTag = 5678

                       NAT cannot find entry: sends ERROR message
  ERROR [M-Bit, NAT state missing]
10.0.0.1:1 &lt;---------- 100.0.0.1:2
          Ext-VTag = 5678


ASCONF [ADD-IP,DELETE-IP,Int-VTag=1234, Ext-VTag = 5678]
10.0.0.1:1 ----------&gt; 100.1.0.1:2
          Ext-VTag = 5678

       +---------+--------+-----------+----------+--------+-----------+
NAT A  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |    5678  |    2   | 100.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+

        ASCONF [ADD-IP,DELETE-IP,Int-VTag=1234, Ext-VTag = 5678]
                       102.1.0.1:1 -----------------------&gt; 100.1.0.1:2
                                       Ext-VTag = 5678

Host B adds new source address and deletes all former entries.

                                             ASCONF-ACK
                       102.1.0.1:1 &lt;----------------------- 100.1.0.1:2
                                            Int-VTag = 1234

               ASCONF-ACK
10.1.0.1:1 &lt;---------- 100.1.0.1:2
Int-VTag = 1234                     1

               DATA
10.0.0.1:1 ----------&gt; 100.0.0.1:2
         Ext-VTag = 5678
                                               DATA
                       102.1.0.1:1 -----------------------&gt; 100.1.0.1:2
                                       Ext-VTag = 5678
</pre></div>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12.5"></a><h3>12.5.&nbsp;
Peer-to-Peer Communication</h3>

<p>If two hosts are behind NATs, they have to get knowledge of the 
peer's public address. This can be achieved with a so-called 
rendezvous server. Afterwards the destination addresses are public, 
and the association is set up with the help of the INIT collision. 
The NAT boxes create their entries according to their internal peer's 
point of view. Therefore, NAT A's Internal-VTag and Internal-Port are
NAT B's External-VTag and External-Port, respectively. The 
naming of the verification tag in the packet flow is done from the 
sending peer's point of view.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Internal | External           External | Internal
                    |                             |
                    |          /--\/---\          |
+--------+      +-------+     /         \     +-------+      +--------+
| Host A |&lt;----&gt;| NAT A |&lt;--&gt;| Internet  |&lt;--&gt;| NAT B |&lt;----&gt;| Host B |
+--------+      +-------+     \         /     +-------+      +--------+
                    |          \--/\---/          |


NAT-Tables
       +---------+--------+-----------+----------+--------+-----------+
NAT A  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+--- -------+----------+--------+-----------+

       +---------+--------+-----------+----------+--------+-----------+
NAT B  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  v-tag  |  port  |    addr   |   v-tag  |   port |   addr    |
       +---------+--------+--- -------+----------+--------+-----------+

Host A sends INIT:

INIT[Initiate-Tag = 1234]
10.0.0.1:1 --&gt; 100.0.0.1:2
        Ext-VTag = 0

NAT A creates entry:
       +---------+--------+-----------+----------+--------+-----------+
NAT A  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  1234   |    1   |  10.0.0.1 |     0    |    2   | 100.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+

                        INIT[Initiate-Tag = 1234]
	       101.0.0.1:1 ----------------&gt; 100.0.0.1:2
                                Ext-VTag = 0

                                               NAT B processes INIT

                                         SCTP packet silently discarded

       +---------+--------+-----------+----------+--------+-----------+
NAT B  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+

                                                   Host B sends INIT:

                                              INIT[Initiate-Tag = 5678]
                                             101.0.0.1:1 &lt;-- 10.1.0.1:2
                                                         Ext-VTag = 0

                                    NAT B processes INIT:

       +---------+--------+-----------+----------+--------+-----------+
NAT B  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  5678   |    2   |  10.1.0.1 |     0    |    1   | 101.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+

                                    NAT B forwards INIT:

                          INIT[Initiate-Tag = 5678]
               101.0.0.1:1  &lt;--------------- 100.0.0.1:2
                                  Ext-VTag = 0

               NAT A processes INIT and updates entry:

               VTag != Int-VTag, but Ext-VTag == 0, find entry.
       +---------+--------+-----------+----------+--------+-----------+
NAT A  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |   1234  |   1    |  10.0.0.1 |   5678   |    2   | 100.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+

               NAT A forwards INIT:

 INIT[Initiate-tag = 5678]
10.0.0.1:1 &lt;-- 100.0.0.1:2
          Ext-VTag = 0

Host A send INIT-ACK:

INIT-ACK[Initiate-Tag = 1234]
10.0.0.1:1 --&gt; 100.0.0.1:2
      Ext-VTag = 5678


	            INIT-ACK[Initiate-Tag = 1234]
               101.0.0.1:1 ----------------&gt; 100.0.0.1:2
                             Ext-VTag = 5678

	                                     NAT B updates entry:

       +---------+--------+-----------+----------+--------+-----------+
NAT B  |  Int    |  Int   |    Priv   |   Ext    |   Ext  |    Ext    |
       |  VTag   |  Port  |    Addr   |   VTag   |   Port |    Addr   |
       +---------+--------+-----------+----------+--------+-----------+
       |  5678   |    2   |  10.1.0.1 |   1234   |   1    | 101.0.0.1 |
       +---------+--------+-----------+----------+--------+-----------+

	                                  INIT-ACK[Initiate-Tag = 1234]
                                             101.0.0.1:1 --&gt; 10.1.0.1:2
                                                    Ext-VTag = 5678

	                                             COOKIE-ECHO
                                             101.0.0.1:1 &lt;-- 10.1.0.1:2
                                                     Ext-VTag = 1234

	                      COOKIE-ECHO
               101.0.0.1:1 &lt;------------- 100.0.0.1:2
                              Ext-VTag = 1234

       COOKIE-ECHO
10.0.0.1:1 &lt;-- 100.0.0.1:2
       Ext-VTag = 1234

       COOKIE-ACK
10.0.0.1:1 --&gt; 100.0.0.1:2
       Ext-VTag = 5678

                              COOKIE-ACK
               101.0.0.1:1 ----------------&gt; 100.0.0.1:2
                              Ext-VTag = 5678

                                                    COOKIE-ACK
                                             101.0.0.1:1 --&gt; 10.1.0.1:2
                                                   Ext-VTag = 5678
</pre></div>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
IANA Considerations</h3>

<p>TBD
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
Security considerations</h3>

<p>State maintenance within a NAT is always a subject of possible
Denial Of Service attacks. This document recommends that at
a minimum a NAT runs a timer on any SCTP state so that old
association state can be cleaned up.
</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15"></a><h3>15.&nbsp;
Acknowledgments</h3>

<p>The authors wish to thank
Qiaobing Xie,
Henning Peters,
Bryan Ford,
David Hayes,
Alfred Hines,
Dan Wing,
and Jason But
for their invaluable comments.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.16"></a><h3>16.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>16.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC0793">[RFC0793]</a></td>
<td class="author-text">Postel, J., &ldquo;<a href="http://tools.ietf.org/html/rfc793">Transmission Control Protocol</a>,&rdquo; STD&nbsp;7, RFC&nbsp;793, September&nbsp;1981 (<a href="http://www.rfc-editor.org/rfc/rfc793.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4960">[RFC4960]</a></td>
<td class="author-text">Stewart, R., &ldquo;<a href="http://tools.ietf.org/html/rfc4960">Stream Control Transmission Protocol</a>,&rdquo; RFC&nbsp;4960, September&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4960.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>16.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC1918">[RFC1918]</a></td>
<td class="author-text"><a href="mailto:yakov@cisco.com">Rekhter, Y.</a>, <a href="mailto:rgm3@is.chrysler.com">Moskowitz, R.</a>, <a href="mailto:Daniel.Karrenberg@ripe.net">Karrenberg, D.</a>, <a href="mailto:GeertJan.deGroot@ripe.net">Groot, G.</a>, and <a href="mailto:lear@sgi.com">E. Lear</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1918">Address Allocation for Private Internets</a>,&rdquo; BCP&nbsp;5, RFC&nbsp;1918, February&nbsp;1996 (<a href="http://www.rfc-editor.org/rfc/rfc1918.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Randall R. Stewart</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Researcher</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Chapin, SC  29036</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text"></td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:randall@lakerest.net">randall@lakerest.net</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Michael Tuexen</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Muenster Univ. of Applied Sciences</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Stegerwaldstr. 39</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">48565 Steinfurt</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Germany</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:tuexen@fh-muenster.de">tuexen@fh-muenster.de</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Irene Ruengeler</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Muenster Univ. of Applied Sciences</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Stegerwaldstr. 39</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">48565 Steinfurt</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Germany</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:i.ruengeler@fh-muenster.de">i.ruengeler@fh-muenster.de</a></td></tr>
</table>
</body></html>
