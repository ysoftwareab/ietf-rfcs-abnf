<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>LISP-Security (LISP-SEC)</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Definition of Terms">
<link href="#rfc.section.3" rel="Chapter" title="3 LISP-SEC Threat Model">
<link href="#rfc.section.4" rel="Chapter" title="4 Protocol Operations">
<link href="#rfc.section.5" rel="Chapter" title="5 LISP-SEC Control Messages Details">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Encapsulated Control Message LISP-SEC Extensions">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Map-Reply LISP-SEC Extensions">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 ITR Processing">
<link href="#rfc.section.5.3.1" rel="Chapter" title="5.3.1 Map-Reply Record Validation">
<link href="#rfc.section.5.3.2" rel="Chapter" title="5.3.2 PITR Processing">
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 Encrypting and Decrypting an OTK ">
<link href="#rfc.section.5.5" rel="Chapter" title="5.5 Map-Resolver Processing">
<link href="#rfc.section.5.6" rel="Chapter" title="5.6 Map-Server Processing">
<link href="#rfc.section.5.6.1" rel="Chapter" title="5.6.1 Map-Server Processing in Proxy mode">
<link href="#rfc.section.5.7" rel="Chapter" title="5.7 ETR Processing">
<link href="#rfc.section.6" rel="Chapter" title="6 Security Considerations">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Mapping System Security">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Random Number Generation">
<link href="#rfc.section.6.3" rel="Chapter" title="6.3 Map-Server and ETR Colocation">
<link href="#rfc.section.7" rel="Chapter" title="7 IANA Considerations">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 HMAC functions">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Key Wrap Functions">
<link href="#rfc.section.7.3" rel="Chapter" title="7.3 Key Derivation Functions">
<link href="#rfc.section.8" rel="Chapter" title="8 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="9 References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This memo specifies LISP-SEC, a set of security mechanisms that provide origin authentication, integrity and anti-replay protection to LISP's EID-to-RLOC mapping data conveyed via mapping lookup process.  LISP-SEC also enables verification of authorization on EID-prefix claims in Map-Reply messages." />
  <meta name="description" content="This memo specifies LISP-SEC, a set of security mechanisms that provide origin authentication, integrity and anti-replay protection to LISP's EID-to-RLOC mapping data conveyed via mapping lookup process.  LISP-SEC also enables verification of authorization on EID-prefix claims in Map-Reply messages." />
  <meta name="keywords" content="LISP; deployment" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">F.M. Maino</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">V.E. Ermagan</td>
</tr>
<tr>
<td class="left">Intended status: Experimental Protocol</td>
<td class="right">Cisco Systems</td>
</tr>
<tr>
<td class="left">Expires: January 03, 2012</td>
<td class="right">A.C. Cabellos</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Technical University of Catalonia</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">D.S. Saucez</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">O.B. Bonaventure</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Universite catholique de Louvain</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">July 02, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">LISP-Security (LISP-SEC)<br />
  <span class="filename">draft-ietf-lisp-sec-00.txt</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This memo specifies LISP-SEC, a set of security mechanisms that provide origin authentication, integrity and anti-replay protection to LISP's EID-to-RLOC mapping data conveyed via mapping lookup process.  LISP-SEC also enables verification of authorization on EID-prefix claims in Map-Reply messages.</p>
<h1><a>Requirements Language</a></h1>
<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on January 03, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Definition of Terms</a>
</li>
<li>3.   <a href="#rfc.section.3">LISP-SEC Threat Model</a>
</li>
<li>4.   <a href="#rfc.section.4">Protocol Operations</a>
</li>
<li>5.   <a href="#rfc.section.5">LISP-SEC Control Messages Details</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Encapsulated Control Message LISP-SEC Extensions</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Map-Reply LISP-SEC Extensions</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">ITR Processing</a>
</li>
<li>5.3.1.   <a href="#rfc.section.5.3.1">Map-Reply Record Validation</a>
</li>
<li>5.3.2.   <a href="#rfc.section.5.3.2">PITR Processing</a>
</li>
<li>5.4.   <a href="#rfc.section.5.4">Encrypting and Decrypting an OTK </a>
</li>
<li>5.5.   <a href="#rfc.section.5.5">Map-Resolver Processing</a>
</li>
<li>5.6.   <a href="#rfc.section.5.6">Map-Server Processing</a>
</li>
<li>5.6.1.   <a href="#rfc.section.5.6.1">Map-Server Processing in Proxy mode</a>
</li>
<li>5.7.   <a href="#rfc.section.5.7">ETR Processing</a>
</li>
<li>6.   <a href="#rfc.section.6">Security Considerations</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">Mapping System Security</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">Random Number Generation</a>
</li>
<li>6.3.   <a href="#rfc.section.6.3">Map-Server and ETR Colocation</a>
</li>
<li>7.   <a href="#rfc.section.7">IANA Considerations</a>
</li>
<li>7.1.   <a href="#rfc.section.7.1">HMAC functions</a>
</li>
<li>7.2.   <a href="#rfc.section.7.2">Key Wrap Functions</a>
</li>
<li>7.3.   <a href="#rfc.section.7.3">Key Derivation Functions</a>
</li>
<li>8.   <a href="#rfc.section.8">Acknowledgements</a>
</li>
<li>9.   <a href="#rfc.references">References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#intro" id="intro">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">The Locator/ID Separation Protocol <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a> defines a set of functions for routers to exchange information used to map from non-routable Endpoint Identifiers (EIDs) to routable Routing Locators (RLOCs). If these EID-to-RLOC mappings, carried through Map-Reply messages, are transmitted without integrity protection, an adversary can manipulate them and hijack the communication, impersonate the requested EID or mount Denial of Service or Distributed Denial of Service attacks. Also, if the Map-Reply message is transported unauthenticated, an adversarial LISP entity can overclaim an EID-prefix and maliciously redirect traffic directed to a large number of hosts. A detailed description of "overclaiming" attack is provided in <a href="#I-D.saucez-lisp-security">[I-D.saucez-lisp-security]</a>.</p>
<p id="rfc.section.1.p.2">This memo specifies LISP-SEC, a set of security mechanisms that provide origin authentication, integrity and anti-replay protection to LISP's EID-to-RLOC mapping data conveyed via mapping lookup process.  LISP-SEC also enables verification of authorization on EID-prefix claims in Map-Reply messages, ensuring that the sender of a Map-Reply that provides the location for a given EID-prefix is entitled to do so according to the EID prefix registered in the associated Map Server.  Map-Register security, including the right for a LISP entity to register an EID-prefix or to claim presence at an RLOC, is out of the scope of LISP-SEC. Additional security considerations are described in Section 6.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#terms" id="terms">Definition of Terms</a>
</h1>
<p><a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>.</p>

<ul class="empty">
<li>One-Time Key (OTK): An ephemeral randomly generated key that must be used for a single Map-Request/Map-Reply exchange.</li>
<li>
<ul class="empty">
<li>ITR-OTK: The One-Time Key generated at the ITR.</li>
<li>MS-OTK: The One-Time Key generated at the Map-Server.</li>
</ul>
<p>Encapsulated Control Message (ECM): A LISP control message that is prepended with an additional LISP header. ECM is used by ITRs to send LISP control messages to a Map-Resolver, by Map-Resolvers to forward LISP control messages to a Map-Server, and by Map-Resolvers to forward LISP control messages to an ETR.</p>
</li>
<li>Authentication Data (AD): Metadata that is included either in a LISP ECM header or in a Map-Reply message to support confidentiality, integrity protection, and verification of EID-prefix authorization.</li>
<li><ul class="empty">
<li>OTK-AD: The portion of ECM Authentication Data that contains a One-Time Key.</li>
<li>EID-AD: The portion of ECM and Map-Reply Authentication Data used for verification of EID-prefix authorization.</li>
<li>PKT-AD: The portion of Map-Reply Authentication Data used to protect the integrity of the Map-Reply message.</li>
</ul></li>
</ul>

<p>For definitions of other terms, notably Map-Request, Map-Reply, Ingress Tunnel Router (ITR), Egress Tunnel Router (ETR), Map-Server (MS) and Map-Resolver (MR) please consult the LISP specification </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#threat-model" id="threat-model">LISP-SEC Threat Model</a>
</h1>
<p id="rfc.section.3.p.1">LISP-SEC addresses the control plane threats, described in <a href="#I-D.saucez-lisp-security">[I-D.saucez-lisp-security]</a>, that target EID-to-RLOC mappings, including manipulations of Map-Request and Map-Reply messages, and malicious xTR EID overclaiming. However LISP-SEC makes two main assumptions that are not part of <a href="#I-D.saucez-lisp-security">[I-D.saucez-lisp-security]</a>. First, the LISP Mapping System is expected to deliver Map-Request messages to their intended destinations as identified by the EID. Second, no man-in-the-middle attack can be mounted within the LISP Mapping System. Furthermore, while LISP-SEC enables detection of EID prefix over claiming attacks, it assumes that Map Servers can verify the EID prefix authorization at time of registration.</p>
<p id="rfc.section.3.p.2">Accordingly to the threat model described in <a href="#I-D.saucez-lisp-security">[I-D.saucez-lisp-security]</a> LISP-SEC assumes that any kind of attack, including MITM attacks, can be mounted in the access network, outside of the boundaries of the LISP mapping system. An on-path attacker, outside of the LISP mapping service system can, for instance, hijack mapping requests and replies, spoofing the identity of a LISP node. Another example of on-path attack, called over claiming attack, can be mounted by a malicious Egress Tunnel Router (ETR), by over claiming the EID-prefixes for which it is authoritative. In this way the ETR can maliciously redirect traffic directed to a large number of hosts.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#operations" id="operations">Protocol Operations</a>
</h1>
<p id="rfc.section.4.p.1">The goal of the security mechanisms defined in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a> is to prevent unauthorized insertion of mapping data, by providing origin authentication and integrity protection for the Map-Registration, and by using the nonce to detect unsolicited Map-Reply sent by off-path attackers.</p>
<p id="rfc.section.4.p.2">LISP-SEC builds on top of the security mechanisms defined in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a> to address the threats described in <a href="#threat-model">Section 3</a> by leveraging the trust relationships existing among the LISP entities participating to the exchange of the Map-Request/Map-Reply messages. Those trust relationships are used to securely distribute a One-Time Key (OTK) that provides origin authentication, integrity and anti-replay protection to mapping data conveyed via the mapping lookup process, and that effectively prevent over claiming attacks. The processing of security parameters during the Map-Request/Map-Reply exchange is as follows:</p>
<p></p>

<ul>
<li>The ITR-OTK is generated and stored at the ITR, and securely transported to the Map-Server.</li>
<li>The Map-Server uses the ITR-OTK to compute an HMAC that protects the integrity of the mapping data provided by the Map-Server to prevent overclaiming attacks. The Map-Server also derives a new OTK (MS-OTK) that is passed to the ETR, by applying a Key Derivation Function (KDF) to the ITR-OTK.</li>
<li>The ETR uses the MS-OTK to compute an HMAC that protects the integrity of the Map-Reply sent to the ITR.</li>
<li>Finally, the ITR uses the stored ITR-OTK to verify the integrity of the mapping data provided by both the Map-Server and the ETR, and to verify that no overclaiming attacks were mounted along the path between the Map-Server and the ITR.</li>
</ul>
<p><a href="#encap">Section 5</a> provides the detailed description of the LISP-SEC control messages and their processing, while the rest of this section describes the flow of protocol operations at each entity involved in the Map-Request/Map-Reply exchange:</p>
<p></p>

<ul>
<li>The ITR, upon transmitting a Map-Request message, generates and stores an OTK (ITR-OTK). This key is included into the Encapsulated Control Message (ECM) that contains the Map-Request sent to the Map-Resolver. To provide confidentiality to the ITR-OTK over the path between the ITR and its Map-Resolver, the ITR-OTK SHOULD be encrypted using a preconfigured key shared between the ITR and the Map-Resolver, similar to the key shared between the ETR and the Map-Server in order to secure ETR registration <a href="#I-D.ietf-lisp-ms">[I-D.ietf-lisp-ms]</a>.</li>
<li>The Map-Resolver decapsulates the ECM message, decrypts the ITR-OTK, if needed, and forwards through the Mapping System the received Map-Request and the ITR-OTK, as part of a new ECM message.  As described in <a href="#map-resolver">Section 5.5</a>, the LISP Mapping System delivers the ECM to the appropriate Map-Server, as identified by the EID destination address of the Map-Request.</li>
<li>The Map-Server is configured with the location mappings and policy information for the ETR responsible for the destination EID address. Using this preconfigured information the Map-Server, after the decapsulation of the ECM message, finds the longest match EID-prefix that covers the requested EID in the received Map-Request. The Map-Server adds this EID-prefix, together with an HMAC computed using the ITR-OTK, to a new Encapsulated Control Message that contains the received Map-Request.</li>
<li>The Map-Server derives a new OTK (MS-OTK) by applying a Key Derivation Function (KDF) to the ITR-OTK. MS-OTK is included in the Encapsulated Control Message sent to the ETR. To provide MS-OTK confidentiality over the path between the Map-Server and the ETR, the MS-OTK should be encrypted using the key shared between the ETR and the Map-Server in order to secure ETR registration <a href="#I-D.ietf-lisp-ms">[I-D.ietf-lisp-ms]</a>.</li>
<li>If the Map-Server is acting in proxy mode, as specified in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>, the ETR is not involved in the generation of the Map-Reply. In this case the Map-Server generates the Map-Reply on behalf of the ETR as described below.</li>
<li>The ETR, upon receiving the Encapsulated Map-Request from the Map-Server, decrypts the MS-OTK, if needed, and originates a Map-Reply that contains the EID-to-RLOC mapping information as specified in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>.</li>
<li>The ETR computes an HMAC over the original LISP Map-Reply, keyed with MS-OTK to protect the integrity of the whole Map-Reply. The ETR also copies the EID-prefix authorization data that the Map-Server included in the Encapsulated Map-Request into the Map-Reply message.</li>
<li>The ITR, upon receiving the Map-Reply, uses the locally stored ITR-OTK to verify the integrity of the EID-prefix authorization data included in the Map-Reply by the Map-Server. The ITR computes the MS-OTK by applying the same KDF used by the Map-Server, and verifies the integrity of the Map-Reply. If the integrity checks fail, the Map-Reply MUST be discarded. Also, if the EID-prefixes claimed by the ETR in the Map-Reply are not equal or less specific than the EID-prefix authorization data inserted by the Map-Server, the ITR MUST discard the Map-Reply.</li>
</ul>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#encap" id="encap">LISP-SEC Control Messages Details</a>
</h1>
<p id="rfc.section.5.p.1">LISP-SEC metadata associated with a Map-Request is transported within the Encapsulated Control Message that contains the Map-Request.</p>
<p id="rfc.section.5.p.2">LISP-SEC metadata associated with the Map-Reply is transported within the Map-Reply itself.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Encapsulated Control Message LISP-SEC Extensions</h1>
<p id="rfc.section.5.1.p.1">LISP-SEC uses the ECM (Encapsulated Control Message) defined in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a> with Type set to 8, and S bit set to 1 to indicate that the LISP header includes Authentication Data (AD). The format of the LISP-SEC ECM Authentication Data is defined in the following figure. OTK-AD stands for One-Time Key Authentication Data and EID-AD stands for EID Authentication Data.</p>
<div id="#rfc.figure.1"></div>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     AD Type   |V|  Reserved   |        Requested HMAC ID      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\
|              OTK Length       |       OTK Encryption ID       | |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
|                       One-Time-Key Preamble ...               | |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ OTK-AD
|                   ... One-Time-Key Preamble                   | |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
~                      One-Time Key (128 bits)                  ~/
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ &lt;---+
|           EID-AD Length       |           KDF ID              |     | 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+     |
| Record Count  |    Reserved   |         EID HMAC ID           |     EID-AD
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\    |
|   Reserved    | EID mask-len  |           EID-AFI             | |   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ Rec |
~                          EID-prefix ...                       ~ |   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+/    |
~                            EID HMAC                           ~     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ &lt;---+          </pre>
<p></p>

<ul class="empty">
<li>AD Type: 1 (LISP-SEC Authentication Data)</li>
<li>V: Key Version bit. This bit is toggled when the sender switches to a new OTK wrapping key</li>
<li>Reserved: Set to 0 on transmission and ignored on receipt.</li>
<li>Requested HMAC ID: The HMAC algorithm requested by the ITR. See <a href="#itr">Section 5.3</a> for details.</li>
<li>OTK Length: The length (in bytes) of the OTK Authentication Data (OTK-AD), that contains the OTK Preamble and the OTK.</li>
<li>OTK Encryption ID: The identifier of the key wrapping algorithm used to encrypt the One-Time-Key. When a 128-bit OTK is sent unencrypted by the Map-Resolver, the OTK Encryption ID is set to NULL_KEY_WRAP_128. See <a href="#encryption">Section 5.4</a> for more details.</li>
<li>One-Time-Key Preamble: set to 0 if the OTK is not encrypted.  When the OTK is encrypted, this field may carry additional metadata resulting from the key wrapping operation. When a 128-bit OTK is sent unencrypted by Map-Resolver, the OTK Preamble is set to 0x0000000000000000 (64 bits). See <a href="#encryption">Section 5.4</a> for details.</li>
<li>One-Time-Key: the OTK encrypted (or not) as specified by OTK Encryption ID. See <a href="#encryption">Section 5.4</a> for details.</li>
<li>EID-AD Length: length (in bytes) of the EID Authentication Data (EID-AD). The ITR MUST set EID-AD Length to 4 bytes, as it only fills the KDF ID field, and all the remaining fields part of the EID-AD are not present. An EID-AD MAY contain multiple EID-records. Each EID-record is 4-byte long plus the length of the AFI-encoded EID-prefix.</li>
<li>KDF ID: Identifier of the Key Derivation Function used to derive the MS-OTK. The ITR SHOULD use this field to indicate the recommended KDF algorithm, according to local policy. The Map-Server can overwrite the KDF ID if it does not support the KDF ID recommended by the ITR. See Section 5.4 for more details.</li>
<li>Record Count: The number of records in this Map-Request message. A record is comprised of the portion of the packet that is labeled 'Rec' above and occurs the number of times equal to Record Count.</li>
<li>Reserved: Set to 0 on transmission and ignored on receipt.</li>
<li>EID HMAC ID: Identifier of the HMAC algorithm used to protect the integrity of the EID-AD. This field is filled by Map-Server that computed the EID-prefix HMAC. See Section 5.4 for more details.</li>
<li>EID mask-len: Mask length for EID-prefix.</li>
<li>EID-AFI: Address family of EID-prefix according to <a href="#RFC5226">[RFC5226]</a>
</li>
<li>EID-prefix: The Map-Server uses this field to specify the EID-prefix that the destination ETR is authoritative for, and is the longest match for the requested EID.</li>
<li>EID HMAC: HMAC of the EID-AD computed and inserted by Map-Server. Before computing the HMAC operation the EID HMAC field MUST be set to 0. The HMAC covers the entire EID-AD.</li>
</ul>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#map-reply" id="map-reply">Map-Reply LISP-SEC Extensions</a>
</h1>
<p id="rfc.section.5.2.p.1">LISP-SEC uses the Map-Reply defined in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>, with Type set to 2, and S bit set to 1 to indicate that the Map-Reply message includes Authentication Data (AD). The format of the LISP-SEC Map-Reply Authentication Data is defined in the following figure. PKT-AD is the Packet Authentication Data that covers the Map-Reply payload.</p>
<div id="#rfc.figure.2"></div>
<pre> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    AD Type    |                 Reserved                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ &lt;---+
|           EID-AD Length       |           KDF ID              |     | 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+     |
| Record Count  |    Reserved   |         EID HMAC ID           |     EID-AD
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\    |
|   Reserved    | EID mask-len  |           EID-AFI             | |   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ Rec |
~                          EID-prefix ...                       ~ |   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+/    |
~                            EID HMAC                           ~     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ &lt;---+
|         PKT-AD Length         |         PKT HMAC ID           |\  
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
~                            PKT HMAC                           ~ PKT-AD
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+/        </pre>
<p></p>

<ul class="empty">
<li>AD Type: 1 (LISP-SEC Authentication Data)</li>
<li>EID-AD Length: length (in bytes) of the EID-AD. An EID-AD MAY contain multiple EID-records. Each EID-record is 4-byte long plus the length of the AFI-encoded EID-prefix.</li>
<li>KDF ID: Identifier of the Key Derivation Function used to derive MS-OTK. See <a href="#map-server">Section 5.6</a> for more details.</li>
<li>Record Count: The number of records in this Map-Reply message.  A record is comprised of the portion of the packet that is labeled 'Rec' above and occurs the number of times equal to Record Count.</li>
<li>Reserved: Set to 0 on transmission and ignored on receipt.</li>
<li>EID HMAC ID: Identifier of the HMAC algorithm used to protect the integrity of the EID-AD. See <a href="#map-server">Section 5.6</a> for more details.</li>
<li>EID mask-len: Mask length for EID-prefix.</li>
<li>EID-AFI: Address family of EID-prefix according to <a href="#RFC5226">[RFC5226]</a>.</li>
<li>EID-prefix: This field contains an EID-prefix that the destination ETR is authoritative for, and is the longest match for the requested EID.</li>
<li>EID HMAC: HMAC of the EID-AD, as computed by the Map-Server.  Before computing the HMAC operation the EID HMAC field MUST be set to 0. The HMAC covers the entire EID-AD.</li>
<li>PKT-AD Length: length (in bytes) of the Packet Authentication Data (PKT-AD).</li>
<li>PKT HMAC ID: Identifier of the HMAC algorithm used to protect the integrity of the Map-reply Location Data.</li>
<li>PKT HMAC: HMAC of the whole Map-Reply packet, including the LISP-SEC Authentication Data. The scope of the authentication goes from the Map-Reply Type field to the PKT HMAC field included.  Before computing the HMAC operation the PKT HMAC field MUST be set to 0. See <a href="#etr">Section 5.7</a> for more details.</li>
</ul>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> <a href="#itr" id="itr">ITR Processing</a>
</h1>
<p id="rfc.section.5.3.p.1">Upon creating a Map-Request, the ITR generates a random ITR-OTK that is stored locally, together with the nonce generated as specified in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>.</p>
<p id="rfc.section.5.3.p.2">The Map-Request MUST be encapsulated in an ECM, with the S-bit set to 1, to indicate the presence of Authentication Data. If the ITR and the Map-Resolver are configured with a shared key, the ITR-OTK confidentiality SHOULD be protected by wrapping the ITR-OTK with the algorithm specified by the OTK Encryption ID field. See <a href="#encryption">Section 5.4</a> for further details on OTK encryption.</p>
<p id="rfc.section.5.3.p.3">The Requested HMAC ID field contains the suggested HMAC algorithm to be used by the Map-Server and the ETR to protect the integrity of the ECM Authentication data and of the Map-Reply.</p>
<p id="rfc.section.5.3.p.4">The KDF ID field, specifies the suggested key derivation function to be used by the Map-Server to derive the MS-OTK.</p>
<p id="rfc.section.5.3.p.5">The EID-AD length is set to 4 bytes, since the Authentication Data does not contain EID-prefix Authentication Data, and the EID-AD contains only the KDF ID field.</p>
<p id="rfc.section.5.3.p.6">In response to an encapsulated Map-Request that has the S-bit set, an ITR MUST receive a Map-Reply with the S-bit set, that includes an EID-AD and a PKT-AD. If the Map-Reply does not include both ADs, the ITR MUST discard it. In response to an encapsulated Map-Request with S-bit set to 0, the ITR expects a Map-Reply with S-bit set to 0, and the ITR SHOULD discard the Map-Reply if the S-bit is set.</p>
<p id="rfc.section.5.3.p.7">Upon receiving a Map-Reply, the ITR must verify the integrity of both the EID-AD and the PKT-AD, and MUST discard the Map-Reply if one of the integrity checks fails.</p>
<p id="rfc.section.5.3.p.8">The integrity of the EID-AD is verified using the locally stored ITR-OTK to re-compute the HMAC of the EID-AD using the algorithm specified in the EID HMAC ID field. If the EID HMAC ID field does not match the Requested HMAC ID the ITR SHOULD discard the Map-Reply and send, at the first opportunity it needs to, a new Map-Request with a different Requested HMAC ID field, according to ITR's local policy.  The ITR MUST set the EID HMAC ID field to 0 before computing the HMAC.</p>
<p id="rfc.section.5.3.p.9">To verify the integrity of the PKT-AD, first the MS-OTK is derived from the locally stored ITR-OTK using the algorithm specified in the KDF ID field. This is because the PKT-AD is generated by the ETR using the MS-OTK. If the KDF ID in the Map-Reply does not match the KDF ID requested in the Map-Request, the ITR SHOULD discard the Map-Reply and send, at the first opportunity it needs to, a new Map-Request with a different KDF ID, according to ITR's local policy. The derived MS-OTK is then used to re-compute the HMAC of the PKT-AD using the Algorithm specified in the PKT HMAC ID field. If the PKT HMAC ID field does not match the Requested HMAC ID the ITR SHOULD discard the Map-Reply and send, at the first opportunity it needs to, a new Map-Request with a different Requested HMAC ID according to ITR's local policy.</p>
<p id="rfc.section.5.3.p.10">Each individual Map-Reply EID-record is considered valid only if: (1) both EID-AD and PKT-AD are valid, and (2) the intersection of the EID-prefix in the Map-Reply EID-record with one of the EID-prefixes contained in the EID-AD is not empty. After identifying the Map-Reply record as valid, the ITR sets the EID-prefix in the Map-Reply record to the value of the intersection set computed before, and adds the Map-Reply EID-record to its EID-to-RLOC cache, as described in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>. An example of Map-Reply record validation is provided in <a href="#validation">Section 5.3.1</a>.</p>
<p id="rfc.section.5.3.p.11">The ITR SHOULD send SMR triggered Map Requests over the mapping system in order to receive a secure Map-Reply. If an ITR accepts piggybacked Map-Replies, it SHOULD also send a Map-Request over the mapping system in order to securely verify the piggybacked Map-Reply.</p>
<p></p>
<h1 id="rfc.section.5.3.1">
<a href="#rfc.section.5.3.1">5.3.1.</a> <a href="#validation" id="validation">Map-Reply Record Validation</a>
</h1>
<p id="rfc.section.5.3.1.p.1">The payload of a Map-Reply may contain multiple EID-records. The whole Map-Reply is signed by the ETR, with the PKT HMAC, to provide integrity protection and origin authentication to the EID-prefix records claimed by the ETR. The Authentication Data field of a Map-Reply may contain multiple EID-records in the EID-AD. The EID-AD is signed by the Map-Server, with the EID HMAC, to provide integrity protection and origin authentication to the EID-prefix records inserted by the Map-Server.</p>
<p id="rfc.section.5.3.1.p.2">Upon receiving a Map-Reply with the S-bit set, the ITR first checks the validity of both the EID HMAC and of the PKT-AD HMAC. If either one of the HMACs is not valid, a log message is issued and the Map-Reply is not processed any further. If both HMACs are valid, the ITR proceeds with validating each individual EID-record claimed by the ETR by computing the intersection of each one of the EID-prefix contained in the payload of the Map-Reply with each one of the EID-prefixes contained in the EID-AD. An EID-record is valid only if at least one of the intersections is not the empty set.</p>
<p id="rfc.section.5.3.1.p.3">For instance, the Map-Reply payload contains 3 mapping record EID-prefixes:</p>

<ul class="empty">
<li>1.1.1.0/24</li>
<li>1.1.2.0/24</li>
<li>1.2.0.0/16</li>
</ul>

<p>The EID-AD contains two EID-prefixes: </p>

<ul class="empty">
<li>1.1.2.0/24</li>
<li>1.2.3.0/24</li>
</ul>

<p>The EID-record with EID-prefix 1.1.1.0/24 is not processed since it is not included in any of the EID-ADs signed by the Map-Server. A log message is issued.</p>
<p id="rfc.section.5.3.1.p.4">The EID-record with EID-prefix 1.1.2.0/24 is stored in the map-cache because it matches the second EID-prefix contained in the EID-AD.</p>
<p id="rfc.section.5.3.1.p.5">The EID-record with EID-prefix 1.2.0.0/16 is not processed since it is not included in any of the EID-ADs signed by the Map-Server. A log message is issued. In this last example the ETR is trying to over claim the EID-prefix 1.2.0.0/16, but the Map-Server authorized only 1.2.3.0/24, hence the EID-record is discarded.</p>
<h1 id="rfc.section.5.3.2">
<a href="#rfc.section.5.3.2">5.3.2.</a> <a href="#pitr" id="pitr">PITR Processing</a>
</h1>
<p id="rfc.section.5.3.2.p.1">The processing performed by a PITR is equivalent to the processing of an ITR. However, if the PITR is directly connected to the ALT, the PITR performs the functions of both the ITR and the Map-Resolver forwarding the Map-Request encapsulated in an ECM header that includes the Authentication Data fields as described in <a href="#map-resolver">Section 5.5</a>.</p>
<h1 id="rfc.section.5.4">
<a href="#rfc.section.5.4">5.4.</a> <a href="#encryption" id="encryption">Encrypting and Decrypting an OTK </a>
</h1>
<p id="rfc.section.5.4.p.1">MS-OTK confidentiality is required in the path between the Map-Server and the ETR, the MS-OTK SHOULD be encrypted using the preconfigured key shared between the Map-Server and the ETR for the purpose of securing ETR registration <a href="#I-D.ietf-lisp-ms">[I-D.ietf-lisp-ms]</a>. Similarly, if ITR-OTK confidentiality is required in the path between the ITR and the Map-Resolver, the ITR-OTK SHOULD be encrypted with a key shared between the ITR and the Map-Resolver.</p>
<p id="rfc.section.5.4.p.2">The OTK is encrypted using the algorithm specified in the OTK Encryption ID field. When the AES Key Wrap algorithm is used to encrypt a 128-bit OTK, according to [RFC3339], the AES Key Wrap Initialization Value MUST be set to 0xA6A6A6A6A6A6A6A6 (64 bits). The output of the AES Key Wrap operation is 192-bit long. The most significant 64-bit are copied in the One-Time Key Preamble field, while the 128 less significant bits are copied in the One-Time Key field of the LISP-SEC Authentication Data.</p>
<p id="rfc.section.5.4.p.3">When decrypting an encrypted OTK the receiver MUST verify that the Initialization Value resulting from the AES Key Wrap decryption operation is equal to 0xA6A6A6A6A6A6A6A6. If this verification fails the receiver MUST discard the entire message.</p>
<p id="rfc.section.5.4.p.4">When a 128-bit OTK is sent unencrypted the OTK Encryption ID is set to NULL_KEY_WRAP_128, and the OTK Preamble is set to 0x0000000000000000 (64 bits).</p>
<h1 id="rfc.section.5.5">
<a href="#rfc.section.5.5">5.5.</a> <a href="#map-resolver" id="map-resolver">Map-Resolver Processing</a>
</h1>
<p id="rfc.section.5.5.p.1">Upon receiving an encapsulated Map-Request with the S-bit set, the Map-Resolver decapsulates the ECM message. The ITR-OTK, if encrypted, is decrypted as specified in <a href="#encryption">Section 5.4</a>.</p>
<p id="rfc.section.5.5.p.2">The Map-Resolver, as specified in <a href="#I-D.ietf-lisp-ms">[I-D.ietf-lisp-ms]</a>, originates a new ECM header with the S-bit set, that contains the unencrypted ITR-OTK, as specified in <a href="#encryption">Section 5.4</a>, and the other data derived from the ECM Authentication Data of the received encapsulated Map-Request.</p>
<p id="rfc.section.5.5.p.3">The Map-Resolver then forwards the received Map-Request, encapsulated in the new ECM header that includes the newly computed Authentication Data fields.</p>
<h1 id="rfc.section.5.6">
<a href="#rfc.section.5.6">5.6.</a> <a href="#map-server" id="map-server">Map-Server Processing</a>
</h1>
<p id="rfc.section.5.6.p.1">Upon receiving an ECM encapsulated Map-Request with the S-bit set, the Map-Server process the Map-Request according to the value of the S-bit contained in the Map-Register sent by the ETR during registration.</p>
<p id="rfc.section.5.6.p.2">If the S-bit contained in the Map-Register was clear the Map-Server decapsulates the ECM and generates a new ECM encapsulated Map-Request that does not contain an ECM Authentication Data, as specified in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>. The Map-Server does not perform any further LISP-SEC processing.</p>
<p id="rfc.section.5.6.p.3">If the S-bit contained in the Map-Register was set the Map-Server decapsulates the ECM and generates a new ECM Authentication Data. The Authentication Data includes the OTK-AD and the EID-AD, that contains EID-prefix authorization information, that are ultimately sent to the requesting ITR.</p>
<p id="rfc.section.5.6.p.4">The Map-Server updates the OTK-AD by deriving a new OTK (MS-OTK) from the ITR-OTK received with the Map-Request. MS-OTK is derived applying the key derivation function specified in the KDF ID field. If the algorithm specified in the KDF ID field is not supported, the Map-Server uses a different algorithm to derive the key and updates the KDF ID field accordingly.</p>
<p id="rfc.section.5.6.p.5">The Map-Server and the ETR MUST be configured with a shared key for mapping registration according to <a href="#I-D.ietf-lisp-ms">[I-D.ietf-lisp-ms]</a>. If MS-OTK confidentiality is required, then the MS-OTK SHOULD be encrypted, by wrapping the MS-OTK with the algorithm specified by the OTK Encryption ID field as specified in <a href="#encryption">Section 5.4</a>.</p>
<p id="rfc.section.5.6.p.6">The Map-Server includes in the EID-AD the longest match registered EID-prefix for the destination EID, and an HMAC of this EID-prefix.  The HMAC is keyed with the ITR-OTK contained in the received ECM Authentication Data, and the HMAC algorithm is chosen according to the Requested HMAC ID field. If The Map-Server does not support this algorithm, the Map-Server uses a different algorithm and specifies it in the EID HMAC ID field. The scope of the HMAC operation covers the entire EID-AD, from the EID-AD Length field to the EID HMAC field, which must be set to 0 before the computation.</p>
<p id="rfc.section.5.6.p.7">The Map-Server then forwards the updated ECM encapsulated Map-Request, that contains the OTK-AD, the EID-AD, and the received Map-Request to an authoritative ETR as specified in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>.</p>
<h1 id="rfc.section.5.6.1">
<a href="#rfc.section.5.6.1">5.6.1.</a> <a href="#proxy" id="proxy">Map-Server Processing in Proxy mode</a>
</h1>
<p id="rfc.section.5.6.1.p.1">If the Map-Server is in proxy mode, it generates a Map-Reply, as specified in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>, with the S-bit set to 1. The Map-Reply includes the Authentication Data that contains the EID-AD, computed as specified in <a href="#map-server">Section 5.6</a>, as well as the PKT-AD computed as specified in <a href="#etr">Section 5.7</a>.</p>
<h1 id="rfc.section.5.7">
<a href="#rfc.section.5.7">5.7.</a> <a href="#etr" id="etr">ETR Processing</a>
</h1>
<p id="rfc.section.5.7.p.1">Upon receiving an encapsulated Map-Request with the S-bit set, the ETR decapsulates the ECM message. The OTK field, if encrypted, is decrypted as specified in <a href="#encryption">Section 5.4</a> to obtain the unencrypted MS-OTK.</p>
<p id="rfc.section.5.7.p.2">The ETR then generates a Map-Reply as specified in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a> and includes an Authentication Data that contains the EID-AD, as received in the encapsulated Map-Request, as well as the PKT-AD.</p>
<p id="rfc.section.5.7.p.3">The EID-AD is copied from the Authentication Data of the received encapsulated Map-Request.</p>
<p id="rfc.section.5.7.p.4">The PKT-AD contains the HMAC of the whole Map-Reply packet, keyed with the MS-OTK and computed using the HMAC algorithm specified in the Requested HMAC ID field of the received encapsulated Map-Request. If the ETR does not support the Requested HMAC ID, it uses a different algorithm and updates the PKT HMAC ID field accordingly. The scope of the HMAC operation covers the entire PKT-AD, from the Map-Reply Type field to the PKT HMAC field, which must be set to 0 before the computation.</p>
<p id="rfc.section.5.7.p.5">Finally the ETR sends the Map-Reply to the requesting ITR as specified in <a href="#I-D.ietf-lisp">[I-D.ietf-lisp]</a>.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p></p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> <a href="#mapping-system" id="mapping-system">Mapping System Security</a>
</h1>
<p id="rfc.section.6.1.p.1">The LISP-SEC threat model described in <a href="#threat-model">Section 3</a>, assumes that the LISP Mapping System is working properly and eventually delivers Map-Request messages to a Map-Server that is authoritative for the requested EID.</p>
<p id="rfc.section.6.1.p.2">Security is not yet embedded in LISP+ALT but BGP route filtering SHOULD be deployed in the ALT infrastructure to enforce proper routing in the mapping system. The SIDR working group is currently addressing prefix and route advertisement authorization and authentication for BGP. While following SIDR recommendations in the global Internet will take time, applying these recommendations to the ALT, which relies on BGP, should be less complex, as ALT is currently small and with a limited number of operators. Ultimately, deploying the SIDR recommendations in ALT further ensures that the fore mentioned assumption is true.</p>
<p id="rfc.section.6.1.p.3">It is also assumed that no man-in-the-middle attack can be carried out against the ALT router to ALT router tunnels, and that the information included into the Map-Requests, in particular the OTK, cannot be read by third-party entities. It should be noted that the integrity of the Map-Request in the ALT is protected by BGP authentication, and that in order to provide OTK confidentiality in the ALT mapping system the ALT router to ALT router tunnels MAY be deployed using IPsec (ESP).</p>
<p id="rfc.section.6.1.p.4">Map-Register security, including the right for a LISP entity to register an EID-prefix or to claim presence at an RLOC, is out of the scope of LISP-SEC.</p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> <a href="#random" id="random">Random Number Generation</a>
</h1>
<p id="rfc.section.6.2.p.1">The ITR-OTK MUST be generated by a properly seeded pseudo-random (or strong random) source. See <a href="#RFC4086">[RFC4086]</a> for advice on generating security-sensitive random data</p>
<h1 id="rfc.section.6.3">
<a href="#rfc.section.6.3">6.3.</a> <a href="#colocation" id="colocation">Map-Server and ETR Colocation</a>
</h1>
<p id="rfc.section.6.3.p.1">If the Map-Server and the ETR are colocated, LISP-SEC does not provide protection from overclaiming attacks mounted by the ETR.  However, in this particular case, since the ETR is within the trust boundaries of the Map-Server, ETR's overclaiming attacks are not included in the threat model.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#IANA" id="IANA">IANA Considerations</a>
</h1>
<p></p>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> <a href="#HMAC" id="HMAC">HMAC functions</a>
</h1>
<p id="rfc.section.7.1.p.1">The following HMAC ID values are defined by this memo for use as Requested HMAC ID, EID HMAC ID, and PKT HMAC ID in the LISP-SEC Authentication Data:</p>
<div id="#rfc.figure.3"></div>
<pre>
Name                     Number        Defined In
-------------------------------------------------
NONE                     0           
AUTH-HMAC-SHA-1-160      1             [RFC2104]
AUTH-HMAC-SHA-256-128    2             [RFC4634]

values 2-65535 are reserved to IANA.</pre>
<p></p>
<p id="rfc.section.7.1.p.3">AUTH-HMAC-SHA-1-160 MUST be supported, AUTH-HMAC-SHA-256-128 should be supported.</p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> <a href="#wrap" id="wrap">Key Wrap Functions</a>
</h1>
<p id="rfc.section.7.2.p.1">The following OTK Encryption ID values are defined by this memo for use as OTK key wrap algorithms ID in the LISP-SEC Authentication Data:</p>
<div id="#rfc.figure.4"></div>
<pre>
Name                     Number        Defined In
-------------------------------------------------
NULL-KEY-WRAP-128        1           
AES-KEY-WRAP-128         2             [RFC3394]

values 0 and 3-65535 are reserved to IANA.</pre>
<p id="rfc.section.7.2.p.2">NULL-KEY-WRAP-128, and AES-KEY-WRAP-128 MUST be supported.</p>
<p id="rfc.section.7.2.p.3">NULL-KEY-WRAP-128 is used to carry an unencrypted 128-bit OTK, with a 64-bit preamble set to 0x0000000000000000 (64 bits).</p>
<h1 id="rfc.section.7.3">
<a href="#rfc.section.7.3">7.3.</a> <a href="#kdf" id="kdf">Key Derivation Functions</a>
</h1>
<p id="rfc.section.7.3.p.1">The following KDF ID values are defined by this memo for use as KDF ID in the LISP-SEC Authentication Data:</p>
<div id="#rfc.figure.5"></div>
<pre>
Name                     Number        Defined In
-------------------------------------------------
NONE                     0           
HKDF-SHA1-128            1             [RFC5869]

values 2-65535 are reserved to IANA.</pre>
<p id="rfc.section.7.3.p.2">HKDF-SHA1-128 MUST be supported</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#Acknowledgements" id="Acknowledgements">Acknowledgements</a>
</h1>
<p id="rfc.section.8.p.1">The authors would like to acknowledge Pere Monclus, Dave Meyer, Dino Farinacci, Brian Weis, David McGrew, Darrel Lewis and Landon Curt Noll for their valuable suggestions provided during the preparation of this document.</p>
<h1 id="rfc.references">
<a href="#rfc.references">9.</a> References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.ietf-lisp">[I-D.ietf-lisp]</b></td>
<td class="top">
<a>Farinacci, D</a>, <a>Fuller, V</a>, <a>Meyer, D</a> and <a>D Lewis</a>, "<a href="http://tools.ietf.org/html/draft-ietf-lisp-14">Locator/ID Separation Protocol (LISP)</a>", Internet-Draft draft-ietf-lisp-14, June 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-lisp-interworking">[I-D.ietf-lisp-interworking]</b></td>
<td class="top">
<a>Lewis, D</a>, <a>Meyer, D</a>, <a>Farinacci, D</a> and <a>V Fuller</a>, "<a href="http://tools.ietf.org/html/draft-ietf-lisp-interworking-01">Interworking LISP with IPv4 and IPv6</a>", Internet-Draft draft-ietf-lisp-interworking-01, August 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-lisp-ms">[I-D.ietf-lisp-ms]</b></td>
<td class="top">
<a>Fuller, V</a> and <a>D Farinacci</a>, "<a href="http://tools.ietf.org/html/draft-ietf-lisp-ms-09">LISP Map Server</a>", Internet-Draft draft-ietf-lisp-ms-09, June 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.saucez-lisp-security">[I-D.saucez-lisp-security]</b></td>
<td class="top">
<a>Saucez, D</a>, <a>Iannone, L</a> and <a>O Bonaventure</a>, "<a href="http://tools.ietf.org/html/draft-saucez-lisp-security-03">LISP Security Threats</a>", Internet-Draft draft-saucez-lisp-security-03, March 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5226">[RFC5226]</b></td>
<td class="top">
<a>Narten, T.</a> and <a>H. Alvestrand</a>, "<a href="http://tools.ietf.org/html/rfc5226">Guidelines for Writing an IANA Considerations Section in RFCs</a>", BCP 26, RFC 5226, May 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4086">[RFC4086]</b></td>
<td class="top">
<a>Eastlake, D.</a>, <a>Schiller, J.</a> and <a>S. Crocker</a>, "<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>", BCP 106, RFC 4086, June 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2104">[RFC2104]</b></td>
<td class="top">
<a href="mailto:hugo@watson.ibm.com" title="IBM, T.J. Watson Research Center">Krawczyk, H.</a>, <a href="mailto:mihir@cs.ucsd.edu" title="University of California at San Diego, Dept of Computer Science and Engineering">Bellare, M.</a> and <a href="mailto:canetti@watson.ibm.com" title="IBM T.J. Watson Research Center">R. Canetti</a>, "<a href="http://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>", RFC 2104, February 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3394">[RFC3394]</b></td>
<td class="top">
<a>Schaad, J.</a> and <a>R. Housley</a>, "<a href="http://tools.ietf.org/html/rfc3394">Advanced Encryption Standard (AES) Key Wrap Algorithm</a>", RFC 3394, September 2002.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5869">[RFC5869]</b></td>
<td class="top">
<a>Krawczyk, H.</a> and <a>P. Eronen</a>, "<a href="http://tools.ietf.org/html/rfc5869">HMAC-based Extract-and-Expand Key Derivation Function (HKDF)</a>", RFC 5869, May 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Fabio Maino</span> 
	  <span class="n hidden">
		<span class="family-name">Maino</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  <span>170 Tasman Drive</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">California</span> 
		<span class="code">95134</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:fmaino@cisco.com">fmaino@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Vina Ermagan</span> 
	  <span class="n hidden">
		<span class="family-name">Ermagan</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  <span>170 Tasman Drive</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">California</span> 
		<span class="code">95134</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:vermagan@cisco.com">vermagan@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Albert Cabellos</span> 
	  <span class="n hidden">
		<span class="family-name">Cabellos</span>
	  </span>
	</span>
	<span class="org vcardline">Technical University of Catalonia</span>
	<span class="adr">
	  <span>c/ Jordi Girona s/n</span>

	  <span class="vcardline">
		<span class="locality">Barcelona</span>,  
		<span class="region"></span>
		<span class="code">08034</span>
	  </span>
	  <span class="country-name vcardline">Spain</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:acabello@ac.upc.edu">acabello@ac.upc.edu</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Damien Saucez</span> 
	  <span class="n hidden">
		<span class="family-name">Saucez</span>
	  </span>
	</span>
	<span class="org vcardline">Universite catholique de Louvain</span>
	<span class="adr">
	  <span>Place St. Barbe 2</span>

	  <span class="vcardline">
		<span class="locality">Louvain-la-Neuve</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Belgium</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:damien.saucez@uclouvain.be">damien.saucez@uclouvain.be</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Olivier Bonaventure</span> 
	  <span class="n hidden">
		<span class="family-name">Bonaventure</span>
	  </span>
	</span>
	<span class="org vcardline">Universite catholique de Louvain</span>
	<span class="adr">
	  <span>Place St. Barbe 2</span>

	  <span class="vcardline">
		<span class="locality">Louvain-la-Neuve</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Belgium</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:olivier.bonaventure@uclouvain.be">olivier.bonaventure@uclouvain.be</a></span>

  </address>
</div>

</body>
</html>