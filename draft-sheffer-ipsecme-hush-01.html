<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>HUSH: Using HUmanly memorable SHared secrets with IKEv2</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="HUSH: Using HUmanly memorable SHared secrets with IKEv2">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">Y. Sheffer</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Independent</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">S. Fluhrer</td></tr>
<tr><td class="header">Expires: March 17, 2011</td><td class="header">Cisco</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">September 13, 2010</td></tr>
</table></td></tr></table>
<h1><br />HUSH: Using HUmanly memorable SHared secrets with IKEv2<br />draft-sheffer-ipsecme-hush-01</h1>

<h3>Abstract</h3>

<p>This document defines a new mode for IKEv2, where both peers can authenticate using
      a short, humanly memorable shared secret. This mode is based on the EKE protocol.
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on March 17, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#anchor3">3.</a>&nbsp;
Overview<br />
<a href="#protocol">4.</a>&nbsp;
Protocol Sequence<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">4.1.</a>&nbsp;
The IKE_SA_INIT Exchange<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">4.2.</a>&nbsp;
The IKE_HUSH Exchange<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">4.2.1.</a>&nbsp;
Message #1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">4.2.2.</a>&nbsp;
Message #2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">4.2.3.</a>&nbsp;
Message #3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">4.2.4.</a>&nbsp;
Message #4<br />
<a href="#anchor10">5.</a>&nbsp;
Protocol Formats<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#encrypt-payload">5.1.</a>&nbsp;
Encrypt Payload<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#protect-payload">5.2.</a>&nbsp;
Protect Payload<br />
<a href="#anchor11">6.</a>&nbsp;
Cryptographic Details<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#dh-groups">6.1.</a>&nbsp;
Diffie-Hellman Groups<br />
<a href="#iana">7.</a>&nbsp;
IANA Considerations<br />
<a href="#security">8.</a>&nbsp;
Security Considerations<br />
<a href="#anchor12">9.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">10.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">10.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">10.2.</a>&nbsp;
Informative References<br />
<a href="#anchor15">Appendix&nbsp;A.</a>&nbsp;
Change Log<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">A.1.</a>&nbsp;
-01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">A.2.</a>&nbsp;
-00<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>There is strong interest in a simple method for bootstrapping an IKE
    <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> security association
    between two peers, requiring neither PKI nor AAA infrastructure. Although IKEv2 supports
    EAP-based authentication in part to provide for this capability, it has been claimed that
    the use of an extra authentication layer/protocol adds little benefit and increases
    complexity.
</p>
<p>This protocol integrates the well known EKE protocol <a class='info' href='#BM92'>[BM92]<span> (</span><span class='info'>Bellovin, S. and M. Merritt, &ldquo;Encrypted Key Exchange: Password-Based Protocols Secure Against Dictionary Attacks,&rdquo; May&nbsp;1992.</span><span>)</span></a> into IKEv2,
    to provide password-based authentication. Some of the benefits of this protocol are:
</p>
<p>
    </p>
<ul class="text">
<li>EKE is a well known protocol, which has had multiple deep cryptographic
    analyses applied to it.
</li>
<li>EKE provides the benefit of a well known, clear IPR status.
</li>
</ul><p>
    
</p>
<p>This protocol is not intended for use in enterprise-scale remote access.
    As a result, only the basic authentication capability is provided.
    Some capabilities
    typically associated with the use of passwords for remote access include: password
    change and expiry, password recovery, and enforcement of password strength policy.
</p>
<p>In this preliminary version of the protocol many issues are not yet covered, such as:
</p>
<p>
    </p>
<ul class="text">
<li>Integration with other IKE elements, e.g. optional notifications, Session Resumption...
</li>
<li>Error handling.
</li>
<li>Generation of a high-quality PSK, so that the password doesn't need to be used
    for each authentication. Secure signalling of PSK possession.
</li>
<li>Security analysis.
</li>
</ul><p>
    
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in
          <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Overview</h3>

<p>This protocol attempts to preserve the general structure of IKEv2, minimizing the number
    of new constructs and round trips, while retaining IKE's security guarantees, including
    identity protection. The resulting protocol only adds one round trip to the shared secret
    authentication mode of IKEv2.
</p>
<p>At a high level, the message exchange is as follows:
	</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

        Initiator                           Responder
        ---------                           ---------

HDR, SAi1, KEi, Ni, N(HUSH)

		    &lt;- HDR, SAr1, KEr, Nr, N(HUSH)

HDR, SK{IDi, [IDr,], SAi2, TSi, TSr, Encrypt{Yi}} -&gt;

		    &lt;- HDR, SK{IDr, Encrypt{Yr}, Protect{Nr2}}

HDR, SK{AUTH, Protect{Ni2|Nr2}}

		    &lt;- HDR, SK{AUTH, SAr2, TSi, TSr, Protect{Ni2}}

</pre></div><p>

    
</p>
<p>The changes to IKEv2 are summarized in the following list:
</p>
<p>
    </p>
<ul class="text">
<li>The regular IKE_SA_INIT exchange is followed by a new 2-round trip exchange,
    IKE_HUSH.
</li>
<li>Negotiation of the new mode using notifications in IKE_SA_INIT.
</li>
<li>Negotiation of cryptographic algorithms: the encryption algorithm,
    the integrity protection algorithm and the pseudo-random
    function are the ones
    negotiated for the IKE SA itself, while a new Diffie-Hellman group is selected
    for the HUSH exchange, by extending the SAi1/SAr1 negotiation.
</li>
<li>A new encrypted payload type, denoted Encrypt{},
    for exchanging an ephemeral public key encrypted by
    the password.
</li>
<li>A new encrypted and integrity-protected payload type, denoted Protect{},
    for exchanging nonces encrypted by the EKE shared secret.
</li>
<li>The IKE AUTH payloads provide cryptographic binding of the IKE shared
    secret with the password-based authentication.
</li>
</ul><p>
    
</p>
<a name="protocol"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Protocol Sequence</h3>

<p>The protocol consists of a slightly extended IKE_SA_INIT exchange, followed by the 4-message
    IKE_HUSH exchange.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
The IKE_SA_INIT Exchange</h3>

<p>During this exchange, the initiator sends an empty HUSH_SUPPORTED notification.
	If the responder understands this protocol and wishes to use it, it sends back
	another empty HUSH_SUPPORTED notification.
</p>
<p>In addition, this protocol defines a new transform type for the IKE protocol,
	called "EKE D-H Group". Possible transforms are the EKE groups defined in
	<a class='info' href='#dh-groups'>Section&nbsp;6.1<span> (</span><span class='info'>Diffie-Hellman Groups</span><span>)</span></a>.
	This transform type is negotiated between the initiator and responder with the usual SAi1,
	SAr1 payloads. If the initiator suspects that the responder does not support
	this protocol, it SHOULD also include a proposal that omits this transform, to allow
	the negotiation to revert to regular IKE. During successful
	negotiation, an EKE D-H Group MUST be negotiated if (and only if)
	the responder indicates support
	for this protocol.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
The IKE_HUSH Exchange</h3>

<p>This exchange consists of two message pairs, and includes all payloads normally
	contained in the IKE_AUTH exchange. These latter payloads are not described in this
	subsection, in order to focus on the new HUSH payloads.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.1"></a><h3>4.2.1.&nbsp;
Message #1</h3>

<p>The initiator computes 
</p>
<p>
          </p>
<blockquote class="text">
<p>Yi = g^x mod N,
</p>
</blockquote><p>
	
</p>
<p>where x is a randomly chosen number in the range 2 .. N-1, as defined by
	the negotiated Diffie-Hellman group. The randomly chosen number
          is the private key, and the calculated value is the corresponding public key.
          Each of the peers MUST use a
          fresh, random value for x on each run of the protocol.
</p>
<p>Note: If Elliptic Curve Diffie-Hellman is used in a future version of this protocol,
	  the corresponding additive
          group operations are to be understood.
</p>
<p>The initiator generates the Encrypt payload (<a class='info' href='#encrypt-payload'>Section&nbsp;5.1<span> (</span><span class='info'>Encrypt Payload</span><span>)</span></a>),
</p>
<p>
          </p>
<blockquote class="text">
<p>Encrypt(prf+(password, "HUSH Password"), Yi),
</p>
</blockquote><p>
        
</p>
<p>where the literal string is encoded using ASCII with no zero terminator.
        The prf+ notation is as defined in <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
        When using block ciphers, it may be necessary to pad Yi on the right, to fit
          the encryption algorithm's block size. In such cases, random padding MUST be used, and
          this randomness is critical to the security of the protocol. Randomness recommendations
          can be found in <a class='info' href='#RFC4086'>[RFC4086]<span> (</span><span class='info'>Eastlake, D., Schiller, J., and S. Crocker, &ldquo;Randomness Requirements for Security,&rdquo; June&nbsp;2005.</span><span>)</span></a>.
</p>
<p>If the password needs to be stored on the server, it is RECOMMENDED to store the
          randomized password value, i.e. prf+(password, ...), as a password-equivalent, rather than
          the cleartext password.
</p>
<p>
          If the password is non-ASCII, it SHOULD be normalized by the sender before the
          message is constructed. The normalization method is SASLprep, <a class='info' href='#RFC4013'>[RFC4013]<span> (</span><span class='info'>Zeilenga, K., &ldquo;SASLprep: Stringprep Profile for User Names and Passwords,&rdquo; February&nbsp;2005.</span><span>)</span></a>.
          Note that the password is not null-terminated.
          
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.2"></a><h3>4.2.2.&nbsp;
Message #2</h3>

<p>Similarly to Message #1, the responder picks a random private key, generates an ephemeral
	  public key Yr, encrypts it by the expanded password and includes the resulting Encrypt
	  payload in the message:
</p>
<p>
          </p>
<blockquote class="text">
<p>Encrypt(prf+(password, "HUSH Password"), Yr),
</p>
</blockquote><p>
        
</p>
<p>The responder now calculates
</p>
<p>
          </p>
<blockquote class="text">
<p>EkeSharedSecret = prf(0+, g^(x*y) mod N)
</p>
</blockquote><p>
        
</p>
<p>where the first argument to "prf" is a string of zero octets whose length
        is the output size of the base hash algorithm,
        e.g. 20 octets for HMAC-SHA1; the result is of the same length.
        This extra
        application of the pseudo-random function is the "extraction step" of
        <a class='info' href='#RFC5869'>[RFC5869]<span> (</span><span class='info'>Krawczyk, H. and P. Eronen, &ldquo;HMAC-based Extract-and-Expand Key Derivation Function (HKDF),&rdquo; May&nbsp;2010.</span><span>)</span></a>.
        
</p>
<p>
        The responder computes the encryption and authentication (integrity protection) keys: 
</p>
<p>
          </p>
<blockquote class="text">
<p>Ke2, Ka2 = prf+(EkeSharedSecret, "HUSH encryption and authentication" | IDi | IDr)
</p>
</blockquote><p>
        
</p>
<p>Now the responder can generate the Protect payload included in the message:
</p>
<p>
          </p>
<blockquote class="text">
<p>Protect(Ke2, Ka2, Nr2),
</p>
</blockquote><p>
        
</p>
<p>where Nr2 is a randomly generated binary string (nonce). Nr2 has length equal to the
          block size of the negotiated encryption algorithm for block ciphers,
          or 32 octets if this algorithm is a stream cipher.
          The responder sends this value as an Encrypt payload.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.3"></a><h3>4.2.3.&nbsp;
Message #3</h3>

<p>The initiator computes the EkeSharedSecret, Ke2 and Ka2 values as above.
</p>
<p>It then picks a random nonce Ni2, of the same format as Nr2,
	concatenates the two nonces, and generates
</p>
<p>
          </p>
<blockquote class="text">
<p>Protect(Ke2, Ka2, Ni2 | Nr2),
</p>
</blockquote><p>
        
</p>
<p>In addition, it computes
</p>
<p>
          </p>
<blockquote class="text">
<p>
      AUTH = prf(prf(Shared Secret, Ni2 | Nr2 | IDi | IDr), &lt;InitiatorSignedOctets>)
		
</p>
</blockquote><p>
        
</p>
<p>where the Shared Secret is the regular IKE shared secret,
	created by the IKE_SA_INIT exchange.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.4"></a><h3>4.2.4.&nbsp;
Message #4</h3>

<p>The responder verifies Nr2 and the received AUTH payload, and MUST terminate
	the protocol if either of them fails to verify. The responder generates
</p>
<p>
          </p>
<blockquote class="text">
<p>Protect(Ke2, Ka2, Ni2)
</p>
</blockquote><p>
        
</p>
<p>and
</p>
<p>
          </p>
<blockquote class="text">
<p>
      AUTH = prf(prf(Shared Secret, Ni2 | Nr2 | IDi | IDr), &lt;ResponderSignedOctets>)
		
</p>
</blockquote><p>
        
</p>
<p>The initiator MUST verify the Ni2 and AUTH values when receiving Message #4.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Protocol Formats</h3>

<a name="encrypt-payload"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Encrypt Payload</h3>

<p>This payload contains encrypted, but non-integrity protected, data.
	Unfortunately the simpler term "Encrypted Payload" is used by IKEv2 for a payload
	that contains encrypted and integrity-protected data.
</p>
<p>Compared to the IKE Encrypted Payload, this payload does not contain other
	embedded payloads. The payload is denoted Encrypt(key, data), and defined thus:
</p>
<p>
          <br /><hr class="insert" />
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Next Payload  |C|  RESERVED   |         Payload Length        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     Initialization Vector                     |
   |         (length is block size for encryption algorithm)       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |        Data Length            |                               ~
   |-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|  Encrypted Data               ~
   ~                                                               ~
   ~               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   ~               |                                               ~
   +-+-+-+-+-+-+-+-+      Random Padding (0-255 octets)            ~
   ~                                                               ~
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;The Encrypt Payload&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

        
</p>
<p>
	</p>
<ul class="text">
<li>Data Length is a 2 octet length of the encrypted data, exclusive of padding.
	This field itself
	is unencrypted.
</li>
<li>Random Padding MUST indeed be random and unpredictable if it is included.
	This randomness is critical to the security of the protocol.
</li>
</ul><p>
	
</p>
<a name="protect-payload"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Protect Payload</h3>

<p>This payload contains encrypted and integrity protected data.
	
</p>
<p>This payload is identical to the Encrypt Payload (<a class='info' href='#encrypt-payload'>Section&nbsp;5.1<span> (</span><span class='info'>Encrypt Payload</span><span>)</span></a>)
	with the addition of an integrity-protection ICV field.
	The payload is denoted by Protect(enc-key, integ-key, data) and defined as follows:
</p>
<p>
          <br /><hr class="insert" />
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                        1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Next Payload  |C|  RESERVED   |         Payload Length        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                     Initialization Vector                     |
   |         (length is block size for encryption algorithm)       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |        Data Length            |                               ~
   |-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|  Encrypted Data               ~
   ~                                                               ~
   ~               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   ~               |                                               ~
   +-+-+-+-+-+-+-+-+      Random Padding (0-255 octets)            ~
   ~                                                               ~
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                  Integrity Check Value (ICV)                  |
   |              (length depends on integrity algorithm)          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;The Protect Payload&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

        
</p>
<p>
	</p>
<ul class="text">
<li>The Integrity Check Value is computed over the Initialization Vector,
	Data Length, Encrypted Data and
	Random Padding (if any). The length of the field is determined by the negotiated
	integrity algorithm.
</li>
</ul><p>
	
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Cryptographic Details</h3>

<a name="dh-groups"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Diffie-Hellman Groups</h3>

<p>
Many of the commonly used Diffie Hellman groups are inappropriate for use in EKE.
Most of these groups use a generator which is not a primitive element of the group.
As a result, an attacker running a dictionary attack would be able to learn at least
1 bit of information for each decrypted password guess.
      
</p>
<p>
      Any MODP Diffie Hellman group defined for use in this protocol MUST have the following properties,
      to ensure that it does not leak a usable amount of information about the password:
      </p>
<ol class="text">
<li>The generator is a primitive element of the group.
</li>
<li>The most significant 64 bits of the prime number are 1.
</li>
<li>The group's order p is a "safe prime", i.e. (p-1)/2 is also prime.
      
</li>
</ol><p>
      
</p>
<p>
      The last requirement is related to the strength of the Diffie Hellman algorithm,
      rather than the password encryption. It also makes it easy to verify that the
      generator is primitive.
      
</p>
<p>
      We have defined the following groups. The Value column is used when negotiating the group.
      Additional groups may be defined through IANA allocation. Future non-MODP groups require
      a document to define their interaction with this protocol.
      
</p><table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left"><col align="left"><col align="left">
<tr><th align="left">Name</th><th align="left">Length</th><th align="left">Value</th><th align="left">Description</th></tr>
<tr>
<td align="left">Reserved</td>
<td align="left">&nbsp;</td>
<td align="left">0</td>
<td align="left">&nbsp;</td>
</tr>
<tr>
<td align="left">DHGROUP_EKE_2</td>
<td align="left">1024</td>
<td align="left">1</td>
<td align="left">The prime number of Group 2 <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>, with the generator 5 (decimal)</td>
</tr>
<tr>
<td align="left">DHGROUP_EKE_5</td>
<td align="left">1536</td>
<td align="left">2</td>
<td align="left">The prime number of Group 5 <a class='info' href='#RFC3526'>[RFC3526]<span> (</span><span class='info'>Kivinen, T. and M. Kojo, &ldquo;More Modular Exponential (MODP) Diffie-Hellman groups for Internet Key Exchange (IKE),&rdquo; May&nbsp;2003.</span><span>)</span></a>, g=31</td>
</tr>
<tr>
<td align="left">DHGROUP_EKE_14</td>
<td align="left">2048</td>
<td align="left">3</td>
<td align="left">The prime number of Group 14 <a class='info' href='#RFC3526'>[RFC3526]<span> (</span><span class='info'>Kivinen, T. and M. Kojo, &ldquo;More Modular Exponential (MODP) Diffie-Hellman groups for Internet Key Exchange (IKE),&rdquo; May&nbsp;2003.</span><span>)</span></a>, g=11</td>
</tr>
<tr>
<td align="left">DHGROUP_EKE_15</td>
<td align="left">3072</td>
<td align="left">4</td>
<td align="left">The prime number of Group 15 <a class='info' href='#RFC3526'>[RFC3526]<span> (</span><span class='info'>Kivinen, T. and M. Kojo, &ldquo;More Modular Exponential (MODP) Diffie-Hellman groups for Internet Key Exchange (IKE),&rdquo; May&nbsp;2003.</span><span>)</span></a>, g=5</td>
</tr>
<tr>
<td align="left">DHGROUP_EKE_16</td>
<td align="left">4096</td>
<td align="left">5</td>
<td align="left">The prime number of Group 16 <a class='info' href='#RFC3526'>[RFC3526]<span> (</span><span class='info'>Kivinen, T. and M. Kojo, &ldquo;More Modular Exponential (MODP) Diffie-Hellman groups for Internet Key Exchange (IKE),&rdquo; May&nbsp;2003.</span><span>)</span></a>, g=5</td>
</tr>
<tr>
<td align="left">Available for allocation via IANA</td>
<td align="left">&nbsp;</td>
<td align="left">6-127</td>
<td align="left">&nbsp;</td>
</tr>
<tr>
<td align="left">Reserved for private use</td>
<td align="left">&nbsp;</td>
<td align="left">128-255</td>
<td align="left">&nbsp;</td>
</tr>
</table>
<br clear="all" />

<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA Considerations</h3>

<p>TBD: one notification, one transform type, two payloads, a new exchange.
	Also a new DH group registry.
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>Will be added.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Acknowledgements</h3>

<p>Much of this protocol is derived from <a class='info' href='#I-D.sheffer-emu-eap-eke'>[I&#8209;D.sheffer&#8209;emu&#8209;eap&#8209;eke]<span> (</span><span class='info'>Sheffer, Y., Zorn, G., Tschofenig, H., and S. Fluhrer, &ldquo;An EAP Authentication Method Based on the EKE Protocol,&rdquo; August&nbsp;2010.</span><span>)</span></a>, and authors
    (and reviewers) of that draft are acknowledged.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3526">[RFC3526]</a></td>
<td class="author-text">Kivinen, T. and M. Kojo, &ldquo;<a href="http://tools.ietf.org/html/rfc3526">More Modular Exponential (MODP) Diffie-Hellman groups for Internet Key Exchange (IKE)</a>,&rdquo; RFC&nbsp;3526, May&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3526.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4306">[RFC4306]</a></td>
<td class="author-text">Kaufman, C., &ldquo;<a href="http://tools.ietf.org/html/rfc4306">Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4306, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4306.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="BM92">[BM92]</a></td>
<td class="author-text">Bellovin, S. and M. Merritt, &ldquo;Encrypted Key Exchange: Password-Based Protocols Secure Against Dictionary Attacks,&rdquo; Proc. IEEE Symp. on Research in Security and Privacy&nbsp;, May&nbsp;1992.</td></tr>
<tr><td class="author-text" valign="top"><a name="BM93">[BM93]</a></td>
<td class="author-text">Bellovin, S. and M. Merritt, &ldquo;Augmented Encrypted Key Exchange: A Password-Based Protocol Secure against
            Dictionary Attacks and Password File Compromise,&rdquo; Proc. 1st ACM Conference on Computer and Communication Security&nbsp;, 1993.</td></tr>
<tr><td class="author-text" valign="top"><a name="BMP00">[BMP00]</a></td>
<td class="author-text">Boyko, V., MacKenzie, P., and S. Patel, &ldquo;Provably Secure Password Authenticated Key Exchange Using Diffie-Hellman,&rdquo; Advances in Cryptology, EUROCRYPT 2000&nbsp;, 2000.</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.sheffer-emu-eap-eke">[I-D.sheffer-emu-eap-eke]</a></td>
<td class="author-text">Sheffer, Y., Zorn, G., Tschofenig, H., and S. Fluhrer, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-sheffer-emu-eap-eke-08.txt">An EAP Authentication Method Based on the EKE Protocol</a>,&rdquo; draft-sheffer-emu-eap-eke-08 (work in progress), August&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-sheffer-emu-eap-eke-08.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="PA97">[PA97]</a></td>
<td class="author-text">Patel, S., &ldquo;Number Theoretic Attacks On Secure Password Schemes,&rdquo; Proceedings of the 1997 IEEE Symposium on Security and Privacy&nbsp;, 1997.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4013">[RFC4013]</a></td>
<td class="author-text">Zeilenga, K., &ldquo;<a href="http://tools.ietf.org/html/rfc4013">SASLprep: Stringprep Profile for User Names and Passwords</a>,&rdquo; RFC&nbsp;4013, February&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4013.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4086">[RFC4086]</a></td>
<td class="author-text">Eastlake, D., Schiller, J., and S. Crocker, &ldquo;<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>,&rdquo; BCP&nbsp;106, RFC&nbsp;4086, June&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4086.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5869">[RFC5869]</a></td>
<td class="author-text">Krawczyk, H. and P. Eronen, &ldquo;<a href="http://tools.ietf.org/html/rfc5869">HMAC-based Extract-and-Expand Key Derivation Function (HKDF)</a>,&rdquo; RFC&nbsp;5869, May&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5869.txt">TXT</a>).</td></tr>
</table>

<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Change Log</h3>

<p>Note to RFC Editor: please remove this section before publication.
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
-01</h3>

<p>Reissued, changed the derivation of the payload encryption and authentication keys.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.2"></a><h3>A.2.&nbsp;
-00</h3>

<p>Initial version, a very rough draft.
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Yaron Sheffer</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Independent</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:yaronf.ietf@gmail.com">yaronf.ietf@gmail.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Scott Fluhrer</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1414 Massachusetts Ave.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Boxborough, MA  01719</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:sfluhrer@cisco.com">sfluhrer@cisco.com</a></td></tr>
</table>
</body></html>
