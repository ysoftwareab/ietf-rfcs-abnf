<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Routing Loop Attack using IPv6
    Automatic Tunnels: Problem Statement and Proposed Mitigations</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Routing Loop Attack using IPv6
    Automatic Tunnels: Problem Statement and Proposed Mitigations">
<meta name="keywords" content="I-D, Internet-Draft">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">G. Nakibly</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">National EW Research &amp;</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">Simulation Center</td></tr>
<tr><td class="header">Expires: May 13, 2011</td><td class="header">F. Templin</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Boeing Research &amp; Technology</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">November 9, 2010</td></tr>
</table></td></tr></table>
<h1><br />Routing Loop Attack using IPv6
    Automatic Tunnels: Problem Statement and Proposed Mitigations<br />draft-ietf-v6ops-tunnel-loops-01.txt</h1>

<h3>Abstract</h3>

<p>This document is concerned with security vulnerabilities in
      IPv6-in-IPv4 automatic tunnels. These vulnerabilities allow an attacker
      to take advantage of inconsistencies between the IPv4 routing state and
      the IPv6 routing state. The attack forms a routing loop which can be
      abused as a vehicle for traffic amplification to facilitate DoS attacks.
      The first aim of this document is to inform on this attack and its root
      causes. The second aim is to present some possible mitigation
      measures.
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on May 13, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
A Detailed Description of the Attack<br />
<a href="#anchor3">3.</a>&nbsp;
Proposed Mitigation Measures<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#address-check">3.1.</a>&nbsp;
Destination and Source Address Checks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#known-ipv6-check">3.1.1.</a>&nbsp;
Known IPv6 Prefix Check<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">3.2.</a>&nbsp;
Verification of end point existence<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#neighbor-check">3.2.1.</a>&nbsp;
Neighbor Cache Check<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#known-ipv4-check">3.2.2.</a>&nbsp;
Known IPv4 Address Check<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#address-resolution">3.2.3.</a>&nbsp;
Neighbor Reachability Check<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#operational">3.3.</a>&nbsp;
Operational Measures<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#Avoiding-shared-IPv4-link">3.3.1.</a>&nbsp;
Avoiding a Shared IPv4 Link<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#single-border-router">3.3.2.</a>&nbsp;
A Single Border Router<br />
<a href="#recommendations">4.</a>&nbsp;
Recommendations<br />
<a href="#anchor5">5.</a>&nbsp;
IANA Considerations<br />
<a href="#security">6.</a>&nbsp;
Security Considerations<br />
<a href="#acknowledge">7.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">8.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">8.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">8.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>IPv6-in-IPv4 tunnels are an essential part of many migration plans
  for IPv6.  They allow two IPv6 nodes to communicate over an IPv4-only
  network.  Automatic tunnels that use stateless address mapping (hereafter called
   "automatic tunnels") are a category of tunnels in which a tunneled packet's
   egress IPv4 address is embedded within the destination IPv6 address
   of the packet.  An automatic tunnel's
  router is a router that respectively encapsulates and decapsulates
  the IPv6 packets into and out of the tunnel.
</p>
<p>Ref. <a class='info' href='#USENIX09'>[USENIX09]<span> (</span><span class='info'>Nakibly, G. and M. Arov, &ldquo;Routing Loop Attacks using IPv6 Tunnels,&rdquo; USENIX WOOT, August&nbsp;2009.</span><span>)</span></a> pointed out the
  existence of a vulnerability in the design of IPv6 automatic tunnels.
  Tunnel routers operate on the implicit assumption that the
  destination address of an incoming IPv6 packet is always an address
  of a valid node that can be reached via the tunnel.  The assumption
  of path validity poses a denial of service risk as
  inconsistency between the IPv4 routing state and the IPv6 routing
  state allows a routing loop to be formed.
</p>
<p>An attacker can exploit this vulnerability by crafting a packet which
  is routed over a tunnel to a node that is not participating in that
  tunnel.  This node may forward the packet out of the tunnel to the
  native IPv6 network.  There the packet is routed back to the ingress
  point that forwards it back into the tunnel.  Consequently, the
  packet loops in and out of the tunnel.  The loop terminates only when
  the Hop Limit field in the IPv6 header of the packet is decremented
  to zero.
</p>
<p>Without compensating security measures in place, all IPv6 automatic
  tunnels that are based on protocol-41 encapsulation are vulnerable to
  such an attack including ISATAP <a class='info' href='#RFC5214'>[RFC5214]<span> (</span><span class='info'>Templin, F., Gleeson, T., and D. Thaler, &ldquo;Intra-Site Automatic Tunnel Addressing Protocol (ISATAP),&rdquo; March&nbsp;2008.</span><span>)</span></a>, 6to4 
  <a class='info' href='#RFC3056'>[RFC3056]<span> (</span><span class='info'>Carpenter, B. and K. Moore, &ldquo;Connection of IPv6 Domains via IPv4 Clouds,&rdquo; February&nbsp;2001.</span><span>)</span></a> and 6rd <a class='info' href='#RFC5569'>[RFC5569]<span> (</span><span class='info'>Despres, R., &ldquo;IPv6 Rapid Deployment on IPv4 Infrastructures (6rd),&rdquo; January&nbsp;2010.</span><span>)</span></a>.
</p>
<p>The aim of this document is to shed light on the
  routing loop attack and describe possible mitigation measures
  that should be considered by operators of current IPv6 automatic
  tunnels and by designers of future ones.  We note that tunnels may be
  deployed in various operational environments, e.g. service provider
  network, enterprise network, etc.  Specific issues related to the
  attack which are derived from the operational environment are not
  considered in this document.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
A Detailed Description of the Attack</h3>

<p>In this section we shall denote an IPv6 address of a node reached via
      a given tunnel by the prefix of the tunnel and an IPv4 address of the
      tunnel end point, i.e., Addr(Prefix, IPv4). Note that the IPv4 address
      may or may not be part of the prefix (depending on the specification of
      the tunnel's protocol). The IPv6 address may be dependent on additional
      bits in the interface ID, however for our discussion their exact value
      is not important.
</p>
<p>The two victims of this attack are routers - R1 and R2 - of two
      different tunnels - T1 and T2. Both routers have the capability to
      forward IPv6 packets in and out of their respective tunnels. The two
      tunnels need not be based on the same tunnel protocol. The only
      condition is that the two tunnel protocols be based on protocol-41
      encapsulation. The IPv4 address of R1 is IP1, while the prefix of its
      tunnel is Prf1. IP2 and Prf2 are the respective values for R2. We assume
      that IP1 and IP2 belong to the same address realm, i.e., they are either
      both public, or both private and belong to the same internal network.
      The following network diagram depicts the locations of the two
      routers.
</p><br /><hr class="insert" />
<a name="network"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                               #######
                               # R1  #
                               #######
                              //      \
                    T1       //        \
                 interface  //          \
            _______________//_         __\________________
           |                  |       |                   |
           |  IPv4 Network    |       |   IPv6 Network    |
           |__________________|       |___________________|
                          \\             /
                           \\           /
                     T2     \\         /
                  interface  \\       /
                               #######
                               # R2  #
                               #######


</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: The network setting of the attack&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The attack is depicted in <a class='info' href='#figattack'>Figure&nbsp;2<span> (</span><span class='info'>Routing loop attack between two tunnels' routers</span><span>)</span></a>. It is
      initiated by sending an IPv6 packet (packet 0 in <a class='info' href='#figattack'>Figure&nbsp;2<span> (</span><span class='info'>Routing loop attack between two tunnels' routers</span><span>)</span></a>) destined to a fictitious end point that
      appears to be reached via T2 and has IP1 as its IPv4 address, i.e.,
      Addr(Prf2, IP1). The source address of the packet is a T1 address with
      Prf1 as the prefix and IP2 as the embedded IPv4 address, i.e.,
      Addr(Prf1, IP2). As the prefix of the destination address is Prf2, the
      packet will be routed over the IPv6 network to T2.
</p>
<p>We assume that R2 is the packet's entry point to T2. R2 receives the
      packet through its IPv6 interface and forwards it over its T2 interface
      encapsulated with an IPv4 header having a destination address derived
      from the IPv6 destination, i.e., IP1. The source address is the address
      of R2, i.e., IP2. The packet (packet 1 in <a class='info' href='#figattack'>Figure&nbsp;2<span> (</span><span class='info'>Routing loop attack between two tunnels' routers</span><span>)</span></a>.) is routed over the IPv4 network to R1,
      which receives the packet on its IPv4 interface. It processes the packet
      as a packet that originates from one of the end nodes of T1.
</p>
<p>Since the IPv4 source address corresponds to the IPv6 source address,
      R1 will decapsulate the packet. Since the packet's IPv6 destination is
      outside of T1, R1 will forward the packet onto a native IPv6 interface.
      The forwarded packet (packet 2 in <a class='info' href='#figattack'>Figure&nbsp;2<span> (</span><span class='info'>Routing loop attack between two tunnels' routers</span><span>)</span></a>) is
      identical to the original attack packet. Hence, it is routed back to R2,
      in which the loop starts again. Note that the packet may not necessarily
      be transported from R1 over native IPv6 network. R1 may be connected to
      the IPv6 network through another tunnel.
</p><br /><hr class="insert" />
<a name="figattack"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                       R1               R2
                       |                |   0
                       |        1       |&lt;------
                       |&lt;===============|
                       |        2       |
                       |---------------&gt;|
                       |        .       |
                       |        .       |

             1  - IPv4: IP2 --&gt; IP1
                  IPv6: Addr(Prf1,IP2) --&gt; Addr(Prf2,IP1)
             0,2- IPv6: Addr(Prf1,IP2) --&gt; Addr(Prf2,IP1)

           Legend: ====&gt; - tunneled IPv6, ---&gt; - native IPv6
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Routing loop attack between two tunnels' routers&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The crux of the attack is as follows. The attacker exploits the fact
      that R2 does not know that R1 does not take part of T2 and that R1 does
      not know that R2 does not take part of T1. The IPv4 network acts as a
      shared link layer for the two tunnels. Hence, the packet is repeatedly
      forwarded by both routers. It is noted that the attack will fail when
      the IPv4 network can not transport packets between the tunnels. For
      example, when the two routers belong to different IPv4 address realms or
      when ingress/egress filtering is exercised between the routes.
</p>
<p>The loop will stop when the Hop Limit field of the packet reaches
      zero. After a single loop the Hop Limit field is decreased by the number
      of IPv6 routers on path from R1 and R2. Therefore, the number of loops
      is inversely proportional to the number of IPv6 hops between R1 and
      R2.
</p>
<p>The tunnel pair T1 and T2 may be any combination of automatic tunnel
      types, e.g., ISATAP, 6to4 and 6rd. This has the exception that both
      tunnels can not be of type 6to4, since two 6to4 routers can not belong
      to different tunnels (there is only one 6to4 tunnel in the Internet).
      For example, if the attack were to be launched on an ISATAP router (R1)
      and 6to4 relay (R2), then the destination and source addresses of the
      attack packet would be 2002:IP1:* and Prf1::0200:5EFE:IP2,
      respectively.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Proposed Mitigation Measures</h3>

<p>This section presents some possible mitigation measures for the
      attack described above. For each measure we shall discuss its advantages
      and disadvantages.
</p>
<p>The proposed measures fall under the following two categories:
</p>
<p></p>
<ul class="text">
<li>Destination and source addresses checks
</li>
<li>Verification of end point existence
</li>
<li>Operational measures
</li>
</ul>

<a name="address-check"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Destination and Source Address Checks</h3>

<p>Tunnel routers can use a source address check mitigation when they
        forward an IPv6 packet into a tunnel interface with an IPv6 source
        address that embeds one of the router's configured IPv4 addresses.
        Similarly, tunnel routers can use a destination address check
        mitigation when they receive an IPv6 packet on a tunnel interface with
        an IPv6 destination address that embeds one of the router's configured
        IPv4 addresses. These checks should correspond to both tunnels' IPv6
        address formats, regardless of the type of tunnel the router
        employs.
</p>
<p>For example, if tunnel router R1 (of any tunnel protocol) forwards
        a packet into a tunnel interface with an IPv6 source address that
        matches the 6to4 prefix 2002:IP1::/48, the router discards the packet
        if IP1 is one of its own IPv4 addresses. In a second example, if
        tunnel router R2 receives an IPv6 packet on a tunnel interface with an
        IPv6 destination address with an off-link prefix but with an interface
        identifier that matches the ISATAP address suffix ::0200:5EFE:IP2, the
        router discards the packet if IP2 is one of its own IPv4
        addresses.
</p>
<p>Hence a tunnel router can avoid the attack by performing the
        following checks:
</p>
<p></p>
<ul class="text">
<li>When the router forwards an IPv6 packet into a tunnel
            interface, it discards the packet if the IPv6 source address has
            an off-link prefix but embeds one of the router's configured IPv4
            addresses.
</li>
<li>When the router receives an IPv6 packet on a tunnel interface,
            it discards the packet if the IPv6 destination address has an
            off-link prefix but embeds one of the router's configured IPv4
            addresses.
</li>
</ul>

<p>This approach has the advantage that that no ancillary state is
        required, since checking is through static lookup in the lists of IPv4
        and IPv6 addresses belonging to the router. However, this approach has
        some inherit limitations:
</p>
<p></p>
<ul class="text">
<li>The checks incur an overhead which is proportional to the
            number of IPv4 addresses assigned to the router. If a router is
            assigned many addresses, the additional processing overhead for
            each packet may be considerable.
</li>
<li>The checks should be performed for the IPv6 address formats of
            every existing automatic IPv6 tunnel protocol (which uses
            protocol-41 encapsulation). Hence, the checks must be updated as
            new protocols are defined.
</li>
<li>Before the checks can be performed the format of the address
            must be recognized. There is no guarantee that this can be
            generally done. For example, one can not determine if an IPv6
            address is a 6rd one, hence a configuration is needed at the
            router.
</li>
<li>The checks cannot be performed if the embedded IPv4 address is
            a private one <a class='info' href='#RFC1918'>[RFC1918]<span> (</span><span class='info'>Rekhter, Y., Moskowitz, R., Karrenberg, D., Groot, G., and E. Lear, &ldquo;Address Allocation for Private Internets,&rdquo; February&nbsp;1996.</span><span>)</span></a> since it is ambiguous
            in scope. Namely, the private address may be legitimately
            allocated to another node in another routing region.
</li>
</ul>

<p>The last limitation may be relieved if the router has some
        information that allows it to unambiguously determine the scope of the
        address. The check in the following subsection is one example for
        this.
</p>
<a name="known-ipv6-check"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.1"></a><h3>3.1.1.&nbsp;
Known IPv6 Prefix Check</h3>

<p>A router may be configured with the full list of IPv6 subnet
          prefixes assigned to the tunnels attached to its current IPv4
          routing region. In such a case it can use the list to determine when
          static destination and source address checks are possible. By
          keeping track of the list of IPv6 prefixes assigned to the tunnels
          in the IPv4 routing region, a router can perform the following
          checks on an address which embeds a private IPv4 address:
</p>
<p></p>
<ul class="text">
<li>When the router forwards an IPv6 packet into its tunnel with
              a source address that embeds a private IPv4 address and matches
              an IPv6 prefix in the prefix list, it determines whether the
              packet should be discarded or forwarded by performing the source
              address check specified in <a class='info' href='#address-check'>Section&nbsp;3.1<span> (</span><span class='info'>Destination and Source Address Checks</span><span>)</span></a>.
              Otherwise, the router forwards the packet.
</li>
<li>When the router receives an IPv6 packet on its tunnel
              interface with a destination address that embeds a private IPv4
              address and matches an IPv6 prefix in the prefix list, it
              determines whether the packet should be discarded or forwarded
              by performing the destination address check specified in <a class='info' href='#address-check'>Section&nbsp;3.1<span> (</span><span class='info'>Destination and Source Address Checks</span><span>)</span></a>. Otherwise, the router forwards
              the packet.
</li>
</ul><p> The disadvantage of this approach is the administrative
          overhead for maintaining the list of IPv6 subnet prefixes associated
          with an IPv4 routing region may become unwieldy should that list be
          long and/or frequently updated.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Verification of end point existence</h3>

<p>The routing loop attack relies on the fact that a router does not
        know whether there is an end point that can reached via its tunnel
        that has the source or destination address of the packet. This
        category includes mitigation measures which aim to verify that there
        is a node which participate in the tunnel and its address corresponds
        to the packet's destination or source addresses, as appropriate.
</p>
<a name="neighbor-check"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.1"></a><h3>3.2.1.&nbsp;
Neighbor Cache Check</h3>

<p>One way to verify that an end point exists in a tunnel is by
          checking whether a valid entry exists for it in the Neighbor Cache
          of the corresponding tunnel interface. A valid entry may exist in
          the Neighbor Cache for legitimate end hosts if they generate traffic
          towards the router upon startup. For example, an initial RS/RA
          exchange to facilitate Stateless Address Auto configuration (as in
          the ISATAP case). This allows the router to keep valid Neighbor
          Cache entry for each legitimate end host in the tunnel.
</p>
<p>By keeping track of the legitimate hosts in the tunnel via the
          Neighbor Cache, a router can perform the following simple
          checks:
</p>
<p></p>
<ul class="text">
<li>When the router forwards a packet into the tunnel with an
              IPv6 destination address that matches an on-link prefix and that
              embeds the IPv4 address IP1, it discards the packet if there is
              no corresponding neighbor cache entry.
</li>
<li>When the router receives a packet on the tunnel's interface
              with an IPv6 source address that matches an on-link prefix and
              that embeds the IPv4 address IP2, it discards the packet if
              there is no corresponding neighbor cache entry.
</li>
</ul>

<p>This approach is easy to implement, and naturally leverages the
          fact that an end host must successively send RSs in order to refresh
          configuration information as on-link prefix information. However,
          this requires the router to retain entries for a duration that is at
          least as long as the router's advertised prefix lifetimes. This may
          require an implementation to adjust its garbage-collection interval
          for stale neighbor cache entries.
</p>
<p>Finally, this approach assumes that the neighbor cache will
          remain coherent and not subject to malicious attack, which must be
          confirmed based on specific deployment scenarios. One possible way
          for an attacker to subvert the neighbor cache is to send false RS
          messages with a spoofed source address.
</p>
<a name="known-ipv4-check"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.2"></a><h3>3.2.2.&nbsp;
Known IPv4 Address Check</h3>

<p>Another approach that enables a router to verify that an end host
          exists and can be reached via the tunnel is simply by
          pre-configuring the router with the set of IPv4 addresses that are
          authorized to use the tunnel. Upon this configuration the router can
          perform the following simple checks:
</p>
<p></p>
<ul class="text">
<li>When the router forwards an IPv6 packet into the tunnel
              interface with a destination address that matches an on-link
              prefix and that embeds the IPv4 address IP1, it discards the
              packet if IP1 does not belong to the configured list of IPv4
              addresses.
</li>
<li>When the router receives an IPv6 packet on the tunnel's
              interface with a source address that matches a on-link prefix
              and that embeds the IPv4 address IP2, it discards the packet if
              IP2 does not belong to the configured list of IPv4
              addresses.
</li>
</ul>

<a name="address-resolution"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.3"></a><h3>3.2.3.&nbsp;
Neighbor Reachability Check</h3>

<p>Yet another approach that allows a router to verify that an end
          host exists and can be reached via the tunnel is by performing an
          initial reachability confirmation, e.g., as specified in the second
          paragraph of Section 8.4 of <a class='info' href='#RFC5214'>[RFC5214]<span> (</span><span class='info'>Templin, F., Gleeson, T., and D. Thaler, &ldquo;Intra-Site Automatic Tunnel Addressing Protocol (ISATAP),&rdquo; March&nbsp;2008.</span><span>)</span></a>. This
          procedure parallels the address resolution specifications in Section
          7.2 of <a class='info' href='#RFC4861'>[RFC4861]<span> (</span><span class='info'>Narten, T., Nordmark, E., Simpson, W., and H. Soliman, &ldquo;Neighbor Discovery for IP version 6 (IPv6),&rdquo; September&nbsp;2007.</span><span>)</span></a>, i.e., the router maintains a
          small queue of packets waiting for reachability confirmation to
          complete. If confirmation succeeds, the router discovers that a
          legitimate neighbor responds to the address and packets may be
          forwarded to it. Otherwise, the router returns ICMP destination
          unreachable indications as specified in Section 7.2.2 of <a class='info' href='#RFC4861'>[RFC4861]<span> (</span><span class='info'>Narten, T., Nordmark, E., Simpson, W., and H. Soliman, &ldquo;Neighbor Discovery for IP version 6 (IPv6),&rdquo; September&nbsp;2007.</span><span>)</span></a>.
</p>
<a name="operational"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Operational Measures</h3>

<p>The following measures can be taken by the network operator. Their
        aim is to configure the network in such a way that the attacks can not
        take place.
</p>
<a name="Avoiding-shared-IPv4-link"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.1"></a><h3>3.3.1.&nbsp;
Avoiding a Shared IPv4 Link</h3>

<p>As noted above, the attack relies on having an IPv4 network as a
          shared link-layer between more than one tunnel. From this the
          following two mitigation measures arise:
</p>
<a name="filtering"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.1.1"></a><h3>3.3.1.1.&nbsp;
Filtering IPv4 Protocol-41 Packets</h3>

<p>In this measure a tunnel router may drop all IPv4 protocol-41
            packets received or sent over interfaces that are attached to an
            untrusted IPv4 network. This will cut-off any IPv4 network as a
            shared link. This measure has the advantage of simplicity.
            However, such a measure may not always be suitable for scenarios
            where IPv4 connectivity is essential on all interfaces.
</p>
<a name="single-tunnel"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.1.2"></a><h3>3.3.1.2.&nbsp;
Operational Avoidance of Multiple Tunnels</h3>

<p>This measure mitigates the attack by simply allowing for a
            single IPv6 tunnel to operate in a bounded IPv4 network (e.g., a
            small home IPv4 network behind a residential gateway serving as a
            tunnel router). In particular, if there are only one or a few
            tunnel routers in the IPv4 network and all participate in the same
            tunnel then there is no opportunity for perpetuating the loop.
</p>
<p>This approach has the advantage that it avoids the attack
            profile altogether without need for explicit mitigations. However,
            it requires careful configuration management which may not be
            tenable in large and/or unbounded IPv4 networks.
</p>
<a name="single-border-router"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.2"></a><h3>3.3.2.&nbsp;
A Single Border Router</h3>

<p>It is reasonable to assume that a tunnel router shall accept or
          forward tunneled packets only over its tunnel interface. It is also
          reasonable to assume that a tunnel router shall accept or forward
          IPv6 packets only over its IPv6 interface. If these two interfaces
          are physically different then the network operator can mitigate the
          attack by ensuring that the following condition holds: there is no
          path between these two interfaces that does not go through the
          tunnel router.
</p>
<p>The above condition ensures that an encapsulated packet which is
          transmitted over the tunnel interface will not get to another tunnel
          router and from there to the IPv6 interface of the first router. The
          condition also ensures the reverse direction, i.e., an IPv6 packet
          which is transmitted over the IPv6 interface will not get to another
          tunnel router and from there to the tunnel interface of the first
          router. This condition is essentially translated to a scenario in
          which the tunnel router is the only border router between the IPv6
          network and the IPv4 network to which it is attached.
</p>
<a name="recommendations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Recommendations</h3>

<p>In light of the mitigation measures proposed above we make the
      following recommendations in decreasing order:
</p>
<p></p>
<ol class="text">
<li>When possible, it is recommended that the attacks are
          operationally eliminated (as per one of the measures proposed in
          <a class='info' href='#operational'>Section&nbsp;3.3<span> (</span><span class='info'>Operational Measures</span><span>)</span></a>).
</li>
<li>For tunnel routers that keep a coherent and trusted neighbor
          cache which includes all legitimate end-points of the tunnel, we
          recommend exercising the Neighbor Cache Check.
</li>
<li>For tunnel routers that can implement the Neighbor Reachability
          Check, we recommend exercising it.
</li>
<li>For tunnels having small and static list of end-points we
          recommend exercising Known IPv4 Address Check.
</li>
<li>For all other cases we recommend the Destination and Source
          Address Checks.
</li>
</ol>

<p>As noted earlier, tunnels may be deployed in various operational
      environments. There is a possibility that other mitigation measures may
      be allowed is specific deployment scenarios. The above recommendations
      are general and do not attempt to cover such scenarios.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
IANA Considerations</h3>

<p>This document has no IANA considerations.
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>This document aims at presenting possible solutions to the routing
      loop attack which involves automatic tunnels' routers. It contains
      various checks that aim to recognize and drop specific packets that have
      strong potential to cause a routing loop. These checks do not introduce
      new security threats.
</p>
<a name="acknowledge"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Acknowledgments</h3>

<p>This work has benefited from discussions on the V6OPS, 6MAN and
      SECDIR mailing lists. Remi Despres, Christian Huitema, Dmitry Anipko,
      Dave Thaler and Fernando Gont are acknowledged for their
      contributions.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC1918">[RFC1918]</a></td>
<td class="author-text"><a href="mailto:yakov@cisco.com">Rekhter, Y.</a>, <a href="mailto:rgm3@is.chrysler.com">Moskowitz, R.</a>, <a href="mailto:Daniel.Karrenberg@ripe.net">Karrenberg, D.</a>, <a href="mailto:GeertJan.deGroot@ripe.net">Groot, G.</a>, and <a href="mailto:lear@sgi.com">E. Lear</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1918">Address Allocation for Private Internets</a>,&rdquo; BCP&nbsp;5, RFC&nbsp;1918, February&nbsp;1996 (<a href="http://www.rfc-editor.org/rfc/rfc1918.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3056">[RFC3056]</a></td>
<td class="author-text">Carpenter, B. and K. Moore, &ldquo;<a href="http://tools.ietf.org/html/rfc3056">Connection of IPv6 Domains via IPv4 Clouds</a>,&rdquo; RFC&nbsp;3056, February&nbsp;2001 (<a href="http://www.rfc-editor.org/rfc/rfc3056.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4861">[RFC4861]</a></td>
<td class="author-text">Narten, T., Nordmark, E., Simpson, W., and H. Soliman, &ldquo;<a href="http://tools.ietf.org/html/rfc4861">Neighbor Discovery for IP version 6 (IPv6)</a>,&rdquo; RFC&nbsp;4861, September&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4861.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5214">[RFC5214]</a></td>
<td class="author-text">Templin, F., Gleeson, T., and D. Thaler, &ldquo;<a href="http://tools.ietf.org/html/rfc5214">Intra-Site Automatic Tunnel Addressing Protocol (ISATAP)</a>,&rdquo; RFC&nbsp;5214, March&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5214.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5569">[RFC5569]</a></td>
<td class="author-text">Despres, R., &ldquo;<a href="http://tools.ietf.org/html/rfc5569">IPv6 Rapid Deployment on IPv4 Infrastructures (6rd)</a>,&rdquo; RFC&nbsp;5569, January&nbsp;2010 (<a href="http://www.rfc-editor.org/rfc/rfc5569.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="USENIX09">[USENIX09]</a></td>
<td class="author-text">Nakibly, G. and M. Arov, &ldquo;Routing Loop Attacks using IPv6 Tunnels,&rdquo; USENIX WOOT, August&nbsp;2009.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Gabi Nakibly</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">National EW
      Research &amp; Simulation Center</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.O. Box 2250 (630)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Haifa  31021</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Israel</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:gnakibly@yahoo.com">gnakibly@yahoo.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Fred L. Templin</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Boeing Research &amp; Technology</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.O. Box 3707 MC 7L-49</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Seattle, WA  98124</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:fltemplin@acm.org">fltemplin@acm.org</a></td></tr>
</table>
</body></html>
