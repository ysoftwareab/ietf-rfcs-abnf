<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Parsing URLs for Fun and Profit </title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Open Issues">
<link href="#rfc.section.2" rel="Chapter" title="2 Definitions">
<link href="#rfc.section.3" rel="Chapter" title="3 Parsing a URL">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Finding the scheme">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Finding the authority, path, query, and fragment">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Finding the user-info, host, and port">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Find the user name and password">
<link href="#rfc.section.4" rel="Chapter" title="4 Resolving a string relative to a base URL">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Resolving a string as a relative URL">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Resolving a string as a scheme-relative URL">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Resolving a string as an authority-relative URL">
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 Resolving a string as a path-relative URL">
<link href="#rfc.section.4.5" rel="Chapter" title="4.5 Resolving a string as a query-relative URL">
<link href="#rfc.section.4.6" rel="Chapter" title="4.6 Resolving a string as a fragment-relative URL">
<link href="#rfc.section.5" rel="Chapter" title="5 Canonicalizing a URL">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Canonicalizing a Scheme">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Canonicalizing a User-Info">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 Canonicalizing a Host">
<link href="#rfc.section.5.3.1" rel="Chapter" title="5.3.1 Host Escape Normalization">
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 Canonicalizing a Path">
<link href="#rfc.section.5.5" rel="Chapter" title="5.5 Canonicalizing a Query">
<link href="#rfc.section.5.6" rel="Chapter" title="5.6 Canonicalizing a Fragment">
<link href="#rfc.references" rel="Chapter" title="6 References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Acknowledgements">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document contains a precise specification of how browsers process URLs.  The behavior specified in this document might or might not match any particular browser, but browsers might be well-served by adopting the behavior defined herein." />
  <meta name="description" content="This document contains a precise specification of how browsers process URLs.  The behavior specified in this document might or might not match any particular browser, but browsers might be well-served by adopting the behavior defined herein." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">iri</td>
<td class="right">A. Barth</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Google, Inc.</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">April 24, 2011</td>
</tr>
<tr>
<td class="left">Expires: October 26, 2011</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Parsing URLs for Fun and Profit <br />
  <span class="filename">draft-abarth-url-01</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document contains a precise specification of how browsers process URLs.  The behavior specified in this document might or might not match any particular browser, but browsers might be well-served by adopting the behavior defined herein.</p>
<h1><a>Editorial Note (To be removed by RFC Editor)</a></h1>
<p>If you have suggestions for improving this document, please send email to <a href="mailto:public-iri@w3.org">mailto:public-iri@w3.org</a>.  Further Working Group information is available from <a href="https://tools.ietf.org/wg/iri/">https://tools.ietf.org/wg/iri/</a>.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on October 26, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Open Issues</a>
</li>
<li>2.   <a href="#rfc.section.2">Definitions</a>
</li>
<li>3.   <a href="#rfc.section.3">Parsing a URL</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Finding the scheme</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Finding the authority, path, query, and fragment</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Finding the user-info, host, and port</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Find the user name and password</a>
</li>
<li>4.   <a href="#rfc.section.4">Resolving a string relative to a base URL</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Resolving a string as a relative URL</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Resolving a string as a scheme-relative URL</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Resolving a string as an authority-relative URL</a>
</li>
<li>4.4.   <a href="#rfc.section.4.4">Resolving a string as a path-relative URL</a>
</li>
<li>4.5.   <a href="#rfc.section.4.5">Resolving a string as a query-relative URL</a>
</li>
<li>4.6.   <a href="#rfc.section.4.6">Resolving a string as a fragment-relative URL</a>
</li>
<li>5.   <a href="#rfc.section.5">Canonicalizing a URL</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Canonicalizing a Scheme</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Canonicalizing a User-Info</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">Canonicalizing a Host</a>
</li>
<li>5.3.1.   <a href="#rfc.section.5.3.1">Host Escape Normalization</a>
</li>
<li>5.4.   <a href="#rfc.section.5.4">Canonicalizing a Path</a>
</li>
<li>5.5.   <a href="#rfc.section.5.5">Canonicalizing a Query</a>
</li>
<li>5.6.   <a href="#rfc.section.5.6">Canonicalizing a Fragment</a>
</li>
<li>6.   <a href="#rfc.references">References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Acknowledgements</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Open Issues</h1>
<p id="rfc.section.1.p.1">Browsers parse URLs differently depending on which operating system they're running on.  The problem is that they want to do sensible things for file paths, but file paths look different on Windows and Unix systems.</p>
<p id="rfc.section.1.p.2">How should we handle cases where browsers disaggree with the regular expression in RFC 3986?  Currently, this document aims to describe how browsers behave, but we'll likely need to compare that to RFC 3986 at some point.  Some specific differences that have been brought up on the mailing list: </p>

<ul>
<li>http:///example.com/</li>
<li>http://example.com;</li>
</ul>

<p> </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Definitions</h1>
<p id="rfc.section.2.p.1">A control character is a character whose value is less than or equal to U+0020 (" ").</p>
<p id="rfc.section.2.p.2">A slash character is either U+???? ("/") or U+???? ("\"). TODO: There's some question as to whether this is necessary for non-file URLs.</p>
<p id="rfc.section.2.p.3">An authority terminating character is either a slash charcter, U+???? ("?"), U+???? ("#"), or U+???? (";").  TODO: Why is ";" on this list?</p>
<p id="rfc.section.2.p.4">During a parsing algorithm, the remaining string is the characters of the input that have not yet been consumed.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Parsing a URL</h1>
<p id="rfc.section.3.p.1">Given a string of characters, consume all leading and trailing control characters.</p>
<p id="rfc.section.3.p.2">Find the scheme, as described in Section ??.</p>
<p id="rfc.section.3.p.3">If the algorithm for finding the scheme determines that the URL is invalid: </p>

<ul class="empty"><li>-&gt; Abort these steps.</li></ul>

<p> </p>
<p id="rfc.section.3.p.4">If the scheme is a single upper or lower case ASCII character (TODO: Just ALPHA?): </p>

<ul class="empty"><li>-&gt; TODO: Windows drive specs!</li></ul>

<p> </p>
<p id="rfc.section.3.p.5">If the scheme is a ASCII case-insensitive match for "file": </p>

<ul class="empty"><li>-&gt; TODO: File URLs!</li></ul>

<p> </p>
<p id="rfc.section.3.p.6">If the scheme is a ASCII case-insensitive match for "mailto": </p>

<ul class="empty"><li>-&gt; TODO: I think mailto URLs are special, but more testing is required.</li></ul>

<p> </p>
<p id="rfc.section.3.p.7">If the scheme is hierarchical: </p>

<ul class="empty">
<li>-&gt; In the after-scheme, if any, find the authority, path, query, and fragment, as described in Section ??.</li>
<li>-&gt; In the authority, if any, find the user-info, host, and port, as described in Section ??.</li>
<li>-&gt; In the user-info, if any, find the user name and password, as described in Section ??.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.3.p.8">The remaining string is the path. TODO: This might not be the best approach.  We need to do more testing of data and javascript URLs.</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> Finding the scheme</h1>
<p id="rfc.section.3.1.p.1">If the remaining string does not contain a ":" character: </p>

<ul class="empty">
<li>-&gt; The URL is invalid.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.3.1.p.2">Consume characters up to, but not including, the first ":" character.  These characters are the scheme.</p>
<p id="rfc.section.3.1.p.3">Consume the ":" character.</p>
<p id="rfc.section.3.1.p.4">The remaining characters are the after-scheme.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> Finding the authority, path, query, and fragment</h1>
<p id="rfc.section.3.2.p.1">Consume any number of slash characters.</p>
<p id="rfc.section.3.2.p.2">If the remaining string does not contain any authority terminating characters: </p>

<ul class="empty">
<li>-&gt; The remaining string is the authority.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.3.2.p.3">Consume characters up to, but not including, the first authority terminating character.  The consumed characters are authority.</p>
<p id="rfc.section.3.2.p.4">If the remaining string does not contain a "?" character or a "#" character: </p>

<ul class="empty">
<li>-&gt; The remaining string is the path.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.3.2.p.5">Consume characters up to, but not including, the first "?" or "#" charcter.  The consumed characters are the path.</p>
<p id="rfc.section.3.2.p.6">If the first character of the remaining string is a "?" character: </p>

<ul class="empty">
<li>-&gt; Consume the "?" character.</li>
<li>-&gt; If the remaining string does not contain a "#" character: <ul class="empty">
<li>-&gt; The remaining string is the query.</li>
<li>-&gt; Abort these steps.</li>
</ul>
<p> </p>
</li>
<li>-&gt; Consume characters up to, but not including, the first "#" charcter.  The consumed characters are the query.</li>
</ul>

<p> </p>
<p id="rfc.section.3.2.p.7">Consume the "#" character.</p>
<p id="rfc.section.3.2.p.8">The remaining string is the fragment.</p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> Finding the user-info, host, and port</h1>
<p id="rfc.section.3.3.p.1">If the remaining string contains an "@" character: </p>

<ul class="empty">
<li>-&gt; Consume characters up to, but not including the *last* "@" character.  The consumed characters are the user-info.</li>
<li>-&gt; Consume the "@" character.</li>
</ul>

<p> </p>
<p id="rfc.section.3.3.p.2">If the remaining string does not contain an ":" character: </p>

<ul class="empty">
<li>-&gt; The remaining string is the host.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.3.3.p.3">If the first character of the remaining string is a "[" character, the remaining string contains a "]" character, and the last ":" character in the remaining string occurs before the last "]" character in the remaining string: </p>

<ul class="empty">
<li>-&gt; The remaining string is the host.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.3.3.p.4">Consume characters up to, but not including, the last ":" character.  The consumed characters are the host.</p>
<p id="rfc.section.3.3.p.5">Consume the ":" character.</p>
<p id="rfc.section.3.3.p.6">The remaining string is the port.</p>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> Find the user name and password</h1>
<p id="rfc.section.3.4.p.1">If the remaining string does not contain a ":" character: </p>

<ul class="empty">
<li>-&gt; The remaining string is the user name.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.3.4.p.2">Consume characters up to, but not including, the first ":" character.  The consumed characters are the user name.</p>
<p id="rfc.section.3.4.p.3">Consume the ":" character.</p>
<p id="rfc.section.3.4.p.4">The remaining string is the password.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Resolving a string relative to a base URL</h1>
<p id="rfc.section.4.p.1">Given a string relative-url and a ParsedURL base-url, find the scheme of relative-url.</p>
<p id="rfc.section.4.p.2">TODO: We probably need to trim leading and trailing control characters.</p>
<p id="rfc.section.4.p.3">If relative-url is an invalid URL: </p>

<ul class="empty">
<li>-&gt; The resolved URL is relative-url resolved as relative URL.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.4.p.4">If relative-url's scheme contains any characters which are not "valid scheme characters" (TODO: Define valid scheme characters): </p>

<ul class="empty">
<li>-&gt; The resolved URL is relative-url resolved as relative URL.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.4.p.5">If base-url's scheme is an ASCII case insensitive match for relative-url's scheme and the shared scheme is hierarchical: </p>

<ul class="empty">
<li>-&gt; The resolved URL is relative-url's after-scheme resolved as a relative URL.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.4.p.6">The resolved URL is relative-url parsed as an absolute URL.</p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> Resolving a string as a relative URL</h1>
<p id="rfc.section.4.1.p.1">Given a string relative-url and a ParsedURL base-url, determine the resolved URL as follows:</p>
<p id="rfc.section.4.1.p.2">TODO: If base-url's scheme is not hierarchical, we can't resolve as a relative URL.  We'll probably want to return an invalid URL.  Check what happens when resolving an empty string as a relative URL with a non-hierarchical base.</p>
<p id="rfc.section.4.1.p.3">If relative-url is empty: </p>

<ul class="empty">
<li>-&gt; The resolved URL is identical to base-url, with the fragment, if any, removed.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.4.1.p.4">If the first character of relative-url is a slash character: </p>

<ul class="empty">
<li>-&gt; If relative-url has at least two characters and the second character is also a slash character: <ul class="empty"><li>-&gt; The resolved URL is relative-url resolved as a scheme-relative URL.</li></ul>
<p> Otherwise: </p>
<ul class="empty"><li>-&gt; The resolved URL is relative-url resolved as an authority-relative URL.</li></ul>
<p> </p>
</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.4.1.p.5">If the first character of relative-url is a "?" character: </p>

<ul class="empty">
<li>-&gt; The resolved URL is relative-url resolved as a query-relative URL.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.4.1.p.6">If the first character of relative-url is a "#" character: </p>

<ul class="empty">
<li>-&gt; The resolved URL is relative-url resolved as a fragment-relative URL.</li>
<li>-&gt; Abort these steps.</li>
</ul>

<p> </p>
<p id="rfc.section.4.1.p.7">TODO: Think about the case where the relative-url is empty.</p>
<p id="rfc.section.4.1.p.8">The resolved URL is relative-url resolved as a path-relative URL.</p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> Resolving a string as a scheme-relative URL</h1>
<p id="rfc.section.4.2.p.1">Given a string relative-url and a ParsedURL base-url, let resolved-url be </p>

<ul>
<li>base-url's scheme</li>
<li>concatenated with ":",</li>
<li>concatenated with relative-url.</li>
</ul>

<p> </p>
<p id="rfc.section.4.2.p.2">The resolved URL is resolved-url parsed as an absolute URL.</p>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> Resolving a string as an authority-relative URL</h1>
<p id="rfc.section.4.3.p.1">Given a string relative-url and a ParsedURL base-url, let resolved-url be </p>

<ul>
<li>base-url's scheme</li>
<li>concatenated with "://",</li>
<li>concatenated with base-url's authority,</li>
<li>concatenated with relative-url.</li>
</ul>

<p> </p>
<p id="rfc.section.4.3.p.2">The resolved URL is resolved-url parsed as an absolute URL.</p>
<h1 id="rfc.section.4.4">
<a href="#rfc.section.4.4">4.4.</a> Resolving a string as a path-relative URL</h1>
<p id="rfc.section.4.4.p.1">TODO: Can the first character of relative-url be a slash character at this point?</p>
<p id="rfc.section.4.4.p.2">TODO: Can we assume base-url is canonicalized here so that it always has at least one "/" character?</p>
<p id="rfc.section.4.4.p.3">Let the directory-name be the characters of the base-url's path up to and including the last slash character.</p>
<p id="rfc.section.4.4.p.4">Let resolved-url be </p>

<ul>
<li>base-url's scheme</li>
<li>concatenated with "://",</li>
<li>concatenated with base-url's authority,</li>
<li>concatenated with directory-name.</li>
<li>concatenated with relative-url.</li>
</ul>

<p> </p>
<p id="rfc.section.4.4.p.5">The resolved URL is resolved-url parsed as an absolute URL.</p>
<h1 id="rfc.section.4.5">
<a href="#rfc.section.4.5">4.5.</a> Resolving a string as a query-relative URL</h1>
<p id="rfc.section.4.5.p.1">Given a string relative-url and a ParsedURL base-url, let resolved-url be </p>

<ul>
<li>base-url's scheme</li>
<li>concatenated with "://",</li>
<li>concatenated with base-url's authority,</li>
<li>concatenated with base-url's path,</li>
<li>concatenated with relative-url.</li>
</ul>

<p> </p>
<p id="rfc.section.4.5.p.2">The resolved URL is resolved-url parsed as an absolute URL.</p>
<h1 id="rfc.section.4.6">
<a href="#rfc.section.4.6">4.6.</a> Resolving a string as a fragment-relative URL</h1>
<p id="rfc.section.4.6.p.1">Given a string relative-url and a ParsedURL base-url, let resolved-url be </p>

<ul>
<li>base-url's scheme</li>
<li>concatenated with "://",</li>
<li>concatenated with base-url's authority,</li>
<li>concatenated with base-url's path,</li>
<li>concatenated with "?",</li>
<li>concatenated with base-url's query,</li>
<li>concatenated with relative-url.</li>
</ul>

<p> </p>
<p id="rfc.section.4.6.p.2">The resolved URL is resolved-url parsed as an absolute URL.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> Canonicalizing a URL</h1>
<p id="rfc.section.5.p.1">This section describes how to construct a canonical version of a parsed URL string. TODO: We probably should mention somewhere that there is *not* a unique canonicalization for every URL.</p>
<p id="rfc.section.5.p.2">Given parsed URL original-url, if original-url is invalid: </p>

<ul class="empty"><li>-&gt; Abort these steps.</li></ul>

<p> </p>
<p id="rfc.section.5.p.3">TODO: Handle file URLs.</p>
<p id="rfc.section.5.p.4">If the scheme is hierarchical: </p>

<ul class="empty">
<li>Output the canonicalized scheme (as described in Section ??).</li>
<li>Output "://".</li>
<li>If the user-info is non-empty: <ul class="empty">
<li>Output the canonicalized user-info (as described in Section ??).</li>
<li>Output "@".</li>
</ul>
<p> </p>
</li>
<li>Output the canonicalized host (as described in Section ??).</li>
<li>Let the canonicalized-port be the canonicalized port (as described in Section ??).</li>
<li>If the canonicalized-port is non-empty and is not the default port for the scheme: <ul class="empty">
<li>Output ":".</li>
<li>Output the canonicalized-port.</li>
</ul>
<p> </p>
</li>
<li>Output the canonicalized path (as described in Section ??).</li>
<li>Let the canonicalized-query be the canonicalized query (as described in Section ??).</li>
<li>If the canonicalized-query is non-empty (TODO: Distinguish between empty and non-existent queries): <ul class="empty">
<li>Output "?".</li>
<li>Output the canonicalized-query.</li>
</ul>
<p> </p>
</li>
<li>Let the canonicalized-fragment be the canonicalized fragment (as described in Section ??).</li>
<li>If the canonicalized-fragment is non-empty (TODO: Distinguish between empty and non-existent fragments): <ul class="empty">
<li>Output "#".</li>
<li>Output the canonicalized-fragment.</li>
</ul>
<p> </p>
</li>
</ul>

<p> </p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Canonicalizing a Scheme</h1>
<p id="rfc.section.5.1.p.1">If the first character of the scheme is not in ALPHA, the scheme is invalid.</p>
<p id="rfc.section.5.1.p.2">Process each character of the scheme in sequence: </p>

<ul class="empty"><li>If the current character is among ALPHA, DIGIT, "+", "-", and ".": <ul class="empty"><li>-&gt; Output the current character.</li></ul>
<p> Otherwise, if the current character is "%": </p>
<ul class="empty">
<li>-&gt; The scheme is invalid.</li>
<li>-&gt; Output the current character.</li>
</ul>
<p> Otherwise: </p>
<ul class="empty">
<li>-&gt; The scheme is invalid.</li>
<li>-&gt; Output the utf8-percent-escaping of the current character.</li>
</ul>
<p> </p>
</li></ul>

<p> </p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> Canonicalizing a User-Info</h1>
<p id="rfc.section.5.2.p.1">Process each character of the username in sequence: </p>

<ul class="empty"><li>If the current character is among TODO: <ul class="empty"><li>-&gt; Output the current character.</li></ul>
<p> Otherwise: </p>
<ul class="empty"><li>-&gt; Output the utf8-percent-escaping of the current character.</li></ul>
<p> </p>
</li></ul>

<p> </p>
<p id="rfc.section.5.2.p.2">If there is no password or if the password is empty: </p>

<ul class="empty"><li>-&gt; Abort these steps.</li></ul>

<p> </p>
<p id="rfc.section.5.2.p.3">Output ":".</p>
<p id="rfc.section.5.2.p.4">Process each character of the password in sequence: </p>

<ul class="empty"><li>If the current character is among TODO: <ul class="empty"><li>-&gt; Output the current character.</li></ul>
<p> Otherwise: </p>
<ul class="empty"><li>-&gt; Output the utf8-percent-escaping of the current character.</li></ul>
<p> </p>
</li></ul>

<p> </p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> Canonicalizing a Host</h1>
<p id="rfc.section.5.3.p.1">TODO: Handle IP addresses.</p>
<p id="rfc.section.5.3.p.2">Let unicode-host be the host-escape-normalized host (see Section ??).</p>
<p id="rfc.section.5.3.p.3">Output result of applying the IDNA to-ascii algorithm to the unicode-host. TODO: Properly reference IDNA's to-ascii algorith (we might need a wrapper like we do in the cookie spec).</p>
<h1 id="rfc.section.5.3.1">
<a href="#rfc.section.5.3.1">5.3.1.</a> Host Escape Normalization</h1>
<div id="#rfc.figure.1"></div>
<pre>
host-escaped   = U+0000-U+002A / U+002C / U+002F / U+003B-U+0040 / U+005C /
                 U+005E / U+0060 / U+007B-U+007F
            </pre>
<p id="rfc.section.5.3.1.p.1">Process each character of the host in sequence: </p>

<ul class="empty">
<li>If the current character is "%": <ul class="empty"><li>-&gt; TODO: Handle percent-unescaping.</li></ul>
<p> </p>
</li>
<li>If the current character matches host-escaped: <ul class="empty"><li>-&gt; Output the utf8-percent-escaping of the current character.</li></ul>
<p> Otherwise, if the current character matches ALPHA: </p>
<ul class="empty"><li>-&gt; Output the current character converted to lower case.</li></ul>
<p> Otherwise: </p>
<ul class="empty"><li>-&gt; Output the current character.</li></ul>
<p> </p>
</li>
</ul>

<p> </p>
<h1 id="rfc.section.5.4">
<a href="#rfc.section.5.4">5.4.</a> Canonicalizing a Path</h1>
<p id="rfc.section.5.4.p.1">TODO: Do we need to ensure that path's always start with a slash character?</p>
<p id="rfc.section.5.4.p.2">If the path is empty: </p>

<ul class="empty"><li>-&gt; Ouput "/" and abort these steps.</li></ul>

<p> </p>
<div id="#rfc.figure.2"></div>
<pre>
path-escaped   = U+0000-U+0020 / U+0022-U+0023 / U+0025 / U+003C / U+003E /
                 U+003F / U+005C / U+005E / U+0060 / U+007B-U+007D / U+007F
path-unescaped = "-" / DIGIT / ALPHA / "_" / "~"
          </pre>
<p id="rfc.section.5.4.p.3">Process each character of the path in sequence: </p>

<ul class="empty"><li>If the current character matches path-escaped or is greater than or equal to U+0080: <ul class="empty"><li>-&gt; Output the utf8-percent-escaping of the current character.</li></ul>
<p> Otherwise, if the current character is ".": </p>
<ul class="empty"><li>-&gt; TODO: Handle "." collapsing.</li></ul>
<p> Otherwise, if the current character is "\": </p>
<ul class="empty"><li>-&gt; Output "/".</li></ul>
<p> Otherwise, if the current character is "%": </p>
<ul class="empty"><li>-&gt; TODO: Handle percent-unescaping.</li></ul>
<p> Otherwise: </p>
<ul class="empty"><li>-&gt; Output the current character.</li></ul>
<p> </p>
</li></ul>

<p> </p>
<h1 id="rfc.section.5.5">
<a href="#rfc.section.5.5">5.5.</a> Canonicalizing a Query</h1>
<p id="rfc.section.5.5.p.1">TODO: Handle the ambient encoding case.</p>
<p id="rfc.section.5.5.p.2">Process each character of the query in sequence: </p>

<ul class="empty"><li>If the current character is among TODO: <ul class="empty"><li>-&gt; Output the current character.</li></ul>
<p> Otherwise: </p>
<ul class="empty"><li>-&gt; Output the utf8-percent-escaping of the current character. TODO: We need to handle the goofy query escaping format.</li></ul>
<p> </p>
</li></ul>

<p> </p>
<h1 id="rfc.section.5.6">
<a href="#rfc.section.5.6">5.6.</a> Canonicalizing a Fragment</h1>
<p id="rfc.section.5.6.p.1">Process each character of the fragment in sequence: </p>

<ul class="empty"><li>If the current character has a Unicode value greater than or equal to U+0020: <ul class="empty"><li>-&gt; Output the current character.</li></ul>
<p> Otherwise: </p>
<ul class="empty"><li>-&gt; Output the utf8-percent-escaping of the current character.</li></ul>
<p> </p>
</li></ul>

<p> </p>
<p id="rfc.section.5.6.p.2">Note: The above algorithm results in the canonicalized fragment containing non-US-ASCII characters.</p>
<h1 id="rfc.references">
<a href="#rfc.references">6.</a> References</h1>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> Acknowledgements</h1>
<p id="rfc.section.Appendix A.p.1">TODO</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Adam Barth</span> 
	  <span class="n hidden">
		<span class="family-name">Barth</span>
	  </span>
	</span>
	<span class="org vcardline">Google, Inc.  </span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ietf@adambarth.com">ietf@adambarth.com</a></span>

<span class="vcardline">URI: <a href="http://www.adambarth.com/">http://www.adambarth.com/</a></span>

  </address>
</div>

</body>
</html>