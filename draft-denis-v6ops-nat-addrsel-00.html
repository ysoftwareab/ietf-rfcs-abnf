<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Problems with IPv6 source address
     selection and IPv4 NATs</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Problems with IPv6 source address
     selection and IPv4 NATs">
<meta name="keywords" content="NAT, address, selection">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">R. Denis-Courmont</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Nokia</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">February 18, 2009</td></tr>
<tr><td class="header">Expires: August 22, 2009</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />Problems with IPv6 source address
     selection and IPv4 NATs<br />draft-denis-v6ops-nat-addrsel-00</h1>

<h3>Status of This Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on August 22, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p> This memo details a problem and potential solution,
        when using the IPv6 source address selection algorithm
        with private IPv4 address space.
      
</p>
<a name="anchor1"></a><br /><hr />
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p> When a host initiates an IP communication flow with a remote host,
        a pair of local and remote IP addresses to use must be chosen.
        If either or both hosts is assigned multiple IP addresses,
        an address selection mechanism is required.
        That can happen, for instance,
        if either or both hosts are dual-stacked.
        The default address selection scheme<a class='info' href='#RFC3484'>[RFC3484]<span> (</span><span class='info'>Draves, R., &ldquo;Default Address Selection for Internet Protocol version 6 (IPv6),&rdquo; February&nbsp;2003.</span><span>)</span></a>
        was specified to address this problem.
      
</p>
<p> One fundamental design assumption of this scheme is the ability
        to determine a scope for any address (IPv4 or IPv6).
        To that end, static scoping rules were defined.
        This memo explains why and how the current rules are inadequate
        when Network Address Translation (NAT) is involved,
        which is a common occurence in modern-day IPv4 deployments.
      
</p>
<a name="anchor2"></a><br /><hr />
<a name="rfc.section.2"></a><h3>2.&nbsp;
IPv4 address scopes</h3>

<p> As defined in <a class='info' href='#RFC3484'>[RFC3484]<span> (</span><span class='info'>Draves, R., &ldquo;Default Address Selection for Internet Protocol version 6 (IPv6),&rdquo; February&nbsp;2003.</span><span>)</span></a>, a unicast IPv4 address
        has one of three scopes:
        </p>
<blockquote class="text"><dl>
<dt>Link-local scope:</dt>
<dd>
            Loopback addresses (127.0.0.0/8)
            and autoconfigured addresses (169.254.0.0/16).
          
</dd>
<dt>Site-local scope:</dt>
<dd>
            Private addresses as defined in <a class='info' href='#RFC1918'>[RFC1918]<span> (</span><span class='info'>Rekhter, Y., Moskowitz, R., Karrenberg, D., Groot, G., and E. Lear, &ldquo;Address Allocation for Private Internets,&rdquo; February&nbsp;1996.</span><span>)</span></a>.
          
</dd>
<dt>Global scope:</dt>
<dd>
            All other unicast addresses.
          
</dd>
</dl></blockquote><p>
      
</p>
<p> The address scopes are supposed to be universal;
        and hence they are statically defined.
        Furthermore, per <a class='info' href='#RFC3484'>[RFC3484]<span> (</span><span class='info'>Draves, R., &ldquo;Default Address Selection for Internet Protocol version 6 (IPv6),&rdquo; February&nbsp;2003.</span><span>)</span></a>,
        scope matching rules (Rule 2) are normally applied
        before any other rule,
        except for the identical address rule (Rule 1).
        In other words, apart from the corner case whereby
        the local and remote hosts are one and the same,
        the scope matching rule always &quot;wins&quot;.
      
</p>
<a name="anchor3"></a><br /><hr />
<a name="rfc.section.3"></a><h3>3.&nbsp;
NAT and address scope</h3>

<p> When it crosses a NAT, either the source or destination address
        of a packet will change.
        As a consequence, the scope of that address might change as well.
        In any case, the result of the source address selection scheme
        could be different when the original address is substitued
        with the translated address.
      
</p>
<p> In fact, many real-world NAT deployments use private addresses
        on one side of the NAT, and public addresses on the other side.
        This is probably the most common scenario with IPv4 network in
        SOHO environment: a single public IPv4 address is provisioned
        to a customer, and all hosts on the customer network
        &quot;share&quot; that address using a NAT function
        within the Customer Premises Equipment (CPE).
      
</p>
<p> <a class='info' href='#RFC3484'>[RFC3484]<span> (</span><span class='info'>Draves, R., &ldquo;Default Address Selection for Internet Protocol version 6 (IPv6),&rdquo; February&nbsp;2003.</span><span>)</span></a> assumes that a source address
        with a small scope cannot reach a destination address
        with a larger scope.
        However, if private IPv4 addresses and a NAT are used
        to reach public IPv4 addresses,
        then this assumption does not hold.
        In other words, the private IPv4 addresses behind NATs
        effectively have a global scope,
        provided that the protocols above the IP network layer
        can cope with network address translation.
      
</p>
<a name="anchor4"></a><br /><hr />
<a name="rfc.section.4"></a><h3>4.&nbsp;
Applicability to IPv6 transition mechanisms</h3>

<p> <a class='info' href='#RFC3484'>[RFC3484]<span> (</span><span class='info'>Draves, R., &ldquo;Default Address Selection for Internet Protocol version 6 (IPv6),&rdquo; February&nbsp;2003.</span><span>)</span></a> states that
        &quot;the use of transitional addresses
        when native addresses are available [should be avoided]&quot;.
        Indeed, transitional addresses and transition mechanisms in general
        tend to be less reliable than native connectivity,
        including native IPv4 connectivity.
      
</p>
<p> However, in a typical IPv4 NAT'ed private address deployments,
        if IPv6 transition mechanisms are available,
        a dual-stack host will typically have the following addresses.
        They are the candidate source addresses:
        </p>
<ul class="text">
<li> a link-local IPv6 address (autoconfigured),
          
</li>
<li> a site-local scope private IPv4 address
                (e.g. assigned by DHCPv4),
          
</li>
<li> a global scope transitional IPv6 address,
            such as Teredo<a class='info' href='#RFC4380'>[RFC4380]<span> (</span><span class='info'>Huitema, C., &ldquo;Teredo: Tunneling IPv6 over UDP through Network Address Translations (NATs),&rdquo; February&nbsp;2006.</span><span>)</span></a>,
            or 6to4<a class='info' href='#RFC3056'>[RFC3056]<span> (</span><span class='info'>Carpenter, B. and K. Moore, &ldquo;Connection of IPv6 Domains via IPv4 Clouds,&rdquo; February&nbsp;2001.</span><span>)</span></a>
            (e.g. if the CPE is a 6to4 gateway).
          
</li>
</ul><p>
        If the destination host is also dual-stacked, then it will typically
        have two public addresses (though the number is not relevant).
        They are the candidate destination addresses:
        </p>
<ul class="text">
<li> a global native IPv6 address (e.g. from DNS AAAA record),
          
</li>
<li> a global IPv4 address (e.g. from DNS A record).
          
</li>
</ul><p>
      
</p>
<p> Because the candidate source IPv4 address have a smaller scope
        (site-local) than the candidate destination IPv4 address (global),
        it will be eliminated.
        The address selection algorithm will always select
        the IPv6 address pair:
        </p>
<ul class="text">
<li> the transitional IPv6 address as source,
          
</li>
<li> the global native IPv6 address as destination.
          
</li>
</ul><p>
        Thus, the transitional (IPv6) address will be used
        instead of the native (IPv4) address,
        even though that should have been avoided.
      
</p>
<p> There is no way to override this result with a compliant
        implementation of source address selection.
        In particular, the policy table does not affect this result,
        because the scope rules preempt the policy table rules.
      
</p>
<a name="anchor5"></a><br /><hr />
<a name="rfc.section.5"></a><h3>5.&nbsp;
Solutions</h3>

<a name="anchor6"></a><br /><hr />
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Changing the private IPv4 address scope</h3>

<p> Several operating system vendors appear to work around this issue
          by assigning a global scope to IPv4 address.
          Thus, rule 2 is no longer discriminating
          against the IPv4 address pair.
        
</p>
<p> In that case, provided the policy table has separate labels
          for transitional addresses,
          the IPv4 addresses pair will be selected.
          IPv4 addresses normally all have the same label.
        
</p>
<p> Note that the default policy table has a separate label
          for 6to4 addresses.
          However, as it predates Teredo,
          it lacks a distinct label for the Teredo prefix, 2001:0:/32.
          An adequate extra label would be as follow:
        
</p>
<p> Prefix: 2001:0:/32, Precedence: 5, Label: 5
        
</p>
<a name="anchor7"></a><br /><hr />
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Address selection parameter for NAT</h3>

<p> With the previous solution,
          IPv4 is always selected.
          This is a potential drawback
          if the upper-layer protocol combination is not NAT-friendly.
        
</p>
<p> As an alternative, a &quot;translation-friendly&quot;
          source address selection parameter could be specified,
          as in <a class='info' href='#RFC5014'>[RFC5014]<span> (</span><span class='info'>Nordmark, E., Chakrabarti, S., and J. Laganier, &ldquo;IPv6 Socket API for Source Address Selection,&rdquo; September&nbsp;2007.</span><span>)</span></a>.
          However, a default value will be needed
          for the many existing applications
          that would fail to set this parameter.
        
</p>
<a name="anchor8"></a><br /><hr />
<a name="rfc.section.6"></a><h3>6.&nbsp;
IPv6 Address Translation</h3>

<p> The implications of IPv6 Address Translation
        and protocol translation are left beyond the scope of this document.
        However, it can only be recommended that RFC3484 be taken into account
        when designing such translation systems.
      
</p>
<a name="security"></a><br /><hr />
<a name="rfc.section.7"></a><h3>7.&nbsp;
Security Considerations</h3>

<p> TBD.
      
</p>
<a name="iana"></a><br /><hr />
<a name="rfc.section.8"></a><h3>8.&nbsp;
IANA Considerations</h3>

<p>This document raises no IANA considerations.
      
</p>
<a name="rfc.references"></a><br /><hr />
<a name="rfc.section.9"></a><h3>9.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<h3>9.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC1918">[RFC1918]</a></td>
<td class="author-text"><a href="mailto:yakov@cisco.com">Rekhter, Y.</a>, <a href="mailto:rgm3@is.chrysler.com">Moskowitz, R.</a>, <a href="mailto:Daniel.Karrenberg@ripe.net">Karrenberg, D.</a>, <a href="mailto:GeertJan.deGroot@ripe.net">Groot, G.</a>, and <a href="mailto:lear@sgi.com">E. Lear</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1918">Address Allocation for Private Internets</a>,&rdquo; BCP&nbsp;5, RFC&nbsp;1918, February&nbsp;1996 (<a href="http://www.rfc-editor.org/rfc/rfc1918.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3484">[RFC3484]</a></td>
<td class="author-text">Draves, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3484">Default Address Selection for Internet Protocol version 6 (IPv6)</a>,&rdquo; RFC&nbsp;3484, February&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3484.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5014">[RFC5014]</a></td>
<td class="author-text">Nordmark, E., Chakrabarti, S., and J. Laganier, &ldquo;<a href="http://tools.ietf.org/html/rfc5014">IPv6 Socket API for Source Address Selection</a>,&rdquo; RFC&nbsp;5014, September&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc5014.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<h3>9.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC3056">[RFC3056]</a></td>
<td class="author-text">Carpenter, B. and K. Moore, &ldquo;<a href="http://tools.ietf.org/html/rfc3056">Connection of IPv6 Domains via IPv4 Clouds</a>,&rdquo; RFC&nbsp;3056, February&nbsp;2001 (<a href="http://www.rfc-editor.org/rfc/rfc3056.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4380">[RFC4380]</a></td>
<td class="author-text">Huitema, C., &ldquo;<a href="http://tools.ietf.org/html/rfc4380">Teredo: Tunneling IPv6 over UDP through Network Address Translations (NATs)</a>,&rdquo; RFC&nbsp;4380, February&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4380.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">R&eacute;mi Denis-Courmont</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nokia Corporation</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.O. Box 407</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">NOKIA GROUP  00045</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FI</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 50 487 6315</td></tr>
<tr><td class="author" align="right">EMail:&nbsp;</td>
<td class="author-text"><a href="mailto:remi.denis-courmont@nokia.com">remi.denis-courmont@nokia.com</a></td></tr>
</table>
</body></html>
