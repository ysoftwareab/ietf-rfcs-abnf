<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>IPv6 Configuration in IKEv2</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="IPv6 Configuration in IKEv2">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">P. Eronen</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Nokia</td></tr>
<tr><td class="header">Intended status: Experimental</td><td class="header">J. Laganier</td></tr>
<tr><td class="header">Expires: April 29, 2010</td><td class="header">QUALCOMM Inc.</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">C. Madson</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Cisco Systems</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">October 26, 2009</td></tr>
</table></td></tr></table>
<h1><br />IPv6 Configuration in IKEv2<br />draft-ietf-ipsecme-ikev2-ipv6-config-03</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.
This document may contain material from IETF Documents or IETF
Contributions published or made publicly available before November
10, 2008. The person(s) controlling the copyright in some of this
material may not have granted the IETF Trust the right to allow
modifications of such material outside the IETF Standards Process.
Without obtaining an adequate license from the person(s) controlling
the copyright in such materials, this document may not be modified
outside the IETF Standards Process, and derivative works of it may
not be created outside the IETF Standards Process, except to format
it for publication as an RFC or to translate it into languages other
than English.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on April 29, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>When IKEv2 is used for remote VPN access (client to VPN
    gateway), the gateway assigns the client an IP address from the
    internal network using IKEv2 configuration payloads.  The
    configuration payloads specified in RFC 4306 work well for IPv4,
    but make it difficult to use certain features of IPv6. 
    This document specifies new configuration attributes for
    IKEv2 that allows the VPN gateway to assign IPv6 prefixes to
    clients, enabling all features of IPv6 to be used with the
    client-gateway "virtual link".
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction and Problem Statement<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#limitations">3.</a>&nbsp;
Current Limitations and Goals<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">3.1.</a>&nbsp;
Multiple Prefixes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">3.2.</a>&nbsp;
Link-Local Addresses<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#iidselection">3.3.</a>&nbsp;
Interface Identifier Selection<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">3.4.</a>&nbsp;
Sharing VPN Access<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">3.5.</a>&nbsp;
General Goals<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">3.6.</a>&nbsp;
Non-Goals<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">3.7.</a>&nbsp;
Additional Information<br />
<a href="#solution">4.</a>&nbsp;
Solution Details<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#init-xchg">4.1.</a>&nbsp;
Initial Exchanges<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#reauth">4.2.</a>&nbsp;
Reauthentication<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#childsas">4.3.</a>&nbsp;
Creating CHILD_SAs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">4.4.</a>&nbsp;
Relationship to Neighbor Discovery<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xist-plds">4.5.</a>&nbsp;
Relationship to Existing IKEv2 Payloads<br />
<a href="#payload">5.</a>&nbsp;
Payload Formats<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">5.1.</a>&nbsp;
INTERNAL_IP6_LINK Configuration Attribute<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">5.2.</a>&nbsp;
INTERNAL_IP6_PREFIX Configuration Attribute<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#link-id">5.3.</a>&nbsp;
LINK_ID Notify Payload<br />
<a href="#iana">6.</a>&nbsp;
IANA Considerations<br />
<a href="#security">7.</a>&nbsp;
Security Considerations<br />
<a href="#anchor12">8.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">9.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">9.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">9.2.</a>&nbsp;
Informative References<br />
<a href="#design rationale">Appendix&nbsp;A.</a>&nbsp;
Design Rationale (Non-Normative)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">A.1.</a>&nbsp;
Link Model<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">A.2.</a>&nbsp;
Distributing Prefix Information<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">A.3.</a>&nbsp;
Unique Address Allocation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">A.4.</a>&nbsp;
Layer 3 Access Control<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">A.5.</a>&nbsp;
Other Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#alt-sol">A.6.</a>&nbsp;
Alternative Solution Sketches<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor20">A.6.1.</a>&nbsp;
Version -00 Sketch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">A.6.2.</a>&nbsp;
Router Aggregation Sketch #1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor22">A.6.3.</a>&nbsp;
Router Aggregation Sketch #2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor23">A.6.4.</a>&nbsp;
IPv4-like Sketch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">A.6.5.</a>&nbsp;
Sketch Based on RFC 3456<br />
<a href="#anchor25">Appendix&nbsp;B.</a>&nbsp;
Evaluation (Non-Normative)<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction and Problem Statement</h3>

<p>In typical remote access VPN use (client to VPN gateway), the
  client needs an IP address in the network protected by the security
  gateway.  IKEv2 includes a feature called "configuration payloads"
  that allows the gateway to dynamically assign a temporary address to
  the client <a class='info' href='#IKEv2'>[IKEv2]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
</p>
<p>For IPv4, the message exchange would look as follows:
</p><br /><hr class="insert" />
<a name="fig:ipv4"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   Client      Gateway
  --------    ---------

   HDR(IKE_SA_INIT), SAi1, KEi, Ni  --&gt;

            &lt;--  HDR(IKE_SA_INIT), SAr1, KEr, Nr, [CERTREQ]

   HDR(IKE_AUTH),
   SK { IDi, CERT, [CERTREQ], AUTH, [IDr],
        CP(CFG_REQUEST) =
           { INTERNAL_IP4_ADDRESS(),
             INTERNAL_IP4_DNS() }, SAi2,
        TSi = (0, 0-65535, 0.0.0.0-255.255.255.255),
        TSr = (0, 0-65535, 0.0.0.0-255.255.255.255) }  --&gt;

          &lt;--  HDR(IKE_AUTH),
               SK { IDr, CERT, AUTH,
                    CP(CFG_REPLY) =
                       { INTERNAL_IP4_ADDRESS(192.0.2.234),
                         INTERNAL_IP4_DNS(10.11.22.33) },
                    SAr2,
                    TSi = (0, 0-65535, 192.0.2.234-192.0.2.234),
                    TSr = (0, 0-65535, 0.0.0.0-255.255.255.255) }
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: IPv4 configuration&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The IPv4 case has been implemented by various vendors, and in
  general works well. IKEv2 also defines almost identical
  configuration payloads for IPv6:
</p><br /><hr class="insert" />
<a name="fig:ipv6"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   Client      Gateway
  --------    ---------

   HDR(IKE_AUTH),
   SK { IDi, CERT, [CERTREQ], AUTH, [IDr],
        CP(CFG_REQUEST) =
           { INTERNAL_IP6_ADDRESS(),
             INTERNAL_IP6_DNS() }, SAi2,
        TSi = (0, 0-65535,
               0:0:0:0:0:0:0:0 -
               FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF),
        TSr = (0,
               0-65535, 0:0:0:0:0:0:0:0 -
               FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF) }  --&gt;

          &lt;--  HDR(IKE_AUTH),
               SK { IDr, CERT, AUTH,
                    CP(CFG_REPLY) =
                       { INTERNAL_IP6_ADDRESS(2001:DB8:0:1:2:3:4:5,
                                              64),
                         INTERNAL_IP6_DNS(2001:DB8:9:8:7:6:5:4) },
                    SAr2,
                    TSi = (0, 0-65535,
                           2001:DB8:0:1:2:3:4:5 -
                           2001:DB8:0:1:2:3:4:5),
                    TSr = (0, 0-65535,
                           0:0:0:0:0:0:0:0: -
                           FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF) }
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: IPv6 configuration&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>In other words, IPv6 is basically treated as IPv4 with larger
  addresses. As noted in <a class='info' href='#RFC4718'>[RFC4718]<span> (</span><span class='info'>Eronen, P. and P. Hoffman, &ldquo;IKEv2 Clarifications and Implementation Guidelines,&rdquo; October&nbsp;2006.</span><span>)</span></a>, this does not fully
  follow the "normal IPv6 way of doing things", and it complicates or
  prevents using certain features of IPv6. <a class='info' href='#limitations'>Section&nbsp;3<span> (</span><span class='info'>Current Limitations and Goals</span><span>)</span></a>
  describes the limitations in detail.
</p>
<p>This document specifies new configuration attributes for
  IKEv2 that allows the VPN gateway to assign IPv6 prefixes to
  clients, enabling all features of IPv6 to be used with the
  client-gateway "virtual link".
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
  NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
  in this document are to be interpreted as described in <a class='info' href='#KEYWORDS'>[KEYWORDS]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<p>When messages containing IKEv2 payloads are described, optional
  payloads are shown in brackets (for instance, "[FOO]"), and a plus
  sign indicates that a payload can be repeated one or more times (for
  instance, "FOO+").
</p>
<p>This document uses the term "virtual interface" when describing
  how the client uses the IPv6 address(es) assigned by the gateway.
  While existing IPsec documents do not use this term, it is not a new
  concept.  In order to use the address assigned by the VPN gateway,
  current VPN clients already create a local "virtual interface", as
  only addresses assigned to interfaces can be used, e.g., as source
  addresses for TCP connections. Note that this definition of
  "interface" is not necessarily identical with what some particular
  implementation calls "interface".
</p>
<a name="limitations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Current Limitations and Goals</h3>

<p>This section describes the limitations of the current IPv6
  configuration mechanism, and requirements for the new solution.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Multiple Prefixes</h3>

<p>In <a class='info' href='#fig:ipv6'>Figure&nbsp;2<span> (</span><span class='info'>IPv6 configuration</span><span>)</span></a> only a single IPv6 address (from a
    single prefix) is assigned. The specification does allow the
    client to include multiple INTERNAL_IP6_ADDRESS attributes in its
    request, but the gateway cannot assign more addresses than the
    client requested.
</p>
<p>Multiple prefixes are useful for site renumbering, host-based
    site multihoming <a class='info' href='#SHIM6'>[SHIM6]<span> (</span><span class='info'>Nordmark, E. and M. Bagnulo, &ldquo;Shim6: Level 3 Multihoming Shim Protocol for IPv6,&rdquo; February&nbsp;2009.</span><span>)</span></a>, and unique local IPv6
    addresses <a class='info' href='#RFC4193'>[RFC4193]<span> (</span><span class='info'>Hinden, R. and B. Haberman, &ldquo;Unique Local IPv6 Unicast Addresses,&rdquo; October&nbsp;2005.</span><span>)</span></a>.  In all of these cases, the
    gateway has better information on how many different addresses
    (from different prefixes) the client should be assigned.
</p>
<p>The solution should support assigning address from multiple
    prefixes, without requiring the client to know beforehand how many
    prefixes are needed.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Link-Local Addresses</h3>

<p>The IPv6 addressing architecture <a class='info' href='#IPv6Addr'>[IPv6Addr]<span> (</span><span class='info'>Hinden, R. and S. Deering, &ldquo;IP Version 6 Addressing Architecture,&rdquo; February&nbsp;2006.</span><span>)</span></a>
    specifies that "IPv6 addresses of all types are assigned to
    interfaces, not nodes. [..]  All interfaces are required to have
    at least one Link-Local unicast address".
</p>
<p>Currently, the virtual interface created by IKEv2 configuration
    payloads does not have link-local addresses. This violates the
    requirements in <a class='info' href='#IPv6Addr'>[IPv6Addr]<span> (</span><span class='info'>Hinden, R. and S. Deering, &ldquo;IP Version 6 Addressing Architecture,&rdquo; February&nbsp;2006.</span><span>)</span></a> and prevents the use of
    protocols that require link-local addresses, such as <a class='info' href='#MLDv2'>[MLDv2]<span> (</span><span class='info'>Vida, R. and L. Costa, &ldquo;Multicast Listener Discovery Version 2 (MLDv2) for IPv6,&rdquo; June&nbsp;2004.</span><span>)</span></a> and <a class='info' href='#DHCPv6'>[DHCPv6]<span> (</span><span class='info'>Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, &ldquo;Dynamic Host Configuration Protocol for IPv6 (DHCPv6),&rdquo; July&nbsp;2003.</span><span>)</span></a>.
</p>
<p>The solution should assign link-local addresses to the virtual
    interfaces, and allow them to be used for protocols between the
    VPN client and gateway.
</p>
<a name="iidselection"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Interface Identifier Selection</h3>

<p>In the message exchange shown in <a class='info' href='#fig:ipv6'>Figure&nbsp;2<span> (</span><span class='info'>IPv6 configuration</span><span>)</span></a>, the
    gateway chooses the interface ID used by the client. It is also
    possible for the client to request a specific interface ID; the
    gateway then chooses the prefix part.
</p>
<p>This approach complicates the use of Cryptographically
    Generated Addresses <a class='info' href='#CGA'>[CGA]<span> (</span><span class='info'>Aura, T., &ldquo;Cryptographically Generated Addresses (CGA),&rdquo; March&nbsp;2006.</span><span>)</span></a>. With CGAs, the interface
    ID cannot be calculated before the prefix is known. The client
    could first obtain a non-CGA address to determine the prefix, and
    then send a separate CFG_REQUEST to obtain a CGA address with the
    same prefix. However, this approach requires that the IKEv2
    software component provides an interface to the component managing
    CGAs; an ugly implementation dependency that would be best
    avoided.
</p>
<p>Similar concerns apply to other cases where the client has some
    interest in what interface ID is being used, such as Hash-Based
    Addresses <a class='info' href='#HBA'>[HBA]<span> (</span><span class='info'>Bagnulo, M., &ldquo;Hash Based Addresses (HBA),&rdquo; December&nbsp;2007.</span><span>)</span></a> and privacy addresses <a class='info' href='#RFC4941'>[RFC4941]<span> (</span><span class='info'>Narten, T., Draves, R., and S. Krishnan, &ldquo;Privacy Extensions for Stateless Address Autoconfiguration in IPv6,&rdquo; September&nbsp;2007.</span><span>)</span></a>.
</p>
<p>Without CGAs and HBAs, VPN clients are not able to fully use
    IPv6 features such as <a class='info' href='#SHIM6'>[SHIM6]<span> (</span><span class='info'>Nordmark, E. and M. Bagnulo, &ldquo;Shim6: Level 3 Multihoming Shim Protocol for IPv6,&rdquo; February&nbsp;2009.</span><span>)</span></a> or enhanced Mobile
    IPv6 route optimization <a class='info' href='#RFC4866'>[RFC4866]<span> (</span><span class='info'>Arkko, J., Vogt, C., and W. Haddad, &ldquo;Enhanced Route Optimization for Mobile IPv6,&rdquo; May&nbsp;2007.</span><span>)</span></a>.
</p>
<p>The solution should allow the VPN client to easily obtain
    several addresses from a given prefix, where the interface IDs are
    selected by the client, and may depend on the prefix.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
Sharing VPN Access</h3>

<p>Some VPN clients may want to share the VPN connection with
    other devices (e.g., from a cell phone to a laptop, or vice versa)
    via some local area network connection (such as Wireless LAN or
    Bluetooth), if allowed by the security policy.
</p>
<p>Quite obviously sharing of VPN access requires more than one
    address (unless NAT is used). However, the current model where
    each address is requested separately is probably complex to
    integrate with a local area network that uses stateless address
    autoconfiguration <a class='info' href='#AUTOCONF'>[AUTOCONF]<span> (</span><span class='info'>Thomson, S., Narten, T., and T. Jinmei, &ldquo;IPv6 Stateless Address Autoconfiguration,&rdquo; September&nbsp;2007.</span><span>)</span></a>.
    Thus, obtaining a whole prefix for the VPN
    client, and advertising that to the local link (something
    resembling <a class='info' href='#NDProxy'>[NDProxy]<span> (</span><span class='info'>Thaler, D., Talwar, M., and C. Patel, &ldquo;Neighbor Discovery Proxies (ND Proxy),&rdquo; April&nbsp;2006.</span><span>)</span></a>) would be preferable. With
    DHCPv6 prefix delegation <a class='info' href='#RFC3633'>[RFC3633]<span> (</span><span class='info'>Troan, O. and R. Droms, &ldquo;IPv6 Prefix Options for Dynamic Host Configuration Protocol (DHCP) version 6,&rdquo; December&nbsp;2003.</span><span>)</span></a>, even <a class='info' href='#NDProxy'>[NDProxy]<span> (</span><span class='info'>Thaler, D., Talwar, M., and C. Patel, &ldquo;Neighbor Discovery Proxies (ND Proxy),&rdquo; April&nbsp;2006.</span><span>)</span></a> and associated multi-link subnet issues would
    be avoided.
</p>
<p>The solution should support sharing the VPN access over a local
   area network connection when the other hosts are using stateless
   address autoconfiguration.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5"></a><h3>3.5.&nbsp;
General Goals</h3>

<p></p>
<ul class="text">
<li>The solution should avoid periodic messages over the VPN
     tunnel.
</li>
<li>Re-authentication works: the client can start a new IKE SA and
     continue using the same addresses as before.
</li>
<li>Compatibility with other IPsec uses: Configuring a virtual
     IPv6 link (with addresses assigned in IKEv2) should not prevent
     the same peers from using IPsec/IKEv2 for other uses (with other
     addresses). In particular, the peers may have SPD entries and PAD
     Child SA Authorization Data entries that are not related to the
     virtual link; when a CHILD_SA is created, it should be unambigous
     which entries are used.
</li>
<li>Compatibility with current IPv6 configuration: Although the
     current IPv6 mechanism is not widely implemented, new solutions
     should not preclude its use (e.g., by defining incompatible
     semantics for the existing payloads).
</li>
<li>The solution should have clean implementation dependencies. In
    particular, it should not require significant modifications to the
    core IPv6 stack (typically part of the operating system), or
    require the IKEv2 implementor to re-implement parts of the IPv6
    stack (to, e.g., have access or control to functionality that is
    currently not exposed by interfaces of the IPv6 stack).
</li>
<li>Re-use existing mechanisms as much as possible, as described in <a class='info' href='#IPConfig'>[IPConfig]<span> (</span><span class='info'>Aboba, B., Thaler, D., Andersson, L., and S. Cheshire, &ldquo;Principles of Internet Host Configuration,&rdquo; May&nbsp;2009.</span><span>)</span></a>.  <a class='info' href='#design rationale'>Appendix&nbsp;A<span> (</span><span class='info'>Design Rationale (Non-Normative)</span><span>)</span></a> describes the
     rationale why this document nevertheless uses IKEv2 Configuration
     Payloads for configuring the addresses.  However,
     <a class='info' href='#init-xchg'>Section&nbsp;4.1<span> (</span><span class='info'>Initial Exchanges</span><span>)</span></a> recommends using DHCPv6 Information-Request
     message for obtaining other configuration information (such as DNS
     server addresses).
</li>
</ul>

<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.6"></a><h3>3.6.&nbsp;
Non-Goals</h3>

<p>Mobile IPv6 already defines how it interacts with IPsec/IKEv2
  <a class='info' href='#RFC4877'>[RFC4877]<span> (</span><span class='info'>Devarapalli, V. and F. Dupont, &ldquo;Mobile IPv6 Operation with IKEv2 and the Revised IPsec Architecture,&rdquo; April&nbsp;2007.</span><span>)</span></a>, and the intent of this document is not
  to change that interaction in any way.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.7"></a><h3>3.7.&nbsp;
Additional Information</h3>

<p>If the VPN client is assigned IPv6 address(es) from prefix(es)
    that are shared with other VPN clients, this results in some kind
    of multi-link subnet.  <a class='info' href='#Multilink'>[Multilink]<span> (</span><span class='info'>Thaler, D., &ldquo;Multi-Link Subnet Issues,&rdquo; June&nbsp;2007.</span><span>)</span></a> describes issues
    associated with multi-link subnets, and recommends that they
    should be avoided.
</p>
<p>The original 3GPP specifications for IPv6 assigned a single IPv6
    address to each mobile phone, resembling current IKEv2 payloads.
    <a class='info' href='#RFC3314'>[RFC3314]<span> (</span><span class='info'>Wasserman, M., &ldquo;Recommendations for IPv6 in Third Generation Partnership Project 3GPP) Standards,&rdquo; September&nbsp;2002.</span><span>)</span></a> described the problems with this
    approach, and caused 3GPP to change the specifications to assign
    unique /64 prefix(es) for each phone.
</p>
<p>Due to similar concerns, the IEEE 802.16 IPv6 Convergence
    Sublayer <a class='info' href='#RFC5121'>[RFC5121]<span> (</span><span class='info'>Patil, B., Xia, F., Sarikaya, B., Choi, JH., and S. Madanapalli, &ldquo;Transmission of IPv6 via the IPv6 Convergence Sublayer over IEEE 802.16 Networks,&rdquo; February&nbsp;2008.</span><span>)</span></a> and Proxy Mobile IPv6 <a class='info' href='#RFC5213'>[RFC5213]<span> (</span><span class='info'>Gundavelli, S., Ed., Leung, K., Devarapalli, V., Chowdury, K., and B. Patil, &ldquo;Proxy Mobile IPv6,&rdquo; August&nbsp;2008.</span><span>)</span></a> also assign unique prefixes.
</p>
<a name="solution"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Solution Details</h3>

<a name="init-xchg"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Initial Exchanges</h3>

<p>1) During IKE_AUTH, the client sends a new configuration
  attribute, INTERNAL_IP6_LINK, which requests a virtual link to be
  configured.  The attribute contains the client's interface ID for
  the link-local address (other addresses may use other interface
  IDs).  Typically, the client would also ask for DHCPv6 server
  address; this is used only for configuration (such as DNS server
  addresses), not address assignment. 
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REQUEST) =
      { INTERNAL_IP6_LINK(Client's Link-Local Interface ID)
        INTERNAL_IP6_DHCP() }
   TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
   TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;
</pre></div>
<p>If the client has sent the INTERNAL_IP6_LINK configuration attribute, the
  VPN gateway SHOULD ignore any INTERNAL_IP6_ADDRESS configuration attribute
  present in the request.
</p>
<p>The VPN gateway MUST choose for itself a link-local interface identifier
  different than the client's one, i.e., accept the link-local interface
  identifier proposed by the client.  In case the VPN gateway cannot accept the
  link-local interface identifier the client proposed, the VPN gateway MUST
  fail the IPv6 address assignment by including a NOTIFY payload with the
  INTERNAL_ADDRESS_FAILURE message.
</p>
<p>The VPN Gateway then replies with an INTERNAL_IP6_LINK
  configuration attribute that contains the IKEv2 Link ID (an
  identifier selected by the VPN gateway, treated as an opaque octet
  string by the client -- this will be used for reauthentication and
  CREATE_CHILD_SA messages), the gateway's link local interface
  identier, and zero or more INTERNAL_IP6_PREFIX attributes. The
  traffic selectors proposed by the initiator are also narrowed to
  contain only the assigned prefixes, and the client link-local
  address (FE80::&lt;Client's Interface ID&gt;)identifier.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REPLY) =
      { INTERNAL_IP6_LINK(Gateway's Link-Local Interface ID,
                          IKEv2 Link ID)
        INTERNAL_IP6_PREFIX(Prefix1/64),
        [INTERNAL_IP6_PREFIX(Prefix2/64),...],
        [INTERNAL_IP6_DHCP(Address) ]
   TSi = ((0, 0-65535,
           FE80::&lt;Client's Interface ID&gt; -
           FE80::&lt;Client's Interface ID&gt;)
          (0, 0-65535,
           Prefix1::0 -
           Prefix1::FFFF:FFFF:FFFF:FFFF),
          [(0, 0-65535,
            Prefix2::0 -
            Prefix2::FFFF:FFFF:FFFF:FFFF), ...])
   TSr = (0, 0-65535,
          0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
</pre></div>
<p>At this point, the client can configure its link-local address 
   (FE80::&lt;Client's Interface ID&gt;), and other non-link-local
   unicast addresses from the assigned prefixes (with any proper interface
   identifier <a class='info' href='#IPv6Addr'>[IPv6Addr]<span> (</span><span class='info'>Hinden, R. and S. Deering, &ldquo;IP Version 6 Addressing Architecture,&rdquo; February&nbsp;2006.</span><span>)</span></a>). The VPN gateway MUST NOT
   simultaneously assign the same prefixes to any other client, and MUST NOT
   itself configure addresses from these prefixes. Thus, the client does not
   have to perform Duplicate Address Detection (DAD). (This approach is based
   on <a class='info' href='#IPv6PPP'>[IPv6PPP]<span> (</span><span class='info'>Varada, S., Haskins, D., and E. Allen, &ldquo;IP Version 6 over PPP,&rdquo; September&nbsp;2007.</span><span>)</span></a>.)
</p>
<p>The prefixes remain valid through the lifetime of the IKE SA
   (and its continuations via rekeying). If the VPN gateway needs to
   remove a prefix it has previously assigned, or assign a new prefix,
   it can do so with reauthentication (either starting
   reauthentication itself, or requesting the client to reauthenticate
   using <a class='info' href='#RFC4478'>[RFC4478]<span> (</span><span class='info'>Nir, Y., &ldquo;Repeated Authentication in Internet Key Exchange (IKEv2) Protocol,&rdquo; April&nbsp;2006.</span><span>)</span></a>).
</p>
<p>2) The client also contacts the DHCPv6 server. This is the
   RECOMMENDED way to obtain additional configuration parameters (such
   as DNS server addresses), as it allows easier extensibility and more
   options (such as the domain search list for DNS).
</p>
<a name="reauth"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Reauthentication</h3>

<p>When the client performs reauthentication (and wants to continue
  using the same "virtual link"), it includes the IKEv2 Link ID
  given by the gateway in the INTERNAL_IP6_LINK attribute.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REQUEST) =
      { INTERNAL_IP6_LINK(Client's Link Local Interface ID,
                          IKEv2 Link ID)
        INTERNAL_IP6_DHCP() }
   TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
   TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;
</pre></div>
<p>

   At this point, the gateway MUST verify that the client is indeed allowed to
   use the link identified by the IKEv2 Link ID. The same situation occurs in
   <a class='info' href='#IKEv2'>[IKEv2]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> when the client wants to continue using the same IPv4
   address with the INTERNAL_IP4_ADDRESS configuration attribute.  Typically,
   the gateway would use the Link ID to look up relevant local state, and
   compare the authenticated peer identity of the IKE_SA with the local state.

   
</p>
<p>

   If the client is allowed to continue using this link, the gateway
   replies (see <a class='info' href='#init-xchg'>Section&nbsp;4.1<span> (</span><span class='info'>Initial Exchanges</span><span>)</span></a>) with the same Gateway's Link-Local
   Interface ID and IKEv2 Link ID as used earlier, and sends the IPv6
   prefix(es) associated with this link. Usually, the IPv6 prefix(es)
   will also be the same as earlier, but this is not required.

   
</p>
<p>

   If the client is not allowed to continue using this link, the
   gateway treats it as a request for a new virtual link, selects a
   different IKEv2 Link ID value, and replies as in <a class='info' href='#init-xchg'>Section&nbsp;4.1<span> (</span><span class='info'>Initial Exchanges</span><span>)</span></a>.


</p>
<a name="childsas"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Creating CHILD_SAs</h3>

<p>When a CHILD_SA is created, the peers need to determine which SPD
  entries and PAD Child SA Authorization Data entries are used for
  this CHILD_SA. In the basic client-to-VPN-gateway uses, the
  situation is simple: all the matching SPD entries and Child SA
  Authorization Data entries are related to the "virtual link" between
  the VPN client and the VPN gateway.  However, if the same peers are
  also using IPsec/IKEv2 for other uses (with addresses not assigned
  inside IKEv2), they would also have SPD entries and PAD Child SA
  Authorization Data that is not related to the virtual link.
</p>
<p>If one of the peers requests a CHILD_SA and proposes traffic
  selectors covering everything (like in <a class='info' href='#fig:ipv6'>Figure&nbsp;2<span> (</span><span class='info'>IPv6 configuration</span><span>)</span></a>),
  should those be narrowed to the prefixes configured with
  INTERNAL_IP6_PREFIX, or to the other SPD/PAD entries? While some
  kind of heuristics are possible (see Appendix A for discussion),
  this document specifies an explicit solution:
</p>
<p>The peers MUST include a LINK_ID notification, containing the
  IKEv2 Link ID, in all CREATE_CHILD_SA requests (including rekeys)
  that are related to the virtual link.  The LINK_ID notification is
  not included in the CREATE_CHILD_SA response, or when doing IKE_SA
  rekeying.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Relationship to Neighbor Discovery</h3>

<p>Neighbor Discovery <a class='info' href='#IPv6ND'>[IPv6ND]<span> (</span><span class='info'>Narten, T., Nordmark, E., Simpson, W., and H. Soliman, &ldquo;Neighbor Discovery for IP version 6 (IPv6),&rdquo; September&nbsp;2007.</span><span>)</span></a> specifies the
  following mechanisms:
</p>
<p>Router Discovery, Prefix Discovery, Parameter Discovery, and
  Address Autoconfiguration are not used, as the necessary
  functionality is implemented in IKEv2.
</p>
<p>Address Resolution, Next-hop Determination, and Redirect are not
  used, as the virtual link does not have link-layer addresses, and is
  a point-to-point link.
</p>
<p>Neighbor Unreachability Detection could be used, but is a bit
  redundant given IKEv2 Dead Peer Detection.
</p>
<p>Duplicate Address Detection is not needed, because this is a
  point-to-point link, where the VPN gateway does not assign any
  addresses from the global unicast prefixes, and link-local interface
  identifier is negotiated separately.
</p>
<p>
	Duplicate Address Detection is not needed for global unicast addresses formed from the global unicast prefix(es) configured as part of the IKEv2 exchange, because this is a point-to-point link, where the VPN gateway does not assign any addresses from the global unicast prefixes. Duplicate Address Detection may be needed for link-local addresses, e.g., when the client configures a link-local address as per <a class='info' href='#RFC4941'>[RFC4941]<span> (</span><span class='info'>Narten, T., Draves, R., and S. Krishnan, &ldquo;Privacy Extensions for Stateless Address Autoconfiguration in IPv6,&rdquo; September&nbsp;2007.</span><span>)</span></a>.

</p>
<p>
	Thus, Duplicate Address Detection MAY be skipped for global unicast addresses formed from the global unicast prefix(es) configured as part of the IKEv2 exchange. However, Duplicate Address Detection for link-local unicast addresses MUST be performed as required per some other specifications, e.g., <a class='info' href='#RFC4941'>[RFC4941]<span> (</span><span class='info'>Narten, T., Draves, R., and S. Krishnan, &ldquo;Privacy Extensions for Stateless Address Autoconfiguration in IPv6,&rdquo; September&nbsp;2007.</span><span>)</span></a>.

</p>
<a name="xist-plds"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Relationship to Existing IKEv2 Payloads</h3>

<p>The mechanism described in this document is not intended to be
  used at the same time as the existing INTERNAL_IP6_ADDRESS
  attribute. For compatibility with gateways implementing only
  INTERNAL_IP6_ADDRESS, the VPN client MAY include attributes for both
  mechanisms in CFG_REQUEST. The capabilities and preferences of the
  VPN gateway will then determine which is used.
</p>
<p>All other attributes except INTERNAL_IP6_ADDRESS (and
  INTENAL_ADDRESS_EXPIRY) from <a class='info' href='#IKEv2'>[IKEv2]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> remain valid,
  including the somewhat confusingly named INTERNAL_IP6_SUBNET (see
  Section 6.3 of <a class='info' href='#RFC4718'>[RFC4718]<span> (</span><span class='info'>Eronen, P. and P. Hoffman, &ldquo;IKEv2 Clarifications and Implementation Guidelines,&rdquo; October&nbsp;2006.</span><span>)</span></a> for discussion).
</p>
<a name="payload"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Payload Formats</h3>

<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
INTERNAL_IP6_LINK Configuration Attribute</h3>

<p>The INTERNAL_IP6_LINK configuration attribute is formatted as
  follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
!R|         Attribute Type      !            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Link-Local                           |
|                         Interface ID                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                        IKEv2 Link ID                          ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p></p>
<ul class="text">
<li>Reserved (1 bit) - See <a class='info' href='#IKEv2'>[IKEv2]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
</li>
<li>Attribute Type (15 bits) - INTERNAL_IP6_LINK (TBD1).
</li>
<li>Length (2 octets) - Length in octets of the Value field (
    Link-Local Interface ID and IKEv2 Link ID); 8 or more.
</li>
<li>Link-Local Interface ID (8 octets) - The Interface ID used for
    link-local address (by the party that sent this attribute).
</li>
<li>IKEv2 Link ID (variable length) - The link ID (may be empty
    when the client does not yet know the link ID). The link ID is
    selected by the VPN gateway, and is treated as an opaque octet
    string by the client.
</li>
</ul>

<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
INTERNAL_IP6_PREFIX Configuration Attribute</h3>

<p>The INTERNAL_IP6_PREFIX configuration attribute is formatted as
  follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
!R|         Attribute Type      !            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                            Prefix                             |
|                                                               |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Prefix Length |
+-+-+-+-+-+-+-+-+
</pre></div>
<p></p>
<ul class="text">
<li>Reserved (1 bit) - See <a class='info' href='#IKEv2'>[IKEv2]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
</li>
<li>Attribute Type (15 bits) - INTERNAL_IP6_PREFIX (TBD2).
</li>
<li>Length (2 octets) - Length in octets of the Value field; 
    in this case, 17. 
</li>
<li>Prefix (16 octets) - An IPv6 prefix assigned to the virtual link. The
    low order bits of the prefix field which are not part of the prefix MUST be
    set to zero by the sender and MUST be ignored by the receiver.
</li>
<li>Prefix Length (1 octets) - The length of the prefix in bits;
    usually 64.
</li>
</ul>

<a name="link-id"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
LINK_ID Notify Payload</h3>

<p>The LINK_ID notification is included in CREATE_CHILD_SA requests
  to indicate that the SA being created is related to the virtual
  link. If this notification is not included, the CREATE_CHILD_SA
  requests is related to the real interface.
</p>
<p>The Notify Message Type for LINK_ID is TBD3. The Protocol ID and
  SPI Size fields are set to zero. The data associated with this
  notification is the IKEv2 Link ID returned in the INTERNAL_IP6_LINK
  configuration attribute.
</p>
<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
IANA Considerations</h3>

<p>This document defines two new IKEv2 configuration attributes,
  whose values are to be allocated (have been allocated) from the
  "IKEv2 Configuration Payload Attribute Types" namespace <a class='info' href='#IKEv2'>[IKEv2]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                    Multi-
   Value    Attribute Type          Valued  Length         Reference
   ------   ----------------------  ------  -------------  ---------
   TBD1     INTERNAL_IP6_LINK         NO    8 or more      [this doc]
   TBD2     INTERNAL_IP6_PREFIX       YES   17 octets      [this doc]
</pre></div>
<p>This document also defines one new IKEv2 notification, whose value is to
  be allocated (has been allocated) from the "IKEv2 Notify Message Types -
  Status Types" namespace <a class='info' href='#IKEv2'>[IKEv2]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   Value   Notify Messages - Status Types   Reference
   ------  -------------------------------  ---------
   TBD3    LINK_ID                          [this doc]
</pre></div>
<p>This document does not create any new namespaces to be maintained
  by IANA.
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Security Considerations</h3>

<p>
   Since this document is an extension to IKEv2, the security 
   considerations in <a class='info' href='#IKEv2'>[IKEv2]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> apply here as well.
   
</p>
<p>

		The mechanism described in this document assigns each client a
		unique prefix, which makes using randomized interface
		identifiers <a class='info' href='#RFC4941'>[RFC4941]<span> (</span><span class='info'>Narten, T., Draves, R., and S. Krishnan, &ldquo;Privacy Extensions for Stateless Address Autoconfiguration in IPv6,&rdquo; September&nbsp;2007.</span><span>)</span></a> ineffective from privacy
		point of view: the client is still uniquely identified by the
		prefix. In some environments, it may be preferable to assign a
		VPN client the same prefix each time a VPN connection is
		established; other environments may prefer assigning a
		different prefix every time for privacy reasons. (This is
		basically a similar trade-off as in Mobile IPv6 -- using the
		same Home Address forever is simpler than changing it often,
		but has privacy implications.)
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Acknowledgments</h3>

<p>The author would like to thank Patrick Irwin, Tero Kivinen, 
  Chinh Nguyen, Mohan Parthasarathy, Yaron Sheffer, Hemant Singh, Dave
  Thaler, Yinghzhe Wu, and Fan Zhao for their valuable comments.
</p>
<p>Many of the challenges associated with IPsec-protected "virtual
  interfaces" have been identified before: for example, in the context
  of protecting IPv6-in-IPv4 tunnels with IPsec <a class='info' href='#RFC4891'>[RFC4891]<span> (</span><span class='info'>Graveman, R., Parthasarathy, M., Savola, P., and H. Tschofenig, &ldquo;Using IPsec to Secure IPv6-in-IPv4 Tunnels,&rdquo; May&nbsp;2007.</span><span>)</span></a>, Provider Provisioned VPNs <a class='info' href='#VLINK'>[VLINK]<span> (</span><span class='info'>Duffy, M., &ldquo;Framework for IPsec Protected Virtual Links for PPVPNs,&rdquo; October&nbsp;2002.</span><span>)</span></a>
  <a class='info' href='#RFC3884'>[RFC3884]<span> (</span><span class='info'>Touch, J., Eggert, L., and Y. Wang, &ldquo;Use of IPsec Transport Mode for Dynamic Routing,&rdquo; September&nbsp;2004.</span><span>)</span></a>, and Mobile IPv6 <a class='info' href='#RFC4877'>[RFC4877]<span> (</span><span class='info'>Devarapalli, V. and F. Dupont, &ldquo;Mobile IPv6 Operation with IKEv2 and the Revised IPsec Architecture,&rdquo; April&nbsp;2007.</span><span>)</span></a>. Some of the limitations of assigning a single
  IPv6 address were identified in <a class='info' href='#RFC3314'>[RFC3314]<span> (</span><span class='info'>Wasserman, M., &ldquo;Recommendations for IPv6 in Third Generation Partnership Project 3GPP) Standards,&rdquo; September&nbsp;2002.</span><span>)</span></a>.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="IKEv2">[IKEv2]</a></td>
<td class="author-text">Kaufman, C., &ldquo;<a href="http://tools.ietf.org/html/rfc4306">Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4306, December&nbsp;2005.</td></tr>
<tr><td class="author-text" valign="top"><a name="IPv6Addr">[IPv6Addr]</a></td>
<td class="author-text">Hinden, R. and S. Deering, &ldquo;<a href="http://tools.ietf.org/html/rfc4291">IP Version 6 Addressing Architecture</a>,&rdquo; RFC&nbsp;4291, February&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="KEYWORDS">[KEYWORDS]</a></td>
<td class="author-text">Bradner, S., &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; RFC&nbsp;2119, March&nbsp;1997.</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="AUTOCONF">[AUTOCONF]</a></td>
<td class="author-text">Thomson, S., Narten, T., and T. Jinmei, &ldquo;<a href="http://tools.ietf.org/html/rfc4862">IPv6 Stateless Address Autoconfiguration</a>,&rdquo; RFC&nbsp;4862, September&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="CGA">[CGA]</a></td>
<td class="author-text">Aura, T., &ldquo;<a href="http://tools.ietf.org/html/rfc3972">Cryptographically Generated Addresses (CGA)</a>,&rdquo; RFC&nbsp;3972, March&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="DHCPv6">[DHCPv6]</a></td>
<td class="author-text">Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C., and M. Carney, &ldquo;<a href="http://tools.ietf.org/html/rfc3315">Dynamic Host Configuration Protocol for IPv6 (DHCPv6)</a>,&rdquo; RFC&nbsp;3315, July&nbsp;2003.</td></tr>
<tr><td class="author-text" valign="top"><a name="HBA">[HBA]</a></td>
<td class="author-text">Bagnulo, M., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-hba-05.txt">Hash Based Addresses (HBA)</a>,&rdquo; draft-ietf-shim6-hba-05 (work in progress), December&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="IPConfig">[IPConfig]</a></td>
<td class="author-text">Aboba, B., Thaler, D., Andersson, L., and S. Cheshire, &ldquo;<a href="http://tools.ietf.org/html/rfc5505">Principles of Internet Host Configuration</a>,&rdquo; RFC&nbsp;5505, May&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="IPv6ND">[IPv6ND]</a></td>
<td class="author-text">Narten, T., Nordmark, E., Simpson, W., and H. Soliman, &ldquo;<a href="http://tools.ietf.org/html/rfc4861">Neighbor Discovery for IP version 6 (IPv6)</a>,&rdquo; RFC&nbsp;4861, September&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="IPv6PPP">[IPv6PPP]</a></td>
<td class="author-text">Varada, S., Haskins, D., and E. Allen, &ldquo;<a href="http://tools.ietf.org/html/rfc5072">IP Version 6 over PPP</a>,&rdquo; RFC&nbsp;5072, September&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="MLDv2">[MLDv2]</a></td>
<td class="author-text">Vida, R. and L. Costa, &ldquo;<a href="http://tools.ietf.org/html/rfc3810">Multicast Listener Discovery Version 2 (MLDv2) for IPv6</a>,&rdquo; RFC&nbsp;3810, June&nbsp;2004.</td></tr>
<tr><td class="author-text" valign="top"><a name="MOBIKE">[MOBIKE]</a></td>
<td class="author-text">Eronen, P., &ldquo;<a href="http://tools.ietf.org/html/rfc4555">IKEv2 Mobility and Multihoming Protocol (MOBIKE)</a>,&rdquo; RFC&nbsp;4555, June&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="Multilink">[Multilink]</a></td>
<td class="author-text">Thaler, D., &ldquo;<a href="http://tools.ietf.org/html/rfc4903">Multi-Link Subnet Issues</a>,&rdquo; RFC&nbsp;4903, June&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="NDProxy">[NDProxy]</a></td>
<td class="author-text">Thaler, D., Talwar, M., and C. Patel, &ldquo;<a href="http://tools.ietf.org/html/rfc4389">Neighbor Discovery Proxies (ND Proxy)</a>,&rdquo; RFC&nbsp;4389, April&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3314">[RFC3314]</a></td>
<td class="author-text">Wasserman, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3314">Recommendations for IPv6 in Third Generation Partnership Project 3GPP) Standards</a>,&rdquo; RFC&nbsp;3314, September&nbsp;2002.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3456">[RFC3456]</a></td>
<td class="author-text">Patel, B., Aboba, B., Kelly, S., and V. Gupta, &ldquo;<a href="http://tools.ietf.org/html/rfc3456">Dynamic Host Configuration Protocol (DHCPv4) Configuration of IPsec Tunnel Mode</a>,&rdquo; RFC&nbsp;3456, January&nbsp;2003.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3633">[RFC3633]</a></td>
<td class="author-text">Troan, O. and R. Droms, &ldquo;<a href="http://tools.ietf.org/html/rfc3633">IPv6 Prefix Options for Dynamic Host Configuration Protocol (DHCP) version 6</a>,&rdquo; RFC&nbsp;3633, December&nbsp;2003.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3884">[RFC3884]</a></td>
<td class="author-text">Touch, J., Eggert, L., and Y. Wang, &ldquo;<a href="http://tools.ietf.org/html/rfc3884">Use of IPsec Transport Mode for Dynamic Routing</a>,&rdquo; RFC&nbsp;3884, September&nbsp;2004.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4193">[RFC4193]</a></td>
<td class="author-text">Hinden, R. and B. Haberman, &ldquo;<a href="http://tools.ietf.org/html/rfc4193">Unique Local IPv6 Unicast Addresses</a>,&rdquo; RFC&nbsp;4193, October&nbsp;2005.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4478">[RFC4478]</a></td>
<td class="author-text">Nir, Y., &ldquo;<a href="http://tools.ietf.org/html/rfc4478">Repeated Authentication in Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4478, April&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4718">[RFC4718]</a></td>
<td class="author-text">Eronen, P. and P. Hoffman, &ldquo;<a href="http://tools.ietf.org/html/rfc4718">IKEv2 Clarifications and Implementation Guidelines</a>,&rdquo; RFC&nbsp;4718, October&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4866">[RFC4866]</a></td>
<td class="author-text">Arkko, J., Vogt, C., and W. Haddad, &ldquo;<a href="http://tools.ietf.org/html/rfc4866">Enhanced Route Optimization for Mobile IPv6</a>,&rdquo; RFC&nbsp;4866, May&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4877">[RFC4877]</a></td>
<td class="author-text">Devarapalli, V. and F. Dupont, &ldquo;<a href="http://tools.ietf.org/html/rfc4877">Mobile IPv6 Operation with IKEv2 and the Revised IPsec Architecture</a>,&rdquo; RFC&nbsp;4877, April&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4891">[RFC4891]</a></td>
<td class="author-text">Graveman, R., Parthasarathy, M., Savola, P., and H. Tschofenig, &ldquo;<a href="http://tools.ietf.org/html/rfc4891">Using IPsec to Secure IPv6-in-IPv4 Tunnels</a>,&rdquo; RFC&nbsp;4891, May&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4941">[RFC4941]</a></td>
<td class="author-text">Narten, T., Draves, R., and S. Krishnan, &ldquo;<a href="http://tools.ietf.org/html/rfc4941">Privacy Extensions for Stateless Address Autoconfiguration in IPv6</a>,&rdquo; RFC&nbsp;4941, September&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5121">[RFC5121]</a></td>
<td class="author-text">Patil, B., Xia, F., Sarikaya, B., Choi, JH., and S. Madanapalli, &ldquo;<a href="http://tools.ietf.org/html/rfc5121">Transmission of IPv6 via the IPv6 Convergence Sublayer over IEEE 802.16 Networks</a>,&rdquo; RFC&nbsp;5121, February&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5213">[RFC5213]</a></td>
<td class="author-text">Gundavelli, S., Ed., Leung, K., Devarapalli, V., Chowdury, K., and B. Patil, &ldquo;<a href="http://tools.ietf.org/html/rfc5213">Proxy Mobile IPv6</a>,&rdquo; RFC&nbsp;5213, August&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="SHIM6">[SHIM6]</a></td>
<td class="author-text">Nordmark, E. and M. Bagnulo, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-shim6-proto-12.txt">Shim6: Level 3 Multihoming Shim Protocol for IPv6</a>,&rdquo; draft-ietf-shim6-proto-12 (work in progress), February&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="VLINK">[VLINK]</a></td>
<td class="author-text">Duffy, M., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-duffy-ppvpn-ipsec-vlink-00.txt">Framework for IPsec Protected Virtual Links for PPVPNs</a>,&rdquo; draft-duffy-ppvpn-ipsec-vlink-00 (work in progress), October&nbsp;2002.</td></tr>
</table>

<a name="design rationale"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Design Rationale (Non-Normative)</h3>

<p>This appendix describes some of the reasons why the solution in
  <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a> was selected, and lists some alternative
  designs that were considered, but ultimately rejected.
</p>
<p>Assigning a new IPv6 address to the client creates a new "virtual
  IPv6 interface", and "virtual link" between the client and the
  gateway. We will assume that the virtual link has the following
  properties:

  </p>
<ul class="text">
<li>The link and its interfaces are created and destroyed by the IKEv2
   process.
</li>
<li>The link is not an IPsec SA; at any time, there can be zero or
   more IPsec SAs covering traffic on this link.
</li>
<li>The link is not a single IKE SA; to support reauthentication, it
   must be possible to identify the same link in another IKE SA.
</li>
<li>Not all IPsec-protected traffic between the peers is necessarily
   related to the virtual link (although in the simplest VPN
   client-to-gateway scenario it will be).
</li>
</ul>

<p>Given these assumptions and the goals described in <a class='info' href='#limitations'>Section&nbsp;3<span> (</span><span class='info'>Current Limitations and Goals</span><span>)</span></a>, it seems that the most important design
  choices to be made are the following:
</p>
<p></p>
<ul class="text">
<li>What link/subnet model is used: in other words, the
    relationships between VPN clients, IPv6 subnet prefixes, and
    link-local traffic (especially link-local multicast).
</li>
<li>How information about the IPv6 prefix(es) is distributed from
    the gateway to the clients.
</li>
<li>How to ensure unique IPv6 addresses for each client, and keep
    forwarding state up-to-date accordingly.
</li>
<li>How layer 3 access control is done; in other words, where the
    mechanisms for preventing address spoofing by clients are placed
    architecturally.
</li>
</ul>

<p>Each of these is discussed next in turn.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
Link Model</h3>

<p>There are at least three main choices how to organize the 
  relationships between VPN clients, IPv6 subnet prefixes, 
  and link-local traffic:
</p>
<p></p>
<ul class="text">
<li>Point-to-point link model: each VPN client is assigned one or
    more IPv6 prefixes; these prefixes are not shared with other
    clients, and there is no link-local traffic between different VPN
    clients connected to the same gateway.
</li>
<li>Multi-access link model: multiple VPN clients share the same
    IPv6 prefix.  Link-local multicast packets sent by one VPN client
    will be received by other VPN clients (VPN gateway will forward
    the packets, possibly with MLD snooping to remove unnecessary
    packets).
</li>
<li>"Router aggregation" link model: one form of "multi-link" subnet
    <a class='info' href='#Multilink'>[Multilink]<span> (</span><span class='info'>Thaler, D., &ldquo;Multi-Link Subnet Issues,&rdquo; June&nbsp;2007.</span><span>)</span></a> where multiple VPN clients share the
    same IPv6 prefix. Link-local multicast will not be received by
    other VPN clients.
</li>
</ul>

<p>In the multi-access link model, VPN clients who are idle (i.e.,
  not currently sending or receiving application traffic) could
  receive significant amounts of multicast packets from other clients
  (depending on how many other clients are connected). This is
  especially undesirable when the clients are battery-powered; for
  example, a PDA which keeps the VPN connection to corporate intranet
  active 24/7. For this reason, using the multi-access link model was
  rejected.
</p>
<p>The configuration attributes specified in <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a> use the point-to-point link model.
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.2"></a><h3>A.2.&nbsp;
Distributing Prefix Information</h3>

<p>Some types of addresses, such as CGAs, require knowledge about
  the prefix before an address can be generated. The prefix
  information could be distributed to clients in the following
  ways:
</p>
<p></p>
<ul class="text">
<li>IKEv2 messages (Configuration Payloads).
</li>
<li>Router Advertisement messages (sent over the IPsec tunnel).
</li>
<li>DHCPv6 messages (sent over the IPsec tunnel).
</li>
</ul>

<p>In <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a>, the prefix information is
  distributed in IKEv2 messages.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.3"></a><h3>A.3.&nbsp;
Unique Address Allocation</h3>

<p>In the "multi-access" and "router aggregation" link models (where
  a single IPv6 prefix is shared between multiple VPN clients)
  mechanisms are needed to ensure that one VPN client does not use an
  address already used by some other client. Also, the VPN gateway has
  to know which client is using which addresses in order to correctly
  forward traffic.
</p>
<p>The main choices seem to be the following:
</p>
<p></p>
<ul class="text">
<li>Clients receive the address(es) they are allowed to use
    in IKEv2 messages (Configuration Payloads). In this case,
    keeping track of which client is using which address is trivial.
</li>
<li>Clients receive the address(es) they are allowed to use in
    DHCPv6 messages sent over the IPsec tunnel. In case the DHCPv6
    server is not integrated with the VPN gateway, the gateway may
    need to work as a relay agent to keep track of which client is
    using which address (and update its forwarding state
    accordingly).
</li>
<li>Clients can use stateless address autoconfiguration to
    configure addresses and perform Duplicate Address Detection
    (DAD). This is easy to do in multi-access link model, and can be
    made to work with router aggregation link model if the VPN gateway
    traps Neighbor Solicitation (NS) messages and spoofs Neighbor
    Advertisement (NA) replies.  The gateway keeps track of which client is
    using which address (and updates its forwarding state accordingly)
    by trapping these NS/NA messages.
</li>
</ul>

<p>In the point-to-point link model, the client can simply use any
  address from the prefix, and the VPN gateway only needs to know
  which client is using which prefix in order to forward packets
  correctly.
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.4"></a><h3>A.4.&nbsp;
Layer 3 Access Control</h3>

<p>It is almost always desirable to prevent one VPN client from
  sending packets with a source address that is used by another VPN
  client. In order to correctly forward packets destined to clients,
  the VPN gateway obviously has to know which client is using which
  address; the question is therefore where, architecturally, the
  mechanisms for ingress filtering are placed.
</p>
<p></p>
<ul class="text">
<li>Layer 3 access control enforced by IPsec SAD/SPD: the
    addresses/prefixes assigned to a VPN client are reflected in the
    traffic selectors used in IPsec Security Association and Security
    Policy Database entries, as negotiated in IKEv2.
</li>
<li>The ingress filtering capability could be placed outside IPsec; 
    the traffic selectors in SAD/SPD entries would cover traffic
    that would be dropped later by ingress filtering.
</li>
</ul>

<p>The former approach is used by the current IPv4 solution, 
  and the mechanism specified in <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a>.
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.5"></a><h3>A.5.&nbsp;
Other Considerations</h3>

<p></p>
<blockquote class="text"><dl>
<dt>VPN gateway state</dt>
<dd>
   <br />
 In some combinations of design choices,
   the amount of state information required in the VPN gateway depends
   not only on the number of clients, but also on the number of addresses
   used by one client. With privacy addresses and potentially some uses 
   of Cryptographically Generated Addresses (CGAs), a single client
   could have a large number of different addresses (especially if 
   different privacy addresses are used with different destinations).
</dd>
<dt>Virtual link identifier</dt>
<dd>
   <br />
 Reauthentication requires a way to
   uniquely identify the virtual link when a second IKE SA is
   created. Some possible alternatives are the IKE SPIs of the IKE SA
   where the virtual link was "created" (assuming we can't have
   multiple virtual links within the same IKE SA), a new identifier
   assigned when the link is created, or any unique prefix or address
   that remains assigned to the link for its entire lifetime. 
   <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a> specifies that the gateway assigns a new
   IKEv2 Link ID when the link is created. The client treats the
   Link ID as an opaque octet string; the gateway uses it to
   identify relevant local state when reauthentication is done.

   <br />
<br />
 Note that the link is not uniquely
   identified by the IKE peer identities (because IDi is often a user
   identity that can be used on multiple hosts at the same time), or
   the outer IP addresses of the peers (due to NAT Traversal and
   <a class='info' href='#MOBIKE'>[MOBIKE]<span> (</span><span class='info'>Eronen, P., &ldquo;IKEv2 Mobility and Multihoming Protocol (MOBIKE),&rdquo; June&nbsp;2006.</span><span>)</span></a>).
</dd>
<dt>Prefix lifetime</dt>
<dd>
  <br />
 Prefixes could remain valid either for the
  lifetime of the IKE SA, until explicitly cancelled, or for an
  explicitly specified time.  In <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a> the
  prefixes remain valid for the lifetime of the IKE SA (and its
  continuations via rekeying, but not reauthentication).  If
  necessary, the VPN gateway can thus add or remove prefixes by
  triggering reauthentication. It is assumed that adding or removing
  prefixes is a relatively rare situation, and thus this document does
  not specify more complex solutions (such as explicit prefix
  lifetimes, or use of CFG_SET/CFG_ACK).
</dd>
<dt>Compatibility with other IPsec uses</dt>
<dd>
  <br />

  Compatibility with other IPsec uses probably requires that when a
  CHILD_SA is created, both peers can determine whether the CHILD_SA
  applies to the virtual interface (at the end of the virtual link),
  or the real interfaces IKEv2 messages are being sent over.
  This is required to select the correct SPD to be used for
  traffic selector narrowing and SA authorization in general.

  <br />
<br />
 One straight-forward solution is to add an
  extra payload to CREATE_CHILD_SA requests, containing the virtual
  link identifier. Requests not containing this payload would refer to
  the real link (over which IKEv2 messages are being sent).

  <br />
<br />

  Another solution is to require that the peer requesting
  a CHILD_SA proposes traffic selectors that identify the link.
  For example, if TSi includes the peer's "outer" IP address, it's
  probably related to the real interface, not the virtual one.
  Or if TSi includes any of the prefixes assigned by the gateway
  (or the link-local or multicast prefix), it is probably related
  to the virtual interface.

  <br />
<br />

  These heuristics can work in many
  situations, but have proved inadequate in the context of
  IPv6-in-IPv4 tunnels <a class='info' href='#RFC4891'>[RFC4891]<span> (</span><span class='info'>Graveman, R., Parthasarathy, M., Savola, P., and H. Tschofenig, &ldquo;Using IPsec to Secure IPv6-in-IPv4 Tunnels,&rdquo; May&nbsp;2007.</span><span>)</span></a> and Provider
  Provisioned VPNs <a class='info' href='#VLINK'>[VLINK]<span> (</span><span class='info'>Duffy, M., &ldquo;Framework for IPsec Protected Virtual Links for PPVPNs,&rdquo; October&nbsp;2002.</span><span>)</span></a> <a class='info' href='#RFC3884'>[RFC3884]<span> (</span><span class='info'>Touch, J., Eggert, L., and Y. Wang, &ldquo;Use of IPsec Transport Mode for Dynamic Routing,&rdquo; September&nbsp;2004.</span><span>)</span></a>,
  and Mobile IPv6 <a class='info' href='#RFC4877'>[RFC4877]<span> (</span><span class='info'>Devarapalli, V. and F. Dupont, &ldquo;Mobile IPv6 Operation with IKEv2 and the Revised IPsec Architecture,&rdquo; April&nbsp;2007.</span><span>)</span></a>. Thus, <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a> includes the virtual link identifier
  in all CREATE_CHILD_SA requests that apply to the virtual
  interface.
</dd>
<dt>Example about other IPsec uses:</dt>
<dd>

  <br />

  If a VPN gateway receives a CREATE_CHILD_SA request
  associated with a physical Ethernet interface, requesting SA for
  (TSi=FE80::something, dst=*), it would typically reject the request
  (or in other words, narrow it to an empty set) because it doesn't
  have SPD/PAD entries that would allow joe.user@example.com to
  request such CHILD_SAs.

  <br />
<br />

  (However, it might have SPD/PAD entries that would allow
  "neighboring-router.example.com" to create such SAs, for protecting
  e.g. some routing protocol that uses link-local addresses.)

  <br />
<br />

  However, the virtual interface created when joe.user@example.com
  authenticated and sent INTERNAL_IP6_LINK would have a different
  SPD/PAD, which would allow joe.user@example.com to create this
  SA.
</dd>
</dl></blockquote>

<a name="alt-sol"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.6"></a><h3>A.6.&nbsp;
Alternative Solution Sketches</h3>

<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.6.1"></a><h3>A.6.1.&nbsp;
Version -00 Sketch</h3>

<p>The -00 version of this draft contained the following solution
  sketch, which is basically a combination of (1) point-to-point link
  model, (2) prefix information distributed in Neighbor
  Advertisements, and (3) access control enforced outside IPsec.
</p>
<p>1) During IKE_AUTH, client sends a new configuration attribute,
  INTERNAL_IP6_LINK, which requests a virtual link to be created.  The
  attribute contains the client's interface ID for link-local address
  (other addresses may use other interface IDs).
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REQUEST) =
      { INTERNAL_IP6_LINK(Link-Local Interface ID) }
   TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
   TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;
</pre></div>
<p>The VPN gateway replies with its own link-local interface ID
  (which has to be different from the client's) and an IKEv2 Link ID
  (which will be used for reauthentication).
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REPLY) =
     { INTERNAL_IP6_LINK(Link-Local Interface ID, IKEv2 Link ID) }
   TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
   TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
</pre></div>
<p>At this point, both peers configure the virtual interface with
  the link-local addresses.
</p>
<p>2) The next step is IPv6 stateless address autoconfiguration;
  that is, Router Solicitation and Router Advertisement messages sent
  over the IPsec SA.  
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   ESP(Router Solicitation:
       src=::,
       dst=FF02:0:0:0:0:0:0:2)  --&gt;

   &lt;-- ESP(Router Advertisement:
           src=FE80::&lt;Gateway's Interface ID&gt;
           dst=FF02:0:0:0:0:0:0:1,
           Prefix1, [Prefix2...])
</pre></div>
<p>After receiving the Router Advertisement, the client can
  configure unicast addresses from the advertised prefixes, using any
  proper interface ID. The VPN gateway does not simultaneously assign the
  same prefixes to any other client, and does not itself configure
  addresses from these prefixes. Thus, the client does not have to
  perform Duplicate Address Detection (DAD).
</p>
<p>3) Reauthentication works basically the same way as in
  <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a>; the client includes the IKEv2 Link ID
  in the INTERNAL_IP6_LINK attribute.
</p>
<p>4) Creating and rekeying IPsec SAs works basically the same way
  as in <a class='info' href='#childsas'>Section&nbsp;4.3<span> (</span><span class='info'>Creating CHILD_SAs</span><span>)</span></a>; the client includes the IKEv2 Link
  ID in those CHILD_SA requests that are related to the virtual
  link.
</p>
<p>Comments: This was changed in -01 draft based on feedback from
  VPN vendors: while the solution looks nice on paper, it is claimed
  to be unneccessarily complex to implement when the IKE
  implementation and IPv6 stack are from different
  companies. Furthermore, enforcing access control outside IPsec is a
  significant architectural change compared to current IPv4
  solutions.
</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.6.2"></a><h3>A.6.2.&nbsp;
Router Aggregation Sketch #1</h3>

<p>The following solution was sketched during the IETF 70 meeting in
  Vancouver together with Hemant Singh.  It combines the (1) router
  aggregation link model, (2) prefix information distributed in IKEv2
  messages, (3) unique address allocation with stateless address
  autoconfiguration (with VPN gateway trapping NS messages and
  spoofing NA replies), and (4) access control enforced (partly)
  outside IPsec.
</p>
<p>1) During IKE_AUTH, the client sends a new configuration
  attribute, INTERNAL_IP6_LINK, which requests a virtual link to be
  created. The attribute contains the client's interface ID for
  link-local address (other addresses may use other interface IDs).
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REQUEST) =
      { INTERNAL_IP6_LINK(Link-Local Interface ID) }
   TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
   TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;
</pre></div>
<p>The VPN gateway replies with its own link-local interface ID
  (which has to be different from the client's), an IKEv2 Link ID (which
  will be used for reauthentication and CREATE_CHILD_SA messages), and
  zero or more INTERNAL_IP6_PREFIX attributes. The traffic selectors
  proposed by the initiator are also narrowed to contain only 
  the assigned prefixes (and the link-local prefix).
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REPLY) =
      { INTERNAL_IP6_LINK(Link-Local Interface ID, IKEv2 Link ID),
        INTERNAL_IP6_PREFIX(Prefix1/64),
        [INTERNAL_IP6_PREFIX(Prefix2/64),...],
        INTERNAL_IP6_DHCP(Address) ]
   TSi = ((0, 0-65535,
           FE80::&lt;Client's Interface ID&gt; -
           FE80::&lt;Client's Interface ID&gt;)
          (0, 0-65535,
           Prefix1::0 -
           Prefix1::FFFF:FFFF:FFFF:FFFF),
          [(0, 0-65535,
            Prefix2::0 -
            Prefix2::FFFF:FFFF:FFFF:FFFF), ...])
   TSr = (0, 0-65535,
          0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
</pre></div>
<p>2) The client now configures tentative unicast addresses from the
  prefixes given by the gateway, and performs Duplicate Address
  Detection (DAD) for them.
</p>
<p>The Neighbor Solicitation messages are processed by the VPN
  gateway: if the target address is already in use by some other VPN
  client, the gateway replies with a Neighbor Advertisement. If the
  target address is not already in use, the VPN gateway notes that it
  is now being used by this client, and updates its forwarding state
  accordingly.
</p>
<p>Comments: The main disadvantages of this solution are
  non-standard processing of NS messages (which are used to update the
  gateway's forwarding state), and performing access control partly
  outside IPsec.
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.6.3"></a><h3>A.6.3.&nbsp;
Router Aggregation Sketch #2</h3>

<p>This is basically similar to the version -00 sketch
  described with above, but uses router aggregation link model. In
  other words, it combines (1) router aggregation link model, (2)
  prefix information distributed in Neighbor Advertisements, (3)
  unique address allocation with stateless address autoconfiguration
  (with VPN gateway trapping NS messages and spoofing NA replies), and
  (4) access control enforced outside IPsec.
</p>
<p>1) During IKE_AUTH, client sends a new configuration attribute,
  INTERNAL_IP6_LINK, which requests a virtual link to be created.  The
  attribute contains the client's interface ID for link-local address
  (other addresses may use other interface IDs).
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REQUEST) =
      { INTERNAL_IP6_LINK(Link-Local Interface ID) }
   TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
   TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;
</pre></div>
<p>The VPN gateway replies with its own link-local interface ID
  (which has to be different from the client's) and an IKEv2 Link ID
  (which will be used for reauthentication).
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REPLY) =
     { INTERNAL_IP6_LINK(Link-Local Interface ID, IKEv2 Link ID) }
   TSi = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
   TSr = (0, 0-65535, 0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
</pre></div>
<p>At this point, both peers configure the virtual interface with
  the link-local addresses.
</p>
<p>2) The next step is IPv6 stateless address autoconfiguration;
  that is, Router Solicitation and Router Advertisement messages sent
  over the IPsec SA.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  ESP(Router Solicitation:
      src=::,
      dst=FF02:0:0:0:0:0:0:2)  --&gt;

  &lt;-- ESP(Router Advertisement:
          src=FE80::&lt;Gateway's Interface ID&gt;
          dst=FF02:0:0:0:0:0:0:1,
          Prefix1, [Prefix2...])
</pre></div>
<p>3) The client now configures tentative unicast addresses from the
  prefixes given by the gateway, and performs Duplicate Address
  Detection (DAD) for them.
</p>
<p>The Neighbor Solicitation messages are processed by the VPN
  gateway: if the target address is already in use by some other VPN
  client, the gateway replies with a Neighbor Advertisement. If the
  target address is not already in use, the VPN gateway notes that it
  is now being used by this client, and updates its forwarding state
  accordingly.
</p>
<p>Comments: The main disadvantages of this solution are
  non-standard processing of NS messages (which are used to update the
  gateway's forwarding state), and performing access control outside
  IPsec.
</p>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.6.4"></a><h3>A.6.4.&nbsp;
IPv4-like Sketch</h3>

<p>This sketch resembles the current IPv4 configuration payloads,
  and it combines (1) router aggregation link model, (2) prefix
  information distributed in IKEv2 messages, (3) unique address
  allocation with IKEv2 messages, and (4) access control enforced by
  IPsec SAD/SPD.
</p>
<p>1) During IKE_AUTH, the client sends a new configuration
  attribute, INTERNAL_IP6_LINK, which requests a virtual link to be
  created. The attribute contains the client's interface ID for
  link-local address (other addresses may use other interface
  IDs).
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REQUEST) =
      { INTERNAL_IP6_LINK(Link-Local Interface ID) }
   TSi = (0, 0-65535,
          0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
   TSr = (0, 0-65535,
          0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;
</pre></div>
<p>The VPN gateway replies with its own link-local interface ID
  (which has to be different from the client's), an IKEv2 Link ID (which
  will be used for reauthentication and CREATE_CHILD_SA messages), and
  zero or more INTERNAL_IP6_ADDRESS2 attributes. Each attribute contains
  one address from a particular prefix.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REPLY) =
      { INTERNAL_IP6_LINK(Link-Local Interface ID, IKEv2 Link ID),
        INTERNAL_IP6_ADDRESS2(Prefix1+Client's Interface ID1),
        [INTERNAL_IP6_ADDRESS2(Prefix2+Client's Interface ID2),...],
   TSi = ((0, 0-65535,
           FE80::&lt;Client's Link-Local Interface ID&gt; -
           FE80::&lt;Client's Link-Local Interface ID&gt;)
          (0, 0-65535,
           Prefix1::&lt;Client's Interface ID1&gt; -
           Prefix1::&lt;Client's Interface ID1&gt;),
          [(0, 0-65535,
            Prefix2::&lt;Client's Interface ID2&gt; -
            Prefix2::&lt;Client's Interface ID2&gt;), ...])
   TSr = (0, 0-65535,
          0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
</pre></div>
<p>Since the VPN gateway keeps track of address uniqueness, there is
  no need to perform Duplicate Address Detection.
</p>
<p>2) If the client wants additional addresses later (for example,
  with specific interface ID), it requests them in a separate
  CREATE_CHILD_SA exchange. For example:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REQUEST) =
      { INTERNAL_IP6_ADDRESS2(Prefix1+Client's Interface ID3) }
   TSi = (0, 0-65535,
          Prefix1::0 -
          Prefix1::FFFF:FFFF:FFFF:FFFF&gt;),
   TSr = (0, 0-65535,
          0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)  --&gt;
</pre></div>
<p>If the requested address is not currently in use by some other
  client, the VPN gateway simply returns the same address, and traffic
  selectors narrowed appropriately.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   CP(CFG_REQUEST) =
      { INTERNAL_IP6_ADDRESS2(Prefix1+Client's Interface ID3) }
   TSi = ((0, 0-65535,
           Prefix1::&lt;Client's Interface ID3&gt; -
           Prefix1::&lt;Client's Interface ID3&gt;),
   TSr = (0, 0-65535,
          0:0:0:0:0:0:0:0 -
          FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF)
</pre></div>
<p>Comments: The main advantage of this solution is that it's quite
  close to the current IPv4 way of doing things. By adding explicit
  link creation (with Link ID for reauthentication/SPD selection, and
  link-local addresses), and slightly changing the semantics (and also
  name) of INTERNAL_IP6_ADDRESS attribute (can return more attributes
  than was asked), we get much of the needed functionality.
</p>
<p>The biggest disadvantages are probably potentially complex
  implementation dependency for interface ID selection (see <a class='info' href='#iidselection'>Section&nbsp;3.3<span> (</span><span class='info'>Interface Identifier Selection</span><span>)</span></a>), and the multi-link subnet model.
</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.6.5"></a><h3>A.6.5.&nbsp;
Sketch Based on RFC 3456</h3>

<p>For completeness: a solution modeled after <a class='info' href='#RFC3456'>[RFC3456]<span> (</span><span class='info'>Patel, B., Aboba, B., Kelly, S., and V. Gupta, &ldquo;Dynamic Host Configuration Protocol (DHCPv4) Configuration of IPsec Tunnel Mode,&rdquo; January&nbsp;2003.</span><span>)</span></a> would combine (1) router aggregation link model,
  (2) prefix information distribution and unique address allocation
  with DHCPv6, and (3) access control enforced by IPsec SAD/SPD.
</p>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
Evaluation (Non-Normative)</h3>

<p>

		<a class='info' href='#limitations'>Section&nbsp;3<span> (</span><span class='info'>Current Limitations and Goals</span><span>)</span></a>described the goals and
		requirements for IPv6 configuration in IKEv2. This appendix
		briefly summarizes how the solution specified in <a class='info' href='#solution'>Section&nbsp;4<span> (</span><span class='info'>Solution Details</span><span>)</span></a> and <a class='info' href='#payload'>Section&nbsp;5<span> (</span><span class='info'>Payload Formats</span><span>)</span></a> meets
		these goals.

   	</p>
<ul class="text">
<li>  (3.1) Assigning addresses from multiple prefixes is supported, 
      without requiring the client to know beforehand how many prefixes 
      are needed.

      
</li>
<li>  (3.2) Link-local addresses are assigned, and can be used for
      protocols between the VPN client and gateway.
      
      
</li>
<li>  (3.3) The entire prefix is assigned to a single client, so 
      the client can freely select any number of interface IDs (which 
      may depend on the prefix.)

      
</li>
<li>  (3.4) This document does not specify how the VPN client would
      share the VPN connection with other devices. However, since the
      entire prefix is assigned to a single client, the client could 
      further assign addresses from it without requiring coordination
      with the VPN gateway.

      
</li>
<li>  (3.5) The solution does not add any new periodic messages over 
      the VPN tunnel.

      
</li>
<li>  (3.5) Re-authentication works (see <a class='info' href='#reauth'>Section&nbsp;4.2<span> (</span><span class='info'>Reauthentication</span><span>)</span></a>.) 

      
</li>
<li>  (3.5) The solution is compatible with other IPsec uses, since 
      the LINK_ID notification makes it unambiguous which CHILD_SAs 
      are related to the virtual link and which are not (see <a class='info' href='#childsas'>Section&nbsp;4.3<span> (</span><span class='info'>Creating CHILD_SAs</span><span>)</span></a> and <a class='info' href='#link-id'>Section&nbsp;5.3<span> (</span><span class='info'>LINK_ID Notify Payload</span><span>)</span></a>.)

      
</li>
<li>  (3.5) The new mechanisms do not prevent the VPN client and/or 
      gateway from implementing the INTERNAL_IP6_ADDRESS configuration
      attribute as well; however, the two mechanisms are not intended 
      to be used simultaneously (see <a class='info' href='#xist-plds'>Section&nbsp;4.5<span> (</span><span class='info'>Relationship to Existing IKEv2 Payloads</span><span>)</span></a>.)

      
</li>
<li>  (3.5) Implementation dependencies are, obviously, implementation 
      dependant (and their cleanliness somewhat subjective.) Possible 
      drawbacks of some alternative solutions are discussed in 
      <a class='info' href='#alt-sol'>Appendix&nbsp;A.6<span> (</span><span class='info'>Alternative Solution Sketches</span><span>)</span></a>.

      
</li>
<li>  (3.5) The mechanism for configuring the prefixes (configuration
      payloads) is specific to IKEv2, for reasons described in 
      <a class='info' href='#design rationale'>Appendix&nbsp;A<span> (</span><span class='info'>Design Rationale (Non-Normative)</span><span>)</span></a>. However, <a class='info' href='#init-xchg'>Section&nbsp;4.1<span> (</span><span class='info'>Initial Exchanges</span><span>)</span></a>
      recommends using DHCPv6 Information-Request
      message for obtaining other configuration information (such as DNS
      server addresses.)
</li>
</ul><p>
      
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Pasi Eronen</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nokia Research Center</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.O. Box 407</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FIN-00045 Nokia Group</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:pasi.eronen@nokia.com">pasi.eronen@nokia.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Julien Laganier</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">QUALCOMM Incorporated</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5775 Morehouse Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Diego, CA  92121</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 858 858 3538</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:julienl@qualcomm.com">julienl@qualcomm.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cheryl Madson</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">510 MacCarthy Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Milpitas, CA</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:cmadson@cisco.com">cmadson@cisco.com</a></td></tr>
</table>
</body></html>
