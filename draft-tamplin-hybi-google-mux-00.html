<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>A Mulplexing Extension for WebSockets</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Overview">
<link href="#rfc.section.2" rel="Chapter" title="2 Interaction with other Extensions / Framing Mechanisms">
<link href="#rfc.section.3" rel="Chapter" title="3 Channels">
<link href="#rfc.section.4" rel="Chapter" title="4 Flow Control">
<link href="#rfc.section.5" rel="Chapter" title="5 Framing">
<link href="#rfc.section.6" rel="Chapter" title="6 Multiplex Control Frames">
<link href="#rfc.section.7" rel="Chapter" title="7 Examples">
<link href="#rfc.section.8" rel="Chapter" title="8 Client Behavior">
<link href="#rfc.section.9" rel="Chapter" title="9 Buffering">
<link href="#rfc.section.10" rel="Chapter" title="10 Fairness">
<link href="#rfc.section.11" rel="Chapter" title="11 Proxies">
<link href="#rfc.section.12" rel="Chapter" title="12 Nesting">
<link href="#rfc.section.13" rel="Chapter" title="13 Security Considerations">
<link href="#rfc.references" rel="Chapter" title="14 References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="" />
  <meta name="description" content="" />
  <meta name="keywords" content="HYBI, websocket, multiplexing" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">HyBi Working Group</td>
<td class="right">J.A. Tamplin</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">T. Yoshino</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">Google, Inc.</td>
</tr>
<tr>
<td class="left">Expires: April 23, 2012</td>
<td class="right">October 21, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">A Mulplexing Extension for WebSockets<br />
  <span class="filename">draft-tamplin-hybi-google-mux-00</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p><a href="#WS">The WebSocket Protocol</a> <cite title="NONE">[WS]</cite> requires a new transport connection for every WebSocket connection.  This presents a scalability problem when many clients connect to the same server, and is made worse by having multiple clients running in different tabs of the same user agent.  This extension provides a way for separate logical WebSocket connections to share an underlying transport connection.</p>
<p>Please send feedback to the hybi@ietf.org mailing list.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted to IETF in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on April 23, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Overview</a>
</li>
<li>2.   <a href="#rfc.section.2">Interaction with other Extensions / Framing Mechanisms</a>
</li>
<li>3.   <a href="#rfc.section.3">Channels</a>
</li>
<li>4.   <a href="#rfc.section.4">Flow Control</a>
</li>
<li>5.   <a href="#rfc.section.5">Framing</a>
</li>
<li>6.   <a href="#rfc.section.6">Multiplex Control Frames</a>
</li>
<li>7.   <a href="#rfc.section.7">Examples</a>
</li>
<li>8.   <a href="#rfc.section.8">Client Behavior</a>
</li>
<li>9.   <a href="#rfc.section.9">Buffering</a>
</li>
<li>10.   <a href="#rfc.section.10">Fairness</a>
</li>
<li>11.   <a href="#rfc.section.11">Proxies</a>
</li>
<li>12.   <a href="#rfc.section.12">Nesting</a>
</li>
<li>13.   <a href="#rfc.section.13">Security Considerations</a>
</li>
<li>14.   <a href="#rfc.references">References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Overview</h1>
<p id="rfc.section.1.p.1">This document describes a MUX extension to the WebSocket protocol.  Initially, it will be identified by the private-use token "x-google-mux".  A client that supports this extension will advertise support for it in the initial handshake using the "Sec-WebSocket-Extensions" header.  If the server supports this extension and supports parameters compatible with the client's request, it accepts the use of this extension in the handshake response.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Interaction with other Extensions / Framing Mechanisms</h1>
<p id="rfc.section.2.p.1">Any compression extensions negotiated apply only to the channel they are negotiated on -- therefore, any compression extension in the initial handshake applies only to logical channel 1.  If WebSocket payload data is masked by a per-frame key, such masking is applied to frames for each logical channel separately.</p>
<p id="rfc.section.2.p.2">If other negotiated extensions define extension data, the other extension defines whether it applies to just one logical channel (it is expected that most extensions will do so) or the physical channel.  If the other extension applies to one logical channel, it always comes after the MUX extension data; otherwise the order depends on the order the extensions were listed during the handshake response.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Channels</h1>
<p id="rfc.section.3.p.1">The MUX extension maintains separate logical channels, each of which is fully the logical equivalent of an independent WebSocket connection, including separate handshake headers.  If the MUX extension is successfully negotiated, the headers on the initial handshake are automatically taken to mean channel 1, which is implicitly opened by completing the handshake.  New channels are added by the client issuing the AddChannel command (note that only the client may initiate new WebSocket connections), including any request headers which do not have the same value as the initial handshake.  The server's AddChannel response likewise includes any response headers which are different from the initial handshake (the details of this are TBD, but a simple suggestion for a delta encoding is given below).  Channel 0 is reserved for mux control messages and does not contain payload data from any logical channel.  A client which attempts to add a channel to an existing connection that is not accepted by the server SHOULD attempt a new WebSocket connection.</p>
<p id="rfc.section.3.p.2">Once the MUX extension is negotiated on a connection, all frames must be prefixed with a channel number in the extension data field.  Control frames with a channel id 0 refer to the physical connection, other control frames MUST be delivered on the logical channel in order with data frames for that logical channel.  Control frames SHOULD be sent only on channel 0 where possible, though control frames for other extensions in particular may need to apply to individual logical channels.</p>
<p id="rfc.section.3.p.3">A receiver MUST fail the physical connection and all open logical channels if any of these rules are violated by the sender.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Flow Control</h1>
<p id="rfc.section.4.p.1">Each logical channel, including the implicitly created channel 1, is initially given a quota of bytes that may be transmitted in each direction without acknowledgement.  It is illegal to send more bytes than the remaining quota, and the receiver MUST fail the logical channel for any sender that does so.  This quota is replenished via control messages as the receiver processes the data.</p>
<p id="rfc.section.4.p.2">The initial quota is specified with the "quota" extension parameter, and defaults to 64k (TBD) if it is not specified.  The client and server each may specify a "quota" parameter and these are unrelated -- each specifies how many bytes the other side may send without acknowledgement.  The quota values in the initial handshake apply to the implicitly opened channel 1.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> Framing</h1>
<p id="rfc.section.5.p.1">If the extension is successfully negotiated during the handshake, all frames have a channel id in the extension data.  The channel ID is encoded as a variable number of bytes, as follows:</p>
<div id="#rfc.figure.1"></div>
<pre>
  0 1 2 3 4 5 6 7
 +-+-------------+
 |0|channel id(7)|
 +-+-------------+

  0                   1
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
 +-+-+---------------------------+
 |1|0|      channel id (14)      |
 +-+-+---------------------------+

  0                   1                   2
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3
 +-+-+-+-----------------------------------------+
 |1|1|0|             channel id (21)             |
 +-+-+-+-----------------------------------------+

  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+---------------------------------------------------------+ 
 |1|1|1|                     channel id (29)                     | 
 +-+-+-+---------------------------------------------------------+ 
      </pre>
<p id="rfc.section.5.p.2">The base spec requires that a sequence of frames on the wire be a frame with an opcode other than 0, zero or more frames with opcode 0 and the FIN bit clear, and terminated by a frame with the FIN bit set (which may be the initial frame in the case of an unfragmented message).  The MUX extension relaxes this requirement to be for just frames of one logical channel, and that frames of other logical channels may be interleaved arbitrarily.</p>
<p id="rfc.section.5.p.3">All frames with a non-zero channel id must be delivered to the specified logical channel in the order they are received, though fragmentation may be changed if appropriate.  Control frames with a non-zero channel id may also trigger additional processing by the MUX extension.</p>
<p id="rfc.section.5.p.4">Control frames with a channel id of 0 refer to the physical connection, and may also trigger additional processing - for example, a close frame on the physical channel will close all logical channels as well (details TBD).</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> Multiplex Control Frames</h1>
<p id="rfc.section.6.p.1">Data frames with a channel id of 0 are MUX control frames.  Unless another negotiated extension defines a meaning for them, any frames on channel 0 with an opcode other than "binary" MUST trigger a failure of the physical connection.  Binary frames on channel 0 are MUX control frames, and the payload consists of a zero or more MUX control blocks, each defined as follows:</p>
<p id="rfc.section.6.p.2">The opcodes defined are:</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> Examples</h1>
<p><em>This section is non-normative.</em></p>
<p id="rfc.section.7.p.2">The examples below assume the handshake has already completed and the x-google-mux extension was negotiated.</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Client Behavior</h1>
<p id="rfc.section.8.p.1">When a client is asked to make a new WebSocket connection, it MAY choose to use an existing WebSocket connection if all of the following are true:</p>
<p id="rfc.section.8.p.2">If the client chooses to reuse an existing MUXd connection, it sends an AddChannel message as described above.  If the AddChannel is successful, WebSocket frames may be sent over that channel as normal.  If the server rejects the AddChannel, the client SHOULD attempt to open a new physical WebSocket connection (for example, in a shared hosting environment a server may not be prepared to multiplex connections from different customers despite having a single IP address for them).</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> Buffering</h1>
<p id="rfc.section.9.p.1">There will be lots of small frames sent in this protocol (particularly replenishing send quotas), so a sender SHOULD attempt to aggregate MUX blocks into larger WebSocket frames.  However, care must be taken to avoid introducing excessive latency -  the exact heuristics for delaying in order to aggregate blocks is TBD.</p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> Fairness</h1>
<p id="rfc.section.10.p.1">A MUX implementation MUST ensure reasonable fairness among the logical channels.  This is accomplished in several ways:</p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> Proxies</h1>
<p id="rfc.section.11.p.1">Proxies which do not mux/demux are not affected by the presence of this extension -- they simply process WebSocket frames as usual.  Proxies which filter or monitor WebSocket traffic will need to understand the MUX extension in order to extract the data from logical connections or to terminate individual logical connections when policy is violated.  Proxies which actively multiplex connections or demultiplex them (for example, a mobile network might have a proxy which aggregates WebSocket connections at a single cell to conserve bandwidth to the main gateway) will require additional configuration (perhaps including the client) that is outside the scope of this document.</p>
<h1 id="rfc.section.12">
<a href="#rfc.section.12">12.</a> Nesting</h1>
<p id="rfc.section.12.p.1">TBD: Should we allow nesting of MUX'd channels, or should we require that an intermediary MUXing channels flatten it?  The advantage of nesting is it is conceptually cleaner and less work for an intermediary, while the disadvantage is that flow control messages will get amplified by nesting and the ultimate server's job is a bit more complicated to keep a tree of channel mappings.</p>
<h1 id="rfc.section.13">
<a href="#rfc.section.13">13.</a> Security Considerations</h1>
<p id="rfc.section.13.p.1">TBD</p>
<h1 id="rfc.references">
<a href="#rfc.references">14.</a> References</h1>
<table><tbody><tr>
<td class="reference"><b id="WS">[WS]</b></td>
<td class="top">
<a title="Google, Inc.">Fette, I.</a> and <a title="Isode, Ltd.">A. Melnikov</a>, "<a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-17">The WebSocket Protocol</a>", Internet-Draft draft-ietf-hybi-thewebsocketprotocol-17, September 2011.</td>
</tr></tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">John A. Tamplin</span> 
	  <span class="n hidden">
		<span class="family-name">Tamplin</span>
	  </span>
	</span>
	<span class="org vcardline">Google, Inc.</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:jat@google.com">jat@google.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Takeshi Yoshino</span> 
	  <span class="n hidden">
		<span class="family-name">Yoshino</span>
	  </span>
	</span>
	<span class="org vcardline">Google, Inc.</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:tyoshino@google.com">tyoshino@google.com</a></span>

  </address>
</div>

</body>
</html>