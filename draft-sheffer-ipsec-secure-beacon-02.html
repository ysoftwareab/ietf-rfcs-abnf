<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Secure Beacon: Securely Detecting a Trusted Network</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Secure Beacon: Securely Detecting a Trusted Network">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">Y. Sheffer</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Y. Nir</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">Check Point</td></tr>
<tr><td class="header">Expires: May 14, 2008</td><td class="header">November 11, 2007</td></tr>
</table></td></tr></table>
<h1><br />Secure Beacon: Securely Detecting a Trusted Network<br />draft-sheffer-ipsec-secure-beacon-02</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on May 14, 2008.</p>

<h3>Abstract</h3>

<p>Remote access clients, in particular IPsec-based ones, are heavily deployed 
        in enterprise environments.
        In many enterprises the security policy allows remote-access clients to switch
        to unprotected operation when entering the trusted network. This document specifies a method
        that lets a client detect this situation in a secure manner, with the help of a security gateway.
        We propose a minor extension to IKEv2 to achieve this goal.
        
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Requirements Notation<br />
<a href="#anchor2">2.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">2.1.</a>&nbsp;
Goals<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">2.2.</a>&nbsp;
Client Mobility<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">2.3.</a>&nbsp;
Alternative Solutions<br />
<a href="#anchor6">3.</a>&nbsp;
Protocol Details<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">3.1.</a>&nbsp;
Extending IKE for Secure Network Detection<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">3.1.1.</a>&nbsp;
The IKE_SA_INIT Exchange<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ike auth">3.1.2.</a>&nbsp;
The IKE_AUTH Exchange<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#notifications">3.2.</a>&nbsp;
IKE Notify Payloads<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">3.2.1.</a>&nbsp;
SECURE_NETWORK_DETECT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">3.2.2.</a>&nbsp;
SECURE_NETWORK_DETECTED<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#detecting_mv">3.3.</a>&nbsp;
Detecting Movement<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#decision">3.4.</a>&nbsp;
The Gateway's Decision<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#policy">3.5.</a>&nbsp;
Client Security Policy<br />
<a href="#mobike">4.</a>&nbsp;
Interoperation with MOBIKE<br />
<a href="#anchor11">5.</a>&nbsp;
IANA Considerations<br />
<a href="#security">6.</a>&nbsp;
Security Considerations<br />
<a href="#anchor12">7.</a>&nbsp;
Change Log<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">7.1.</a>&nbsp;
-02<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">7.2.</a>&nbsp;
-01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">7.3.</a>&nbsp;
-00<br />
<a href="#anchor16">8.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">9.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">9.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">9.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Requirements Notation</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL",
            "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY",
            and "OPTIONAL" in this document are to be interpreted as
            described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Introduction</h3>

<p>
The IKE and IPsec protocols are often used for remote-access clients. IKE version 2 <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> provides enhanced support for remote-access clients through the use of EAP. In many cases, IPsec clients need to be "turned off" when the client roams into the internal, or "trusted" network of an enterprise. 
This operation is very sensitive, since an adversary may use this mechanism to force the client to send unprotected packets into the network.
This document defines an extension to IKEv2 where the client contacts a trusted gateway, the gateway detects that the client is located in a trusted network, and delivers an indication to the client in a secure manner.
An important property of this protocol is that the exchange may terminate early, if the client and the server agree that IPsec is not required; otherwise the protocol will "fall through" into a standard IKEv2 exchange, generating IKE and Child security associations.

</p>
<p>
Unfortunately at the time of writing, there is no IETF work group chartered with IPsec. We encourage discussion of this draft on the IPsec mailing list, https://www1.ietf.org/mailman/listinfo/ipsec.

</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
Goals</h3>

<p>
The proposed protocol should fulfill the following goals.
</p>
<ul class="text">
<li>Security, in particular the protocol should not adversely affect the security of IKE. 
</li>
<li>Robustness: the protocol should fall back into a full IKE exchange if any error is detected.
</li>
<li>Performance: minimize the number of exchanges and the CPU effort expanded, whether the client is in the trusted or untrusted network.
</li>
<li>Usability: the user should not be required to perform any action unless this is required for security.
We avoid sending the client's identity, because this normally requires input from the user.
</li>
<li>Simplicity: the protocol should deal with the case of "simple" networks, meaning networks where the internal network is wholly trusted. It does not need to cover more complex topologies.
</li>
<li>Extensibility: however, the base protocol can be extended, e.g. to handle more complex networks.
</li>
</ul><p> 
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Client Mobility</h3>

<p> Client mobility in IKEv2 is defined using the MOBIKE protocol extension, <a class='info' href='#RFC4555'>[RFC4555]<span> (</span><span class='info'>Eronen, P., &ldquo;IKEv2 Mobility and Multihoming Protocol (MOBIKE),&rdquo; June&nbsp;2006.</span><span>)</span></a>.
<a class='info' href='#mobike'>Section&nbsp;4<span> (</span><span class='info'>Interoperation with MOBIKE</span><span>)</span></a> below specifies how the Secure Beacon solution coexists with MOBIKE. 

</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
Alternative Solutions</h3>

<p>
There are several alternatives for providing the functionality discussed here.
</p>
<ul class="text">
<li>Several proposals related to Mobile IP, such as <a class='info' href='#I-D.ietf-mip4-vpn-problem-solution'>[I&#8209;D.ietf&#8209;mip4&#8209;vpn&#8209;problem&#8209;solution]<span> (</span><span class='info'>Vaarala, S. and E. Klovning, &ldquo;Mobile IPv4 Traversal Across IPsec-based VPN Gateways,&rdquo; March&nbsp;2008.</span><span>)</span></a>,
rely on secure connectivity to the Home Agent, which is assumed to be in the trusted network. This solution obviously can only be applied in a Mobile IP setting.
</li>
<li>Some proprietary solutions rely on secure connectivity to other "internal" hosts, for example the Windows Domain Controller.
</li>
<li>Another solution we have considered is to open a dedicated, short-lived TLS connection into the security gateway.
This would
enable the client to authenticate the gateway. However an IPsec gateway should not be assumed to implement TLS.
</li>
<li>Lastly, we considered a new protocol, possibly derived from IKE. A separate protocol offers modularity as its main benefit. However we have chosen to reuse IKE itself, where the exchange can be completed as a full IKE exchange. This results in fewer exchanges, and possibly in a simpler implementation.
</li>
</ul><p> 
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Protocol Details</h3>

<p> The following sections describe the protocol, first at the exchange level and then at the payload level. Following that, we discuss two central issues: how the client detects that it has moved, so that this protocol can be run, and how the gateway can make the decision whether the client is in the trusted or untrusted network.

</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Extending IKE for Secure Network Detection</h3>

<p> To summarize, we add an IKE notification to message #1 of the protocol, and another to message #2.
However, the protocol is only
terminated after the initiator has authenticated the responder, i.e. after message #4. It is important to note that the initiator's identity may not be authenticated if the protocol is terminated early.

</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.1"></a><h3>3.1.1.&nbsp;
The IKE_SA_INIT Exchange</h3>

<p> The IKE_SA_INIT exchange is modified as follows:
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
        Initiator                    Responder
      -----------                   -----------
      HDR, SAi1, KEi, Ni, N1  --&gt;
                             &lt;--    HDR, SAr1, KEr, Nr, N2, [CERTREQ]
</pre></div><p>


</p>
<p>
All payloads, with the exception of the notifications, have their usual semantics.
The first notification, N1, is of type SECURE_NETWORK_DETECT.
It denotes to the responder that it SHOULD respond with a second notification (N2), which is of type SECURE_NETWORK_DETECTED.
Both notifications are defined in
<a class='info' href='#notifications'>Section&nbsp;3.2<span> (</span><span class='info'>IKE Notify Payloads</span><span>)</span></a>. Note that both notifications are sent in the clear.

</p>
<p>
Following the first exchange, there are three options:
</p>
<ul class="text">
<li>If there is no response after the normal retransmission period, the client SHOULD assume
it is on an untrusted network, and is experiencing connectivity problems. For example, the IKE port may be blocked.
</li>
<li>Otherwise, a response was received. If N2 is not received, or if it is received but explicitly specifies that the initiator is in an untrusted network, the protocol continues according to standard IKE rules. This would be the case if the responder does not understand the SECURE_NETWORK_DETECT notification.
</li>
<li>If N2 indicates that the initiator is in a trusted network, the protocol continues as detailed in <a class='info' href='#ike auth'>Section&nbsp;3.1.2<span> (</span><span class='info'>The IKE_AUTH Exchange</span><span>)</span></a> below.
</li>
</ul><p> 
</p>
<a name="ike auth"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.2"></a><h3>3.1.2.&nbsp;
The IKE_AUTH Exchange</h3>

<p> The initiator now responds with a truncated IKE_AUTH exchange:
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      HDR, SK {[IDi, CERT,] [CERTREQ,] [IDr,] [AUTH]}     --&gt;
</pre></div><p>

The initiator sends the AUTH payload only if it can be authenticated in message #2,
i.e. if it uses a shared secret or certificate, rather than EAP.
Even if the initiator normally authenticates using one of these methods,
it MAY omit both IDi and AUTH, in order to avoid user interaction.
If AUTH is included, then the responder MUST authenticate the initiator.

</p>
<p>
The responder replies with:
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                                   &lt;--   HDR, SK {IDr, [CERT,] AUTH}
</pre></div><p>

The initiator MUST now validate the identity of the responder as defined in <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>, and following that, MUST terminate the protocol. Obviously in this case, no Child SA is created and therefore no IPsec-protected traffic will be sent. Moreover, no long-term IKE SA is created, and both parties SHOULD delete their IKE SAs. The initiator SHOULD send an Informational exchange containing a Delete payload for the IKE SA.

The responder should regard a persistent IKE SA where a secure network has been detected as anomalous
and audit their existence.
The responder MUST NOT allow any Create Child SA exchanges based on such an IKE SA.

</p>
<p>
See also <a class='info' href='#policy'>Section&nbsp;3.5<span> (</span><span class='info'>Client Security Policy</span><span>)</span></a> regarding implications on the client's security policy.

</p>
<p>
It is RECOMMENDED that the client display a message to the user at this point, announcing that it has moved into unprotected mode.

</p>
<a name="notifications"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
IKE Notify Payloads</h3>

<p> We define two new notify payload types, SECURE_NETWORK_DETECT and SECURE_NETWORK_DETECTED.

</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.1"></a><h3>3.2.1.&nbsp;
SECURE_NETWORK_DETECT</h3>

<p>
This notification type has the value [TBD-BY-IANA1]. It contains no data.

</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.2"></a><h3>3.2.2.&nbsp;
SECURE_NETWORK_DETECTED</h3>

<p> This notification type has the value [TBD-BY-IANA2].

</p>
<p>
This notify payload includes a single 1-octet data item. It has the value 0 if the responder believes that the initiator is coming from an untrusted network, or if the responder cannot determine where the initiator is coming from. It has the value 1 if the responder believes that the initiator is coming from a trusted network.

</p>
<p>
Implementations MAY include additional data in this notify payload, however this usage SHOULD be signaled with a Vendor ID payload. Such additional data MUST be ignored by the receiver if not understood.

</p>
<a name="detecting_mv"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Detecting Movement</h3>

<p> Mobility detection is outside the scope of this document. The procedures involved are best described in <a class='info' href='#RFC4436'>[RFC4436]<span> (</span><span class='info'>Aboba, B., Carlson, J., and S. Cheshire, &ldquo;Detecting Network Attachment in IPv4 (DNAv4),&rdquo; March&nbsp;2006.</span><span>)</span></a> for IPv4. 
The DNA procedures SHOULD be followed, so that the client can employ the mechanism defined here whenever it suspects that it has moved into a new network, particularly from a trusted to an untrusted network.

</p>
<a name="decision"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
The Gateway's Decision</h3>

<p> The gateway MUST be configured to make a correct decision regarding the client's location. Typically, the gateway would only detect clients connecting through the trusted network if their IKE packets arrive from a trusted physical network interface. Determining which network or network type is considered trusted is left to local policy.

</p>
<p>
It is RECOMMENDED that the gateway indicate an untrusted network, if it detects that the client is behind a NAT. See <a class='info' href='#security'>Section&nbsp;6<span> (</span><span class='info'>Security Considerations</span><span>)</span></a> for rationale.

</p>
<a name="policy"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.5"></a><h3>3.5.&nbsp;
Client Security Policy</h3>

<p> If the client sends the SECURE_NETWORK_DETECT notification and does not receive an indication of a trusted network, it SHOULD NOT change its existing SPD and SPD Cache.

</p>
<p>
If the client receives the SECURE_NETWORK_DETECTED notification indicating a trusted network, it should alter its behavior as follows.

</p>
<p>
The client SHOULD create BYPASS entries in the SPD Cache for all PROTECT entries in the SPD which are associated with the peer gateway.
An entry is said to be associated with a peer gateway if it is a transport mode entry and the remote address is the peer gateway address, or if it is a tunnel mode entry, and the remote tunnel address is the peer gateway address.

</p>
<p>
The above SPD Cache entries MUST be reset (flushed) whenever the client detects that it has 
moved from one network attachment to another. See <a class='info' href='#detecting_mv'>Section&nbsp;3.3<span> (</span><span class='info'>Detecting Movement</span><span>)</span></a>.

</p>
<p>
IKEv2 allows the client to populate the SPD Cache dynamically based on the INTERNAL_IPv*_SUBNET attributes in the configuration payload (see section 6.3 in IKEv2 Clarifications <a class='info' href='#RFC4718'>[RFC4718]<span> (</span><span class='info'>Eronen, P. and P. Hoffman, &ldquo;IKEv2 Clarifications and Implementation Guidelines,&rdquo; October&nbsp;2006.</span><span>)</span></a>).
However, since the client does not reach this state, depending on its static SPD configuration, such a client might effectively create a BYPASS entry for the entire IP address space.

</p>
<a name="mobike"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Interoperation with MOBIKE</h3>

<p> The client MAY include the SECURE_NETWORK_DETECT notification in any Informational exchange that contains an UPDATE_SA_ADDRESSES notification.

</p>
<p>
By this time, the client has already determined that the gateway supports both MOBIKE and the Secure Beacon extension.
The gateway MUST respond with a SECURE_NETWORK_DETECTED notification in the response to this Informational exchange.

</p>
<p>
If the gateway's response specifies that the client is in a trusted network:
</p>
<ul class="text">
<li>The gateway MUST NOT attempt
a return routability check, if such a check would have normally been required.

</li>
<li>Both client and gateway MUST tear down the existing IKE SA, and terminate the IKE protocol.
The client SHOULD send an Informational exchange containing a Delete payload for the IKE SA.

</li>
<li>
It is RECOMMENDED that the client display a message to the user at this point, announcing that it has moved into unprotected mode.

</li>
<li>
The next time the client detects that it has moved, it SHOULD re-initiate an IKE exchange.

</li>
</ul><p>

</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
IANA Considerations</h3>

<p>
   This document does not create any new namespaces to be maintained by
   IANA, but it requires new values in namespaces that have been defined
   in the IKEv2 base specification.

</p>
<p>
   This document defines several new IKEv2 notifications whose values
   are to be allocated from the "IKEv2 Notify Message Types" namespace.

</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      Notify Messages - Error Types     Value
      -----------------------------     -----
      None

      Notify Messages - Status Types    Value
      ------------------------------    -----
      SECURE_NETWORK_DETECT             TBD-BY-IANA1 (16396..40959)
      SECURE_NETWORK_DETECTED           TBD-BY-IANA2 (16396..40959)
</pre></div>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>The proposed solution needs to be analyzed carefully, since it may cause a host to switch from protected to unprotected communication. Following are the threats that we have identified.
</p>
<ol class="text">
<li>The notifications are sent in the clear. A passive attacker will learn whether the responder
is receiving traffic over a trusted or untrusted interface.
This is information that the attacker is probably able to obtain otherwise.
</li>
<li>An active attacker may be able to change either or both notifications.
The first notification N1 does not carry any data, so it can at worst be deleted.
In this case the protocol will revert to normal IKE.
</li>
<li>An active attacker's change to the N2 notification (or deletion of N2)
will be detected since IKE message #2 is authenticated and integrity-protected.
Therefore this attack is only equivalent to a DoS attack on IKE.
Moreover, the protocol is "fail safe" since any detected failures or attacks will at worst result
in the client using a secure channel where one is not required by policy.
</li>
<li>This protocol can be defeated by an active attacker who can inject packets into the trusted network
and relay the responses to such packets back into the untrusted network.
Such an attacker will be able to cheat the client into believing that it is on the trusted network.
We believe we do not have to address this threat.
</li>
<li>This protocol MUST NOT be used if the network can change the path between the client
and the security gateway without the client's awareness, causing its security properties to change.
That is, if the network can route traffic sometimes over a trusted path and sometimes over an untrusted one,
without notifying the end-point.
Such a situation might be possible in incorrectly configured Mobile IP deployments, e.g. where the same Home Agent is shared between a trusted Wi-Fi access network and an untrusted one, and where the IPsec layer is not informed of the connectivity changes.
</li>
<li>There are rare cases when a client is collocated with a NAT. One such case is a client implemented within a software virtual machine.
In such cases the client is likely to remain unaware when moving from a trusted to an untrusted network.
Therefore we recommend (<a class='info' href='#decision'>Section&nbsp;3.4<span> (</span><span class='info'>The Gateway's Decision</span><span>)</span></a>)
to always indicate an untrusted network to clients behind NAT.
</li>
</ol><p> 
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Change Log</h3>

<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
-02</h3>

<p>
        Minor editorial changes.
        
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
-01</h3>

<p>
        Added a section on the client's security policy, per <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
        Added discussion of the interaction with MOBIKE. Added treatment of client behind NAT.
        
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
-00</h3>

<p>
        Initial version.
        
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Acknowledgements</h3>

<p>
We would like to thank Ariel Shaqed for his many useful comments. Thanks to Steve Kent for helping to clarify security policy issues.

</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4301">[RFC4301]</a></td>
<td class="author-text">Kent, S. and K. Seo, &ldquo;<a href="http://tools.ietf.org/html/rfc4301">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;4301, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4301.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4306">[RFC4306]</a></td>
<td class="author-text">Kaufman, C., &ldquo;<a href="http://tools.ietf.org/html/rfc4306">Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4306, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4306.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4436">[RFC4436]</a></td>
<td class="author-text">Aboba, B., Carlson, J., and S. Cheshire, &ldquo;<a href="http://tools.ietf.org/html/rfc4436">Detecting Network Attachment in IPv4 (DNAv4)</a>,&rdquo; RFC&nbsp;4436, March&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4436.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4555">[RFC4555]</a></td>
<td class="author-text">Eronen, P., &ldquo;<a href="http://tools.ietf.org/html/rfc4555">IKEv2 Mobility and Multihoming Protocol (MOBIKE)</a>,&rdquo; RFC&nbsp;4555, June&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4555.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-mip4-vpn-problem-solution">[I-D.ietf-mip4-vpn-problem-solution]</a></td>
<td class="author-text">Vaarala, S. and E. Klovning, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-mip4-vpn-problem-solution-05.txt">Mobile IPv4 Traversal Across IPsec-based VPN Gateways</a>,&rdquo; draft-ietf-mip4-vpn-problem-solution-05 (work in progress), March&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-mip4-vpn-problem-solution-05.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4718">[RFC4718]</a></td>
<td class="author-text">Eronen, P. and P. Hoffman, &ldquo;<a href="http://tools.ietf.org/html/rfc4718">IKEv2 Clarifications and Implementation Guidelines</a>,&rdquo; RFC&nbsp;4718, October&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4718.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Yaron Sheffer</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Check Point Software Technologies Ltd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5 Hasolelim st.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tel Aviv  67897</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Israel</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:yaronf@checkpoint.com">yaronf@checkpoint.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Yoav Nir</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Check Point Software Technologies Ltd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5 Hasolelim st.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tel Aviv  67897</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Israel</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ynir@checkpoint.com">ynir@checkpoint.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2007).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
