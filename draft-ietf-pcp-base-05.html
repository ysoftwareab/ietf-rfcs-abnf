<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Port Control Protocol (PCP)</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Scope">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Deployment Scenarios">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 Supported Transport Protocols">
<link href="#rfc.section.2.3" rel="Chapter" title="2.3 Single-homed Customer Premises Network">
<link href="#rfc.section.3" rel="Chapter" title="3 Terminology">
<link href="#rfc.section.4" rel="Chapter" title="4 Relationship of PCP Server and its NAT">
<link href="#rfc.section.5" rel="Chapter" title="5 Common Request and Response Header Format">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Request Header">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Response Header">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 Options">
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 Result Codes">
<link href="#rfc.section.6" rel="Chapter" title="6 General PCP Operation">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 General PCP Client: Generating a Request">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 General PCP Server: Processing a Request">
<link href="#rfc.section.6.3" rel="Chapter" title="6.3 General PCP Client: Processing a Response">
<link href="#rfc.section.6.4" rel="Chapter" title="6.4 Multi-interface Issues">
<link href="#rfc.section.6.5" rel="Chapter" title="6.5 Epoch">
<link href="#rfc.section.6.6" rel="Chapter" title="6.6 Version negotiation">
<link href="#rfc.section.6.7" rel="Chapter" title="6.7 General PCP Options">
<link href="#rfc.section.6.7.1" rel="Chapter" title="6.7.1 UNPROCESSED">
<link href="#rfc.section.7" rel="Chapter" title="7 Introduction to MAP and PEER OpCodes">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 For Operating a Server">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 For Reducing NAT Keepalive Messages">
<link href="#rfc.section.7.3" rel="Chapter" title="7.3 For Operating a Symmetric Client/Server">
<link href="#rfc.section.8" rel="Chapter" title="8 MAP OpCodes">
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 OpCode Packet Formats">
<link href="#rfc.section.8.2" rel="Chapter" title="8.2 OpCode-Specific Result Codes">
<link href="#rfc.section.8.3" rel="Chapter" title="8.3 OpCode-Specific Client: Generating a Request">
<link href="#rfc.section.8.4" rel="Chapter" title="8.4 OpCode-Specific Server: Processing a Request">
<link href="#rfc.section.8.5" rel="Chapter" title="8.5 OpCode-Specific Client: Processing a Response">
<link href="#rfc.section.8.6" rel="Chapter" title="8.6 Mapping Lifetime and Deletion">
<link href="#rfc.section.8.7" rel="Chapter" title="8.7 Subscriber Renumbering">
<link href="#rfc.section.8.8" rel="Chapter" title="8.8 PCP Options for MAP OpCodes">
<link href="#rfc.section.8.8.1" rel="Chapter" title="8.8.1 THIRD_PARTY">
<link href="#rfc.section.8.8.2" rel="Chapter" title="8.8.2 REMOTE_PEER_FILTER">
<link href="#rfc.section.8.8.3" rel="Chapter" title="8.8.3 PREFER_FAILURE">
<link href="#rfc.section.8.9" rel="Chapter" title="8.9 PCP Mapping State Maintenance">
<link href="#rfc.section.8.9.1" rel="Chapter" title="8.9.1 Recreating Mappings">
<link href="#rfc.section.8.9.2" rel="Chapter" title="8.9.2 Maintaining Mappings">
<link href="#rfc.section.9" rel="Chapter" title="9 PEER OpCodes">
<link href="#rfc.section.9.1" rel="Chapter" title="9.1 OpCode Packet Formats">
<link href="#rfc.section.9.2" rel="Chapter" title="9.2 OpCode-Specific Result Codes">
<link href="#rfc.section.9.3" rel="Chapter" title="9.3 OpCode-Specific Client: Generating a Request">
<link href="#rfc.section.9.4" rel="Chapter" title="9.4 OpCode-Specific Server: Processing a Request">
<link href="#rfc.section.9.5" rel="Chapter" title="9.5 OpCode-Specific Client: Processing a Response">
<link href="#rfc.section.10" rel="Chapter" title="10 Deployment Considerations">
<link href="#rfc.section.10.1" rel="Chapter" title="10.1 Maintaining Same External IP Address">
<link href="#rfc.section.10.2" rel="Chapter" title="10.2 Ingress Filtering">
<link href="#rfc.section.11" rel="Chapter" title="11 Deployment Scenarios">
<link href="#rfc.section.11.1" rel="Chapter" title="11.1 Dual Stack-Lite">
<link href="#rfc.section.11.1.1" rel="Chapter" title="11.1.1 Overview">
<link href="#rfc.section.11.1.2" rel="Chapter" title="11.1.2 Encapsulation Mode">
<link href="#rfc.section.11.1.3" rel="Chapter" title="11.1.3 Plain IPv6 Mode">
<link href="#rfc.section.11.2" rel="Chapter" title="11.2 NAT64">
<link href="#rfc.section.11.3" rel="Chapter" title="11.3 NAT44 and NAT444">
<link href="#rfc.section.11.4" rel="Chapter" title="11.4 IPv6 Simple Firewall">
<link href="#rfc.section.12" rel="Chapter" title="12 Security Considerations">
<link href="#rfc.section.12.1" rel="Chapter" title="12.1 Denial of Service">
<link href="#rfc.section.12.2" rel="Chapter" title="12.2 Ingress Filtering">
<link href="#rfc.section.12.3" rel="Chapter" title="12.3 Validating Target Address">
<link href="#rfc.section.13" rel="Chapter" title="13 IANA Considerations">
<link href="#rfc.section.13.1" rel="Chapter" title="13.1 Port Number">
<link href="#rfc.section.13.2" rel="Chapter" title="13.2 OpCodes">
<link href="#rfc.section.13.3" rel="Chapter" title="13.3 Result Codes">
<link href="#rfc.section.13.4" rel="Chapter" title="13.4 Options">
<link href="#rfc.section.14" rel="Chapter" title="14 Acknowledgments">
<link href="#rfc.references" rel="Chapter" title="15 References">
<link href="#rfc.references.1" rel="Chapter" title="15.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="15.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Changes">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 Changes from draft-ietf-pcp-base-04 to -05">
<link href="#rfc.appendix.Appendix%20A.2" rel="Chapter" title="Appendix A.2 Changes from draft-ietf-pcp-base-03 to -04">
<link href="#rfc.appendix.Appendix%20A.3" rel="Chapter" title="Appendix A.3 Changes from draft-ietf-pcp-base-02 to -03">
<link href="#rfc.appendix.Appendix%20A.4" rel="Chapter" title="Appendix A.4 Changes from draft-ietf-pcp-base-01 to -02">
<link href="#rfc.appendix.Appendix%20A.5" rel="Chapter" title="Appendix A.5 Changes from draft-ietf-pcp-base-00 to -01">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="Port Control Protocol allows a host to control how incoming IPv6 or IPv4 packets are translated and forwarded by a network address translator (NAT) or simple firewall to an IPv6 or IPv4 host, and also allows a host to optimize its NAT keepalive messages." />
  <meta name="description" content="Port Control Protocol allows a host to control how incoming IPv6 or IPv4 packets are translated and forwarded by a network address translator (NAT) or simple firewall to an IPv6 or IPv4 host, and also allows a host to optimize its NAT keepalive messages." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">PCP working group</td>
<td class="right">D. Wing, Ed.</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Cisco</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">S. Cheshire</td>
</tr>
<tr>
<td class="left">Expires: August 26, 2011</td>
<td class="right">Apple</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">M. Boucadair</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">France Telecom</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">R. Penno</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Juniper Networks</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">F. Dupont</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Internet Systems Consortium</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">February 22, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Port Control Protocol (PCP)<br />
  <span class="filename">draft-ietf-pcp-base-05</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>Port Control Protocol allows a host to control how incoming IPv6 or IPv4 packets are translated and forwarded by a network address translator (NAT) or simple firewall to an IPv6 or IPv4 host, and also allows a host to optimize its NAT keepalive messages.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on August 26, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Scope</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">Deployment Scenarios</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">Supported Transport Protocols</a>
</li>
<li>2.3.   <a href="#rfc.section.2.3">Single-homed Customer Premises Network</a>
</li>
<li>3.   <a href="#rfc.section.3">Terminology</a>
</li>
<li>4.   <a href="#rfc.section.4">Relationship of PCP Server and its NAT</a>
</li>
<li>5.   <a href="#rfc.section.5">Common Request and Response Header Format</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Request Header</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Response Header</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">Options</a>
</li>
<li>5.4.   <a href="#rfc.section.5.4">Result Codes</a>
</li>
<li>6.   <a href="#rfc.section.6">General PCP Operation</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">General PCP Client: Generating a Request</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">General PCP Server: Processing a Request</a>
</li>
<li>6.3.   <a href="#rfc.section.6.3">General PCP Client: Processing a Response</a>
</li>
<li>6.4.   <a href="#rfc.section.6.4">Multi-interface Issues</a>
</li>
<li>6.5.   <a href="#rfc.section.6.5">Epoch</a>
</li>
<li>6.6.   <a href="#rfc.section.6.6">Version negotiation</a>
</li>
<li>6.7.   <a href="#rfc.section.6.7">General PCP Options</a>
</li>
<li>6.7.1.   <a href="#rfc.section.6.7.1">UNPROCESSED</a>
</li>
<li>7.   <a href="#rfc.section.7">Introduction to MAP and PEER OpCodes</a>
</li>
<li>7.1.   <a href="#rfc.section.7.1">For Operating a Server</a>
</li>
<li>7.2.   <a href="#rfc.section.7.2">For Reducing NAT Keepalive Messages</a>
</li>
<li>7.3.   <a href="#rfc.section.7.3">For Operating a Symmetric Client/Server</a>
</li>
<li>8.   <a href="#rfc.section.8">MAP OpCodes</a>
</li>
<li>8.1.   <a href="#rfc.section.8.1">OpCode Packet Formats</a>
</li>
<li>8.2.   <a href="#rfc.section.8.2">OpCode-Specific Result Codes</a>
</li>
<li>8.3.   <a href="#rfc.section.8.3">OpCode-Specific Client: Generating a Request</a>
</li>
<li>8.4.   <a href="#rfc.section.8.4">OpCode-Specific Server: Processing a Request</a>
</li>
<li>8.5.   <a href="#rfc.section.8.5">OpCode-Specific Client: Processing a Response</a>
</li>
<li>8.6.   <a href="#rfc.section.8.6">Mapping Lifetime and Deletion</a>
</li>
<li>8.7.   <a href="#rfc.section.8.7">Subscriber Renumbering</a>
</li>
<li>8.8.   <a href="#rfc.section.8.8">PCP Options for MAP OpCodes</a>
</li>
<li>8.8.1.   <a href="#rfc.section.8.8.1">THIRD_PARTY</a>
</li>
<li>8.8.2.   <a href="#rfc.section.8.8.2">REMOTE_PEER_FILTER</a>
</li>
<li>8.8.3.   <a href="#rfc.section.8.8.3">PREFER_FAILURE</a>
</li>
<li>8.9.   <a href="#rfc.section.8.9">PCP Mapping State Maintenance</a>
</li>
<li>8.9.1.   <a href="#rfc.section.8.9.1">Recreating Mappings</a>
</li>
<li>8.9.2.   <a href="#rfc.section.8.9.2">Maintaining Mappings</a>
</li>
<li>9.   <a href="#rfc.section.9">PEER OpCodes</a>
</li>
<li>9.1.   <a href="#rfc.section.9.1">OpCode Packet Formats</a>
</li>
<li>9.2.   <a href="#rfc.section.9.2">OpCode-Specific Result Codes</a>
</li>
<li>9.3.   <a href="#rfc.section.9.3">OpCode-Specific Client: Generating a Request</a>
</li>
<li>9.4.   <a href="#rfc.section.9.4">OpCode-Specific Server: Processing a Request</a>
</li>
<li>9.5.   <a href="#rfc.section.9.5">OpCode-Specific Client: Processing a Response</a>
</li>
<li>10.   <a href="#rfc.section.10">Deployment Considerations</a>
</li>
<li>10.1.   <a href="#rfc.section.10.1">Maintaining Same External IP Address</a>
</li>
<li>10.2.   <a href="#rfc.section.10.2">Ingress Filtering</a>
</li>
<li>11.   <a href="#rfc.section.11">Deployment Scenarios</a>
</li>
<li>11.1.   <a href="#rfc.section.11.1">Dual Stack-Lite</a>
</li>
<li>11.1.1.   <a href="#rfc.section.11.1.1">Overview</a>
</li>
<li>11.1.2.   <a href="#rfc.section.11.1.2">Encapsulation Mode</a>
</li>
<li>11.1.3.   <a href="#rfc.section.11.1.3">Plain IPv6 Mode</a>
</li>
<li>11.2.   <a href="#rfc.section.11.2">NAT64</a>
</li>
<li>11.3.   <a href="#rfc.section.11.3">NAT44 and NAT444</a>
</li>
<li>11.4.   <a href="#rfc.section.11.4">IPv6 Simple Firewall</a>
</li>
<li>12.   <a href="#rfc.section.12">Security Considerations</a>
</li>
<li>12.1.   <a href="#rfc.section.12.1">Denial of Service</a>
</li>
<li>12.2.   <a href="#rfc.section.12.2">Ingress Filtering</a>
</li>
<li>12.3.   <a href="#rfc.section.12.3">Validating Target Address</a>
</li>
<li>13.   <a href="#rfc.section.13">IANA Considerations</a>
</li>
<li>13.1.   <a href="#rfc.section.13.1">Port Number</a>
</li>
<li>13.2.   <a href="#rfc.section.13.2">OpCodes</a>
</li>
<li>13.3.   <a href="#rfc.section.13.3">Result Codes</a>
</li>
<li>13.4.   <a href="#rfc.section.13.4">Options</a>
</li>
<li>14.   <a href="#rfc.section.14">Acknowledgments</a>
</li>
<li>15.   <a href="#rfc.references">References</a>
</li>
<li>15.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>15.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Changes</a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">Changes from draft-ietf-pcp-base-04 to -05</a>
</li>
<li>Appendix A.2.   <a href="#rfc.appendix.Appendix%20A.2">Changes from draft-ietf-pcp-base-03 to -04</a>
</li>
<li>Appendix A.3.   <a href="#rfc.appendix.Appendix%20A.3">Changes from draft-ietf-pcp-base-02 to -03</a>
</li>
<li>Appendix A.4.   <a href="#rfc.appendix.Appendix%20A.4">Changes from draft-ietf-pcp-base-01 to -02</a>
</li>
<li>Appendix A.5.   <a href="#rfc.appendix.Appendix%20A.5">Changes from draft-ietf-pcp-base-00 to -01</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">Port Control Protocol (PCP) provides a mechanism to control how incoming packets are forwarded by upstream devices such as NAT64, NAT44, and firewall devices, and a mechanism to reduce application keepalive traffic. PCP is primarily designed to be implemented in the context of both Carrier-Grade NATs (CGN) and small NATs (e.g., residential NATs).  PCP allows hosts to operate server for a long time (e.g., a webcam) or a short time (e.g., while playing a game or on a phone call) when behind a NAT device, including when behind a CGN operated by their Internet service provider.</p>
<p id="rfc.section.1.p.2">PCP allows applications to create mappings from an external IP address and port to an internal IP address and port. If the PCP-controlled device is a NAT, a mapping is created; if the PCP-controlled device is a firewall, a mapping is created in the firewall. These mappings are required for successful inbound communications destined to machines located behind a NAT.</p>
<p id="rfc.section.1.p.3">After creating a mapping for incoming connections, it is necessary to inform remote computers about the IP address and port for the incoming connection. This is usually done in an application-specific manner. For example, a computer game would use a rendezvous server specific to that game (or specific to that game developer), and a SIP phone would use a SIP proxy. PCP does not provide this rendezvous function. The rendezvous function will support IPv4, IPv6, or both. Depending on that support and the application's support of IPv4 or IPv6, the PCP client will need an IPv4 or IPv6 mapping or both.</p>
<p id="rfc.section.1.p.4">Many NAT-friendly applications send frequent application-level messages to ensure their session will not be timed out by a NAT. These are commonly called "NAT keepalive" messages, even though they are not sent to the NAT itself (rather, they are sent 'through' the NAT). These applications can reduce the frequency of those NAT keepalive messages by using PCP to learn (or control) the NAT mapping lifetime. This helps reduce bandwidth on the subscriber's access network, traffic to the server, and battery consumption on mobile devices.</p>
<p id="rfc.section.1.p.5">Many NATs and firewalls have included application layer gateways (ALGs) to create mappings for applications that establish additional streams or accept incoming connections. ALGs incorporated into NATs additionally modify the application payload. Industry experience has shown that these ALGs are detrimental to protocol evolution. PCP allows an application create its own mappings in NATs and firewalls, removing the incentive to deploy ALGs in NATs and firewalls.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Scope</h1>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> Deployment Scenarios</h1>
<p id="rfc.section.2.1.p.1">PCP can be used in various deployment scenarios, including:</p>

<ul>
<li>
<a href="#I-D.ietf-softwire-dual-stack-lite">Dual Stack-Lite</a> <cite title="NONE">[I-D.ietf-softwire-dual-stack-lite]</cite>, and;</li>
<li>NAT64, both <a href="#I-D.ietf-behave-v6v4-xlate-stateful">Stateful</a> <cite title="NONE">[I-D.ietf-behave-v6v4-xlate-stateful]</cite> and <a href="#I-D.ietf-behave-v6v4-xlate">Stateless </a> <cite title="NONE">[I-D.ietf-behave-v6v4-xlate]</cite>, and;</li>
<li>
<a href="#I-D.ietf-behave-lsn-requirements">Carrier-Grade NAT</a> <cite title="NONE">[I-D.ietf-behave-lsn-requirements]</cite>, and;</li>
<li>
<a href="#RFC3022">Basic NAT</a> <cite title="NONE">[RFC3022]</cite>, and;</li>
<li>
<a href="#RFC3022">Network Address and Port Translation (NAPT)</a> <cite title="NONE">[RFC3022]</cite>, such as commonly deployed in residential NAT devices, and;</li>
<li>
<a href="#I-D.miles-behave-l2nat">Layer-2 aware NAT</a> <cite title="NONE">[I-D.miles-behave-l2nat]</cite> and <a href="#I-D.arkko-dual-stack-extra-lite">Dual-Stack Extra Lite</a> <cite title="NONE">[I-D.arkko-dual-stack-extra-lite]</cite>, and;</li>
<li>
<a href="#RFC6092">IPv6 firewall control</a> <cite title="NONE">[RFC6092]</cite>.</li>
</ul>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> Supported Transport Protocols</h1>
<p id="rfc.section.2.2.p.1">The PCP OpCodes defined in this document are designed to support transport protocols that use a 16-bit port number (e.g., TCP, UDP, SCTP, DCCP). Transport protocols that do not use a port number (e.g., IPsec ESP), and the ability to use PCP to forward all traffic to a single default host (often nicknamed "DMZ"), are beyond the scope of this document.</p>
<h1 id="rfc.section.2.3">
<a href="#rfc.section.2.3">2.3.</a> <a href="#single_homed" id="single_homed">Single-homed Customer Premises Network</a>
</h1>
<p id="rfc.section.2.3.p.1">The PCP machinery assumes a single-homed host model. That is, for a given IP version, only one default route exists to reach the Internet.  This is important because after a PCP mapping is created and an inbound packet (e.g., TCP SYN) arrives at the host the outbound response (e.g., TCP SYNACK) has to go through the same path so the proper address rewriting takes place on that outbound response packet.  This restriction exists because otherwise there would need to be one PCP server for each egress, because the host could not reliably determine which egress path packets would take, so the client would need to be able to reliably make the same internal/external mapping in every NAT gateway, which in general is not possible.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#terminology" id="terminology">Terminology</a>
</h1>
<p id="rfc.section.3.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">RFC 2119</a> <cite title="NONE">[RFC2119]</cite>.</p>
<p></p>

<dl>
<dt>Internal Host, Target Host:</dt>
<dd style="margin-left: 8">
<br>A host served by a NAT gateway, or protected by a firewall.</dd>
<dt>Remote Host:</dt>
<dd style="margin-left: 8">
<br>A host with which an Internal Host is communicating.</dd>
<dt>Target Address, External Address, Remote Peer Address:</dt>
<dd style="margin-left: 8">
<br>The address of an Internal Host served by a NAT gateway (typically a private address <a href="#RFC1918">[RFC1918]</a>) or an Internal Host protected by a firewall. <br><br>An External Address is the address of an Internal Host as seen by other Remote Hosts on the Internet with which the Internal Host is communicating, after translation by any NAT gateways on the path. An External Address is generally a public routable (i.e., non-private) address. In the case of an Internal Host protected by a pure firewall, with no address translation on the path, its External Address is the same as its Internal Address.  <br><br>A Remote Peer Address is the address of a Remote Host, as seen by the Internal Host. A Remote Address is generally a public routable address. In the case of a Remote Host that is itself served by a NAT gateway, the Remote Address my in fact be the Remote Host's External Address, but since this remote translation is generally invisible to software running on the Internal Host, the distinction can safely be ignored for the purposes of this document.</dd>
<dt>Third Party:</dt>
<dd style="margin-left: 8">
<br>In the common case, an Internal Host manages its own Mappings using PCP requests, and the Internal Address of those Mappings is the same as the source IP address of the PCP request packet. <br><br> In the case where one device is managing Mappings on behalf of some other device which does not implement PCP, the presence of the THIRD_PARTY option in the MAP request signifies that the specified address, not the source IP address of the PCP request packet, should be used as the Internal Address for the Mapping. When PCP requests are used with the THIRD_PARTY option, appropriate security measures MUST be used to ensure that the device creating, renewing, or deleting mappings is authorized to do so on behalf of the internal address given in the THIRD_PARTY option.</dd>
<dt>Mapping:</dt>
<dd style="margin-left: 8">
<br>A NAT mapping creates a relationship between an internal IP transport address and an external IP transport address. More specifically, it creates a translation rule where packets destined to the external IP and port are translated to the internal IP and port. In the case of a pure firewall, the "Mapping" is the identity function, translating an internal port number to the same external port number and vice versa, and this "Mapping" indicates to the firewall that traffic to and from this internal port number is permitted to pass. See also Port Forwarding.</dd>
<dt>Mapping Types:</dt>
<dd style="margin-left: 8">
<br>There are three different ways to create mappings: implicit dynamic mappings, explicit dynamic mappings, and static mappings. Implicit dynamic mappings are created as a result of a TCP SYN or outgoing UDP packet. Explicit dynamic mappings are created as a result of PCP MAP requests. Both implicit and explicit dynamic mappings are dynamic in the sense that they are created on demand, as requested (implicitly or explicitly) by the Internal Host, and have a lifetime, after which they are automatically deleted unless the lifetime is extended by action by the Internal Host. Static mappings are created by manual configuration (e.g., command language interface or web page) and differ from dynamic mappings in that their lifetime is typically infinite (they exist until manually removed) but otherwise they behave exactly the same as dynamic mappings. For example, a PCP MAP request to create a mapping that already exists as a static mapping will return a successful result, confirming that the requested mapping exists.</dd>
<dt>Port Forwarding, Port Mapping:</dt>
<dd style="margin-left: 8">
<br>Port forwarding (or port mapping) allows a host to receive traffic sent to a specific IP address and port. <br><br> In the context of a NAT or NAPT, the Internal Address and External Address are different. In the context of a pure firewall, the Internal Address and External Address are the same. In both contexts, if an internal host is listening to connections on a specific port (that is, operating as a server), the external IP address and port number need to be port forwarded to the internal IP address and port number, which may be the same, in the case of a pure firewall. In the context of a NAPT, it is possible that both the IP address and port are modified. For example with a NAPT, a webcam might be listening on port 80 on its internal address 192.168.1.1, while its publicly-accessible external address is 192.0.2.1 and port is 12345. The NAT does 'port forwarding' of one to the other.</dd>
<dt>PCP Client:</dt>
<dd style="margin-left: 8">
<br>A PCP software instance responsible for issuing PCP requests to a PCP server. One or several PCP Clients can be embedded in the same host. Several PCP Clients can be located in the same local network of a given subscriber. A PCP Client can issue PCP request on behalf of a third party device of the same subscriber. An interworking function, from UPnP IGD to PCP, or from NAT-PMP <a href="#I-D.cheshire-nat-pmp">[I-D.cheshire-nat-pmp]</a> is another example of a PCP Client. A PCP server in a NAT gateway that is itself a client of another NAT gateway (nested NAT) may itself act as a PCP client to the upstream NAT.</dd>
<dt>PCP Server:</dt>
<dd style="margin-left: 8">
<br>A network element which receives and processes PCP requests from a PCP client. See also <a href="#relationship">Section 4</a>.</dd>
<dt>Interworking Function:</dt>
<dd style="margin-left: 8">
<br>a functional element responsible for interworking another protocol with PCP. For example interworking between <a href="#IGD">UPnP IGD</a> <cite title="NONE">[IGD]</cite> with PCP or NAT-PMP <a href="#I-D.cheshire-nat-pmp">[I-D.cheshire-nat-pmp]</a> and PCP.</dd>
<dt>subscriber:</dt>
<dd style="margin-left: 8">
<br>an entity provided access to the network. In the case of a commercial ISP, this is typically a single home.</dd>
<dt>host:</dt>
<dd style="margin-left: 8">
<br>a device which can have packets sent to it, as a result of PCP operations. A host is not necessarily a PCP client.</dd>
<dt>5-tuple</dt>
<dd style="margin-left: 8">The 5 pieces of information that fully identify a flow: source IP address, destination IP address, protocol, source port number, destination port number.</dd>
</dl>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#relationship" id="relationship">Relationship of PCP Server and its NAT</a>
</h1>
<p id="rfc.section.4.p.1">The PCP server receives PCP requests. The PCP server might be integrated within the NAT or firewall device (as shown in <a href="#diagram_pcp_server_embedded">Figure 1</a>) which is expected to be a common deployment.</p>
<div id="#rfc.figure.1"></div>
<div id="#diagram_pcp_server_embedded"></div>
<pre>
                         +-----------------+
+------------+           | NAT or firewall |
| PCP client |-&lt;network&gt;-+      with       +---&lt;Internet&gt;
+------------+           |    PCP server   |
                         +-----------------+</pre>
<p id="rfc.section.4.p.2">It is also possible to operate the PCP server in a separate device from the NAT, so long as such operation is indistinguishable from the PCP client's perspective.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> Common Request and Response Header Format</h1>
<p id="rfc.section.5.p.1">All PCP messages contain a request (or response) header containing an opcode, any relevant opcode-specific information, and zero or more options. The packet layout for the common header, and operation of the PCP client and PCP server are described in the following sections. The information in this section applies to all OpCodes. Behavior of the OpCodes defined in this document is described in <a href="#pin_opcodes">Section 8</a> and <a href="#peer_opcodes">Section 9</a>.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> Request Header</h1>
<div id="#rfc.figure.2"></div>
<div id="#common_request"></div>
<p>All requests have the following format:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1| Version = 0 |R|   OpCode    |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
|                         Reserved (48 bits)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:             (optional) opcode-specific information            :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:             (optional) PCP Options                            :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.5.1.p.1">These fields are described below:</p>

<dl>
<dt>1</dt>
<dd style="margin-left: 8">A single bit set to 1. This allows DTLS and non-DTLS to be multiplexed on same port, should a future update to this specification add DTLS support.</dd>
<dt>Version:</dt>
<dd style="margin-left: 8">This document specifies protocol version 0.  Should later updates to this document specify different message formats with a version number greater than zero, the first two bytes of those new message formats will still contain the version number and opcode as shown here, so that a PCP server receiving a message format newer or older than the version(s) it understands can still parse enough of the message to correctly identify the version number, and determine whether the problem is that this server is too old and needs to be updated to work with the PCP client, or whether the PCP client is too old and needs to be updated to work with this server.</dd>
<dt>R:</dt>
<dd style="margin-left: 8">Indicates Request (0) or Response (1). All Requests MUST use 0.</dd>
<dt>OpCode:</dt>
<dd style="margin-left: 8">Opcodes are defined in <a href="#pin_opcodes">Section 8</a> and <a href="#peer_opcodes">Section 9</a>. New OpCodes can be defined per rules described in <a href="#iana">Section 13</a>.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">48 reserved bits, MUST be sent as 0 and MUST be ignored when received.</dd>
</dl>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> Response Header</h1>
<div id="#rfc.figure.3"></div>
<div id="#common_response"></div>
<p>All responses have the following format:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1| Version = 0 |R|   OpCode    |   Reserved    |  Result Code  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Epoch                                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:             (optional) OpCode-specific response data          :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:             (optional) Options                                :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.5.2.p.1">These fields are described below:</p>

<dl>
<dt>1</dt>
<dd style="margin-left: 8">A single bit set to 1.</dd>
<dt>Ver:</dt>
<dd style="margin-left: 8">This document specifies protocol version 0.  Should later updates to this document specify different message formats with a version number greater than zero, the first four bytes of those new message formats will still contain the version number, opcode, and result code, as shown here, so that a PCP client receiving a message format newer or older than the version(s) it understands can still parse enough of the message to correctly identify the version number, and determine whether the problem is that this client is too old and needs to be updated to work with the PCP server, or whether the PCP server is too old and needs to be updated to work with this client.</dd>
<dt>R:</dt>
<dd style="margin-left: 8">Indicates Request (0) or Response (1). All Responses MUST use 1.</dd>
<dt>OpCode:</dt>
<dd style="margin-left: 8">The OpCode value, copied from the request.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">8 reserved bits, MUST be sent as 0, MUST be ignored when received. This is set by the server.</dd>
<dt>Result Code:</dt>
<dd style="margin-left: 8">The result code for this response. See <a href="#result_codes">Section 5.4</a> for values. This is set by the server.</dd>
<dt>Epoch:</dt>
<dd style="margin-left: 8">The server's Epoch value. See <a href="#epoch">Section 6.5</a> for discussion. This value is set both success and error responses.</dd>
</dl>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> <a href="#pcp_information_elements" id="pcp_information_elements">Options</a>
</h1>
<p id="rfc.section.5.3.p.1">A PCP OpCode can be extended with an Option. Options can be used in requests and responses. It is anticipated that Options will include information which are associated with the normal function of an OpCode. For example, an Option could indicate DSCP <a href="#RFC2474">[RFC2474]</a> markings to apply to incoming or outgoing traffic associated with a PCP mapping, or an Option could include descriptive text (e.g., "for my webcam").</p>
<div id="#rfc.figure.4"></div>
<div id="#options-layout"></div>
<p>Options use the following Type-Length-Value format:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Option Code  |  Reserved     |       Option-Length           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                       (optional) data                         :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.5.3.p.2">The description of the fields is as follows:</p>

<dl>
<dt>Option Code:</dt>
<dd style="margin-left: 8">Option code, 8 bits. The first bit of the option code is the "P" bit, described below. Option codes MUST be registered with IANA following the procedure described in <a href="#iana">Section 13</a>.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">MUST be set to 0 on transmission and MUST be ignored on reception.</dd>
<dt>Option-Length:</dt>
<dd style="margin-left: 8">Indicates in units of 4 octets the length of the enclosed data. Options with length of 0 are allowed.</dd>
<dt>data:</dt>
<dd style="margin-left: 8">Option data. The option data MUST end on a 32 bit boundary, padded with 0's when necessary.</dd>
</dl>
<p id="rfc.section.5.3.p.3">A given Option MAY be included in a request or a response, as permitted by that Option. If a given Option was included in a request, and understood and processed by the PCP server, it MUST be included in the response. The handling of an Option by the PCP client and PCP server MUST be specified in an appropriate document and must include whether the PCP Option can appear (one or more times) in a request, and indicate the contents of the Option in the request and in the response. If an Option appears in a request or response more often than allowed, the first occurence(s) is used and the others simply ignored as if they were not present. If several Options are included in a PCP request or response, they can be encoded in any order by the PCP client and are processed in the order received. If, while processing an option, an error is encountered that causes a PCP error response to be generated, the PCP request causes no state change in the PCP server or the PCP-controlled device (i.e., it rolls back any changes it might have made while processing the request). The response MUST encode the Options in the same order, but may omit some PCP Options in the response, as is necessary to indicate the PCP server does not understand that Option or simply because that Option is not included in responses. Additional Options included in the response (if any) MUST be included at the end. A certain Option MAY appear more than once in a request or in a response, if permitted by the definition of the Option itself. If the Option's definition allows the Option to appear once but it appears more than once in a request, the PCP server MUST respond with the MALFORMED_OPTION result code; if this occurs in a response, the PCP client processes the first occurrence and ignores the other occurrences.</p>
<p id="rfc.section.5.3.p.4">If the "P" bit in the OpCode is set, </p>

<ul>
<li>the PCP server MUST only generate a positive PCP response if it can successfully process the PCP request and this Option.</li>
<li>if the PCP server does not implement this Option, or cannot perform the function indicated by this Option (e.g., due to a parsing error with the option), it MUST generate a failure response with code UNSUPP_OPTION or MALFORMED_OPTION (as appropriate) and include the UNPROCESSED option in the response (<a href="#unprocessed">Section 6.7.1</a>).</li>
</ul>
<p id="rfc.section.5.3.p.5">If the "P" bit is clear, the PCP server MAY process or ignore this Option.</p>
<p id="rfc.section.5.3.p.6">To enhance interoperability, newly defined Options should avoid interdependencies with each other.</p>
<p id="rfc.section.5.3.p.7">New Options MUST include the information below:</p>
<p></p>

<ul class="empty"><li>This Option:<ul class="empty">
<li>name: &lt;mnemonic&gt;</li>
<li>number: &lt;value&gt;</li>
<li>purpose:</li>
<li>is valid for OpCodes: &lt;list of OpCodes&gt;</li>
<li>length: &lt;rules for length&gt;</li>
<li>may appear in: &lt;requests/responses/both&gt;</li>
<li>maximum occurrences: &lt;count&gt;</li>
</ul>
</li></ul>
<h1 id="rfc.section.5.4">
<a href="#rfc.section.5.4">5.4.</a> <a href="#result_codes" id="result_codes">Result Codes</a>
</h1>
<p id="rfc.section.5.4.p.1">The following result codes may be returned as a result of any OpCode received by the PCP server. The only success result code is 0, other values indicate an error. </p>

<dl>
<dt>0</dt>
<dd style="margin-left: 8">SUCCESS, success</dd>
<dt>1</dt>
<dd style="margin-left: 8">UNSUPP_VERSION, unsupported version. </dd>
<dt>2</dt>
<dd style="margin-left: 8">UNSUPP_OPCODE, unsupported OpCode. </dd>
<dt>3</dt>
<dd style="margin-left: 8">UNSUPP_OPTION, unsupported Option. This error only occurs if the Option is in the mandatory-to-process range. </dd>
<dt>4</dt>
<dd style="margin-left: 8">MALFORMED_OPTION, malformed Option (e.g., exists too many times, invalid length).</dd>
<dt>5</dt>
<dd style="margin-left: 8">UNSPECIFIED_ERROR, server encountered unspecified error. </dd>
<dt>6</dt>
<dd style="margin-left: 8">MALFORMED_REQUEST. </dd>
</dl>
<p id="rfc.section.5.4.p.2">Additional result codes, specific to the OpCodes defined in this document, are listed in <a href="#map_result_codes">Section 8.2</a> and <a href="#peer_result_codes">Section 9.2</a> .</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> General PCP Operation</h1>
<p id="rfc.section.6.p.1">PCP messages MUST be sent over UDP, and the PCP server MUST listen for PCP requests on the PCP port number (<a href="#iana_port">Section 13.1</a>). Every PCP request generates a response, so PCP does not need to run over a reliable transport protocol.</p>
<p id="rfc.section.6.p.2">PCP is idempotent, so if the PCP client sends the same request multiple times and the PCP server processes those requests, the same result occurs. The order of operation is that a PCP client generates and sends a request to the PCP server which processes the request and generates a response back to the PCP client.</p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> General PCP Client: Generating a Request</h1>
<p id="rfc.section.6.1.p.1">This section details operation specific to a PCP client, for any OpCode. Procedures specific to the MAP OpCodes are described in <a href="#pin_opcodes">Section 8</a>, and procedures specific to the PEER OpCodes are described in <a href="#peer_opcodes">Section 9</a>.</p>
<p id="rfc.section.6.1.p.2">Prior to sending its first PCP message, the PCP client determines which servers to use. The PCP client performs the following steps to determine its PCP server(s):</p>

<ol>
<li>if a PCP server is configured (e.g., in a configuration file), the address(es) of the PCP server(s) used as the list of PCP server(s), else;</li>
<li>if DHCP indicates the PCP server(s), the address(es) of the indicated PCP server(s) are used as the the list of PCP server(s), else;</li>
<li>the address of the default router is used as the PCP server.</li>
</ol>
<p id="rfc.section.6.1.p.3">With that list of PCP servers, the PCP client formulates its PCP request. The PCP request contains a PCP common header, PCP OpCode and payload, and (possibly) Options. It initializes a retransmission timer to 4 seconds. (As with all UDP or TCP clients on any operating system, when several PCP clients are embedded in the same host, each uses a distinct source port number to disambiguate their requests and replies.) The PCP client sends a PCP message to each server in sequence, waiting for a response until its timer expires. Once a PCP client has successfully communicated with a PCP server, it continues communicating with that PCP server until that PCP server becomes non-responsive, which causes the PCP client to attempt to re-iterate the procedure starting with the first PCP server on its list. If a hard ICMP error is received the PCP client SHOULD immediately abort trying to contact that PCP server (see Section 2 of <a href="#RFC5461">[RFC5461]</a> for discussion of ICMP and ICMPv6 hard errors). If no response is received from any of those servers, it doubles its retransmission timer and tries each server again. This is repeated 4 times (for a total of 5 transmissions to each server).  If, after these transmissions, the PCP client has still not received a response, the PCP client SHOULD abort the procedure.</p>
<p></p>

<ul class="empty"><li>[Ed.&#160;Note: We need to define precisely what we mean by "non-responsive". No response after some number of retransmissions? How many? No response within what time period? -- SC]</li></ul>
<p id="rfc.section.6.1.p.5">Upon receiving a response (success or error), the PCP client does not change to a different PCP server. That is, it does not "shop around" trying to find a PCP server to service its (same) request.</p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> General PCP Server: Processing a Request</h1>
<p id="rfc.section.6.2.p.1">This section details operation specific to a PCP server.</p>
<p id="rfc.section.6.2.p.2">Upon receiving a PCP request message, the PCP server parses and validates it. A valid request contains a valid PCP common header, one valid PCP Opcode, and zero or more Options (which the server might or might not comprehend). If an error is encountered during processing, the server generates an error response which is sent back to the PCP client. Processing an OpCode and the Options are specific to each OpCode.</p>
<p id="rfc.section.6.2.p.3">If the received message is shorter than 4 octets, has the R bit set, or the first bit is clear, the request is simply dropped. If the version number is not supported, a response is generated containing the UNSUPP_VERSION response code and the protocol version which the server does understand (if the server understands a range of protocol versions then it returns the supported version closest to the version in the request).</p>
<p id="rfc.section.6.2.p.4">If the OpCode is not supported, a response is generated with the UNSUPP_OPCODE response code. If the length of the request exceeds 1024 octets or is not a multiple of 4 octets, it is invalid. Invalid requests are handled by copying up to 1024 octets of the request into the response, setting the response code to MALFORMED_REQUEST, and zero-padding the response to a multiple of 4 octets if necessary.</p>
<p id="rfc.section.6.2.p.5">Error responses have the same packet layout as success responses, with fields copied from the request copied into the response, and other fields assigned by the PCP server set to 0.</p>
<p></p>

<ul class="empty"><li>[Ed.&#160;Note: Need more detail around how an error response is formed, and what it contains.]</li></ul>
<h1 id="rfc.section.6.3">
<a href="#rfc.section.6.3">6.3.</a> General PCP Client: Processing a Response</h1>
<p id="rfc.section.6.3.p.1">The PCP client receives the response and verifies the source IP address and port belong to the PCP server of an outstanding request.  It validates the version number and OpCode matches an outstanding request. Responses shorter than 12 octets, longer than 1024 octets, or not a multiple of 4 octets are invalid and ignored, likely causing the request to be re-transmitted. The response is further matched by comparing fields in the response OpCode-specific data to fields in the request OpCode-specific data. After a successful match with an outstanding request, the PCP client checks the Epoch field to determine if it needs to restore its state to the PCP server (see <a href="#epoch">Section 6.5</a>).</p>
<p id="rfc.section.6.3.p.2">If the response code is 0, the PCP client knows the request was successful.</p>
<p id="rfc.section.6.3.p.3">If the response code is not 0, the request failed. If the response code is UNSUPP_VERSION, processing continues as described in <a href="#version">Section 6.6</a>. The PCP client MAY resend the same message but MUST first wait until the smaller of 30 minutes or the value of the Lifetime field. If the PCP client has re-discovered a new PCP server (e.g., connected to a new network), the PCP client is not restricted from communicating immediately with its new PCP server.</p>
<p id="rfc.section.6.3.p.4">Non-0 responses will normally have a value in the Assigned Lifetime field. Clients SHOULD NOT repeat the same request to the same PCP server within the lifetime given in the error response. In the case of the SERVER_OVERLOADED error response, clients SHOULD NOT send *any* further requests to the that PCP server within the lifetime given in the SERVER_OVERLOADED error response.</p>
<h1 id="rfc.section.6.4">
<a href="#rfc.section.6.4">6.4.</a> <a href="#mif" id="mif">Multi-interface Issues</a>
</h1>
<p id="rfc.section.6.4.p.1">Hosts which desire a PCP mapping might be multi-interfaced (i.e., own several logical/physical interfaces). Indeed, a host can be dual-stack or be configured with several IP addresses. These IP addresses may have distinct reachability scopes (e.g., if IPv6 they might have global reachability scope as for GUA (Global Unicast Address) or limited scope such as ULA (Unique Local Address, <a href="#RFC4193">[RFC4193]</a>)).</p>
<p id="rfc.section.6.4.p.2">IPv6 addresses with global reachability scope SHOULD be used as internal IP address when requesting a PCP mapping in a PCP-controlled device. IPv6 addresses with limited scope (e.g., ULA), SHOULD NOT be indicated as internal IP address in a PCP message.</p>
<p id="rfc.section.6.4.p.3">As mentioned in <a href="#single_homed">Section 2.3</a>, only single-homed CP routers are in scope. Therefore, there is no viable scenario where a host located behind a CP router is assigned with two GUA addresses belonging to the same global IPv6 prefix. </p>

<ul class="empty"><li>[Ed.&#160;Note: text regarding multi-homing needs work.]</li></ul>
<h1 id="rfc.section.6.5">
<a href="#rfc.section.6.5">6.5.</a> <a href="#epoch" id="epoch">Epoch</a>
</h1>
<p id="rfc.section.6.5.p.1">Every PCP response sent by the PCP server includes an Epoch field. This field increments by 1 every second, and indicates to the PCP client if PCP state needs to be restored. If the PCP server resets or loses the state of its explicit dynamic Mappings (that is, those mappings created by PCP MAP requests), due to reboot, power failure, or any other reason, it MUST reset its Epoch time to 0.  Similarly, if the public IP address(es) of the NAT (controlled by the PCP server) changes, the Epoch MUST be reset to 0. A PCP server MAY maintain one Epoch value for all PCP clients, or MAY maintain distinct Epoch values for each PCP client; this choice is implementation-dependent.</p>
<p id="rfc.section.6.5.p.2">Whenever a client receives a PCP response, the client computes its own conservative estimate of the expected Epoch value by taking the Epoch value in the last packet it received from the gateway and adding 7/8 (87.5%) of the time elapsed since that packet was received. If the Epoch value in the newly received packet is less than the client's conservative estimate by more than one second, then the client concludes that the PCP server lost state, and the client MUST immediately renew all its active port mapping leases as described in <a href="#reboot">Section 8.9.1</a>.</p>
<p id="rfc.section.6.5.p.3">When the PCP server reduces its Epoch value, the PCP clients will send PCP requests to refresh their mappings. The PCP server needs to be scaled appropriately to accomodate this traffic. Because PCP lacks a mechanism to simultaneously inform all PCP clients of the Epoch value, the PCP clients will not flood the PCP server simultaneously when the PCP server reduces its Epoch value.</p>
<h1 id="rfc.section.6.6">
<a href="#rfc.section.6.6">6.6.</a> <a href="#version" id="version">Version negotiation</a>
</h1>
<p id="rfc.section.6.6.p.1">A PCP client sends its requests using PCP version number 0.  Should later updates to this document specify different message formats with a version number greater than zero it is expected that PCP servers will still support version 0 in addition to the newer version(s). However, in the event that a server returns a response with error code UNSUPP_VERSION, the client MAY log an error message to inform the user that it is too old to work with this server, and the client SHOULD set a timer to retry its request in 30 minutes (in case this was a temorary condition and the server configuration is changed to rectify the situation).</p>
<p id="rfc.section.6.6.p.2">If future PCP versions greater than zero are specified, version negotiation is expected to proceed as follows: </p>

<ol>
<li>If a client or server supports more than one version it SHOULD support a contiguous range of versions -- i.e., a lowest version and a highest version and all versions in between.</li>
<li>Client sends first request using highest (i.e., presumably 'best') version number it supports.</li>
<li>If server supports that version it responds normally.</li>
<li>If server does not support that version it replies giving a response containing the error code UNSUPP_VERSION, and the closest version number it does support (if the server supports a range of versions higher than the client's requested version, the server returns the lowest of that supported range; if the server supports a range of versions lower than the client's requested version, the server returns the highest of that supported range).</li>
<li>If the client receives an UNSUPP_VERSION response containing a version it does support, it records this fact and proceeds to use this message version for subsequent communication with this PCP server (until a possible future UNSUPP_VERSION response if the server is later updated, at which point the version negotiation process repeats).</li>
<li>If the client receives an UNSUPP_VERSION response containing a version it does not support then the client MAY log an error message to inform the user that it is too old to work with this server, and the client SHOULD set a timer to retry its request in 30 minutes.</li>
</ol>
<h1 id="rfc.section.6.7">
<a href="#rfc.section.6.7">6.7.</a> General PCP Options</h1>
<p id="rfc.section.6.7.p.1">The following options can appear in certain PCP responses.</p>
<h1 id="rfc.section.6.7.1">
<a href="#rfc.section.6.7.1">6.7.1.</a> <a href="#unprocessed" id="unprocessed">UNPROCESSED</a>
</h1>
<p id="rfc.section.6.7.1.p.1">If the PCP server cannot process a mandatory-to-process option, for whatever reason, it includes the UNPROCESSED Option in the response, shown in <a href="#fig_unprocessed">Figure 5</a>. This helps with debugging interactions between the PCP client and PCP server. For simplicity, no more than 4 options can be encoded. This option MUST NOT appear more than once in a PCP response, no matter how many PCP options appeared in the request and were unprocessed by the PCP server. If only one Option code was unprocessed, that option code it is placed in option-code-1 (and the other three fields are set to zero), if two Option codes were unprocessed, their option codes are placed in option-code-1 and option-code-2, and so on. If a certain Option appeared more than once in the PCP request, that Option value only appears once in the option-code fields. The order of the Options in the PCP request has no relationship with the order of the Option values in this UNPROCESSED Option. This Option MUST NOT appear in a response unless the associated request contained at least one mandatory-to-process Option. This Option MUST NOT appear more than once.</p>
<div id="#rfc.figure.5"></div>
<div id="#fig_unprocessed"></div>
<p>The UNPROCESSED option is formatted as follows:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| option-code-1 | option-code-2 | option-code-3 | option-code-4 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| option-code-5 | option-code-6 | option-code-7 | option-code-8 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p></p>

<ul class="empty"><li>This Option:<ul class="empty">
<li>name: UNPROCESSED</li>
<li>number: 1</li>
<li>purpose: indicates which PCP options in the request are not supported by the PCP server</li>
<li>is valid for OpCodes: all</li>
<li>length: 1</li>
<li>may appear in: responses, and only if the response code is non-zero.</li>
<li>maximum occurrences: 1</li>
</ul>
</li></ul>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#opcode_introduction" id="opcode_introduction">Introduction to MAP and PEER OpCodes</a>
</h1>
<p id="rfc.section.7.p.1">There are three uses for the MAP and PEER OpCodes defined in this document: a host operating a server (and wanting an incoming connection), a host operating a client (and wanting to optimize the application keepalive traffic), and a host operating a client and server on the same port. These are discussed in the following sections.</p>
<p id="rfc.section.7.p.2">When operating a server (<a href="#operating_a_server">Section 7.1</a> and <a href="#pcp_symmetric">Section 7.3</a>) the PCP client knows if it wants an IPv4 listener, IPv6 listener, or both on the Internet. The PCP client also knows if it has an IPv4 interface on itself or an IPv6 interface on itself. It takes the union of this knowledge to decide to send a one or two MAP requests for each of its interfaces. Applications that embed IP addresses in payloads (e.g., FTP, SIP) will find it beneficial to avoid address family translation, if possible.</p>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> <a href="#operating_a_server" id="operating_a_server">For Operating a Server</a>
</h1>
<p id="rfc.section.7.1.p.1">A host operating a server (e.g., a web server) listens for traffic on a port, but the server never initiates traffic from that port. For this to work across a NAT or a firewall, the application needs to (a) create a mapping from a public IP address and port to itself as described in <a href="#pin_opcodes">Section 8</a> and (b) publish that public IP address and port via some sort of rendezvous server (e.g., DNS, a SIP message, a proprietary protocol). Publishing the public IP address and port is out of scope of this specification. To accomplish (a), the application follows the procedures described in this section.</p>
<p id="rfc.section.7.1.p.2">As normal, the application needs to begin listening to a port, and to ensure that it can get exclusive use of that port it needs to choose a port that is not in the operating system's ephemeral port range. Then, the application constructs a PCP message with the appropriate MAP OpCode depending on if it is listening on an IPv4 or IPv6 interface and if it wants a public IPv4 or IPv6 address.</p>
<div id="#rfc.figure.6"></div>
<div id="#fig_operate_server"></div>
<p>The following pseudo-code shows how PCP can be reliably used to operate a server:</p>
<pre>
/* start listening on the local server port */
int s = socket(...);
internal_sockaddr = ...;
bind(s, &amp;internal_sockaddr, ...);
listen(s, ...);
requested_external_sockaddr = 0;
pcp_send_map_request(internal_sockaddr, 
   requested_external_sockaddr, &amp;assigned_external_sockaddr, 
   requested_lifetime, &amp;assigned_lifetime);
update_rendezvous_server("Client 12345", assigned_external_sockaddr);
while (1) {
    int c = accept(s, ...);
    /* ... */
}</pre>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> <a href="#keepalives" id="keepalives">For Reducing NAT Keepalive Messages</a>
</h1>
<p></p>

<ul class="empty"><li>[Ed.&#160;Note: This section creates a difference between an implicitly-created mapping, which PCP then tries to query/control using the PEER OpCode, and a explicitly-created mapping which was created with a MAP OpCode. This section attempts to address PCP Issue #9 and PCP Issue #35.]</li></ul>
<p id="rfc.section.7.2.p.2">A host operating a client (e.g., XMPP client, SIP client) sends from a port but never accepts incoming connections on this port. It wants to ensure the flow to its server is not terminated (due to inactivity) by an on-path NAT or firewall. To accomplish this, the applications uses the procedure described in this section.</p>
<p id="rfc.section.7.2.p.3">Middleboxes such as NATs or firewalls need to see occasional traffic or will terminate their session state, causing application failures. To avoid this, many applications routinely generate keepalive traffic for the primary (or sole) purpose of maintaining state with such middleboxes. Applications can reduce such application keepalive traffic by using PCP. </p>

<ul class="empty"><li>Note: For reasons beyond NAT, an application may find it useful to perform application-level keepalives, such as to detect a broken path between the client and server, detect a crashed server, or detect a powered-down client. These keepalives are not related to maintaining middlebox state, and PCP cannot do anything useful to reduce those keepalives.</li></ul>
<p id="rfc.section.7.2.p.4">To use PCP for this function, the applications first connects to its server, as normal. Afterwards, it issues a PCP request with the PEER4 or PEER6 OpCode as described in <a href="#peer_opcodes">Section 9</a>. The PEER4 OpCode is used if the host is using IPv4 for its communication to its peer; PEER6 if using IPv6. The same 5-tuple as used for the connection to the server is placed into the PEER4 or PEER6 payload.</p>
<div id="#rfc.figure.7"></div>
<div id="#fig_keepalive_pseudocode"></div>
<p>The following pseudo-code shows how PCP can be reliably used with a dynamic socket, for the purposes of reducing application keepalive messages:</p>
<pre>
int s = socket(...);
connect(s, &amp;remote_peer, ...);
getsockname(s, &amp;internal_address, ...);
external_address = 0;
pcp_send_peer_request(internal_address, 
   requested_external_address, &amp;assigned_external_address, 
   remote_peer, requested_lifetime, &amp;assigned_lifetime);
</pre>
<h1 id="rfc.section.7.3">
<a href="#rfc.section.7.3">7.3.</a> <a href="#pcp_symmetric" id="pcp_symmetric">For Operating a Symmetric Client/Server</a>
</h1>
<p></p>

<ul class="empty"><li>[Ed.&#160;Note: The PEER4 and PEER6 OpCodes, discussed here, are intended to resolve PCP Issue #35.]</li></ul>
<p id="rfc.section.7.3.p.2">A host operating a client and server on the same port (e.g., <a href="#RFC4961">Symmetric RTP</a> <cite title="NONE">[RFC4961]</cite> or <a href="#RFC3581">SIP Symmetric Response Routing (rport)</a> <cite title="NONE">[RFC3581]</cite>) first establishes a local listener, (usually) sends the local and public IP addresses and ports to a rendezvous service (which is out of scope of this document), and (usually) initiates outbound connections from that same source address. To accomplish this, the application uses the procedure described in this section.</p>
<p id="rfc.section.7.3.p.3">An application that is using the same port for outgoing connections as well as incoming connections MUST first signal its operation of a server using the PCP MAP OpCode, as described in <a href="#pin_opcodes">Section 8</a>, and receive a positive PCP response before it sends any packets from that port. </p>

<ul class="empty"><li>Discussion: Although reversing those steps is tempting (to eliminate the PCP round trip before a packet can be sent from that port) and will work if the NAT has endpoint-independent mappings (EIM) behavior, reversing the steps will fail if the NAT does not have EIM behavior. With a non-EIM NAT, the implicit mapping created by an outgoing TCP SYN and the explicit mapping created using the MAP OpCode will cause different ports to be assigned (which is not desirable; after all, the application is using the same port for outgoing and incoming traffic on purpose) and they will generally also have different lifetimes. PCP does not attempt to change or dictate how a NAT creates its mappings (endpoint independent mapping, or otherwise) so there is no assurance that an implicit mapping will be EIM or non-EIM. Thus, it is necessary for applications to first signal its operation of a server using the PCP MAP OpCode.</li></ul>
<div id="#rfc.figure.8"></div>
<div id="#fig_pseudocode_symmetric"></div>
<p>The following pseudo-code shows how PCP can be used to operate a symmetric client and server:</p>
<pre>
/* start listening on the local server port */
int s = socket(...);
internal_sockaddr = ...;
bind(s, &amp;internal_sockaddr, ...);
listen(s, ...);
requested_external_sockaddr = 0;
pcp_send_map_request(internal_sockaddr, 
   requested_external_sockaddr, &amp;assigned_external_sockaddr, 
   requested_lifetime, &amp;assigned_lifetime);
update_rendezvous_server("Client 12345", assigned_external_sockaddr);
send_packet(s, "Hello World");
while (1) {
    int c = accept(s, ...);
    /* ... */
}
</pre>
<p></p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#pin_opcodes" id="pin_opcodes">MAP OpCodes</a>
</h1>
<p id="rfc.section.8.p.1">This section defines four OpCodes which control forwarding from a NAT (or firewall) to an internal host. They are: </p>

<dl>
<dt> MAP4=0:</dt>
<dd style="margin-left: 11">create a mapping between an internal address and external IPv4 address (e.g., NAT44, NAT64, or firewall)</dd>
<dt> MAP6=1:</dt>
<dd style="margin-left: 11">create a mapping between an internal address and external IPv6 address (e.g., NAT46, NAT66, or firewall)</dd>
</dl>
<p id="rfc.section.8.p.2">The operation of these OpCodes is described in this section.</p>
<h1 id="rfc.section.8.1">
<a href="#rfc.section.8.1">8.1.</a> OpCode Packet Formats</h1>
<p id="rfc.section.8.1.p.1">The two MAP OpCodes (MAP4, MAP6) share a similar packet layout for both requests and responses. Because of this similarity, they are shown together. For both of the MAP OpCodes, if the assigned external IP address and assigned external port both match the request's source IP address and MAP OpCode's internal IP address, the functionality is purely a firewall; otherwise it pertains to a network address translator which might also perform firewall functions.</p>
<div id="#rfc.figure.9"></div>
<div id="#pin_request"></div>
<p>The following diagram shows the request packet format for MAP4 and MAP6. This packet format is aligned with the response packet format:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Protocol     |          Reserved (24 bits)                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
: Requested external IP address (32 or 128, depending on OpCode):
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        internal port          |   requested external port     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.8.1.p.2">These fields are described below:</p>

<dl>
<dt>Protocol:</dt>
<dd style="margin-left: 8">indicates protocol associated with this OpCode. Values are taken from the <a href="#proto_numbers">IANA protocol registry</a> <cite title="NONE">[proto_numbers]</cite>. For example, this field contains 6 (TCP) if the opcode is intended to create a TCP mapping. The value 0 means "all protocols" (supported by the PCP server), which is useful to create mappings for all protocols with a <a href="#RFC3022">Basic NAT</a> <cite title="NONE">[RFC3022]</cite> or a firewall, and used to delete mappings for all protocols.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">24 reserved bits, MUST be sent as 0 and MUST be ignored when received.</dd>
<dt>Requested External IP Address:</dt>
<dd style="margin-left: 8">Requested external IP address. This is useful for refreshing a mapping, especially after the PCP server loses state. If the PCP server can fulfill the request, it will do so. If the PCP client doesn't know the external address, or doesn't have a preference, it MUST use 0.</dd>
<dt>Requested lifetime:</dt>
<dd style="margin-left: 8">Requested lifetime of this mapping, in seconds.</dd>
<dt>Internal port:</dt>
<dd style="margin-left: 8">Internal port for the mapping. The value 0 means "all ports", which is useful to create mappings for all protocols with a <a href="#RFC3022">Basic NAT</a> <cite title="NONE">[RFC3022]</cite> or a firewall, and used to delete mappings for all ports for a protocol. Using 0 for both this field and the Protocol field indicates "all ports for all (supported) protocols".</dd>
<dt>Requested external port:</dt>
<dd style="margin-left: 8">requested external port for the mapping. This is useful for refreshing a mapping, especially after the PCP server loses state. If the PCP server can fulfill the request, it will do so. If the PCP client doesn't know the external port, or doesn't have a preference, it uses 0.</dd>
</dl>
<div id="#rfc.figure.10"></div>
<div id="#pin_response"></div>
<p>The following diagram shows the response packet format for MAP4 and MAP6 OpCodes:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Protocol     |          Reserved (24 bits)                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
: Assigned external IP address (32 or 128, depending on OpCode) :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                         Lifetime                              :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       internal port           |    assigned external port     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.8.1.p.3">These fields are described below:</p>

<dl>
<dt>Protocol:</dt>
<dd style="margin-left: 8">Copied from the request</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">24 reserved bits, MUST be sent as 0 and MUST be ignored when received.</dd>
<dt>Assigned external IP address:</dt>
<dd style="margin-left: 8">On success responses, this is the assigned external IPv4 or IPv6 address for the mapping; IPv4 or IPv6 address is indicated by the OpCode. On error responses, this MUST be 0.</dd>
<dt>Lifetime:</dt>
<dd style="margin-left: 8">On a success response, this indicates the lifetime for this mapping, in seconds. On an error response, this indicates how long clients should assume they'll get the same error response from the that PCP server if they repeat the same request. </dd>
<dt>Internal port:</dt>
<dd style="margin-left: 8">Internal port for the mapping, copied from request.</dd>
<dt>Assigned external port:</dt>
<dd style="margin-left: 8">On success responses, this is the assigned external port for the mapping. IPv4 or IPv6 address is indicated by the OpCode. If the NAT gateway can allocate the requested external port it SHOULD do so. This is beneficial for re-establishing state lost when a NAT gateway fails or loses its state due to reboot. If the NAT gateway cannot allocate the requested external port but can allocate some other port, it MUST do so and return the allocated port in the response.  Cases where a NAT gateway cannot allocate the requested external port include when the requested external port is prohibited by policy, already used by the NAT gateway for one of its own services (e.g., port 80 for the NAT gateway's own configuration pages) already allocated to another explicit mapping (by static manual allocation or by a prior PCP request by a different Internal Host) or the rare case where the requested external port was already allocated to an implicit mapping which cannot be 'promoted' to an explicit mapping for this Internal Host (a different Internal Host already made a prior outbound connection for which the NAT gateway happened to assign the external port requested in this explicit PCP request). On error responses, this MUST be 0.</dd>
</dl>
<h1 id="rfc.section.8.2">
<a href="#rfc.section.8.2">8.2.</a> <a href="#map_result_codes" id="map_result_codes">OpCode-Specific Result Codes</a>
</h1>
<p id="rfc.section.8.2.p.1">In addition to the general PCP result codes (<a href="#result_codes">Section 5.4</a>), the following additional result codes may be returned as a result of the four MAP OpCodes received by the PCP server. These errors are considered 'long lifetime' or 'short lifetime', which provides guidance to PCP server developers for the duration of the Lifetime value for these errors. It is RECOMMENDED that short lifetime errors use 30 second lifetime and long lifetime errors use 30 minute lifetime.</p>

<dl>
<dt>19</dt>
<dd style="margin-left: 8">SERVER_OVERLOADED, server is processing too many MAP requests from this client or from other clients, and requests this client delay sending other requests. This is a long lifetime error.</dd>
<dt>20</dt>
<dd style="margin-left: 8">NETWORK_FAILURE, e.g., NAT device has not obtained a DHCP lease so cannot perform a MAP operation. This is a short lifetime error.</dd>
<dt>21</dt>
<dd style="margin-left: 8">NO_RESOURCES, e.g., NAT device cannot create more mappings at this time. This is a system-wide error, and different from USER_EX_QUOTA. This is a short lifetime error.</dd>
<dt>22</dt>
<dd style="margin-left: 8">UNSUPP_PROTOCOL, unsupported Protocol. This is a long lifetime error.</dd>
<dt>23</dt>
<dd style="margin-left: 8">NOT_AUTHORIZED, e.g., PCP server supports mapping, but the feature is disabled for this PCP client, or the PCP client requested a mapping that cannot be fulfilled by the PCP server's security policy. This is a long lifetime error.</dd>
<dt>24</dt>
<dd style="margin-left: 8">USER_EX_QUOTA, mapping would exceed user's port quota. This is a short lifetime error.</dd>
<dt>25</dt>
<dd style="margin-left: 8">CANNOT_PROVIDE_EXTERNAL_PORT, indicates the port is already in use or otherwise unavailable (e.g., special port that cannot be allocated by the server's policy). This error is only returned if the request included the Option PREFER_FAILURE.  This is a short lifetime error.</dd>
<dt>26</dt>
<dd style="margin-left: 8">UNABLE_TO_DELETE_ALL, indicates the PCP server was not able to delete all mappings. This is a short lifetime error.</dd>
</dl>
<p id="rfc.section.8.2.p.2">Other result codes are defined following the procedure in <a href="#iana_result_codes">Section 13.3</a>.</p>
<h1 id="rfc.section.8.3">
<a href="#rfc.section.8.3">8.3.</a> <a href="#pin-opcode_client_operation" id="pin-opcode_client_operation">OpCode-Specific Client: Generating a Request</a>
</h1>
<p id="rfc.section.8.3.p.1">This section describes the operation of a PCP client when sending requests with OpCodes MAP4 and MAP6.</p>
<p id="rfc.section.8.3.p.2">There are certain sentinal values used by the MAP OpCodes:</p>

<ul>
<li>lifetime=0, indicates a request to delete the specified mapping.</li>
<li>target IP address=0, indicates all internal IP addresses associated with this subscriber. This is valid only if lifetime is also 0. [[THIRD_PARTY]]</li>
<li>internal-port=0, indicates all ports. This is valid only if lifetime is also 0.</li>
</ul>
<p id="rfc.section.8.3.p.3">The request MAY contain values in the requested-external-ip-address and requested-external-port fields. This allows the PCP client to attempt to rebuild the PCP server's state, so that the PCP client could avoid having to change information maintained at the rendezvous server. Of course, due to other activity on the network (e.g., by other users or network renumbering), the PCP server may not be able to fulfill the request.</p>
<p id="rfc.section.8.3.p.4">An existing mapping can have its lifetime extended by the PCP client. To do this, the PCP client sends a new MAP request indicating the internal IP address and port(s).</p>
<p id="rfc.section.8.3.p.5">The PCP client SHOULD renew the mapping before its expiry time, otherwise it will be removed by the PCP server (see <a href="#lifetime">Section 8.6</a>). In order to prevent excessive PCP chatter, it is RECOMMENDED to send a single renewal request packet when a mapping is halfway to expiration time, then, if no positive response is received, another single renewal request 3/4 of the way to expiration time, and then another at 7/8 of the way to expiration time, and so on, subject to the constraint that renewal requests MUST NOT be sent less than four seconds apart (a PCP client MUST NOT send an infinite number of ever-closer-together requests in the last few seconds before a mapping expires).</p>
<h1 id="rfc.section.8.4">
<a href="#rfc.section.8.4">8.4.</a> <a href="#map-opcode_server_operation" id="map-opcode_server_operation">OpCode-Specific Server: Processing a Request</a>
</h1>
<p id="rfc.section.8.4.p.1">This section describes the operation of a PCP server when processing a request with the OpCodes MAP4 or MAP6.</p>
<p id="rfc.section.8.4.p.2">If the requested lifetime is 0, it indicates a request to delete the mapping immediately. If the target-ip-address is 0, it indicates all IP addresses belonging to this subscriber should have all their mappings removed [[THIRD_PARTY]]. If internal-port is 0, it means the delete request is for all ports of the particular protocol. On a deletion request, the requested external port field is ignored by the server. PCP MAP requests only control mappings created by MAP requests. So, if the PCP client attempts to delete a static mapping (i.e., a mapping created outside of PCP itself), the PCP server deletes all of the PCP-created mappings but MUST respond with UNABLE_TO_DELETE_ALL result code, with the other fields encoded as described above. If the PCP client attempts to delete a mapping that does not exist, the success response code is returned. If the PCP client is not authorized to delete this mapping, NOT_AUTHORIZED is returned. If the deletion request was properly formatted, a positive response is generated with lifetime of 0 and the server copies the protocol and internal port number from the request into the response; this positive response is generated even if there is no mapping (because the mapping could have been already deleted by a previous PCP transaction).</p>
<p id="rfc.section.8.4.p.3">If the requested lifetime is not zero, it indicates a request to create a mapping or extend the lifetime of an existing mapping.</p>
<p id="rfc.section.8.4.p.4">Processing of the lifetime is described in <a href="#lifetime">Section 8.6</a>.</p>
<p id="rfc.section.8.4.p.5">If the PCP-controlled device is stateless (that is, it does not establish any per-flow state, and simply rewrites the address and/or port in a purely algorithmic fashion), the PCP server simply returns an answer indicating the external IP address and port yielded by this stateless algorithmic translation. This allows the PCP client to learn its external IP address and port as seen by remote peers. Examples of stateless translators include stateless NAT64 and 1:1 NAT44, both of which modify addresses but not port numbers.</p>
<p id="rfc.section.8.4.p.6">If an Option with value greater than 128 exists but that option does not make sense (e.g., the PREFER_FAILURE option is included in a request with lifetime=0), the request is invalid and generates a MALFORMED_OPTION error.</p>
<p id="rfc.section.8.4.p.7">By default, a PCP-controlled device MUST NOT create mappings for a protocol not indicated in the request. For example, if the request was for a TCP mapping, a UDP mapping MUST NOT be created.</p>
<p id="rfc.section.8.4.p.8">If the THIRD_PARTY option is not present in the request, the source IP address of the PCP packet is used when creating the mapping. If the THIRD_PARTY option is present, the PCP server validates the indicated target IP address belongs to the same subscriber. This validation depends on the PCP deployment scenario; see <a href="#subscriber_identification">Section 12.3</a> for the validation procedure. If the internal IP address in the PCP request does not belong to the subscriber, an error response MUST be generated with result code NOT_AUTHORIZED.</p>
<p id="rfc.section.8.4.p.9">Mapings typically consume state on the PCP-controlled device, and it is RECOMMENDED that a per-subscriber or per-host limit be enforced by the PCP server to prevent exhausting the mapping state. If this limit is exceeded, the response code USER_EX_QUOTA is returned.</p>
<p id="rfc.section.8.4.p.10">If all of the proceeding operations were successful (did not generate an error response), then the requested mappings are created as described in the request and a positive response is built. This positive result contains the same OpCode as the request, but with the "R" bit set.</p>
<p id="rfc.section.8.4.p.11">As a side-effect of creating a mapping, ICMP messages associated with the mapping MUST be forwarded (and also translated, if appropriate) for the duration of the mapping's lifetime. This is done to ensure that ICMP messages can still be used by hosts, without application programmers or PCP client implementations needing to signal PCP separately to create ICMP mappings for those flows.</p>
<h1 id="rfc.section.8.5">
<a href="#rfc.section.8.5">8.5.</a> OpCode-Specific Client: Processing a Response</h1>
<p id="rfc.section.8.5.p.1">This section describes the operation of the PCP client when it receives a PCP response for the OpCodes MAP4 or MAP6.</p>
<p id="rfc.section.8.5.p.2">A response is matched with a request by comparing the protocol, internal IP address, and internal port. Other fields are not compared, because the PCP server sets those fields.</p>
<p id="rfc.section.8.5.p.3">If a successful response, the PCP client can use the external IP address and port(s) as desired. Typically the PCP client will communicate the external IP address and port(s) to another host on the Internet using an application-specific rendezvous mechanism such as DNS SRV records.</p>
<p id="rfc.section.8.5.p.4">If the response code is IMPLICIT_MAPPING_EXISTS, it indicates the PCP client is attempting to use MAP when an implicit dynamic connection already exists for the same internal host and internal port. This can occur with certain types of NATs. When this is received, if the PCP client still wants to establish a mapping, the PCP client MUST choose a different internal port and send a new PCP request specifying that port.</p>
<p id="rfc.section.8.5.p.5">On an error response, clients SHOULD NOT repeat the same request to the same PCP server within the lifetime returned in the response.</p>
<h1 id="rfc.section.8.6">
<a href="#rfc.section.8.6">8.6.</a> <a href="#lifetime" id="lifetime">Mapping Lifetime and Deletion</a>
</h1>
<p id="rfc.section.8.6.p.1">The PCP client requests a certain lifetime, and the PCP server responds with the assigned lifetime. The PCP server MAY grant a lifetime smaller or larger than the requested lifetime. The PCP server SHOULD be configurable for permitted minimum and maximum lifetime, and the RECOMMENDED values are 120 seconds for the minimum value and 24 hours for the maximum. It is NOT RECOMMENDED that the server allow lifetimes exceeding 24 hours, because they will consume ports even if the internal host is no longer interested in receiving the traffic or no longer connected to the network.</p>
<p id="rfc.section.8.6.p.2">Once a PCP server has responded positively to a mapping request for a certain lifetime, the port forwarding is active for the duration of the lifetime unless the lifetime is reduced by the PCP client (to a shorter lifetime or to zero) or until the PCP server loses its state (e.g., crashes). However, if the PCP lifetime has reached zero yet there is still active inside-to-outside traffic, the PCP server MAY, if it desires, keep the mapping active until the inside-to-outside traffic has stopped.</p>
<p id="rfc.section.8.6.p.3">An application that forgets its PCP-assigned mappings (e.g., the application or OS crashes) will request new PCP mappings. This will consume port mappings. The application will also likely initiate new implicit dynamic mappings (e.g., TCP connections) without using PCP, which will also consume port mappings. If there is a port mapping quota for the internal host, frequent restarts such as this may exhaust the quota. PCP provides no explicit protection against such port consumption. In such environments, it is RECOMMENDED that applications use shorter PCP lifetimes to reduce the impact of consuming the user's port quota. An operating system or framework that issues a mapping request to "delete all" (protocol=0, port=0, lifetime=0) on reboot protects itself against this resource exhaustion by voluntarily relinquishing all of its old mappings before beginning to request new ones. The PCP server MAY chose to allocate the same (recently relinquished) mappings when mappings are re-requested by the booting OS. Some port mapping APIs (such as the "DNSServiceNATPortMappingCreate" API provided by Apple's Bonjour on Mac OS X, iOS, Windows, Linux, etc.) automatically monitor for process exit (including application crashes) and automatically send port mapping deletion requests if the process that requested them goes away without explicitly relinquishing them.</p>
<p id="rfc.section.8.6.p.4">In order to reduce unwanted traffic and data corruption, a port that was mapped using the MAP OpCode SHOULD NOT be assigned to another internal target, or another subscriber, for 120 seconds (MSL, <a href="#RFC0793">[RFC0793]</a>). However, the PCP server MUST allow the same internal target to re-acquire the same port during that same interval.</p>
<p id="rfc.section.8.6.p.5">When a PCP client first acquires a new IP address, it may want to remove mappings that may have been instantiated for a previous host.  To do this, the PCP client sends a MAP request with protocol, external port, internal port, and lifetime set to 0.</p>
<h1 id="rfc.section.8.7">
<a href="#rfc.section.8.7">8.7.</a> Subscriber Renumbering</h1>
<p id="rfc.section.8.7.p.1">The customer premises router might obtain a new IPv4 address or new IPv6 prefix. This can occur because of a variety of reasons including a reboot, power outage, DHCP lease expiry, or other action by the ISP. If this occurs, traffic forwarded to the subscriber might be delivered to another customer who now has that address.  This affects both implicit dynamic mappings and explicit dynamic mappings. However, this same problem occurs today when a subscriber's IP address is re-assigned, without PCP and without an ISP-operated CGN. The solution is the same as today: the problems associated with subscriber renumbering are caused by subscriber renumbering and are eliminated if subscriber renumbering is avoided.  PCP defined in this document does not provide machinery to reduce the subscriber renumbering problem.</p>
<p id="rfc.section.8.7.p.2">When a new Internal Address is assigned to a host embedding a PCP client, the NAT (or firewall) controlled by the PCP server will continue to send traffic to the old IP address. Assuming the PCP client wants to continue receiving traffic, it needs to install new mappings for its new IP address. The requested external port field will not be fulfilled by the PCP server, in all likelihood, because it is still being forwarded to the old IP address. Thus, a mapping is likely to be assigned a new external port number and/or public IP address. Note that this scenario is not expected to happen routinely on a regular basis for most hosts, since most hosts renew their DHCP leases before they expire (or re-request the same address after reboot) and most DHCP servers honor such requests and grant the host the same address it was previously using before the reboot.</p>
<h1 id="rfc.section.8.8">
<a href="#rfc.section.8.8">8.8.</a> <a href="#pin_options" id="pin_options">PCP Options for MAP OpCodes</a>
</h1>
<h1 id="rfc.section.8.8.1">
<a href="#rfc.section.8.8.1">8.8.1.</a> <a href="#third_party" id="third_party">THIRD_PARTY</a>
</h1>
<p id="rfc.section.8.8.1.p.1">This Option is used when a PCP client wants to control a mapping to another host. A PCP server will only support this option if sent by an authorized PCP client. Determining which PCP clients are authorized to use the THIRD_PARTY option depends on the deployment scenario. For Dual-Stack Lite deployments, the PCP server only supports this option if the source IPv4 address is the B4's source IP address. For other scenarios, the subscriber has only one IPv4 address and this Option serves no purpose (and will only generate error messages from the server). If a subscriber has more than one IPv4 address, the ISP MUST determine its own policy for how to identify the trusted device within the subscriber's home. This might be, for example, the lowest- or highest-numbered host address for that user's IPv4 prefix.</p>
<div id="#rfc.figure.11"></div>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
: Target Internal IP address (32 bits of 128 bits, depending    :
:                                       on Option length)       :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre>
<p id="rfc.section.8.8.1.p.2">The fields are described below:</p>

<dl>
<dt>Mapping Internal IP Address:</dt>
<dd style="margin-left: 8">Internal IP address of the mapping. If the length of this Option is 1, this is a 32-bit IPv4 address. If the length of this Option is 4, this is a 128-bit IPv6 address.</dd>
</dl>
<p id="rfc.section.8.8.1.p.3">This Option:</p>

<ul class="empty">
<li>name: THIRD_PARTY</li>
<li>number: 131</li>
<li>purpose: Indicate the MAP request is for a host other than the host sending the PCP option.</li>
<li>is valid for OpCodes: MAP4, MAP6</li>
<li>length: 1 if OpCode is MAP4, 4 if OpCode is MAP6</li>
<li>may appear in: request. May appear in response only if it appeared in the associated request.</li>
<li>maximum occurrences: 1</li>
</ul>
<p id="rfc.section.8.8.1.p.4">A PCP server is configured to permit third party mappings or to restrict third party mappings. If third party mappings are permitted, any host on the network can create, modify, or destroy mappings for another host on the network, which is generally undesirable. If third party mappings are restricted, only a certain host on the network can perform third party mappings. If a PCP server is configured to restrict third party mappings, and receives a PCP MCP request with a Target Address that does not match the source IP address of that request, it MUST generate a UNAUTH_TARGET response. A customer premise router SHOULD be configured to restrict third party mappings.</p>
<p id="rfc.section.8.8.1.p.5">It is RECOMMENDED that PCP servers embedded into customer premise equipment be configured to restrict third party mappings. With this configuration, if a user wants to create a third party mapping, the user needs to interact out-of-band with their customer premise router (e.g., using its administrative interface).</p>
<p id="rfc.section.8.8.1.p.6">It is RECOMMENDED that PCP servers embedded into service provider NAT and firewall devices be configured to permit third party mapings. With this confguration, if a user wants to create a third party mapping, the user needs to interact out-of-band with their customer premise router (e.g., using its administrative interface).  This is because the service provider's PCP server only allows third party mappings from the subscriber's customer premise router. To do this, the PCP server needs certain knowledge about the network's subscribers. It needs to determine the IP address of the subscriber's customer premise router and to determine the IP subnet assigned to the subscriber. This knowledge might be dynamic (e.g., database query into the service provider's user database for every incoming PCP request), might be a table (e.g., subscribers with a certain IPv4 network prefix all have an IPv4 /24, other IPv4 prefixes have an IPv4 /32, certain IPv6 prefixes have an have an IPv6 /32, and so on), or might be very static (e.g., all subscribers have one IPv4 address). In many common deployments, there is only one IPv4 address assigned to a subscriber, and thus the Target Address will always match the source address of the PCP message. If there are multiple IPv4 or multiple IPv6 addresses assigned to a subscriber, the PCP server allows the highest-numbered address to perform third party mappings. Thus, on a network supporting PCP with multiple addresses assigned to a subscriber, the highest-numbered host SHOULD be the subscriber's customer premise router. Upon receiving a MAP request where the Target Address does not match the source IP address of the request, the PCP server determines if the source IP address of the request is the subscriber's highest numbered address, following the procedure above. If not, the PCP server MUST generate an UNAUTH_SOURCE_ADDRESS error. Then the PCP server determines if the Target Address belongs to the same subscriber as the source IP address of the PCP packet, using the procedure described above. If not, the PCP server MUST generate an UNAUTH_TARGET_ADDRESS error.</p>
<h1 id="rfc.section.8.8.2">
<a href="#rfc.section.8.8.2">8.8.2.</a> <a href="#remote_peer_filter" id="remote_peer_filter">REMOTE_PEER_FILTER</a>
</h1>
<p id="rfc.section.8.8.2.p.1">This Option indicates packet filtering is desired. The remote peer port and remote peer IP Address indicate the permitted remote peer's source IP address and port for packets from the Internet. The remote peer prefix length indicates the length of the remote peer's IP address that is significant; this allows a single Option to permit an entire subnet. After processing this MAP request and generating a successful response, the PCP-controlled device will simply drop packets with a source IP address, transport, or port that do not match the fields.</p>
<div id="#rfc.figure.12"></div>
<div id="#fig_remote_peer_filter"></div>
<p>The REMOTE_PEER_FILTER packet layout is described below:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Reserved   | prefix-length |      Remote Peer Port         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:     Remote Peer IP address (32 bits if MAP4,                  :
:              1 28 bits if MAP6)                               :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.8.8.2.p.2">These fields are described below:</p>

<dl>
<dt>Reserved:</dt>
<dd style="margin-left: 8">8 reserved bits, MUST be sent as 0 and MUST be ignored when received.</dd>
<dt>prefix-length:</dt>
<dd style="margin-left: 8">indicates how many bits of the IPv4 or IPv6 address are relevant for this filter. The value 0 indicates "no filter", and will remove all previous filters. See below for detail.</dd>
<dt>Remote Peer Port:</dt>
<dd style="margin-left: 8">the port number of the remote peer. The value 0 indicates "all ports"</dd>
<dt>Remote Peer IP address:</dt>
<dd style="margin-left: 8">The IP address of the remote peer.</dd>
</dl>
<p id="rfc.section.8.8.2.p.3">This Option:</p>

<ul class="empty">
<li>name: REMOTE_PEER_FILTER</li>
<li>number: 128</li>
<li>is valid for OpCodes: MAP4, MAP6</li>
<li>is included in responses: MUST, if it appeared in the request</li>
<li>length: 2 if used with MAP4, 5 if used with MAP6</li>
<li>may appear in: requests</li>
<li>maximum occurrences: as many as fit within maximum PCP message size</li>
</ul>
<p id="rfc.section.8.8.2.p.4">Because of interactions with dynamic ports this Option MUST only be used by a client that is operating a server (that is, using the MAP OpCode), as this ensures that no other application will be assigned the same ephemeral port for its outgoing connection. Other use by a PCP client is NOT RECOMMENDED and will cause some UNSAF NAT traversal mechanisms <a href="#RFC3424">[RFC3424]</a> to fail where they would have otherwise succeeded, breaking other applications running on this same host.</p>
<p id="rfc.section.8.8.2.p.5">The prefix-length indicates how many bits of the IPv6 address or IPv4 address are used for the filter. For MAP4, a prefix-length of 32 indicates the entire IPv4 address is used. For MAP6, a prefix-length of 128 indicates the entire IPv6 address is used. For MAP4 the minimum prefix-length value is 0 and the maximum value is 32. For MAP6 the minimum prefix-length value is 0 and the maximum value is 128. Values outside those range cause an MALFORMED_OPTION response code.</p>
<p id="rfc.section.8.8.2.p.6">If multiple occurrences of REMOTE_PEER_FILTER exist in the same MAP request, they are processed in the same order received, and they MUST all be successfully processed or return an error (e.g., MALFORMED_OPTION if one of the options was malformed). As with other PCP errors, returning an error causes no state to be changed in the PCP server or in the PCP-controlled device. If an existing mapping exists (with or without a filter) and the server receives a MAP request with REMOTE_PEER_FILTER, the filters indicated in the new request are added to any existing filters. If a MAP request has a lifetime of 0 and contains the REMOTE_PEER_FILTER option, the error MALFORMED_OPTION is returned.</p>
<p id="rfc.section.8.8.2.p.7">To remove all existing filters, the prefix-length 0 is used.  There is no mechanism to remove a specific filter.</p>
<p id="rfc.section.8.8.2.p.8">To change an existing filter, the PCP client sends a MAP request containing two REMOTE_PEER_FILTER options, the first option containing a prefix-length of 0 (to delete all existing filters) and the second containing the new remote peer's IP address and port.  Other REMOTE_PEER_FILTER options in that PCP request, if any, add more allowed remote hosts.</p>
<p id="rfc.section.8.8.2.p.9">The PCP server or the PCP-controlled device is expected to have a limit on the number of remote peers it can support. This limit might be as small as one. If a MAP request would exceed this limit, the entire MAP request is rejected with the result code EXCESSIVE_REMOTE_PEERS, and the state on the PCP server is unchanged.</p>
<p id="rfc.section.8.8.2.p.10">If this option appears in a request, the following addition result code could be returned:</p>

<dl>
<dt>27</dt>
<dd style="margin-left: 8">EXCESSIVE_REMOTE_PEERS, indicates the PCP server was not able to create the filters in this request. This result code MUST only be returned if the MAP request contained the REMOTE_PEER_FILTER Option. This is a long lifetime error.</dd>
</dl>
<h1 id="rfc.section.8.8.3">
<a href="#rfc.section.8.8.3">8.8.3.</a> PREFER_FAILURE</h1>
<p id="rfc.section.8.8.3.p.1">This option indicates that if the PCP server is unable to allocate the requested port, then instead of returning an available port that it *can* allocate, the PCP server should instead allocate no port and return result code CANNOT_HONOR_EXTERNAL_PORT.</p>
<p id="rfc.section.8.8.3.p.2">This option is intended solely for use by <a href="#I-D.bpw-pcp-upnp-igd-interworking">UPnP IGD interworking</a> <cite title="NONE">[I-D.bpw-pcp-upnp-igd-interworking]</cite>, where the semantics of IGD version 1 do not provide any way to indicate to an IGD client that any port is available other than the one it requested. A PCP server MAY support this option, if its designers wish to support downstream devices that perform IGD interworking. PCP servers MAY choose to rate-limit their handling of PREFER_FAILURE requests, to protect themselves from a rapid flurry of 65535 consecutive PREFER_FAILURE requests from clients probing to discover which external ports are available.  PCP servers that are not intended to support downstream devices that perform IGD interworking are not required to support this option.  PCP clients other than IGD interworking clients SHOULD NOT use this option because it results in inefficient operation, and they cannot safely assume that all PCP servers will implement it. The option is provided only because the semantics of IGD version 1 offer no viable alternative way to implement an IGD interworking function. It is anticipated that this option will be deprecated in the future as more clients adopt PCP natively and the need for IGD interworking declines.</p>
<p></p>

<ul class="empty"><li>This Option:<ul class="empty">
<li>name: PREFER_FAILURE</li>
<li>number: 130</li>
<li>is valid for OpCodes: MAP4, MAP6</li>
<li>is included in responses: MUST</li>
<li>length: 0</li>
<li>may appear in: requests</li>
<li>maximum occurrences: no</li>
</ul>
</li></ul>
<h1 id="rfc.section.8.9">
<a href="#rfc.section.8.9">8.9.</a> PCP Mapping State Maintenance</h1>
<p id="rfc.section.8.9.p.1">If an event occurs that causes the PCP server to lose state (such as a crash or power outage), the mappings created by PCP are lost.  Such loss of state is rare in a service provider environment (due to redundant power, disk drives for storage, etc.). But such loss of state is more common in a residential NAT device which does not write information to its non-volatile memory.</p>
<p id="rfc.section.8.9.p.2">The Epoch allows a client to deduce when a PCP server may have lost its state. If this occurs, the PCP client can attempt to recreate the mappings following the procedures described in this section.</p>
<h1 id="rfc.section.8.9.1">
<a href="#rfc.section.8.9.1">8.9.1.</a> <a href="#reboot" id="reboot">Recreating Mappings</a>
</h1>
<p id="rfc.section.8.9.1.p.1">The PCP server SHOULD store mappings in persistent storage so when it is powered off or rebooted, it remembers the port mapping state of the network. Due to the physical architecture of some PCP servers, this is not always achievable (e.g., some non-volatile memory can withstand only a certain number of writes, so writing PCP mappings to such memory is generally avoided).</p>
<p id="rfc.section.8.9.1.p.2">However, maintaining this state is not essential for correct operation. When the PCP server loses state and begins processing new PCP messages, its Epoch is reset to zero (per the procedure of <a href="#epoch">Section 6.5</a>).</p>
<p id="rfc.section.8.9.1.p.3">A mapping renewal packet is formatted identically to an original mapping request; from the point of view of the client it is a renewal of an existing mapping, but from the point of view of the PCP server it appears as a new mapping request.</p>
<p id="rfc.section.8.9.1.p.4">As the result of receiving a packet where the Epoch field indicates that a reboot or similar loss of state has occurred, the client renews its port mappings.</p>
<p id="rfc.section.8.9.1.p.5">The discussion in this section focuses on recreating inbound port mappings after loss of PCP server state, because that is the more serious problem. Losing port mappings for outgoing connections destroys those currently active connections, but does not prevent clients from establishing new outgoing connections. In contrast, losing inbound port mappings not only destroys all existing inbound connections, but also prevents the reception of any new inbound connections until the port mapping is recreated. Accordingly, we consider recovery of inbound port mappings the more important priority. However, clients that want outgoing connections to survive a NAT gateway reboot can also achieve that using PCP. After initiating an outbound TCP connection (which will cause the NAT gateway to establish an implicit port mapping) the client should send the NAT gateway a port mapping request for the source port of its TCP connection, which will cause the NAT gateway to send a response giving the external port it allocated for that mapping. The client can then store this information, and use it later to recreate the mapping if it determines that the NAT gateway has lost its mapping state.</p>
<h1 id="rfc.section.8.9.2">
<a href="#rfc.section.8.9.2">8.9.2.</a> Maintaining Mappings</h1>
<p id="rfc.section.8.9.2.p.1">A PCP client can refresh a mapping by sending a new PCP request containing information from the earlier PCP response. The PCP server will respond indicating the new lifetime. It is possible, due to failure of the PCP server, that the public IP address and/or public port, or the PCP server itself, has changed (due to a new route to a different PCP server). To detect such events more quickly, the PCP client may find it beneficial to use shorter lifetimes (so that it communicates with the PCP server more often). If the PCP client has several mappings, the Epoch value only needs to be retrieved for one of them to verify the PCP server has not lost port forwarding state.</p>
<p id="rfc.section.8.9.2.p.2">If the client wishes to check the PCP server's Epoch, it sends a PCP request for any one of the client's mappings. This will return the current Epoch value. In that request the PCP client could extend the mapping lifetime (by asking for more time) or maintain the current lifetime (by asking for the same number of seconds that it knows are remaining of the lifetime).</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#peer_opcodes" id="peer_opcodes">PEER OpCodes</a>
</h1>
<p id="rfc.section.9.p.1">This section defines two OpCodes for controlling dynamic connections.  They are:</p>

<dl>
<dt>  PEER4=2:</dt>
<dd style="margin-left: 12">Set or query lifetime for flow from IPv4 address to a remote peer's IPv4 address.</dd>
<dt>  PEER6=3:</dt>
<dd style="margin-left: 12">Set or query lifetime for flow from IPv6 address to a remote peer's IPv6 address.</dd>
</dl>

<p> The operation of these OpCodes is described in this section.</p>
<h1 id="rfc.section.9.1">
<a href="#rfc.section.9.1">9.1.</a> OpCode Packet Formats</h1>
<p id="rfc.section.9.1.p.1">The two PEER OpCodes (PEER4 and PEER6) share a similar packet layout for both requests and responses. Because of this similarity, they are shown together. For both of the PEER OpCodes, if the internal IP address and internal port fields of the request both match the external IP address and external port fields of the response, the IP addresses and ports are not changed and thus the functionality is purely a firewall; otherwise it pertains to a network address translator which might also perform firewall functions.</p>
<div id="#rfc.figure.13"></div>
<div id="#peer_request"></div>
<p>The following diagram shows the request packet format for PEER4 and PEER6. This packet format is aligned with the response packet format:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Protocol     |        Reserved (24 bits)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:  Internal IP address (32 bits if PEER4, 128 bits if PEER6)    :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:  Remote Peer IP address (32 bits if PEER4, 128 bits if PEER6) :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:                 Reserved (128 bits)                           :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Requested lifetime                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        internal port          |     reserved (16 bits)        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       remote peer port        |     reserved (16 bits)        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p id="rfc.section.9.1.p.2">These fields are described below:</p>

<dl>
<dt>Protocol:</dt>
<dd style="margin-left: 8">indicates protocol associated with this OpCode. Values are taken from the <a href="#proto_numbers">IANA protocol registry</a> <cite title="NONE">[proto_numbers]</cite>. For example, this field contains 6 (TCP) if the OpCode is describing a TCP peer.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">24 reserved bits, MUST be 0 on transmission and MUST be ignored on reception.</dd>
<dt>Mapping Internal IP Address:</dt>
<dd style="margin-left: 8">Internal IP address of the 5-tuple. This can be 32 bits long (if OpCode is PEER4) or 128 bits long (if OpCode is PEER6).</dd>
<dt>Remote Peer IP Address:</dt>
<dd style="margin-left: 8">Remote peer's IP address, from the perspective of the PCP client.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">128 reserved bits, MUST be 0 on transmission and MUST be ignored on reception.</dd>
<dt>Requested lifetime:</dt>
<dd style="margin-left: 8">Requested lifetime of this mapping, in seconds. Unlike the MAP OpCode, there is no special meaning of 0.</dd>
<dt>internal port:</dt>
<dd style="margin-left: 8">Internal port for the of the 5-tuple.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">16 reserved bits, MUST be 0 on transmission and MUST be ignored on reception.</dd>
<dt>Remote Peer Port:</dt>
<dd style="margin-left: 8">Remote peer's port of the 5-tuple.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">16 reserved bits, MUST be 0 on transmission and MUST be ignored on reception.</dd>
</dl>
<div id="#rfc.figure.14"></div>
<div id="#peer_response"></div>
<p>The following diagram shows the response packet format for PEER4 and PEER6:</p>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Protocol     |  External_AF  |       Reserved (16 bits)      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:  Internal IP address (32 bits if PEER4, 128 bits if PEER6)    :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:  Remote Peer IP address (32 bits if PEER4, 128 bits if PEER6) :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:                                                               :
:   External IP address (always 128 bits)                       :
:                                                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               Assigned Lifetime                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        internal port          |     external port             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       remote peer port        |     reserved (16 bits)        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p></p>

<dl>
<dt>Protocol:</dt>
<dd style="margin-left: 8">Copied from the request.</dd>
<dt>External_AF</dt>
<dd style="margin-left: 8">For success responses, this contains the address family of the external IP address associated with this peer connection. Values are from IANA's address family numbers (IPv4 is 1, IPv6 is 2). For error responses, the value MUST be 0.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">16 reserved bits, MUST be 0 on transmission, MUST be ignored on reception.</dd>
<dt>Internal IP address</dt>
<dd style="margin-left: 8">Copied from the request.</dd>
<dt>remote Peer IP address</dt>
<dd style="margin-left: 8">Copied from the request.</dd>
<dt>External IP Address</dt>
<dd style="margin-left: 8">For success responses, this contains the external IP address, assigned by the NAT (or firewall) to this mapping. If firewall, this will match the internal IP address. This field is always 128 bits long. If External_AF indicates IPv4, the IPv4 address is encoded in the first 32 bits of the External IP Address field and the remaining 96 bits are zero. For error responses, this MUST be 0.</dd>
<dt>Assigned Lifetime:</dt>
<dd style="margin-left: 8">For success responses, this is the assigned lifetime, in seconds. For error responses, this is 0.s</dd>
<dt>internal port:</dt>
<dd style="margin-left: 8">copied from request.</dd>
<dt>external port:</dt>
<dd style="margin-left: 8">For success responses, this is the external port number, assigned by the NAT (or firewall) to this mapping. If firewall or 1:1 NAT, this will match the internal port. For error responses, this MUST be 0.</dd>
<dt>remote peer port:</dt>
<dd style="margin-left: 8">Copied from request.</dd>
<dt>Reserved:</dt>
<dd style="margin-left: 8">16 reserved bits, MUST be 0 on transmission, MUST be ignored on reception.</dd>
</dl>
<h1 id="rfc.section.9.2">
<a href="#rfc.section.9.2">9.2.</a> <a href="#peer_result_codes" id="peer_result_codes">OpCode-Specific Result Codes</a>
</h1>
<p id="rfc.section.9.2.p.1">In addition to the general PCP result codes (<a href="#result_codes">Section 5.4</a>) the following additional result codes may be returned as a result of the two PEER OpCodes received by the PCP server.</p>

<dl>
<dt>50</dt>
<dd style="margin-left: 8">NONEXIST_PEER, the connection to that peer does not exist in the mapping table</dd>
</dl>
<p id="rfc.section.9.2.p.2">Other result codes are defined following the procedure in <a href="#iana_result_codes">Section 13.3</a>.</p>
<h1 id="rfc.section.9.3">
<a href="#rfc.section.9.3">9.3.</a> <a href="#peer_opcode_client_operation" id="peer_opcode_client_operation">OpCode-Specific Client: Generating a Request</a>
</h1>
<p id="rfc.section.9.3.p.1">This section describes the operation of a client when generating the OpCodes PEER4 or PEER6.</p>
<p id="rfc.section.9.3.p.2">The PEER4 or PEER6 OpCodes MUST NOT be sent until establishing bi-directional communicaion with the remote peer; for TCP, this means completing the TCP 3-way handshake.</p>
<h1 id="rfc.section.9.4">
<a href="#rfc.section.9.4">9.4.</a> <a href="#peer-opcode_server_operation" id="peer-opcode_server_operation">OpCode-Specific Server: Processing a Request</a>
</h1>
<p id="rfc.section.9.4.p.1">This section describes the operation of a server when receiving a request with the OpCodes PEER4 or PEER6.</p>
<p id="rfc.section.9.4.p.2">The PEER OpCodes provide a single function: the ability for the PCP client to query and (possibly) extend the lifetime of an existing mapping.</p>
<p id="rfc.section.9.4.p.3">On receiving the PEER4 or PEER6 OpCode, the PCP server examines the mapping table. If a mapping does not exist, the NONEXIST_PEER error is returned.</p>
<p id="rfc.section.9.4.p.4">If the PCP-controlled device can have its lifetime adjusted, the PCP server uses the smaller of its configured maximum lifetime value and the requested lifetime from the PEER request, and sets the lifetime to that value.</p>
<p id="rfc.section.9.4.p.5">Note:  The PEER4 or PEER6 OpCodes can never reduce the lifetime of an existing mapping, nor can those OpCodes delete a mapping. If the mapping is terminated by the TCP client or server (e.g., TCP FIN or TCP RST), the mapping will eventually be destroyed normally; the earlier use of PEER does not extend the lifetime in that case.</p>
<p id="rfc.section.9.4.p.6">If all of the proceeding operations were successful (did not generate an error response), then a SUCCESS response is generated, with the assigned-lifetime containing the lifetime of the mapping.</p>
<h1 id="rfc.section.9.5">
<a href="#rfc.section.9.5">9.5.</a> OpCode-Specific Client: Processing a Response</h1>
<p id="rfc.section.9.5.p.1">This section describes the operation of a client when processing a response with the OpCodes PEER4 or PEER6.</p>
<p id="rfc.section.9.5.p.2">A response is matched with a request by comparing the protocol, external AF, internal IP address, internal port, remote peer address and remote peer port. Other fields are not compared, because the PCP server changes those fields to provide information about the mapping created by the OpCode.</p>
<p id="rfc.section.9.5.p.3">If a successful response, the PCP client uses the assigned lifetime value to reduce its frequency of application keepalives for that particular NAT mapping.  Of course, there may be other reasons, specific to the application, to use more frequent application keepalives. For example, the PCP assigned-lifetime could be one hour but the application may want to ensure the server is still accessible (e.g., has not crashed) more frequently than once an hour.</p>
<p id="rfc.section.9.5.p.4">If the error response NONEXIST_PEER, this could have occurred if the PCP client sent its PEER request before the PCP-controlled device had installed the mapping, or because the mapping has been destroyed (e.g., due to a TCP FIN).  If the PCP client believes the mapping should exist, the PCP client SHOULD retry the request after a brief delay (e.g., 5 seconds).</p>
<p id="rfc.section.9.5.p.5">Other error responses SHOULD NOT be retried.</p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> Deployment Considerations</h1>
<h1 id="rfc.section.10.1">
<a href="#rfc.section.10.1">10.1.</a> Maintaining Same External IP Address</h1>
<p id="rfc.section.10.1.p.1">It is REQUIRED that the PCP-controlled device assign the same external IP address PCP-created explicit dynamic mappings and to implicit dynamic mappings. It is RECOMMENDED that static mappings (e.g., those created by a command language interface on the PCP server or PCP-controlled device) also be assigned to the same IP address.</p>
<p id="rfc.section.10.1.p.2">Once all internal hosts belonging to a given subscriber have no implicit dynamic mappings and have no explicit dynamic mappings in the PCP-controlled device, a subsequent PCP request for that internal host MAY be assigned to a different external IP address. Generally, this re-assignment would occur when a CGN device is load balancing newly-seen hosts to its public IPv4 address pool. </p>
<h1 id="rfc.section.10.2">
<a href="#rfc.section.10.2">10.2.</a> Ingress Filtering</h1>
<p id="rfc.section.10.2.p.1">To prevent spoofing of PCP requests, <a href="#RFC2827">ingress filtering</a> <cite title="NONE">[RFC2827]</cite> MUST be performed by devices between the PCP clients and PCP server. For example, with a PCP server integrated into a customer premise router, the ethernet switch needs to perform ingress filtering. As another example, with a PCP server deployed by a service provider, the service provider's aggregation router (the first device connecting to subscribers) needs to do ingress filtering. </p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> <a href="#scenarios" id="scenarios">Deployment Scenarios</a>
</h1>
<h1 id="rfc.section.11.1">
<a href="#rfc.section.11.1">11.1.</a> Dual Stack-Lite</h1>
<p id="rfc.section.11.1.p.1">The interesting components in a Dual-Stack Lite deployment are the B4 element (which is the customer premises router) and the AFTR element (which is the device that both terminates the IPv6-over-IPv4 tunnel and also implements the Carrier-Grade NAT44 function). The B4 element does not need to perform a NAT function (and usually does not perform a NAT function), but it does operate its own DHCP server and is the local network's default router.</p>
<h1 id="rfc.section.11.1.1">
<a href="#rfc.section.11.1.1">11.1.1.</a> Overview</h1>
<p id="rfc.section.11.1.1.p.1">Various PCP deployment scenarios can be considered to control the PCP server embedded in the AFTR element:</p>

<ol>
<li>UPnP IGD and NAT-PMP <a href="#I-D.cheshire-nat-pmp">[I-D.cheshire-nat-pmp]</a> are used in the LAN: an interworking function is required to be embedded in the B4 element to ensure interworking between the protocol used in the LAN and PCP. UPnP IGD-PCP Interworking Function is described in <a href="#I-D.bpw-pcp-upnp-igd-interworking">[I-D.bpw-pcp-upnp-igd-interworking]</a>.</li>
<li>Hosts behind the B4 element will either include a PCP client or UPnP IGD client, or both.<ol style="list-style-type: lower-alpha">
<li>if a UPnP IGD client, the B4 element will need to include an interworking function from UPnP IGD to PCP.</li>
<li>if a PCP client, the PCP client will communicate directly with the PCP server.</li>
</ol>
</li>
<li>The B4 element includes a PCP client which is invoked by an HTTP-based configuration (as is common today). The internal IP address field in the PCP payload would be the internal host used in the port forwarding configuration.</li>
</ol>
<p id="rfc.section.11.1.1.p.2">Two modes are identified to forward PCP packets to a PCP server controlling the provisioned AFTR as described in the following sub-sections.</p>
<p></p>

<ul class="empty"><li>[Ed.&#160;Note: We need to decide on Encapsulation Mode or Plain IPv6 Mode. This is tracked as PCP Issue #13 <a href="#PCP-Issues">[PCP-Issues]</a>.]</li></ul>
<h1 id="rfc.section.11.1.2">
<a href="#rfc.section.11.1.2">11.1.2.</a> <a href="#dslite_encap" id="dslite_encap">Encapsulation Mode</a>
</h1>
<p id="rfc.section.11.1.2.p.1">In this mode, B4 element does no processing at all of the PCP messages, and forwards them as any other UDP traffic. With DS-Lite, this means that IPv4 PCP messages issued by internal PCP clients are encapsulated into the IPv6 tunnel sent to the AFTR as for any other IPv4 packets. The IPv6 address used as source address MUST be the same as the one used by the B4 element. The AFTR decapsulates the IPv4 packets and processes the PCP requests (because the destination IPv4 address points to the PCP server embedded in the AFTR).</p>
<h1 id="rfc.section.11.1.3">
<a href="#rfc.section.11.1.3">11.1.3.</a> <a href="#dslite_plain" id="dslite_plain">Plain IPv6 Mode</a>
</h1>
<p id="rfc.section.11.1.3.p.1">Another alternative for deployment of PCP in a DS-Lite context is to rely on a PCP Proxy in the B4 element. Protocol exchanges between the PCP Proxy and the PCP server are conveyed using plain IPv6 (no tunnelling is used). Nevertheless, the IPv6 address used as source address by the PCP Proxy MUST be the same as the one used by the B4 element.</p>
<h1 id="rfc.section.11.2">
<a href="#rfc.section.11.2">11.2.</a> NAT64</h1>
<p id="rfc.section.11.2.p.1">Hosts behind a NAT64 device can make use of PCP in order to perform port reservation (to get a publicly routable IPv4 port).</p>
<h1 id="rfc.section.11.3">
<a href="#rfc.section.11.3">11.3.</a> NAT44 and NAT444</h1>
<p id="rfc.section.11.3.p.1">Residential subscribers in NAT44 (and NAT444) deployments are usually given one IPv4 address, but may also be given several IPv4 addresses. These addresses are not routable on the IPv4 Internet, but are routable between the subscriber's home and the ISP's CGN. To accommodate multiple hosts within a home, especially when provided insufficient IPv4 addresses for the number of devices in the home, subscribers operate a NAPT device. When this occurs in conjunction with an upstream NAT44, this is nicknamed "NAT444".</p>
<h1 id="rfc.section.11.4">
<a href="#rfc.section.11.4">11.4.</a> IPv6 Simple Firewall</h1>
<p id="rfc.section.11.4.p.1">Many IPv6 deployments will include a <a href="#RFC6092">simple firewall</a> <cite title="NONE">[RFC6092]</cite>, which permits outgoing packets to initiate bi-directional communication but blocks unsolicited incoming packets, which is similar to PCP's security model that allows a host to create a mapping to itself. In many situations, especially residential networks that lack an IT staff, the security provided by an IPv6 simple firewall and the security provided by PCP are compatible. In such situations, the IPv6 simple firewall and the IPv6 host can use PCP's OpCode PIN6 to allow unsolicited incoming packets, so the host can operate a server.</p>
<h1 id="rfc.section.12">
<a href="#rfc.section.12">12.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.12.p.1">The PCP client's source port SHOULD be randomly generated <a href="#RFC6056">[RFC6056]</a>. The PCP server MUST only listen for requests from its internal interfaces, and MUST NOT listen for requests on its Internet-facing interfaces.</p>
<p id="rfc.section.12.p.2">This document defines Port Control Protocol and two types of OpCodes, PEER and MAP. The PEER OpCode allows querying and extending (if permitted) the lifetime of an existing implicit dynamic mapping, so a host can reduce its keepalive messages. The MAP OpCode allows creating a mapping so a host can receive incoming unsolicited connections from the Internet in order to run a server.</p>
<p id="rfc.section.12.p.3">The PEER OpCode does not introduce any new security considerations.</p>
<p id="rfc.section.12.p.4">On today's Internet, ISPs do not typically filter incoming traffic for their subscribers. However, when an ISP introduces stateful address sharing with a NAPT device, such filtering will occur as a side effect.  Filtering will also occur with IPv6 CPE <a href="#I-D.ietf-v6ops-cpe-simple-security">[I-D.ietf-v6ops-cpe-simple-security]</a>. The MAP OpCode allows a PCP client to create a mapping so that a host can receive inbound traffic and operate a server. Security considerations for the MAP OpCode are described in the following sections.</p>
<h1 id="rfc.section.12.1">
<a href="#rfc.section.12.1">12.1.</a> Denial of Service</h1>
<p id="rfc.section.12.1.p.1">Because the state created in a NAPT or firewall, a per-subscriber quota will likely exist for both implicit dynamic mappings (e.g., outgoing TCP connections) and explicit dynamic mappings (PCP). A subscriber might make an excessive number of implicit or explicit dynamic mappings, consuming an inordinate number of ports, causing a denial of service to other subscribers. Thus, section XXX recommends that subscribers be limited to a reasonable number of explicit dynamic mappings.</p>
<h1 id="rfc.section.12.2">
<a href="#rfc.section.12.2">12.2.</a> Ingress Filtering</h1>
<p id="rfc.section.12.2.p.1">It is important to prevent a subscriber from creating a mapping for another subscriber, because this allows incoming packets from the Internet and consumes the other user's mapping quota. Both implicit dynamic mappings (e.g., outgoing TCP connections) and explicit dynamic mappings (PCP) need ingress filtering. Thus, PCP does not create a new requirement for ingress filtering.</p>
<h1 id="rfc.section.12.3">
<a href="#rfc.section.12.3">12.3.</a> <a href="#subscriber_identification" id="subscriber_identification">Validating Target Address</a>
</h1>
<p id="rfc.section.12.3.p.1">The MAP OpCode / THIRD_PARTY contains a Target Address field, which allows a PCP client to create an explicit dynamic mapping for another host. Hosts within a subscriber's network cannot create, modify, or delete mappings of other hosts, except by using the administrative interface of the customer premise router <a href="#third_party">Section 8.8.1</a>.</p>
<h1 id="rfc.section.13">
<a href="#rfc.section.13">13.</a> <a href="#iana" id="iana">IANA Considerations</a>
</h1>
<p id="rfc.section.13.p.1">IANA is requested to perform the following actions:</p>
<h1 id="rfc.section.13.1">
<a href="#rfc.section.13.1">13.1.</a> <a href="#iana_port" id="iana_port">Port Number</a>
</h1>
<p id="rfc.section.13.1.p.1">IANA has assigned UDP port 44323 for PCP.</p>
<h1 id="rfc.section.13.2">
<a href="#rfc.section.13.2">13.2.</a> <a href="#iana_opcodes" id="iana_opcodes">OpCodes</a>
</h1>
<p id="rfc.section.13.2.p.1">IANA shall create a new protocol registry for PCP OpCodes, initially populated with the values in <a href="#pin_opcodes">Section 8</a> and <a href="#peer_opcodes">Section 9</a>.</p>
<p id="rfc.section.13.2.p.2">New OpCodes in the range 1-95 can be created via <a href="#RFC5226">Standards Action</a> <cite title="NONE">[RFC5226]</cite>, and the range 96-128 is for <a href="#RFC5226">Private Use</a> <cite title="NONE">[RFC5226]</cite>.</p>
<h1 id="rfc.section.13.3">
<a href="#rfc.section.13.3">13.3.</a> <a href="#iana_result_codes" id="iana_result_codes">Result Codes</a>
</h1>
<p id="rfc.section.13.3.p.1">IANA shall create a new registry for PCP result codes, numbered 0-255, initially populated with the result codes from <a href="#result_codes">Section 5.4</a>, <a href="#map_result_codes">Section 8.2</a>, <a href="#remote_peer_filter">Section 8.8.2</a>, and <a href="#peer_result_codes">Section 9.2</a>.</p>
<p id="rfc.section.13.3.p.2">Additional Result Codes can be defined via <a href="#RFC5226">Specification Required</a> <cite title="NONE">[RFC5226]</cite>.</p>
<h1 id="rfc.section.13.4">
<a href="#rfc.section.13.4">13.4.</a> <a href="#iana_ie" id="iana_ie">Options</a>
</h1>
<p id="rfc.section.13.4.p.1">IANA shall create a new registry for PCP Options, numbered 0-255 with an associated mnemonic. The values 0-127 are optional-to-process, and 128-255 are mandatory-to-process. The initial registry contains the options described in <a href="#pin_options">Section 8.8</a>, and the option values 0 and 255 are reserved.</p>
<p id="rfc.section.13.4.p.2">New PCP option codes in the range 0-63 and 128-192 can be created via <a href="#RFC5226">Standards Action</a> <cite title="NONE">[RFC5226]</cite>, and the range 64-127 and 192-255 is for <a href="#RFC5226">Private Use</a> <cite title="NONE">[RFC5226]</cite>.</p>
<h1 id="rfc.section.14">
<a href="#rfc.section.14">14.</a> Acknowledgments</h1>
<p id="rfc.section.14.p.1">Thanks to Alain Durand, Christian Jacquenet, and Simon Perreault for their comments and review. Thanks to Simon Perreault for highlighting the interaction of dynamic connections with PCP-created mappings.</p>
<h1 id="rfc.references">
<a href="#rfc.references">15.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">15.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5226">[RFC5226]</b></td>
<td class="top">
<a>Narten, T.</a> and <a>H. Alvestrand</a>, "<a href="http://tools.ietf.org/html/rfc5226">Guidelines for Writing an IANA Considerations Section in RFCs</a>", BCP 26, RFC 5226, May 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2827">[RFC2827]</b></td>
<td class="top">
<a>Ferguson, P.</a> and <a>D. Senie</a>, "<a href="http://tools.ietf.org/html/rfc2827">Network Ingress Filtering: Defeating Denial of Service Attacks which employ IP Source Address Spoofing</a>", BCP 38, RFC 2827, May 2000.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-softwire-dual-stack-lite">[I-D.ietf-softwire-dual-stack-lite]</b></td>
<td class="top">
<a>Durand, A</a>, <a>Droms, R</a>, <a>Woodyatt, J</a> and <a>Y Lee</a>, "<a href="http://tools.ietf.org/html/draft-ietf-softwire-dual-stack-lite-11">Dual-Stack Lite Broadband Deployments Following IPv4 Exhaustion</a>", Internet-Draft draft-ietf-softwire-dual-stack-lite-11, May 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-behave-v6v4-xlate">[I-D.ietf-behave-v6v4-xlate]</b></td>
<td class="top">
<a>Li, X</a>, <a>Bao, C</a> and <a>F Baker</a>, "<a href="http://tools.ietf.org/html/draft-ietf-behave-v6v4-xlate-23">IP/ICMP Translation Algorithm</a>", Internet-Draft draft-ietf-behave-v6v4-xlate-23, September 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-behave-v6v4-xlate-stateful">[I-D.ietf-behave-v6v4-xlate-stateful]</b></td>
<td class="top">
<a>Bagnulo, M</a>, <a>Matthews, P</a> and <a>I Beijnum</a>, "<a href="http://tools.ietf.org/html/draft-ietf-behave-v6v4-xlate-stateful-12">Stateful NAT64: Network Address and Protocol Translation from IPv6 Clients to IPv4 Servers</a>", Internet-Draft draft-ietf-behave-v6v4-xlate-stateful-12, July 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4193">[RFC4193]</b></td>
<td class="top">
<a>Hinden, R.</a> and <a>B. Haberman</a>, "<a href="http://tools.ietf.org/html/rfc4193">Unique Local IPv6 Unicast Addresses</a>", RFC 4193, October 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6056">[RFC6056]</b></td>
<td class="top">
<a>Larsen, M.</a> and <a>F. Gont</a>, "<a href="http://tools.ietf.org/html/rfc6056">Recommendations for Transport-Protocol Port Randomization</a>", BCP 156, RFC 6056, January 2011.</td>
</tr>
<tr>
<td class="reference"><b id="proto_numbers">[proto_numbers]</b></td>
<td class="top">
<a>IANA, </a>, "<a>Protocol Numbers</a>", 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">15.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC0793">[RFC0793]</b></td>
<td class="top">
<a title="University of Southern California (USC)/Information Sciences Institute">Postel, J.</a>, "<a href="http://tools.ietf.org/html/rfc793">Transmission Control Protocol</a>", STD 7, RFC 793, September 1981.</td>
</tr>
<tr>
<td class="reference"><b id="RFC1918">[RFC1918]</b></td>
<td class="top">
<a href="mailto:yakov@cisco.com" title="Cisco systems">Rekhter, Y.</a>, <a href="mailto:rgm3@is.chrysler.com" title="Chrysler Corporation">Moskowitz, R.</a>, <a href="mailto:Daniel.Karrenberg@ripe.net" title="RIPE Network Coordination Centre">Karrenberg, D.</a>, <a href="mailto:GeertJan.deGroot@ripe.net" title="RIPE Network Coordination Centre">Groot, G.</a> and <a href="mailto:lear@sgi.com" title="Silicon Graphics, Inc.">E. Lear</a>, "<a href="http://tools.ietf.org/html/rfc1918">Address Allocation for Private Internets</a>", BCP 5, RFC 1918, February 1996.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2474">[RFC2474]</b></td>
<td class="top">
<a href="mailto:kmn@cisco.com" title="Cisco Systems">Nichols, K.</a>, <a href="mailto:slblake@torrentnet.com" title="Torrent Networking Technologies">Blake, S.</a>, <a href="mailto:fred@cisco.com" title="Cisco Systems">Baker, F.</a> and <a href="mailto:black_david@emc.com" title="EMC Corporation">D.L. Black</a>, "<a href="http://tools.ietf.org/html/rfc2474">Definition of the Differentiated Services Field (DS Field) in the IPv4 and IPv6 Headers</a>", RFC 2474, December 1998.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4961">[RFC4961]</b></td>
<td class="top">
<a>Wing, D.</a>, "<a href="http://tools.ietf.org/html/rfc4961">Symmetric RTP / RTP Control Protocol (RTCP)</a>", BCP 131, RFC 4961, July 2007.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3581">[RFC3581]</b></td>
<td class="top">
<a>Rosenberg, J.</a> and <a>H. Schulzrinne</a>, "<a href="http://tools.ietf.org/html/rfc3581">An Extension to the Session Initiation Protocol (SIP) for Symmetric Response Routing</a>", RFC 3581, August 2003.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3022">[RFC3022]</b></td>
<td class="top">
<a>Srisuresh, P.</a> and <a>K. Egevang</a>, "<a href="http://tools.ietf.org/html/rfc3022">Traditional IP Network Address Translator (Traditional NAT)</a>", RFC 3022, January 2001.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5461">[RFC5461]</b></td>
<td class="top">
<a>Gont, F.</a>, "<a href="http://tools.ietf.org/html/rfc5461">TCP's Reaction to Soft Errors</a>", RFC 5461, February 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3424">[RFC3424]</b></td>
<td class="top">
<a>Daigle, L.</a>, <a>IAB</a>, "<a href="http://tools.ietf.org/html/rfc3424">IAB Considerations for UNilateral Self-Address Fixing (UNSAF) Across Network Address Translation</a>", RFC 3424, November 2002.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.miles-behave-l2nat">[I-D.miles-behave-l2nat]</b></td>
<td class="top">
<a>Miles, D</a> and <a>M Townsley</a>, "<a href="http://tools.ietf.org/html/draft-miles-behave-l2nat-00">Layer2-Aware NAT</a>", Internet-Draft draft-miles-behave-l2nat-00, March 2009.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-v6ops-cpe-simple-security">[I-D.ietf-v6ops-cpe-simple-security]</b></td>
<td class="top">
<a>Woodyatt, J</a>, "<a href="http://tools.ietf.org/html/draft-ietf-v6ops-cpe-simple-security-16">Recommended Simple Security Capabilities in Customer Premises Equipment for Providing Residential IPv6 Internet Service</a>", Internet-Draft draft-ietf-v6ops-cpe-simple-security-16, October 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.bpw-pcp-upnp-igd-interworking">[I-D.bpw-pcp-upnp-igd-interworking]</b></td>
<td class="top">
<a>Boucadair, M</a>, <a>Penno, R</a>, <a>Wing, D</a> and <a>F Dupont</a>, "<a href="http://tools.ietf.org/html/draft-bpw-pcp-upnp-igd-interworking-02">Universal Plug and Play (UPnP) Internet Gateway Device (IGD)-Port Control Protocol (PCP) Interworking Function</a>", Internet-Draft draft-bpw-pcp-upnp-igd-interworking-02, February 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6092">[RFC6092]</b></td>
<td class="top">
<a>Woodyatt, J.</a>, "<a href="http://tools.ietf.org/html/rfc6092">Recommended Simple Security Capabilities in Customer Premises Equipment (CPE) for Providing Residential IPv6 Internet Service</a>", RFC 6092, January 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-behave-lsn-requirements">[I-D.ietf-behave-lsn-requirements]</b></td>
<td class="top">
<a>Perreault, S</a>, <a>Yamagata, I</a>, <a>Miyakawa, S</a>, <a>Nakagawa, A</a> and <a>H Ashida</a>, "<a href="http://tools.ietf.org/html/draft-ietf-behave-lsn-requirements-04">Common requirements for Carrier Grade NAT (CGN)</a>", Internet-Draft draft-ietf-behave-lsn-requirements-04, October 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.cheshire-nat-pmp">[I-D.cheshire-nat-pmp]</b></td>
<td class="top">
<a>Cheshire, S</a>, "<a href="http://tools.ietf.org/html/draft-cheshire-nat-pmp-03">NAT Port Mapping Protocol (NAT-PMP)</a>", Internet-Draft draft-cheshire-nat-pmp-03, April 2008.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.arkko-dual-stack-extra-lite">[I-D.arkko-dual-stack-extra-lite]</b></td>
<td class="top">
<a>Arkko, J</a>, <a>Eggert, L</a> and <a>M Townsley</a>, "<a href="http://tools.ietf.org/html/draft-arkko-dual-stack-extra-lite-05">Scalable Operation of Address Translators with Per-Interface Bindings</a>", Internet-Draft draft-arkko-dual-stack-extra-lite-05, February 2011.</td>
</tr>
<tr>
<td class="reference"><b id="IGD">[IGD]</b></td>
<td class="top">
<a title="UPnP Forum">UPnP Gateway Committee, </a>, "<a>WANIPConnection:1</a>", November 2001.</td>
</tr>
<tr>
<td class="reference"><b id="PCP-Issues">[PCP-Issues]</b></td>
<td class="top">
<a title="IETF">PCP Working Group, </a>, "<a>PCP Active Tickets</a>", January 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> Changes</h1>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> Changes from draft-ietf-pcp-base-04 to -05</h1>
<p></p>

<ul>
<li>tweaked PCP common header packet layout.</li>
<li>Re-added port=0 (all ports).</li>
<li>minimum size is 12 octets (missed that change in -04).</li>
<li>removed Lifetime from PCP common header.</li>
<li>for MAP error responses, the lifetime indicates how long the server wants the client to avoid retrying the request.</li>
<li>More clearly indicated which fields are filled by the server on success responses and error responses.</li>
</ul>
<h1 id="rfc.appendix.Appendix A.2">
<a href="#rfc.appendix.Appendix%20A.2">Appendix A.2.</a> Changes from draft-ietf-pcp-base-03 to -04</h1>
<p></p>

<ul>
<li>"Pinhole" and "PIN" changed to "mapping" and "MAP".</li>
<li>Reduced from four MAP OpCodes to two. This was done by implicitly using the address family of the PCP message itself.</li>
<li>New option THIRD_PARTY, to more carefully split out the case where a mapping is created to a different host within the home.</li>
<li>Integrated a lot of editorial changes from Stuart and Francis.</li>
<li>Removed nested NAT text into another document, including the IANA-registered IP addresses for the PCP server.</li>
<li>Removed suggestion (MAY) that PCP server reserve UDP when it maps TCP. Nobody seems to need that.</li>
<li>Clearly added NAT and NAPT, such as in residential NATs, as within scope for PCP.</li>
<li>HONOR_EXTERNAL_PORT renamed to PREFER_FAILURE</li>
<li>Added 'Lifetime' field to the common PCP header, which replaces the functions of the 'temporary' and 'permanent' error types of the previous version.</li>
<li>Allow arbitrary Options to be included in PCP response, so that PCP server can indicate un-supported PCP Options. Satisfies PCP Issue #19</li>
<li>Reduced scope to only deal with mapping protocols that have port numbers.</li>
<li>Reduced scope to not support DMZ-style forwarding.</li>
<li>Clarified version negotiation.</li>
</ul>
<h1 id="rfc.appendix.Appendix A.3">
<a href="#rfc.appendix.Appendix%20A.3">Appendix A.3.</a> Changes from draft-ietf-pcp-base-02 to -03</h1>
<p></p>

<ul>
<li>Adjusted abstract and introduction to make it clear PCP is intended to forward ports and intended to reduce application keepalives.</li>
<li>First bit in PCP common header is set. This allows DTLS and non-DTLS to be multiplexed on same port, should a future update to this specification add DTLS support.</li>
<li>Moved subscriber identity from common PCP section to MAP* section.</li>
<li>made clearer that PCP client can reduce mapping lifetime if it wishes.</li>
<li>Added discussion of host running a server, client, or symmetric client+server.</li>
<li>Introduced PEER4 and PEER6 OpCodes.</li>
<li>Removed REMOTE_PEER Option, as its function has been replaced by the new PEER OpCodes.</li>
<li>IANA assigned port 44323 to PCP.</li>
<li>Removed AMBIGUOUS error code, which is no longer needed.</li>
</ul>
<h1 id="rfc.appendix.Appendix A.4">
<a href="#rfc.appendix.Appendix%20A.4">Appendix A.4.</a> Changes from draft-ietf-pcp-base-01 to -02</h1>
<p></p>

<ul>
<li>more error codes</li>
<li>PCP client source port number should be random</li>
<li>PCP message minimum 8 octets, maximum 1024 octets.</li>
<li>tweaked a lot of text in section 7.4, "Opcode-Specific Server Operation".</li>
<li>opening a mapping also allows ICMP messages associated with that mapping.</li>
<li>PREFER_FAILURE value changed to the mandatory-to-process range.</li>
<li>added text recommending applications that are crashing obtain short lifetimes, to avoid consuming subscriber's port quota.</li>
</ul>
<h1 id="rfc.appendix.Appendix A.5">
<a href="#rfc.appendix.Appendix%20A.5">Appendix A.5.</a> Changes from draft-ietf-pcp-base-00 to -01</h1>
<p></p>

<ul>
<li>Significant document reorganization, primarily to split base PCP operation from OpCode operation.</li>
<li>packet format changed to move 'protocol' outside of PCP common header and into the MAP* opcodes</li>
<li>Renamed Informational Elements (IE) to Options.</li>
<li>Added REMOTE_PEER (for disambiguation with dynamic ports), REMOTE_PEER_FILTER (for simple packet filtering), and PREFER_FAILURE (to optimize UPnP IGD interworking) options.</li>
<li>Is NAT or router behind B4 in scope?</li>
<li>PCP option MAY be included in a request, in which case it MUST appear in a response. It MUST NOT appear in a response if it wasn't in the request.</li>
<li>Response code most significant bit now indicates permanent/temporary error</li>
<li>PCP Options are split into mandatory-to-process ("P" bit), and into Specification Required and Private Use.</li>
<li>Epoch discussion simplified.</li>
</ul>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Dan Wing</span> editor
	  <span class="n hidden">
		<span class="family-name">Wing</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>170 West Tasman Drive</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">California</span> 
		<span class="code">95134</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:dwing@cisco.com">dwing@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Stuart Cheshire</span> 
	  <span class="n hidden">
		<span class="family-name">Cheshire</span>
	  </span>
	</span>
	<span class="org vcardline">Apple, Inc.</span>
	<span class="adr">
	  <span>1 Infinite Loop</span>

	  <span class="vcardline">
		<span class="locality">Cupertino</span>,  
		<span class="region">California</span> 
		<span class="code">95014</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">Phone: +1 408 974 3207</span>

<span class="vcardline">EMail: <a href="mailto:cheshire@apple.com">cheshire@apple.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mohamed Boucadair</span> 
	  <span class="n hidden">
		<span class="family-name">Boucadair</span>
	  </span>
	</span>
	<span class="org vcardline">France Telecom</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality">Rennes</span>,  
		<span class="region"></span>
		<span class="code">35000</span>
	  </span>
	  <span class="country-name vcardline">France</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mohamed.boucadair@orange-ftgroup.com">mohamed.boucadair@orange-ftgroup.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Reinaldo Penno</span> 
	  <span class="n hidden">
		<span class="family-name">Penno</span>
	  </span>
	</span>
	<span class="org vcardline">Juniper Networks</span>
	<span class="adr">
	  <span>1194 N Mathilda Avenue</span>

	  <span class="vcardline">
		<span class="locality">Sunnyvale</span>,  
		<span class="region">California</span> 
		<span class="code">94089</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:rpenno@juniper.net">rpenno@juniper.net</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Francis Dupont</span> 
	  <span class="n hidden">
		<span class="family-name">Dupont</span>
	  </span>
	</span>
	<span class="org vcardline">Internet Systems Consortium</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:fdupont@isc.org">fdupont@isc.org</a></span>

  </address>
</div>

</body>
</html>