<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>End-to-End Object Encryption for the Extensible Messaging and Presence Protocol (XMPP)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="End-to-End Object Encryption for the Extensible Messaging and Presence Protocol (XMPP)">
<meta name="keywords" content="Internet-Draft, XMPP, Extensible Messaging and Presence Protocol, Jabber">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">M. Miller</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">P. Saint-Andre</td></tr>
<tr><td class="header">Obsoletes: <a href='http://tools.ietf.org/html/rfc3923'>3923</a> (if&nbsp;approved)</td><td class="header">Cisco</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">March 09, 2010</td></tr>
<tr><td class="header">Expires: September 10, 2010</td><td class="header">&nbsp;</td></tr>
</table></td></tr></table>
<h1><br />End-to-End Object Encryption for the Extensible Messaging and Presence Protocol (XMPP)<br />draft-miller-3923bis-01</h1>

<h3>Abstract</h3>

<p>This document defines a method of end-to-end object encryption for the Extensible Messaging and Presence Protocol (XMPP).  The protocol defined herein is a simplified version of the protocol defined in RFC 3923.
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on September 10, 2010.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#intro">1.</a>&nbsp;
Introduction<br />
<a href="#terms">2.</a>&nbsp;
Terminology<br />
<a href="#stanza">3.</a>&nbsp;
Securing XMPP Stanzas<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ex-message">3.1.</a>&nbsp;
Example of Securing Messages<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ex-iq">3.2.</a>&nbsp;
Example of Securing IQs<br />
<a href="#interact">4.</a>&nbsp;
Interaction with Stanza Semantics<br />
<a href="#inbound">5.</a>&nbsp;
Handling of Inbound Stanzas<br />
<a href="#timestamps">6.</a>&nbsp;
Inclusion and Checking of Timestamps<br />
<a href="#mti">7.</a>&nbsp;
Mandatory-to-Implement Cryptographic Algorithms<br />
<a href="#certs">8.</a>&nbsp;
Certificates<br />
<a href="#security">9.</a>&nbsp;
Security Considerations<br />
<a href="#iana">10.</a>&nbsp;
IANA Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#iana-ns-e2e">10.1.</a>&nbsp;
XML Namespace Name for e2e Data in XMPP<br />
<a href="#rfc.references1">11.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">11.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">11.2.</a>&nbsp;
Informative References<br />
<a href="#schemas-e2e">Appendix&nbsp;A.</a>&nbsp;
Schema for urn:ietf:params:xml:ns:xmpp-objenc<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>End-to-end encryption of traffic sent over the Extensible Messaging and Presence Protocol <a class='info' href='#XMPP-CORE'>[XMPP&#8209;CORE]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a> is a desirable goal.  Requirements and a threat analysis for XMPP encryption are provided in <a class='info' href='#E2E-REQ'>[E2E&#8209;REQ]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Requirements for End-to-End Encryption in the Extensible Messaging and Presence Protocol (XMPP),&rdquo; March&nbsp;2010.</span><span>)</span></a>.  Many possible approaches to meet those (or similar) requirements have been proposed over the years, including methods based on PGP, S/MIME, SIGMA, and TLS.
</p>
<p>The S/MIME approach defined in RFC 3923 has never been implemented in XMPP clients to the best of our knowledge, but has some attractive features, especially the ability to store-and-forward an encrypted message at a user's server if the user is not online when the message is received (in the XMPP community this is called "offline storage" and the message is referred to as an "offline message").  The authors surmise that RFC 3923 has not been implemented mainly because it adds several new dependencies to XMPP clients, especially MIME (along with the CPIM and MSGFMT media types).  Therefore this document explores the possibility of an approach that is similar to but simpler than RFC 3923, while retaining the same basic object encryption model.
</p>
<a name="terms"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>This document inherits terminology defined in <a class='info' href='#XMPP-CORE'>[XMPP&#8209;CORE]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a>.
</p>
<p>Security-related terms are to be understood in the sense defined in <a class='info' href='#SECTERMS'>[SECTERMS]<span> (</span><span class='info'>Shirey, R., &ldquo;Internet Security Glossary, Version 2,&rdquo; August&nbsp;2007.</span><span>)</span></a>.
</p>
<p>The capitalized key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a class='info' href='#TERMS'>BCP 14, RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [TERMS].
</p>
<a name="stanza"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Securing XMPP Stanzas</h3>

<p>The process that a sending agent follows for securing stanzas is very similar regardless of the form of stanza (i.e., &lt;iq/&gt;, &lt;message/&gt;, or &lt;presence/&gt;).
</p>
<p></p>
<ol class="text">
<li>Constructs a cleartext version of the stanza, S.
</li>
<li>Notes the current UTC date and time N when this stanza is constructed, formatted as per <a class='info' href='#DATETIME'>[DATETIME]<span> (</span><span class='info'>Klyne, G. and C. Newman, &ldquo;Date and Time on the Internet: Timestamps,&rdquo; July&nbsp;2002.</span><span>)</span></a> and including the seconds and fractions of a second to three digits (resulting in a datetime string 24 characters in length, such as "2010-02-28T18:00:00.314Z").
</li>
<li>Hashes the datetime N using a cryptographic hashing algorithm, i.e., hash(N) = N'.
</li>
<li>Converts the stanza to a UTF-8 encoded string, optionally removing line breaks and other insignificant whitespace between elements and attributes, i.e., UTF8-encode(S) = S'. We call S' a "stanza-string" because for purposes of encryption and decryption it is treated not as XML but as an opaque string (this avoids the need for complex canonicalization of the XML input).
</li>
<li>Encrypts (N' + S') using the recipient's public key to produce encrypted data T.  (Known issue: This step is under-specified and will be expanded in a later version of this document.)
</li>
<li>Base64-encodes T to produce the encrypted data T'.
</li>
<li>Constructs an &lt;e2e/&gt; element qualified by the "urn:ietf:params:xml:ns:xmpp-objenc" namespace as follows:
        
<blockquote class="text"><dl>
<dt></dt>
<dd>The attribute 'stamp' set to the timestamp N from step 2;
</dd>
<dt></dt>
<dd>The attribute 'hash' set to the cryptographic hashing algorithm used in step 3;
</dd>
<dt></dt>
<dd>The attribute 'cipher' set to the encryption scheme used in step 5;
</dd>
<dt></dt>
<dd>The XML character data as T' from step 6.
</dd>
</dl></blockquote>
</li>
<li>Sends the &lt;e2e/&gt; element as the payload of a stanza that matches the stanza from step 1 in both kind (e.g., &lt;message/&gt;) and type (e.g., "chat").
</li>
</ol>

<a name="ex-message"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Example of Securing Messages</h3>

<p>The sender begins with the cleartext version of the &lt;message/&gt; stanza "S":
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message    xmlns='jabber:client'
            from='juliet@capulet.net/balcony'
            id='183ef129'
            to='romeo@montague.net'
            type='chat'&gt;
    &lt;thread&gt;8996aef0-061d-012d-347a-549a200771aa&lt;/thread&gt;
    &lt;body&gt;Wherefore art thou, Romeo?&lt;/body&gt;
&lt;/message&gt;
</pre></div>
<p>The sender then performs the steps from above, and sends the following:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message  xmlns='jabber:client'
          from='juliet@capulet.net/balcony'
          id='6410ed123'
          to='romeo@montague.net'
          type='chat'&gt;
  &lt;e2e  xmlns='urn:ietf:params:xml:ns:xmpp-objenc'
        cipher='RSAES-PKCS1-v1_5'
        hash='SHA-256'
        stamp='2010-02-28T18:00:00.203Z'&gt;
    Ysocyy9I2jUACcChThqCuVxqB9qdFJ+mKzpbABiF+a5wMavDnQf
    z1Rda1OAL\nzs5M8+uSnQA643bGlpVvuzbi1zdfmuRtqIHzopz2
    3CNq5cz8nuIPOLcWZvWP\nmDa5tbhB+loItG8roCYuF7Y4h+RkG
    CwXBpV+Kwe9ZKhM1vklJ4znCfcghDXU\nORQiY29W2r/Vrqhd6U
    u+ftp0mFm+7s45NjIOSYm7T+Fl5e7wu1FUtr9CmcPd\n22WRLNT
    wZ+iKu0AdGUUSqLWqAUBtERA85hhj/3vNCdawOf6dm/K9eLmoLF
    zH\nph7vc0519w5mqUktKnfzuh/4/iXGRHWJ27jZLfCcag==
  &lt;/e2e&gt;
&lt;/message&gt;
</pre></div>
<a name="ex-iq"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Example of Securing IQs</h3>

<p>The sender begins with the cleartext version of the &lt;iq/&gt; stanza "S":
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;iq       xmlns='jabber:client'
          from='juliet@capulet.net/crypt'
          id='a543bc3ee'
          to='romeo@montague.net'
          type='resut'&gt;
  &lt;mood xmlns='http://jabber.org/protocol/mood'&gt;
    &lt;dejected/&gt;
    &lt;text&gt;
      Romeo, what's here? Poison? Drunk all, and left no
      friendly drop to help me after?
    &lt;/text&gt;
  &lt;/mood&gt;
&lt;/iq&gt;
</pre></div>
<p>The sender then performs the steps from above, and sends the following:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;iq       xmlns='jabber:client'
          from='juliet@capulet.net/crypt'
          id='a543bc3ee'
          to='romeo@montague.net/crypt'
          type='result'&gt;
  &lt;e2e  xmlns='urn:ietf:params:xml:ns:xmpp-objenc'
        cipher='RSAES-PKCS1-v1_5'
        hash='SHA-256'
        stamp='2010-03-06T20:53:18.082Z'&gt;
    Up3uZr1j0H9UCdG91ec8h4bIbgmHNZ6Gu/UHr03XsPtc4Qamb/8
    hpc4h+JL5\n6G8hhIkPeUN2ieCrXbCa84RtsJ/TuFONLw/tNe2Y
    Fm7Js7RKgTrTRzjWCTAh\nKTp2rvjkN1T15c9N0kE2m4QX5nnYo
    zv+bV/i/mFFCwY1UdDQqIpKhd0eaHV/\n9FYikzp319fDu6op8/
    kbyce2rUBzAbYRAPCxM1E1sd11UERR0VwWoOTMEDCz\n+g3/Rhd
    vT5HOIVBHYEFKl+NQeHTJIAIsVWRl9Bn1+CdgZxM8phoRidtYFk
    18\nOaPvVABy65HBeUIYaye7Mzi0Qg2oNwRkLy1Brf/m9Q==
  &lt;/e2e&gt;
&lt;/iq&gt;
</pre></div>
<a name="interact"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Interaction with Stanza Semantics</h3>

<p>The following limitations and caveats apply:
</p>
<p></p>
<ul class="text">
<li>Undirected &lt;presence/&gt; stanzas MUST NOT be encrypted. Such stanzas are delivered to anyone the sender has authorized, and therefore it is highly unlikely that the send can find an appropriate certificate.
</li>
<li>Stanzas directed to multiplexing services (e.g. multi-user chat) SHOULD NOT be encrypted, unless the sender has established an acceptable trust relationship with the multiplexing service.
</li>
</ul>

<a name="inbound"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Handling of Inbound Stanzas</h3>

<p>Several scenarios are possible when an entity receives an encrypted stanza:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Case #1:</dt>
<dd>The receiving application does not understand the protocol.
</dd>
<dt>Case #2:</dt>
<dd>The receiving application understands the protocol and is able to decrypt the payload.
</dd>
<dt>Case #3:</dt>
<dd>The receiving application understands the protocol and is able to decrypt the payload, but the timestamps fail the checks specified under <a class='info' href='#timestamps'>Checking of Timestamps<span> (</span><span class='info'>Inclusion and Checking of Timestamps</span><span>)</span></a>.
</dd>
<dt>Case #4:</dt>
<dd>The receiving application understands the protocol but is unable to decrypt the payload.
</dd>
</dl></blockquote>

<p>In Case #1, the receiving application MUST do one and only one of the following: (1) ignore the &lt;e2e/&gt; extension, (2) ignore the entire stanza, or (3) return a &lt;service-unavailable/&gt; error to the sender, as described in <a class='info' href='#XMPP-CORE'>[XMPP&#8209;CORE]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a>.
</p>
<p>In Case #2, the receiving application MUST NOT return a stanza error to the sender, since this is the success case.
</p>
<p>In Case #3, the receiving application MAY return a &lt;not-acceptable/&gt; error to the sender (as described in <a class='info' href='#XMPP-CORE'>[XMPP&#8209;CORE]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a>), optionally supplemented by an application-specific error condition element of &lt;bad-timestamp/&gt; as shown below:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net/orchard'
         id='6410ed123'
         to='juliet@capulet.net/balcony'
         type='error'&gt;
  &lt;e2e xmlns='urn:ietf:params:xml:ns:xmpp-objenc'&gt;
    XML-character-data-here
  &lt;/e2e&gt;
  &lt;error type='modify'&gt;
    &lt;not-acceptable xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;bad-timestamp xmlns='urn:ietf:params:xml:xmpp-e2e'/&gt;
  &lt;/error&gt;
&lt;/message&gt;
</pre></div>
<p>In Case #4, the receiving application SHOULD return a &lt;bad-request/&gt; error to the sender (as described in <a class='info' href='#XMPP-CORE'>[XMPP&#8209;CORE]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a>), optionally supplemented by an application-specific error condition element of &lt;decryption-failed/&gt; as shown below:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;message from='romeo@example.net/orchard'
         id='6410ed123'
         to='juliet@capulet.net/balcony'
         type='error'&gt;
  &lt;e2e xmlns='urn:ietf:params:xml:ns:xmpp-objenc'&gt;
    XML-character-data-here
  &lt;/e2e&gt;
  &lt;error type='modify'&gt;
    &lt;bad-request xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/&gt;
    &lt;decryption-failed xmlns='urn:ietf:params:xml:xmpp-e2e'/&gt;
  &lt;/error&gt;
&lt;/message&gt;
</pre></div>
<p>In addition to returning an error in Case #4, the receiving application SHOULD NOT present the stanza to the intended recipient (human or application) and SHOULD provide some explicit alternate processing of the stanza (which may be to display a message informing the recipient that it has received a stanza that cannot be decrypted).
</p>
<a name="timestamps"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Inclusion and Checking of Timestamps</h3>

<p>Timestamps are included to help prevent replay attacks.  All timestamps MUST conform to <a class='info' href='#DATETIME'>[DATETIME]<span> (</span><span class='info'>Klyne, G. and C. Newman, &ldquo;Date and Time on the Internet: Timestamps,&rdquo; July&nbsp;2002.</span><span>)</span></a> and be presented as UTC with no offset, always including the seconds and fractions of a second to three digits (resulting in a datetime 24 characters in length).  Absent a local adjustment to the sending agent's perceived time or the underlying clock time, the sending agent MUST ensure that the timestamps it sends to the receiver increase monotonically (if necessary by incrementing the seconds fraction in the timestamp if the clock returns the same time for multiple requests).  The following rules apply to the receiving application:
</p>
<p></p>
<ul class="text">
<li>It MUST verify that the timestamp received is within five minutes of the current time, except as described below for offline messages.
</li>
<li>It SHOULD verify that the timestamp received is greater than any timestamp received in the last 10 minutes which passed the previous check.
</li>
<li>If any of the foregoing checks fails, the timestamp SHOULD be presented to the receiving entity (human or application) marked as "old timestamp", "future timestamp", or "decreasing timestamp", and the receiving entity MAY return a stanza error to the sender.
</li>
</ul>

<p>The foregoing timestamp checks assume that the recipient is online when the message is received.  However, if the recipient is offline then the server will probably store the message for delivery when the recipient is next online (offline storage does not apply to &lt;iq/&gt; or &lt;presence/&gt; stanzas, only &lt;message/&gt; stanzas).  As described in <a class='info' href='#OFFLINE'>[OFFLINE]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Best Practices for Handling Offline Messages,&rdquo; January&nbsp;2006.</span><span>)</span></a>, when sending an offline message to the recipient, the server SHOULD include delayed delivery data as specified in <a class='info' href='#DELAY'>[DELAY]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Delayed Delivery,&rdquo; September&nbsp;2009.</span><span>)</span></a> so that the recipient knows that this is an offline message and also knows the original time of receipt at the server.  In this case, the recipient SHOULD verify that the timestamp received in the encrypted message is within five minutes of the time stamped by the recipient's server in the &lt;delay/&gt; element.
</p>
<a name="mti"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Mandatory-to-Implement Cryptographic Algorithms</h3>

<p>All implementations MUST support the following algorithms.  Implementations MAY support other algorithms as well.
</p>
<p></p>
<ul class="text">
<li>The RSA (PKCS #1 v1.5) key transport, as specified in <a class='info' href='#CMS-ALG'>[CMS&#8209;ALG]<span> (</span><span class='info'>Housley, R., &ldquo;Cryptographic Message Syntax (CMS) Algorithms,&rdquo; August&nbsp;2002.</span><span>)</span></a> section 4.2.1.
</li>
<li>The AES-128 encryption algorithm in CBC mode, as specified in <a class='info' href='#CMS-AES'>[CMS&#8209;AES]<span> (</span><span class='info'>Schaad, J., &ldquo;Use of the Advanced Encryption Standard (AES) Encryption Algorithm in Cryptographic Message Syntax (CMS),&rdquo; July&nbsp;2003.</span><span>)</span></a>.
</li>
<li>The SHA-256 hashing algorithm, as specified in <a class='info' href='#X509-ALGO'>[X509&#8209;ALGO]<span> (</span><span class='info'>Jonsson, J. and B. Kaliski, &ldquo;Public-Key Cryptography Standards (PKCS) #1: RSA Cryptography Specifications Version 2.1,&rdquo; February&nbsp;2003.</span><span>)</span></a>.
</li>
</ul>

<a name="certs"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Certificates</h3>

<p>To participate in end-to-end encryption using the methods defined in this document, a client needs to possess an X.509 certificate.  It is expected that many clients will generate their own (self-signed) certificates rather than obtain a certificate issued by a certification authority (CA).  In any case the certificate MUST include an XMPP address that is represented using the ASN.1 Object Identifier "id-on-xmppAddr" as specified in Section 5.1.1 of <a class='info' href='#XMPP-CORE'>[XMPP&#8209;CORE]<span> (</span><span class='info'>Saint-Andre, P., &ldquo;Extensible Messaging and Presence Protocol (XMPP): Core,&rdquo; October&nbsp;2004.</span><span>)</span></a>.
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Security Considerations</h3>

<p>The recipient's server might store any &lt;message/&gt; stanzas received until the recipient is next available; this duration could be anywhere from a few minutes to several months.
</p>
<a name="iana"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
IANA Considerations</h3>

<a name="iana-ns-e2e"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1"></a><h3>10.1.&nbsp;
XML Namespace Name for e2e Data in XMPP</h3>

<p>A URN sub-namespace of signed and encrypted content for the Extensible Messaging and Presence Protocol (XMPP) is defined as follows.
</p>
<p></p>
<blockquote class="text"><dl>
<dt>URI:</dt>
<dd>urn:ietf:params:xml:ns:xmpp-objenc
</dd>
<dt>Specification:</dt>
<dd>RFC XXXX
</dd>
<dt>Description:</dt>
<dd>This is an XML namespace name of signed and encrypted content for the Extensible Messaging and Presence Protocol as defined by RFC XXXX.
</dd>
<dt>Registrant Contact:</dt>
<dd>IESG, &lt;iesg@ietf.org&gt;
</dd>
</dl></blockquote>

<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="CMS-AES">[CMS-AES]</a></td>
<td class="author-text">Schaad, J., &ldquo;<a href="http://tools.ietf.org/html/rfc3565">Use of the Advanced Encryption Standard (AES) Encryption Algorithm in Cryptographic Message Syntax (CMS)</a>,&rdquo; RFC&nbsp;3565, July&nbsp;2003 (<a href="ftp://ftp.isi.edu/in-notes/rfc3565.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="CMS-ALG">[CMS-ALG]</a></td>
<td class="author-text">Housley, R., &ldquo;<a href="http://tools.ietf.org/html/rfc3370">Cryptographic Message Syntax (CMS) Algorithms</a>,&rdquo; RFC&nbsp;3370, August&nbsp;2002 (<a href="ftp://ftp.isi.edu/in-notes/rfc3370.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="DATETIME">[DATETIME]</a></td>
<td class="author-text">Klyne, G. and C. Newman, &ldquo;<a href="http://tools.ietf.org/html/rfc3339">Date and Time on the Internet: Timestamps</a>,&rdquo; RFC&nbsp;3339, July&nbsp;2002 (<a href="ftp://ftp.isi.edu/in-notes/rfc3339.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="E2E-REQ">[E2E-REQ]</a></td>
<td class="author-text">Saint-Andre, P., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-saintandre-xmpp-e2e-requirements-01.txt">Requirements for End-to-End Encryption in the Extensible Messaging and Presence Protocol (XMPP)</a>,&rdquo; draft-saintandre-xmpp-e2e-requirements-01 (work in progress), March&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-saintandre-xmpp-e2e-requirements-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SECTERMS">[SECTERMS]</a></td>
<td class="author-text">Shirey, R., &ldquo;<a href="http://tools.ietf.org/html/rfc4949">Internet Security Glossary, Version 2</a>,&rdquo; RFC&nbsp;4949, August&nbsp;2007 (<a href="ftp://ftp.isi.edu/in-notes/rfc4949.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="TERMS">[TERMS]</a></td>
<td class="author-text"><a href="mailto:-">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997.</td></tr>
<tr><td class="author-text" valign="top"><a name="X509-ALGO">[X509-ALGO]</a></td>
<td class="author-text">Jonsson, J. and B. Kaliski, &ldquo;<a href="http://tools.ietf.org/html/rfc3447">Public-Key Cryptography Standards (PKCS) #1: RSA Cryptography Specifications Version 2.1</a>,&rdquo; RFC&nbsp;3447, February&nbsp;2003 (<a href="ftp://ftp.isi.edu/in-notes/rfc3447.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="XMPP-CORE">[XMPP-CORE]</a></td>
<td class="author-text">Saint-Andre, P., &ldquo;<a href="http://tools.ietf.org/html/rfc3920">Extensible Messaging and Presence Protocol (XMPP): Core</a>,&rdquo; RFC&nbsp;3920, October&nbsp;2004 (<a href="ftp://ftp.isi.edu/in-notes/rfc3920.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="DELAY">[DELAY]</a></td>
<td class="author-text"><a href="mailto:stpeter@jabber.org">Saint-Andre, P.</a>, &ldquo;<a href="http://xmpp.org/extensions/xep-0203.html">Delayed Delivery</a>,&rdquo; XSF XEP&nbsp;0203, September&nbsp;2009.</td></tr>
<tr><td class="author-text" valign="top"><a name="OFFLINE">[OFFLINE]</a></td>
<td class="author-text"><a href="mailto:stpeter@jabber.org">Saint-Andre, P.</a>, &ldquo;<a href="http://xmpp.org/extensions/xep-0160.html">Best Practices for Handling Offline Messages</a>,&rdquo; XSF XEP&nbsp;0160, January&nbsp;2006.</td></tr>
</table>

<a name="schemas-e2e"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Schema for urn:ietf:params:xml:ns:xmpp-objenc</h3>

<p>The following XML schema is descriptive, not normative.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
&lt;?xml version='1.0' encoding='UTF-8'?&gt;

&lt;xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='urn:ietf:params:xml:ns:xmpp-objenc'
    xmlns='urn:ietf:params:xml:ns:xmpp-objenc'
    elementFormDefault='qualified'&gt;

  &lt;xs:element name='e2e'&gt;
    &lt;xs:complexType&gt;
      &lt;xs:simpleContent&gt;
        &lt;xs:extension base='xs:string'&gt;
          &lt;xs:attribute name='cipher'
                        type='xs:string'
                        use='optional'/&gt;
          &lt;xs:attribute name='hash'
                        type='xs:string'
                        use='optional'/&gt;
          &lt;xs:attribute name='timestamp'
                        type='xs:string'
                        use='optional'/&gt;
        &lt;/xs:extension&gt;
      &lt;/xs:simpleContent&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;

  &lt;xs:element name='decryption-failed' type='empty'/&gt;
  &lt;xs:element name='bad-timestamp' type='empty'/&gt;

  &lt;xs:simpleType name='empty'&gt;
    &lt;xs:restriction base='xs:string'&gt;
      &lt;xs:enumeration value=''/&gt;
    &lt;/xs:restriction&gt;
  &lt;/xs:simpleType&gt;

&lt;/xs:schema&gt;
</pre></div>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Matthew Miller</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:mamille2@cisco.com">mamille2@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Peter Saint-Andre</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:psaintan@cisco.com">psaintan@cisco.com</a></td></tr>
</table>
</body></html>
