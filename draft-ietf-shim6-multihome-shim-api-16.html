<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Socket Application Program Interface (API) for Multihoming Shim</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.2" rel="Chapter" title="2 Requirements Language">
<link href="#rfc.section.3" rel="Chapter" title="3 Terminology">
<link href="#rfc.section.4" rel="Chapter" title="4 System Overview">
<link href="#rfc.section.5" rel="Chapter" title="5 Requirements">
<link href="#rfc.section.6" rel="Chapter" title="6 Socket Options for Multihoming Shim Sub-layer">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 SHIM_ASSOCIATED">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 SHIM_DONTSHIM">
<link href="#rfc.section.6.3" rel="Chapter" title="6.3 SHIM_HOT_STANDBY">
<link href="#rfc.section.6.4" rel="Chapter" title="6.4 SHIM_LOC_LOCAL_PREF">
<link href="#rfc.section.6.5" rel="Chapter" title="6.5 SHIM_LOC_PEER_PREF">
<link href="#rfc.section.6.6" rel="Chapter" title="6.6 SHIM_LOC_LOCAL_RECV">
<link href="#rfc.section.6.7" rel="Chapter" title="6.7 SHIM_LOC_PEER_RECV">
<link href="#rfc.section.6.8" rel="Chapter" title="6.8 SHIM_LOC_LOCAL_SEND">
<link href="#rfc.section.6.9" rel="Chapter" title="6.9 SHIM_LOC_PEER_SEND">
<link href="#rfc.section.6.10" rel="Chapter" title="6.10 SHIM_LOCLIST_LOCAL">
<link href="#rfc.section.6.11" rel="Chapter" title="6.11 SHIM_LOCLIST_PEER">
<link href="#rfc.section.6.12" rel="Chapter" title="6.12 SHIM_APP_TIMEOUT">
<link href="#rfc.section.6.13" rel="Chapter" title="6.13 SHIM_PATHEXPLORE">
<link href="#rfc.section.6.14" rel="Chapter" title="6.14 SHIM_DEFERRED_CONTEXT_SETUP">
<link href="#rfc.section.6.15" rel="Chapter" title="6.15 Applicability">
<link href="#rfc.section.6.16" rel="Chapter" title="6.16 Error Handling">
<link href="#rfc.section.7" rel="Chapter" title="7 Ancillary Data for Multihoming Shim Sub-layer">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Get Locator from Incoming Packet">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Set Locator for Outgoing Packet">
<link href="#rfc.section.7.3" rel="Chapter" title="7.3 Notification from Application to Multihoming Shim Sub-layer">
<link href="#rfc.section.7.4" rel="Chapter" title="7.4 Applicability">
<link href="#rfc.section.8" rel="Chapter" title="8 Data Structures">
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 Placeholder for Locator Information">
<link href="#rfc.section.8.1.1" rel="Chapter" title="8.1.1 Handling Locator behind NAT">
<link href="#rfc.section.8.2" rel="Chapter" title="8.2 Path Exploration Parameter">
<link href="#rfc.section.8.3" rel="Chapter" title="8.3 Feedback Information">
<link href="#rfc.section.9" rel="Chapter" title="9 System Requirements">
<link href="#rfc.section.10" rel="Chapter" title="10 Relation to Existing Sockets API Extensions">
<link href="#rfc.section.11" rel="Chapter" title="11 Operational Considerations">
<link href="#rfc.section.11.1" rel="Chapter" title="11.1 Conflict Resolution">
<link href="#rfc.section.11.2" rel="Chapter" title="11.2 Incompatibility between IPv4 and IPv6">
<link href="#rfc.section.12" rel="Chapter" title="12 IANA Considerations">
<link href="#rfc.section.13" rel="Chapter" title="13 Protocol Constants and Variables">
<link href="#rfc.section.14" rel="Chapter" title="14 Security Considerations">
<link href="#rfc.section.14.1" rel="Chapter" title="14.1 Treatment of Unknown Locator">
<link href="#rfc.section.14.1.1" rel="Chapter" title="14.1.1 Treatment of Unknown Source Locator">
<link href="#rfc.section.14.1.2" rel="Chapter" title="14.1.2 Treatment of Unknown Destination Locator">
<link href="#rfc.section.15" rel="Chapter" title="15 Changes">
<link href="#rfc.section.15.1" rel="Chapter" title="15.1 Changes from version 00 to version 01">
<link href="#rfc.section.15.2" rel="Chapter" title="15.2 Changes from version 01 to version 02">
<link href="#rfc.section.15.3" rel="Chapter" title="15.3 Changes from version 02 to version 03">
<link href="#rfc.section.15.4" rel="Chapter" title="15.4 Changes from version 03 to version 04">
<link href="#rfc.section.15.5" rel="Chapter" title="15.5 Changes from version 04 to version 05">
<link href="#rfc.section.15.6" rel="Chapter" title="15.6 Changes from version 05 to version 06">
<link href="#rfc.section.15.7" rel="Chapter" title="15.7 Changes from version 06 to version 07">
<link href="#rfc.section.15.8" rel="Chapter" title="15.8 Changes from version 07 to version 08">
<link href="#rfc.section.15.9" rel="Chapter" title="15.9 Changes from version 08 to version 09">
<link href="#rfc.section.15.10" rel="Chapter" title="15.10 Changes from version 09 to version 10">
<link href="#rfc.section.15.11" rel="Chapter" title="15.11 Changes from version 10 to version 11">
<link href="#rfc.section.15.12" rel="Chapter" title="15.12 Changes from version 11 to version 12">
<link href="#rfc.section.15.13" rel="Chapter" title="15.13 Changes from version 12 to version 13">
<link href="#rfc.section.15.14" rel="Chapter" title="15.14 Changes from version 13 to version 14">
<link href="#rfc.section.15.15" rel="Chapter" title="15.15 Changes from version 14 to version 15">
<link href="#rfc.section.15.16" rel="Chapter" title="15.16 Changes from version 15 to version 16">
<link href="#rfc.section.16" rel="Chapter" title="16 Acknowledgments">
<link href="#rfc.references" rel="Chapter" title="17 References">
<link href="#rfc.references.1" rel="Chapter" title="17.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="17.2 Informative References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Context Forking">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document specifies sockets API extensions for the multihoming shim layer.  The API aims to enable interactions between applications and the multihoming shim layer for advanced locator management, and access to information about failure detection and path exploration." />
  <meta name="description" content="This document specifies sockets API extensions for the multihoming shim layer.  The API aims to enable interactions between applications and the multihoming shim layer for advanced locator management, and access to information about failure detection and path exploration." />
  <meta name="keywords" content="SHIM6, HIP, identifier/locator split" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">SHIM6 Working Group</td>
<td class="right">M. Komu</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">HIIT</td>
</tr>
<tr>
<td class="left">Intended status: Informational</td>
<td class="right">M. Bagnulo</td>
</tr>
<tr>
<td class="left">Expires: August 16, 2011</td>
<td class="right">UC3M</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">K. Slavov</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">S. Sugimoto, Ed.</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Ericsson</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">February 12, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Socket Application Program Interface (API) for Multihoming Shim<br />
  <span class="filename">draft-ietf-shim6-multihome-shim-api-16</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document specifies sockets API extensions for the multihoming shim layer.  The API aims to enable interactions between applications and the multihoming shim layer for advanced locator management, and access to information about failure detection and path exploration.</p>
<p>This document is based on an assumption that a multihomed host is equipped with a conceptual sub-layer (hereafter "shim") inside the IP layer that maintains mappings between identifiers and locators.  Examples of the shim are SHIM6 and HIP.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on August 16, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>
<p>This document may contain material from IETF Documents or IETF Contributions published or made publicly available before November 10, 2008.  The person(s) controlling the copyright in some of this material may not have granted the IETF Trust the right to allow modifications of such material outside the IETF Standards Process. Without obtaining an adequate license from the person(s) controlling the copyright in such materials, this document may not be modified outside the IETF Standards Process, and derivative works of it may not be created outside the IETF Standards Process, except to format it for publication as an RFC or to translate it into languages other than English.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>2.   <a href="#rfc.section.2">Requirements Language</a>
</li>
<li>3.   <a href="#rfc.section.3">Terminology</a>
</li>
<li>4.   <a href="#rfc.section.4">System Overview</a>
</li>
<li>5.   <a href="#rfc.section.5">Requirements</a>
</li>
<li>6.   <a href="#rfc.section.6">Socket Options for Multihoming Shim Sub-layer</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">SHIM_ASSOCIATED</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">SHIM_DONTSHIM</a>
</li>
<li>6.3.   <a href="#rfc.section.6.3">SHIM_HOT_STANDBY</a>
</li>
<li>6.4.   <a href="#rfc.section.6.4">SHIM_LOC_LOCAL_PREF</a>
</li>
<li>6.5.   <a href="#rfc.section.6.5">SHIM_LOC_PEER_PREF</a>
</li>
<li>6.6.   <a href="#rfc.section.6.6">SHIM_LOC_LOCAL_RECV</a>
</li>
<li>6.7.   <a href="#rfc.section.6.7">SHIM_LOC_PEER_RECV</a>
</li>
<li>6.8.   <a href="#rfc.section.6.8">SHIM_LOC_LOCAL_SEND</a>
</li>
<li>6.9.   <a href="#rfc.section.6.9">SHIM_LOC_PEER_SEND</a>
</li>
<li>6.10.   <a href="#rfc.section.6.10">SHIM_LOCLIST_LOCAL</a>
</li>
<li>6.11.   <a href="#rfc.section.6.11">SHIM_LOCLIST_PEER</a>
</li>
<li>6.12.   <a href="#rfc.section.6.12">SHIM_APP_TIMEOUT</a>
</li>
<li>6.13.   <a href="#rfc.section.6.13">SHIM_PATHEXPLORE</a>
</li>
<li>6.14.   <a href="#rfc.section.6.14">SHIM_DEFERRED_CONTEXT_SETUP</a>
</li>
<li>6.15.   <a href="#rfc.section.6.15">Applicability</a>
</li>
<li>6.16.   <a href="#rfc.section.6.16">Error Handling</a>
</li>
<li>7.   <a href="#rfc.section.7">Ancillary Data for Multihoming Shim Sub-layer</a>
</li>
<li>7.1.   <a href="#rfc.section.7.1">Get Locator from Incoming Packet</a>
</li>
<li>7.2.   <a href="#rfc.section.7.2">Set Locator for Outgoing Packet</a>
</li>
<li>7.3.   <a href="#rfc.section.7.3">Notification from Application to Multihoming Shim Sub-layer</a>
</li>
<li>7.4.   <a href="#rfc.section.7.4">Applicability</a>
</li>
<li>8.   <a href="#rfc.section.8">Data Structures</a>
</li>
<li>8.1.   <a href="#rfc.section.8.1">Placeholder for Locator Information</a>
</li>
<li>8.1.1.   <a href="#rfc.section.8.1.1">Handling Locator behind NAT</a>
</li>
<li>8.2.   <a href="#rfc.section.8.2">Path Exploration Parameter</a>
</li>
<li>8.3.   <a href="#rfc.section.8.3">Feedback Information</a>
</li>
<li>9.   <a href="#rfc.section.9">System Requirements</a>
</li>
<li>10.   <a href="#rfc.section.10">Relation to Existing Sockets API Extensions</a>
</li>
<li>11.   <a href="#rfc.section.11">Operational Considerations</a>
</li>
<li>11.1.   <a href="#rfc.section.11.1">Conflict Resolution</a>
</li>
<li>11.2.   <a href="#rfc.section.11.2">Incompatibility between IPv4 and IPv6</a>
</li>
<li>12.   <a href="#rfc.section.12">IANA Considerations</a>
</li>
<li>13.   <a href="#rfc.section.13">Protocol Constants and Variables</a>
</li>
<li>14.   <a href="#rfc.section.14">Security Considerations</a>
</li>
<li>14.1.   <a href="#rfc.section.14.1">Treatment of Unknown Locator</a>
</li>
<li>14.1.1.   <a href="#rfc.section.14.1.1">Treatment of Unknown Source Locator</a>
</li>
<li>14.1.2.   <a href="#rfc.section.14.1.2">Treatment of Unknown Destination Locator</a>
</li>
<li>15.   <a href="#rfc.section.15">Changes</a>
</li>
<li>15.1.   <a href="#rfc.section.15.1">Changes from version 00 to version 01</a>
</li>
<li>15.2.   <a href="#rfc.section.15.2">Changes from version 01 to version 02</a>
</li>
<li>15.3.   <a href="#rfc.section.15.3">Changes from version 02 to version 03</a>
</li>
<li>15.4.   <a href="#rfc.section.15.4">Changes from version 03 to version 04</a>
</li>
<li>15.5.   <a href="#rfc.section.15.5">Changes from version 04 to version 05</a>
</li>
<li>15.6.   <a href="#rfc.section.15.6">Changes from version 05 to version 06</a>
</li>
<li>15.7.   <a href="#rfc.section.15.7">Changes from version 06 to version 07</a>
</li>
<li>15.8.   <a href="#rfc.section.15.8">Changes from version 07 to version 08</a>
</li>
<li>15.9.   <a href="#rfc.section.15.9">Changes from version 08 to version 09</a>
</li>
<li>15.10.   <a href="#rfc.section.15.10">Changes from version 09 to version 10</a>
</li>
<li>15.11.   <a href="#rfc.section.15.11">Changes from version 10 to version 11</a>
</li>
<li>15.12.   <a href="#rfc.section.15.12">Changes from version 11 to version 12</a>
</li>
<li>15.13.   <a href="#rfc.section.15.13">Changes from version 12 to version 13</a>
</li>
<li>15.14.   <a href="#rfc.section.15.14">Changes from version 13 to version 14</a>
</li>
<li>15.15.   <a href="#rfc.section.15.15">Changes from version 14 to version 15</a>
</li>
<li>15.16.   <a href="#rfc.section.15.16">Changes from version 15 to version 16</a>
</li>
<li>16.   <a href="#rfc.section.16">Acknowledgments</a>
</li>
<li>17.   <a href="#rfc.references">References</a>
</li>
<li>17.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>17.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Context Forking</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">This document defines socket API extensions by which upper layer protocols may be informed about and control the way in which a multihoming shim sub-layer in the IP layer manages the dynamic choice of locators.  Initially it applies to SHIM6 and HIP, but it is defined generically.</p>
<p id="rfc.section.1.p.2">The role of the multihoming shim sub-layer (hereafter called "shim sub-layer" in this document) is to avoid impacts to upper layer protocols which may be caused when the endhost changes its attachment point to the Internet, for instance, in the case of rehoming event under the multihomed environment.  There is, however, a need for API in the cases where 1) the upper layer protocol is particularly sensitive to impacts, or 2) the upper layer protocol wants to benefit from better knowledge of what is going on underneath.</p>
<p id="rfc.section.1.p.3">There are various kinds of technologies that aim to solve the same issue, the multihoming issue.  Note that there will be conflict when more than one shim sub-layer is active at the same time.  The assumption made in this document is that there is only a single shim sub-layer (HIP or SHIM6) activated on the system.  </p>
<p id="rfc.section.1.p.4">In this document, syntax and semantics of the API are given in the same way as in the Posix standard <a href="#POSIX">[POSIX]</a>.  The API specifies how to use ancillary data (aka cmsg) to access the locator information with recvmsg() and/or sendmsg() I/O calls.  The API is described in C language and data types are defined in the Posix format; intN_t means a signed integer of exactly N bits (e.g. int16_t) and uintN_t means an unsigned integer of exactly N bits (e.g. uint32_t).</p>
<p id="rfc.section.1.p.5">The distinction between "connected" sockets and "unconnected" sockets is important when discussing the applicability of the socket API defined in this document.  A connected socket is bound to a given peer, whereas an unconnected socket is not bound to any specific peers.  A TCP socket becomes a connected socket when the TCP connection establishment is completed.  UDP sockets are unconnected, unless the application uses the connect() system call.</p>
<p id="rfc.section.1.p.6">The target readers of this document are application programmers who develop application software which may benefit greatly from multihomed environments.  In addition, this document aims to provide necessary information for developers of shim protocols to implement API for enabling advanced locator management.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Requirements Language</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Terminology</h1>
<p id="rfc.section.3.p.1">This section provides terminology used in this document.  Basically most of the terms used in this document are taken from the following documents:<br><br> <br><br> In this document, the term "IP" refers to both IPv4 and IPv6, unless the protocol version is specifically mentioned.  The following are definitions of terms frequently used in this document:<br><br> </p>

<ul>
<li>SHIM6 Protocol Specification<a href="#RFC5533">[RFC5533]</a>
</li>
<li>HIP Architecture<a href="#RFC4423">[RFC4423]</a>
</li>
<li>Reachability Protocol (REAP)<a href="#RFC5534">[RFC5534]</a>
</li>
</ul>

<p> </p>

<ul>
<li>Endpoint identifier (EID) - The identifier used by the application to specify the endpoint of a given communication.  Applications may handle EIDs in various ways such as long-lived connections, callbacks, and referrals<a href="#I-D.ietf-shim6-app-refer">[I-D.ietf-shim6-app-refer]</a>.  <ul>
<li>In the case of SHIM6, an identifier called a ULID (Upper Layer Identifier) serves as an EID.  A ULID is chosen from locators available on the host.</li>
<li>In the case of HIP, an identifier called a Host Identifier serves as an EID.  A Host Identifier is derived from the public key of a given host.  For the sake of backward compatibility with the sockets API, the Host Identifier is represented in a form of hash of public key.  </li>
<li>Note that the EID appears in the standard socket API as an address, and does not appear in the extensions defined in this document, which only concern locators.</li>
</ul>
<p> </p>
</li>
<li>Locator - The IP address actually used to deliver IP packets.  Locators are present in the source and destination fields of the IP header of a packet on the wire.  Locator discussed in this document could be either an IPv4 address or an IPv6 address.  Note that HIP can handle both IPv4 and IPv6 locators, whereas SHIM6 can handle only IPv6 locators.  For the HIP case, locator can be a private IPv4 address when the host is behind a NAT.  Section <a href="#sec-locator-behind-nat">Section 8.1.1</a> gives detailed description about handling of locator behind NAT.  <ul>
<li>List of locators - A list of locators associated with an EID.  There are two lists of locators stored in a given context.  One is associated with the local EID and the other is associated with the remote EID.  As defined in <a href="#RFC5533">[RFC5533]</a>, the list of locators associated with an EID 'A' is denoted as Ls(A).</li>
<li>Preferred locator - The (source/destination) locator currently used to send packets within a given context.</li>
<li>Unknown locator - Any locator that does not appear in the locator list of the shim context associated with the socket.  When there is no shim context associated with the socket, any source and/or destination locator requested by the application is considered to be unknown locator.</li>
<li>Valid locator - A valid locator means that the locator is considered to be valid in the security sense.  More specifically, the validity indicates whether the locator is part of a HBA set.</li>
<li>Verified locator - A verified locator means that the locator is considered to be reachable according to the result of REAP return routability check.  Note that the verification applies only to peer's locator.</li>
</ul>
<p> </p>
</li>
<li>Shim - The conceptual sub-layer inside the IP layer which maintains mappings between EIDs and locators.  An EID can be associated with more than one locator at a time when the host is multihomed.  The term 'shim' does not refer to a specific protocol but refers to the conceptual sub-layer inside the IP layer.</li>
<li>Identifier/locator adaptation - The adaptation performed at the shim sub-layer which may end up re-writing the source and/or destination addresses of an IP packet.  In the outbound packet processing, the EID pair is converted to the associated locator pair.  In the inbound packet processing, the locator pair is converted to the EID pair.</li>
<li>Context - The state information shared by a given pair of peers, which stores a binding between the EID and associated locators.  Contexts are maintained by the shim sub-layer.</li>
<li>Reachability detection - The procedure to check reachability between a given locator pair.</li>
<li>Path - The sequence of routers that an IP packet goes through to reach the destination.</li>
<li>Path exploration - The procedure to explore available paths for a given set of locator pairs.</li>
<li>Outage - The incident that prevents IP packets to flow from the source locator to the destination locator.  When there is an outage, it means that there is no reachability between a given locator pair.  The outage may be caused by various reasons, such as shortage of network resources, congestion, and human error (faulty operation).</li>
<li>Working address pair - The address pair is considered to be "working" if the packet can safely travel from the source to the destination where the packet contains the first address from the pair as the source address and the second address from the pair as the destination address.  If reachability is confirmed in both directions, the address pair is considered to be working bi-directionally.</li>
<li>Reachability protocol (REAP) - The protocol for detecting failure and exploring reachability in a multihomed environment.  REAP is defined in <a href="#RFC5534">[RFC5534]</a>.</li>
</ul>

<p> </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#sec-system-overview" id="sec-system-overview">System Overview</a>
</h1>
<p><a href="#fig-system-overview">Figure 1</a> illustrates the system overview.  The shim sub-layer and REAP component exist inside the IP layer.  Applications use the sockets API defined in this document to interface with the shim sub-layer and the transport layer for locator management, failure detection, and path exploration.</p>
<p id="rfc.section.4.p.2">It may also be possible that the shim sub-layer interacts with the transport layer, however, such an interaction is outside the scope of this document.</p>
<div id="#rfc.figure.1"></div>
<div id="#fig-system-overview"></div>
<pre>

                     +------------------------+
                     |       Application      |
                     +------------------------+
                        ^                 ^ 
           ~~~~~~~~~~~~~|~Socket Interface|~~~~~~~~~~~~~~
                        |                 v
            +-----------|------------------------------+
            |           |  Transport Layer             |
            +-----------|------------------------------+
                  ^     |
    +-------------|-----|-------------------------------------+
    |             v     v                                     |
    |   +-----------------------------+       +----------+    |  IP 
    |   |            Shim             |&lt;-----&gt;|   REAP   |    | Layer
    |   +-----------------------------+       +----------+    |
    |                       ^                      ^          |
    +-----------------------|----------------------|----------+
                            v                      v
            +------------------------------------------+
            |                Link Layer                |
            +------------------------------------------+ 

	    </pre>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#sec-requirements" id="sec-requirements">Requirements</a>
</h1>
<p id="rfc.section.5.p.1">The following is a list of requirements from applications: </p>

<ul>
<li>Turn on/off shim.  An application should be able to request to turn on or turn off the multihoming support by the shim layer: <ul>
<li>Apply shim.  The application should be able to explicitly request the shim sub-layer to apply multihoming support.</li>
<li>Don't apply shim.  The application should be able to request the shim sub-layer not to apply the multihoming support but to apply normal IP processing at the IP layer.</li>
<li>Note that this function is also required by other types of multihoming mechanisms such as SCTP and multipath TCP to avoid potential conflict with the shim sub-layer.</li>
</ul>
<p> </p>
</li>
<li>Locator management.  <ul>
<li>It should be possible to set preferred source and/or destination locator within a given context.</li>
<li>It should be possible to get preferred source and/or destination locator within a given context.</li>
<li>It should be possible to set a list of source and/or destination locators within a given context: Ls(local) and Ls(remote).</li>
<li>It should be possible to get a list of source and/or destination locators within a given context: Ls(local) and Ls(remote).</li>
</ul>
<p> </p>
</li>
<li>Notification from applications to the shim sub-layer about the status of the communication.  The notification occurs in an event-based manner.  Applications and/or upper layer protocols may provide positive feedback or negative feedback to the shim sub-layer.  Note that these feedback are mentioned in <a href="#RFC5534">[RFC5534]</a>: <ul>
<li>Applications and/or upper layer protocols (e.g., TCP) may provide positive feedback to the shim sub-layer informing that the communication is going well.</li>
<li>Applications and/or upper layer protocols (e.g., TCP) may provide negative feedback to the shim sub-layer informing that the communication status is not satisfactory.  TCP may detect a problem when it does not receive any expected ACK message from the peer.  The REAP module may be triggered by these negative feedback and invoke the path exploration procedure.</li>
</ul>
<p> </p>
</li>
<li>Feedback from applications to the shim sub-layer.  Applications should be able to inform the shim sub-layer of the timeout values for detecting failures, sending keepalives, and starting the exploration procedure.  In particular, applications should be able to suppress keepalives.  </li>
<li>Hot-standby.  Applications may request the shim sub-layer for the hot-standby capability.  This means that, alternative paths are known to be working in advance of a failure detection.  In such a case, it is possible for the host to immediately replace the current locator pair with an alternative locator pair.  </li>
<li>Eagerness for locator exploration.  An application should be able to inform the shim sub-layer of how aggressively it wants the REAP mechanism to perform a path exploration (e.g., by specifying the number of concurrent attempts of discovery of working locator pairs) when an outage occurs on the path between the locator pair in use.</li>
<li>Providing locator information to applications.  An application should be able to obtain information about the locator pair which was actually used to send or receive the packet.  <ul>
<li>For inbound traffic, the application may be interested in the locator pair which was actually used to receive the packet.  </li>
<li>For outbound traffic, the application may be interested in the locator pair which was actually used to transmit the packet.</li>
</ul>
<p> In this way, applications may have additional control on the locator management.  For example, an application becomes able to verify if its preference for locator is actually applied to the flow or not.  </p>
</li>
<li>Applications should be able to know if the shim-sublayer supports deferred context setup or not.</li>
<li>An application should be able to know if the communication is now being served by the shim sub-layer or not.</li>
<li>An application should be able to use a common interface to access an IPv4 locator and an IPv6 locator.</li>
</ul>

<p> </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#sec-shim-socket-options" id="sec-shim-socket-options">Socket Options for Multihoming Shim Sub-layer</a>
</h1>
<p id="rfc.section.6.p.1">In this section, socket options that are specific to the shim sub-layer are defined.</p>
<p><a href="#tab-shim-socket-options">Table 1</a> shows a list of the socket options that are specific to the shim sub-layer.  All of these socket options are defined at the level SOL_SHIM.  When an application uses one of the socket options by getsockopt() or setsockopt(), the second argument must be set as SOL_SHIM.</p>
<p id="rfc.section.6.p.3">The first column of <a href="#tab-shim-socket-options">Table 1</a> gives the name of the option.  The second and third columns indicate whether the option can be handled by the getsockopt() system call and/or by the setsockopt() system call.  The fourth column provides a brief description of the socket option.  The fifth column shows the type of data structure specified along with the socket option.  By default, the data structure type is an integer.</p>
<div id="#rfc.table.1"></div>
<div id="#tab-shim-socket-options"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<caption>Socket options for multihoming shim sub-layer</caption>
<thead><tr>
<th class="left">optname</th>
<th class="left">get</th>
<th class="left">set</th>
<th class="left">description</th>
<th class="left">dtype</th>
</tr></thead>
<tbody>
<tr>
<td class="left">SHIM_ASSOCIATED</td>
<td class="left">o</td>
<td class="left"></td>
<td class="left">Get the parameter (0 or 1) which indicates whether the socket is associated (1) with any shim context or not (0).</td>
<td class="left">int</td>
</tr>
<tr>
<td class="left">SHIM_DONTSHIM</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the parameter which indicates whether to employ the multihoming support by the shim sub-layer or not.</td>
<td class="left">int</td>
</tr>
<tr>
<td class="left">SHIM_HOT_STANDBY</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the parameter to request the shim sub-layer to prepare a hot-standby connection.</td>
<td class="left">int</td>
</tr>
<tr>
<td class="left">SHIM_LOC_LOCAL_PREF</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the preferred locator on the local side for the context associated with the socket.</td>
<td class="left">Note 1</td>
</tr>
<tr>
<td class="left">SHIM_LOC_PEER_PREF</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the preferred locator on the remote side for the context associated with the socket.</td>
<td class="left">Note 1</td>
</tr>
<tr>
<td class="left">SHIM_LOC_LOCAL_RECV</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Request the shim sub-layer to store the destination locator of the received IP packet in an ancillary data object.</td>
<td class="left">int</td>
</tr>
<tr>
<td class="left">SHIM_LOC_PEER_RECV</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Request the shim sub-layer to store the source locator of the received IP packet in an ancillary data object.</td>
<td class="left">int</td>
</tr>
<tr>
<td class="left">SHIM_LOC_LOCAL_SEND</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the source locator of outgoing IP packets.</td>
<td class="left">Note 1</td>
</tr>
<tr>
<td class="left">SHIM_LOC_PEER_SEND</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the destination locator of outgoing IP packets.</td>
<td class="left">Note 1</td>
</tr>
<tr>
<td class="left">SHIM_LOCLIST_LOCAL</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the list of locators associated with the local EID.</td>
<td class="left">Note 2</td>
</tr>
<tr>
<td class="left">SHIM_LOCLIST_PEER</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the list of locators associated with the peer's EID.</td>
<td class="left">Note 2</td>
</tr>
<tr>
<td class="left">SHIM_APP_TIMEOUT</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set the Send Timeout value of the REAP protocol.</td>
<td class="left">int</td>
</tr>
<tr>
<td class="left">SHIM_PATHEXPLORE</td>
<td class="left">o</td>
<td class="left">o</td>
<td class="left">Get or set parameters for path exploration and failure detection.</td>
<td class="left">Note 3</td>
</tr>
<tr>
<td class="left">SHIM_CONTEXT_DEFERRED_SETUP</td>
<td class="left">o</td>
<td class="left"></td>
<td class="left">Get the parameter which indicates whether deferred context setup is supported or not.</td>
<td class="left">int</td>
</tr>
</tbody>
</table>
<p id="rfc.section.6.p.4">Note 1: Pointer to a shim_locator which is defined in <a href="#sec-data-structures">Section 8</a>.</p>
<p id="rfc.section.6.p.5">Note 2: Pointer to an array of shim_locator.</p>
<p id="rfc.section.6.p.6">Note 3: Pointer to a shim_pathexplore which is defined in <a href="#sec-data-structures">Section 8</a>.</p>
<p><a href="#fig-socket-api-model">Figure 2</a> illustrates how the shim specific socket options fit into the system model of socket API.  The figure shows that the shim sub-layer and the additional protocol components (IPv4 and IPv6) below the shim sub-layer are new to the system model.  As previously mentioned, all the shim specific socket options are defined at the SOL_SHIM level.  This design choice brings the following advantages:<br><br> </p>

<ol>
<li>The existing sockets API continue to work at the layer above the shim sub-layer.  That is, those legacy API handle IP addresses as identifiers.</li>
<li>With newly defined socket options for the shim sub-layer, the application obtains additional control of locator management.</li>
<li>The shim specific socket options can be kept independent from address family (IPPROTO_IP or IPPROTO_IPV6) and transport protocol (IPPROTO_TCP or IPPROTO_UDP).</li>
</ol>

<p> </p>
<div id="#rfc.figure.2"></div>
<div id="#fig-socket-api-model"></div>
<pre>
	
                         s1 s2      s3 s4
                          |  |       |  |
         +----------------|--|-------|--|----------------+
         |             +-------+   +-------+             |
         | IPPROTO_TCP |  TCP  |   |  UDP  |             |
         |             +-------+   +-------+             |
         |                |   \     /   |                |
         |                |    -----    |                | 
         |                |   /     \   |                |
         |              +------+   +------+              |
         |   IPPROTO_IP | IPv4 |   | IPv6 | IPPROTO_IPV6 |
         |              +------+   +------+              |
         |                  \         /             SOL_SOCKET
         |          +--------\-------/--------+          |
         | SOL_SHIM |          shim           |          |
         |          +--------/-------\--------+          |
         |                  /         \                  |
         |              +------+   +------+              |
         |              | IPv4 |   | IPv6 |              |
         |              +------+   +------+              |
         |                  |          |                 |
         +------------------|----------|-----------------+
                            |          |
                          IPv4       IPv6
                        Datagram   Datagram

	 </pre>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> SHIM_ASSOCIATED</h1>
<p id="rfc.section.6.1.p.1">The SHIM_ASSOCIATED option is used to check whether the socket is associated with any shim context or not.</p>
<p id="rfc.section.6.1.p.2">This option is meaningful when the locator information of the received IP packet does not tell whether the identifier/locator adaptation is performed or not.  Note that the EID pair and the locator pair may be identical in some cases.</p>
<p id="rfc.section.6.1.p.3">This option can be specified by getsockopt().  Thus, the option is read-only and the result (0/1/2) is set in the option value (the fourth argument of getsockopt()).</p>
<p id="rfc.section.6.1.p.4">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.1.p.5">The data type of the option value is an integer.  The option value indicates the presence of shim context.  A return value 1 means that the socket is associated with a shim context at the shim sub-layer.  A return value 0 indicates that there is no shim context associated with the socket.  A return value 2 means that it is not known whether the socket is associated with a shim context or not, and this must be returned only when the socket is unconnected.  In other words, the returned value must be 0 or 1 when the socket is connected.</p>
<p id="rfc.section.6.1.p.6">For example, the option can be used by the application as follows:</p>
<div id="#rfc.figure.3"></div>
<pre>
    int optval;
    int optlen = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_ASSOCIATED, &amp;optval, &amp;optlen);
	  </pre>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> SHIM_DONTSHIM</h1>
<p id="rfc.section.6.2.p.1">The SHIM_DONTSHIM option is used to request the shim layer not to provide the multihoming support for the communication established over the socket.</p>
<p id="rfc.section.6.2.p.2">The data type of the option value is an integer, and it takes 0 or 1. An option value 0 means that the shim sub-layer is employed if available. An option value 1 means that the application does not want the shim sub-layer to provide the multihoming support for the communication established over the socket.</p>
<p id="rfc.section.6.2.p.3">Default value is set as 0, which means that the shim sub-layer performs identifier/locator adaptation if available.</p>
<p id="rfc.section.6.2.p.4">Any attempt to disable the multihoming shim support MUST be made by the application before the socket is connected.  If an application makes such an attempt for a connected-socket, an error code EOPNOTSUPP MUST be returned.</p>
<p id="rfc.section.6.2.p.5">For example, an application can request the system not to apply the multihoming support as follows:</p>
<div id="#rfc.figure.4"></div>
<pre>
    int optval;

    optval = 1;

    setsockopt(fd, SOL_SHIM, SHIM_DONTSHIM, &amp;optval, sizeof(optval));
    </pre>
<p id="rfc.section.6.2.p.6">For example, the application can check the option value as follows:</p>
<div id="#rfc.figure.5"></div>
<pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_DONTSHIM, &amp;optval, &amp;len);
    </pre>
<h1 id="rfc.section.6.3">
<a href="#rfc.section.6.3">6.3.</a> SHIM_HOT_STANDBY</h1>
<p id="rfc.section.6.3.p.1">The SHIM_HOT_STANDBY option is used to control the shim sub-layer whether to employ a hot-standby connection for the socket or not.  A hot-standby connection is an alternative working locator pair to the current locator pair.  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.3.p.2">The data type of the option value is an integer.</p>
<p id="rfc.section.6.3.p.3">The option value can be set by setsockopt().</p>
<p id="rfc.section.6.3.p.4">The option value can be read by getsockopt().</p>
<p id="rfc.section.6.3.p.5">By default, the value is set to 0, meaning that hot-standby connection is disabled.</p>
<p id="rfc.section.6.3.p.6">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.3.p.7">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.3.p.8">For example, an application can request establishment of a hot-standby connection by using the socket option as follows:</p>
<div id="#rfc.figure.6"></div>
<pre>
    int optval;

    optval = 1;

    setsockopt(fd, SOL_SHIM, SHIM_HOT_STANDBY, &amp;optval,
               sizeof(optval));
    </pre>
<p id="rfc.section.6.3.p.9">For example, an application can get the option value by using the socket option as follows:</p>
<div id="#rfc.figure.7"></div>
<pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_HOT_STANDBY, &amp;optval, &amp;len);
    </pre>
<h1 id="rfc.section.6.4">
<a href="#rfc.section.6.4">6.4.</a> SHIM_LOC_LOCAL_PREF</h1>
<p id="rfc.section.6.4.p.1">The SHIM_LOC_LOCAL_PREF option is used to get or set preference for a source locator for outbound traffic within a given context.  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.4.p.2">The preference of a locator is defined by a combination of priority and weight as per DNS SRV<a href="#RFC2782">[RFC2782]</a>.  Note that the SHIM6 base protocol defines preference of locator in the same way.</p>
<p id="rfc.section.6.4.p.3">The data type of the option value is a pointer to a locator information data structure which is defined in <a href="#sec-data-structures">Section 8</a>.</p>
<p id="rfc.section.6.4.p.4">By default, the option value is set to NULL, meaning that the option is disabled.</p>
<p id="rfc.section.6.4.p.5">The preferred locator can be set by setsockopt().  The shim sub-layer shall verify requested locator before it updates the preferred locator.</p>
<p id="rfc.section.6.4.p.6">An application can get the preferred locator by getsockopt().</p>
<p id="rfc.section.6.4.p.7">An application needs to get or set preference for each address, one by one.</p>
<p id="rfc.section.6.4.p.8">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.4.p.9">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.4.p.10">An error EINVALIDLOCATOR is returned when the validation of the specified locator fails.</p>
<p id="rfc.section.6.4.p.11">For example, an application can set the preferred locator by using the socket option as follows.  Note that some members of the shim_locator (lc_ifidx and lc_flags) are ignored in the set operation.</p>
<div id="#rfc.figure.8"></div>
<pre>
    struct shim_locator lc;
    struct in6_addr ip6;

    /* ...set the locator (ip6)... */

    memset(&amp;lc, 0, sizeof(shim_locator));
    lc.lc_family = AF_INET6;  /* IPv6 */
    lc.lc_ifidx = 0;
    lc.lc_flags = 0;
    lc.lc_prio = 1;
    lc.lc_weight = 10;
    memcpy(&amp;lc.lc_addr, &amp;ip6, sizeof(in6_addr)); 

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_PREF, &amp;lc,
               sizeof(optval));
    </pre>
<p id="rfc.section.6.4.p.12">For example, an application can get the preferred locator by using the socket option as follows.</p>
<div id="#rfc.figure.9"></div>
<pre>
    struct shim_locator lc;
    int len;

    len = sizeof(lc);

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_PREF, &amp;lc, &amp;len);
    </pre>
<h1 id="rfc.section.6.5">
<a href="#rfc.section.6.5">6.5.</a> SHIM_LOC_PEER_PREF</h1>
<p id="rfc.section.6.5.p.1">The SHIM_LOC_PEER_PREF option is used to get or set preference of a destination locator for outbound traffic within a given context.  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.5.p.2">As defined earlier, the preference of a locator is defined by a combination of priority and weight as per DNS SRV<a href="#RFC2782">[RFC2782]</a>.  When there are more than one candidate destination locators, the shim sub-layer makes selection based on the priority and weight specified for each locator.</p>
<p id="rfc.section.6.5.p.3">The data type of the option value is a pointer to the locator information data structure which is defined in <a href="#sec-data-structures">Section 8</a>.</p>
<p id="rfc.section.6.5.p.4">By default, the option value is set to NULL, meaning that the option is disabled.</p>
<p id="rfc.section.6.5.p.5">The preferred locator can be set by setsockopt().  The shim sub-layer shall verify requested locator before it updating the preferred locator.</p>
<p id="rfc.section.6.5.p.6">An application can get the preferred locator by getsockopt().</p>
<p id="rfc.section.6.5.p.7">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.5.p.8">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.5.p.9">An error EINVALIDLOCATOR is returned when the validation of the requested locator fails.</p>
<p id="rfc.section.6.5.p.10">An error EUNREACHABLELOCATOR is returned when the requested locator is determined to be not reachable according to a reachability check.</p>
<p id="rfc.section.6.5.p.11">The usage of the option is same as that of SHIM_LOC_LOCAL_PREF.  Note that some members of the shim_locator (lc_ifidx and lc_flags) are ignored in the set operation.</p>
<h1 id="rfc.section.6.6">
<a href="#rfc.section.6.6">6.6.</a> SHIM_LOC_LOCAL_RECV</h1>
<p id="rfc.section.6.6.p.1">The SHIM_LOC_LOCAL_RECV option can be used to request the shim sub-layer to store the destination locator of the received IP packet in an ancillary data object which can be accessed by recvmsg().  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.6.p.2">The data type of the option value is integer. The option value should be binary (0 or 1).  By default, the option value is set to 0, meaning that the option is disabled.</p>
<p id="rfc.section.6.6.p.3">An application can set the option value by setsockopt().</p>
<p id="rfc.section.6.6.p.4">An application can get the option value by getsockopt().</p>
<p id="rfc.section.6.6.p.5">See <a href="#sec-access-to-locinfo">Section 7</a> for the procedure to access locator information stored in the ancillary data objects.</p>
<p id="rfc.section.6.6.p.6">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.6.p.7">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.6.p.8">For example, an application can request the shim sub-layer to store destination locator by using the socket option as follows.</p>
<div id="#rfc.figure.10"></div>
<pre>
    int optval;

    optval = 1;

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, &amp;optval,
               sizeof(optval));
    </pre>
<p id="rfc.section.6.6.p.9">For example, an application can get the option value as follows.</p>
<div id="#rfc.figure.11"></div>
<pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, &amp;optval, &amp;len);
    </pre>
<h1 id="rfc.section.6.7">
<a href="#rfc.section.6.7">6.7.</a> SHIM_LOC_PEER_RECV</h1>
<p id="rfc.section.6.7.p.1">The SHIM_LOC_PEER_RECV option is used to request the shim sub-layer to store the source locator of the received IP packet in an ancillary data object which can be accessed by recvmsg().  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.7.p.2">The data type of the option value is integer. The option value should be binary (0 or 1).  By default, the option value is set to 0, meaning that the option is disabled.</p>
<p id="rfc.section.6.7.p.3">The option value can be set by setsockopt().</p>
<p id="rfc.section.6.7.p.4">The option value can be read by getsockopt().</p>
<p id="rfc.section.6.7.p.5">See <a href="#sec-access-to-locinfo">Section 7</a> for the procedure to access locator information stored in the ancillary data objects.</p>
<p id="rfc.section.6.7.p.6">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.7.p.7">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.7.p.8">The usage of the option is same as that of SHIM_LOC_LOCAL_RECV option.</p>
<h1 id="rfc.section.6.8">
<a href="#rfc.section.6.8">6.8.</a> SHIM_LOC_LOCAL_SEND</h1>
<p id="rfc.section.6.8.p.1">The SHIM_LOC_LOCAL_SEND option is used to request the shim sub-layer to use a specific locator as the source locator for the IP packets to be sent from the socket.  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.8.p.2">The data type of option value is pointer to shim_locator data structure.</p>
<p id="rfc.section.6.8.p.3">An application can set the local locator by setsockopt() providing a locator which is stored in a shim_locator data structure.  When a zero-filled locator is specified, pre-existing setting of local locator is inactivated.</p>
<p id="rfc.section.6.8.p.4">An application can get the local locator by getsockopt().</p>
<p id="rfc.section.6.8.p.5">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.8.p.6">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.8.p.7">An error EINVALIDLOCATOR is returned when an invalid locator is specified.</p>
<p id="rfc.section.6.8.p.8">For example, an application can request the shim sub-layer to use a specific local locator by using the socket option as follows.</p>
<div id="#rfc.figure.12"></div>
<pre>
    struct shim_locator locator;
    struct in6_addr ia6;

    /* an IPv6 address preferred for the source locator is copied
       to the parameter ia6 */

    memset(&amp;locator, 0, sizeof(locator));

    /* fill shim_locator data structure */
    locator.lc_family = AF_INET6;
    locator.lc_ifidx = 1;
    locator.lc_flags = 0;
    locator.lc_prio = 0;
    locator.lc_weight = 0;
    memcpy(&amp;locator.lc_addr, &amp;ia6, sizeof(ia6));

    setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_SEND, &amp;locator,
               sizeof(locator));
    </pre>
<p id="rfc.section.6.8.p.9">For example, an application can get the designated local locator by using the socket option as follows:</p>
<div id="#rfc.figure.13"></div>
<pre>
    struct shim_locator locator;

    memset(&amp;locator, 0, sizeof(locator));

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_SEND, &amp;locator,
               sizeof(locator));

    /* check locator */
    </pre>
<h1 id="rfc.section.6.9">
<a href="#rfc.section.6.9">6.9.</a> SHIM_LOC_PEER_SEND</h1>
<p id="rfc.section.6.9.p.1">The SHIM_LOC_PEER_SEND option is used to request the shim sub-layer to use a specific locator for the destination locator of IP packets to be sent from the socket.  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.9.p.2">The data type of the option value is a pointer to shim_locator data structure.</p>
<p id="rfc.section.6.9.p.3">An application can set the remote locator by setsockopt() providing a locator which is stored in a shim_locator data structure.  When a zero-filled locator is specified, pre-existing setting of remote locator is inactivated.</p>
<p id="rfc.section.6.9.p.4">An application can get the specified remote locator by getsockopt().</p>
<p id="rfc.section.6.9.p.5">The difference between the SHIM_LOC_PEER_SEND option and the SHIM_LOC_PEER_PREF option is that the former guarantee the use of requested locator when applicable whereas the latter does not.</p>
<p id="rfc.section.6.9.p.6">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.9.p.7">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.9.p.8">An error EINVALIDLOCATOR is returned when the validation of the requested locator fails.</p>
<p id="rfc.section.6.9.p.9">An error EUNVERIFIEDLOCATOR is returned when reachability for the requested locator has not been verified yet.</p>
<p id="rfc.section.6.9.p.10">An error EUNREACHABLELOCATOR is returned when the requested locator is determined to be not reachable according to a reachability check.</p>
<p id="rfc.section.6.9.p.11">The usage of the option is the same as that of SHIM_LOC_LOCAL_SEND option.</p>
<h1 id="rfc.section.6.10">
<a href="#rfc.section.6.10">6.10.</a> SHIM_LOCLIST_LOCAL</h1>
<p id="rfc.section.6.10.p.1">The SHIM_LOCLIST_LOCAL option is used to get or set the locator list associated with the local EID of the shim context associated with the socket.  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.10.p.2">The data type of the option value is a pointer to the buffer in which a locator list is stored.  See <a href="#sec-data-structures">Section 8</a> for the data structure for storing the locator information.  By default, the option value is set to NULL, meaning that the option is disabled.</p>
<p id="rfc.section.6.10.p.3">An application can get the locator list by getsockopt().  Note that the size of the buffer pointed to by the optval argument should be large enough to store an array of locator information.  The number of the locator information is not known beforehand.</p>
<p id="rfc.section.6.10.p.4">The local locator list can be set by setsockopt().  The buffer pointed to by the optval argument should contain an array of locator structures.</p>
<p id="rfc.section.6.10.p.5">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.10.p.6">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.10.p.7">An error EINVALIDLOCATOR is returned when the validation of any of the specified locators failed.</p>
<p id="rfc.section.6.10.p.8">An error ETOOMANYLOCATORS is returned when the number of locators specified exceeds the limit (SHIM_MAX_LOCATORS), or when the size of the buffer provided by the application is not large enough to store the locator list provided by the shim sub-layer.</p>
<p id="rfc.section.6.10.p.9">For example, an application can set a list of locators to be associated with the local EID by using the socket option as follows.  Note that IPv4 locator can be handled by HIP and not by SHIM6.</p>
<div id="#rfc.figure.14"></div>
<pre>
    struct shim_locator locators[SHIM_MAX_LOCATORS];
    struct sockaddr_in *sin;
    struct sockaddr_in6 *sin6;

    memset(locators, 0, sizeof(locators));

    ...

    /* obtain local IP addresses from local interfaces */

    ...

    /* first locator (an IPv6 address) */
    locators[0].lc_family = AF_INET6;
    locators[0].lc_ifidx = 0;
    locators[0].lc_flags = 0;
    locators[0].lc_prio = 1;
    locators[0].lc_weight = 0;
    memcpy(&amp;locators[0].lc_addr, &amp;sa6-&gt;sin6_addr,
           sizeof(sa6-&gt;sin6_addr));

    ...

    /* second locator (an IPv4 address) */
    locators[1].lc_family = AF_INET;
    locators[1].lc_ifidx = 0;
    locators[1].lc_flags = 0;
    locators[1].lc_prio = 0;
    locators[1].lc_weight = 0;
    memcpy(&amp;locators[1].lc_addr, &amp;sa-&gt;sin_addr,
           sizeof(sa-&gt;sin_addr));

    setsockopt(fd, SOL_SHIM, SHIM_LOCLIST_LOCAL, locators,
               sizeof(locators));
	       </pre>
<p id="rfc.section.6.10.p.10">For example, an application can get a list of locators that are associated with the local EID by using the socket option as follows.</p>
<div id="#rfc.figure.15"></div>
<pre>
    struct shim_locator locators[SHIM_MAX_LOCATORS];

    memset(locators, 0, sizeof(locators));

    getsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_RECV, locators,
               sizeof(locators));

    /* parse locators */
    ...

    </pre>
<h1 id="rfc.section.6.11">
<a href="#rfc.section.6.11">6.11.</a> SHIM_LOCLIST_PEER</h1>
<p id="rfc.section.6.11.p.1">The SHIM_LOCLIST_PEER option is used to get or set the locator list associated with the peer EID of the shim context associated with the socket.  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.11.p.2">The data type of the option value is a pointer to the buffer where a locator list is stored.  See <a href="#sec-data-structures">Section 8</a> for the data structure for storing the locator information.  By default, the option value is set to NULL, meaning that the option is disabled.</p>
<p id="rfc.section.6.11.p.3">An application can get the locator list by getsockopt().  Note that the size of the buffer pointed to by the optval argument should be large enough to store an array of locator information.  The number of the locator information is not known beforehand.</p>
<p id="rfc.section.6.11.p.4">An application can set the locator list by setsockopt().  The buffer pointed to by the optval argument should contain an array of locator list.</p>
<p id="rfc.section.6.11.p.5">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.11.p.6">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.11.p.7">An error EINVALIDLOCATOR is returned when the validation of any of the specified locators failed.</p>
<p id="rfc.section.6.11.p.8">An error EUNVERIFIEDLOCATOR is returned when reachability for the requested locator has not been verified yet.</p>
<p id="rfc.section.6.11.p.9">An error EUNREACHABLELOCATOR is returned when the requested locator is determined to be not reachable according to a reachability check.</p>
<p id="rfc.section.6.11.p.10">An error ETOOMANYLOCATORS is returned when the number of locators specified exceeds the limit (SHIM_MAX_LOCATORS), or when the size of the buffer provided by the application is not large enough to store the locator list provided by the shim sub-layer.</p>
<p id="rfc.section.6.11.p.11">The usage of the option is same as that of SHIM_LOCLIST_LOCAL.</p>
<h1 id="rfc.section.6.12">
<a href="#rfc.section.6.12">6.12.</a> SHIM_APP_TIMEOUT</h1>
<p id="rfc.section.6.12.p.1">The SHIM_APP_TIMEOUT option is used to get or set the Send Timeout value of the REAP protocol<a href="#RFC5534">[RFC5534]</a>.  This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.12.p.2">The data type of the option value is an integer.  The value indicates the period of timeout in seconds to send a REAP Keepalive message since the last outbound traffic.  By default, the option value is set to 0, meaning that the option is disabled.  When the option is disabled, the REAP mechanism follows its default value of Send Timeout value as specified in <a href="#RFC5534">[RFC5534]</a></p>
<p id="rfc.section.6.12.p.3">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.12.p.4">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.12.p.5">When there is no REAP protocol instance on the system, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.12.p.6">For example, an application can set the timeout value by using the socket option as follows.</p>
<div id="#rfc.figure.16"></div>
<pre>
    int optval;

    optval = 15; /* 15 seconds */

    setsockopt(fd, SOL_SHIM, SHIM_APP_TIMEOUT, &amp;optval,
               sizeof(optval));
    </pre>
<p id="rfc.section.6.12.p.7">For example, an application can get the timeout value by using the socket option as follows.</p>
<div id="#rfc.figure.17"></div>
<pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_APP_TIMEOUT, &amp;optval, &amp;len);
    </pre>
<h1 id="rfc.section.6.13">
<a href="#rfc.section.6.13">6.13.</a> SHIM_PATHEXPLORE</h1>
<p id="rfc.section.6.13.p.1">The application may use this socket option to get or set parameters concerning path exploration.  Path exploration is a procedure to find an alternative locator pair to the current locator pair.  As the REAP specification defines, a peer may send Probe messages to find an alternative locator pair.</p>
<p id="rfc.section.6.13.p.2">This option is effective only when there is a shim context associated with the socket.</p>
<p id="rfc.section.6.13.p.3">The data type of the option value is a pointer to the buffer where a set of information for path exploration is stored.  The data structure is defined in <a href="#sec-data-structures">Section 8</a>.</p>
<p id="rfc.section.6.13.p.4">By default, the option value is set to NULL, meaning that the option is disabled.</p>
<p id="rfc.section.6.13.p.5">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.13.p.6">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.6.13.p.7">For example, an application can set parameters for path exploration by using the socket option as follows.</p>
<div id="#rfc.figure.18"></div>
<pre>
    struct shim6_pathexplore pe;

    pe.pe_probenum = 4;        /* times */
    pe.pe_keepaliveto = 10;    /* seconds */
    pe.pe_initprobeto = 500;   /* milliseconds */
    pe.pe_reserved = 0;

    setsockopt(fd, SOL_SHIM, SHIM_PATHEXPLORE, &amp;pe, sizeof(pe));
    </pre>
<p id="rfc.section.6.13.p.8">For example, an application can get parameters for path exploration by using the socket option as follows.</p>
<div id="#rfc.figure.19"></div>
<pre>
    struct shim6_pathexplore pe;
    int len;

    len = sizeof(pe);

    getsockopt(fd, SOL_SHIM, SHIM_PATHEXPLORE, &amp;pe, &amp;len);
    </pre>
<h1 id="rfc.section.6.14">
<a href="#rfc.section.6.14">6.14.</a> SHIM_DEFERRED_CONTEXT_SETUP</h1>
<p id="rfc.section.6.14.p.1">The SHIM_DEFERRED_CONTEXT_SETUP option is used to check whether deferred context setup is possible or not.  Deferred context setup means that the context is established in parallel with the data communication.  Note that SHIM6 supports deferred context setup and HIP does not because EIDs in HIP (i.e., Host Identifiers) are non-routable.</p>
<p id="rfc.section.6.14.p.2">The data type for the option value is an integer.  The option value should be binary (0 or 1).  The option value 1 means that the shim sub-layer supports deferred context setup.  </p>
<p id="rfc.section.6.14.p.3">When the application specifies the socket option to an unconnected socket, an error code EOPNOTSUPP is returned to the application.</p>
<p id="rfc.section.6.14.p.4">For example, an application can check whether deferred context setup is possible or not as follows:</p>
<div id="#rfc.figure.20"></div>
<pre>
    int optval;
    int len;

    len = sizeof(optval);

    getsockopt(fd, SOL_SHIM, SHIM_DEFERRED_CONTEXT_SETUP,
               &amp;optval, &amp;len);
	       </pre>
<h1 id="rfc.section.6.15">
<a href="#rfc.section.6.15">6.15.</a> <a href="#sec-socket-options-applicability" id="sec-socket-options-applicability">Applicability</a>
</h1>
<p id="rfc.section.6.15.p.1">All the socket options defined in this section except for the SHIM_DONTSHIM option are applicable to applications that use connected sockets.</p>
<p id="rfc.section.6.15.p.2">All the socket options defined in this section except for the SHIM_ASSOCIATED, SHIM_DONTSHIM and SHIM_CONTEXT_DEFERRED_SETUP options are effective only when there is a shim context associated with the socket.</p>
<h1 id="rfc.section.6.16">
<a href="#rfc.section.6.16">6.16.</a> Error Handling</h1>
<p id="rfc.section.6.16.p.1">If successful, getsockopt() and setsockopt() return 0; otherwise, the functions return -1 and set errno to indicate an error.</p>
<p id="rfc.section.6.16.p.2">The following are new error values defined for some shim specific socket options indicating that the getsockopt() or setsockopt() finished incompletely:<br><br> </p>

<dl>
<dt>EINVALIDLOCATOR</dt>
<dd style="margin-left: 8">
<br>This indicates that the locator is not part of the HBA set<a href="#RFC5535">[RFC5535]</a> within the shim context associated with the socket.</dd>
<dt>EUNVERIFIEDLOCATOR</dt>
<dd style="margin-left: 8">
<br>This indicates that the reachability of the locator has not been confirmed.  This error is applicable to only peer's locator.</dd>
<dt>EUNREACHABLELOCATOR</dt>
<dd style="margin-left: 8">
<br>This indicates that the locator is not reachable according to the result of the reachability check.  This error is applicable to only peer's locator.</dd>
</dl>

<p> </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#sec-access-to-locinfo" id="sec-access-to-locinfo">Ancillary Data for Multihoming Shim Sub-layer</a>
</h1>
<p id="rfc.section.7.p.1">This section provides definitions of ancillary data to be used for locator management and notification from/to the shim sub-layer to/from application.</p>
<p id="rfc.section.7.p.2">When the application performs locator management by sendmsg() or recvmsg(), a member of the msghdr structure (given in <a href="#fig-msghdr">Figure 21</a>) called msg_control holds a pointer to the buffer in which one or more shim specific ancillary data objects may be stored.  An ancillary data object can store a single locator.  It should be possible to process the shim specific ancillary data object by the existing macros defined in the Posix standard and <a href="#RFC3542">[RFC3542]</a>.</p>
<div id="#rfc.figure.21"></div>
<div id="#fig-msghdr"></div>
<pre>
     struct msghdr {
             caddr_t msg_name;       /* optional address */
             u_int   msg_namelen;    /* size of address */
             struct  iovec *msg_iov; /* scatter/gather array */
             u_int   msg_iovlen;     /* # elements in msg_iov */
             caddr_t msg_control;    /* ancillary data, see below */
             u_int   msg_controllen; /* ancillary data buffer len */
             int     msg_flags;      /* flags on received message */
     };
    </pre>
<p id="rfc.section.7.p.3">In the case of unconnected socket, msg_name stores the socket address of the peer which should be considered to be an identifier rather than a locator.  SHIM_LOC_PEER_RECV should be used to get the locator of the peer node.</p>
<p><a href="#tab-shim-ancillary-data">Table 2</a> is a list of the shim specific ancillary data which can be used for locator management by recvmsg() or sendmsg().  In any case, the value of cmsg_level must be set as SOL_SHIM.</p>
<div id="#rfc.table.2"></div>
<div id="#tab-shim-ancillary-data"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<caption>Shim specific ancillary data</caption>
<thead><tr>
<th class="left">cmsg_type</th>
<th class="center">sendmsg()</th>
<th class="center">recvmsg()</th>
<th class="center">cmsg_data[]</th>
</tr></thead>
<tbody>
<tr>
<td class="left">SHIM_LOC_LOCAL_RECV</td>
<td class="center"></td>
<td class="center">o</td>
<td class="center">Note 1</td>
</tr>
<tr>
<td class="left">SHIM_LOC_PEER_RECV</td>
<td class="center"></td>
<td class="center">o</td>
<td class="center">Note 1</td>
</tr>
<tr>
<td class="left">SHIM_LOC_LOCAL_SEND</td>
<td class="center">o</td>
<td class="center"></td>
<td class="center">Note 1</td>
</tr>
<tr>
<td class="left">SHIM_LOC_PEER_SEND</td>
<td class="center">o</td>
<td class="center"></td>
<td class="center">Note 1</td>
</tr>
<tr>
<td class="left">SHIM_FEEDBACK</td>
<td class="center">o</td>
<td class="center"></td>
<td class="center">shim_feedback{}</td>
</tr>
</tbody>
</table>
<p id="rfc.section.7.p.5">Note 1: cmsg_data[] within msg_control includes a single sockaddr_in{} or sockaddr_in6{} and padding if necessary</p>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> Get Locator from Incoming Packet</h1>
<p id="rfc.section.7.1.p.1">An application can get locator information from the received IP packet by specifying the shim specific socket options for the socket.  When SHIM_LOC_LOCAL_RECV and/or SHIM_LOC_PEER_RECV socket options are set, the application can retrieve local and/or remote locator from the ancillary data.</p>
<p id="rfc.section.7.1.p.2">When there is no shim context associated with the socket, the shim sub-layer MUST return zero-filled locator information to the application.</p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> Set Locator for Outgoing Packet</h1>
<p id="rfc.section.7.2.p.1">An application can specify the locators to be used for transmitting an IP packet by sendmsg().  When the ancillary data of cmsg_type SHIM_LOC_LOCAL_SEND and/or SHIM_LOC_PEER_SEND are specified, the application can explicitly specify the source and/or the destination locators to be used for the communication over the socket.  If the specified locator pair is verified, the shim sub-layer overrides the locator(s) of the outgoing IP packet.  Note that the effect is limited to the datagram transmitted by the sendmsg().</p>
<p id="rfc.section.7.2.p.2">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.7.2.p.3">An error code EINVALIDLOCATOR is returned when validation of the specified locator fails.</p>
<p id="rfc.section.7.2.p.4">An error EUNVERIFIEDLOCATOR is returned when reachability for the requested locator has not been verified yet.  The application is recommended to use another destination locator until the reachability check for the requested locator is done.</p>
<p id="rfc.section.7.2.p.5">An error EUNREACHABLELOCATOR is returned when the requested locator is determined to be not reachable according to a reachability check.  The application is recommended to use another destination locator when receiving the error.</p>
<h1 id="rfc.section.7.3">
<a href="#rfc.section.7.3">7.3.</a> <a href="#sec-feedback" id="sec-feedback">Notification from Application to Multihoming Shim Sub-layer</a>
</h1>
<p id="rfc.section.7.3.p.1">An application may provide feedback to the shim sub-layer about the communication status.  Such feedback are useful for the shim sub-layer to monitor the reachability status of the currently used locator pair in a given shim context.</p>
<p id="rfc.section.7.3.p.2">The notification can be made by sendmsg() specifying a new ancillary data called SHIM_FEEDBACK.  The ancillary data can be handled by specifying SHIM_FEEDBACK option in cmsg_type.</p>
<p id="rfc.section.7.3.p.3">When there is no shim context associated with the socket, an error code ENOENT is returned to the application.</p>
<p id="rfc.section.7.3.p.4">See <a href="#sec-feedback-info">Section 8.3</a> for details of the data structure to be used.</p>
<p id="rfc.section.7.3.p.5">It is outside the scope of this document how the shim sub-layer would react when a feedback is provided by an application.</p>
<h1 id="rfc.section.7.4">
<a href="#rfc.section.7.4">7.4.</a> <a href="#sec-ancillary-data-applicability" id="sec-ancillary-data-applicability">Applicability</a>
</h1>
<p id="rfc.section.7.4.p.1">All the ancillary data for the shim sub-layer is applicable to connected sockets.</p>
<p id="rfc.section.7.4.p.2">Care is needed when the SHIM_LOC_*_RECV socket option is used for stream-oriented sockets (e.g., TCP sockets) because there is no one-to-one mapping between a single send or receive operation and the data (e.g., a TCP segment) being received.  In other words, there is no gurantee that the locator(s) set in the SHIM_LOC_*_RECV ancillary data is identical to the locator(s) that appear in the IP packets received.  The shim sub-layer SHOULD provide the latest locator information to the application in response to the SHIM_LOC_*_RECV socket option.  </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#sec-data-structures" id="sec-data-structures">Data Structures</a>
</h1>
<p id="rfc.section.8.p.1">This section gives data structures for the shim sub-layer.  These data structures are either used as a parameter for setsockopt() or getsockopt() (as mentioned in <a href="#sec-shim-socket-options">Section 6</a>) or as a parameter for ancillary data to be processed by sendmsg() or recvmsg() (as mentioned in <a href="#sec-access-to-locinfo">Section 7</a>).</p>
<h1 id="rfc.section.8.1">
<a href="#rfc.section.8.1">8.1.</a> Placeholder for Locator Information</h1>
<p id="rfc.section.8.1.p.1">As defined in <a href="#sec-shim-socket-options">Section 6</a>, the SHIM_LOC_*_PREF, SHIM_LOC_*_SEND, and SHIM_LOCLIST_* socket options need to handle one or more locator information.  Locator information includes not only the locator itself but also additional information about the locator which is useful for locator management.  A new data structure is defined to serve as a placeholder for the locator information.</p>
<div id="#rfc.figure.22"></div>
<div id="#fig-shim-locator"></div>
<pre>
     struct shim_locator {
             uint8_t    lc_family;       /* address family */
             uint8_t    lc_proto;        /* protocol */
             uint16_t   lc_port;         /* port number */ 
             uint16_t   lc_prio;         /* preference value */
             uint16_t   lc_weight;       /* weight */
             uint32_t   lc_ifidx;        /* interface index */
             struct in6_addr lc_addr;    /* address */ 
             uint16_t   lc_flags;        /* flags */
     };
     </pre>
<p><a href="#fig-shim-locator">Figure 22</a> illustrates the data structure called shim_locator which stores a locator information.  </p>

<dl>
<dt>lc_family</dt>
<dd style="margin-left: 8">
<br> Address family of the locator (e.g.  AF_INET, AF_INET6).  It is required that the parameter contains non-zero value indicating the exact address family of the locator.</dd>
<dt>lc_proto</dt>
<dd style="margin-left: 8">
<br>Internet Protocol number for the protocol which is used to handle locator behind NAT.  Typically, this value is set as UDP (17) when the locator is a UDP encapsulation interface.</dd>
<dt>lc_port</dt>
<dd style="margin-left: 8">
<br>Port number which is used for handling locator behind NAT.</dd>
<dt>lc_prio</dt>
<dd style="margin-left: 8">
<br>The priority of the locator.  The range is 0-65535.  The lowest priority value means the highest priority.</dd>
<dt>lc_weight</dt>
<dd style="margin-left: 8">
<br>The weight value indicates a relative weight for locators with the same priority value.  The range is 0-65535.  A locator with higher weight value is prioritized over the other locators with lower weight values.</dd>
<dt>lc_ifidx</dt>
<dd style="margin-left: 8">
<br>Interface index of the network interface to which the locator is assigned.  This field is only used in a read (getsockopt()) operation.</dd>
<dt>lc_addr</dt>
<dd style="margin-left: 8">
<br>Contains the locator.  In the case where a locator whose size is smaller than 16 bytes, an encoding rule should be provided for each locator of a given address family.  For instance, in case of AF_INET (IPv4), the locator should be in the format of an IPv4-mapped IPv6 address as defined in <a href="#RFC4291">[RFC4291]</a>.</dd>
<dt>lc_flags</dt>
<dd style="margin-left: 8">
<br>Each bit of the flags represents a specific characteristics of the locator.  Hash Based Address (HBA) is defined as 0x01.  Cryptographically Generated Address (CGA) is defined as 0x02.</dd>
</dl>

<p> </p>
<h1 id="rfc.section.8.1.1">
<a href="#rfc.section.8.1.1">8.1.1.</a> <a href="#sec-locator-behind-nat" id="sec-locator-behind-nat">Handling Locator behind NAT</a>
</h1>
<div id="#rfc.figure.23"></div>
<div id="#fig-nat-locator-handling"></div>
<pre>

       struct shim_locator locator;
       struct in6_addr ia6;

       /* copy the private IPv4 address to the ia6 as an IPv4-mapped
          IPv6 address */

       memset(&amp;locator, 0, sizeof(locator));

       /* fill shim_locator data structure */
       locator.lc_family = AF_INET;
       locator.lc_proto = IPPROTO_UDP;
       locator.lc_port = 50500;
       locator.lc_flags = 0;
       locator.lc_prio = 0;
       locator.lc_weight = 0;
       locator.lc_ifidx = 3;

       memcpy(&amp;locator.lc_addr, &amp;ia6, sizeof(ia6));

       setsockopt(fd, SOL_SHIM, SHIM_LOC_LOCAL_SEND, &amp;locator,
                  sizeof(locator));
       </pre>
<p id="rfc.section.8.1.1.p.1">Note that the locator information MAY contain a locator behind a Network Address Translator (NAT).  Such a situation may arise when the host is behind the NAT and uses a local address as a source locator to communicate with the peer.  Note that a NAT traversal mechanism for HIP is defined, which allows HIP host to tunnel control and data traffic over UDP<a href="#RFC5770">[RFC5770]</a>.  Note also that the locator behind NAT is not necessarily an IPv4 address but it can be an IPv6 address.  Below is an example where the application sets a UDP encapsulation interface as a source locator when sending IP packets.  </p>
<h1 id="rfc.section.8.2">
<a href="#rfc.section.8.2">8.2.</a> Path Exploration Parameter</h1>
<div id="#rfc.figure.24"></div>
<div id="#fig-path-explore"></div>
<pre>
     struct shim_pathexplore {
             uint16_t  pe_probenum;      /* # of initial probes */
             uint16_t  pe_keepaliveto;   /* Keepalive Timeout */
             uint16_t  pe_keepaliveint   /* Keepalive Interval */
             uint16_t  pe_initprobeto;   /* Initial Probe Timeout */
             uint32_t  pe_reserved;      /* reserved */
     };
     </pre>
<p id="rfc.section.8.2.p.1">As defined in <a href="#sec-shim-socket-options">Section 6</a>, SHIM_PATHEXPLORE allows application to set or read the parameters for path exploration and failure detection.  A new data structure called shim_pathexplore is defined to store the necessary parameters.  <a href="#fig-path-explore">Figure 24</a> illustrates the data structure.  The data structure can be passed to getsockopt() or setsockopt() as an argument.  </p>

<dl>
<dt>pe_probenum</dt>
<dd style="margin-left: 8">
<br> Indicates the number of initial probe messages to be sent.  Default value of this parameter should follow what is specified in <a href="#RFC5534">[RFC5534]</a>.  </dd>
<dt>pe_keepaliveto</dt>
<dd style="margin-left: 8">
<br> Indicates timeout value in seconds for detecting a failure when the host does not receive any packets for a certain period of time while there is outbound traffic.  When the timer expires, path exploration procedure will be carried out by sending a REAP Probe message.  Default value of this parameter should follow what is specified in <a href="#RFC5534">[RFC5534]</a>.  </dd>
<dt>pe_keepaliveint</dt>
<dd style="margin-left: 8">
<br> Indicates interval of REAP keepalive messages in seconds to be sent by the host when there is no outbound traffic to the peer host.  The value shall be set according to the recommendation given in <a href="#RFC5534">[RFC5534]</a>.  </dd>
<dt>pe_initprobeto</dt>
<dd style="margin-left: 8">
<br> Indicates retransmission timer of REAP Probe message in milliseconds.  Note that this timer is applied before exponential back-off is started.  A REAP Probe message for the same locator pair may be retransmitted.  Default value of this parameter should follow what is specified in <a href="#RFC5534">[RFC5534]</a>.  </dd>
<dt>pe_reserved</dt>
<dd style="margin-left: 8">
<br> A reserved field for future extension.  By default, the field should be initialized to zero.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.8.3">
<a href="#rfc.section.8.3">8.3.</a> <a href="#sec-feedback-info" id="sec-feedback-info">Feedback Information</a>
</h1>
<div id="#rfc.figure.25"></div>
<div id="#fig-feedback-info"></div>
<pre>
     struct shim_feedback {
             uint8_t   fb_direction;    /* direction of traffic */
             uint8_t   fb_indicator;    /* indicator (1-3) */
             uint16_t  fb_reserved;     /* reserved */
     };
     </pre>
<p id="rfc.section.8.3.p.1">As mentioned in <a href="#sec-feedback">Section 7.3</a>, applications can inform the shim sub-layer about the status of unicast reachability of the locator pair currently in use.  The feedback information can be handled by using ancillary data called SHIM_FEEDBACK.  A new data structure named shim_feedback is illustrated in <a href="#fig-feedback-info">Figure 25</a>.  </p>

<dl>
<dt>direction</dt>
<dd style="margin-left: 8">
<br> Indicates direction of reachability between a locator pair in question.  A value 0 indicates outbound and a value 1 indicates inbound direction.  </dd>
<dt>indicator</dt>
<dd style="margin-left: 8">
<br> A value indicating the degree of satisfaction of a unidirectional reachability for a given locator pair.  <ul>
<li>0: Default value.  Whenever this value is specified the feedback information must not be processed by the shim sub-layer.</li>
<li>1: Unable to connect.  There is no unidirectional reachability between the locator pair in question.</li>
<li>2: Unsatisfactory.  The application is not satisfied with the unidirectional reachability between the locator pair in question.</li>
<li>3: Satisfactory.  There is satisfactory unidirectional reachability between the locator pair in question.</li>
</ul>
<p> </p>
</dd>
<dt>reserved</dt>
<dd style="margin-left: 8">
<br> Reserved field.  Must be ignored by the receiver.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#sec-system-requirements" id="sec-system-requirements">System Requirements</a>
</h1>
<p id="rfc.section.9.p.1">As addressed in <a href="#sec-shim-socket-options">Section 6</a>, most of the socket options and ancillary data defined in this document are applicable to connected sockets.  It is assumed that the kernel is capable of maintaining the association between a connected socket and a shim context.  This requirement is considered to be reasonable because a pair of source and destination IP addresses is bound to a connected socket.</p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> <a href="#sec-implications-for-legacyapi" id="sec-implications-for-legacyapi">Relation to Existing Sockets API Extensions</a>
</h1>
<p id="rfc.section.10.p.1">This section explains relation between the sockets API defined in this document and the existing sockets API extensions.</p>
<p id="rfc.section.10.p.2">As mentioned in <a href="#sec-shim-socket-options">Section 6</a>, the basic assumption is that the existing sockets API continues to work above the shim sub-layer.  This means that, the existing sockets API deals with identifiers, and the sockets API defined in this document deals with locators.</p>
<p id="rfc.section.10.p.3">SHIM_LOC_LOCAL_SEND and SHIM_LOC_PEER_SEND socket options are semantically similar to the IPV6_PKTINFO socket API in the sense that both provide a means for application to set the source IP address of outbound IP packets.</p>
<p id="rfc.section.10.p.4">SHIM_LOC_LOCAL_RECV and SHIM_LOC_PEER_RECV socket options are semantically similar to the IP_RECVDSTADDR and IPV6_PKTINFO socket APIs in the sense that both provides a means for application to get the source and/or destination IP address of inbound IP packets.</p>
<p id="rfc.section.10.p.5">getsockname() and getpeername() enable application to get 'name' of the communication endpoints which is represented by a pair of IP address and port number assigned to the socket.  getsockname() gives IP address and port number assigned to the socket on the local side, and getpeername() gives IP address and port number of the peer side.</p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> Operational Considerations</h1>
<p id="rfc.section.11.p.1">This section gives operational considerations of the sockets API defined in this document.</p>
<h1 id="rfc.section.11.1">
<a href="#rfc.section.11.1">11.1.</a> Conflict Resolution</h1>
<p id="rfc.section.11.1.p.1">There may be a conflicting situation when different applications specify difference preference for the same shim context.  For instance, application A and B may establish communication with the same EID pair while both applications have different preference in their choice of local locator.  The notion of context forking in SHIM6 can resolve the conflicting situation.</p>
<p id="rfc.section.11.1.p.2">Socket options defined in <a href="#sec-shim-socket-options">Section 6</a> may cause conflicting situation when the target context is shared by multiple applications.  In such a case, the socket handler should inform the shim sub-layer that context forking is required.  In SHIM6, when a context is forked, an unique identifier called Forked Instance Identifier (FII) is assigned to the newly forked context.  The forked context is then exclusively associated with the socket through which non-default preference value was specified.  The forked context is maintained by the shim sub-layer during the lifetime of associated socket instance.  When the socket is closed, the shim sub-layer SHOULD delete associated context.</p>
<p id="rfc.section.11.1.p.3">When the application specifies SHIM_LOC_*_SEND specifying a different source or destination locator which does not have the highest priority and weight specified by the SHIM_LOC_*_PREF, the shim sub-layer SHOULD supersede the request made by SHIM_LOC_*_SEND over the preference specified by SHIM_LOC_*_PREF.</p>
<p id="rfc.section.11.1.p.4">When the peer provides preferences of the locators (e.g., a SHIM6 peer may send a locator with a Locator Preferences Option) which conflict with preference specified by the applications either by SHIM_LOC_PEER_SEND or SHIM_LOC_PEER_PREF, the shim sub-layer SHOULD supersede the preference made by the application over the preference specified by the peer.  </p>
<h1 id="rfc.section.11.2">
<a href="#rfc.section.11.2">11.2.</a> Incompatibility between IPv4 and IPv6</h1>
<p id="rfc.section.11.2.p.1">The shim sub-layer performs identifier/locator adaptation.  Therefore, in some cases, the whole IP header can be replaced with new IP header of a different address family (e.g. conversion from IPv4 to IPv6 or vice versa).  Hence, there is an issue how to make the conversion with minimum impact.  Note that this issue is common in other protocol conversion techniques <a href="#RFC2765">[RFC2765]</a><a href="#I-D.ietf-behave-v6v4-xlate">[I-D.ietf-behave-v6v4-xlate]</a>.</p>
<p id="rfc.section.11.2.p.2">As studied in the previous works on protocol conversion<a href="#RFC2765">[RFC2765]</a><a href="#I-D.ietf-behave-v6v4-xlate">[I-D.ietf-behave-v6v4-xlate]</a>, some of the features (IPv6 routing headers, hop-by-hop extension headers, and destination headers) from IPv6 are not convertible to IPv4.  In addition, notion of source routing is not exactly the same in IPv4 and IPv6.  This means that an error may occur during the conversion of identifier and locator.  It is outside the scope of this document to describe how the shim sub-layer should behave in such erroneous cases.</p>
<h1 id="rfc.section.12">
<a href="#rfc.section.12">12.</a> IANA Considerations</h1>
<p id="rfc.section.12.p.1">There is no IANA considerations for the socket options (SHIM_*), the ancillary data, and the socket level (SOL_SHIM) that are defined in this document.  All the numbers concerned are not under the control of IETF or IANA but they are platform-specific.</p>
<h1 id="rfc.section.13">
<a href="#rfc.section.13">13.</a> Protocol Constants and Variables</h1>
<p id="rfc.section.13.p.1">This section defines protocol constants and variables.  </p>

<dl>
<dt>SHIM_MAX_LOCATORS</dt>
<dd style="margin-left: 8">The maximum number of the locators to be included in a locator list.  The value is set to 32.</dd>
</dl>

<p> </p>
<h1 id="rfc.section.14">
<a href="#rfc.section.14">14.</a> Security Considerations</h1>
<p id="rfc.section.14.p.1">This section gives security considerations of the API defined in this document.</p>
<h1 id="rfc.section.14.1">
<a href="#rfc.section.14.1">14.1.</a> Treatment of Unknown Locator</h1>
<p id="rfc.section.14.1.p.1">When sending IP packets, application may request use of unknown locator for the source and/or destination locators.  Note that treatment of unknown locator can be a subject of security considerations because use of invalid source and/or destination locator may cause redirection attack.</p>
<h1 id="rfc.section.14.1.1">
<a href="#rfc.section.14.1.1">14.1.1.</a> Treatment of Unknown Source Locator</h1>
<p id="rfc.section.14.1.1.p.1">The shim sub-layer checks if the requested locator is available on any of the local interface.  If not, the shim sub-layer MUST reject the request and return an error message with the EINVALIDLOCATOR code to the application.  If the locator is confirmed to be available, the shim sub-layer SHOULD initiate the procedure to update the locator list.</p>
<p id="rfc.section.14.1.1.p.2">Use of the following socket options and ancillary data may require treatment of unknown source locator: </p>

<ul>
<li>SHIM_LOC_LOCAL_SEND</li>
<li>SHIM_LOC_LOCAL_PREF</li>
<li>SHIM_LOCLIST_LOCAL</li>
</ul>

<p> </p>
<h1 id="rfc.section.14.1.2">
<a href="#rfc.section.14.1.2">14.1.2.</a> Treatment of Unknown Destination Locator</h1>
<p id="rfc.section.14.1.2.p.1">If the shim sub-layer turns out to be SHIM6, the SHIM6 layer MUST reject the request for using an unknown destination locator.</p>
<p id="rfc.section.14.1.2.p.2">If the shim sub-layer turns out to be HIP, the HIP layer MUST reject the request for using an unknown destination locator.  There is, however, an exceptional case where the HIP layer SHOULD accept the request provided that the HIP association is in an UNASSOCIATED state.  Details of locator handling in HIP is described in section 4.6 of <a href="#I-D.ietf-hip-native-api">[I-D.ietf-hip-native-api]</a>.</p>
<p id="rfc.section.14.1.2.p.3">Use of the following socket options and ancillary data may require treatment of unknown destination locator: </p>

<ul>
<li>SHIM_LOC_PEER_SEND</li>
<li>SHIM_LOC_PEER_PREF</li>
<li>SHIM_LOCLIST_PEER</li>
</ul>

<p> </p>
<h1 id="rfc.section.15">
<a href="#rfc.section.15">15.</a> Changes</h1>
<h1 id="rfc.section.15.1">
<a href="#rfc.section.15.1">15.1.</a> Changes from version 00 to version 01</h1>
<p></p>

<ul>
<li>Define shim_locator{} data type which is a placeholder for locator.</li>
<li>Define shim_pathexplore{} data type in which a set of REAP parameters are stored.</li>
<li>Remove descriptions about "stickiness" of socket options.</li>
<li>Deprecate SHIM_IF_RECV and SHIM_IF_SEND socket options.</li>
<li>Give default value and how to disable given socket option.</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.2">
<a href="#rfc.section.15.2">15.2.</a> Changes from version 01 to version 02</h1>
<p></p>

<ul>
<li>Add section describing context forking.</li>
<li>Rephrase conclusion section.</li>
<li>Separate normative references from informative references.</li>
<li>Remove texts from discussion section that are not relevant to the contents of the document.</li>
<li>Add section describing change history (this section).</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.3">
<a href="#rfc.section.15.3">15.3.</a> Changes from version 02 to version 03</h1>
<p></p>

<ul><li>Add an Appendix section describing the issue of context forking.</li></ul>

<p> </p>
<h1 id="rfc.section.15.4">
<a href="#rfc.section.15.4">15.4.</a> Changes from version 03 to version 04</h1>
<p></p>

<ul>
<li>Updated reference.</li>
<li>Correct typo and grammatical errors.</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.5">
<a href="#rfc.section.15.5">15.5.</a> Changes from version 04 to version 05</h1>
<p></p>

<ul>
<li>Added definition of SHIM_FEEDBACK ancillary data.</li>
<li>Added an example of code using the SHIM_LOCLIST_LOCAL</li>
<li>Added SHIM_LOC_LOCAL_SEND and SHIM_LOC_PEER_SEND socket options.</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.6">
<a href="#rfc.section.15.6">15.6.</a> Changes from version 05 to version 06</h1>
<p></p>

<ul><li>Updated references.</li></ul>

<p> </p>
<h1 id="rfc.section.15.7">
<a href="#rfc.section.15.7">15.7.</a> Changes from version 06 to version 07</h1>
<p></p>

<ul><li>Resolved editorial issues.</li></ul>

<p> </p>
<h1 id="rfc.section.15.8">
<a href="#rfc.section.15.8">15.8.</a> Changes from version 07 to version 08</h1>
<p id="rfc.section.15.8.p.1">No changes are made except for updates of the references.</p>
<h1 id="rfc.section.15.9">
<a href="#rfc.section.15.9">15.9.</a> Changes from version 08 to version 09</h1>
<p></p>

<ul>
<li>Updated texts for Section 1 and Section 5 according to the comments provided by Samu Varjonen.</li>
<li>Made it clear that downgrading the multihoming shim support (i.e., specifying value 1 with the SHIM_DONTSHIM socket option) is only allowed before the socket is connected.</li>
<li>Updated locator information (shim_locator{}) so that it can contain a locator behind NAT.</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.10">
<a href="#rfc.section.15.10">15.10.</a> Changes from version 09 to version 10</h1>
<p></p>

<ul>
<li>Addressed applicability of socket options and ancillary data for the shim sub-layer.</li>
<li>Addressed system requirements.</li>
<li>Removed unnecessary description about deprecated socket option (SHIM_IF_RECV).</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.11">
<a href="#rfc.section.15.11">15.11.</a> Changes from version 10 to version 11</h1>
<p></p>

<ul>
<li>Added short descriptions about connected sockets and unconnected sockets.</li>
<li>Relaxed applicability of the socket options.</li>
<li>Relaxed applicability of the ancillary data.</li>
<li>Added notification about locator change.</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.12">
<a href="#rfc.section.15.12">15.12.</a> Changes from version 11 to version 12</h1>
<p></p>

<ul>
<li>Reflected comments from Brian Karpenter.</li>
<li>Reflected comments from Michael Scharf.</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.13">
<a href="#rfc.section.15.13">15.13.</a> Changes from version 12 to version 13</h1>
<p></p>

<ul>
<li>Reflected comments from Sebastien Barre.</li>
<li>Removed the description about the notification from the shim sub-layer to applications.</li>
<li>Narrowed down the scope of the applicability of the socket options and the ancillary data.</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.14">
<a href="#rfc.section.15.14">15.14.</a> Changes from version 13 to version 14</h1>
<p></p>

<ul><li>No change was made. The draft was re-submitted to avoid expiration.</li></ul>

<p> </p>
<h1 id="rfc.section.15.15">
<a href="#rfc.section.15.15">15.15.</a> Changes from version 14 to version 15</h1>
<p></p>

<ul>
<li>Addressed the difference between SHIM_LOC_PEER_SEND and SHIM_LOC_PEER_PREF.</li>
<li>Made clear distinction between validation of locator and verification of locator, and introduced two errors: EUNVERIFIEDLOCATOR and EUNREACHABLELOCATOR.</li>
<li>Addressed exceptional case for HIP in handling of unknown destination locator.</li>
</ul>

<p> </p>
<h1 id="rfc.section.15.16">
<a href="#rfc.section.15.16">15.16.</a> Changes from version 15 to version 16</h1>
<p id="rfc.section.15.16.p.1">Updated the documents reflecting the comments received during the IETF Last Call.  </p>

<ul>
<li>Added Keepalive Interval (pe_keepaliveint) as a member of the shim_pathexplore{} data structure.</li>
<li>Addressed the unit of pe_keepaliveto.</li>
<li>Rephrased the last sentence in Appendix A to make it clear that the addressed issue is for further study.</li>
<li>Corrected a typo.</li>
</ul>

<p> </p>
<h1 id="rfc.section.16">
<a href="#rfc.section.16">16.</a> Acknowledgments</h1>
<p id="rfc.section.16.p.1">Authors would like to thank Jari Arkko who participated in the discussion that lead to the first version of this document, and Tatuya Jinmei who thoroughly reviewed the early version of this draft and provided detailed comments on sockets API related issues.  Thomas Henderson provided valuable comments especially from HIP perspectives.</p>
<p id="rfc.section.16.p.2">Authors sincerely thank to the following people for their helpful comments to the document: Samu Varjonen, Dmitriy Kuptsov, Brian Carpenter, Michael Scharf, Sebastien Barre, and Roni Even.</p>
<h1 id="rfc.references">
<a href="#rfc.references">17.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">17.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3542">[RFC3542]</b></td>
<td class="top">
<a>Stevens, W.</a>, <a>Thomas, M.</a>, <a>Nordmark, E.</a> and <a>T. Jinmei</a>, "<a href="http://tools.ietf.org/html/rfc3542">Advanced Sockets Application Program Interface (API) for IPv6</a>", RFC 3542, May 2003.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4423">[RFC4423]</b></td>
<td class="top">
<a>Moskowitz, R.</a> and <a>P. Nikander</a>, "<a href="http://tools.ietf.org/html/rfc4423">Host Identity Protocol (HIP) Architecture</a>", RFC 4423, May 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5533">[RFC5533]</b></td>
<td class="top">
<a>Nordmark, E.</a> and <a>M. Bagnulo</a>, "<a href="http://tools.ietf.org/html/rfc5533">Shim6: Level 3 Multihoming Shim Protocol for IPv6</a>", RFC 5533, June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5534">[RFC5534]</b></td>
<td class="top">
<a>Arkko, J.</a> and <a>I. van Beijnum</a>, "<a href="http://tools.ietf.org/html/rfc5534">Failure Detection and Locator Pair Exploration Protocol for IPv6 Multihoming</a>", RFC 5534, June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="POSIX">[POSIX]</b></td>
<td class="top">
<a>, </a>, "<a>IEEE Std. 1003.1-2001 Standard for Information Technology -- Portable Operating System Interface (POSIX). Open group Technical Standard: Base Specifications, Issue 6, http://www.opengroup.org/austin</a>", December 2001.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">17.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.ietf-behave-v6v4-xlate">[I-D.ietf-behave-v6v4-xlate]</b></td>
<td class="top">
<a>Li, X</a>, <a>Bao, C</a> and <a>F Baker</a>, "<a href="http://tools.ietf.org/html/draft-ietf-behave-v6v4-xlate-23">IP/ICMP Translation Algorithm</a>", Internet-Draft draft-ietf-behave-v6v4-xlate-23, September 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-shim6-app-refer">[I-D.ietf-shim6-app-refer]</b></td>
<td class="top">
<a>Nordmark, E</a>, "<a href="http://tools.ietf.org/html/draft-ietf-shim6-app-refer-00">Shim6 Application Referral Issues</a>", Internet-Draft draft-ietf-shim6-app-refer-00, July 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2765">[RFC2765]</b></td>
<td class="top">
<a href="mailto:nordmark@sun.com" title="Sun Microsystems, Inc.">Nordmark, E.</a>, "<a href="http://tools.ietf.org/html/rfc2765">Stateless IP/ICMP Translation Algorithm (SIIT)</a>", RFC 2765, February 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2782">[RFC2782]</b></td>
<td class="top">
<a href="mailto:arnt@troll.no" title="Troll Tech">Gulbrandsen, A.</a>, <a title="Internet Software Consortium">Vixie, P.</a> and <a href="mailto:levone@microsoft.com" title="Microsoft Corporation">L. Esibov</a>, "<a href="http://tools.ietf.org/html/rfc2782">A DNS RR for specifying the location of services (DNS SRV)</a>", RFC 2782, February 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4291">[RFC4291]</b></td>
<td class="top">
<a>Hinden, R.</a> and <a>S. Deering</a>, "<a href="http://tools.ietf.org/html/rfc4291">IP Version 6 Addressing Architecture</a>", RFC 4291, February 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5535">[RFC5535]</b></td>
<td class="top">
<a>Bagnulo, M.</a>, "<a href="http://tools.ietf.org/html/rfc5535">Hash-Based Addresses (HBA)</a>", RFC 5535, June 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5770">[RFC5770]</b></td>
<td class="top">
<a>Komu, M.</a>, <a>Henderson, T.</a>, <a>Tschofenig, H.</a>, <a>Melen, J.</a> and <a>A. Keranen</a>, "<a href="http://tools.ietf.org/html/rfc5770">Basic Host Identity Protocol (HIP) Extensions for Traversal of Network Address Translators</a>", RFC 5770, April 2010.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-hip-native-api">[I-D.ietf-hip-native-api]</b></td>
<td class="top">
<a>Komu, M</a> and <a>T Henderson</a>, "<a href="http://tools.ietf.org/html/draft-ietf-hip-native-api-12">Basic Socket Interface Extensions for Host Identity Protocol (HIP)</a>", Internet-Draft draft-ietf-hip-native-api-12, January 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> Context Forking</h1>
<p id="rfc.section.Appendix A.p.1">In this section, an issue concerning context forking and its relation to the multihoming shim API are discussed.</p>
<p id="rfc.section.Appendix A.p.2">SHIM6 supports a notion of context forking.  A peer may decide to fork a context for certain reason (e.g. upper layer protocol prefers to use different locator pair than the one defined in available context).  The procedure of forking context is done similar to the normal context establishment, performing the 4-way message exchange.  A peer who has decided to fork a context initiates the context establishment.  Hereafter, we call this peer the "initiator".  The peer of the initiator is called the "responder".</p>
<p id="rfc.section.Appendix A.p.3">Once the forked context is established between the peers, on the initiator side, it is possible to apply forked context to the packet flow since the system maintains an association between the forked context and the socket owned by the application that has requested the context forking.  How this association is maintained is an implementation specific issue.  However, on the responder side, there is a question how the outbound packet can be multiplexed by the shim sub-layer because there are more than one SHIM6 contexts that match with the ULID pair of the packet flow.  There is a need to differentiate packet flows not only by the ULID pairs but by some other information and associate a given packet flow with a specific context.</p>
<div id="#rfc.figure.26"></div>
<div id="#fig-context-forking"></div>
<pre>
           Peer 1                                 Peer 2   
         (initiator)                            (responder)

    +----+         +----+                  +----+         +----+
    |App1|         |App2|                  |App1|         |App2|
    +----+         +----+                  +----+         +----+
      |^             |^                      ^|             ^|
      v|             v|                      |v             |v
 -----S1-------------S2-----            -----S1-------------S2-----
      ||             ||                      ||             ||
      ||             ||                      ||             ||

     Ctx1           Ctx2                    Ctx1           Ctx2
 ULID:&lt;A1,B1&gt;   ULID:&lt;A1,B1&gt;            ULID:&lt;B1,A1&gt;    ULID:&lt;B1,A1&gt;
 Loc: &lt;A1,B2&gt;   Loc: &lt;A1,B3&gt;            Loc: &lt;B2,A1&gt;    Loc: &lt;B3,A1&gt; 
 FII: 0         FII: 100                FII: 0          FII: 100
 
      |^             |^                      ^|             ^|
      ||             ||                      ||             ||
      ||             ||                      ||             ||
      \..............||....................../|             ||
       \.............||......................./             ||
                     ||                                     ||
                     \|...................................../|
                      \....................................../
       </pre>
<p><a href="#fig-context-forking">Figure 26</a> gives an example of a scenario where two communicating peers fork a context.  Initially, there has been a single transaction between the peers, by the application 1 (App1).  Accordingly, another transaction is started, by application 2 (App2).  Both of the transactions are made based on the same ULID pair.  The first context pair (Ctx1) is established for the transaction of App1.  Given the requests from App2, the shim sub-layer on Peer 1 decides to fork a context.  Accordingly, a forked context (Ctx2) is established between the peers, which should be exclusively applied to the transaction of App2.  Ideally, multiplexing and demultiplexing of packet flows that relate to App1 and App2 should be done as illustrated in <a href="#fig-context-forking">Figure 26</a>.  However, as mentioned earlier, the responder needs to multiplex outbound flows of App1 and App2 somehow.  Note that if a context forking occurs on the initiator side, a context forking needs to occur also on the responder side.  </p>
<p id="rfc.section.Appendix A.p.5">It is for further study how to solve the issue described above.</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Miika Komu</span> 
	  <span class="n hidden">
		<span class="family-name">Komu</span>
	  </span>
	</span>
	<span class="org vcardline">Helsinki Institute for Information Technology</span>
	<span class="adr">
	  <span>Tammasaarenkatu 3</span>

	  <span class="vcardline">
		<span class="locality">Helsinki</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Finland</span>
	</span>
	<span class="vcardline">Phone: +358503841531</span>

<span class="vcardline">EMail: <a href="mailto:miika@iki.fi">miika@iki.fi</a></span>

<span class="vcardline">URI: <a href="http://www.hiit.fi/">http://www.hiit.fi/</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Marcelo Bagnulo</span> 
	  <span class="n hidden">
		<span class="family-name">Bagnulo</span>
	  </span>
	</span>
	<span class="org vcardline">Universidad Carlos III de Madrid</span>
	<span class="adr">
	  <span>Av. Universidad 30</span>

	  <span class="vcardline">
		<span class="locality">Leganes</span>,  
		<span class="region"></span>
		<span class="code">28911</span>
	  </span>
	  <span class="country-name vcardline">SPAIN</span>
	</span>
	<span class="vcardline">Phone: +34 91 6248837</span>

<span class="vcardline">EMail: <a href="mailto:marcelo@it.uc3m.es">marcelo@it.uc3m.es</a></span>

<span class="vcardline">URI: <a href="http://it.uc3m.es/marcelo">http://it.uc3m.es/marcelo</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Kristian Slavov</span> 
	  <span class="n hidden">
		<span class="family-name">Slavov</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson Research Nomadiclab</span>
	<span class="adr">
	  <span>Hirsalantie 11</span>

	  <span class="vcardline">
		<span class="locality">Jorvas</span>,  
		<span class="region"></span>
		<span class="code">FI-02420</span>
	  </span>
	  <span class="country-name vcardline">Finland</span>
	</span>
	<span class="vcardline">Phone: +358 9 299 3286</span>

<span class="vcardline">EMail: <a href="mailto:kristian.slavov@ericsson.com">kristian.slavov@ericsson.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Shinta Sugimoto</span> editor
	  <span class="n hidden">
		<span class="family-name">Sugimoto</span>
	  </span>
	</span>
	<span class="org vcardline">Nippon Ericsson K.K.</span>
	<span class="adr">
	  <span>Koraku Mori Building</span>
<span>1-4-14, Koraku, Bunkyo-ku</span>

	  <span class="vcardline">
		<span class="locality">Tokyo</span>,  
		<span class="region"></span>
		<span class="code">112-0004</span>
	  </span>
	  <span class="country-name vcardline">Japan</span>
	</span>
	<span class="vcardline">Phone: +81 3 3830 2241</span>

<span class="vcardline">EMail: <a href="mailto:shinta@sfc.wide.ad.jp">shinta@sfc.wide.ad.jp</a></span>

  </address>
</div>

</body>
</html>