<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Session Traversal Utilities for (NAT) (STUN)</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Session Traversal Utilities for (NAT) (STUN)">
<meta name="keywords" content="SIPs, NAT">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">BEHAVE Working Group</td><td class="header">J. Rosenberg</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco</td></tr>
<tr><td class="header">Obsoletes: <a href='http://tools.ietf.org/html/rfc3489'>3489</a> (if&nbsp;approved)</td><td class="header">C. Huitema</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">Microsoft</td></tr>
<tr><td class="header">Expires: January 28, 2008</td><td class="header">R. Mahy</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Plantronics</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">P. Matthews</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Avaya</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">D. Wing</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Cisco</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">July 27, 2007</td></tr>
</table></td></tr></table>
<h1><br />Session Traversal Utilities for (NAT) (STUN)<br />draft-ietf-behave-rfc3489bis-08</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on January 28, 2008.</p>

<h3>Abstract</h3>

<p>Session Traversal Utilities for NAT (STUN) is a protocol that serves
      as a tool for other protocols in dealing with NAT traversal. It
      can be used by an endpoint to determine the IP address and port allocated to it
      by a NAT. It can also be used to check
      connectivity between two endpoints, and as a keep-alive protocol to
      maintain NAT bindings. STUN works with many existing NATs, and does not
      require any special behavior from them.
</p>
<p>STUN is not a NAT traversal solution by itself. Rather, it
      is a tool to be used in the context of a NAT traversal solution. This is
      an important change from the previous version of this specification
      (RFC 3489), which presented STUN as a complete solution.
</p>
<p>This document obsoletes RFC 3489.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Evolution from RFC 3489<br />
<a href="#sec:overview">3.</a>&nbsp;
Overview of Operation<br />
<a href="#anchor3">4.</a>&nbsp;
Terminology<br />
<a href="#anchor4">5.</a>&nbsp;
Definitions<br />
<a href="#message_structure">6.</a>&nbsp;
STUN Message Structure<br />
<a href="#sec:base-procedures">7.</a>&nbsp;
Base Protocol Procedures<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">7.1.</a>&nbsp;
Forming a Request or an Indication<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">7.2.</a>&nbsp;
Sending the Request or Indication<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">7.2.1.</a>&nbsp;
Sending over UDP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">7.2.2.</a>&nbsp;
Sending over TCP or TLS-over-TCP<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:receiving-a-stun-message">7.3.</a>&nbsp;
Receiving a STUN Message<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">7.3.1.</a>&nbsp;
Processing a Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">7.3.1.1.</a>&nbsp;
Forming a Success or Error Response<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">7.3.1.2.</a>&nbsp;
Sending the Success or Error Response<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">7.3.2.</a>&nbsp;
Processing an Indication<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec-success-resp">7.3.3.</a>&nbsp;
Processing a Success Response<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:processing-an-error-response">7.3.4.</a>&nbsp;
Processing an Error Response<br />
<a href="#sec:fingerprint-extension">8.</a>&nbsp;
FINGERPRINT Mechanism<br />
<a href="#client_discovery">9.</a>&nbsp;
DNS Discovery of a
	Server<br />
<a href="#sec:authentication-mechanisms">10.</a>&nbsp;
Authentication and Message-Integrity Mechanisms<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">10.1.</a>&nbsp;
Short-Term Credential Mechanism<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">10.1.1.</a>&nbsp;
Forming a Request or Indication<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">10.1.2.</a>&nbsp;
Receiving a Request or Indication<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">10.1.3.</a>&nbsp;
Receiving a Response<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">10.2.</a>&nbsp;
Long-term Credential Mechanism<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">10.2.1.</a>&nbsp;
Forming a Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">10.2.1.1.</a>&nbsp;
First Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor20">10.2.1.2.</a>&nbsp;
Subsequent Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">10.2.2.</a>&nbsp;
Receiving a Request<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor22">10.2.3.</a>&nbsp;
Receiving a Response<br />
<a href="#sec:alternate-server-extension">11.</a>&nbsp;
ALTERNATE-SERVER Mechanism<br />
<a href="#sec:backwards-compatibility">12.</a>&nbsp;
Backwards Compatibility with RFC 3489<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor23">12.1.</a>&nbsp;
Changes to Client Processing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">12.2.</a>&nbsp;
Changes to Server Processing<br />
<a href="#usages">13.</a>&nbsp;
STUN Usages<br />
<a href="#attribute_details">14.</a>&nbsp;
STUN Attributes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#mapped_address">14.1.</a>&nbsp;
MAPPED-ADDRESS<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#xor_mapped_address">14.2.</a>&nbsp;
XOR-MAPPED-ADDRESS<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">14.3.</a>&nbsp;
USERNAME<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#message_integrity">14.4.</a>&nbsp;
MESSAGE-INTEGRITY<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:fingerprint">14.5.</a>&nbsp;
FINGERPRINT<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#sec:error-code">14.6.</a>&nbsp;
ERROR-CODE<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor26">14.7.</a>&nbsp;
REALM<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor27">14.8.</a>&nbsp;
NONCE<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor28">14.9.</a>&nbsp;
UNKNOWN-ATTRIBUTES<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor29">14.10.</a>&nbsp;
SERVER<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor30">14.11.</a>&nbsp;
ALTERNATE-SERVER<br />
<a href="#security_considerations">15.</a>&nbsp;
Security
        Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor31">15.1.</a>&nbsp;
Attacks against the Protocol<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor32">15.1.1.</a>&nbsp;
Outside Attacks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor33">15.1.2.</a>&nbsp;
Inside Attacks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor34">15.2.</a>&nbsp;
Attacks Affecting the Usage<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ddos">15.2.1.</a>&nbsp;
Attack I: DDoS Against a Target<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor35">15.2.2.</a>&nbsp;
Attack II: Silencing a Client<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor36">15.2.3.</a>&nbsp;
Attack III: Assuming the Identity of a Client<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor37">15.2.4.</a>&nbsp;
Attack IV: Eavesdropping<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor38">15.3.</a>&nbsp;
Hash Agility Plan<br />
<a href="#iab_considerations">16.</a>&nbsp;
IAB Considerations<br />
<a href="#iana_considerations">17.</a>&nbsp;
IANA Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor39">17.1.</a>&nbsp;
STUN Methods Registry<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor40">17.2.</a>&nbsp;
STUN Attribute Registry<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor41">17.3.</a>&nbsp;
STUN Error Code Registry<br />
<a href="#sec-changes">18.</a>&nbsp;
Changes Since RFC 3489<br />
<a href="#anchor42">19.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">20.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">20.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">20.2.</a>&nbsp;
Informational References<br />
<a href="#anchor45">Appendix&nbsp;A.</a>&nbsp;
C Snippet to Determine STUN Message Types <br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>The protocol defined in this specification, Session Traversal
Utilities for NAT, provides a tool for dealing with
NATs. It provides a means for an endpoint to determine the IP address
and port allocated by a NAT that corresponds to its private IP address
and port. It also provides a way for an endpoint to keep a NAT binding
alive. With some extensions, the protocol can be used to do
connectivity checks between two endpoints
<a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>, or to relay packets between two
endpoints <a class='info' href='#I-D.ietf-behave-turn'>[I&#8209;D.ietf&#8209;behave&#8209;turn]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; July&nbsp;2009.</span><span>)</span></a>.
</p>
<p>In keeping
with its tool nature, this specification defines an extensible
packet format, defines operation over several transport protocols,
and provides for two forms of authentication. 

</p>
<p>STUN is intended to be used in context of one or more NAT
	traversal solutions. These solutions are known as STUN
	usages. Each usage describes how STUN is utilized to achieve
	the NAT traversal solution. Typically, a usage indicates when
	STUN messages get sent, which optional attributes to include,
	what server is used, and what authentication mechanism is to
	be used. Interactive Connectivity Establishment (ICE)
	<a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a> is one usage of ICE. SIP
	Outbound <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a> is another
	usage of ICE. In some cases, a usage will require extensions
	to STUN. A STUN extension can be in the form of new methods,
	attributes, or error response codes. More information on STUN
	usages can be found in <a class='info' href='#usages'>Section&nbsp;13<span> (</span><span class='info'>STUN Usages</span><span>)</span></a>.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Evolution from RFC 3489</h3>

<p>STUN was originally defined in RFC 3489
      <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a>. That specification, sometimes referred
      to as "classic STUN", represented itself as a complete
      solution to the NAT traversal problem. In that solution, a
      client would discover whether it was behind a NAT, determine its
      NAT type, discover its IP address and port on the public side of
      the outermost NAT, and then utilize that IP address and port
      within the body of protocols, such as the Session Initiation
      Protocol (SIP) <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. However, experience
      since the publication of RFC 3489 has found that classic STUN simply does
      not work sufficiently well to be a deployable solution. The
      address and port learned through classic STUN are sometimes usable for
      communications with a peer, and sometimes not. Classic STUN provided no
      way to discover whether it would, in fact, work or
      not, and it provided no remedy in cases where it did
      not. Furthermore, classic STUN's algorithm for classification of NAT
      types was found to be faulty, as many NATs did not fit cleanly
      into the types defined there. Classic STUN also had security
      vulnerabilities which required an extremely complicated
      mechanism to address, and despite the complexity of the
      mechanism, were not fully remedied.
      
</p>
<p>
	For these reasons, this specification obsoletes RFC 3489, and
	instead describes STUN as a tool that is utilized as part of a
	complete NAT traversal solution. ICE is a complete NAT
	traversal solution for protocols based on the offer/answer
	<a class='info' href='#RFC3264'>[RFC3264]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;An Offer/Answer Model with Session Description Protocol (SDP),&rdquo; June&nbsp;2002.</span><span>)</span></a> methodology, such as SIP. SIP
	Outbound is a complete solution for traversal of SIP
	signaling, and it uses STUN in a very different way. Though it
	is possible that a protocol may be able to use STUN by itself
	(classic STUN) as a traversal solution, such usage is not
	described here and is strongly discouraged for the reasons
	described above. 
      
</p>
<p>
	The on-the-wire protocol described here is changed only
	slightly from classic STUN. The protocol now runs over TCP in
	addition to UDP. Extensibility was added to the protocol in a
	more structured way. A magic-cookie mechanism for
	demultiplexing STUN with application protocols was added by
	stealing 32 bits from the 128 bit transaction ID defined in
	RFC 3489, allowing the change to be backwards
	compatible. Mapped addresses are encoded using a new
	exclusive-or format. There are other, more minor changes. See
	<a class='info' href='#sec-changes'>Section&nbsp;18<span> (</span><span class='info'>Changes Since RFC 3489</span><span>)</span></a> for a more complete listing.
      
</p>
<p>
	Due to the change in scope, STUN has also been renamed from
	"Simple Traversal of UDP Through NAT" to "Session Traversal
	Utilities for NAT". The acronym remains STUN, which is all
	anyone ever remembers anyway.
      
</p>
<a name="sec:overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Overview of Operation</h3>

<p>This section is descriptive only.
</p><br /><hr class="insert" />
<a name="fig:typical_stun_server"></a>

<p>
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
                            /--------\
                          //  STUN    \\
                         |    Agent    |
                          \\ (server) //
                            \--------/


                       +----------------+           Public Internet
       ................|      NAT 2     |.......................
                       +----------------+


                       +----------------+           Private NET 2
       ................|      NAT 1     |.......................
                       +----------------+

                            /--------\
                          //  STUN    \\
                         |    Agent    |
                          \\ (client) //             Private NET 1
                            \--------/

</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: One possible STUN Configuration&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>One possible STUN configuration is shown in Figure 1. In this configuration,
      there are two entities (called STUN agents) that implement the STUN protocol.
      The lower agent in the figure is connected to private network 1. 
      This network connects to private network
      2 through NAT 1. Private network 2 connects to the public Internet
      through NAT 2. The upper agent in the figure resides on the public Internet.
</p>
<p>STUN is a client-server protocol. It supports two types of
      transactions. One is a request/response transaction in which a client
      sends a request to a server, and the server returns a response. The
      second is an indication transaction in which a client sends an indication
      to the server and the server does not respond. Both types of transactions
      include a transaction ID, which is a randomly selected 96-bit number. 
      For request/response
      transactions, this transaction ID allows the client to associate the response
      with the request that generated it; for indications, this simply serves
      as a debugging aid.
</p>
<p>All STUN messages start with a fixed header that includes a
      method, a class, and the transaction ID. The method indicates
      which of the various requests or indications this is; this
      specification defines just one method, Binding, but other methods are
      expected to be defined in other documents. The class indicates
      whether this is a request, a success response, an error
      response, or an indication. Following the fixed header comes
      zero or more attributes, which are type-length-value extensions
      that convey additional information for the specific message.
</p>
<p>This document defines a single method called Binding. The
      Binding method can be used either in request/response
      transactions or in indication transactions. When used in
      request/response transactions, the Binding method can be used to
      determine the particular "binding" a NAT has allocated to a STUN
      client. When used in either request/response or in indication
      transactions, the Binding method can also be used to keep these
      "bindings" alive.
</p>
<p>In the Binding request/response transaction, a Binding
      Request is sent from a STUN client to a STUN server. When the
      Binding Request arrives at the STUN server, it may have passed
      through one or more NATs between the STUN client and the STUN
      server (in
      <a class='info' href='#fig:typical_stun_server'>Figure&nbsp;1<span> (</span><span class='info'>One possible STUN Configuration</span><span>)</span></a>, there were two
      such NATs). As the Binding Request message passes through a NAT,
      the NAT will modify the source transport address (that is, the
      source IP address and the source port) of the packet. As a
      result, the source transport address of the request received by
      the server will be the public IP address and port created by the
      NAT closest to the server. This is called a reflexive transport
      address. The STUN server copies that source transport address
      into an XOR-MAPPED-ADDRESS attribute in the STUN Binding
      Response and sends the Binding Response back to the the STUN
      client. As this packet passes back through a NAT, the NAT will
      modify the destination transport address in the IP header, but
      the transport address in the XOR-MAPPED-ADDRESS attribute within
      the body of the STUN response will remain untouched. In this
      way, the client can learn its reflexive transport address
      allocated by the outermost NAT with respect to the STUN
      server.
</p>
<p>In some usages, STUN must be multiplexed with other protocols
      (e.g., <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>,
      <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>). In these usages, there
      must be a way to inspect a packet and determine if it is a STUN
      packet or not. STUN provides three fields in the STUN header with
      fixed values that can be used for this purpose. If this is not
      sufficient, then STUN packets can also contain a FINGERPRINT
      value which can further be used to distinguish the packets.
</p>
<p>STUN defines a set of optional procedures that a usage can
      decide to use, called mechanisms. These mechanisms include DNS
      discovery, a redirection technique to an alternate server, a
      fingerprint attribute for demultiplexing, and two authentication
      and message integrity exchanges. The authentication mechanisms
      revolve around the use of a username, password, and
      message-integrity value. Two authentication mechanisms, the long-term
      credential mechanism and the short-term credential mechanism,
      are defined in this specification. Each usage specifies the
      mechanisms allowed with that usage.
</p>
<p>In the long-term credential mechanism, the client and server
	share a pre-provisioned username and password and perform a
	digest challenge/response exchange inspired by (but differing
	in details) to the one defined for HTTP
	<a class='info' href='#RFC2617'>[RFC2617]<span> (</span><span class='info'>Franks, J., Hallam-Baker, P., Hostetler, J., Lawrence, S., Leach, P., Luotonen, A., and L. Stewart, &ldquo;HTTP Authentication: Basic and Digest Access Authentication,&rdquo; June&nbsp;1999.</span><span>)</span></a>. In the short-term credential
	mechanism, the client and the server exchange a username and
	password through some out-of-band method prior to the STUN
	exchange. For example, in the ICE usage
	<a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a> the two endpoints use
	out-of-band signaling to exchange a username and
	password. These are used to integrity protect and authenticate
	the request and response. There is no challenge or nonce
	used. 
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Terminology</h3>

<p>In this document, the key words "MUST", "MUST NOT", "REQUIRED",
      "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
      "OPTIONAL" are to be interpreted as described in <a class='info' href='#RFC2119'>BCP 14, RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119] and indicate requirement levels
      for compliant STUN implementations.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Definitions</h3>

<blockquote class="text"><dl>
<dt>STUN Agent:</dt>
<dd>An entity that implements the STUN protocol.
	Agents can act as STUN clients for some transactions and as STUN servers
	for other transactions.
</dd>
<dt>STUN Client:</dt>
<dd>A logical role in the STUN protocol. A STUN client
	sends STUN requests or STUN indications, and receives STUN responses.
        The term "STUN client" is also used colloquially to refer to a STUN agent
	that only acts as a STUN client.
</dd>
<dt>STUN Server:</dt>
<dd>A logical role in the STUN protocol.
	A STUN server receives STUN requests or STUN indications
	and sends STUN responses.
	The term "STUN server" is also used colloquially to refer to a STUN agent
	that only acts as a STUN server.
</dd>
<dt>Transport Address:</dt>
<dd>The combination of an IP address and
        port number (such as a UDP or TCP port number).
</dd>
<dt>Reflexive Transport Address:</dt>
<dd>A transport address learned
        by a client that identifies that client as seen by another host on an
        IP network, typically a STUN server. When there is an intervening NAT
        between the client and the other host, the reflexive transport address
        represents the mapped address allocated to the client on the public
        side of the NAT. Reflexive transport addresses are learned from the
        mapped address attribute (MAPPED-ADDRESS or XOR-MAPPED-ADDRESS) in
        STUN responses.
</dd>
<dt>Mapped Address:</dt>
<dd>Same meaning as Reflexive Address. This
        term is retained only for for historic reasons and due to the naming
        of the MAPPED-ADDRESS and XOR-MAPPED-ADDRESS attributes.
</dd>
<dt>Long Term Credential:</dt>
<dd>A username and associated password
        that represent a shared secret between client and server. Long term
        credentials are generally granted to the client when a subscriber
        enrolls in a service and persist until the subscriber leaves the
        service or explicitly changes the credential.
</dd>
<dt>Long Term Password:</dt>
<dd>The password from a long term
        credential.
</dd>
<dt>Short Term Credential:</dt>
<dd>A temporary username and
        associated password which represent a shared secret between
        client and server. Short term credentials are obtained through
        some kind of protocol mechanism between the client server,
        preceding the STUN exchange. A short term credential has an
        explicit temporal scope, which may be based on a specific
        amount of time (such as 5 minutes) or on an event (such as
        termination of a SIP dialog). The specific scope of a short
        term credential is defined by the application usage. 
</dd>
<dt>Short Term Password:</dt>
<dd>The password component of a short
        term credential.
</dd>
<dt>STUN Indication:</dt>
<dd>A STUN message that does not receive a
        response
</dd>
<dt>Attribute:</dt>
<dd>The STUN term for a
        Type-Length-Value (TLV) object that can be
        added to a STUN message. Attributes are divided into two
        types: comprehension-required and comprehension-optional. STUN
        agents can safely ignore comprehension-optional attributes
        they don't understand, but cannot successfully process a
        message if it contains comprehension-required attributes that
        are not understood.
</dd>
<dt>RTO:</dt>
<dd>Retransmission TimeOut
</dd>
</dl></blockquote>
<a name="message_structure"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
STUN Message Structure</h3>

<p>STUN messages are encoded in binary using network-oriented format
      (most significant byte or octet first,
      also commonly known as big-endian). The transmission order is described
      in detail in Appendix B of <a class='info' href='#RFC0791'>RFC791<span> (</span><span class='info'>Postel, J., &ldquo;Internet Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a> [RFC0791]. Unless
      otherwise noted, numeric constants are in decimal (base 10).
</p><br /><hr class="insert" />
<a name="stun_message_header"></a>

<p>All STUN messages MUST start with a 20-byte
          header followed by zero or more Attributes. The STUN header contains a STUN
          message type, magic cookie, transaction ID, and message
          length.
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |0 0|     STUN Message Type     |         Message Length        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         Magic Cookie                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   |                     Transaction ID (96 bits)                  |
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Format of STUN Message Header&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The most significant two bits of every STUN message MUST be zeroes.
        This can be used to differentiate STUN packets from other protocols when STUN is
        multiplexed with other protocols on the same port.
</p>
<p>The message type defines the message class (request, success
        response, failure response, or indication) and the message method (the
        primary function) of the STUN message. Although there are four message
        classes, there are only two types of transactions in STUN:
        request/response transactions (which consist of a request message and
        a response message), and indication transactions (which consists a
        single indication message). Response classes are split into
        error and success responses to aid
        in quickly processing the STUN message.
</p><br /><hr class="insert" />
<a name="stun_message_type"></a>

<p>The message type field is decomposed further into the
          following structure:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
   +--+--+-+-+-+-+-+-+-+-+-+-+-+-+
   |M |M |M|M|M|C|M|M|M|C|M|M|M|M|
   |11|10|9|8|7|1|6|5|4|0|3|2|1|0|
   +--+--+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Format of STUN Message Type Field&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Here the bits in the message type field are shown as most-significant (M11)
           through least-significant (M0). M11 through M0 represent a 12-bit encoding
        of the method. C1
        and C0 represent a 2 bit encoding of the class. A class of 0b00 is
        a Request, a class of 0b01 is an indication, a class of 0b10 is a
        success response, and a class of 0b11 is an error response. This
        specification defines a single method, Binding. The method
           and class are orthogonal, so that four each method, a
           request, success response, error response and indication
           are defined for that method. 
</p>
<p>For example, a Binding Request has class=0b00 (request)
        and method=0b000000000001 (Binding), and is encoded into the first 16 bits as
        0x0001. A Binding response has class=0b10 (success response)
        and method=0b000000000001, and is encoded into the first 16 bits as
        0x0101.
</p>
<p></p>
<blockquote class="text">
<p>Note: This unfortunate encoding is due to assignment of values
            in <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a> which did not consider encoding
            Indications, Success, and Errors using bit fields.
</p>
</blockquote>

<p>The magic cookie field MUST contain the fixed value 0x2112A442
        in network byte order. In RFC
        3489 <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a>, this field was part of
        the transaction ID; 
        placing the magic cookie in this location allows a server to detect
        if the client will understand certain attributes that were added in this
        revised specification. In addition, it aids in distinguishing STUN packets
        from packets of other protocols when STUN is multiplexed with those other
        protocols on the same port.
</p>
<p>The transaction ID is a 96 bit identifier, used to uniquely
        identify STUN transactions. The transaction ID is chosen by the STUN
        client. It primarily serves to correlate requests with responses,
        though it also plays a small role in helping to prevent certain types
        of attacks. As such, the transaction ID MUST be
        uniformly and randomly chosen from the interval 0 .. 2**96-1. Resends
        of the same request reuse the same transaction ID, but the client MUST
        choose a new transaction ID for new transactions unless the new
        request is bit-wise identical to the previous request and sent from
        the same transport address to the same IP address. Success and error
        responses MUST carry the same transaction ID as their corresponding
        request. When an agent is acting as a STUN server and STUN client on
        the same port, the transaction IDs in requests sent by the
        agent have no relationship to the transaction IDs in requests
        received by the agent. 
</p>
<p>The message length MUST contain the size, in bytes, of the message
        not including the 20 byte STUN header. Since all STUN attributes are
        padded to a multiple of four bytes, the last two bits of this field
        are always zero. This provides another way to distinguish STUN packets
        from packets of other protocols.
</p>
<p>Following the STUN fixed portion of the header are zero or
        more attributes. Each attribute 
        is TLV (type-length-value) encoded. The details of the encoding, and
        of the attributes themselves is given in
        <a class='info' href='#attribute_details'>Section&nbsp;14<span> (</span><span class='info'>STUN Attributes</span><span>)</span></a>.
</p>
<a name="sec:base-procedures"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Base Protocol Procedures</h3>

<p>This section defines the base procedures of the STUN
	protocol. It describes how messages are formed, how they are
	sent, and how they are processed when they are received. It
	also defines the detailed processing of the Binding
	method. Other sections in this document describe optional 
	procedures that a usage may elect to use in certain
	situations. Other documents may define other extensions to
	  STUN, by adding new methods, new attributes, or new error
	response codes.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Forming a Request or an Indication</h3>

<p>When formulating a request or indication message, the
	client MUST follow the rules in
	<a class='info' href='#message_structure'>Section&nbsp;6<span> (</span><span class='info'>STUN Message Structure</span><span>)</span></a> when creating the
	header. In addition, the message class MUST be either
	"Request" or "Indication" (as appropriate), and the method
	must be either Binding or some method defined in another
	document.
</p>
<p>The client then adds any attributes specified by the method
	or the usage. For example, some usages may specify that the
	client use an authentication method
	(<a class='info' href='#sec:authentication-mechanisms'>Section&nbsp;10<span> (</span><span class='info'>Authentication and Message-Integrity Mechanisms</span><span>)</span></a>) or the
	FINGERPRINT attribute
	(<a class='info' href='#sec:fingerprint-extension'>Section&nbsp;8<span> (</span><span class='info'>FINGERPRINT Mechanism</span><span>)</span></a>).
</p>
<p>For the Binding method with no authentication, no 
	attributes are required unless the usage specifies
	otherwise.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
Sending the Request or Indication</h3>

<p>The client then sends the request to the server. This
	document specifies how to send STUN messages over UDP, TCP, or
	TLS-over-TCP; other transport protocols may be added in the
	future. The STUN usage must specify which transport protocol
	is used, and how the client determines the IP address and port
	of the server. <a class='info' href='#client_discovery'>Section&nbsp;9<span> (</span><span class='info'>DNS Discovery of a 	Server</span><span>)</span></a> describes a
	DNS-based method of determining the IP address and port of a
	server which a usage may elect to use. STUN may be used with
	anycast addresses, but only with UDP and in usages where
	authentication is not used. 
</p>
<p>At any time, a client MAY have multiple
	outstanding STUN requests with the same STUN server (that is,
	multiple transactions in progress, with different transaction
	ids).
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2.1"></a><h3>7.2.1.&nbsp;
Sending over UDP</h3>

<p>When running STUN over UDP it is possible that the STUN
	message might be dropped by the network. Reliability of STUN
	request/response transactions is accomplished through
	retransmissions of the request message by the client
	application itself. STUN indications are not retransmitted;
	thus indication transactions over UDP are not reliable.
</p>
<p>A client SHOULD retransmit a STUN request message starting with
   an interval of RTO ("Retransmission TimeOut"), doubling after each
   retransmission.  The RTO is an estimate of the round-trip-time, and
   is computed as described in RFC 2988 <a class='info' href='#RFC2988'>[RFC2988]<span> (</span><span class='info'>Paxson, V. and M. Allman, &ldquo;Computing TCP's Retransmission Timer,&rdquo; November&nbsp;2000.</span><span>)</span></a>, with two
   exceptions.  First, the initial value for RTO SHOULD be
   configurable (rather than the 3s recommended in RFC 2988) and
   SHOULD be greater than 100ms.  In
   fixed- line access links, a value of 100ms is RECOMMENDED. 
   Secondly, the value of RTO MUST NOT be rounded up to the nearest
   second.  Rather, a 1ms accuracy MUST be maintained.  As with TCP,
   the usage of Karn's algorithm is RECOMMENDED.  When applied to
   STUN, it means that RTT estimates SHOULD NOT be computed from STUN
   transactions which result in the retransmission of a request.
</p>
<p>The value for RTO SHOULD be cached by an client after the completion
   of the transaction, and used as the starting value for RTO for the
   next transaction to the same server (based on equality of IP address).
   The value SHOULD be considered stale and discarded after 10 minutes.
</p>
<p>Retransmissions continue until a response is received, or until a
   total of 7 requests have been sent.  If, after the last request, a
   duration equal to 16 times the RTO has passed without a response,
   the client SHOULD 
   consider the transaction to have failed.  A STUN transaction over UDP
   is also considered failed if there has been a transport failure of
   some sort, such as a fatal ICMP error.  For example, assuming an RTO
   of 100ms, requests would be sent at times 0ms, 100ms, 300ms, 700ms,
   1500ms, 3100ms, and 6300ms.  If the client has not received a
   response after 7900ms, the client will consider the transaction to
   have timed out.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2.2"></a><h3>7.2.2.&nbsp;
Sending over TCP or TLS-over-TCP</h3>

<p>For TCP and TLS-over-TCP, the client opens a TCP connection to the
server.
</p>
<p>
In some usage of STUN, STUN is sent as the only protocol over the TCP
connection. In this case, it can be sent without the aid of any
additional framing or demultiplexing. In other usages, or with other
extensions, it may be multiplexed with other data over a TCP
connection. In that case, STUN MUST be run on top of some kind of
framing protocol, specified by the usage or extension, which allows
for the agent to extract complete STUN messages and complete
application layer messages. 

</p>
<p>For TLS-over-TCP, the TLS_RSA_WITH_AES_128_CBC_SHA ciphersuite MUST be
   supported at a minimum.
   Implementations MAY also support any other ciphersuite.  When it
   receives the TLS Certificate message, the client SHOULD verify the
   certificate and inspect the site identified by the certificate.  If
   the certificate is invalid, revoked, or if it does not identify the
   appropriate party, the client MUST NOT send the STUN message or
   otherwise proceed with the STUN transaction.  The client MUST verify
   the identity of the server.  To do that, it follows the
   identification procedures defined in Section 3.1 of RFC 2818
   <a class='info' href='#RFC2818'>[RFC2818]<span> (</span><span class='info'>Rescorla, E., &ldquo;HTTP Over TLS,&rdquo; May&nbsp;2000.</span><span>)</span></a>.  Those procedures assume the client is
   dereferencing a 
   URI.  For purposes of usage with this specification, the client
   treats the domain name or IP address used in Section 8.1 as the host
   portion of the URI that has been dereferenced.  If DNS was not used,
   the client MUST be configured with a set of authorized domains whose
   certificates will be accepted.
</p>
<p>Reliability of STUN over TCP and TLS-over-TCP is handled by TCP
   itself, and there are no retransmissions at the STUN protocol
   level. However, for a request/response transaction, if the client
   has not received a response 7900ms after it sent the SYN to
   establish the connection, it considers the
   transaction to have timed out. This value has been chosen to
   equalize the TCP and UDP timeouts for the default initial RTO.
</p>
<p>
     In addition, if the client is unable to establish the TCP
     connection, or the TCP connection is reset or fails before a
     response is received, any request/response transaction in
     progress is considered to have failed
     
</p>
<p>The client MAY send multiple transactions over a single TCP
          (or TLS-over-TCP) connection, and it MAY send another
          request before receiving a response to the previous. The
          client SHOULD keep the 
          connection open until it</p>
<ul class="text">
<li>has no further STUN requests or indications to send over that
              connection, and;
</li>
<li>has no plans to use any resources (such as a mapped address
              (MAPPED-ADDRESS or XOR-MAPPED-ADDRESS) or relayed address <a class='info' href='#I-D.ietf-behave-turn'>[I&#8209;D.ietf&#8209;behave&#8209;turn]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN),&rdquo; July&nbsp;2009.</span><span>)</span></a>) that were learned though
              STUN requests sent over that connection, and;
</li>
<li>if multiplexing other application protocols over that port,
              has finished using that other application, and;
</li>
<li>if using that learned port with a remote peer, has
              established communications with that remote peer, as is required
              by some TCP NAT traversal techniques (e.g.,
              <a class='info' href='#I-D.ietf-mmusic-ice-tcp'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice&#8209;tcp]<span> (</span><span class='info'>Perreault, S. and J. Rosenberg, &ldquo;TCP Candidates with Interactive Connectivity Establishment (ICE),&rdquo; October&nbsp;2009.</span><span>)</span></a>).
</li>
</ul>

<p>At the server end, the server SHOULD keep the connection
	open, and let the client close it.  If a server becomes
	overloaded and needs to close connections to free up
	resources, it SHOULD close an existing connection rather than
	reject new connection requests.  The server SHOULD NOT close a
	connection if a request was received over that connection for
	which a response was not sent.  A server MUST NOT ever open a
	connection back towards the client in order to send a
	response.
</p>
<a name="sec:receiving-a-stun-message"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
Receiving a STUN Message</h3>

<p>This section specifies the processing of a STUN
	message. The processing specified here is for STUN
	messages as defined in this specification; additional rules
	for backwards compatibility are defined in 
	in <a class='info' href='#sec:backwards-compatibility'>Section&nbsp;12<span> (</span><span class='info'>Backwards Compatibility with RFC 3489</span><span>)</span></a>. Those
	additional procedures are optional, and usages can elect to
	utilize them. First, a set of processing operations are applied
	that are independent of the class. This is followed by
	class-specific processing, described in the subsections which
	follow.   
</p>
<p>When a STUN agent receives a STUN message, it first checks
	that the message obeys the rules of
	<a class='info' href='#message_structure'>Section&nbsp;6<span> (</span><span class='info'>STUN Message Structure</span><span>)</span></a>. It checks
	that the first two bits are 0, that the magic cookie field has
	the correct value, that the message length is sensible, and
	that the method value is a supported method. If the
	message-class is Success 
	Response or Error Response, the agent checks that the
	transaction ID matches a transaction that is still in
	progress. If the FINGERPRINT extension is being used, the
	agent checks that the FINGERPRINT attribute is present and
	contains the correct value. If any errors are detected, the
	message is silently discarded. In the case when STUN is being
	multiplexed with another protocol, an error may indicate that
	this is not really a STUN message; in this case, the agent
	should try to parse the message as a different protocol.
</p>
<p>The STUN agent then does any checks that are required by a
	authentication mechanism that the usage has specified (see
	<a class='info' href='#sec:authentication-mechanisms'>Section&nbsp;10<span> (</span><span class='info'>Authentication and Message-Integrity Mechanisms</span><span>)</span></a>.
</p>
<p>Once the authentication checks are done, the STUN agent
	checks for unknown attributes and known-but-unexpected
	attributes in the message. Unknown comprehension-optional
	attributes MUST be ignored by the agent. Known-but-unexpected
	attributes SHOULD be ignored by the agent. Unknown
	comprehension-required attributes cause processing that
	depends on the message-class and is described below.
</p>
<p>At this point, further processing depends on the message
	class of the request.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3.1"></a><h3>7.3.1.&nbsp;
Processing a Request</h3>

<p>If the request contains one or more unknown
	comprehension-required attributes, the server replies with an
	error response with an error code of 420 (Unknown Attribute),
	and includes an UNKNOWN-ATTRIBUTES attribute in the response
	that lists the unknown comprehension-required attributes.
</p>
<p>The server then does any additional checking that the
	method or the specific usage requires. If all the checks
	succeed, the server formulates a success response as described
	below.
</p>
<p>If the request uses UDP transport and is a retransmission
	of a request for which the server has already generated a
	success response within the last 10 seconds, the server MUST
	retransmit the same success response.  One way for a server to
	do this is to remember all transaction IDs received over UDP
	and their corresponding responses in the last 10
	seconds. Another way is to reprocess the request and recompute
	the response. The latter technique MUST only be applied to
	requests which are idempotent and result in the same success
	response for the same request. The Binding method is
	considered to idempotent in this way (even though certain rare
	network events could cause the reflexive transport address
	value to change). Extensions to STUN SHOULD state whether
	their request types have this property or not.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3.1.1"></a><h3>7.3.1.1.&nbsp;
Forming a Success or Error Response</h3>

<p>When forming the response (success or error), the server
	  follows the rules of section 6. The method of the response
	  is the same as that of the request, and the message class is
	  either "Success Response" or "Error Response".
</p>
<p>For an error response, the server MUST add an ERROR-CODE
	attribute containing the error code specified in the
	processing above. The reason phrase is not fixed, but SHOULD
	be something suitable for the error code. For certain errors,
	additional attributes are added to the message. These
	attributes are spelled out in the description where the error
	code is specified. For example, for an error code of 420
	(Unknown Attribute), the server MUST include an
	UNKNOWN-ATTRIBUTES attribute. Certain authentication errors
	also cause attributes to be added (see
	<a class='info' href='#sec:authentication-mechanisms'>Section&nbsp;10<span> (</span><span class='info'>Authentication and Message-Integrity Mechanisms</span><span>)</span></a>). Extensions may
	define other errors and/or additional attributes to add in
	error cases.
</p>
<p>If the server authenticated the request using an
	authentication mechanism, then the server SHOULD add the
	appropriate authentication attributes to the response (see
	<a class='info' href='#sec:authentication-mechanisms'>Section&nbsp;10<span> (</span><span class='info'>Authentication and Message-Integrity Mechanisms</span><span>)</span></a>).
</p>
<p>The server also adds any attributes required by the
	specific method or usage. In addition, the server SHOULD add a
	SERVER attribute to the message.
</p>
<p>For the Binding method, no additional checking is required
	unless the usage specifies otherwise. When forming the success
	response, the server adds a XOR-MAPPED-ADDRESS attribute to
	the response, where the contents of the attribute are the
	source transport address of the request message. For UDP, this
	is the source IP address and source UDP port of the request
	message. For TCP and TLS-over-TCP, this is the source IP
	address and source TCP port of the TCP connection as seen by
	the server. 
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3.1.2"></a><h3>7.3.1.2.&nbsp;
Sending the Success or Error Response</h3>

<p>The response (success or error) is sent over the same
	transport as the request was received on. If the request was
	received over UDP, the destination IP address and port of the
	response is the source IP address and port of the received
	request message, and the source IP address and port of the
	response is equal to the destination IP address and port of
	the received request message. If the request was received over
	TCP or TLS-over-TCP, the response is sent back on the same TCP
	connection as the request was received on.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3.2"></a><h3>7.3.2.&nbsp;
Processing an Indication</h3>

<p>If the indication contains unknown comprehension-required
	attributes, the indication is discarded and processing
	ceases.
</p>
<p>The server then does any additional checking that the
	method or the specific usage requires. If all the checks
	succeed, the server then processes the indication. No response
	is generated for an indication.
</p>
<p>For the Binding method, no additional checking or
	processing is required, unless the usage specifies
	otherwise. The mere receipt of the message by the server has
	refreshed the "bindings" in the intervening NATs.
</p>
<p>Since indications are not re-transmitted over UDP (unlike
	requests), there is no need to handle re-transmissions of
	indications at the server.
</p>
<a name="sec-success-resp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3.3"></a><h3>7.3.3.&nbsp;
Processing a Success Response</h3>

<p>If the success response contains unknown
	comprehension-required attributes, the response is discarded
	and the transaction is considered to have failed.
</p>
<p>The client then does any additional checking that the
	method or the specific usage requires. If all the checks
	succeed, the client then processes the success response.
</p>
<p>For the Binding method, the client checks that the
	XOR-MAPPED-ADDRESS attribute is present in the response. The
	client checks 
	the address family specified. If it is an unsupported address
	family, the attribute SHOULD be ignored. If it is an
	unexpected but supported address family (for example, the
	Binding transaction was sent over IPv4, but the address family
	specified is IPv6), then the client MAY accept and use the
	value. 
</p>
<a name="sec:processing-an-error-response"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3.4"></a><h3>7.3.4.&nbsp;
Processing an Error Response</h3>

<p>If the error response contains unknown
	comprehension-required attributes, or if the error response
	does not contain an ERROR-CODE attribute, then the transaction
	is simply considered to have failed.
</p>
<p>The client then does any processing specified by the
	authentication mechanism (see
	<a class='info' href='#sec:authentication-mechanisms'>Section&nbsp;10<span> (</span><span class='info'>Authentication and Message-Integrity Mechanisms</span><span>)</span></a>). This may
	result in a new transaction attempt.
</p>
<p>The processing at this point depends on the error-code, the
	method, and the usage; the following are the default
	rules:
</p>
<ul class="text">
<li>If the error code is 300 through 399, the client
		SHOULD consider the transaction as failed unless the
		ALTERNATE-SERVER extension is being used. See
		<a class='info' href='#sec:alternate-server-extension'>Section&nbsp;11<span> (</span><span class='info'>ALTERNATE-SERVER Mechanism</span><span>)</span></a>.
</li>
<li> If the error code is 400 through 499, the client
		declares the transaction failed; in the case of 420
		  (Unknown Attribute),
		the response should contain a UNKNOWN-ATTRIBUTES
		attribute that gives additional information.
</li>
<li>If the error code is 500 through 599, the client
		MAY resend the request; clients that do so MUST limit
		the number of times they do this. 
</li>
</ul>
<p>Any other error code
		causes the client to consider the transaction
		failed.
</p>
<a name="sec:fingerprint-extension"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
FINGERPRINT Mechanism</h3>

<p>This section describes an optional mechanism for STUN that aids in
     distinguishing STUN messages from packets of other protocols when
     the two are multiplexed on the same transport address. This
     mechanism is optional, and a STUN usage must describe if and when
     it is used.
</p>
<p>In some usages, STUN messages are multiplexed on the same
      transport address as other protocols, such as RTP. In order to
      apply the processing described in
      <a class='info' href='#sec:base-procedures'>Section&nbsp;7<span> (</span><span class='info'>Base Protocol Procedures</span><span>)</span></a>, STUN messages must first
      be separated from the application
      packets. <a class='info' href='#message_structure'>Section&nbsp;6<span> (</span><span class='info'>STUN Message Structure</span><span>)</span></a> describes three
      fixed fields in the STUN header that can be used for this
      purpose. However, in some cases, these three fixed fields may
      not be sufficient.
</p>
<p>When the FINGERPRINT extension is used, an agent includes
	the FINGERPRINT attribute in messages it sends to another
	agent. <a class='info' href='#sec:fingerprint'>Section&nbsp;14.5<span> (</span><span class='info'>FINGERPRINT</span><span>)</span></a> describes the
	placement and value of this attribute. When the agent receives
	what it believes is a STUN message, then, in addition to other
	basic checks, the agent also checks that the message contains
	a FINGERPRINT attribute and that the attribute contains the
	correct value (see
	<a class='info' href='#sec:receiving-a-stun-message'>Section&nbsp;7.3<span> (</span><span class='info'>Receiving a STUN Message</span><span>)</span></a>. This additional
	check helps the agent detect messages of other protocols that
	might otherwise seem to be STUN messages.
</p>
<a name="client_discovery"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
DNS Discovery of a
	Server</h3>

<p>This section describes an optional procedure for STUN that allows a
        client to use DNS to determine the IP address and port of a
        server. A STUN usage must
        describe if and when this extension is used. To use this
        procedure, the client must have a domain name and a service
        name; the usage must also describe how the client obtains
        these.
</p>
<p>When a client wishes to locate a STUN server in the public
	Internet that accepts Binding Request/Response transactions,
	the SRV service name is "stun". STUN usages MAY define
	additional DNS SRV service names.
</p>
<p>The domain name is resolved to a transport address using
        the SRV procedures specified in <a class='info' href='#RFC2782'>[RFC2782]<span> (</span><span class='info'>Gulbrandsen, A., Vixie, P., and L. Esibov, &ldquo;A DNS RR for specifying the location of services (DNS SRV),&rdquo; February&nbsp;2000.</span><span>)</span></a>. The
        DNS SRV service name is the service name provided as input to
        this procedure. The protocol in the SRV lookup is the
        transport protocol the client will run STUN over: "udp" for
        UDP, "tcp" for TCP, and "tls" for TLS-over-TCP. If, in the
        future, additional SRV records are defined for TLS over other
        transport protocols, those will need to utilize an SRV
        transport token of the form "tls-foo" for transport protocol
        "foo". 
</p>
<p>The procedures of RFC 2782 are followed to determine the server to
        contact. RFC 2782 spells out the details of how a set of SRV records
        are sorted and then tried. However, RFC2782 only states that the
        client should "try to connect to the (protocol, address, service)"
        without giving any details on what happens in the event of failure.
        When following these procedures, if the STUN transaction times
        out without 
        receipt of a response, the client SHOULD retry the request to the
        next server in the list of servers from the DNS SRV
        response. Such a retry is only possible for request/response
        transmissions, since indication transactions generate no
        response or timeout. 
</p>
<p>The default port for STUN requests is 3478, for both TCP and UDP.
        Administrators SHOULD use this port in their SRV records for UDP and
        TCP, but MAY use others. There is no default port for STUN over TLS,
        however a STUN server SHOULD use a port number for TLS
        different from 3478 so 
        that the server can determine whether the first
        message it will receive after the TCP connection is set up, is a STUN
        message or a TLS message.
</p>
<p>If no SRV records were found, the client performs an A or
        AAAA record lookup of the domain name. The result will be a
        list of IP addresses, each of which can be contacted at the
        default port using UDP or TCP, independent of the STUN
        usage. For usages that require TLS, lack of SRV records is
        equivalent to a failure of the transaction, since the request
        or indication MUST NOT be sent unless SRV records provided a
        transport address specifically for TLS.
</p>
<a name="sec:authentication-mechanisms"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Authentication and Message-Integrity Mechanisms</h3>

<p>This section defines two mechanisms for STUN that a client
	and server can use to provide authentication and
	message-integrity; these two mechanisms are known as the
	short-term credential mechanism and the long-term credential
	mechanism. These two mechanisms are optional, and each usage
	must specify if and when these mechanisms are
	used. Consequently, both clients and servers will know which
	mechanism (if any) to follow based on knowledge of which usage
	applies. For example, a STUN server on the public Internet
	supporting ICE would have no authentication, whereas the STUN
	server functionality in an agent supporting connectivity
	checks would utilize short term credentials. An
	overview of these two mechanisms is given in
	<a class='info' href='#sec:overview'>Section&nbsp;3<span> (</span><span class='info'>Overview of Operation</span><span>)</span></a>.
</p>
<p> Each mechanism specifies the additional processing
	required to use that mechanism, extending the processing
	specified in <a class='info' href='#sec:base-procedures'>Section&nbsp;7<span> (</span><span class='info'>Base Protocol Procedures</span><span>)</span></a>. The
	additional processing occurs in three different places: when
	forming a message; when receiving a message immediately after
	the the basic checks have been performed; and when doing the
	detailed processing of error responses.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1"></a><h3>10.1.&nbsp;
Short-Term Credential Mechanism</h3>

<p>
    The short-term credential mechanism assumes that, prior to the
    STUN transaction, the client and server have used some other protocol
    to exchange a credential in the form of a username and
    password. This credential is time-limited. The time-limit is
    defined by the usage. As an example, in the ICE usage
	<a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>, the two endpoints use
	out-of-band signaling to agree on a username and password, and
    this username and password is applicable for the duration of the
    media session.
</p>
<p>
    This credential is used to form a message integrity check in each
    request and in many responses. There is no challenge and response
    as in the long term mechanism; consequently, replay is prevented
    by virtue of the time-limited nature of the credential.
  
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1.1"></a><h3>10.1.1.&nbsp;
Forming a Request or Indication</h3>

<p>For a request or indication message, the agent MUST include the
	USERNAME and MESSAGE-INTEGRITY attributes in the message.  The
	HMAC for the MESSAGE-INTEGRITY attribute is computed as
	described in <a class='info' href='#message_integrity'>Section&nbsp;14.4<span> (</span><span class='info'>MESSAGE-INTEGRITY</span><span>)</span></a>. The key for
	the HMAC is the password. Note that the password is never
	included in the request or indication.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1.2"></a><h3>10.1.2.&nbsp;
Receiving a Request or Indication</h3>

<p>After the agent has done the basic processing of a message,
	the agent performs the checks listed below in order
	specified:
</p>
<ul class="text">
<li>If the message does not
		contain both a MESSAGE-INTEGRITY and a USERNAME
		attribute:
		  
<ul class="text">
<li>If the message is a request, the server MUST
		    reject the request with an error response. This
		    response MUST use an error code of 400 (Bad Request).
		      
</li>
<li>If the message is an indication, the server
		    MUST silently discard the indication.
		    
</li>
</ul>
		
</li>
<li>
		  If the USERNAME does not contain a username value
		  currently valid within the server:
		  
<ul class="text">
<li>
		      If the message is a request, the server MUST
		      reject the request with an error response. This
		      response MUST use an error code of 401 (Unauthorized).
		    
</li>
<li>
		      If the message is an indication, the server MUST
		      silently discard the indication.
		    
</li>
</ul>
		
</li>
<li>Using the password associated with the username,
		  compute the value for the message-integrity as
		  described in
		  <a class='info' href='#message_integrity'>Section&nbsp;14.4<span> (</span><span class='info'>MESSAGE-INTEGRITY</span><span>)</span></a>. If the
		  resulting value does not match the contents of the
		  MESSAGE-INTEGRITY attribute:
		  
<ul class="text">
<li>
		      If the message is a request, the server MUST
		      reject the request with an error response. This
		      response MUST use an error code of 401 (Unauthorized).
		    
</li>
<li>
		      If the message is an indication, the server MUST
		      silently discard the indication.
		    
</li>
</ul>
		
</li>
</ul>
<p>If these checks pass, the server continues to process the
	  request or indication. Any response generated by the server
	  MUST include the MESSAGE-INTEGRITY attribute, computed
	  using the password utilized to authenticate
	  the request. The response MUST NOT contain the USERNAME
	  attribute.
</p>
<p>
	  If any of the checks fail, the server MUST NOT include a
	  MESSAGE-INTEGRITY or USERNAME attribute in the error
	  response. This is because, in these failure cases,
	  the server cannot determine the shared secret necessary to
	  compute MESSAGE-INTEGRITY. 
	
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1.3"></a><h3>10.1.3.&nbsp;
Receiving a Response</h3>

<p>
    The client looks for the MESSAGE-INTEGRITY attribute in the
    response. If present, the client computes the message integrity
    over the response as defined in
    <a class='info' href='#message_integrity'>Section&nbsp;14.4<span> (</span><span class='info'>MESSAGE-INTEGRITY</span><span>)</span></a>, using the same password it
    utilized for the request. If the resulting value matches the
    contents of the MESSAGE-INTEGRITY attribute, the response is
    considered authenticated. If the value does not match, or if
    MESSAGE-INTEGRITY was absent, the
    response MUST be discarded, as if it was never received. This
    means that retransmits, if applicable, will continue.
  
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2"></a><h3>10.2.&nbsp;
Long-term Credential Mechanism</h3>

<p>
    The long-term credential mechanism relies on a long term
    credential, in the form of a username and password, that are
    shared between client and server. The credential is considered
    long-term since it is assumed that it is provisioned for a user,
    and remains in effect until the user is no longer a subscriber of
    the system, or is changed. This is basically a traditional
    "log-in" username and password given to users.
  
</p>
<p>
    Because these usernames and passwords are expected to be valid for
    extended periods of time, replay prevention is provided in the
    form of a digest challenge. In this mechanism, the client
    initially sends a request, without offering any credentials or any
    integrity checks. The server rejects this request, providing the
    user a realm (used to guide the user or agent in selection of a
    username and password) and a nonce. The nonce provides the replay
    protection. It is a cookie, selected by the server, and encoded in
    such a way as to indicate a duration of validity or client
    identity from which it is valid. The client retries the request,
    this time including its username, the realm, and echoing the nonce
    provided by the server. The client also includes a
    message-integrity, which provides an HMAC over the entire request,
    including the nonce. The server validates the nonce, and checks
    the message-integrity. If they match, the request is
    authenticated. If the nonce is no longer valid, it is considered
    "stale", and the server rejects the request, providing a new
    nonce.
  
</p>
<p>
    In subsequent requests to the same server, the client reuses the
    nonce, username, realm and password it used previously. In this
    way, subsequent requests are not rejected until the nonce becomes
    invalid by the server, in which case the rejection provides a new
    nonce to the client.
  
</p>
<p>Note that the long-term credential mechanism cannot be used
	to protect indications, since indications cannot be
	challenged. Usages utilizing indications must either use a
	short-term credential, or omit authentication and message
	integrity for them.
</p>
<p>
    Since the long-term credential mechanism is susceptible to offline
    dictionary attacks, deployments SHOULD utilize strong passwords.
  
</p>
<p>
    For STUN servers used in conjunction with SIP servers, it is
    desirable to use the same credentials for authentication to the
    SIP server and STUN server. Typically, SIP systems utilizing SIP's
    digest authentication mechanism do not actually store the password
    in the database. Rather, they store a value called H(A1), which is
    computed as:
  
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
H(A1) = MD5(username ":" realm ":" password)
</pre></div>
<p>
    If a system wishes to utilize this credential, the STUN password
    would be computed by taking the user-entered username and
    password, and using H(A1) as the STUN password. It is RECOMMENDED
    that clients utilize this construction for the STUN password. 
  
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2.1"></a><h3>10.2.1.&nbsp;
Forming a Request</h3>

<p>
There are two cases when forming a request. In the first case, this is
the first request from the client to the server (as identified by its
IP address and port). In the second case, the client is submitting a
subsequent request once a previous request/response transaction has
completed successfully.

</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2.1.1"></a><h3>10.2.1.1.&nbsp;
First Request</h3>

<p>
If the client has not completed a successful request/response
transaction with the server, it SHOULD omit the USERNAME,
MESSAGE-INTEGRITY, REALM, and NONCE attributes. In other words, the
very first request is sent as if there were no authentication or
message integrity applied.

</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2.1.2"></a><h3>10.2.1.2.&nbsp;
Subsequent Requests</h3>

<p>
Once a request/response transaction has completed successfully, the
client will have been been presented a realm and nonce by the server, and
selected a username and password with which it authenticated. The
client SHOULD cache the username, password, realm, and nonce for
subsequent communications with the server. When the client sends a
subsequent request, it SHOULD include the USERNAME, REALM, and NONCE
attributes with these cached values. It SHOULD include a
MESSAGE-INTEGRITY attributed, computed as described in
<a class='info' href='#message_integrity'>Section&nbsp;14.4<span> (</span><span class='info'>MESSAGE-INTEGRITY</span><span>)</span></a> using the cached password as
the key. 

</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2.2"></a><h3>10.2.2.&nbsp;
Receiving a Request</h3>

<p>
  After the server has done the basic processing of a request, it
  performs the checks listed below in the order specified:

</p>
<ul class="text">
<li>If the message:
    
<ul class="text">
<li>does not
	contain a MESSAGE-INTEGRITY attribute,
      
</li>
<li>OR, it contains a USERNAME whose value is not a
	valid username,
      
</li>
</ul>
    the server MUST
    generate an error response with an error code of
    401 (Unauthorized). This response MUST include a REALM value. It is
    RECOMMENDED that the REALM value be the domain name of
    the provider of the STUN server. The response MUST
    include a NONCE, selected by the server. 
  
</li>
<li>
    If the message contains a MESSAGE-INTEGRITY
    attribute, but is missing the USERNAME, REALM or
    NONCE attributes, the server MUST generate an error
    response with an error code of 400 (Bad Request). 
  
</li>
<li>
    If the NONCE is no longer valid, the server MUST
    generate an error response with an error code of 438
    (Stale Nonce). This response MUST include a NONCE and REALM
    attribute.
  
</li>
<li>Using the password associated with the username in
    the USERNAME attribute,
    compute the value for the message-integrity as
    described in
    <a class='info' href='#message_integrity'>Section&nbsp;14.4<span> (</span><span class='info'>MESSAGE-INTEGRITY</span><span>)</span></a>. If the
    resulting value does not match the contents of the
    MESSAGE-INTEGRITY attribute, the server MUST
    reject the request with an error response. This
    response MUST use an error code of 401 (Unauthorized). It MUST include a REALM
    and NONCE attribute.
  
</li>
</ul>
<p>If these checks pass, the server continues to process the
  request or indication. Any response generated by the server
  MUST include the MESSAGE-INTEGRITY attribute, computed
  using the username and password utilized to authenticate
  the request. The REALM, NONCE, and USERNAME attributes SHOULD NOT
  be included. 
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.2.3"></a><h3>10.2.3.&nbsp;
Receiving a Response</h3>

<p>
    If the response is an error response, with an error code of 401
    (Unauthorized), the client SHOULD retry the request with a new
    transaction. This request MUST contain a USERNAME, determined by
    the client as the appropriate username for the REALM from the
    error response. The request MUST contain the REALM, copied from
    the error response. The request MUST contain the NONCE, copied
    from the error response. The request MUST contain the
    MESSAGE-INTEGRITY attribute, computed using the password
    associated with the username in the USERNAME attribute. The client
    MUST NOT perform this retry if it is not changing the USERNAME or
    REALM or its associated password, from the previous attempt.  
  
</p>
<p>
    If the response is an error response with an error code of 438
    (Stale Nonce),
    the client MUST retry the request, using the new NONCE supplied in
    the 438 (Stale Nonce) response. This retry MUST also include the USERNAME, REALM
    and MESSAGE-INTEGRITY.
  
</p>
<p>
    The client looks for the MESSAGE-INTEGRITY attribute in the
    response (either success or failure). If present, the client
    computes the message integrity 
    over the response as defined in
    <a class='info' href='#message_integrity'>Section&nbsp;14.4<span> (</span><span class='info'>MESSAGE-INTEGRITY</span><span>)</span></a>, using the same password it
    utilized for the request. If the resulting value matches the
    contents of the MESSAGE-INTEGRITY attribute, the response is
    considered authenticated. If the value does not match, or if
    MESSAGE-INTEGRITY was absent, the
    response MUST be discarded, as if it was never received. This
    means that retransmits, if applicable, will continue.
  
</p>
<a name="sec:alternate-server-extension"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
ALTERNATE-SERVER Mechanism</h3>

<p>This section describes a mechanism in STUN that allows a
	server to redirect a client to another server. This extension
	is optional, and a usage must define if and when this
	extension is used. To prevent denial-of-service attacks, this
	extension MUST only be used in situations where the client and
	server are using an authentication and message-integrity
	mechanism.
</p>
<p>A server using this extension redirects a client to another
	server by replying to a request message with an error response
	message with an error code of 300 (Try Alternate). The server
	MUST include a ALTERNATE-SERVER attribute in the error
	response. The error response message MUST be authenticated,
	which in practice means the request message must have passed
	the authentication checks.
</p>
<p>A client using this extension handles a 300 (Try Alternate)
	error code as follows. If the error response has passed the
	authentication checks, then the client looks for a
	ALTERNATE-SERVER attribute in the error response. If one is
	found, then the client considers the current transaction as
	failed, and re-attempts the request with the server specified
	in the attribute. The client SHOULD reuse any authentication
	credentials from the old request in the new transaction.
</p>
<a name="sec:backwards-compatibility"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
Backwards Compatibility with RFC 3489</h3>

<p>This section define procedures that allow a degree of
	  backwards compatible with the original protocol defined in
	  RFC 3489 <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a>. This mechanism is
	  optional, meant to be utilized only in cases where a new
	  client can connect to an old server, or vice-a-versa. A
	  usage must define if and when this procedure is used.
</p>
<p><a class='info' href='#sec-changes'>Section&nbsp;18<span> (</span><span class='info'>Changes Since RFC 3489</span><span>)</span></a> lists all the changes between
	this specification and RFC 3489 <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a>. However, not
	all of these differences are important, because "classic STUN"
	was only used in a few specific ways. For the
	purposes of this extension, the important changes are the
	following. In RFC 3489:
</p>
<ul class="text">
<li>UDP was the only supported transport;
</li>
<li>The field that is now the Magic Cookie field was a part of
		the transaction id field, and transaction ids were 128
		bits long;
</li>
<li>The XOR-MAPPED-ADDRESS attribute
		did not exist, and the Binding method used the
		MAPPED-ADDRESS attribute instead;
</li>
<li>There were
		two comprehension-required attributes,
		RESPONSE-ADDRESS and CHANGE-REQUEST, that have been
		removed from this specification;
		  
<ul class="text">
<li>These attributes are now part of the NAT
		    Behavior Discovery usage.
</li>
</ul>
</li>
</ul>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12.1"></a><h3>12.1.&nbsp;
Changes to Client Processing</h3>

<p> A client that wants to interoperate with a
<a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a> server SHOULD send a request message that
uses the Binding method, contains no attributes, and uses UDP as the
transport protocol to the server. If successful, the success response
received from the server will contain a MAPPED-ADDRESS attribute
rather than an XOR-MAPPED-ADDRESS attribute; other than this change,
the processing of the response is identical to the procedures
described above.
</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12.2"></a><h3>12.2.&nbsp;
Changes to Server Processing</h3>

<p>
A STUN server can detect when a given Binding Request message was sent
from an RFC 3489 <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a> client by the absence of the
correct value in the Magic Cookie field. When the server detects an
RFC 3489 client, it SHOULD copy the value seen in the Magic Cookie
field in the Binding Request to the Magic Cookie field in the Binding
Response message, and insert a MAPPED-ADDRESS attribute instead of an
XOR-MAPPED-ADDRESS attribute.
</p>
<p>The client might, in rare situations, include either the
	RESPONSE-ADDRESS or CHANGE-REQUEST attributes. In these
	situations, the server will view these as unknown
	comprehension-required attributes and reply with an error
	response. Since the mechanisms utilizing those attributes are
	no longer supported, this behavior is acceptable.
</p>
<a name="usages"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.13"></a><h3>13.&nbsp;
STUN Usages</h3>

<p>STUN by itself is not a solution to the NAT traversal
	problem. Rather, STUN defines a tool that can
	be used inside a larger solution. The term "STUN Usage" is
	used for any solution that uses STUN as a component.
</p>
<p>At the time of writing, three STUN usages are defined:
       Interactive Connectivity Establishment (ICE)
       <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>, Client-initiated
       connections for SIP <a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>, and
       NAT Behavior Discovery
       <a class='info' href='#I-D.ietf-behave-nat-behavior-discovery'>[I&#8209;D.ietf&#8209;behave&#8209;nat&#8209;behavior&#8209;discovery]<span> (</span><span class='info'>MacDonald, D. and B. Lowekamp, &ldquo;NAT Behavior Discovery Using STUN,&rdquo; September&nbsp;2009.</span><span>)</span></a>.  Other
       STUN usages may be defined in the future.
</p>
<p>A STUN usage defines how STUN is actually utilized - when
	to send requests, what to do with the responses, and which
	optional procedures defined here (or in an extension to STUN) are
	to be used. A usage would also define:
</p>
<ul class="text">
<li>Which STUN methods are used;
</li>
<li>What authentication and message integrity
		mechanisms are used;
</li>
<li>What mechanisms are used to distinguish STUN
		messages from other messages. When STUN is run over
		TCP, a framing mechanism may be required;
</li>
<li>How a STUN client determines the IP address and
		port of the STUN server;
</li>
<li>Whether backwards compatibility to RFC 3489 is
		required;
</li>
<li>What optional attributes defined here (such as
		FINGERPRINT and ALTERNATE-SERVER) or in other
		extensions are required.
</li>
</ul>
<p>In addition, any STUN usage must consider the security
	implications of using STUN in that usage. A number of attacks
	against STUN are known (see the Security Considerations
	section in this document) and any usage must consider how
	these attacks can be thwarted or mitigated.
</p>
<p>Finally, a usage must consider whether its usage of STUN is
	an example of the Unilateral Self-Address Fixing approach to
	NAT traversal, and if so, address the questions raised in RFC
	3424.
</p>
<a name="attribute_details"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14"></a><h3>14.&nbsp;
STUN Attributes</h3>
<br /><hr class="insert" />
<a name="stun_attribute"></a>

<p>After the STUN header are zero or more attributes. Each
          attribute MUST be TLV encoded, with a 16 bit type, 16 bit length,
          and value. Each STUN attribute MUST end on a 32 bit
          boundary. As mentioned above, all fields in an attribute are transmitted most
          significant bit first.
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Type                  |            Length             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         Value (variable)                ....
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: Format of STUN Attributes&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The value in the Length field MUST contain the length of the Value
        part of the attribute, prior to padding, measured in bytes. Since STUN
        aligns attributes on 32 bit boundaries, attributes whose content is
        not a multiple of 4 bytes are padded with 1, 2 or 3 bytes of padding
        so that its value contains a multiple of 4 bytes. The padding bits are
        ignored, and may be any value.
</p>
<p>Any attribute type MAY appear more than once in a STUN message.
        Unless specified otherwise, the order of appearance is significant:
        only the first occurance needs to be processed by a receiver, and any
        duplicates MAY be ignored by a receiver.
</p>
<p>To allow future revisions of this specification to add new
      attributes if needed, the attribute space is divided into two
      ranges.  Attributes with type values between 0x0000 and 0x7FFF
      are comprehension-required attributes, which means that the STUN
      agent cannot successfully process the message unless it
      understands the attribute.  Attributes with type values between
      0x8000 and 0xFFFF are comprehension-optional attributes, which
      means that those attributes can be ignored by the STUN agent if
      it does not understand them.
</p>
<p>The STUN Attribute types defined by this
          specification are:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Comprehension-required range (0x0000-0x7FFF):
    0x0000: (Reserved)
    0x0001: MAPPED-ADDRESS
    0x0006: USERNAME
    0x0007: (Reserved; was PASSWORD)
    0x0008: MESSAGE-INTEGRITY
    0x0009: ERROR-CODE
    0x000A: UNKNOWN-ATTRIBUTES
    0x0014: REALM
    0x0015: NONCE
    0x0020: XOR-MAPPED-ADDRESS

  Comprehension-optional range (0x8000-0xFFFF)
    0x8022: SERVER
    0x8023: ALTERNATE-SERVER
    0x8028: FINGERPRINT
</pre></div>
<p>The rest of this section describes the format of the various
      attributes defined in this specification. 
</p>
<a name="mapped_address"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.1"></a><h3>14.1.&nbsp;
MAPPED-ADDRESS</h3>

<p>The MAPPED-ADDRESS attribute indicates a reflexive
        transport address of the client. It consists of an eight bit
        address family, and a sixteen bit port, followed by a fixed
        length value representing the IP address. If the address
        family is IPv4, the address MUST be 32 bits.  If the address
        family is IPv6, the address MUST be 128 bits. All fields must
        be in network byte order.
</p><br /><hr class="insert" />
<a name="mapped_address_syntax"></a>

<p>The format of the MAPPED-ADDRESS attribute is:
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |0 0 0 0 0 0 0 0|    Family     |           Port                |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   |                 Address (32 bits or 128 bits)                 |
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: Format of MAPPED-ADDRESS attribute&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The address family can take on the following
          values:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  0x01:IPv4
  0x02:IPv6
</pre></div>
<p>
</p>
<p>The first 8 bits of the MAPPED-ADDRESS MUST be set to 0 and
        MUST be
        ignored by receivers. These bits are present for aligning parameters
        on natural 32 bit boundaries.
</p>
<p>
	  This attribute is used only by servers for achieving
	  backwards compatibility with RFC 3489
	  <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a> clients. 
	
</p>
<a name="xor_mapped_address"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.2"></a><h3>14.2.&nbsp;
XOR-MAPPED-ADDRESS</h3>

<p>The XOR-MAPPED-ADDRESS attribute is identical to the
        MAPPED-ADDRESS attribute, except that the reflexive transport
        address is obfuscated through the XOR function.
</p><br /><hr class="insert" />
<a name="xor_mapped_address_format"></a>

<p>The format of the XOR-MAPPED-ADDRESS is:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |x x x x x x x x|    Family     |         X-Port                |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                X-Address (Variable)
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: Format of XOR-MAPPED-ADDRESS Attribute&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The Family represents the IP address family, and is encoded
        identically to the Family in MAPPED-ADDRESS.
</p>
<p>X-Port is the mapped port, exclusive or'd with most significant 16
        bits of the magic cookie. If the IP address family is IPv4, X-Address
        is the mapped IP address exclusive or'd with the magic cookie. If the
        IP address family is IPv6, the X-Address is the mapped IP address
        exclusively or'ed with the magic cookie and the 96-bit transaction
        ID.
</p>
<p>For example, using the "^" character to indicate exclusive or, if
        the IP address is 192.168.1.1 (0xc0a80101) and the port is 5555
        (0x15B3), the X-Port would be 0x15B3 ^ 0x2112 = 0x34A1, and the
        X-Address would be 0xc0a80101 ^ 0x2112A442 = 0xe1baa543.
</p>
<p>The rules for encoding and processing the first 8 bits of the
        attribute's value, the rules for handling multiple occurrences of the
        attribute, and the rules for processing addresses families are the
        same as for MAPPED-ADDRESS.
</p>
<p>NOTE: XOR-MAPPED-ADDRESS and MAPPED-ADDRESS differ only in their
          encoding of the transport address. The former encodes the transport
          address by exclusive-or'ing it with
          the magic cookie. The latter encodes it directly in binary. RFC
          3489 originally specified only MAPPED-ADDRESS. However, deployment
          experience found that some NATs rewrite the 32-bit binary payloads
          containing the NAT's public IP address, such as STUN's
          MAPPED-ADDRESS attribute, in the well-meaning but misguided attempt
          at providing a generic ALG function. Such behavior interferes with
          the operation of STUN and also causes failure of STUN's message
          integrity checking.
</p>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.3"></a><h3>14.3.&nbsp;
USERNAME</h3>

<p>The USERNAME attribute is used for message integrity. It
        identifies the username and password combination used in the
        message integrity check.
	  
</p>
<p>The value of USERNAME is a variable length value. It
        MUST contain a UTF-8 encoded sequence of less than 128
        characters (which can be as long as 763 bytes). 
</p>
<a name="message_integrity"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.4"></a><h3>14.4.&nbsp;
MESSAGE-INTEGRITY</h3>

<p>The MESSAGE-INTEGRITY attribute contains an <a class='info' href='#RFC2104'>HMAC-SHA1<span> (</span><span class='info'>Krawczyk, H., Bellare, M., and R. Canetti, &ldquo;HMAC: Keyed-Hashing for Message Authentication,&rdquo; February&nbsp;1997.</span><span>)</span></a> [RFC2104] of the STUN message. The
        MESSAGE-INTEGRITY attribute can be present in any STUN message type.
        Since it uses the SHA1 hash, the HMAC will be 20 bytes. The text used
        as input to HMAC is the STUN message, including the header, up to and
        including the attribute preceding the MESSAGE-INTEGRITY attribute.
        With the exception of the FINGERPRINT attribute, which appears after
        MESSAGE-INTEGRITY, agents MUST ignore all other attributes that
        follow MESSAGE-INTEGRITY.
</p>
<p>The key used as input to HMAC is the password.
</p>
<p>Based on the rules above, the hash includes the length
        field from the STUN message header. This length indicates the
        length of the entire message, including the MESSAGE-INTEGRITY
        attribute itself. Consequently, the MESSAGE-INTEGRITY
        attribute MUST be inserted into the message (with dummy
        content) prior to the computation of the integrity check. Once
        the computation is performed, the value of the attribute can
        be filled in. This ensures the length has the correct value
        when the hash is performed. Similarly, when validating the
        MESSAGE-INTEGRITY, the length field should be adjusted to
        point to the end of the MESSAGE-INTEGRITY attribute prior to
        calculating the HMAC. Such adjustment is necessary when
        attributes, such as FINTERPRINT, appear after
        MESSAGE-INTEGRITY. 
</p>
<a name="sec:fingerprint"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.5"></a><h3>14.5.&nbsp;
FINGERPRINT</h3>

<p>The FINGERPRINT attribute may be present in all STUN
        messages. The value of the attribute is computed as the CRC-32
        of the STUN message up to (but excluding) the FINGERPRINT
        attribute itself, xor-d with the 32 bit value 0x5354554e (the
        XOR helps in cases where an application packet is also using
        CRC-32 in it). The 32 bit CRC is the one defined in ITU V.42
        <a class='info' href='#ITU.V42.1994'>[ITU.V42.1994]<span> (</span><span class='info'>International Telecommunications Union, &ldquo;Error-correcting Procedures for DCEs Using Asynchronous-to-Synchronous Conversion,&rdquo; 1994.</span><span>)</span></a>, which has a generator polynomial
        of x32+x26+x23+x22+x16+x12+x11+x10+x8+x7+x5+x4+x2+x+1. When present,
        the FINGERPRINT attribute MUST be the last attribute in the
        message, and thus will appear after MESSAGE-INTEGRITY.
</p>
<p>The FINGERPRINT attribute can aid in distinguishing STUN packets
        from packets of other protocols. See <a class='info' href='#sec:fingerprint-extension'>Section&nbsp;8<span> (</span><span class='info'>FINGERPRINT Mechanism</span><span>)</span></a>.
</p>
<p>When using the FINGERPRINT attribute in a message,
        the attribute is first placed into the message with a dummy value,
        then the CRC is computed, and then the value of the attribute is updated.
        If the MESSAGE-INTEGRITY attribute is also present, then it must be
        present with the correct message-integrity value before the CRC is
        computed, since the CRC is done over the value of the MESSAGE-INTEGRITY
        attribute as well.
</p>
<a name="sec:error-code"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.6"></a><h3>14.6.&nbsp;
ERROR-CODE</h3>

<p>The ERROR-CODE attribute is used in Error Response messages.
        It contains a numeric error code value in the range
        of 300 to 699 plus a textual reason phrase encoded in UTF-8, and is
        consistent in its code assignments and semantics with <a class='info' href='#RFC3261'>SIP<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [RFC3261] and <a class='info' href='#RFC2616'>HTTP<span> (</span><span class='info'>Fielding, R., Gettys, J., Mogul, J., Frystyk, H., Masinter, L., Leach, P., and T. Berners-Lee, &ldquo;Hypertext Transfer Protocol -- HTTP/1.1,&rdquo; June&nbsp;1999.</span><span>)</span></a> [RFC2616].
        The reason phrase is meant for user consumption, and can be anything
        appropriate for the error code. Recommended reason phrases for the
        defined error codes are presented below. The reason phrase
        MUST be a UTF-8 encoded sequence of less than 128 characters
        (which can be as long as 763 bytes).
</p>
<p>To facilitate processing, the class of the error code (the
          hundreds digit) is encoded separately from the rest of the
          code.
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |           Reserved, should be 0         |Class|     Number    |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |      Reason Phrase (variable)                                ..
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>The Reserved bits SHOULD be 0, and are for alignment on
          32-bit boundaries. Receivers MUST ignore these bits. The Class
          represents the hundreds digit of the error code. The value MUST
          be between 3 and 6. The number represents the error code modulo
          100, and its value MUST be between 0 and 99.
</p>
<p>
</p>
<p>The following error codes, along with their recommended
        reason phrases (in brackets) are defined:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>300</dt>
<dd>Try Alternate: The client should contact an
            alternate server for this request. This error response MUST only
            be sent if the request included a USERNAME attribute and a valid
            MESSAGE-INTEGRITY attribute; otherwise it MUST NOT be sent and
            error code 400 (Bad Request) is suggested. This error response MUST be protected
            with the MESSAGE-INTEGRITY attribute, and receivers MUST validate
            the MESSAGE-INTEGRITY of this response before redirecting
            themselves to an alternate server.
<blockquote class="text">
<p>Note: failure to generate and validate message-integrity
                for a 300 response allows an on-path attacker to falsify a 300
                response thus causing subsequent STUN messages to be sent to a
                victim.
</p>
</blockquote>
</dd>
<dt>400</dt>
<dd>Bad Request: The request was malformed. The
            client SHOULD NOT retry the request without modification from the
            previous attempt. The server may not be able to generate a valid
            MESSAGE-INTEGRITY for this error, so the client MUST NOT expect a
            valid MESSAGE-INTEGRITY attribute on this response.
</dd>
<dt>401</dt>
<dd>Unauthorized: The request did not contain the
            expected MESSAGE-INTEGRITY attribute. The server MAY include the
            MESSAGE-INTEGRITY attribute in its error response.
</dd>
<dt>420</dt>
<dd>Unknown Attribute: The server received STUN
            packet containing a comprehension-required attribute which it did not
            understand. The server MUST put this unknown attribute in the
            UNKNOWN-ATTRIBUTE attribute of its error response.
</dd>
<dt>438</dt>
<dd>Stale Nonce: The NONCE used by the
            client was no longer valid. The client should retry,
            using the NONCE provided in the response. 
</dd>
<dt>500</dt>
<dd>Server Error: The server has suffered a
            temporary error. The client should try again.
</dd>
</dl></blockquote>

<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.7"></a><h3>14.7.&nbsp;
REALM</h3>

<p>The REALM attribute may be present in requests and responses. It
        contains text which meets the grammar for "realm-value" as described in
        <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [RFC3261] but without the double
        quotes and their surrounding whitespace. That is, it is an
        unquoted realm-value. It MUST be a UTF-8 encoded sequence of
        less than 128 characters (which can be as long as 763 bytes). 
</p>
<p>Presence of the REALM attribute in a request indicates that
        long-term credentials are being used for authentication. Presence in
        certain error responses indicates that the server wishes the client to
        use a long-term credential for authentication.
</p>
<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.8"></a><h3>14.8.&nbsp;
NONCE</h3>

<p>The NONCE attribute may be present in requests and responses. It
        contains a sequence of qdtext or quoted-pair, which are defined in
        <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [RFC3261]. See <a class='info' href='#RFC2617'>RFC
        2617<span> (</span><span class='info'>Franks, J., Hallam-Baker, P., Hostetler, J., Lawrence, S., Leach, P., Luotonen, A., and L. Stewart, &ldquo;HTTP Authentication: Basic and Digest Access Authentication,&rdquo; June&nbsp;1999.</span><span>)</span></a> [RFC2617], Section 4.3, for guidance on selection of nonce
        values in a server. It MUST be less than 128 characters (which
        can be as long as 763 bytes).
</p>
<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.9"></a><h3>14.9.&nbsp;
UNKNOWN-ATTRIBUTES</h3>

<p>The UNKNOWN-ATTRIBUTES attribute is present only in an error
        response when the response code in the ERROR-CODE attribute is
        420.
</p><br /><hr class="insert" />
<a name="unknown_attribute_format"></a>

<p>The attribute contains a list of 16 bit values, each of
          which represents an attribute type that was not understood by the
          server.
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      Attribute 1 Type           |     Attribute 2 Type        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |      Attribute 3 Type           |     Attribute 4 Type    ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;7: Format of UNKNOWN-ATTRIBUTES attribute&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p></p>
<blockquote class="text">
<p>Note: In <a class='info' href='#RFC3489'>[RFC3489]<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a>, this field was padded
            to 32 by duplicating the last attribute. In this version of the specification,
            the normal padding rules for attributes are used instead.
</p>
</blockquote>

<a name="anchor29"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.10"></a><h3>14.10.&nbsp;
SERVER</h3>

<p>The server attribute contains a textual description of the software
        being used by the server, including manufacturer and version number.
        The attribute has no impact on operation of the protocol, and serves
        only as a tool for diagnostic and debugging purposes. The value of
        SERVER is variable length. It MUST be a UTF-8 encoded sequence
        of less than 128 characters (which can be as long as 763
        bytes). 
</p>
<a name="anchor30"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.14.11"></a><h3>14.11.&nbsp;
ALTERNATE-SERVER</h3>

<p>The alternate server represents an alternate transport address
        identifying a different STUN server which the STUN client should
        try.
</p>
<p>It is encoded in the same way as MAPPED-ADDRESS, and thus
        refers to a single server by IP address. The IP address
        family MUST be identical to that of the source IP address of
        the request. 
</p>
<p>This attribute MUST only appear in an error response that
        contains a MESSAGE-INTEGRITY attribute. This prevents it from
        being used in denial-of-service attacks.
</p>
<a name="security_considerations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15"></a><h3>15.&nbsp;
Security
        Considerations</h3>

<a name="anchor31"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.1"></a><h3>15.1.&nbsp;
Attacks against the Protocol</h3>

<a name="anchor32"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.1.1"></a><h3>15.1.1.&nbsp;
Outside Attacks</h3>

<p>
	  An attacker can try to modify STUN messages in transit, in
	  order to cause a failure in STUN operation. These attacks
	  are detected for both requests and responses through the
	  message integrity mechanism, using either a short term or
	  long term credential. Of course, once detected, the
	  manipulated packets will be dropped, causing the STUN
	  transaction to effectively fail. This attack is possible
	  only by an on-path attacker.
	
</p>
<p>
	  An attacker that can observe, but not modify STUN messages
	  in-transit (for example, an attacker present on a shared
	  access medium, such as Wi-Fi), can see a STUN request, and
	  then immediately send a STUN response, typically an error
	  response, in order to disrupt STUN processing. This attack
	  is also prevented for messages that utilize
	  MESSAGE-INTEGRITY. However, some error responses, those
	  related to authentication in particular, cannot be protected
	  by MESSAGE-INTEGRITY. When STUN itself is run over a secure
	  transport protocol (e.g., TLS), these attacks are
	  completely mitigated.
	
</p>
<a name="anchor33"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.1.2"></a><h3>15.1.2.&nbsp;
Inside Attacks</h3>

<p>
	    A rogue client may try to launch a DoS attack against a
	    server by sending it a large number of STUN
	    requests. Fortunately, STUN requests can be processed
	    statelessly by a server, making such attacks hard to
	    launch. 
	    
</p>
<p>
	    A rogue client may use a STUN server as a reflector,
	    sending it requests with a falsified source IP address and
	    port. In such a case, the response would be delivered to
	    that source IP and port. There is no amplification with
	    this attack, and it is mitigated by ingress source address
	    filtering. 
	  
</p>
<a name="anchor34"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.2"></a><h3>15.2.&nbsp;
Attacks Affecting the Usage</h3>

<p>This section lists attacks that might be launched against a
      usage of STUN.  Each STUN usage must consider whether these
      attacks are applicable to it, and if so, discuss
      counter-measures.
</p>
<p>Most of the attacks in this section revolve around an
      attacker modifying the reflexive address learned by a STUN
      client through a Binding Request/Binding Response
      transaction. Since the usage of the reflexive address is a
      function of the usage, the applicability and remediation of
      these attacks is usage-specific. 
In common situations, modification of the reflexive address by an
      on-path attacker is easy to do. Consider, for example, the common
      situation where STUN is run directly over UDP. In this case, an
      on-path attacker can modify the source IP address of the Binding
      Request before it arrives at the STUN server. The STUN server
      will then return this IP address in the XOR-MAPPED-ADDRESS
      attribute to the client. Protecting against this attack by using
      a message-integrity check is impossible, since a
      message-integrity value cannot cover the source IP address,
      since the intervening NAT must be able to modify this
      value. Instead, one solution to preventing the attacks listed
      below is for the client to verify the reflexive address learned,
      as is done in ICE <a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a>. Other
      usages may use other means to prevent these attacks.
</p>
<a name="ddos"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.2.1"></a><h3>15.2.1.&nbsp;
Attack I: DDoS Against a Target</h3>

<p>In this attack, the attacker provides one or more clients
          with the same faked reflexive address that points to the intended
          target. This will trick the STUN clients into thinking that
          their reflexive addresses are equal to that of the target.
          If the clients hand out that reflexive address in order to receive
	   traffic on it (for example, in SIP messages), the traffic will
          instead be sent to the target. This attack can provide
          substantial amplification, especially when used with clients that
          are using STUN to enable multimedia applications.
</p>
<a name="anchor35"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.2.2"></a><h3>15.2.2.&nbsp;
Attack II: Silencing a Client</h3>

<p>In this attack, the attacker provides
          a STUN client with a faked reflexive address. The reflexive address it
          provides is a transport address that routes to nowhere. As a result,
          the client won't receive any of the packets it expects to receive
          when it hands out the reflexive address. This exploitation is not
          very interesting for the attacker. It impacts a single client, which
          is frequently not the desired target. Moreover, any attacker that
          can mount the attack could also deny service to the client by other
          means, such as preventing the client from receiving any response
          from the STUN server, or even a DHCP server.
</p>
<a name="anchor36"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.2.3"></a><h3>15.2.3.&nbsp;
Attack III: Assuming the Identity of a Client</h3>

<p>This attack is similar to attack II. However, the faked reflexive
          address points to the attacker itself. This allows the attacker to
          receive traffic which was destined for the client.
</p>
<a name="anchor37"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.2.4"></a><h3>15.2.4.&nbsp;
Attack IV: Eavesdropping</h3>

<p>In this attack, the attacker forces the client to use a reflexive
          address that routes to itself. It then forwards any packets it
          receives to the client. This attack would allow the attacker to
          observe all packets sent to the client. However, in order to launch
          the attack, the attacker must have already been able to observe
          packets from the client to the STUN server. In most cases (such as
          when the attack is launched from an access network), this means that
          the attacker could already observe packets sent to the client. This
          attack is, as a result, only useful for observing traffic by
          attackers on the path from the client to the STUN server, but not
          generally on the path of packets being routed towards the
          client.
</p>
<a name="anchor38"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.15.3"></a><h3>15.3.&nbsp;
Hash Agility Plan</h3>

<p>
	  This specification uses SHA-1 for computation of the message
	  integrity. If, at a later time, SHA-1 is found to be
	  compromised, the following is the remedy that will be
	  applied.
	
</p>
<p>
	  We will define a STUN extension which introduces a new
	  message integrity attribute, computed using a new
	  hash. Clients would be required to include both the new and
	  old message integrity attributes in their requests or
	  indications. A new server will utilize the new message
	  integrity attribute, and an old one, the old. After a
	  transition period where mixed implementations are in
	  deployment, the old message-integrity attribute will be
	  deprecated by another specification, and clients will cease
	  including it in requests. 
	
</p>
<a name="iab_considerations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.16"></a><h3>16.&nbsp;
IAB Considerations</h3>

<p>The IAB has studied the problem of "Unilateral Self Address Fixing"
      (UNSAF), which is the general process by which a client attempts to
      determine its address in another realm on the other side of a NAT
      through a collaborative protocol reflection mechanism (<a class='info' href='#RFC3424'>RFC3424<span> (</span><span class='info'>Daigle, L. and IAB, &ldquo;IAB Considerations for UNilateral Self-Address Fixing (UNSAF) Across Network Address Translation,&rdquo; November&nbsp;2002.</span><span>)</span></a> [RFC3424]). STUN can be used to perform this function
      using a Binding Request/Response transaction if one agent is behind
      a NAT and the other is on the public side of the NAT.
</p>
<p>The IAB has mandated that protocols developed for this
	purpose document a specific set of considerations. Because 
	some STUN usages provide UNSAF functions (such as ICE
	<a class='info' href='#I-D.ietf-mmusic-ice'>[I&#8209;D.ietf&#8209;mmusic&#8209;ice]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols,&rdquo; October&nbsp;2007.</span><span>)</span></a> ), and
	others do not (such as SIP Outbound
	<a class='info' href='#I-D.ietf-sip-outbound'>[I&#8209;D.ietf&#8209;sip&#8209;outbound]<span> (</span><span class='info'>Jennings, C., &ldquo;Managing Client Initiated Connections in the Session Initiation Protocol  (SIP),&rdquo; June&nbsp;2009.</span><span>)</span></a>), answers to these
	considerations need to be addressed by the usages themselves.  
	
</p>
<a name="iana_considerations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.17"></a><h3>17.&nbsp;
IANA Considerations</h3>

<p>IANA is hereby requested to create three new registries: a
      STUN methods registry, a STUN Attributes registry, and a STUN
      Error Codes registry.
</p>
<a name="anchor39"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.17.1"></a><h3>17.1.&nbsp;
STUN Methods Registry</h3>

<p>A STUN method is a hex number in the range 0x000 - 0x3FF.
	    The encoding of STUN method into a STUN message is described in
           <a class='info' href='#message_structure'>Section&nbsp;6<span> (</span><span class='info'>STUN Message Structure</span><span>)</span></a>.
</p>
<p>The initial STUN methods are:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  0x000: (Reserved)
  0x001: Binding
  0x002: (Reserved; was SharedSecret)
</pre></div>
<p>STUN methods in the range 0x000 - 0x1FF
          are assigned by IETF Consensus <a class='info' href='#RFC2434'>[RFC2434]<span> (</span><span class='info'>Narten, T. and H. Alvestrand, &ldquo;Guidelines for Writing an IANA Considerations Section in RFCs,&rdquo; October&nbsp;1998.</span><span>)</span></a>.
          STUN methods in the range 0x200 - 0x3FF are assigned on a
          First Come First Served basis <a class='info' href='#RFC2434'>[RFC2434]<span> (</span><span class='info'>Narten, T. and H. Alvestrand, &ldquo;Guidelines for Writing an IANA Considerations Section in RFCs,&rdquo; October&nbsp;1998.</span><span>)</span></a>
</p>
<a name="anchor40"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.17.2"></a><h3>17.2.&nbsp;
STUN Attribute Registry</h3>

<p>A STUN Attribute type is a hex number in the range 0x0000 - 0xFFFF.
	 STUN attribute types in the range 0x0000 - 0x7FFF
        are considered comprehension-required;
        STUN attribute types in the range 0x8000 - 0xFFFF
        are considered comprehension-optional.
        A STUN agent handles unknown comprehension-required and comprehension-optional attributes differently.
</p>
<p>The initial STUN Attributes types are:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Comprehension-required range (0x0000-0x7FFF):
    0x0000: (Reserved)
    0x0001: MAPPED-ADDRESS
    0x0006: USERNAME
    0x0007: (Reserved; was PASSWORD)
    0x0008: MESSAGE-INTEGRITY
    0x0009: ERROR-CODE
    0x000A: UNKNOWN-ATTRIBUTES
    0x0014: REALM
    0x0015: NONCE
    0x0020: XOR-MAPPED-ADDRESS

  Comprehension-optional range (0x8000-0xFFFF)
    0x8022: SERVER
    0x8023: ALTERNATE-SERVER
    0x8028: FINGERPRINT
</pre></div>
<p>STUN Attribute types in the first half of the comprehension-required range 
           (0x0000 - 0x3FFF) and in the first half of the comprehension-optional range
           (0x8000 - 0xBFFF) are assigned
	    by IETF Consensus <a class='info' href='#RFC2434'>[RFC2434]<span> (</span><span class='info'>Narten, T. and H. Alvestrand, &ldquo;Guidelines for Writing an IANA Considerations Section in RFCs,&rdquo; October&nbsp;1998.</span><span>)</span></a>.
           STUN Attribute types in the second half of the comprehension-required range
           (0x4000 - 0x7FFF)
           and in the second half of the comprehension-optional range
           (0xC000 - 0xFFFF) are assigned on a
           First Come First Served basis <a class='info' href='#RFC2434'>[RFC2434]<span> (</span><span class='info'>Narten, T. and H. Alvestrand, &ldquo;Guidelines for Writing an IANA Considerations Section in RFCs,&rdquo; October&nbsp;1998.</span><span>)</span></a>.
</p>
<a name="anchor41"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.17.3"></a><h3>17.3.&nbsp;
STUN Error Code Registry</h3>

<p>A STUN Error code is a number in the range 0 - 699. 
           STUN error codes are accompanied by a textual reason phrase in UTF-8
           which is intended only for human consumption and can be anything
           appropriate; this document proposes only suggested values.
</p>
<p>STUN error codes are consistent in codepoint assignments and semantics with <a class='info' href='#RFC3261'>SIP<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [RFC3261] and <a class='info' href='#RFC2616'>HTTP<span> (</span><span class='info'>Fielding, R., Gettys, J., Mogul, J., Frystyk, H., Masinter, L., Leach, P., and T. Berners-Lee, &ldquo;Hypertext Transfer Protocol -- HTTP/1.1,&rdquo; June&nbsp;1999.</span><span>)</span></a> [RFC2616].
</p>
<p>The initial values in this registry are given in <a class='info' href='#sec:error-code'>Section&nbsp;14.6<span> (</span><span class='info'>ERROR-CODE</span><span>)</span></a>.
</p>
<p>New STUN error codes are assigned on a Specification-Required basis <a class='info' href='#RFC2434'>[RFC2434]<span> (</span><span class='info'>Narten, T. and H. Alvestrand, &ldquo;Guidelines for Writing an IANA Considerations Section in RFCs,&rdquo; October&nbsp;1998.</span><span>)</span></a>. The specification must carefully consider how clients that do not understand this error code will process it before granting the request. See the rules in <a class='info' href='#sec:processing-an-error-response'>Section&nbsp;7.3.4<span> (</span><span class='info'>Processing an Error Response</span><span>)</span></a>.
</p>
<a name="sec-changes"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.18"></a><h3>18.&nbsp;
Changes Since RFC 3489</h3>

<p>This specification obsoletes <a class='info' href='#RFC3489'>RFC3489<span> (</span><span class='info'>Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs),&rdquo; March&nbsp;2003.</span><span>)</span></a> [RFC3489].
      This specification differs from RFC3489 in the following ways:
</p>
<ul class="text">
<li>Removed the notion that STUN is a complete NAT traversal solution.
        STUN is now a tool that can be used to produce a NAT traversal solution. As a consequence, changed the name of the protocol to Session Traversal Utilities for NAT.
</li>
<li>Introduced the concept of STUN usages, and described what a usage
        of STUN must document.
</li>
<li>Removed the usage of STUN for NAT type detection and binding
        lifetime discovery. These techniques have proven overly brittle due to
        wider variations in the types of NAT devices than described in this
        document. Removed the RESPONSE-ADDRESS, CHANGED-ADDRESS,
        CHANGE-REQUEST, SOURCE-ADDRESS, and REFLECTED-FROM attributes.
</li>
<li>Added a fixed 32-bit magic cookie and reduced length of transaction
        ID by 32 bits. The magic cookie begins at the same offset as the
        original transaction ID.
</li>
<li>Added the XOR-MAPPED-ADDRESS attribute, which is included in
        Binding Responses if the magic cookie is present in the request.
        Otherwise the RFC3489 behavior is retained (that is, Binding Response
        includes MAPPED-ADDRESS). See discussion in XOR-MAPPED-ADDRESS
        regarding this change.
</li>
<li>Introduced formal structure into the Message Type header field,
        with an explicit pair of bits for indication of request, response,
        error response or indication. Consequently, the message type field is
        split into the class (one of the previous four) and method.
</li>
<li>Explicitly point out that the most significant two bits of STUN are
        0b00, allowing easy differentiation with RTP packets when used with
        ICE.
</li>
<li>Added the FINGERPRINT attribute to provide a method of definitely
        detecting the difference between STUN and another protocol when the
        two protocols are multiplexed together.
</li>
<li>Added support for IPv6. Made it clear that an IPv4 client could get
        a v6 mapped address, and vice-a-versa.
</li>
<li>Added long-term credential-based authentication.
</li>
<li>Added the SERVER, REALM, NONCE, and ALTERNATE-SERVER
        attributes.
</li>
<li>Removed the SharedSecret method, and thus the PASSWORD attribute.
        This method was almost never implemented and is not needed with current
        usages.
</li>
<li>Removed recommendation to continue listening for STUN Responses for
        10 seconds in an attempt to recognize an attack.
</li>
<li>Changed transaction timers to be more TCP friendly.
</li>
<li>Removed the STUN example that centered around the separation of the
        control and media planes. Instead, provided more information on using
        STUN with protocols.
</li>
<li>
	  Defined a generic padding mechanism that changes the
	  interpretation of the length attribute. This would, in
	  theory, break backwards compatibility. However, the
	  mechanism in RFC 3489 never worked for the few attributes
	  that weren't aligned naturally on 32 bit boundaries. 
	
</li>
<li>
	  REALM, USERNAME, SERVER, reason phrases and NONCE limited to
	  127 characters. 
	
</li>
</ul>
<a name="anchor42"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.19"></a><h3>19.&nbsp;
Acknowledgements</h3>

<p>The authors would like to thank Cedric Aoun, Pete Cordell, Cullen
      Jennings, Bob Penfield, Xavier Marjou, Bruce Lowekamp and Chris Sullivan
      for their comments, and Baruch Sterman and Alan Hawrylyshen for initial
      implementations. Thanks for Leslie Daigle, Allison Mankin, Eric
      Rescorla, and Henning Schulzrinne for IESG and IAB input on this
      work.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.20"></a><h3>20.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>20.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC0791">[RFC0791]</a></td>
<td class="author-text">Postel, J., &ldquo;<a href="http://tools.ietf.org/html/rfc791">Internet Protocol</a>,&rdquo; STD&nbsp;5, RFC&nbsp;791, September&nbsp;1981 (<a href="http://www.rfc-editor.org/rfc/rfc791.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2782">[RFC2782]</a></td>
<td class="author-text"><a href="mailto:arnt@troll.no">Gulbrandsen, A.</a>, Vixie, P., and <a href="mailto:levone@microsoft.com">L. Esibov</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2782">A DNS RR for specifying the location of services (DNS SRV)</a>,&rdquo; RFC&nbsp;2782, February&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2782.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2818">[RFC2818]</a></td>
<td class="author-text">Rescorla, E., &ldquo;<a href="http://tools.ietf.org/html/rfc2818">HTTP Over TLS</a>,&rdquo; RFC&nbsp;2818, May&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2818.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2617">[RFC2617]</a></td>
<td class="author-text"><a href="mailto:john@math.nwu.edu">Franks, J.</a>, <a href="mailto:pbaker@verisign.com">Hallam-Baker, P.</a>, <a href="mailto:jeff@AbiSource.com">Hostetler, J.</a>, <a href="mailto:lawrence@agranat.com">Lawrence, S.</a>, <a href="mailto:paulle@microsoft.com">Leach, P.</a>, Luotonen, A., and <a href="mailto:stewart@OpenMarket.com">L. Stewart</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2617">HTTP Authentication: Basic and Digest Access Authentication</a>,&rdquo; RFC&nbsp;2617, June&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2617.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2617.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2617.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2988">[RFC2988]</a></td>
<td class="author-text">Paxson, V. and M. Allman, &ldquo;<a href="http://tools.ietf.org/html/rfc2988">Computing TCP's Retransmission Timer</a>,&rdquo; RFC&nbsp;2988, November&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2988.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="ITU.V42.1994">[ITU.V42.1994]</a></td>
<td class="author-text">International Telecommunications Union, &ldquo;Error-correcting Procedures for DCEs Using Asynchronous-to-Synchronous Conversion,&rdquo; ITU-T&nbsp;Recommendation V.42, 1994.</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>20.2.&nbsp;Informational References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2104">[RFC2104]</a></td>
<td class="author-text"><a href="mailto:hugo@watson.ibm.com">Krawczyk, H.</a>, <a href="mailto:mihir@cs.ucsd.edu">Bellare, M.</a>, and <a href="mailto:canetti@watson.ibm.com">R. Canetti</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2104">HMAC: Keyed-Hashing for Message Authentication</a>,&rdquo; RFC&nbsp;2104, February&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2104.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2616">[RFC2616]</a></td>
<td class="author-text"><a href="mailto:fielding@ics.uci.edu">Fielding, R.</a>, <a href="mailto:jg@w3.org">Gettys, J.</a>, <a href="mailto:mogul@wrl.dec.com">Mogul, J.</a>, <a href="mailto:frystyk@w3.org">Frystyk, H.</a>, <a href="mailto:masinter@parc.xerox.com">Masinter, L.</a>, <a href="mailto:paulle@microsoft.com">Leach, P.</a>, and <a href="mailto:timbl@w3.org">T. Berners-Lee</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a>,&rdquo; RFC&nbsp;2616, June&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2616.txt">TXT</a>, <a href="http://www.rfc-editor.org/rfc/rfc2616.ps">PS</a>, <a href="http://www.rfc-editor.org/rfc/rfc2616.pdf">PDF</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2616.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2616.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-mmusic-ice">[I-D.ietf-mmusic-ice]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>,&rdquo; draft-ietf-mmusic-ice-19 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3489">[RFC3489]</a></td>
<td class="author-text">Rosenberg, J., Weinberger, J., Huitema, C., and R. Mahy, &ldquo;<a href="http://tools.ietf.org/html/rfc3489">STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs)</a>,&rdquo; RFC&nbsp;3489, March&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3489.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-behave-turn">[I-D.ietf-behave-turn]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., and P. Matthews, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-turn-16.txt">Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)</a>,&rdquo; draft-ietf-behave-turn-16 (work in progress), July&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-turn-16.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sip-outbound">[I-D.ietf-sip-outbound]</a></td>
<td class="author-text">Jennings, C., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-20.txt">Managing Client Initiated Connections in the Session Initiation Protocol  (SIP)</a>,&rdquo; draft-ietf-sip-outbound-20 (work in progress), June&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sip-outbound-20.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-behave-nat-behavior-discovery">[I-D.ietf-behave-nat-behavior-discovery]</a></td>
<td class="author-text">MacDonald, D. and B. Lowekamp, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-nat-behavior-discovery-08.txt">NAT Behavior Discovery Using STUN</a>,&rdquo; draft-ietf-behave-nat-behavior-discovery-08 (work in progress), September&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-behave-nat-behavior-discovery-08.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-mmusic-ice-tcp">[I-D.ietf-mmusic-ice-tcp]</a></td>
<td class="author-text">Perreault, S. and J. Rosenberg, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-tcp-08.txt">TCP Candidates with Interactive Connectivity Establishment (ICE)</a>,&rdquo; draft-ietf-mmusic-ice-tcp-08 (work in progress), October&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-tcp-08.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3264">[RFC3264]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3264">An Offer/Answer Model with Session Description Protocol (SDP)</a>,&rdquo; RFC&nbsp;3264, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3264.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3424">[RFC3424]</a></td>
<td class="author-text">Daigle, L. and IAB, &ldquo;<a href="http://tools.ietf.org/html/rfc3424">IAB Considerations for UNilateral Self-Address Fixing (UNSAF) Across Network Address Translation</a>,&rdquo; RFC&nbsp;3424, November&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3424.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2434">[RFC2434]</a></td>
<td class="author-text"><a href="mailto:narten@raleigh.ibm.com">Narten, T.</a> and <a href="mailto:Harald@Alvestrand.no">H. Alvestrand</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2434">Guidelines for Writing an IANA Considerations Section in RFCs</a>,&rdquo; BCP&nbsp;26, RFC&nbsp;2434, October&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2434.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2434.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2434.xml">XML</a>).</td></tr>
</table>

<a name="anchor45"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
C Snippet to Determine STUN Message Types </h3>

<p>Given an 16-bit STUN message type value in host byte order
        in msg_type parameter, below are C macros to determine the STUN
        message types:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
#define IS_REQUEST(msg_type)       (((msg_type) &amp; 0x0110) == 0x0000)
#define IS_INDICATION(msg_type)    (((msg_type) &amp; 0x0110) == 0x0010)
#define IS_SUCCESS_RESP(msg_type)  (((msg_type) &amp; 0x0110) == 0x0100)
#define IS_ERR_RESP(msg_type)      (((msg_type) &amp; 0x0110) == 0x0110)

</pre></div>
<p>
</p>
<p>
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jonathan Rosenberg</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Edison, NJ</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jdrosen@cisco.com">jdrosen@cisco.com</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.jdrosen.net">http://www.jdrosen.net</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Christian Huitema</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Microsoft</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">One Microsoft Way</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Redmond, WA  98052</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:huitema@microsoft.com">huitema@microsoft.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Rohan Mahy</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Plantronics</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">345 Encinal Street</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Santa Cruz, CA  95060</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:rohan@ekabal.com">rohan@ekabal.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Philip Matthews</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Avaya</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1135 Innovation Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ottawa, Ontario  K2K 3G7</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 613 592 4343 x224</td></tr>
<tr><td class="author" align="right">Fax:&nbsp;</td>
<td class="author-text"></td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:philip_matthews@magma.ca">philip_matthews@magma.ca</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href=""></a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dan Wing</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">771 Alder Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Jose, CA  95035</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:dwing@cisco.com">dwing@cisco.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2007).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
