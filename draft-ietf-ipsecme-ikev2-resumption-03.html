<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>IKEv2 Session
    Resumption</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="IKEv2 Session
    Resumption">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">Y. Sheffer</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Check Point</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">H. Tschofenig</td></tr>
<tr><td class="header">Expires: November 2, 2009</td><td class="header">Nokia Siemens Networks</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">L. Dondeti</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">V. Narayanan</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">QUALCOMM, Inc.</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">May 01, 2009</td></tr>
</table></td></tr></table>
<h1><br />IKEv2 Session
    Resumption<br />draft-ietf-ipsecme-ikev2-resumption-03.txt</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on November 2, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>The Internet Key Exchange version 2 (IKEv2) protocol has a
      certain computational and communication overhead with respect
      to the number of round-trips required and the cryptographic
      operations involved. In remote access situations, the
      Extensible Authentication Protocol (EAP) is used for
      authentication, which adds several more round trips and
      consequently latency.
</p>
<p>To re-establish security associations (SAs) upon a failure
      recovery condition is time consuming especially when an IPsec
      peer (such as a VPN gateway) needs to re-establish a large
      number of SAs with various end points. A high number of
      concurrent sessions might cause additional problems for an
      IPsec peer during SA re-establishment.
</p>
<p>In order to avoid the need to re-run the key exchange
      protocol from scratch it would be useful to provide an
      efficient way to resume an IKE/IPsec session. This document
      proposes an extension to IKEv2 that allows a client to
      re-establish an IKE SA with a gateway in a highly efficient
      manner, utilizing a previously established IKE SA.
</p>
<p>A client can reconnect to a gateway from which it was
      disconnected. The proposed approach requires passing opaque
      data from the IKEv2 responder to the IKEv2 initiator, which
      is later made available to the IKEv2 responder for
      re-authentication. We use the term ticket to refer to the
      opaque data that is created by the IKEv2 responder. This
      document does not specify the format of the ticket but
      recommendations are provided.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Terminology<br />
<a href="#usage">3.</a>&nbsp;
Usage Scenario<br />
<a href="#anchor3">4.</a>&nbsp;
Protocol Details<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#request-ticket">4.1.</a>&nbsp;
Requesting a Ticket<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#receive-ticket">4.2.</a>&nbsp;
Receiving a Ticket<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#present-ticket">4.3.</a>&nbsp;
Presenting a Ticket<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#resume-details">4.4.</a>&nbsp;
IKE_SESSION_RESUME Details<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#request-resume">4.5.</a>&nbsp;
Requesting a Ticket During Resumption<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">4.6.</a>&nbsp;
IP Address Change and NAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#notifications">4.7.</a>&nbsp;
IKE Notifications<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ticket-encoding">4.7.1.</a>&nbsp;
TICKET_LT_OPAQUE Notify Payload<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ticket-encoding2">4.7.2.</a>&nbsp;
TICKET_OPAQUE Notify Payload<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#auth-values">4.8.</a>&nbsp;
Computing the AUTH Payload<br />
<a href="#ike-sa">5.</a>&nbsp;
Processing Guidelines for IKE SA Establishment<br />
<a href="#anchor5">6.</a>&nbsp;
The State After Resumption<br />
<a href="#anchor6">7.</a>&nbsp;
Ticket Handling<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#content">7.1.</a>&nbsp;
Ticket Content<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#lifecycle">7.2.</a>&nbsp;
Ticket Identity and Lifecycle<br />
<a href="#anchor7">8.</a>&nbsp;
IANA Considerations<br />
<a href="#security">9.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">9.1.</a>&nbsp;
Stolen Tickets<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">9.2.</a>&nbsp;
Forged Tickets<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">9.3.</a>&nbsp;
Denial of Service Attacks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">9.4.</a>&nbsp;
Key Management for Tickets By Value <br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">9.5.</a>&nbsp;
Ticket Lifetime<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">9.6.</a>&nbsp;
Ticket by Value Format<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">9.7.</a>&nbsp;
Identity Privacy, Anonymity, and Unlinkability<br />
<a href="#anchor15">10.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">11.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">11.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">11.2.</a>&nbsp;
Informative References<br />
<a href="#format">Appendix&nbsp;A.</a>&nbsp;
Ticket Format<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">A.1.</a>&nbsp;
Example Ticket by Value Format<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">A.2.</a>&nbsp;
Example Ticket by Reference Format<br />
<a href="#anchor20">Appendix&nbsp;B.</a>&nbsp;
Change Log<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">B.1.</a>&nbsp;
-03<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor22">B.2.</a>&nbsp;
-02<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor23">B.3.</a>&nbsp;
-01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">B.4.</a>&nbsp;
-00<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">B.5.</a>&nbsp;
-01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor26">B.6.</a>&nbsp;
-00<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor27">B.7.</a>&nbsp;
-04<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor28">B.8.</a>&nbsp;
-03<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor29">B.9.</a>&nbsp;
-02<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor30">B.10.</a>&nbsp;
-01<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor31">B.11.</a>&nbsp;
-00<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>The Internet Key Exchange version 2 (IKEv2) protocol has a
      certain computational and communication overhead with respect
      to the number of round-trips required and the cryptographic
      operations involved. In particular the Extensible
      Authentication Protocol (EAP) is used for authentication in
      remote access cases, which increases latency.
</p>
<p>To re-establish security associations (SA) upon a failure
      recovery condition is time-consuming, especially when an
      IPsec peer, such as a VPN gateway, needs to re-establish a
      large number of SAs with various end points. A high number of
      concurrent sessions might cause additional problems for an
      IPsec responder.
</p>
<p>In many failure cases it would be useful to provide an
      efficient way to resume an interrupted IKE/IPsec session.
      This document proposes an extension to IKEv2 that allows a
      client to re-establish an IKE SA with a gateway in a highly
      efficient manner, utilizing a previously established IKE
      SA.
</p>
<p>A client can reconnect to a gateway from which it was
      disconnected. One way to ensure that the IKEv2 responder is
      able to recreate the state information is by maintaining
      IKEv2 state (or a reference into a state store) in a
      "ticket", an opaque data structure. This ticket is created by
      the server and forwarded to the client. The IKEv2 protocol is
      extended to allow a client to request and present a ticket.
      This document does not mandate the format of the ticket
      structure but a recommendation is provided. In
      <a class='info' href='#format'>Appendix&nbsp;A<span> (</span><span class='info'>Ticket Format</span><span>)</span></a> a ticket by value and a ticket by
      reference format is proposed.
</p>
<p>This approach is similar to the one taken by TLS session
      resumption
      <a class='info' href='#RFC5077'>[RFC5077]<span> (</span><span class='info'>Salowey, J., Zhou, H., Eronen, P., and H. Tschofenig, &ldquo;Transport Layer Security (TLS) Session Resumption without Server-Side State,&rdquo; January&nbsp;2008.</span><span>)</span></a> with the required adaptations for
      IKEv2, e.g., to accommodate the two-phase protocol structure.
      We have borrowed heavily from that specification.
</p>
<p>The proposed solution should additionally meet the
      following goals:
</p>
<p>
        </p>
<ul class="text">
<li>Using only symmetric cryptography to minimize CPU
          consumption.
</li>
<li>Providing cryptographic agility.
</li>
<li>Having no negative impact on IKEv2 security
          features.
</li>
</ul><p>
      
</p>
<p>The following are non-goals of this solution:
      </p>
<ul class="text">
<li>Failover from one gateway to another. This use case may
        be added in a future specification.
</li>
<li>Providing load balancing among gateways.
</li>
<li>Specifying how a client detects the need for
        resumption.
</li>
</ul>

<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL",
      "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY",
      and "OPTIONAL" in this document are to be interpreted as
      described in
      <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<p>This document uses terminology defined in
      <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> and
      <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
      In addition, this document uses the following terms:
</p>
<p>
        </p>
<blockquote class="text"><dl>
<dt>Ticket:</dt>
<dd>An IKEv2 ticket is a data structure
          that contains all the necessary information that allows
          an IKEv2 responder to re-establish an IKEv2 security
          association.
          <br />

</dd>
</dl></blockquote><p>
      
</p>
<p>In this document we use the term "ticket" and thereby refer
      to an opaque data structure that may either contain IKEv2
      state as described above or a reference pointing to such
      state.
</p>
<a name="usage"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Usage Scenario</h3>

<p>This specification envisions two usage scenarios for
      efficient IKEv2 and IPsec SA session re-establishment.
</p>
<p>The first is similar to the use case specified in Section
      1.1.3 of the IKEv2 specification
      <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>, where the IPsec tunnel mode is
      used to establish a secure channel between a remote access
      client and a gateway; the traffic flow may be between the
      client and entities beyond the gateway. This scenario is
      further discussed below.
</p>
<p>The second use case focuses on the usage of transport (or
      tunnel) mode to secure the communicate between two end points
      (e.g., two servers). The two endpoints have a client-server
      relationship with respect to a protocol that runs using the
      protections afforded by the IPsec SA.
</p>
<p>
        <br /><hr class="insert" />
<a name="Case1GWfig"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

 (a)

 +-+-+-+-+-+                          +-+-+-+-+-+
 !         !      IKEv2/IKEv2-EAP     !         !     Protected
 ! Remote  !&lt;------------------------&gt;!         !     Subnet
 ! Access  !                          ! Access  !&lt;--- and/or
 ! Client  !&lt;------------------------&gt;! Gateway !     Internet
 !         !      IPsec tunnel        !         !
 +-+-+-+-+-+                          +-+-+-+-+-+


 (b)

 +-+-+-+-+-+                          +-+-+-+-+-+
 !         !    IKE_SESSION_RESUME    !         !
 ! Remote  !&lt;------------------------&gt;!         !
 ! Access  !                          ! Access  !
 ! Client  !&lt;------------------------&gt;! Gateway !
 !         !      IPsec tunnel        !         !
 +-+-+-+-+-+                          +-+-+-+-+-+


</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Resuming a Session with a Remote Access Gateway&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

      
</p>
<p>In the first use case above,
      an end host (an entity with a host
      implementation of IPsec
      <a class='info' href='#RFC4301'>[RFC4301]<span> (</span><span class='info'>Kent, S. and K. Seo, &ldquo;Security Architecture for the Internet Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>) establishes a tunnel mode IPsec SA
      with a gateway in a remote network using IKEv2. The end host
      in this scenario is sometimes referred to as a remote access
      client. At a later stage when a client needs to re-establish
      the IKEv2 session it may choose to establish IPsec SAs using
      a full IKEv2 exchange or the IKE_SESSION_RESUME exchange
      (shown in
      <a class='info' href='#Case1GWfig'>Figure&nbsp;1<span> (</span><span class='info'>Resuming a Session with a Remote Access Gateway</span><span>)</span></a>).
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Protocol Details</h3>

<p>This section provides protocol details and contains the
      normative parts. This document defines two protocol
      exchanges, namely requesting a ticket, see
      <a class='info' href='#request-ticket'>Section&nbsp;4.1<span> (</span><span class='info'>Requesting a Ticket</span><span>)</span></a>, and presenting a ticket,
      see
      <a class='info' href='#present-ticket'>Section&nbsp;4.3<span> (</span><span class='info'>Presenting a Ticket</span><span>)</span></a>.
</p>
<a name="request-ticket"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Requesting a Ticket</h3>

<p>A client MAY request a ticket in the following
        exchanges:
</p>
<p>
          </p>
<ul class="text">
<li>In an IKE_AUTH exchange, as shown in the example
            message exchange in
            <a class='info' href='#request-ticket-example'>Figure&nbsp;2<span> (</span><span class='info'>Example Message Exchange for Requesting a Ticket</span><span>)</span></a> below.
</li>
<li>In a CREATE_CHILD_SA exchange, when an IKE SA is
            rekeyed (and only when this exchange is initiated
            by the client).
</li>
<li>In an Informational exchange at any time, e.g. if
            the gateway previously replied with an N(TICKET_ACK)
            instead of providing a ticket, or when the ticket
            lifetime is about to expire. All such
            Informational exchanges MUST be initiated by the client.
</li>
<li>While resuming an IKE session, i.e. in the IKE_AUTH exchange that follows
            an IKE_SESSION_RESUME exchange, see
            <a class='info' href='#request-resume'>Section&nbsp;4.5<span> (</span><span class='info'>Requesting a Ticket During Resumption</span><span>)</span></a>.
</li>
</ul><p>
        
</p>
<p>Normally, a client requests a ticket in the third
        message of an IKEv2 exchange (the first of IKE_AUTH).
        <a class='info' href='#request-ticket-example'>Figure&nbsp;2<span> (</span><span class='info'>Example Message Exchange for Requesting a Ticket</span><span>)</span></a> shows the message
        exchange for this typical case.
</p>
<p>
          <br /><hr class="insert" />
<a name="request-ticket-example"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  Initiator                Responder
  -----------              -----------
 HDR, SAi1, KEi, Ni  --&gt;

                     &lt;--    HDR, SAr1, KEr, Nr, [CERTREQ]

 HDR, SK {IDi, [CERT,] [CERTREQ,] [IDr,]
 AUTH, SAi2, TSi, TSr, N(TICKET_REQUEST)}     --&gt;

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Example Message Exchange for Requesting a Ticket&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

        
</p>
<p>The notification payloads are described in
        <a class='info' href='#notifications'>Section&nbsp;4.7<span> (</span><span class='info'>IKE Notifications</span><span>)</span></a>. The above is an example,
        and IKEv2 allows a number of variants on these messages.
        Refer to <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> and <a class='info' href='#I-D.ietf-ipsecme-ikev2bis'>[I&#8209;D.ietf&#8209;ipsecme&#8209;ikev2bis]<span> (</span><span class='info'>Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;Internet Key Exchange Protocol: IKEv2,&rdquo; April&nbsp;2010.</span><span>)</span></a>
        for more details on IKEv2.
</p>
<p>When an IKEv2 responder receives a request for a ticket
        using the N(TICKET_REQUEST) payload it MUST perform one of
        the following operations if it supports the extension
        defined in this document:
        </p>
<ul class="text">
<li>it creates a ticket and returns it with the
          N(TICKET_LT_OPAQUE) payload in a subsequent message
          towards the IKEv2 initiator. This is shown in
          <a class='info' href='#request-ticket-example2'>Figure&nbsp;3<span> (</span><span class='info'>Receiving a Ticket</span><span>)</span></a>.
</li>
<li>it returns an N(TICKET_NACK) payload, if it refuses to
          grant a ticket for some reason.
</li>
<li>it returns an N(TICKET_ACK), if it cannot grant a
          ticket immediately, e.g., due to packet size limitations.
          In this case the client MAY request a ticket later using
          an Informational exchange, at any time during the
          lifetime of the IKE SA.
</li>
</ul><p>
        Regardless of this choice, there is no change to the behavior of the responder with respect
        to the IKE exchange, and the proper IKE response (e.g. an IKE_AUTH response or an error
        notification) MUST be sent.
        
</p>
<a name="receive-ticket"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Receiving a Ticket</h3>

<p>The IKEv2 initiator receives the ticket and may accept
        it, provided the IKEv2 exchange was successful.
        The ticket may be used
        later with an IKEv2 responder that supports this extension.

        <a class='info' href='#request-ticket-example2'>Figure&nbsp;3<span> (</span><span class='info'>Receiving a Ticket</span><span>)</span></a> shows how the
        initiator receives the ticket.
</p>
<p>
          <br /><hr class="insert" />
<a name="request-ticket-example2"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  Initiator                Responder
  -----------              -----------
         &lt;--    HDR, SK {IDr, [CERT,] AUTH, SAr2, TSi,
                     TSr, N(TICKET_LT_OPAQUE) }

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Receiving a Ticket&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

        
</p>
<p>When a multi-round-trip IKE_AUTH exchange is used, the
        N(TICKET_REQUEST) payload MUST be included in the first
        IKE_AUTH request, and N(TICKET_LT_OPAQUE) (or
        TICKET_NACK/TICKET_ACK) MUST only be returned in the final
        IKE_AUTH response.
</p>
<a name="present-ticket"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Presenting a Ticket</h3>

<p>A client MAY initiate a regular (non-ticket-based) IKEv2
        exchange even if it is in possession of a valid ticket.
        Note that the client can only judge validity in the sense
        of the ticket lifetime. A client MUST NOT present a ticket
        when it knows that the ticket's lifetime has expired.
</p>
<p>It is up to the client's local policy to decide when the
        communication with the IKEv2 responder is seen as
        interrupted and the session resumption procedure is to be
        initiated.
</p>
<p>Tickets are intended for one-time use, i.e. a client
        MUST NOT reuse a ticket. A reused ticket SHOULD be rejected
        by a gateway. Note that a ticket is considered as used only when an IKE
        SA has been established successfully with it.
</p>
<p>This document specifies a new IKEv2 exchange type called
        IKE_SESSION_RESUME whose value is TBA by IANA. This
        exchange is equivalent to the IKE_SA_INIT exchange, and
        MUST be followed by an IKE_AUTH exchange. The client SHOULD
        NOT use this exchange type unless it knows that the gateway
        supports it.
</p>
<p>
          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

 Initiator                Responder
 -----------              -----------
 HDR, Ni, N(TICKET_OPAQUE) [,N+]   --&gt;

</pre></div><p>

        
</p>
<p>The exchange type in HDR is set to 'IKE_SESSION_RESUME'.
        The initiator sets the SPIi value in the HDR to a new
        random value and the SPIr value is set to 0.
</p>
<p>When the IKEv2 responder receives a ticket using the
        N(TICKET_OPAQUE) payload it MUST perform one of the
        following steps if it supports the extension defined in
        this document:
</p>
<p>
          </p>
<ul class="text">
<li>If it is willing to accept the ticket, it responds
            as shown in
            <a class='info' href='#ticket-present-success'>Figure&nbsp;4<span> (</span><span class='info'>IKEv2 Responder accepts the ticket</span><span>)</span></a>.
</li>
<li>It responds with an unprotected N(TICKET_NACK)
            notification, if it rejects the ticket for any reason.
            In that case, the initiator should re-initiate a
            regular IKE exchange. One such case is when the
            responder receives a ticket for an IKE SA that has
            previously been terminated on the responder itself,
            which may indicate inconsistent state between the IKEv2
            initiator and the responder. However, a responder is
            not required to maintain the state for terminated
            sessions.
</li>
</ul><p>
        
</p>
<p>
          <br /><hr class="insert" />
<a name="ticket-present-success"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

 Initiator                Responder
 -----------              -----------
                 &lt;--  HDR, Nr [,N+]

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: IKEv2 Responder accepts the ticket&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

        
</p>
<p>Again, the exchange type in HDR is set to
        'IKE_SESSION_RESUME'. The responder copies the SPIi value
        from the request, and the SPIr value is set to a new random
        value .
</p>
<p>At this point the client MUST initiate an IKE_AUTH
        exchange, as per
        <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>. See
        <a class='info' href='#auth-values'>Section&nbsp;4.8<span> (</span><span class='info'>Computing the AUTH Payload</span><span>)</span></a> for guidelines on computing
        the AUTH payloads.
        The IDi value sent in this exchange MUST
        be identical to the value included in the ticket.
        Following this exchange, a new IKE SA is
        created by both parties, see
        <a class='info' href='#ike-sa'>Section&nbsp;5<span> (</span><span class='info'>Processing Guidelines for IKE SA Establishment</span><span>)</span></a>, and a child SA is derived, per Section 2.17 of
        <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>.
</p>
<p>When the responder receives a ticket for an IKE SA that
        is still active and if the responder accepts it, then the
        old SA SHOULD be silently deleted without sending a DELETE
        informational exchange. Consequently, all the dependent
        IPsec child SAs are also deleted. This happens after both
        peers have been authenticated.
</p>
<a name="resume-details"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
IKE_SESSION_RESUME Details</h3>

<p>The IKE_SESSION_RESUME exchange behaves like the
        IKE_SA_INIT exchange in most respects. Specifically:
</p>
<p>
          </p>
<ul class="text">
<li>The first message may be rejected in denial of
            service situations, with the initiator instructed to send
            a cookie.
</li>
<li>Notifications normally associated with IKE_SA_INIT
            can be sent. In particular, NAT detection payloads.
</li>
<li>The SPI values and Message ID fields behave
            similarly to IKE_SA_INIT.
</li>
</ul><p>
        
</p>
<a name="request-resume"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Requesting a Ticket During Resumption</h3>

<p>When resuming a session, a client will typically request
        a new ticket immediately, so it is able to resume the
        session again in the case of a second failure.
        The N(TICKET_REQUEST) and N(TICKET_LT_OPAQUE) notifications
        will be included in the
        IKE_AUTH exchange that follows the IKE_SESSION_RESUME exchange, with
        similar behavior to a ticket request during a regular IKE exchange,
        <a class='info' href='#request-ticket'>Section&nbsp;4.1<span> (</span><span class='info'>Requesting a Ticket</span><span>)</span></a>.
</p>
<p>The returned ticket (if any) will correspond to the IKE
        SA created per the rules described in
        <a class='info' href='#ike-sa'>Section&nbsp;5<span> (</span><span class='info'>Processing Guidelines for IKE SA Establishment</span><span>)</span></a>.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
IP Address Change and NAT</h3>

<p>
      The client MAY resume the IKE exchange from an IP address different from its original
      address. The gateway MAY reject the resumed exchange if its policy depends on the client's
      address (although this rarely makes sense).
      
</p>
<p>
      The client's NAT traversal status SHOULD be determined anew upon session resumption, by
      using the appropriate notifications. This status is explicitly not part of the session
      resumption state.
      
</p>
<a name="notifications"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7"></a><h3>4.7.&nbsp;
IKE Notifications</h3>

<p>This document defines a number of notifications. The
        notification numbers are TBA by IANA.
</p><table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left"><col align="left">
<tr><th align="left">Notification Name</th><th align="left">Number</th><th align="left">Data</th></tr>
<tr>
<td align="left">TICKET_LT_OPAQUE</td>
<td align="left">TBA1</td>
<td align="left">See
          <a class='info' href='#ticket-encoding'>Section&nbsp;4.7.1<span> (</span><span class='info'>TICKET_LT_OPAQUE Notify Payload</span><span>)</span></a></td>
</tr>
<tr>
<td align="left">TICKET_REQUEST</td>
<td align="left">TBA2</td>
<td align="left">None</td>
</tr>
<tr>
<td align="left">TICKET_ACK</td>
<td align="left">TBA3</td>
<td align="left">None</td>
</tr>
<tr>
<td align="left">TICKET_NACK</td>
<td align="left">TBA4</td>
<td align="left">None</td>
</tr>
<tr>
<td align="left">TICKET_OPAQUE</td>
<td align="left">TBA5</td>
<td align="left">See
          <a class='info' href='#ticket-encoding2'>Section&nbsp;4.7.2<span> (</span><span class='info'>TICKET_OPAQUE Notify Payload</span><span>)</span></a></td>
</tr>
</table>
<br clear="all" />

<p>For all these notifications, the Protocol ID and the SPI
        Size fields MUST both be sent as 0.
</p>
<a name="ticket-encoding"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7.1"></a><h3>4.7.1.&nbsp;
TICKET_LT_OPAQUE Notify Payload</h3>

<p>The data for the TICKET_LT_OPAQUE Notify payload
          consists of the Notify message header, a Lifetime field
          and the ticket itself. The four octet Lifetime field
          contains a relative time value, the number of seconds
          until the ticket expires (encoded as an unsigned
          integer).
</p>
<p>
            <br /><hr class="insert" />
<a name="ticket"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

       0                     1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      ! Next Payload  !C!  Reserved   !      Payload Length           !
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      ! Protocol ID   ! SPI Size = 0  !    Notify Message Type        !
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      !                       Lifetime                                !
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      !                                                               !
      ~                        Ticket                                 ~
      !                                                               !
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: TICKET_LT_OPAQUE Notify Payload&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

          
</p>
<a name="ticket-encoding2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7.2"></a><h3>4.7.2.&nbsp;
TICKET_OPAQUE Notify Payload</h3>

<p>The data for the TICKET_OPAQUE Notify payload consists
          of the Notify message header, and the ticket itself.
          Unlike the TICKET_LT_OPAQUE payload no lifetime value is
          included in the TICKET_OPAQUE Notify payload.
</p>
<p>
            <br /><hr class="insert" />
<a name="ticket2"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

       0                     1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      ! Next Payload  !C!  Reserved   !      Payload Length           !
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      ! Protocol ID   ! SPI Size = 0  !    Notify Message Type        !
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      !                                                               !
      ~                        Ticket                                 ~
      !                                                               !
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: TICKET_OPAQUE Notify Payload&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

          
</p>
<a name="auth-values"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.8"></a><h3>4.8.&nbsp;
Computing the AUTH Payload</h3>

<p>The value of the AUTH payload is derived in a manner
        similar to the usage of IKEv2 pre-shared secret
        authentication, as shown below:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

         AUTH = prf(SK_px, &lt;msg octets&gt;)

</pre></div>
<p>Each of the initiator and responder uses its own SK_p
        value, taken from the newly generated IKE SA, <a class='info' href='#ike-sa'>Section&nbsp;5<span> (</span><span class='info'>Processing Guidelines for IKE SA Establishment</span><span>)</span></a>.
</p>
<p>The exact material to be signed is defined in Section
        2.15 of
        <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a>. The notation "IDr'" in RFC 4306
        should be applied to the new IDr value included in the
        exchange, rather than the value in the ticket.
</p>
<a name="ike-sa"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Processing Guidelines for IKE SA Establishment</h3>

<p>When a ticket is presented, the gateway needs to obtain
        the ticket state. In case a ticket by reference was
        provided by the client, the gateway needs to resolve the
        reference in order to obtain this state. In case
        the client has already provided a ticket per value, the gateway can
        parse the ticket to obtain the state directly. In either case, the gateway needs to
        process the ticket state in order to restore the state
        of the old IKE SA, and the client retrieves the same state from
        its local store. Both peers now create state for the new
        IKE SA as follows:
</p>
<p>
          </p>
<ul class="text">
<li>The SA value (transforms etc.) is taken directly
            from the ticket.
</li>
<li>The Message ID values are reset to 0 in
            IKE_SESSION_RESUME, and subsequently incremented
            normally.
</li>
<li>The IDi value is obtained from the ticket.
</li>
<li>The IDr value is obtained from the new exchange. The
            gateway MAY make policy decisions based on the IDr
            value encoded in the ticket.
</li>
<li>The SPI values are created anew during
            IKE_SESSION_RESUME, similarly to a regular IKE_SA_INIT
            exchange. SPI values from the ticket MUST NOT be
            reused, and they are sent merely to help the gateway to
            locate the old state. The restriction on SPI reuse is
            to avoid problems caused by collisions with other SPI
            values used already by the initiator/responder.
</li>
</ul><p>
        
</p>
<p>The cryptographic material is refreshed based on the
        ticket and the nonce values, Ni, and Nr, from the current
        exchange. A new SKEYSEED value is derived as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

     SKEYSEED = prf(SK_d_old, "Resumption" | Ni | Nr)

</pre></div>
<p>where SK_d_old is taken from the ticket. The literal
        string is encoded as 10 ASCII characters, with no NULL
        terminator.
</p>
<p>The keys are derived as follows, unchanged from
        IKEv2:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

     {SK_d | SK_ai | SK_ar | SK_ei | SK_er | SK_pi | SK_pr} =
                                 prf+(SKEYSEED, Ni | Nr | SPIi | SPIr)

</pre></div>
<p>where SPIi, SPIr are the SPI values created in the new
        IKE exchange.
</p>
<p>See
        <a class='info' href='#RFC4306'>[RFC4306]<span> (</span><span class='info'>Kaufman, C., &ldquo;Internet Key Exchange (IKEv2) Protocol,&rdquo; December&nbsp;2005.</span><span>)</span></a> for the notation. "prf" is
        determined from the SA value in the ticket.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
The State After Resumption</h3>

<p>
    The following table, compiled by Pasi Eronen, describes the IKE and IPsec state of the
    peers after session resumption, and how it is related to their state before the IKE SA was
    interrupted. When the table mentions that a certain state item is taken "from the ticket",
    this should be construed as:
    </p>
<ul class="text">
<li>The client retrieves this item from its local store.
</li>
<li>In the case of ticket by value, the gateway encodes this information in the ticket.
</li>
<li>In the case of ticket by reference, the gateway fetches this information from the
    ticket store.
</li>
</ul><p>
    
</p><table class="full" align="center" border="0" cellpadding="2" cellspacing="2">
<col align="left"><col align="left">
<tr><th align="left">State Item</th><th align="left">After Resumption</th></tr>
<tr>
<td align="left">IDi</td>
<td align="left">From the ticket (but must also be exchanged in IKE_AUTH)</td>
</tr>
<tr>
<td align="left">IDr</td>
<td align="left">From the new exchange (but old value included in the ticket)</td>
</tr>
<tr>
<td align="left">Authentication method</td>
<td align="left">From the ticket</td>
</tr>
<tr>
<td align="left">Certificates (when applicable)</td>
<td align="left">Unspecified, see note 1</td>
</tr>
<tr>
<td align="left">Local IP address/port, peer IP address/port</td>
<td align="left">Selected by the client, see note 2</td>
</tr>
<tr>
<td align="left">NAT detection status</td>
<td align="left">From new exchange</td>
</tr>
<tr>
<td align="left">SPIs</td>
<td align="left">From new exchange</td>
</tr>
<tr>
<td align="left">Which peer is the "original initiator"?</td>
<td align="left">Determined by the initiator of IKE_SESSION_RESUME</td>
</tr>
<tr>
<td align="left">IKE SA sequence numbers (Message ID)</td>
<td align="left">Start from 0</td>
</tr>
<tr>
<td align="left">IKE SA algorithms (SAr)</td>
<td align="left">From the ticket</td>
</tr>
<tr>
<td align="left">IKE SA keys (SK_*)</td>
<td align="left">SK_d from the ticket, others are refreshed</td>
</tr>
<tr>
<td align="left">IKE SA window size</td>
<td align="left">Reset to 1</td>
</tr>
<tr>
<td align="left">Child SAs (ESP/AH)</td>
<td align="left">Created in new exchange, see note 5</td>
</tr>
<tr>
<td align="left">Internal IP address</td>
<td align="left">Not resumed, but see note 3</td>
</tr>
<tr>
<td align="left">Other Configuration Payload information</td>
<td align="left">Not resumed</td>
</tr>
<tr>
<td align="left">Peer vendor IDs</td>
<td align="left">Unspecified (needed in the ticket only if vendor-specific state is required)</td>
</tr>
<tr>
<td align="left">Peer supports MOBIKE <a class='info' href='#RFC4555'>[RFC4555]<span> (</span><span class='info'>Eronen, P., &ldquo;IKEv2 Mobility and Multihoming Protocol (MOBIKE),&rdquo; June&nbsp;2006.</span><span>)</span></a></td>
<td align="left">From new exchange</td>
</tr>
<tr>
<td align="left">MOBIKE additional addresses</td>
<td align="left">Not resumed, should be resent by client if necessary</td>
</tr>
<tr>
<td align="left">Time until re-authentication <a class='info' href='#RFC4478'>[RFC4478]<span> (</span><span class='info'>Nir, Y., &ldquo;Repeated Authentication in Internet Key Exchange (IKEv2) Protocol,&rdquo; April&nbsp;2006.</span><span>)</span></a></td>
<td align="left">From new exchange (but ticket lifetime is bounded by this duration)</td>
</tr>
<tr>
<td align="left">Peer supports redirects <a class='info' href='#I-D.ietf-ipsecme-ikev2-redirect'>[I&#8209;D.ietf&#8209;ipsecme&#8209;ikev2&#8209;redirect]<span> (</span><span class='info'>Devarapalli, V. and K. Weniger, &ldquo;Redirect Mechanism for IKEv2,&rdquo; August&nbsp;2009.</span><span>)</span></a></td>
<td align="left">From new exchange</td>
</tr>
</table>
<br clear="all" />

<p>
        </p>
<blockquote class="text"><dl>
<dt>Note 1:</dt>
<dd>Certificates don't need to be stored if the peer never uses them for anything after the IKE SA is up (but would be needed if exposed to applications via IPsec APIs).
</dd>
<dt>Note 2:</dt>
<dd>If the certificate has an iPAddress SubjectAltName, and the implementation requires it to match the peer's source IP address, the same check needs to be performed on session resumption and the required information saved locally or in the ticket. 
</dd>
<dt>Note 3:</dt>
<dd>The client can request the address it was using earlier, and if possible, the gateway SHOULD honor the request.
</dd>
<dt>Note 4:</dt>
<dd>IKEv2 features that affect only the IKE_AUTH exchange (including HTTP_CERT_LOOKUP_SUPPORTED, multiple authentication exchanges <a class='info' href='#RFC4739'>[RFC4739]<span> (</span><span class='info'>Eronen, P. and J. Korhonen, &ldquo;Multiple Authentication Exchanges in the Internet Key Exchange (IKEv2) Protocol,&rdquo; November&nbsp;2006.</span><span>)</span></a>, ECDSA authentication <a class='info' href='#RFC4754'>[RFC4754]<span> (</span><span class='info'>Fu, D. and J. Solinas, &ldquo;IKE and IKEv2 Authentication Using the Elliptic Curve Digital Signature Algorithm (ECDSA),&rdquo; January&nbsp;2007.</span><span>)</span></a>, and OCSP <a class='info' href='#RFC4806'>[RFC4806]<span> (</span><span class='info'>Myers, M. and H. Tschofenig, &ldquo;Online Certificate Status Protocol (OCSP) Extensions to IKEv2,&rdquo; February&nbsp;2007.</span><span>)</span></a>) don't usually need any state in the IKE SA (after the IKE_AUTH exchanges are done), so resumption doesn't affect them.
</dd>
<dt>Note 5:</dt>
<dd>Since information about CHILD SAs and configuration payloads is not resumed, IKEv2 features related to CHILD SA negotiation (such as IPCOMP_SUPPORTED, ESP_TFC_PADDING_NOT_SUPPORTED, ROHC-over-IPsec <a class='info' href='#I-D.ietf-rohc-ikev2-extensions-hcoipsec'>[I&#8209;D.ietf&#8209;rohc&#8209;ikev2&#8209;extensions&#8209;hcoipsec]<span> (</span><span class='info'>Ertekin, E., Christou, C., Jasani, R., Kivinen, T., and C. Bormann, &ldquo;IKEv2 Extensions to Support Robust Header Compression over IPsec,&rdquo; February&nbsp;2010.</span><span>)</span></a> and configuration aren't usually affected by session resumption. 
</dd>
<dt>Note 6:</dt>
<dd>New IKEv2 features that are not covered by notes 4 and 5 should specify how they interact with session resumption. 
</dd>
</dl></blockquote><p>

        
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Ticket Handling</h3>

<a name="content"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
Ticket Content</h3>

<p>When passing a ticket by value to the client, the ticket
        content MUST be integrity protected and encrypted.
</p>
<p>A ticket
        by reference does not need to be encrypted, as it does not
        contain any sensitive material, such as keying material.
        However, access to the storage where that sensitive
        material is stored MUST be protected so that only
        unauthorized access is not allowed. We note that such a
        ticket is analogous to the concept of 'stub', as defined in
        <a class='info' href='#I-D.xu-ike-sa-sync'>[I&#8209;D.xu&#8209;ike&#8209;sa&#8209;sync]<span> (</span><span class='info'>Xu, Y., Yang, P., Ma, Y., Deng, H., and H. Deng, &ldquo;IKEv2 SA Synchronization for session resumption,&rdquo; October&nbsp;2008.</span><span>)</span></a>, or the concept of a
        Session ID from TLS.
</p>
<p>Although not strictly required for cryptographic protection,
        it is RECOMMENDED to integrity-protect the ticket by reference. Failing to do so
        could result in various security vulnerabilities on the gateway side, depending
        on the format of the reference. Potential vulnerabilities include
        access by the gateway to unintended URLs (similar to cross-site scripting) or SQL
        injection.
        
</p>
<p>When the state is passed by value, the ticket MUST
        encode at least the following state from an IKE SA.
        The same state MUST be stored in the ticket store,
        in the case of ticket by reference.
        
</p>
<p>
          </p>
<ul class="text">
<li>IDi, IDr.
</li>
<li>SPIi, SPIr.
</li>
<li>SAr (the accepted proposal).
</li>
<li>SK_d.
</li>
</ul><p>
        
</p>
<p>The ticket by value MUST include a key identity field,
        so that keys for encryption and authentication can be
        changed, and when necessary, algorithms can be
        replaced.
</p>
<a name="lifecycle"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
Ticket Identity and Lifecycle</h3>

<p>Each ticket is associated with a single IKE SA. In
        particular, when an IKE SA is deleted, the client MUST
        delete its stored ticket. Similarly, when credentials associated
        with the IKE SA are invalidated (e.g. when a user logs out),
        the ticket MUST be deleted. When the IKE SA is rekeyed the
        ticket is invalidated, and the client SHOULD request a new
        ticket.
</p>
<p>The lifetime of the ticket sent by the gateway SHOULD be the minimum of
        the IKE SA lifetime (per the gateway's local policy) and
        its re-authentication time, according to
        <a class='info' href='#RFC4478'>[RFC4478]<span> (</span><span class='info'>Nir, Y., &ldquo;Repeated Authentication in Internet Key Exchange (IKEv2) Protocol,&rdquo; April&nbsp;2006.</span><span>)</span></a>. Even if neither of these are
        enforced by the gateway, a finite lifetime MUST be
        specified for the ticket.
</p>
<p>
        The key that is used to protect the ticket MUST have a
        lifetime that is significantly longer than the lifetime of
        an IKE SA.
</p>
<p>In normal operation, the client will request a ticket when establishing the initial
        IKE SA, and then every time the SA is rekeyed or re-established
        because of re-authentication.
        
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
IANA Considerations</h3>

<p>This document requires a number of IKEv2 notification
      status types in
      <a class='info' href='#notifications'>Section&nbsp;4.7<span> (</span><span class='info'>IKE Notifications</span><span>)</span></a>, to be registered by IANA.
      The "IKEv2 Notify Message Types - Status Types" registry was
      established by IANA.
</p>
<p>The document defines a new IKEv2 exchange in
      <a class='info' href='#present-ticket'>Section&nbsp;4.3<span> (</span><span class='info'>Presenting a Ticket</span><span>)</span></a>. The corresponding registry
      was established by IANA.
</p>
<a name="security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Security Considerations</h3>

<p>This section addresses security issues related to the
      usage of a ticket.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.1"></a><h3>9.1.&nbsp;
Stolen Tickets</h3>

<p>An man-in-the-middle may try to eavesdrop on an exchange
        to obtain a ticket by value and use it to establish a
        session with the IKEv2 responder. This can happen in
        different ways: by eavesdropping on the initial
        communication and copying the ticket when it is granted and
        before it is used, or by listening in on a client's use of
        the ticket to resume a session. However, since the ticket's
        contents is encrypted and the attacker does not know the
        corresponding secret key, a stolen ticket cannot be used by
        an attacker to successfully resume a session. An IKEv2
        responder MUST use strong encryption and integrity
        protection of the ticket to prevent an attacker from
        obtaining the ticket's contents, e.g., by using a brute
        force attack.
</p>
<p>A ticket by reference does not need to be encrypted.
        When an adversary is able to eavesdrop on an exchange, as
        described in the previous paragraph, then the ticket by
        reference may be obtained. A ticket by reference cannot be used by
        an attacker to successfully resume a session, for the
        same reasons as for a ticket by value.
        Moreover, the adversary MUST NOT be able
        to resolve the ticket via the reference, i.e., access
        control MUST be enforced to ensure disclosure only to
        authorized entities.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.2"></a><h3>9.2.&nbsp;
Forged Tickets</h3>

<p>A malicious user could forge or alter a ticket by value
        in order to resume a session, to extend its lifetime, to
        impersonate as another user, or to gain additional
        privileges. This attack is not possible if the content of
        the ticket by value is protected using a strong integrity
        protection algorithm.
</p>
<p>In case of a ticket by reference an adversary may
        attempt to construct a fake ticket by reference to point to
        state information stored by the IKEv2 responder. This
        attack will fail because the adversary is not in possession
        of the keying material associated with the IKEv2 SA. As noted in
        <a class='info' href='#content'>Section&nbsp;7.1<span> (</span><span class='info'>Ticket Content</span><span>)</span></a>, it is often useful to integrity-protect
        the ticket by reference, too.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.3"></a><h3>9.3.&nbsp;
Denial of Service Attacks</h3>

<p>An adversary could generate and send a large number of
        tickets by value to a gateway for verification. To minimize
        the possibility of such denial of service, ticket
        verification should be lightweight (e.g., using efficient
        symmetric key cryptographic algorithms).
</p>
<p>When an adversary chooses to send a large number of
        tickets by reference then this may lead to an amplification
        attack as the IKEv2 responder is forced to resolve the reference to a
        ticket in order to determine that the adversary is not in
        possession of the keying material corresponding to the
        stored state or that the reference is void. To minimize
        this attack, the protocol to resolve the reference should be
        as lightweight as possible. and should not generate a large
        number of messages.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.4"></a><h3>9.4.&nbsp;
Key Management for Tickets By Value </h3>

<p>A full description of the management of the keys used to
        protect the ticket by value is beyond the scope of this
        document. A list of RECOMMENDED practices is given below.
        </p>
<ul class="text">
<li>The keys should be generated securely following the
          randomness recommendations in
          <a class='info' href='#RFC4086'>[RFC4086]<span> (</span><span class='info'>Eastlake, D., Schiller, J., and S. Crocker, &ldquo;Randomness Requirements for Security,&rdquo; June&nbsp;2005.</span><span>)</span></a>.
</li>
<li>The keys and cryptographic protection algorithms
          should be at least 128 bits in strength.
</li>
<li>The keys should not be used for any other purpose than
          generating and verifying tickets.
</li>
<li>The keys should be changed regularly.
</li>
<li>The keys should be changed if the ticket format or
          cryptographic protection algorithms change.
</li>
</ul>

<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.5"></a><h3>9.5.&nbsp;
Ticket Lifetime</h3>

<p>An IKEv2 responder controls the validity period of the
        state information by attaching a lifetime to a ticket. The
        chosen lifetime is based on the operational and security
        requirements of the environment in which this IKEv2
        extension is deployed. The responder provides information
        about the ticket lifetime to the IKEv2 initiator, allowing
        it to manage its tickets.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.6"></a><h3>9.6.&nbsp;
Ticket by Value Format</h3>

<p>Great care must be taken when defining a ticket format
        such that the requirements outlined in
        <a class='info' href='#content'>Section&nbsp;7.1<span> (</span><span class='info'>Ticket Content</span><span>)</span></a> are met. In particular, if
        confidential information, such as a secret key, is
        transferred to the client it MUST be done using channel
        security to prevent attackers from obtaining or modifying
        the ticket. Also, the ticket by value MUST have its
        integrity and confidentiality protected with strong
        cryptographic techniques to prevent a breach in the
        security of the system.
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.7"></a><h3>9.7.&nbsp;
Identity Privacy, Anonymity, and Unlinkability</h3>

<p>Since opaque state information is passed around between
        the IKEv2 initiator and the IKEv2 responder it is important
        that leakage of information, such as the identities of an
        IKEv2 initiator and a responder, MUST be avoided.
</p>
<p>When an IKEv2 initiator presents a ticket as part of the
        IKE_SESSION_RESUME exchange, confidentiality is not
        provided for the exchange. There is thereby the possibility
        for an on-path adversary to observe multiple exchange
        handshakes where the same state information is used and
        therefore to conclude that they belong to the same
        communication end points.
</p>
<p>This document therefore requires that the ticket be
        presented to the IKEv2 responder only once; under normal circumstances
        (e.g. no active attacker), there should be no multiple use
        of the same ticket.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Acknowledgements</h3>

<p>We would like to thank Paul Hoffman, Pasi Eronen, Florian
      Tegeler, Stephen Kent, Sean Shen, Xiaoming Fu, Stjepan Gros,
      Dan Harkins, Russ Housely, Yoav Nir and Tero Kivinen for
      their comments. We would like to particularly thank Florian
      Tegeler and Stjepan Gros for their help with their
      implementation efforts and Florian Tegeler for his formal
      verification using the CASPER tool set.
</p>
<p>We would furthermore like to thank the authors of
      <a class='info' href='#I-D.xu-ike-sa-sync'>[I&#8209;D.xu&#8209;ike&#8209;sa&#8209;sync]<span> (</span><span class='info'>Xu, Y., Yang, P., Ma, Y., Deng, H., and H. Deng, &ldquo;IKEv2 SA Synchronization for session resumption,&rdquo; October&nbsp;2008.</span><span>)</span></a>(Yan Xu, Peny Yang,
      Yuanchen Ma, Hui Deng and Ke Xu) for their input on the stub
      concept.
</p>
<p>We would like to thank Hui Deng, Tero Kivinen, Peny Yang,
      Ahmad Muhanna and Stephen Kent for their feedback regarding
      the ticket by reference concept.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4306">[RFC4306]</a></td>
<td class="author-text">Kaufman, C., &ldquo;<a href="http://tools.ietf.org/html/rfc4306">Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4306, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4306.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-ipsecme-ikev2-redirect">[I-D.ietf-ipsecme-ikev2-redirect]</a></td>
<td class="author-text">Devarapalli, V. and K. Weniger, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-ikev2-redirect-13.txt">Redirect Mechanism for IKEv2</a>,&rdquo; draft-ietf-ipsecme-ikev2-redirect-13 (work in progress), August&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-ikev2-redirect-13.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-ipsecme-ikev2bis">[I-D.ietf-ipsecme-ikev2bis]</a></td>
<td class="author-text">Kaufman, C., Hoffman, P., Nir, Y., and P. Eronen, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-ikev2bis-10.txt">Internet Key Exchange Protocol: IKEv2</a>,&rdquo; draft-ietf-ipsecme-ikev2bis-10 (work in progress), April&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-ipsecme-ikev2bis-10.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-rohc-ikev2-extensions-hcoipsec">[I-D.ietf-rohc-ikev2-extensions-hcoipsec]</a></td>
<td class="author-text">Ertekin, E., Christou, C., Jasani, R., Kivinen, T., and C. Bormann, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-rohc-ikev2-extensions-hcoipsec-12.txt">IKEv2 Extensions to Support Robust Header Compression over IPsec</a>,&rdquo; draft-ietf-rohc-ikev2-extensions-hcoipsec-12 (work in progress), February&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-rohc-ikev2-extensions-hcoipsec-12.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.rescorla-stateless-tokens">[I-D.rescorla-stateless-tokens]</a></td>
<td class="author-text">Rescorla, E., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-rescorla-stateless-tokens-01.txt">How to Implement Secure (Mostly) Stateless Tokens</a>,&rdquo; draft-rescorla-stateless-tokens-01 (work in progress), March&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-rescorla-stateless-tokens-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.xu-ike-sa-sync">[I-D.xu-ike-sa-sync]</a></td>
<td class="author-text">Xu, Y., Yang, P., Ma, Y., Deng, H., and H. Deng, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-xu-ike-sa-sync-01.txt">IKEv2 SA Synchronization for session resumption</a>,&rdquo; draft-xu-ike-sa-sync-01 (work in progress), October&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-xu-ike-sa-sync-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4086">[RFC4086]</a></td>
<td class="author-text">Eastlake, D., Schiller, J., and S. Crocker, &ldquo;<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>,&rdquo; BCP&nbsp;106, RFC&nbsp;4086, June&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4086.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4301">[RFC4301]</a></td>
<td class="author-text">Kent, S. and K. Seo, &ldquo;<a href="http://tools.ietf.org/html/rfc4301">Security Architecture for the Internet Protocol</a>,&rdquo; RFC&nbsp;4301, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4301.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4478">[RFC4478]</a></td>
<td class="author-text">Nir, Y., &ldquo;<a href="http://tools.ietf.org/html/rfc4478">Repeated Authentication in Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4478, April&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4478.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4555">[RFC4555]</a></td>
<td class="author-text">Eronen, P., &ldquo;<a href="http://tools.ietf.org/html/rfc4555">IKEv2 Mobility and Multihoming Protocol (MOBIKE)</a>,&rdquo; RFC&nbsp;4555, June&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4555.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4718">[RFC4718]</a></td>
<td class="author-text">Eronen, P. and P. Hoffman, &ldquo;<a href="http://tools.ietf.org/html/rfc4718">IKEv2 Clarifications and Implementation Guidelines</a>,&rdquo; RFC&nbsp;4718, October&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4718.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4739">[RFC4739]</a></td>
<td class="author-text">Eronen, P. and J. Korhonen, &ldquo;<a href="http://tools.ietf.org/html/rfc4739">Multiple Authentication Exchanges in the Internet Key Exchange (IKEv2) Protocol</a>,&rdquo; RFC&nbsp;4739, November&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4739.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4754">[RFC4754]</a></td>
<td class="author-text">Fu, D. and J. Solinas, &ldquo;<a href="http://tools.ietf.org/html/rfc4754">IKE and IKEv2 Authentication Using the Elliptic Curve Digital Signature Algorithm (ECDSA)</a>,&rdquo; RFC&nbsp;4754, January&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4754.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4806">[RFC4806]</a></td>
<td class="author-text">Myers, M. and H. Tschofenig, &ldquo;<a href="http://tools.ietf.org/html/rfc4806">Online Certificate Status Protocol (OCSP) Extensions to IKEv2</a>,&rdquo; RFC&nbsp;4806, February&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4806.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5077">[RFC5077]</a></td>
<td class="author-text">Salowey, J., Zhou, H., Eronen, P., and H. Tschofenig, &ldquo;<a href="http://tools.ietf.org/html/rfc5077">Transport Layer Security (TLS) Session Resumption without Server-Side State</a>,&rdquo; RFC&nbsp;5077, January&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5077.txt">TXT</a>).</td></tr>
</table>

<a name="format"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Ticket Format</h3>

<p>This document does not specify a mandatory-to-implement or
      a mandatory-to-use ticket format. The formats described in the
      following sub-sections are provided as useful examples.
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
Example Ticket by Value Format</h3>

<p>
          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

struct {
    [authenticated] struct {
        octet format_version;    // 1 for this version of the protocol
        octet reserved[3];       // sent as 0, ignored by receiver.
        octet key_id[8];         // arbitrary byte string
        opaque IV[0..255];       // actual length (possibly 0) depends
                                 // on the encryption algorithm

        [encrypted] struct {
            opaque IDi, IDr;     // the full payloads
            octet SPIi[8], SPIr[8];
            opaque SA;           // the full SAr payload
            octet SK_d[0..255];  // actual length depends on SA value
            int32 expiration;    // an absolute time value, seconds
                                 // since Jan. 1, 1970
        } ikev2_state;
    } protected_part;
    opaque MAC[0..255];          // the length (possibly 0) depends
                                 // on the integrity algorithm
} ticket;

</pre></div><p>

        
</p>
<p>Note that the key defined by "key_id" determines the
        encryption and authentication algorithms used for this
        ticket. Those algorithms are unrelated to the transforms
        defined by the SA payload.
</p>
<p>The reader is referred to
        <a class='info' href='#I-D.rescorla-stateless-tokens'>[I&#8209;D.rescorla&#8209;stateless&#8209;tokens]<span> (</span><span class='info'>Rescorla, E., &ldquo;How to Implement Secure (Mostly) Stateless Tokens,&rdquo; March&nbsp;2007.</span><span>)</span></a> that
        recommends a similar (but not identical) ticket format, and
        discusses related security considerations in depth.
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.2"></a><h3>A.2.&nbsp;
Example Ticket by Reference Format</h3>

<p>For implementations that prefer to pass a reference to
        IKE state in the ticket, rather than the state itself, we
        suggest the following format:
</p>
<p>
          </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

struct {
      [authenticated] struct {
          octet format_version;  // 1 for this version of the protocol
          octet reserved[3];     // sent as 0, ignored by receiver.
          octet key_id[8];       // arbitrary byte string

          struct {
              opaque state_ref;  // reference to IKE state
              int32 expiration;  // an absolute time value, seconds
                                 // since Jan. 1, 1970
          } ikev2_state_ref;
      } protected_part;
      opaque MAC[0..255];        // the length depends
                                 // on the integrity algorithm
} ticket;

</pre></div><p>

        
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
Change Log</h3>

<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.1"></a><h3>B.1.&nbsp;
-03</h3>

<p>Changed the protocol from one to two round trips, to
        simplify the security assumptions. Eliminated security
        considerations associated with the previous version.
</p>
<p>Closed issue #69, Clarify behavior of SPI and sequence
        numbers.
</p>
<p>Closed issue #70, Ticket lifetime - explicit or not?
        (and ticket push from gateway).
</p>
<p>Closed issue #99, Ticket example: downgrade.
</p>
<p>Closed issue #76, IPsec child SAs during resumption.
</p>
<p>Closed issue #77, Identities in draft-ietf-ipsecme-ikev2-resumption.
</p>
<p>Closed issue #95, Minor nits for
        ikev2-resumption-02.
</p>
<p>Closed issue #97, Clarify what state comes from where.
</p>
<p>Closed issue #98, Replays in 1-RTT protocol.
</p>
<p>Closed issue #100, NAT detection [and] IP address change.
</p>
<p>Closed issue #101, Assorted issues by Tero.
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.2"></a><h3>B.2.&nbsp;
-02</h3>

<p>Added a new TICKET_OPAQUE payload that does not have a
        lifetime field included.
</p>
<p>Removed the lifetime usage from the IKE_SESSION_RESUME
        exchange (utilizing the TICKET_OPAQUE) when presenting the
        ticket to the gateway.
</p>
<p>Removed IDi payloads from the IKE_SESSION_RESUME
        exchange.
</p>
<p>Clarified that IPsec child SAs would be deleted once the
        old IKE SA gets deleted as well.
</p>
<p>Clarified the behavior of SPI and sequence number
        usage.
</p>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.3"></a><h3>B.3.&nbsp;
-01</h3>

<p>Addressed issue#75, see
        http://tools.ietf.org/wg/ipsecme/trac/ticket/75. This
        included changes throughout the document to ensure that the
        ticket may contain a reference or a value.
</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.4"></a><h3>B.4.&nbsp;
-00</h3>

<p>Resubmitted document as a WG item.
</p>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.5"></a><h3>B.5.&nbsp;
-01</h3>

<p>Added reference to
        <a class='info' href='#I-D.xu-ike-sa-sync'>[I&#8209;D.xu&#8209;ike&#8209;sa&#8209;sync]<span> (</span><span class='info'>Xu, Y., Yang, P., Ma, Y., Deng, H., and H. Deng, &ldquo;IKEv2 SA Synchronization for session resumption,&rdquo; October&nbsp;2008.</span><span>)</span></a>
</p>
<p>Included recommended ticket format into the appendix
</p>
<p>Various editorial improvements within the document
</p>
<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.6"></a><h3>B.6.&nbsp;
-00</h3>

<p>Issued a -00 version for the IPSECME working group.
        Reflected discussions at IETF#72 regarding the strict focus
        on session resumption. Consequently, text about failover
        was removed.
</p>
<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.7"></a><h3>B.7.&nbsp;
-04</h3>

<p>Editorial fixes; references cleaned up; updated author's
        contact address
</p>
<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.8"></a><h3>B.8.&nbsp;
-03</h3>

<p>Removed counter mechanism. Added an optional anti-DoS
        mechanism, based on IKEv2 cookies (removed previous
        discussion of cookies). Clarified that gateways may support
        reallocation of same IP address, if provided by network.
        Proposed a solution outline to the problem of key exchange
        for the keys that protect tickets. Added fields to the
        ticket to enable interoperability. Removed incorrect MOBIKE
        notification.
</p>
<a name="anchor29"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.9"></a><h3>B.9.&nbsp;
-02</h3>

<p>Clarifications on generation of SPI values, on the
        ticket's lifetime and on the integrity protection of the
        anti-replay counter. Eliminated redundant SPIs from the
        notification payloads.
</p>
<a name="anchor30"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.10"></a><h3>B.10.&nbsp;
-01</h3>

<p>Editorial review. Removed 24-hour limitation on ticket
        lifetime, lifetime is up to local policy.
</p>
<a name="anchor31"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B.11"></a><h3>B.11.&nbsp;
-00</h3>

<p>Initial version. This draft is a selective merge of
        draft-sheffer-ike-session-resumption-00 and
        draft-dondeti-ipsec-failover-sol-00.
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Yaron Sheffer</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Check Point Software
      Technologies Ltd.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5 Hasolelim St.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tel Aviv  67897</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Israel</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:yaronf@checkpoint.com">yaronf@checkpoint.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hannes Tschofenig</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nokia Siemens Networks</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Linnoitustie 6</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Espoo  02600</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 (50) 4871445</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Hannes.Tschofenig@gmx.net">Hannes.Tschofenig@gmx.net</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.tschofenig.priv.at">http://www.tschofenig.priv.at</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Lakshminath Dondeti</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">QUALCOMM, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5775 Morehouse Dr</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Diego, CA</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 858-845-1267</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ldondeti@qualcomm.com">ldondeti@qualcomm.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Vidya Narayanan</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">QUALCOMM, Inc.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5775 Morehouse Dr</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Diego, CA</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 858-845-2483</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:vidyan@qualcomm.com">vidyan@qualcomm.com</a></td></tr>
</table>
</body></html>
