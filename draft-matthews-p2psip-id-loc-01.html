<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>An ID/Locator Architecture for P2PSIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="An ID/Locator Architecture for P2PSIP">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">P2PSIP Working Group</td><td class="header">E. Cooper</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">A. Johnston</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">P. Matthews</td></tr>
<tr><td class="header">Expires: August 28, 2008</td><td class="header">Avaya</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">February 25, 2008</td></tr>
</table></td></tr></table>
<h1><br />An ID/Locator Architecture for P2PSIP<br />draft-matthews-p2psip-id-loc-01</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on August 28, 2008.</p>

<h3>Abstract</h3>

<p>This document describes an architecture where peers in an
      peer-to-peer overlay use special IP addresses to identify other peers.
      Two of the advantages of this approach are that (a) most existing
      applications can run in an overlay without needing any changes and (b)
      peer mobility and NAT traversal are handled in a way that is transparent
      to most applications.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<br />
<a href="#anchor2">2.</a>&nbsp;
Overview/Example<br />
<br />
<a href="#anchor3">3.</a>&nbsp;
Terminology<br />
<br />
<a href="#anchor4">4.</a>&nbsp;
Details<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">4.1.</a>&nbsp;
LSI<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">4.2.</a>&nbsp;
Peer Protocol<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">4.3.</a>&nbsp;
Shim Layer<br />
<br />
<a href="#anchor8">5.</a>&nbsp;
Domain Names<br />
<br />
<a href="#anchor9">6.</a>&nbsp;
Example<br />
<br />
<a href="#anchor10">7.</a>&nbsp;
IANA Considerations<br />
<br />
<a href="#anchor11">8.</a>&nbsp;
Security Considerations<br />
<br />
<a href="#anchor12">9.</a>&nbsp;
Appendix: Discussion of Design Choices<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">9.1.</a>&nbsp;
LSIs have Local Significance<br />
<br />
<a href="#Relationship-to-HIP">10.</a>&nbsp;
Relationship to HIP<br />
<br />
<a href="#rfc.references1">11.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">11.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">11.2.</a>&nbsp;
Informative References<br />
<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>This document describes a scheme whereby the applications running on
      a peer can use a special IP addresses, called "LSIs" (Locally
      Significant Identifiers), to identify other peers in the peer-to-peer
      overlay, rather than using real IP addresses or peer IDs. Using these
      LSIs brings the following advantages:</p>
<ul class="text">
<li>An LSI is unique, unlike the real IP address of most peers (which
          is often a private IP address);
</li>
<li>An LSI can be used in the Socket API without change, unlike
          160-bit peer IDs;
</li>
<li>Applications using LSIs do not have to worry about NAT traversal,
          mobility, or multi-homing, since these are handled by a helper
          application.
</li>
</ul><p>The scheme effectively turns the overlay into a VPN. Like other
      VPNs, it can be implemented so that most applications are unaware that
      they are using the VPN. Only applications that want to take advantage of
      the special properties of the overlay need to be aware.
</p>
<p>Though not discussed further in the document, this scheme can be
      trivially extended to handle clients as well.
</p>
<p>This scheme is not a Peer Protocol in itself. Rather, it is an
      enhancement to a Peer Protocol.
</p>
<p>This approach can be compared with the approach taken by many of the
      other proposals in P2PSIP (e.g., RELOAD, ASP, P2PP, and XPP/PCAN). In
      these proposals, peers are identified with bitstrings that do not look
      like addresses, forcing applications that want to run in an overlay to
      use a new (as yet unspecified) API, rather than the existing Socket API.
      Furthermore, though these proposals handle NAT traversal for the Peer
      protocol, they do not handle NAT traversal for applications, forcing
      each application to invent its own ICE variation. None of these
      proposals currently consider mobility at all. All of this means that any
      application that wants to run in an overlay requires significant
      modification.
</p>
<p>This scheme grew out of the authors' previous efforts to adapt HIP to
      peer-to-peer overlays. More details on the relationship of this work to
      HIP is given in <a class='info' href='#Relationship-to-HIP'>Section&nbsp;10<span> (</span><span class='info'>Relationship to HIP</span><span>)</span></a>.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Overview/Example</h3>

<p>This section gives an overview of how the scheme works. It is
      non-normative.
</p>
<p>This overview is in the form of an extended example and assume a
      particular implementation approach. While not fully general, experience
      has shown that this is a good way to explain the concepts.
</p>
<p>Consider a peer-to-peer overlay. This overlay is assigned a domain
      name by the peer that created it; say it is "example.com". This overlay
      has a number of peers, of which there are three of interest, called
      "venus", "earth", and "mars". Each peer in the overlay is assigned a
      domain name underneith the "example.com" domain; for example
      "mars.example.com". The domain names of peers are NOT stored in DNS.
      Instead, each peer stores a mapping between its domain name and its peer
      ID in the overlay's Distributed Database.
</p>
<p>The machines Venus and Mars are using popular commercial operating
      systems. To allow them to join the overlay, a user named Wilma has
      installed some peer-to-peer software. This software has two parts. One
      part an implementation of the Peer Protocol with some ID-LOC extensions,
      the other part is a TAP device driver <a href='http://en.wikipedia.org/wiki/TUN/TAP'>http://en.wikipedia.org/wiki/TUN/TAP</a>. This is shown in
      the following figure.
</p><br /><hr class="insert" />
<a name="fig-implementation"></a>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre> _______________                 _________________
|               |               |  Peer Protocol  |
| Application   |               |  with ID-LOC    |
|_______________|               |_________________|    Userspace
 _______+_________________________+________+_______   -------------
|                              +                   |     Kernel
|          TCP/IP stack    +                       |
|______________________+___________________________|
 _______+___________+            __________+______
|                   |           |  Ethernet       |
| TAP Device Driver |           |  Device Driver  |
|___________________|           |_________________|
                                           +
                                           +

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>The "+" signs show the typical path of an application data packet
      traveling to/from a remote peer. Packets sent by the application pass
      down through the kernel's TCP/IP stack. Packets satisfying certain
      criteria are intercepted by the TAP driver and passed to the Peer
      Protocol, which modifies them before sending them back down through the
      kernel's TCP/IP stack and out through the Ethernet device driver. In the
      reverse direction, incoming packets arrive at the Ethernet device driver
      and pass up through the TCP/IP stack and are delivered to the Peer
      Protocol. There they are modified and then passed to the TAP driver
      which reinjects them into the bottom of the TCP/IP stack. They then pass
      up through the TCP/IP stack and are delivered to the application.
</p>
<p>Wilma wishes to view a website on the machine Mars. To do this, she
      opens a popular web brower and enters "http://mars.example.com" into the
      address bar. This causes the web browser to do gethostbyname() on
      "mars.example.com", which in turn causes a DNS query packet to be formed
      and sent down the TCP/IP stack. It is important to note that this web
      browser has not been modified in any way, and thus has no knowledge that
      it is operating in a peer-to-peer overlay.
</p>
<p>The DNS query packet is intercepted by the TAP driver, which passes
      it to the Peer Protocol process. The Peer Protocol notices that the
      domain name is in the "example.com" overlay which Venus is currently a
      member of. So the Peer Protocol does a Distributed Database query for
      "mars.example.com" and gets back the 160-bit peer ID of Mars.
</p>
<p>The Peer Protocol process stores the peer ID of Mars and assigns it
      an LSI (call it Y). The Peer Protocol process then creates a DNS
      response packet indicating that "mars.example.com" maps to Y. This
      packet is passed to the TAP driver, which injects it into the bottom of
      the TCP/IP stack. 
</p>
<p>The result is that the Wilma's web browser gets back the LSI "Y" as
      the address of Mars. 
</p>
<p>Wilma's web browser then issues a connect() call to create a TCP
      connection to "Y". This causes the TCP/IP stack to send a SYN packet
      with destination "Y". This packet is intercepted by the TAP driver and
      passed to the Peer Protocol process. 
</p>
<p>The Peer Protocol stores the TCP SYN while it sets up a UDP
      connection between Venus and Mars. This UDP connection is established
      using the connection establishment procedures of the peer protocol and
      uses ICE to traverse any NATs between Venus and Mars. This UDP
      connection is then uses as a "pipe" to carry all traffic between Venus
      and Mars encapsulated inside it.
</p>
<p></p>
<blockquote class="text">
<p>This approach is known as the "Outer UDP encapsulation". An
          alternative approach, known as the "Null encapsulation" is described
          in the normative text below.
</p>
</blockquote>
<div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre>
 ___________                                      ___________
|           |                                    |           |
|           | -------- outer UDP pipe ---------- |           |
|           |                                    |           |
|  Venus    | === web browser TCP connection ==  |   Mars    |
|           | ===== other TCP connection ======  |           |
|           | -------- outer UDP pipe ---------- |           |
|___________|                                    |___________|


</pre></div>
<p>Once this UDP pipe is established, the Peer Protocol process on Venus
      then modifies the TCP SYN so that it will travel inside the "UDP pipe"
      to the machine Mars. By doing this, the web browser and the web server
      do not need to run ICE or deal with peer IDs. 
</p>
<p>At Mars, the UDP header is removed and the TCP SYN is then passed to
      the TAP driver on Mars, which passes it up through the TCP/IP stack.
</p>
<p>Subsequent TCP packets between Venus and Mars are also encapsulated
      inside UDP and sent along the pipe. 
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].
</p>
<p>Readers are expected to be familar with <a class='info' href='#I-D.ietf-p2psip-concepts'>[I&#8209;D.ietf&#8209;p2psip&#8209;concepts]<span> (</span><span class='info'>Bryan, D., Matthews, P., Shim, E., Willis, D., and S. Dawkins, &ldquo;Concepts and Terminology for Peer to Peer SIP,&rdquo; July&nbsp;2008.</span><span>)</span></a> and the terms defined
      there.
</p>
<p>This document defines the following terms:</p>
<blockquote class="text"><dl>
<dt>LSI:</dt>
<dd>An IP address uses to identify a peer in the
          overlay.
</dd>
<dt>Outer UDP Encapsulation</dt>
<dd>An encapsulation scheme for
          packets travelling between two peers in the overlay that insert a
          UDP header and a demux header between the IP header and the existing
          transport header.
</dd>
<dt>Null Encapsulation</dt>
<dd>An excapsulation scheme for packets
          travelling between two peers in the overlay that does not insert any
          extra headers, but instead modifies fields in the existing IP and
          transport headers.
</dd>
</dl></blockquote>

<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Details</h3>

<p>Figure X shows the conceptual relationship between the parts
      discussed in this section. 
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre> _______________ _______________
|               |               |
| Peer Protocol |      SIP      |  Other Apps ...
|_______________|_______________|_________________
|                                                 |
|                 TCP, UDP, etc                   |
|_________________________________________________|
|                                                 |
|                   Shim layer                    |
|_________________________________________________|
|                                                 |
|                  IP (v4 or v6)                  |
|_________________________________________________|
</pre></div>
<p>In this architecture, the Peer Protocol is responsible for creating
      the mapping between LSIs and real addresses, while the Shim layer is
      responsible for doing the translation on a packet-by-packet basis as
      well as adding any necessary encapsulation. More details on these roles
      can be found below.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
LSI</h3>

<p>An LSI is either:</p>
<ul class="text">
<li>An IPv4 address selected from a range to be allocated by IANA
            (likely a /16), or
</li>
<li>An IPv6 address selected from a range to be determined (perhaps
            the ORCHID range <a class='info' href='#RFC4843'>[RFC4843]<span> (</span><span class='info'>Nikander, P., Laganier, J., and F. Dupont, &ldquo;An IPv6 Prefix for Overlay Routable Cryptographic Hash Identifiers (ORCHID),&rdquo; April&nbsp;2007.</span><span>)</span></a>).
</li>
</ul><p>An LSI has local significance only.
</p>
<p>Applications can freely intermix LSIs with ordinary
        (&ldquo;real&rdquo;) addresses. For example, an application can use
        LSIs to identify nodes in the overlay, and real addresses to identify
        nodes off the overlay.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Peer Protocol</h3>

<p>The job of the Peer Protocol in this scheme (in addition to its
        other duties of managing the overlay and implementing the Distributed
        Database <a class='info' href='#I-D.ietf-p2psip-concepts'>[I&#8209;D.ietf&#8209;p2psip&#8209;concepts]<span> (</span><span class='info'>Bryan, D., Matthews, P., Shim, E., Willis, D., and S. Dawkins, &ldquo;Concepts and Terminology for Peer to Peer SIP,&rdquo; July&nbsp;2008.</span><span>)</span></a>) is to
        establish connections between peers and to manage the mappings between
        LSIs and real addresses. To do this, the Peer Protocol does an ICE
        exchange with the destination peer to negotiate a set of addresses and
        ports to use for the data traffic.
</p>
<p>The stimulus for doing this ICE exchange is an indication from the
        Shim layer saying that is has no set of real addresses to use for a
        given destination LSI (cf. an ARP cache miss). The Peer Protocol then
        does an ICE exchange with the destination peer, routing the
        Offer/Answer though other peers in the overlay. Once the exchange has
        completed, the Peer Protocol installs the appropriate mapping entry
        into the Shim layer.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Shim Layer</h3>

<p>The shim layer is a new layer introduced between the IP layer and
        the transport layer. It has two functions: translating LSIs to/from
        real addresses, and adding any necessary encapsulation.
</p>
<p>There are two forms of encapsulation: null encapsulation and
        outer-UDP encapsulation.
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre> _____________________________         ___________________________
|                             |       |                           |
|      Application data       |       |     Application data      |
|_____________________________|       |___________________________|
|                             |       |                           |
| Transport (TCP or UDP only) |       |     Transport header      |
|_____________________________|       |___________________________|
|                             |       |                           |
|        Demux header         |       |    IP header (v4 or v6)   |
|_____________________________|       |___________________________|
|                             |
|         UDP header          |             Null Encapsulation
|_____________________________|
|                             |
|     IP header (v4 or v6)    |
|_____________________________|

    Outer-UDP Encapsulation
</pre></div>
<p>The Demux header looks like:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Protocol     |                Reserved                       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>Here the protocol field indicates which transport (or other)
        protocol follows, and uses the same codepoints as used for the
        &lsquo;protocol&rsquo; field in the IPv4/IPv6 header.
</p>
<p>The null encapsulation adds no extra bytes but simply translates
        LSIs to real addresses and modifies port numbers as necessary to
        traverse NATs. The null encapsulation is very similar to existing
        protocol stacks, but requires more work to set up and maintain because
        each connection requires its own set of ICE connectivity checks.
</p>
<p>By contrast, the Outer-UDP encapsulation adds a UDP header plus a
        4-byte demux header between the IP header and the transport header.
        The Outer-UDP encapsulation multiplexes all connections between two
        given nodes inside a single UDP "pipe". Because intervening NATs see
        only the outer UDP header, this encapsulation requires only one ICE
        exchange (to set up the outer pipe), regardless of how many
        connections there are inside the pipe.
</p>
<p>The Outer-UDP encapsulation can be used with all transport
        protocols, while the null encapsulation can only be used with UDP and
        TCP.
</p>
<p>To explain the mapping and encapsulations in more detail, consider
        a transport layer PDU is sent from X:x to Y:y, where X is the LSI of
        the local host, Y is the LSI of the remote host, and x and y are the
        port numbers allocated off of these identifiers. For both
        encapsulations, the Peer Protocol will have used ICE to determine a
        corresponding set of real addresses and ports.
</p>
<p>For the null encapsulation, each transport layer 5-tuple (transport
        protocol,X,x,Y,y) will have a corresponding set of real addresses and
        ports (X&rsquo;,x&rsquo;,Y&rsquo;,y&rsquo;). When sending, the port
        numbers x and y in the transport header are replaced with x&rsquo; and
        y&rsquo;, and an IP header is added containing addresses X&rsquo; and
        Y&rsquo; is added. (TBD: Are the addresses in the transport layer
        pseudo-header also replaced?). The reverse replacement is done when
        receiving a PDU.
</p>
<p>If either X or Y change their real address, then an ICE exchange is
        required to determine a new 5-tuple for each connection. For UDP, this
        new 5-tuple is simply used in place of the old.
</p>
<p></p>
<blockquote class="text">
<p>OPEN ISSUE: For TCP, this doesn&rsquo;t work, since generating
            the new 5-tuple requires a new TCP handshake. This seems to imply
            that the TCP layer has to be aware of the change in address. So
            what do we do? Do we just say &ldquo;don&rsquo;t use null
            encapsulation for TCP if you want mobility to work&rdquo;? Or do
            we figure out how to make this work?
</p>
</blockquote>

<p>For the outer-UDP encapsulation, there is a single 5-tuple
        (UDP,X&rsquo;,x&rsquo;,Y&rsquo;,y&rsquo;) for each (X,Y) pair. When
        sending, the transport header is not modified, instead a demux header
        and a outer UDP header is added. Ports x&rsquo; and y&rsquo; are
        inserted in the outer UDP header, and an IP header containing
        addresses X&rsquo; and Y&rsquo; is added.
</p>
<p>Mobility is simpler with the Outer-UDP encapsulation. In this case,
        only a single ICE exchange is required, and the new 5-tuple is simply
        used in place of the old. There are no TCP concerns in this case,
        since the TCP header is never modified.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Domain Names</h3>

<p>Each overlay is assigned a domain name by the peer that creates the
      overlay. This can be any domain name that the peer has authority
      over.
</p>
<p>Each peer is assigned a unique domain name underneith the overlay's
      domain name. This document does not specify how this assignment is done,
      but one option might be to use the peer's machine name as the label in
      front of the overlay domain name, and then use some scheme to break
      ties. 
</p>
<p>Each peer MUST store a mapping between its domain name and its peer
      ID in the Distributed Database. The peer's domain name MAY be stored in
      DNS as well.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Example</h3>

<p>In this section, we show a SIP call between two UAs in an
      overlay.
</p>
<p>This example illustrates how this scheme allows applications to work
      in an overlay without being aware of that fact. The two SIP UAs in this
      example use standard client-server SIP to communicate, without needing
      any SIP extensions.
</p>
<p>IMPORTANT NOTE: Without extensions to SIP, there is no way to do an
      AOR to contact URI lookup using the Distributed Database. So in this
      example, Wilma calls Fred by specifying Fred&rsquo;s machine name, using
      the domain name scheme described in the previous section. With this
      caveat, everything works with SIP as it is today.
</p>
<p>The figure below shows the call flow for this example.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>Wilma                                                              Fred
Venus                                  Earth                       Mars
 |                                       |                           |
 |-- DD query for mars.example.com  ----&gt;|                           |
 |&lt;--------------- DD response ----------|                           |
 |                                       |                           |
 |----------- Msg w/ICE Offer ----------&gt;|                           |
 |                                       |----- Msg w/ICE Offer ----&gt;|
 |                                       |&lt;---- Msg w/ICE Ans -------|
 |&lt;---------- Msg w/ ICE Ans ------------|                           |
 |                                                                   |
 |&lt;=================== ICE Connectivity Checks =====================&gt;|
 |                                                                   |
 |&lt;-------------------- TCP and TLS handshake ----------------------&gt;|
 |                                                                   |
 |&lt;------------- SIP transaction over TLS connection ---------------&gt;|
 |                                                                   |

</pre></div>
<p>This example shows three machines, named &ldquo;Venus&rdquo;,
      &ldquo;Earth&rdquo;, and &ldquo;Mars&rdquo; which are part of a larger
      overlay named &ldquo;example.com&rdquo;. Wilma is on Venus, and Fred is
      on Mars.
</p>
<p>Wilma initiates the call by typing in "sips:fred@mars.example.com"
      into her UA. Wilma&rsquo;s UA does a gethostbyname() call to resolve
      &ldquo;mars.example.com&rdquo; and this is resolved by doing a
      Distributed Database lookup. In this example, it turns out that the
      corresponding resource record is stored on the machine "Earth". As a
      result, an LSI for the peer Mars is returned from the gethostbyname()
      call to Wilma&rsquo;s UA.
</p>
<p></p>
<blockquote class="text">
<p>NOTE: The Peer Protocol allocates an LSI and remembers that it
          maps to the machine named "mars.solar-system.p2p" which has the peer
          id learned from the response.
</p>
</blockquote>

<p>Wilma&rsquo;s UA then issues a connect() to this LSI. This causes TCP
      to send a SYN to this LSI. Since there is currently no direct connection
      between Venus and Mars, the Shim layer finds no mapping for this LSI and
      thus generates an indication to the Peer Protocol.
</p>
<p>The Peer Protocol layer on Venus now does an ICE offer/answer
      exchange with the Peer Protocol layer on Mars. The Offer is sent on the
      existing connection to Earth, which forwards it to Mars, and the Answer
      is returned in the same way. ICE connectivity checks are then done, and
      the result is a tuple of real addresses and ports for the
      connection.
</p>
<p>If null encapsulation is used, then the TCP connection was
      established as part of the ICE connectivity checks. This new connection
      is used only for SIP signaling, and subsequent connections require a new
      offer/answer exchange.
</p>
<p>But if Outer-UDP encapsulation is used, then all the ICE connectivity
      checks do is establish a UDP "pipe" between the two peers, and the TCP
      and TLS handshakes must still be done inside that pipe (as shown above).
      However, this UDP pipe can be used for all traffic between Venus and
      Mars, including subsequent RTP packets) without the need of subsequent
      offer/answer exchanges.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA Considerations</h3>

<p>TBD.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>TBD.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Appendix: Discussion of Design Choices</h3>

<p>This appendix discusses the thinking around some of the design
      choices made.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.1"></a><h3>9.1.&nbsp;
LSIs have Local Significance</h3>

<p>In the design presented here, the LSIs presented to applications
        have local significance only. For IPv4, this seems to be the only
        reasonable choice, as it would be difficult to get an IPv4 block of
        addresses large enough to be of wider significance. However, for IPv6,
        a wider scope would be possible, and that option was considered. In
        particular, it would have been possible to use a globally scoped
        identifier, like the HIT of HIP. At first blush, it seems that using a
        globally scoped identifier would allow an applications to send the
        identifier (embedded in protocol messages) to an application on other
        nodes and have that identifier make sense.
</p>
<p>However, an examination of the details shows that there are
        problems with this approach. Say a node X has an indentifier for node
        Z (e.g., a HIT) and sends its to node Y. For Y to be able to use this
        identifier, it must know how to establish a connection with node Z. If
        node Y is in multiple overlays, then Y has no idea which overlay to
        search to find node Z. It is this difficulty that led us to the
        decision to make LSI have local significance only.
</p>
<a name="Relationship-to-HIP"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Relationship to HIP</h3>

<p>The fundamental concept in this document, that of an identifier for a
      node which is distinct from the node&rsquo;s real addresses, has been
      adopted from HIP. In HIP, this identifier (known as a HIT <a class='info' href='#I-D.ietf-hip-base'>[I&#8209;D.ietf&#8209;hip&#8209;base]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; October&nbsp;2007.</span><span>)</span></a>) is always an IPv6 identifier, and
      has global scope and cryptographic properties, making it computationally
      hard for an second node to steal a node&rsquo;s identity. (Current HIP
      implementations also implement an IPv4 identifier as a local identifier,
      but the properties of this IPv4 identifier are not currently specified
      anywhere).
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-mmusic-ice">[I-D.ietf-mmusic-ice]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>,&rdquo; draft-ietf-mmusic-ice-19 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-mmusic-ice-19.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-hip-base">[I-D.ietf-hip-base]</a></td>
<td class="author-text">Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-hip-base-10.txt">Host Identity Protocol</a>,&rdquo; draft-ietf-hip-base-10 (work in progress), October&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-hip-base-10.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-p2psip-concepts">[I-D.ietf-p2psip-concepts]</a></td>
<td class="author-text">Bryan, D., Matthews, P., Shim, E., Willis, D., and S. Dawkins, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-p2psip-concepts-02.txt">Concepts and Terminology for Peer to Peer SIP</a>,&rdquo; draft-ietf-p2psip-concepts-02 (work in progress), July&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-p2psip-concepts-02.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4843">[RFC4843]</a></td>
<td class="author-text">Nikander, P., Laganier, J., and F. Dupont, &ldquo;<a href="http://tools.ietf.org/html/rfc4843">An IPv6 Prefix for Overlay Routable Cryptographic Hash Identifiers (ORCHID)</a>,&rdquo; RFC&nbsp;4843, April&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4843.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Eric Cooper</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Avaya</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1135 Innovation Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ottawa, Ontario  K2K 3G7</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 613 592 4343 x228</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ecooper@avaya.com">ecooper@avaya.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Alan Johnston</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Avaya</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">St. Louis, MO  63124</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:alan@sipstation.com">alan@sipstation.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Philip Matthews</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Avaya</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">100 Innovation Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ottawa, Ontario  K2K 3G7</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 613 592 4343 x224</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:philip_matthews@magma.ca">philip_matthews@magma.ca</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
