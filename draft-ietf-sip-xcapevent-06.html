<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>An Extensible Markup Language (XML)
    Configuration Access Protocol (XCAP) Diff Event Package</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="An Extensible Markup Language (XML)
    Configuration Access Protocol (XCAP) Diff Event Package">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">SIP</td><td class="header">J. Urpalainen</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Nokia</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">D. Willis, Ed.</td></tr>
<tr><td class="header">Expires: November 28, 2009</td><td class="header">Softarmor Systems LLC</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">May 27, 2009</td></tr>
</table></td></tr></table>
<h1><br />An Extensible Markup Language (XML)
    Configuration Access Protocol (XCAP) Diff Event Package<br />draft-ietf-sip-xcapevent-06</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.
This document may contain material from IETF Documents or IETF
Contributions published or made publicly available before November
10, 2008. The person(s) controlling the copyright in some of this
material may not have granted the IETF Trust the right to allow
modifications of such material outside the IETF Standards Process.
Without obtaining an adequate license from the person(s) controlling
the copyright in such materials, this document may not be modified
outside the IETF Standards Process, and derivative works of it may
not be created outside the IETF Standards Process, except to format
it for publication as an RFC or to translate it into languages other
than English.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on November 28, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>This document describes an "xcap-diff" SIP (Session Initiation
      Protocol) event package for the SIP Event Notification Framework, which
      clients can use to receive notifications of changes to Extensible Markup
      Language (XML) Configuration Access Protocol (XCAP) resources. The
      initial synchronization information exchange and document updates are
      based on the XCAP Diff format.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#introduction">1.</a>&nbsp;
Introduction<br />
<a href="#Terminology">2.</a>&nbsp;
Terminology<br />
<a href="#Definitions">3.</a>&nbsp;
Definitions<br />
<a href="#Package">4.</a>&nbsp;
XCAP-Diff Event Package<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#Requirements">4.1.</a>&nbsp;
Overview of Operation With Basic Requirements<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#event-name">4.2.</a>&nbsp;
Event Package Name<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#diff-processing-parameter">4.3.</a>&nbsp;
'diff-processing' Event Package Parameter<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#subbody">4.4.</a>&nbsp;
SUBSCRIBE Bodies<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#duration">4.5.</a>&nbsp;
Subscription Duration<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#notbody">4.6.</a>&nbsp;
NOTIFY Bodies<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#notgen">4.7.</a>&nbsp;
Notifier Generation of NOTIFY Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#subproc">4.8.</a>&nbsp;
Subscriber Processing of NOTIFY Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#fork">4.9.</a>&nbsp;
Handling of Forked Requests<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#notrate">4.10.</a>&nbsp;
Rate of Notifications<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#agents">4.11.</a>&nbsp;
State Agents<br />
<a href="#Example">5.</a>&nbsp;
An Initial Example NOTIFY document<br />
<a href="#IANA-Considerations">6.</a>&nbsp;
IANA Considerations<br />
<a href="#Security">7.</a>&nbsp;
Security Considerations<br />
<a href="#Acknowledgments">8.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">9.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">9.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">9.2.</a>&nbsp;
Informative References<br />
<a href="#appendix">Appendix&nbsp;A.</a>&nbsp;
Informative Examples<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">A.1.</a>&nbsp;
Initial documents on an XCAP server<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">A.2.</a>&nbsp;
An Initial Subscription<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">A.3.</a>&nbsp;
A Document Addition Into a Collection<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">A.4.</a>&nbsp;
A Series of XCAP Component Modifications<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">A.5.</a>&nbsp;
An XCAP Component Subscription<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">A.6.</a>&nbsp;
A Conditional Subscription<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="introduction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>The SIP Events framework <a class='info' href='#RFC3265'>[RFC3265]<span> (</span><span class='info'>Roach, A., &ldquo;Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a> describes
      subscription and notification conventions for the Session Initiation
      Protocol (SIP) <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. The Extensible Markup
      Language (XML) <a class='info' href='#W3C.REC-xml-20060816'>[W3C.REC&#8209;xml&#8209;20060816]<span> (</span><span class='info'>Bray, T., Paoli, J., Yergeau, F., Maler, E., and C. Sperberg-McQueen, &ldquo;Extensible Markup Language (XML) 1.0 (Fourth Edition),&rdquo; August&nbsp;2006.</span><span>)</span></a> Configuration
      Access Protocol (XCAP) <a class='info' href='#RFC4825'>[RFC4825]<span> (</span><span class='info'>Rosenberg, J., &ldquo;The Extensible Markup Language (XML) Configuration Access Protocol (XCAP),&rdquo; May&nbsp;2007.</span><span>)</span></a> allows a client to
      read, write and modify XML-formatted application usage data stored on an
      XCAP server.
</p>
<p>While XCAP allows authorized users or devices to modify the same XML
      document, XCAP does not provide an effective mechanism (beyond polling)
      to keep resources synchronized between a server and a client. This memo
      defines an "xcap-diff" event package that, together with the SIP event
      notification framework <a class='info' href='#RFC3265'>[RFC3265]<span> (</span><span class='info'>Roach, A., &ldquo;Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a> and the XCAP diff
      format <a class='info' href='#I-D.ietf-simple-xcap-diff'>[I&#8209;D.ietf&#8209;simple&#8209;xcap&#8209;diff]<span> (</span><span class='info'>Rosenberg, J. and J. Urpalainen, &ldquo;An Extensible Markup Language (XML) Document Format for Indicating A Change in XML Configuration Access Protocol (XCAP) Resources,&rdquo; February&nbsp;2010.</span><span>)</span></a>, allows a user
      to subscribe to changes in an XML document, and to receive notifications
      whenever the XML document changes.
</p>
<p>There are three basic features that this event package enables:
</p>
<p>First, a client can subscribe to a list of XCAP documents' URLs in a
      collection located on an XCAP server. This allows a subscriber to
      compare server resources with its local resources using the URLs and the
      strong entity tag (ETag) values of XCAP documents, which are shown in
      the XCAP Diff format, and to synchronize them.
</p>
<p>Second, this event package can signal a change in those resources in
      one of three ways. The first mode only indicates the event type and does
      not include document contents, so the subscriber uses HTTP <a class='info' href='#RFC2616'>[RFC2616]<span> (</span><span class='info'>Fielding, R., Gettys, J., Mogul, J., Frystyk, H., Masinter, L., Leach, P., and T. Berners-Lee, &ldquo;Hypertext Transfer Protocol -- HTTP/1.1,&rdquo; June&nbsp;1999.</span><span>)</span></a> to retrieve the updated document. The
      second mode includes document content or changes in notification
      messages, using the XML-Patch-Ops <a class='info' href='#RFC5261'>[RFC5261]<span> (</span><span class='info'>Urpalainen, J., &ldquo;An Extensible Markup Language (XML) Patch Operations Framework Utilizing XML Path Language (XPath) Selectors,&rdquo; September&nbsp;2008.</span><span>)</span></a>
      format with minimal notification size. The third mode also includes
      document content or changes in notification messages, but is more
      verbose, and shows the full HTTP version-history.
</p>
<p>Third, the client can subscribe to changes in specific XML element or
      attribute contents (XCAP components) and receive element or attribute
      contents in the resulting XCAP Diff format notification messages. If the
      requested component does not exist but is later created, the notifier
      sends a notification with the component's content. The notifier also
      sends notifications when the subscribed XCAP components are removed, for
      example after a successful HTTP DELETE request.
</p>
<a name="Terminology"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in RFC 2119, BCP 14 <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> and indicate requirement levels for compliant
      implementations.
</p>
<a name="Definitions"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Definitions</h3>

<p>The following terms are used in this document:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>XCAP Component:</dt>
<dd>An XML element or an attribute, which
          can be updated, removed, or retrieved with XCAP.
</dd>
<dt>Aggregating:</dt>
<dd>An XCAP client can update only a single
          XCAP Component at a time using HTTP. However, a notifier may be able
          to aggregate a series of these modifications into a single
          notification using XML-Patch- Ops semantics encoded in the XCAP-Diff
          format.
</dd>
</dl></blockquote>

<p>This document reuses terminology mostly defined in XCAP <a class='info' href='#RFC4825'>[RFC4825]<span> (</span><span class='info'>Rosenberg, J., &ldquo;The Extensible Markup Language (XML) Configuration Access Protocol (XCAP),&rdquo; May&nbsp;2007.</span><span>)</span></a> and some in WebDAV <a class='info' href='#RFC4918'>[RFC4918]<span> (</span><span class='info'>Dusseault, L., &ldquo;HTTP Extensions for Web Distributed Authoring and Versioning (WebDAV),&rdquo; June&nbsp;2007.</span><span>)</span></a>.
</p>
<a name="Package"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
XCAP-Diff Event Package</h3>

<a name="Requirements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Overview of Operation With Basic Requirements</h3>

<p>To receive "xcap-diff" event package features, the subscriber
        indicates its interest in certain resources by including a URI list in
        the subscription body to the notifier. Each URL in this list MUST be a
        HTTP URL that identifies a collection, an XCAP document, or an XCAP
        component. Collection URLs MUST have a trailing forward slash "/",
        following the conventions of WebDAV <a class='info' href='#RFC4918'>[RFC4918]<span> (</span><span class='info'>Dusseault, L., &ldquo;HTTP Extensions for Web Distributed Authoring and Versioning (WebDAV),&rdquo; June&nbsp;2007.</span><span>)</span></a>. 
		A collection selection includes all documents in that
        collection and recursively all documents in sub-collections. The URL
        of an XCAP component consists of the document URL with the XCAP Node
        Selector added. Although the XCAP Node Selector allows requesting all
        in-scope namespaces of an element, the client MUST NOT subscribe to
        namespaces.
</p>
<p>The notifier MUST support XCAP component subscriptions. The
        notifier sends the first notification in response to the subscription,
        and this first notification MUST contain the URLs of the documents and
        XCAP components that are part of the subscription. The first
        notification SHOULD contain the contents of subscribed XCAP documents
        and components. The subsequent notifications MAY contain patches to
        these documents. The subscriber can specify how the notifier will
        signal the changes of documents by using the 'diff-processing' event
        package parameter, covered in the section <a class='info' href='#diff-processing-parameter'>Section&nbsp;4.3<span> (</span><span class='info'>'diff-processing' Event Package Parameter</span><span>)</span></a>
</p>
<a name="event-name"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Event Package Name</h3>

<p>The name of this event package is "xcap-diff". As specified in
        <a class='info' href='#RFC3265'>[RFC3265]<span> (</span><span class='info'>Roach, A., &ldquo;Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a>, this value appears in the
        Event header field present in SUBSCRIBE and NOTIFY requests.
</p>
<a name="diff-processing-parameter"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
'diff-processing' Event Package Parameter</h3>

<p>With the aid of the optional "diff-processing" Event header field
        parameter, the subscriber indicates a preference as to how the
        notifier SHOULD indicate change notifications of documents. The
        possible values are "no-patching", "xcap-patching", and "aggregate".
        All three modes provide information that allows the subscriber to
        synchronize its local cache, but only the "xcap-patching" mode
        provides intermediate states of the version history. The notifier
        SHOULD use the indicated mode if it understands it (as such optimizes
        network traffic within the capabilities of the receiver), but MAY use
        "xcap-patching" as a matter of local policy, as all subscribers are
        required to support that mode.</p>
<blockquote class="text"><dl>
<dt></dt>
<dd>The "no-patching" value means that the notifier indicates only
            the document and the event type (creation, modification, and
            removal) in the notification. The notification does not
            necessarily indicate the full HTTP ETag change history.
            Subscribers and notifiers MUST support the "no-patching" mode as a
            base-line for interoperability. The other, more complex modes are
            optional. 
</dd>
<dt></dt>
<dd>The "xcap-patching" value means that the notifier includes all
            updated XCAP component contents and entity tag (ETag) changes. The
            client receives the full (HTTP) ETag change history of a document.
            This is equivalent to sending individual notifications for each
            change.
</dd>
<dt></dt>
<dd>The "aggregate" value means that the notifier MAY aggregate
            several individual XCAP component updates into a single XCAP Diff
            &lt;document&gt; element. The policy for determining whether or
            not to apply aggregation or to determine how many updates to
            aggregate is locally determined. The notifier SHOULD support the
            "aggregate" mode and implement XML-Patch-Ops ( <a class='info' href='#RFC5261'>[RFC5261]<span> (</span><span class='info'>Urpalainen, J., &ldquo;An Extensible Markup Language (XML) Patch Operations Framework Utilizing XML Path Language (XPath) Selectors,&rdquo; September&nbsp;2008.</span><span>)</span></a>) diff-generation, because this
            can greatly reduce the number of notification operations
            required.
</dd>
</dl></blockquote><p> If the subscription does not contain the "diff-processing"
        header field parameter, the notifier SHOULD default to the
        "no-patching" mode, as this is the only mode for which implementation
        is required in both subscribers and notifiers.
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>Note: To see the difference between "xcap-patching" and
            "aggregate" modes, consider a document that has versions "a", "b"
            and "c" with corresponding ETag values "1", "2" and "3". The
            "xcap-patching" mode will include first the change from version
            "a" to "b" with the versions' corresponding "1" and "2" ETags and
            then the change from version "b" to "c" with their "2" and "3"
            ETags. The "aggregate" mode optimizes the change and indicates
            only a single aggregated change from "a" to "c" with the old "1"
            and new "3" ETags. If these changes are closely related, that is,
            the same element has been updated many times, the bandwidth
            savings are larger.
</dd>
</dl></blockquote>

<p>This "diff-processing" parameter is a subscriber hint to the
        notifier. The notifier may respond using a simpler mode, but not a
        more complex one. Notifier selection of a mode is covered in <a class='info' href='#notgen'>Section&nbsp;4.7<span> (</span><span class='info'>Notifier Generation of NOTIFY Requests</span><span>)</span></a>. During re-subscriptions, the subscriber MAY
        change the diff-processing parameter.
</p>
<p>The formal grammar <a class='info' href='#RFC5234'>[RFC5234]<span> (</span><span class='info'>Crocker, D. and P. Overell, &ldquo;Augmented BNF for Syntax Specifications: ABNF,&rdquo; January&nbsp;2008.</span><span>)</span></a> of the
        "diff-processing" parameter:
</p>
<p></p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
     diff-processing = "diff-processing" EQUAL (
       "no-patching" /
       "xcap-patching" /
       "aggregate" /
       token )
</pre></div><p>
 where EQUAL and token are defined in RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
</p>
<a name="subbody"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
SUBSCRIBE Bodies</h3>

<p>The URI list is described by the XCAP resource list format
        <a class='info' href='#RFC4826'>[RFC4826]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Extensible Markup Language (XML) Formats for Representing Resource Lists,&rdquo; May&nbsp;2007.</span><span>)</span></a>, and is included
        as a body of the initial SUBSCRIBE request. Only a simple subset of
        that format is required, a flat list of XCAP R-URIs. The "uri"
        attribute of the &lt;entry&gt; element contains these URI values. The
        subscriber MUST NOT use hierarchical lists or &lt;entry-ref&gt;
        references, etc., (though in the future, semantics may be expanded
        thanks to the functionality in the resource list format). In
        subsequent SUBSCRIBE requests, such as those used for refreshing the
        expiration timer, the subscribed URI list MAY change, in which case
        the notifier MUST use the new list.
</p>
<p>The SUBSCRIBE request MAY contain an Accept header field. If no
        such header field is present, it has a default value of
        "application/xcap-diff+xml". If the header field is present, it MUST
        include "application/xcap-diff+xml", and MAY include any other
        types.
</p>
<p>The SUBSCRIBE request MAY contain the Suppress-If-Match header
        field <a class='info' href='#I-D.ietf-sipcore-subnot-etags'>[I&#8209;D.ietf&#8209;sipcore&#8209;subnot&#8209;etags]<span> (</span><span class='info'>Niemi, A. and D. Willis, &ldquo;An Extension to Session Initiation Protocol (SIP) Events for Conditional Event Notification,&rdquo; January&nbsp;2010.</span><span>)</span></a>, which directs
        the notifier to suppress either the body of a subsequent notification,
        or the entire notification if the ETag value matches.
</p>
<p>If the SUBSCRIBE body contains elements or attributes that the
        notifier doesn't understand, the notifier MUST ignore them.
</p>
<p>Subscribers need to appropriately populate the Request-URI of the
        SUBSCRIBE request, typically set to the URI of the notifier. This
        document does not constrain that URI. It is assumed that the
        subscriber is provisioned with or has learned the URI of the notifier
        of this event package.
</p>
<p>The XCAP server will usually be co-located with the SIP notifier,
        so the subscriber MAY use relative XCAP Request-URIs. Because relative
        Request-URIs are allowed, the notifier MUST know how to resolve these
        against the correct XCAP Root URI value.
</p><br /><hr class="insert" />
<a name="Figure"></a>

<p><a class='info' href='#Figure'>Figure&nbsp;1<span> (</span><span class='info'>Example subscription body</span><span>)</span></a> shows a SUBSCRIBE request
          and body covering several XCAP resources: a "resource-list"
          document, a specific element in a "rls-services" document, and a
          collection in "pidf-manipulation" application usage. The
          "Content-Type" header of this SUBSCRIBE request is
          "application/resource-lists+xml".
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

SUBSCRIBE sip:tests@xcap.example.com SIP/2.0
...
Accept: application/xcap-diff+xml
Event: xcap-diff; diff-processing=aggregate
Content-Type: application/resource-lists+xml
Content-Length: [XXX]
Expires: 4200

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;resource-lists xmlns="urn:ietf:params:xml:ns:resource-lists"&gt;
    &lt;list&gt;
      &lt;entry uri="resource-lists/users/sip:joe@example.com/index"/&gt;
      &lt;entry uri="rls-services/users/sip:joe@example.com/index/
         ~~/*/service%5b@uri='sip:marketing@example.com'%5d"/&gt;
      &lt;entry uri="pidf-manipulation/"/&gt;
    &lt;/list&gt;
  &lt;/resource-lists&gt;

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Example subscription body&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="duration"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Subscription Duration</h3>

<p>The default expiration time for subscriptions within this package
        is 3600 seconds. As per RFC 3265 <a class='info' href='#RFC3265'>[RFC3265]<span> (</span><span class='info'>Roach, A., &ldquo;Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a>, the
        subscriber MAY specify an alternative expiration timer in the Expires
        header field.
</p>
<a name="notbody"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
NOTIFY Bodies</h3>

<p>The format of the NOTIFY message body is either the default of
        "application/xcap-diff+xml" or is a format listed in the Accept header
        field of the SUBSCRIBE.
</p>
<p>In this event package, notification messages contain an XCAP Diff
        document .
</p>
<p>The XCAP Diff format <a class='info' href='#I-D.ietf-simple-xcap-diff'>[I&#8209;D.ietf&#8209;simple&#8209;xcap&#8209;diff]<span> (</span><span class='info'>Rosenberg, J. and J. Urpalainen, &ldquo;An Extensible Markup Language (XML) Document Format for Indicating A Change in XML Configuration Access Protocol (XCAP) Resources,&rdquo; February&nbsp;2010.</span><span>)</span></a> can include the full
        element and attribute content of XCAP documents and components. For
        documents, the format can also include corresponding URIs, ETag
        values, and patching instructions from version "a" to "b". Removal
        events (of documents, elements, or attributes) can be identified too.
        Except for collection selections, the "sel" selector values of the
        XCAP-Diff format MUST be octet-by-octet equivalent to the relevant
        "uri" parameter values of the &lt;entry&gt; element of the
        "resource-list" document.
</p>
<a name="notgen"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7"></a><h3>4.7.&nbsp;
Notifier Generation of NOTIFY Requests</h3>

<p>During the initial subscription, or if the URI list changes in
        SUBSCRIBE refresh requests, the notifier MUST resolve the requested
        XCAP resources and their privileges. If there are superfluous resource
        selections in the requested URI list, the notifier SHOULD NOT provide
        overlapping similar responses for these resources. A resource for
        which an authenticated user does not have a read privilege MUST NOT be
        included in the XCAP-Diff format. Note that an XCAP component that
        could not be located with XCAP semantics does not produce an error.
        Instead, the request remains in a "pending" state, that is, waiting
        for this resource to be created (or read access granted).
        Subscriptions to collections have a similar property: once a new
        document is created into the subscribed collection, the creation of a
        new resource is signaled with the next NOTIFY request.
</p>
<p>After the notifier knows the list of authorized XCAP resources, it
        generates the first NOTIFY, which contains URI references to all
        subscribed, existing documents for which the subscriber has read
        privileges, and typically XCAP component(s) of existing content.
</p>
<p>After sending the initial notification, the notifier selects a
        diff-processing mode for reporting changes. If the subscriber
        suggested a mode in the "diff-processing" parameter of the SUBSCRIBE,
        the notifier MAY use that requested mode or MAY fall back to a simpler
        operational mode, but the notifier MUST NOT use a more complex mode
        than the one chosen by the subscriber. From least to most complex, the
        order of the modes is the following: "no-patching", "xcap-patching",
        "aggregate". Thus, the notifier may respond to an "aggregate" request
        using any mode, but cannot reply to an "xcap-patching" subscription
        using the "aggregate" mode. Naturally, the notifier MUST handle a
        "no-patching" request with the "no-patching" mode.
</p>
<p>In all modes, the notifier MUST maintain the chronological order of
        XCAP changes. If several changes to a given resource are presented in
        a single notification, the chronological update order MUST be
        preserved in the XML document order of the notification body.
        Preservation of chronological order is required to produce a correct
        document in the subscriber. If content modifications are made
        out-of-order, an erroneous document would probably be formed.
</p>
<p>While the "aggregate" mode uses bandwidth most efficiently, it
        introduces other challenges. The initial synchronization might fail
        with rapidly changing resources, because the "aggregate" mode messages
        might not include the full version-history of a document and the base
        XCAP protocol does not support version-history retrievals of
        documents. When new documents are created in subscribed collections
        and the notifier is aggregating patches, the same issue can occur. In
        a corner case, the notifier may not be able to provide patches with
        the XML-Patch-Ops <a class='info' href='#RFC5261'>[RFC5261]<span> (</span><span class='info'>Urpalainen, J., &ldquo;An Extensible Markup Language (XML) Patch Operations Framework Utilizing XML Path Language (XPath) Selectors,&rdquo; September&nbsp;2008.</span><span>)</span></a> semantics.
        Therefore, if the notifier has to temporarily disable diff generation
        and send only the URI references of some changed documents to the
        subscriber, it MUST continue with the "xcap-patching" mode afterwards
        for these resources, if the initial subscription also started with the
        "xcap-patching" mode. In other words, if the subscriber loses track of the 
		patching operations, the subscriber must refresh to a "known good" state by
        downloading the current document. Once it has done so, it can resume using 
		xcap-patching. 
</p>
<p>In the "aggregate" mode, the notifier chooses how long to wait for
        multiple patches to combine. Even with rapidly changing resources the
        notifier MUST signal only the latest state: e.g. whether the XCAP
        component exists or not.
</p>
<p>In the "xcap-patching" mode, the notifier MAY disable the
        diff-generation temporarily for certain resources, for example when
        the NOTIFY body becomes impractically large or an intermediate error
        has happened. Some XCAP clients will probably not have completely
        optimized their patchrequest, so even when acting in the
        "xcap-patching" operational mode, the notifier MAY try to optimize the
        diff-generation, for example by eliminating redundant patch
        operations. Otherwise said: the notifier is not required to send patch
        operations exactly as received by clients; rather it MAY notify with a
        more efficient patch operation that MUST produce the same result as
        the series of patch operations producd by the XCAP client.
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>Note: It is straightforward to change the XCAP client's change
            requests (sent via HTTP) to use XML-Patch-Ops semantics. While
            XCAP does not support patching of all XML node types - for
            example, namespace declarations can not be added separately -
            utilization of XML-Patch-Ops can sometimes significantly reduce
            the bandwidth requirements at the expense of extra processing.
            Extension of XCAP for this utilization of patch-ops is outside the
            scope of this document, but it is evident that XCAP clients that
            produce efficient change requests using XML-Patch-Ops make it much
            easier for the notifier to produce an efficient change
            notification using XML-Patch-Ops.
</dd>
</dl></blockquote>

<p>After the notifier has reported the existence of an XCAP component,
        it MUST also report its removal consistently. For example, the removal
        of the parent element of the subscribed element requires the same
        signalling since the subscribed element ceases to exist. To signal the
        removal of an XCAP component, the notifier sets the Boolean "exist"
        attribute value of the &lt;element&gt; or &lt;attribute&gt; elements
        to false.
</p>
<p>When the notifier receives a re-subscription, it MUST re-send the
        current full XML-Diff content unless the subscriber has requested a
        conditional subscription <a class='info' href='#I-D.ietf-sipcore-subnot-etags'>[I&#8209;D.ietf&#8209;sipcore&#8209;subnot&#8209;etags]<span> (</span><span class='info'>Niemi, A. and D. Willis, &ldquo;An Extension to Session Initiation Protocol (SIP) Events for Conditional Event Notification,&rdquo; January&nbsp;2010.</span><span>)</span></a> by using the header field
        Suppress-If-Match: [ETag value]. With a conditional re-subscription,
        the notifier MUST also inspect the subscription body when determining
        the current subscription state. Since the subscription is based on a
        list of XCAP R-URIs, it is RECOMMENDED that the notifier does not
        consider the order of these URIs when determining the equivalence to
        "stored" previous states. If a match to the previous state is not
        found, the NOTIFY message MUST contain the full XML-Diff state
        (similar to the initial notification). The notifiers SHOULD implement
        the conditional subscription handling with this event package.
</p>
<p>During re-subscriptions, the subscriber may change the value of the
        diff-processing parameter. The value change influences only subsequent
        notifications, not the notification (if generated) followed
        immediately after the (re-)SUBSCRIBE request.
</p>
<p>Event packages like this require reliable transfer of NOTIFY
        messages. This means that all messages MUST successfully be
        transferred or the document will become out of synch, and then patches
        will most likely fail (or worse, have unintended consequences). This
        "xcap-diff" event package requires, similar to Partial-PIDF-Notify RFC
        5263 <a class='info' href='#RFC5263'>[RFC5263]<span> (</span><span class='info'>Lonnfors, M., Costa-Requena, J., Leppanen, E., and H. Khartabil, &ldquo;Session Initiation Protocol (SIP) Extension for Partial Notification of Presence Information,&rdquo; September&nbsp;2008.</span><span>)</span></a>, that a notifier MUST NOT send a
        new NOTIFY request to the same dialog unless a successful 200-response
        has been received for the last sent NOTIFY request. If the NOTIFY
        request fails due to a timeout, the notifier MUST remove the
        subscription.
</p>
<p></p>
<blockquote class="text"><dl>
<dt></dt>
<dd>Note: This requirement ensures that out-of-order events will
            not happen or that the dialog will terminate after non-resolvable
            NOTIFY request failures. In addition, some of the probable NOTIFY
            error responses (for example, 401, 407, 413) can possibly be
            handled gracefully without tearing down the dialog.
</dd>
</dl></blockquote>

<p>If, for example, the subscriber has selected too many elements to
        which to subscribe, such that the notification body would be
        impractically large (that is, an intermediate NOTIFY failure), the
        notifier MAY discard the &lt;element&gt; element content. The
        existence of elements is then indicated with an empty &lt;element&gt;
        element, and the content is not shown for those resources. In other
        words, the &lt;element&gt; element does not not have a child element
        which would show the subscribed "full" element content. 
</p>
<a name="subproc"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.8"></a><h3>4.8.&nbsp;
Subscriber Processing of NOTIFY Requests</h3>

<p>The first NOTIFY request will usually contain references to HTTP
        resources including their strong ETag values. If the subscriber does
        not have similar locally cached versions, it will typically start an
        unconditional HTTP GET request for those resources. During this HTTP
        retrieval time, the subscriber MAY also receive patches to these
        documents (if it has requested them) if the documents are changing. A
        subscriber can chain the modification list for the document and
        aggregate the changes itself if the notifications contain patches and
        indicate all atomic XCAP modifications with both previous and new
        ETags of each resource ("xcap-patching" mode). If the version received
        via HTTP is newer than any received via the notifications, the
        subscriber may not find an equivalent match of an ETag value from the
        chain of patches. This can happen since notifications are reported
        after HTTP changes and preferably at some minimum intervals. In such a
        case, the subscriber SHOULD either wait for subsequent notifications
        or refresh the subscription and repeat the described "sync" algorithm
        until a match is achieved.
</p>
<p>To avoid out-of-sync issues, the subscriber MAY start the
        subscription with the "xcap-patching" mode, and then refresh the
        subscription with the "aggregate" mode. Syncs are successful if the
        received HTTP ETag matches with either the previous or new ETag of the
        reported aggregated patch. If the subscription is started with the
        "aggregate" mode, which doesn't necessarily show the full
        version-history information, the subscriber may not be able to
        synchronize its local cache with the first notification. The
        subscriber MAY resolve this issue by doing one of the following:
        re-fetching the out-of-sync document, waiting for subsequent
        notifications, or by refreshing the subscription. However, the same
        issue may still repeat.
</p>
<p>If the subscriber has received a "full" sync and it has detected
        that some of the resources are being served with the "xcap-patching"
        mode while others are in the "aggregate" mode, it SHOULD refresh the
        subscription to the "aggregate" mode.
</p>
<p>The notifier MAY at any time temporarily use the "no-patching" mode
        for some resources so that the subscriber receives only URI references
        of modifications. When the notifier is acting in this mode, several
        cycles MAY be needed before an initial "full" sync is achieved. As the
        notifier MAY change modes in the middle of a dialog, the subscriber is
        always responsible for taking appropriate actions. Also, as the last
        resort, the subscriber MAY always disable the usage of diff-processing
        by setting the "diff-processing" parameter to "no-patching".
</p>
<p>If a diff format cannot be applied due to patch processing and/or
        programming errors (for a list, see Section 5.1 of <a class='info' href='#RFC5261'>[RFC5261]<span> (</span><span class='info'>Urpalainen, J., &ldquo;An Extensible Markup Language (XML) Patch Operations Framework Utilizing XML Path Language (XPath) Selectors,&rdquo; September&nbsp;2008.</span><span>)</span></a>), the subscriber SHOULD refresh the
        subscription and disable patching by setting the "diff-processing"
        parameter to "no-patching". The subscriber SHOULD NOT reply with a
        non-200 response since the notifier cannot make corrections.
</p>
<p>During unconditional re-subscriptions, the subscriber MUST stamp
        the received state of all previous resources as stale. However, if a
        conditional <a class='info' href='#I-D.ietf-sipcore-subnot-etags'>[I&#8209;D.ietf&#8209;sipcore&#8209;subnot&#8209;etags]<span> (</span><span class='info'>Niemi, A. and D. Willis, &ldquo;An Extension to Session Initiation Protocol (SIP) Events for Conditional Event Notification,&rdquo; January&nbsp;2010.</span><span>)</span></a>
        re-subscription is successful, the subscriber MUST preserve the
        current state of resources unless the subscribed URI list has changed.
        That is, the subscriber MUST fetch the resource's state, for example,
        from some local cache.
</p>
<a name="fork"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.9"></a><h3>4.9.&nbsp;
Handling of Forked Requests</h3>

<p>This specification allows only a single dialog to be constructed
        from an initial SUBSCRIBE request. If the subscriber receives forked
        responses to a SUBSCRIBE, the subscriber MUST apply the procedures in
        Section 4.4.9 of RFC 3265 <a class='info' href='#RFC3265'>[RFC3265]<span> (</span><span class='info'>Roach, A., &ldquo;Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a> for handling
        non-allowed forked requests.
</p>
<a name="notrate"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.10"></a><h3>4.10.&nbsp;
Rate of Notifications</h3>

<p>Notifiers of "xcap-diff" event package SHOULD NOT generate
        notifications for a single subscription at a rate of more than once
        every five seconds.
</p>
<a name="agents"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.11"></a><h3>4.11.&nbsp;
State Agents</h3>

<p>State agents play no role in this package.
</p>
<a name="Example"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
An Initial Example NOTIFY document</h3>

<p><a class='info' href='#Figureb'>Figure&nbsp;2<span> (</span><span class='info'>An example initial XCAP Diff format document</span><span>)</span></a> shows an example initial XCAP Diff
      format document provided by the first NOTIFY request to the SUBSCRIBE
      example in <a class='info' href='#Figure'>Figure&nbsp;1<span> (</span><span class='info'>Example subscription body</span><span>)</span></a>. The following is an example
      Event header field for this SUBSCRIBE request:
</p>
<p>Event: xcap-diff; diff-processing=aggregate
</p>
<p>The subscriber requests that the notifier "aggregate" XCAP component
      updates and anticipates that the subsequent notifications will contain
      aggregated patches to these documents.
</p>
<p><br />
 <br /><hr class="insert" />
<a name="Figureb"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

  &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;xcap-diff xmlns="urn:ietf:params:xml:ns:xcap-diff"
      xcap-root="http://xcap.example.com/root/"&gt;
      &lt;document new-etag="7ahggs"
        sel="resource-lists/users/sip:joe@example.com/index"/&gt;
      &lt;document new-etag="30376adf"
        sel="pidf-manipulation/users/sip:joe@example.com/index"/&gt;
      &lt;d:element sel="rls-services/users/sip:joe@example.com/index/
        ~~/*/service%5b@uri='sip:marketing@example.com'%5d"
        xmlns:d="urn:ietf:params:xml:ns:xcap-diff"
        xmlns="urn:ietf:params:xml:ns:rls-services"
        xmlns:rl="urn:ietf:params:xml:ns:resource-lists"&gt;
        &lt;service uri="sip:marketing@example.com"&gt;
          &lt;list name="marketing"&gt;
            &lt;rl:entry uri="sip:joe@example.com"/&gt;
            &lt;rl:entry uri="sip:sudhir@example.com"/&gt;
          &lt;/list&gt;
          &lt;packages&gt;
            &lt;package&gt;presence&lt;/package&gt;
          &lt;/packages&gt;
        &lt;/service&gt;
      &lt;/d:element&gt;
    &lt;/xcap-diff&gt;

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: An example initial XCAP Diff format document&nbsp;</b></font><br /></td></tr></table><hr class="insert" />
 Note that the resource-list "index" document included only
      the new ETag value, as the document existed during the subscription
      time. In the "pidf-manipulation" collection, there is only a single
      document for which the user has read privilege. The &lt;services&gt;
      element exists within the rls-services "index" document and its content
      is shown.
</p>
<a name="IANA-Considerations"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
IANA Considerations</h3>

<p>This specification instructs IANA to add a new event package to the
      SIP Event Types Namespace registry. The new data to be added is:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  Package Name    Type            Contact                    Reference
  -------------   --------        -------                    ---------
  xcap-diff       package         IETF SIP Working Group     [RFCXXXX]
  &lt;sip@ietf.org&gt;
</pre></div>
<a name="Security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Security Considerations</h3>

<p>This document defines a new SIP event package for the SIP event
      notification framework specified in RFC 3265 <a class='info' href='#RFC3265'>[RFC3265]<span> (</span><span class='info'>Roach, A., &ldquo;Session Initiation Protocol (SIP)-Specific Event Notification,&rdquo; June&nbsp;2002.</span><span>)</span></a>. As such, all the security considerations of
      RFC 3265 apply. The configuration data can contain sensitive
      information, and both the client and the server need to authenticate
      each other. The notifiers MUST authenticate the "xcap-diff" event
      package subscriber using the normal SIP authentication mechanisms, for
      example Digest as defined in Section 22 of RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>. The notifiers MUST be aware of XCAP User
      identities (XUI) and how to map the authenticated SIP identities
      unambiguously with XUIs.
</p>
<p>Since XCAP <a class='info' href='#RFC4825'>[RFC4825]<span> (</span><span class='info'>Rosenberg, J., &ldquo;The Extensible Markup Language (XML) Configuration Access Protocol (XCAP),&rdquo; May&nbsp;2007.</span><span>)</span></a> provides a basic
      authorization policy for resources and since notifications contain
      content similar to XCAP resources, the security considerations of XCAP
      also apply. The notifiers MUST obey the XCAP authorization rules when
      signalling resource changes. In practice, this means following the read
      privilege rules of XCAP resources.
</p>
<p>Denial-of-Service attacks against notifiers deserve special mention.
      The following can cause denial of service due to intensive processing:
      subscriptions to a long list of URIs, "pending" subscriptions to
      non-existent documents or XCAP components, and diff-generation
      algorithms that try to optimize the required bandwidth usage to
      extremes.
</p>
<p>The mechanism used for conveying xcap-diff event information MUST
      ensure integrity and SHOULD ensure confidentially of the information. An
      end-to-end SIP encryption mechanism, such as S/MIME described in Section
      26.2.4 of RFC 3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>, SHOULD be used. If
      that is not available, it is RECOMMENDED that TLS <a class='info' href='#RFC5246'>[RFC5246]<span> (</span><span class='info'>Dierks, T. and E. Rescorla, &ldquo;The Transport Layer Security (TLS) Protocol Version 1.2,&rdquo; August&nbsp;2008.</span><span>)</span></a> be used between elements to provide hop-by-hop
      authentication and encryption mechanisms described in Section 26.2.2
      "SIPS URI Scheme" and Section 26.3.2.2 "Interdomain Requests" of RFC
      3261 <a class='info' href='#RFC3261'>[RFC3261]<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a>.
</p>
<a name="Acknowledgments"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Acknowledgments</h3>

<p>The author would like to thank Jonathan Rosenberg for his valuable
      comments and providing the initial event package, and Aki Niemi, Pekka
      Pessi, Miguel Garcia, Pavel Dostal, Krisztian Kiss, Anders Lindgren,
      Sofie Lassborn, Keith Drage, Stephen Hinton, Byron Campen, Avshalom
      Houri, Ben Campbell, Paul Kyzivat, Spencer Dawkins, Pasi Eronen and
      Chris Newman for their valuable comments. Lisa Dusseault critiqued 
	  the document during IESG review, raising numerous issues that resulted
	  in improved document quality. Further, technical writer A. Jean Mahoney 
	  devoted countless hours to integrating Lisa's comments and cleaning up 
	  the technical English usage.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-simple-xcap-diff">[I-D.ietf-simple-xcap-diff]</a></td>
<td class="author-text">Rosenberg, J. and J. Urpalainen, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-simple-xcap-diff-14.txt">An Extensible Markup Language (XML) Document Format for Indicating A Change in XML Configuration Access Protocol (XCAP) Resources</a>,&rdquo; draft-ietf-simple-xcap-diff-14 (work in progress), February&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-simple-xcap-diff-14.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.ietf-sipcore-subnot-etags">[I-D.ietf-sipcore-subnot-etags]</a></td>
<td class="author-text">Niemi, A. and D. Willis, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipcore-subnot-etags-04.txt">An Extension to Session Initiation Protocol (SIP) Events for Conditional Event Notification</a>,&rdquo; draft-ietf-sipcore-subnot-etags-04 (work in progress), January&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-sipcore-subnot-etags-04.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2616">[RFC2616]</a></td>
<td class="author-text"><a href="mailto:fielding@ics.uci.edu">Fielding, R.</a>, <a href="mailto:jg@w3.org">Gettys, J.</a>, <a href="mailto:mogul@wrl.dec.com">Mogul, J.</a>, <a href="mailto:frystyk@w3.org">Frystyk, H.</a>, <a href="mailto:masinter@parc.xerox.com">Masinter, L.</a>, <a href="mailto:paulle@microsoft.com">Leach, P.</a>, and <a href="mailto:timbl@w3.org">T. Berners-Lee</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a>,&rdquo; RFC&nbsp;2616, June&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2616.txt">TXT</a>, <a href="http://www.rfc-editor.org/rfc/rfc2616.ps">PS</a>, <a href="http://www.rfc-editor.org/rfc/rfc2616.pdf">PDF</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2616.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2616.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3265">[RFC3265]</a></td>
<td class="author-text">Roach, A., &ldquo;<a href="http://tools.ietf.org/html/rfc3265">Session Initiation Protocol (SIP)-Specific Event Notification</a>,&rdquo; RFC&nbsp;3265, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3265.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4825">[RFC4825]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc4825">The Extensible Markup Language (XML) Configuration Access Protocol (XCAP)</a>,&rdquo; RFC&nbsp;4825, May&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4825.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4826">[RFC4826]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;<a href="http://tools.ietf.org/html/rfc4826">Extensible Markup Language (XML) Formats for Representing Resource Lists</a>,&rdquo; RFC&nbsp;4826, May&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4826.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5234">[RFC5234]</a></td>
<td class="author-text">Crocker, D. and P. Overell, &ldquo;<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>,&rdquo; STD&nbsp;68, RFC&nbsp;5234, January&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5234.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5246">[RFC5246]</a></td>
<td class="author-text">Dierks, T. and E. Rescorla, &ldquo;<a href="http://tools.ietf.org/html/rfc5246">The Transport Layer Security (TLS) Protocol Version 1.2</a>,&rdquo; RFC&nbsp;5246, August&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5246.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5261">[RFC5261]</a></td>
<td class="author-text">Urpalainen, J., &ldquo;<a href="http://tools.ietf.org/html/rfc5261">An Extensible Markup Language (XML) Patch Operations Framework Utilizing XML Path Language (XPath) Selectors</a>,&rdquo; RFC&nbsp;5261, September&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5261.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC4918">[RFC4918]</a></td>
<td class="author-text">Dusseault, L., &ldquo;<a href="http://tools.ietf.org/html/rfc4918">HTTP Extensions for Web Distributed Authoring and Versioning (WebDAV)</a>,&rdquo; RFC&nbsp;4918, June&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4918.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5263">[RFC5263]</a></td>
<td class="author-text">Lonnfors, M., Costa-Requena, J., Leppanen, E., and H. Khartabil, &ldquo;<a href="http://tools.ietf.org/html/rfc5263">Session Initiation Protocol (SIP) Extension for Partial Notification of Presence Information</a>,&rdquo; RFC&nbsp;5263, September&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5263.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="W3C.REC-xml-20060816">[W3C.REC-xml-20060816]</a></td>
<td class="author-text">Bray, T., Paoli, J., Yergeau, F., Maler, E., and C. Sperberg-McQueen, &ldquo;<a href="http://www.w3.org/TR/2006/REC-xml-20060816">Extensible Markup Language (XML) 1.0 (Fourth Edition)</a>,&rdquo; World Wide Web Consortium FirstEdition&nbsp;REC-xml-20060816, August&nbsp;2006 (<a href="http://www.w3.org/TR/2006/REC-xml-20060816">HTML</a>).</td></tr>
</table>

<a name="appendix"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Informative Examples</h3>

<p>These examples illustrate the basic features of the xcap-diff event
      package. Only the relevant header fields are shown. Note also that the
      SIP R-URIs of these examples don't correspond to reality.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
Initial documents on an XCAP server</h3>

<p>The following documents exist on an XCAP server (xcap.example.com)
        with an imaginary "tests" application usage (there's no default
        document namespace defined in this imaginary application usage).
</p>
<p>http://xcap.example.com/tests/users/sip:joe@example.com/index: 
        </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
	&lt;doc&gt;
			&lt;note&gt;This is a sample document&lt;/note&gt;
	&lt;/doc&gt;

</pre></div><p>

</p>
<p>and then
</p>
<p>http://xcap.example.com/tests/users/sip:john@example.com/index:
         </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
	&lt;doc&gt;
		&lt;note&gt;This is another sample document&lt;/note&gt;
	&lt;/doc&gt;

</pre></div><p>

</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.2"></a><h3>A.2.&nbsp;
An Initial Subscription</h3>

<p>The following demonstrates the listing of a collection contents and
        it shows only resources where the user has read privilege. The user
        Joe, whose XUI is "sip:joe@example.com", sends an initial
        subscription: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

SUBSCRIBE sip:tests@xcap.example.com SIP/2.0
...
Accept: application/xcap-diff+xml
Event: xcap-diff; diff-processing=aggregate
Content-Type: application/resource-lists+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;resource-lists xmlns="urn:ietf:params:xml:ns:resource-lists"&gt;
    &lt;list&gt;
      &lt;entry uri="tests/users/sip:joe@example.com/"/&gt;
    &lt;/list&gt;
  &lt;/resource-lists&gt;

</pre></div><p>

</p>
<p>In addition to the 200 (OK) response, the notifier sends the first
        NOTIFY: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
	&lt;xcap-diff xmlns="urn:ietf:params:xml:ns:xcap-diff"
		xcap-root="http://xcap.example.com/"&gt;
	&lt;document new-etag="7ahggs"
		sel="tests/users/sip:joe@example.com/index"/&gt;
	&lt;/xcap-diff&gt;

</pre></div><p>
 The subscriber learns that the document on this "tests"
        application usage is equivalent to its locally cached version, so it
        does not act. If the local version had been different, the subscriber
        would most likely re-fetch the document.
</p>
<p>If the subscriber had requested the "tests/users/" collection, the
        notification body would have been the same since Joe has no read
        privilege to John's resources (XCAP default behavior).
</p>
<p>If the Expires header field had a value "0", the request would be
        similar to the PROPFIND method of WebDAV. The syntax and responses
        differ, however.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.3"></a><h3>A.3.&nbsp;
A Document Addition Into a Collection</h3>

<p>Let's say that Joe adds a new document to his collection, using
        either the same client or another client running on a different
        device. He does an HTTP PUT to his application usage collection:
        </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

PUT /tests/users/sip:joe@example.com/another_document HTTP/1.1
Host: xcap.example.com
....
Content-Type: application/xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
	&lt;doc&gt;
		&lt;note&gt;This is another sample document&lt;/note&gt;
	&lt;/doc&gt;

</pre></div><p>
 This HTTP PUT request results in the XCAP client receiving
        a strong HTTP ETag "terteer" for this new document.
</p>
<p>Then the subscriber receives a notification afterwards:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;xcap-diff xmlns="urn:ietf:params:xml:ns:xcap-diff"
    xcap-root="http://xcap.example.com/"&gt;
    &lt;document new-etag="terteer"
      sel="tests/users/sip:joe@example.com/another_document"/&gt;
  &lt;/xcap-diff&gt;

</pre></div>
<p>Note that the result is "additive"; it doesn't indicate the already
        indicated "index" document. Only the initial (or refreshed)
        notification contains all document URI references.
</p>
<p>If Joe's client both modifies the documents and refreshes the
        subscriptions, it would typically ignore this notification, since its
        modifications had caused the notification. If the client that received
        this NOTIFY hadn't submitted the document change, it would probably
        fetch this new document.
</p>
<p>If Joe's client refreshes the subscription with the same request
        body as in the initial subscription, the result will include these two
        documents: "index" and "another_document" with their ETags.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.4"></a><h3>A.4.&nbsp;
A Series of XCAP Component Modifications</h3>

<p>Now Joe's client uses its XCAP patching capability by doing the
        following: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

PUT /tests/users/sip:joe@example.com/index/~~/doc/foo HTTP/1.1
Host: xcap.example.com
....
Content-Type: application/xcap-el+xml
Content-Length: [XXX]

&lt;foo&gt;this is a new element&lt;/foo&gt;

</pre></div><p>
 Since the insertion of the element is successful, Joe's
        client receives the new HTTP ETag "fgherhryt3" of the updated "index"
        document.
</p>
<p>Immediately thereafter, Joe's client issues another HTTP request
        (this request could even be pipe-lined): </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

PUT /tests/users/sip:joe@example.com/index/~~/doc/bar HTTP/1.1
Host: xcap.example.com
....
Content-Type: application/xcap-el+xml
Content-Length: [XXX]
  &lt;bar&gt;this is a bar element
  &lt;/bar&gt;

</pre></div><p>
 The reported new HTTP ETag of "index" is now
        "dgdgdfgrrr".
</p>
<p>And Joe's client issues yet another HTTP request: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

PUT /tests/users/sip:joe@example.com/index/~~/doc/foobar HTTP/1.1
Host: xcap.example.com
....
Content-Type: application/xcap-el+xml
Content-Length: [XXX]

&lt;foobar&gt;this is a foobar element&lt;/foobar&gt;

</pre></div><p>
 The reported new ETag of "index" is now "63hjjsll".
</p>
<p>After awhile, Joe's client receives a notification with an embedded
        patch since it has requested "aggregate" diff-processing and the
        notifier is capable of producing them: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;d:xcap-diff xmlns:d="urn:ietf:params:xml:ns:xcap-diff"
    xcap-root="http://xcap.example.com/"&gt;
    &lt;d:document previous-etag="7ahggs3"
      sel="tests/users/sip:joe@example.com/index"
	  new-etag="63hjjsll"&gt;
	  &lt;d:add sel="*"&gt;
	    &lt;foo&gt;this is a new element&lt;/foo&gt;
        &lt;bar&gt;this is a bar element
        &lt;/bar&gt;
        &lt;foobar&gt;this is a foobar element&lt;/foobar&gt;
      &lt;/d:add&gt;
    &lt;/d:document&gt;
  &lt;/d:xcap-diff&gt;

</pre></div><p>
 Joe's client applies this patch to the locally cached
        "index" document, detects the ETag update, and stores the last ETag
        value. Note how several XCAP component modifications were
        aggregated.
</p>
<p>Note also that, if Joe's client did not have a locally cached
        version of the reference document, it would have needed to do a HTTP
        GET request after the initial notification. If the ETag of the
        received resource by HTTP did not match either the previous or new
        ETag of this aggregated patch, an out-of-sync condition would be
        probable. This issue is not typical, but it can happen. To resolve the
        issue, the client could re-fetch the "index" document and/or wait for
        subsequent notifications to detect a match. A better and simpler way
        to avoid the issue is to refresh the subscription with the
        "xcap-patching" mode and later refresh with the "aggregate" mode.
</p>
<p>Alternatively, if the notifier's operational mode been
        "xcap-patching", the NOTIFY could have been the following: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

</pre></div><p>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

</pre></div><p>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

</pre></div><p>
 If the client had to re-fetch the "index" document after
        the initial notification, it could have skipped some or all of these
        patches, depending on whether the HTTP ETag matched some of these
        ETags in the chain of patches. If the HTTP ETag did not match and the
        received HTTP version is a newer version indicated in later
        notification(s) then the sync may then be achieved since the notifier
        provided the full change history in the "xcap-patching" mode.
</p>
<p>Lastly, the notifier could (temporarily) fall back to the
        "no-patching" mode, which allows the notifier to keep the dialog alive
        when there are too many updates: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
	&lt;xcap-diff xmlns="urn:ietf:params:xml:ns:xcap-diff"
		xcap-root="http://xcap.example.com/"&gt;
		&lt;document previous-etag="7ahggs3"
			sel="tests/users/sip:joe@example.com/index"
			new-etag="63hjjsll"/&gt;
		&lt;/xcap-diff&gt;

</pre></div><p>
 At any time, the notifier may fall back to the
        "no-patching" mode for some or all of the subscribed documents.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.5"></a><h3>A.5.&nbsp;
An XCAP Component Subscription</h3>

<p>The user Joe sends an initial subscription for the "id" affribute
        of a &lt;doc&gt; element. The "index" document exists, but the
        &lt;doc&gt; root element does not contain the "id" attribute at the
        time of the subscription. </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

SUBSCRIBE sip:tests@xcap.example.com SIP/2.0
...
Accept: application/xcap-diff+xml
Event: xcap-diff
Content-Type: application/resource-lists+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;resource-lists xmlns="urn:ietf:params:xml:ns:resource-lists"&gt;
    &lt;list&gt;
      &lt;entry uri="tests/users/sip:joe@example.com/index/~~/doc/@id"/&gt;
    &lt;/list&gt;
  &lt;/resource-lists&gt;

</pre></div><p>

</p>
<p>The first NOTIFY looks like the following since there is nothing to
        indicate: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;xcap-diff xmlns="urn:ietf:params:xml:ns:xcap-diff"
    xcap-root="http://xcap.example.com/"/&gt;

</pre></div><p>
 Note that if the "index" document hadn't existed, the
        first NOTIFY request would have been the same. The XCAP Diff document
        format doesn't indicate reasons for non-existing resources.
</p>
<p>Afterwards Joe's client updates the whole document root element
        including the attribute "id" (not a typical XCAP operation nor a
        preferred one, just an illustration here): </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

PUT /tests/users/sip:joe@example.com/index/~~/doc HTTP/1.1
Host: xcap.example.com
....
Content-Type: application/xcap-el+xml
Content-Length: [XXX]

&lt;doc id="bar"&gt;This is a new root element&lt;/doc&gt;

</pre></div><p>
 The new HTTP ETag of the "index" document is now
        "dwawrrtyy".
</p>
<p>Then Joe's client gets a notification: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;xcap-diff xmlns="urn:ietf:params:xml:ns:xcap-diff"
    xcap-root="http://xcap.example.com/"&gt;
    &lt;attribute
      sel="tests/users/sip:joe@example.com/index/~~/doc/@id"&gt;
      bar
    &lt;/attribute&gt;
  &lt;/xcap-diff&gt;

</pre></div><p>
 Note that the HTTP ETag value of the new document is not
        shown as it is irrelevant for this use-case.
</p>
<p>Then Joe's client removes the "id" attribute: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

DELETE /tests/users/sip:joe@example.com/index/~~/doc/@id HTTP/1.1
Host: xcap.example.com
....
Content-Length: 0

</pre></div><p>

</p>
<p>And the subscriber gets a notification: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;xcap-diff xmlns="urn:ietf:params:xml:ns:xcap-diff"
    xcap-root="http://xcap.example.com/"&gt;
    &lt;attribute sel="tests/users/sip:joe@example.com/index/~~/doc/@id"
      exists="0"/&gt;
  &lt;/xcap-diff&gt;

</pre></div><p>
 The notification indicates that the subscribed attribute
        was removed from the document. Naturally attributes are "removed" if
        the element where they belong is removed, for example by an HTTP
        DELETE request. The component selections indicate only the existence
        of attributes or elements.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.6"></a><h3>A.6.&nbsp;
A Conditional Subscription</h3>

<p>The last example is a conditional subscription where a full refresh
        can be avoided when there are no changes in resources. Joe's client
        sends an initial subscription: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

SUBSCRIBE sip:tests@xcap.example.com SIP/2.0
...
Accept: application/xcap-diff+xml
Event: xcap-diff; diff-processing=xcap-patching
Content-Type: application/resource-lists+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;resource-lists xmlns="urn:ietf:params:xml:ns:resource-lists"&gt;
    &lt;list&gt;
      &lt;entry uri="tests/users/sip:joe@example.com/"/&gt;
    &lt;/list&gt;
  &lt;/resource-lists&gt;

</pre></div><p>

</p>
<p>Since there are now two documents in the repository, the first
        NOTIFY looks like the following: </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

NOTIFY sip:joe@userhost.example.com SIP/2.0
...
Event: xcap-diff
SIP-ETag: xggfefe54
Content-Type: application/xcap-diff+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;xcap-diff xmlns="urn:ietf:params:xml:ns:xcap-diff"
    xcap-root="http://xcap.example.com/"&gt;
    &lt;document new-etag="63hjjsll"
      sel="tests/users/sip:joe@example.com/index"/&gt;
    &lt;document new-etag="terteer"
      sel="tests/users/sip:joe@example.com/another_document"/&gt;
  &lt;/xcap-diff&gt;

</pre></div><p>

</p>
<p>Note that the NOTIFY request contains the SIP-ETag "xggfefe54".
        This SIP-ETag is placed in the Suppress-If-Match header field of the
        conditional subscription. The "diff-processing" mode also is changed
        (or is requested to change): </p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

SUBSCRIBE sip:tests@xcap.example.com SIP/2.0
...
Suppress-If-Match: xggfefe54
Accept: application/xcap-diff+xml
Event: xcap-diff; diff-processing=aggregate
Content-Type: application/resource-lists+xml
Content-Length: [XXX]

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;resource-lists xmlns="urn:ietf:params:xml:ns:resource-lists"&gt;
    &lt;list&gt;
      &lt;entry uri="tests/users/sip:joe@example.com/"/&gt;
   &lt;/list&gt;
  &lt;/resource-lists&gt;

</pre></div><p>
 If the notifier finds a match to the previous stored state
        when it evaluates this request, it responds with 204 (No
        Notification). If there are no reportable changes as per <a class='info' href='#I-D.ietf-sipcore-subnot-etags'>[I&#8209;D.ietf&#8209;sipcore&#8209;subnot&#8209;etags]<span> (</span><span class='info'>Niemi, A. and D. Willis, &ldquo;An Extension to Session Initiation Protocol (SIP) Events for Conditional Event Notification,&rdquo; January&nbsp;2010.</span><span>)</span></a>, NOTIFY request generation
        is suppressed. When the notifier can aggregate several modifications,
        this re-subscription enables the processing of that mode thereafter.
        Indeed, the re-subscription may be quite process-intensive, especially
        when there are a large number of relevant reported resources.
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jari Urpalainen</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nokia</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Itamerenkatu 11-13</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Helsinki  00180</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 7180 37686</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jari.urpalainen@nokia.com">jari.urpalainen@nokia.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dean Willis (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Softarmor Systems LLC</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">3100 Independence Pk #311-164</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Plano, TX  75075</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 214 504 19876</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:dean.willis@softarmor.com">dean.willis@softarmor.com</a></td></tr>
</table>
</body></html>
