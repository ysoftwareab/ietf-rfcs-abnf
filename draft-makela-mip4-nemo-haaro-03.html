<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Home Agent assisted Route Optimization between
    Mobile IPv4 Networks</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Home Agent assisted Route Optimization between
    Mobile IPv4 Networks">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">A. Makela</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">J. Korhonen</td></tr>
<tr><td class="header">Intended status: Experimental</td><td class="header">TeliaSonera</td></tr>
<tr><td class="header">Expires: May 4, 2009</td><td class="header">October 31, 2008</td></tr>
</table></td></tr></table>
<h1><br />Home Agent assisted Route Optimization between
    Mobile IPv4 Networks<br />draft-makela-mip4-nemo-haaro-03</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on May 4, 2009.</p>

<h3>Abstract</h3>

<p>This document describes a Home Agent assisted route optimization
      extension to IPv4 Network Mobility Protocol.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#Background">1.</a>&nbsp;
Introduction and motivations<br />
<a href="#anchor1">2.</a>&nbsp;
Terms and definitions<br />
<a href="#MIP4RO">3.</a>&nbsp;
Mobile IPv4 route optimization between mobile networks<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ROUTING">3.1.</a>&nbsp;
Maintaining route optimization information<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#PREFIX_INFO">3.1.1.</a>&nbsp;
Advertising route-optimizable prefixes<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ROCACHE">3.1.2.</a>&nbsp;
Route Optimization cache<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor2">3.1.3.</a>&nbsp;
Correspondent Router Mobility Bindings<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#RRP">3.2.</a>&nbsp;
Return routability procedure<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">3.2.1.</a>&nbsp;
Router keys<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">3.2.2.</a>&nbsp;
Nonces<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">3.3.</a>&nbsp;
Mobile-Correspondent Router operations<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">3.3.1.</a>&nbsp;
Triggering Route Optimization<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">3.3.2.</a>&nbsp;
Mobile Router routing tables<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#INTERMOBILEREG">3.3.3.</a>&nbsp;
Inter-Mobile Router registration<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#TUNNELS">3.3.4.</a>&nbsp;
Inter-Mobile Router tunnels<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">3.3.5.</a>&nbsp;
Constructing route-optimized packets<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">3.3.6.</a>&nbsp;
Handovers and Mobile Routers leaving network<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">3.4.</a>&nbsp;
Convergence and synchronization issues<br />
<a href="#compressionsformats">4.</a>&nbsp;
Data compression schemes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#prefixcomp">4.1.</a>&nbsp;
Prefix compression<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#realmcomp">4.2.</a>&nbsp;
Realm compression<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">4.2.1.</a>&nbsp;
Encoding of compressed realms<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor12">4.2.2.</a>&nbsp;
Searching algorithm<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">4.2.3.</a>&nbsp;
Encoding example<br />
<a href="#MESSAGESANDEXTENSIONS">5.</a>&nbsp;
New Mobile IPv4 messages and extensions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ROPREFIXAD">5.1.</a>&nbsp;
Route optimization prefix advertisement<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#MRROCAP">5.2.</a>&nbsp;
Mobile router Route optimization capability<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#HOTI">5.3.</a>&nbsp;
Home-Test Init message<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#CoTI">5.4.</a>&nbsp;
Care-of-Test Init message<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#HoT">5.5.</a>&nbsp;
Home Test message<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#CoT">5.6.</a>&nbsp;
Care-of test message<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#AUTHENTICATIONEXT">5.7.</a>&nbsp;
Mobile-Correspondent authentication extension<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">5.8.</a>&nbsp;
Care-of address Extension<br />
<a href="#anchor15">6.</a>&nbsp;
Special Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#NATCONSIDERATIONS">6.1.</a>&nbsp;
NATs and stateful firewalls <br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">6.2.</a>&nbsp;
Foreign Agents<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#MULTIHOMEAGENTS">6.3.</a>&nbsp;
Multiple Home Agents<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#MUTUALNESS">6.4.</a>&nbsp;
Mutualness of Route Optimization<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#EXTENSIBILITY">6.5.</a>&nbsp;
Extensibility<br />
<a href="#anchor17">7.</a>&nbsp;
Scalability<br />
<a href="#examplesignals">8.</a>&nbsp;
Example signaling scenarios<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#regreqexample">8.1.</a>&nbsp;
Registration request<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">8.2.</a>&nbsp;
Route optimization with return routability<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">8.3.</a>&nbsp;
Handovers<br />
<a href="#IANA">9.</a>&nbsp;
IANA Considerations<br />
<a href="#Security">10.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#TRUST">10.1.</a>&nbsp;
Trust relationships<br />
<a href="#Acknowledgements">11.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">12.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">12.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">12.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="Background"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction and motivations</h3>

<p>Traditionally, there has been no method for route optimization in
      <a class='info' href='#RFC3344'>Mobile IPv4<span> (</span><span class='info'>Perkins, C., &ldquo;IP Mobility Support for IPv4,&rdquo; August&nbsp;2002.</span><span>)</span></a> [RFC3344] apart from an early attempt
      <a class='info' href='#I-D.ietf-mobileip-optim'>[I&#8209;D.ietf&#8209;mobileip&#8209;optim]<span> (</span><span class='info'>Perkins, C. and D. Johnson, &ldquo;Route Optimization in Mobile IP,&rdquo; September&nbsp;2001.</span><span>)</span></a>. Unlike <a class='info' href='#RFC3775'>Mobile IPv6<span> (</span><span class='info'>Johnson, D., Perkins, C., and J. Arkko, &ldquo;Mobility Support in IPv6,&rdquo; June&nbsp;2004.</span><span>)</span></a> [RFC3775], where route optimization has been
      included from the start, Mobile IPv4 route optimization hasn't been
      addressed in a generalized scope.
</p>
<p>Even though general route optimization may not be of interest in IPv4
      world, there are still specific applications for route optimization in
      Mobile IPv4. This draft proposes method to optimize routes between
      mobile networks behind mobile routers, as defined by <a class='info' href='#RFC5177'>NEMO<span> (</span><span class='info'>Leung, K., Dommety, G., Narayanan, V., and A. Petrescu, &ldquo;Network Mobility (NEMO) Extensions for Mobile IPv4,&rdquo; April&nbsp;2008.</span><span>)</span></a> [RFC5177].
</p>
<p>From service provider perspective a common topology for enterprise
      customer network consists of one to several sites (typically
      headquarters and various branch offices). These sites are typically
      connected via various Layer 2 technologies (ATM or Frame relay PVCs),
      MPLS VPNs or Layer 3 site-to-site VPNs.
</p>
<p>Recently, a trend has emerged where customers prefer to maintain
      connectivity via multiple service providers. Reasons include redundancy,
      reliability and availability issues. These kinds of multi-homing
      scenarios have traditionally been solved by using such technologies as
      multihoming BGP. However, a more lightweight solution is desirable.
</p>
<p>Mobile IP, especially mobile routers, can accommodate for this. The
      customer becomes a client of a virtual service provider, which does not
      take part in the actual access technology. The service provider has a
      backend system and an IP pool that it distributes to customers. The
      drawback of this solution is that it creates a star topology; All Mobile
      IP tunnels end up at the service provider hosted home agent, causing
      heavy load at the backend. Route optimization between mobile networks
      addresses this issue, by taking network load off the home agent and the
      backend.
</p>
<p>An example network is pictured below:
</p><br /><hr class="insert" />

<p>
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
        +----------------------------+
        |  Virtual Operator Backend  |
        +------------+         +-----+
        | Home Agent |         | AAA |
        +------------+---------+-----+
                     |
                   .--.
                 _(.   `)
               _(   ISP `)_
              (   Peering  `)
             ( `  . Point )  )
              `--(_______)--'
        ____ /     |         \
       /           |          \
    .--.         .--.         .--.
  _(    `.     _(    `.     _(    `.
 (  ISP A )   (  ISP B )   (  ISP C )
( `  .  )  ) ( `  .  )  ) ( `  .  )  )
 `--(___.-'   `--(___.-'   `--(___.-'
     |     ______/    \       /
     |    /            \     /
     |   /              \   /
   +----+               +----+
   |MR A|               |MR B|
   +----+               +----+
     |                    |
    .--.                 .--.
  _(    `.             _(    `.
 ( Site A )           ( Site B )
( `  .  )  )         ( `  .  )  )
 `--(___.-'           `--(___.-'
</pre></div>
<p>
</p><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Virtual service provider architecture using NEMOv4&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>In this case, organization network consists of two sites, that are
      connected via 2 ISPs for redundancy reasons. Mobile IP allows fast
      handovers without problematics of multi-homing and BGP peering between
      each individual ISP and the organization. The traffic however takes a
      non-optimal route through the virtual operator backend.
</p>
<p>Route optimization would address this issue, allowing traffic between
      Sites A and B to flow through ISP B's network, or in case of a link
      failure, via the ISP peering point (such as MAE-WEST). The backend will
      not suffer from heavy loads.
</p>
<p>The primary design goal is to limit the load to the backend to
      minimum. Additional design goals include extensibility to a more
      generalized scope, beyond the need of a single, coordinating Home
      Agent.
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terms and definitions</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Home Agent (HA)</dt>
<dd><br />
Mobile IPv4
          Home Agent
</dd>
<dt>Mobile Router (MR)</dt>
<dd><br />
Nemov4
          Mobile Router
</dd>
<dt>Home Address (HoA)</dt>
<dd><br />
Mobile
          Router's home address
</dd>
<dt>Care-of Address (CoA)</dt>
<dd><br />
Mobile
          Router's Care-of Address. Address serving as the current attachment
          point.
</dd>
<dt>Correspondent Router (CR)</dt>
<dd><br />
Nemov4 Mobile Router which is destination for a
          Mobile network-initiated flow.
</dd>
<dt>Mobile Network</dt>
<dd><br />
Network
          managed by a Mobile Router
</dd>
<dt>Route Optimization Cache</dt>
<dd><br />
Data
          structure held by Mobile Routers on Route Optimizable
          destinations.
</dd>
<dt>Route Optimization activation</dt>
<dd><br />
Procedure consisting of Return Routability check,
          registration, setting up tunnels (if necessary) and starting to
          route traffic along the tunnel.
</dd>
<dt>Host Prefix</dt>
<dd><br />
Prefix with the
          mask of /32. eg. 192.0.2.254/32.
</dd>
<dt>Return Routability, RR</dt>
<dd><br />
Procedure to bind a Mobile Router's Home Address to
          a Care-of address on a Correspondent Router
</dd>
<dt>Mobility Binding</dt>
<dd><br />
The
          association of Home Address with a Care-of address, along with the
          lifetime remaining for that association, maintained by Home Agents
          and Correspondent Routers.
</dd>
<dt>Mobility Session</dt>
<dd><br />
Active
          connection to Home Agent and Correspondent Routers, maintained by
          Mobile Routers.
</dd>
</dl></blockquote>

<a name="MIP4RO"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Mobile IPv4 route optimization between mobile networks</h3>

<p>This section describes the changed functionality of Home Agent and
      Mobile Router compared to the base NEMOv4 operation defined in <a class='info' href='#RFC5177'>NEMO-base<span> (</span><span class='info'>Leung, K., Dommety, G., Narayanan, V., and A. Petrescu, &ldquo;Network Mobility (NEMO) Extensions for Mobile IPv4,&rdquo; April&nbsp;2008.</span><span>)</span></a> [RFC5177]. The basic premise is still the same;
      Mobile Routers, when registering, inform the Home Agent of the mobile
      networks they are managing; However, instead of only remaining on the
      Home Agent this information will now be distributed to the Mobile
      Routers as well.
</p>
<p>The Home Agent-assisted route optimization is primarily intended for
      helping to optimize traffic patterns between multiple sites in an single
      organization or administrative domain; However, extranets can also be
      reached with optimized routes, as long as all Mobile Routers connect to
      the same Home Agent. The procedure aim to maintain backwards
      compatibility; With legacy nodes or routers full connectivity is always
      preserved even though optimal routing cannot be guaranteed.
</p>
<p>The schema requires a Mobile Router to be able to receive messages
      from Home Agent and other Mobile Routers unsolicited - that is, without
      first initiating a request. This behavior is similar to the <a class='info' href='#RFC3543'>registration revocation procedure<span> (</span><span class='info'>Glass, S. and M. Chandra, &ldquo;Registration Revocation in Mobile IPv4,&rdquo; August&nbsp;2003.</span><span>)</span></a> [RFC3543]. Many of the
      mechanisms are same - including the fact that advertising route
      optimization support upon registration implies capability to receive
      registration requests and return routability messages from other Mobile
      Routers.
</p>
<p>Compared to IPv6, where Mobile Node &lt;-&gt; Correspondent node
      bindings are maintained via Mobility Routing header and Home Address
      options, Mobile IPv4 always requires the use of tunnels. Therefore,
      inter-mobile-router tunnel establishment has to be conducted.
</p>
<a name="ROUTING"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Maintaining route optimization information</h3>

<p>During registration, a joining Mobile Router MAY request
        information on route-optimizable networks and let the Home Agent allow
        re-distribution of information of its own networks. This is indicated
        with Mobile Router route optimization capability extension, see <a class='info' href='#MRROCAP'>Section&nbsp;5.2<span> (</span><span class='info'>Mobile router Route optimization capability</span><span>)</span></a>.
</p>
<p>Note that the redistribution of networks from the Home Agent
        happens only during the registration phase. There are no "routing
        updates" from Home Agent except in the form of re-registration.
        Besides timeouts, the re-registration may occur if a Correspondent
        Router receives a registration request from a unknown Mobile Router
        (see <a class='info' href='#INTERMOBILEREG'>Section&nbsp;3.3.3<span> (</span><span class='info'>Inter-Mobile Router registration</span><span>)</span></a>).
</p>
<a name="PREFIX_INFO"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.1"></a><h3>3.1.1.&nbsp;
Advertising route-optimizable prefixes</h3>

<p>A NEMO-supporting Home Agent already maintains information on
          which network(s) are reachable behind certain Mobile Routers. Only
          change to this functionality is that this information can now be
          distributed to other nodes upon request. This request is defined in
          <a class='info' href='#MRROCAP'>Section&nbsp;5.2<span> (</span><span class='info'>Mobile router Route optimization capability</span><span>)</span></a>.
</p>
<p>When a Home Agent receives a registration request, it conducts
          the normal authentication and authorization procedures.
</p>
<p>If registration is successful and the route optimization request
          was present in the registration request, the reply message MAY
          include one route optimization prefix advertisement extensions which
          inform the Mobile Router of all existing mobile networks and the
          Mobile Routers that manage them. The networks SHOULD be included in
          order of priority, with the networks most desired to conduct
          optimization listed first. The extension is constructed as shown in
          <a class='info' href='#ROPREFIXAD'>Section&nbsp;5.1<span> (</span><span class='info'>Route optimization prefix advertisement</span><span>)</span></a>. The extension consists of a list
          where each Mobile Router is listed with according prefix(es) and
          their respective realm(s).
</p>
<p>Each network prefix can be associated to a realm, usually of form
          '@organization.example.com'. Besides the routers in customer's own
          organization, the prefix list may also include other Mobile Routers,
          e.g. default prefix (0.0.0.0/0) pointing towards Internet gateway
          for Internet connectivity, and possible extranets. The realm
          information can be used to make policy decisions on the Mobile
          Router, such as preferring optimization within specific realm
          only.
</p>
<p>In common scenarios, where prefixes are allocated to Mobile
          Routers connecting to a single Home Agent, the prefixes are usually
          either continuous or at least very close to each other. Due to these
          qualities, a prefix compression mechanism is provided. A similar
          schema is in use for realm information, where realms often share
          same higher-level domains. These compression mechanisms are further
          examined in <a class='info' href='#compressionsformats'>Section&nbsp;4<span> (</span><span class='info'>Data compression schemes</span><span>)</span></a>.
</p>
<p>Upon receiving registration reply with the route optimization
          prefix advertisement extension, the Mobile Router SHALL insert the
          Mobile Router HoA as a host-prefix to the local Route Optimization
          Cache if it does not already exist. If they are included, any
          additional prefixes information SHALL also be inserted to the Route
          Optimization Cache.
</p>
<p>The Mobile Router MAY discard entries from a desired starting
          point onwards, due to memory or other policy related constraints.
          The intention of listing the prefixes in order of priority is to
          provide implicit guidance for this decision. If the capacity of the
          device allows, the Mobile Router SHOULD use information on all
          advertised prefixes.
</p>
<a name="ROCACHE"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.2"></a><h3>3.1.2.&nbsp;
Route Optimization cache</h3>

<p>Mobile routers supporting route optimization will maintain a
          Route Optimization Cache.
</p>
<p>The Route Optimization Cache contains mappings between
          Correspondent Router HoA's, network(s) associated with each HoA and
          return routability procedure status.
</p>
<p>The Route Optimization Cache contains the following information
          for all Correspondent Routers:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>CR-HoA</dt>
<dd>Correspondent Router's Home Address.
</dd>
<dt>Prefixes</dt>
<dd>A list of destination prefixes reachable
              via this Correspondent Router. Includes network and prefix
              length, e.g. 192.0.2.0/25. Always contains at least a single
              entry, the CR-HoA host prefix in the form of 192.0.2.1/32.
</dd>
<dt>Realm</dt>
<dd>Destination realm. May be empty, if realm is
              not provided by advertisement or configuration.
</dd>
<dt>NAT</dt>
<dd>The Correspondent Router is behind
              NAT/Firewall as seen from HA. Set if 'O' bit is set in the
              received advertisement. Affects tunnel establishment, see <a class='info' href='#TUNNELS'>Section&nbsp;3.3.4<span> (</span><span class='info'>Inter-Mobile Router tunnels</span><span>)</span></a>. Also mandates use of UDP
              encapsulation.
</dd>
<dt>RRSTATE</dt>
<dd>Return routability state. States are
              INACTIVE, IN PROGRESS and ACTIVE. If state is INACTIVE, return
              routability procedure must be completed before forwarding
              route-optimized traffic. If state is IN PROGRESS or ACTIVE, this
              entry MUST NOT be removed from Route Optimization Cache as long
              as tunnel to the Correspondent Router is established .
</dd>
<dt>KRm</dt>
<dd>Registration management key. Either
              established via return routability procedure or configured
              statically. If configured statically, RRSTATE is permanently set
              to ACTIVE.
</dd>
<dt>HA</dt>
<dd>HA bit is set if this entry is learned from HA.
              This implies that the entry can be trusted. If not set, the
              entry has been learned from another Mobile Router and not yet
              verified from HA. The entry may still be maintained while
              awaiting verification.
</dd>
</dl></blockquote>

<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1.3"></a><h3>3.1.3.&nbsp;
Correspondent Router Mobility Bindings</h3>

<p>Each Correspondent Router will maintain Mobility Bindings, in a
          similar way to the Home Agent.
</p>
<p>The Mobility Binding for each Mobile Router contains
</p>
<p></p>
<blockquote class="text"><dl>
<dt>HoA</dt>
<dd>Mobile Router's Home Address
</dd>
<dt>CoA</dt>
<dd>Mobile Router's Care-of Address
</dd>
<dt>Prefixes</dt>
<dd>A list of destination prefixes bound to
              this Mobile Router. Includes the Mobile Router itself as a host
              prefix, e.g. 192.0.2.1/32.
</dd>
<dt>Realm</dt>
<dd>Destination realm. May be empty, if realm
              not provided by advertisement or configuration.
</dd>
<dt>Tunnel</dt>
<dd>Tunnel interface associated with the Mobile
              Router. The tunnel interface itself handles all the necessary
              operations to keep the tunnel operational, e.g. sends UDP
              keepalives.
</dd>
</dl></blockquote>

<a name="RRP"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Return routability procedure</h3>

<p>The return routability procedure for Mobile IPv6 is described in
        <a class='info' href='#RFC3775'>[RFC3775]<span> (</span><span class='info'>Johnson, D., Perkins, C., and J. Arkko, &ldquo;Mobility Support in IPv6,&rdquo; June&nbsp;2004.</span><span>)</span></a>. Same principles apply to the Mobile
        IPv4 version: Two messages are sent to Correspondent Router's Home
        Address, one via Home Agent and the other directly from the Mobile
        Router CoA, with two responses coming through same routes.
        Registration management key is derived from token information carried
        on these messages. This registration management key (KRm) can then be
        used to authenticate registration requests (comparable to Binding
        Updates in Mobile IPv6).
</p>
<p>The Return Routability procedure is a method provided by Mobile IP
        protocol to establish the KRm in a relatively lightweight fashion. If
        desired, the KRm's can be configured to Mobile Routers statically, or
        using an appropriate secure key provisioning mechanism. If KRm's are
        known to the Mobile Routers via some other mechanism, Return
        Routability procedure can be skipped. Such provisioning mechanisms are
        out of scope for this document.
</p>
<p>Assumption on traffic patterns is that the Mobile Router that
        initiates the RR procedure can always send outbound messages, even
        when behind NAT or firewall. This basic assumption made for NAT
        Traversal in <a class='info' href='#RFC3519'>[RFC3519]<span> (</span><span class='info'>Levkowetz, H. and S. Vaarala, &ldquo;Mobile IP Traversal of Network Address Translation (NAT) Devices,&rdquo; April&nbsp;2003.</span><span>)</span></a> is also applicable here.
        In case the Correspondent Router is behind such obstacles, it receives
        these messages via the reverse tunnel to CR's Home Address, thus any
        problem regarding the CR's connectivity is addressed during the
        registration phase.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.1"></a><h3>3.2.1.&nbsp;
Router keys</h3>

<p>Each Correspondent Router maintains a router key, Kcr, which is
          not shared with anyone else. This is analogous to node key, Kcn, in
          Mobile IPv6. Correspondent Router uses router key to verify that the
          keygen tokens sent by Mobile Router in registration request are its
          own. The router key MUST be a random number, 96 bits in length.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2.2"></a><h3>3.2.2.&nbsp;
Nonces</h3>

<p>Each Correspondent Router also maintains one or more indexed
          nonces. Nonces should be generated periodically with a good random
          number generator. The Correspondent Router may use same nonces with
          all Mobile Routers.
</p>
<p>Correspondent Routers keep both the current nonce and small set
          of valid previous nonces whose lifetime have not expired yet.
</p>
<p>Return Routability procedure may be initiated only when the Route
        Optimization Cache's RRSTATE field for the Correspondent Router is
        INACTIVE. When Return Routability procedure is initiated, the state
        MUST be set to IN PROGRESS.
</p>
<p>The Return Routability procedure consists of four new Mobile IP
        messages: Home Test Init, Care-of Test Init, Home Test and Care-of
        Test. They are constructed as shown in <a class='info' href='#HOTI'>Section&nbsp;5.3<span> (</span><span class='info'>Home-Test Init message</span><span>)</span></a>
        through <a class='info' href='#CoT'>Section&nbsp;5.6<span> (</span><span class='info'>Care-of test message</span><span>)</span></a>. If the Mobile Router has included
        the Mobile Router optimization capability extension in its
        Registration Request, it MUST be able to accept Return Routability
        messages. The messages are delivered as standard Mobile IP packets.
        The addresses are set to Correspondent Router's HoA and Mobile
        Router's CoA.
</p>
<p>The return routability procedure begins with the Mobile Router
        sending HoTI and CoTI messages, each containing a cookie.
</p>
<p>Upon receiving the HoTI or CoTI message the Correspondent Router
        MUST have a secret Kcr. If the Kcr does not exist, it must be produced
        before continuing with the return routability procedure.
</p>
<p>Correspondent Router responds to HoTI and CoTI messages by
        constructing HoT and CoT messages, respectively, as replies. HoT
        message contains current home nonce index and CoT message contains
        current care-of nonce index.
</p>
<p>Upon completion of Return Routability procedure, the Routing
        Optimization Cache's RRSTATE field is set to ACTIVE. The Mobile Router
        will establish a registration management key KRm:
</p>
<p>KRm = SHA1 (home keygen token | care-of keygen token)
</p>
<p>Like in Mobile IPv6, the Correspondent Router does not maintain any
        state for the Mobile Router until after receiving a registration
        request.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Mobile-Correspondent Router operations</h3>

<p>This section deals with the operation of Mobile and Correspondent
        Routers performing route optimization. Note that in a typical case all
        routers work as both Mobile Router and Correspondent Router.
</p>
<p>Especially compared to Mobile IPv6 route optimization there are two
        issues that are different regarding IPv4. First of all, since Mobile
        IPv4 always uses tunnels, there must be a tunnel established between
        MR and CR's Care-of addresses. This is accomplished with a new
        extension, "Care-of Address", in registration reply. Second issue is
        rising from security standpoint: In a registration request, the Mobile
        Router claims to represent an arbitrary IPv4 network. If the CR has
        not yet received this information (HoA &lt;-&gt; Network prefix), it
        SHOULD perform a re-registration to Home Agent to verify the
        claim.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.1"></a><h3>3.3.1.&nbsp;
Triggering Route Optimization</h3>

<p>Since each Mobile Router knows all the route-optimizable
          networks, the route optimization between all Correspondent Routers
          can be established at any time; However a better general practice is
          to conduct Route Optimization activation on-demand only. Route
          optimization SHOULD only be started when receiving a packet where
          destination address is local (and the subnet is registered as route
          optimizable) and source address exists in the Route Optimization
          Cache.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.2"></a><h3>3.3.2.&nbsp;
Mobile Router routing tables</h3>

<p>Each Mobile Router maintains a routing table. In a typical
          situation, it contains interface(s) to the local networks, interface
          to wide-area network (such as ISP), and a tunnel interface to the
          Home Agent. Additional entries consist of route-optimized tunnel
          interfaces and networks associated with each tunnel.
</p>
<a name="INTERMOBILEREG"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.3"></a><h3>3.3.3.&nbsp;
Inter-Mobile Router registration</h3>

<p>If route optimization between Mobile Router and Correspondent
          Router is desired, either Return Routability procedure must have
          been performed ( See <a class='info' href='#RRP'>Section&nbsp;3.2<span> (</span><span class='info'>Return routability procedure</span><span>)</span></a>), or key KRm must be
          pre-shared between the Mobile and Correspondent Router. If a known
          KRm exists, a Mobile Router MAY send a registration request to the
          Correspondent Router's HoA.
</p>
<p>The registration request's source address and Care-of address
          field are set to the Mobile Router's Care-of address. The
          registration request MUST include Mobile-Correspondent
          Authentication extension defined in <a class='info' href='#AUTHENTICATIONEXT'>Section&nbsp;5.7<span> (</span><span class='info'>Mobile-Correspondent authentication extension</span><span>)</span></a> and Mobile Network Request
          Extension defined in <a class='info' href='#RFC5177'>[RFC5177]<span> (</span><span class='info'>Leung, K., Dommety, G., Narayanan, V., and A. Petrescu, &ldquo;Network Mobility (NEMO) Extensions for Mobile IPv4,&rdquo; April&nbsp;2008.</span><span>)</span></a>. If timestamps
          are used, the Correspondent Router MUST check the identification
          field for validity. The registration request MUST include Home
          Address. The Authenticator field is hashed with the key KRm.
</p>
<p>The encapsulation can be set as desired, except in the case where
          the Correspondent Router's Route Optimization Cache Entry has NAT
          set or the Mobile Router itself is behind NAT or firewall. If either
          of the conditions apply, registration request MUST specify UDP
          encapsulation.
</p>
<p>The Correspondent Router first checks the registration request's
          authentication against Kcr and nonce indexes negotiated during
          Return Routability procedure. This ensures that the registration
          request is coming from a correct Mobile Router. If the check passes,
          the Correspondent Router MUST check whether the Mobile Router
          already exists in it's Route Optimization Cache and is linked with
          the prefixes included in the request.
</p>
<p>If the prefixes don't match, the Correspondent Router SHOULD send
          a re-registration request to Home Agent with the 'S' (solicitation)
          bit set, thus obtaining the latest information on mobile prefixes
          managed by incoming Mobile Router. If, even after this update, the
          prefixes still don't match, the Correspondent Router MUST reject the
          registration request. This verification is done to protect against
          Mobile Router claiming to represent arbitrary networks; However,
          since Home Agent provides trusted information, it can authorize
          Mobile Router's claim. If the network is considered trusted, the
          Correspondent Router can, as a policy, accept registrations from
          without this check; however, this is NOT RECOMMENDED as a general
          practice.
</p>
<p>If the prefixes match, the Correspondent Router MAY accept the
          registration. Upon receiving the registration reply, the Mobile
          Router MUST check if a tunnel to the Mobile Router already exists.
          Otherwise a tunnel MUST be established and Mobility Binding updated.
          This is covered in <a class='info' href='#TUNNELS'>Section&nbsp;3.3.4<span> (</span><span class='info'>Inter-Mobile Router tunnels</span><span>)</span></a>.
</p>
<p>The Correspondent Router's routing table MUST be updated to
          include the Mobile Router's networks are reachable via the tunnel to
          the Mobile Router.
</p>
<p>After the tunnel is established, the Mobile Router MAY update
          it's routing tables to reach all Correspondent Router's Prefixes via
          the tunnel. This is primarily a policy decision depending on the
          network environment. See section <a class='info' href='#MUTUALNESS'>Section&nbsp;6.4<span> (</span><span class='info'>Mutualness of Route Optimization</span><span>)</span></a>.
</p>
<a name="TUNNELS"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.4"></a><h3>3.3.4.&nbsp;
Inter-Mobile Router tunnels</h3>

<p>Inter-Mobile Router tunnel establishment follows establishing
          standard reverse tunnels to the Home Agent. The registration request
          to Correspondent Router includes information on the desired
          encapsulation. In the case of GRE, IP over IP or minimal
          encapsulation no special considerations regarding the reachability
          are necessary; The tunnel has no stateful information; The packets
          are simply encapsulated within the GRE, IP, or minimal header.
</p>
<p>The tunnel origination point for the Correspondent Router is its
          Care-of Address, not the address where the registration requests
          were sent. This is different from creation of the Reverse Tunnel to
          Home Agent.
</p>
<p>Special considerations rise from using UDP encapsulation,
          especially in cases where one of the Mobile Routers is located
          behind NAT or firewall. If the Route Optimization Cache has NAT bit
          set for a specific network, the UDP tunnel establishment MUST be
          initiated from the Correspondent Router. However, the procedure
          otherwise follows <a class='info' href='#RFC3519'>[RFC3519]<span> (</span><span class='info'>Levkowetz, H. and S. Vaarala, &ldquo;Mobile IP Traversal of Network Address Translation (NAT) Devices,&rdquo; April&nbsp;2003.</span><span>)</span></a>. Once the first UDP
          keepalive is sent, the tunnel can be considered active.
</p>
<p>If both the Mobile Router and the Correspondent Router are behind
          NAT, route optimization cannot be performed between them.
          Possibilities to set up mutual tunneling when both routers are
          behind NAT, are outside the scope of this draft. However, some of
          these issues are addressed in <a class='info' href='#NATCONSIDERATIONS'>Section&nbsp;6.1<span> (</span><span class='info'>NATs and stateful firewalls </span><span>)</span></a>.
</p>
<p>Due to the fact that the route optimization procedures may occur
          concurrently at two Mobile Routers, each working as each other's
          Correspondent Router, there may be a situation where two routers are
          attempting to establish separate tunnels between them at the same
          time. If a router with a smaller Home Address receives a
          registration request (in CR role) while its own registration request
          (sent in MR role) has not been answered yet, the reply must be held
          until the tunnel initiated by its registration request is up. This
          avoids the problem of maintaining two separate tunnels forming
          concurrently between two Mobile Routers.
</p>
<p>Since typical routers act as both MR's and CR's, tunnels can be
          only torn down if there is no Mobility Bindings on the tunnel (in
          Correspondent Router role) AND no Mobility Sessions are bound to the
          tunnel (Mobile Router role). Both Mobility Sessions and Mobility
          Bindings will go down when their lifetime expires.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.5"></a><h3>3.3.5.&nbsp;
Constructing route-optimized packets</h3>

<p>All packets received by the Mobile Router are forwarded using
          normal routing rules according to the routing table. There are no
          special considerations when constructing the packets, the interface
          procedure will encapsulate any packet automatically.
</p>
<p>If prefixes overlap each other, e.g. 192.0.2.128/25 and
          192.0.2.128/29, the standard longest match rule for routing is in
          effect. However, overlapping private address SHOULD be considered an
          error situation. Any aggregation for routes in private address space
          SHOULD be conducted only at HA.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3.6"></a><h3>3.3.6.&nbsp;
Handovers and Mobile Routers leaving network</h3>

<p>Handovers and connection breakdowns can be categorized as either
          ungraceful or graceful, or break-before-make and make-before-break
          situations.
</p>
<p>In a typical situation, router act as both Mobile Router and
          Correspondent Router for other routers' prefixes.
</p>
<p>When a Mobile Router wishes to leave network, it SHOULD send a
          re-registration request to all Correspondent Routers with the
          lifetime set to zero. If the Correspondent Router is also acting as
          a Mobile Router with active Route Optimization with the leaving
          router, it SHOULD send a similar re-registration request with the
          lifetime set to zero. This causes both the Mobility Bindings and
          active Mobility Sessions to go down, allowing for teardown of the
          tunnel.
</p>
<p>If the Mobile Router was unable to send the re-registration
          request before handover, it MUST send it immediately after handover
          is completed and binding with the Home Agent is up. In a similar
          fashion, Correspondent Router acting as a Mobile Router MUST realize
          that the old Mobility Session is no longer valid and establish a new
          one. Thus, route optimization can resume.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.4"></a><h3>3.4.&nbsp;
Convergence and synchronization issues</h3>

<p>Home Agent state and Mobile Routers' Route Optimization Caches do
        not need to be explicitly synchronized. The assumption is that at
        least some of the traffic between mobile networks is always
        bidirectional. This will cause Mobile Routers to perform
        re-registrations and thus they will receive updates on-demand
        only.
</p>
<p>Consider a situation with three mobile networks, A, B, C handled by
        three Mobile Routers, MR A, MR B and MR C. If they register to a Home
        Agent in this order, the situation goes as follows:
</p>
<p>MR A registers; Receives no information on other networks from HA,
        as no other MR has registered yet.
</p>
<p>MR B registers; Receives information on mobile network A being
        reachable via MR A.
</p>
<p>MR C registers; Receives information on both of the other mobile
        networks.
</p>
<p>If a node in mobile network C receives traffic from mobile network
        A, the route optimization is straightforward; MR C already has network
        A in its Route Optimization Cache. When it registers to MR A (after
        Return Routability procedure is completed), MR A does not have
        information on mobile network C; Thus it will perform a
        re-registration to the Home Agent on-demand. This allows MR A to
        verify that MR C is indeed managing network C.
</p>
<p>If a node in mobile network B receives to traffic from mobile
        network C, MR B has no information on network C. No route optimization
        is triggered. However, when network B's reply reaches MR C, route
        optimization happens as above. Further examples of signaling are in
        <a class='info' href='#examplesignals'>Section&nbsp;8<span> (</span><span class='info'>Example signaling scenarios</span><span>)</span></a>.
</p>
<p>Even in the very rare case of completely unidirectional traffic
        from an entire network, the re-registrations caused by timeouts will
        eventually cause convergence. However, this should be treated as a
        special case.
</p>
<p>Note that all Mobile Routers are connected to same Home Agent. For
        possibilities concerning multiple Home Agents, see <a class='info' href='#MULTIHOMEAGENTS'>Section&nbsp;6.3<span> (</span><span class='info'>Multiple Home Agents</span><span>)</span></a>
</p>
<a name="compressionsformats"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Data compression schemes</h3>

<p>This section defines the two compression formats used in Route
      Optimization Prefix Advertisement extensions.
</p>
<a name="prefixcomp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Prefix compression</h3>

<p>The prefix-compression is based on the idea that prefixes usually
        share common properties. The scheme is simple delta-compression. In
        the prefix information advertisement, <a class='info' href='#ROPREFIXAD'>Section&nbsp;5.1<span> (</span><span class='info'>Route optimization prefix advertisement</span><span>)</span></a>, the D bit indicates whether receiving a
        "master" or a "delta" prefix. This, combined with the Prefix Length
        information, allows for compression and decompression of prefix
        information.
</p>
<p>If D=0, what follows in the "Prefix" field are bits 1..n of the a
        new master prefix, where n is PLen. This is rounded up to nearest full
        octet. Thus, prefix lengths of /4 and /8 take 1 octet, /12 and /16
        take 2 octets, /20 and /24 three, and larger than that full 4
        octets.
</p>
<p>If D=1, what follows in the "Prefix" field are bits m..PLen of the
        prefix, where m is the first changed bit of previous master prefix,
        with padding from master prefix filling the field to full octet.
        Maximum value of Plen-m is 8 (that is, delta MUST fit into one octet).
        If this is not possible, a new master prefix has to be declared.
</p>
<p>Determining the order of prefix transmission should be based on
        saving maximum space during transmission.
</p>
<p>Example of compression and transmitted data, where network prefixes
        192.0.2.0/28, 192.0.2.64/26 and 192.0.2.128/25 are transmitted are
        illustrated. Because of the padding to full octets, redundant
        information is also sent. The bit-patterns being transmitted are:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre> =+= shows the prefix mask
 --- shows the master prefix for delta coded prefixes
 192.0.2.0/28, D=0

 0                   1                     2                     3
 1 2 3 4 5 6 7 8   9 0 1 2 3 4 5 6   7 8 9 0 1 2 3 4   5 6 7 8 9 0 1 2
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1|1|0|0|0|0|0|0|.|0|0|0|0|0|0|0|0|.|0|0|0|0|0|0|1|0|.|0|0|0|0|0|0|0|0|
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+-+-+-+-+
 ^                                                                   ^
 +---------------------------- encoded ------------------------------+
                                                               ^     ^
                                                               +-pad-+
 192.0.2.64/26, D=1

 0                   1                     2                     3
 1 2 3 4 5 6 7 8   9 0 1 2 3 4 5 6   7 8 9 0 1 2 3 4   5 6 7 8 9 0 1 2
+-------------------------------------------------------------+-+-+-+-+
|1|1|0|0|0|0|0|0|.|0|0|0|0|0|0|0|0|.|0|0|0|0|0|0|1|0|.|0|1|0|0|0|0|0|0|
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+-+-+-+-+-+-+
                                         ^               ^
                                         +--- encoded ---+
                                         ^             ^
                                         +-- padding --+
 192.0.2.128/25, D=1

 0                   1                     2                     3
 1 2 3 4 5 6 7 8   9 0 1 2 3 4 5 6   7 8 9 0 1 2 3 4   5 6 7 8 9 0 1 2
+-------------------------------------------------------------+-+-+-+-+
|1|1|0|0|0|0|0|0|.|0|0|0|0|0|0|0|0|.|0|0|0|0|0|0|1|0|.|1|0|0|0|0|0|0|0|
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+-+-+-+-+-+-+-+
                                       ^               ^
                                       +--- encoded ---+
                                       ^           ^
                                       +- padding -+

</pre></div>
<p>First prefix, 192.0.2.0/28, is considered a master prefix and is
        transmitted in full. The PLen of 28 bits determines that all four
        octets must be transmitted. If the prefix would have been eg.
        192.0.2.0/24, three octets would have sufficed since 24 bits fit into
        3 octets.
</p>
<p>For the following prefixes, the D=1. Thus, they are deltas of the
        previous prefix where D was zero.
</p>
<p>192.0.2.64/26 includes bits 19-26 (full octet). Bits 19-25 are
        copied from master prefix, but bit 26 is changed to 1. The final
        notation in binary is "1001", or 0x09.
</p>
<p>192.0.2.128/25 includes bits 18-25 (full octet). Bits 18-24 are
        copied from master prefix, but bit 25 is changed to 1. The final
        notation in binary is "101", or 0x05.
</p>
<p>The final encoding thus becomes:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
+----------------+--------+-+---------------------+
|     Prefix     |  Plen  |D| Transmitted Prefix  |
+----------------+--------+-+---------------------+
| 192.0.2.0/28   |  28    |0| 0xc0 0x00 0x02 0x00 |
| 192.0.2.64/26  |  26    |1| 0x09                |
| 192.0.2.128/25 |  25    |1| 0x05                |
+----------------+--------+-+---------------------+
</pre></div>
<p>It should be noted that in this case the order of prefix
        transmission would not affect compression efficiency. If prefix
        192.0.2.128/25 would have been considered the master prefix and the
        others as deltas instead, the resulting encoding still fits into one
        octet for the subsequent prefixes. There would be no need to declare a
        new master prefix.
</p>
<a name="realmcomp"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Realm compression</h3>

<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.1"></a><h3>4.2.1.&nbsp;
Encoding of compressed realms</h3>

<p>In order to reduce the size of messages, the system introduces a
          realm compression scheme, which reduces the size of realms in a
          message. The compression scheme is a simple dynamically updated
          dictionary based algorithm, which is designed to compress arbitrary
          length text strings. In this scheme, an entire realm, a single label
          or a list of labels may be replaced with an index to a previous
          occurance of the same string stored in the dictionary. The realm
          compression defined in this specification was inspired by the <a class='info' href='#RFC1035'>RFC 1035<span> (</span><span class='info'>Mockapetris, P., &ldquo;Domain names - implementation and specification,&rdquo; November&nbsp;1987.</span><span>)</span></a> [RFC1035] DNS domain name label compression.
          Our algorithm is, however, improved to gain more compression.
</p>
<p>When compressing realms, the dictionary is first resetted and
          does not contain a single string. The realms are processed one by
          one so the algorithm does not expect to see them all or the whole
          message at once. The state of the compressor is the current content
          of the dictionary. The realms are compressed label by label or as a
          list of labels. The dictionary can hold maximum 128 strings. Thus,
          when adding the 129th string into the dictionary, the dictionary
          MUST first be resetted to the initial state (i.e. emptied) and the
          index of the string will become 0.
</p>
<p>The encoding of an index to the dictionary or an uncompressed run
          of octets representing a single label has purposely been made simple
          and the whole encoding works on an octet granularity. The encoding
          of an uncompressed label takes the form of a one octet:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 0
 0 1 2 3 4 5 6 7
+-+-+-+-+-+-+-+-+-+-+-+-=================-+-+-+-+
|0|   LENGTH    | 'length' octets long string.. |
+-+-+-+-+-+-+-+-+-+-+-+-=================-+-+-+-+
</pre></div>
<p>This encoding allows label lengths from 1 to 127 octets. A label
          length of zero (0) is not allowed. The "label length" tag octet is
          then followed by up to 127 octets of the actual encoded label
          string.
</p>
<p>The index to the dictionary (the "label index" tag octet) takes
          the form of a one octet:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 0
 0 1 2 3 4 5 6 7
+-+-+-+-+-+-+-+-+
|1|   INDEX     |
+-+-+-+-+-+-+-+-+
</pre></div>
<p>The above encodings do not allow generating an output octet value
          of zero (0). The encapsulating Mobile IPv4 extension makes use of
          this property and uses the value of zero (0) to mark the end of
          compressed realm or to indicate an empty realm. It is also possible
          to encode the complete realm using only "label length" tags. In this
          case no compression takes place. This allows the sender to skip
          compression, for example to reduce computation requirements when
          generating messages. However, the receiver MUST always be prepared
          to receive compressed realms.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.2"></a><h3>4.2.2.&nbsp;
Searching algorithm</h3>

<p>When compressing the input realm, the dictionary is searched for
          a matching string. If no match could be found, the last label is
          removed from the right-hand side of the used input realm. The search
          is repeated until the whole input realm has been processed. If no
          match was found at all, then the first label of the original input
          realm is encoded using the "label length" tag and the label is
          inserted into the dictionary. The previously described search is
          repeated with the remaining part of the input realm, if any. If
          nothing remains, the realm encoding is complete
</p>
<p>When a matching string is found in the dictionary the matching
          part of the input realm is encoded using the "label index" tag. The
          matching part of the input realm is removed and the search is
          repeated with the remaining part of the input realm, if any. If
          nothing remains, the octet value of zero (0) is inserted to mark the
          end of encoded realm.
</p>
<p>The search algorithm also maintains the "longest non-matching
          string" for each input realm. Each time the search in dictionary
          fails and a new label gets encoded using the "label length" tag and
          inserted into the dictionary, the "longest non-matching string" is
          concatenated by this label. When a match is found in the dictionary
          the "longest non-matching string" is resetted (i.e. emptied). Once
          the whole input realm has been processed and encoded, all possible
          suffixes longer than one label are taken from the string and
          inserted into the dictionary.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2.3"></a><h3>4.2.3.&nbsp;
Encoding example</h3>

<p>This section shows an example how to encode a set of realms using
          the specified realm compression algorithm. For example, a message
          might need to compress the realms "foo.example.com",
          "bar.foo.example.com", "buz.foo.example.org", "example.com" and
          "bar.example.com.org". The following example shows the processing of
          input realms on the left side and the contents of the dictionary on
          the right hand side. The example uses hexadecimal representation of
          numbers.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
COMPRESSOR:                                 DICTIONARY:
1) Input "foo.example.com"
Search("foo.example.com")
Search("foo.example")
Search("foo")
Encode(0x03,'f','o','o')                    0x00 "foo"
  +-&gt; "longest non-matching string" = "foo"
Search("example.com")
Search("example")
Encode(0x07,'e','x','a','m','p','l','e')    0x01 "example"
  +-&gt; "longest non-matching string" = "foo.example"
Search("com")
Encode(0x03,'c','o','m')                    0x02 "com"
  +-&gt; "longest non-matching string" = "foo.example.com"
                                            0x03 "foo.example.com"
                                            0x04 "example.com"
Encode(0x00)
2) Input "bar.foo.example.com"
Search("bar.foo.example.com")
Search("bar.foo.example")
Search("bar.foo"
Search("bar")
Encode(0x03,'b','a','r')                    0x05 "bar"
  +-&gt; "longest non-matching string" = "bar"
Search("foo.example.com") -&gt; match to 0x03
Encode(0x83)
  +-&gt; "longest non-matching string" = NUL
Encode(0x00)
3) Input "buz.foo.example.org"
Search("buz.foo.example.org")
Search("buz.foo.example")
Search("buz.foo")
Search("buz")
Encode(0x03,'b','u','z')                    0x06 "buz"
  +-&gt; "longest non-matching string" = "buz"
Search("foo.example.org")
Search("foo.example")
Search("foo") -&gt; match to 0x00
Encode(0x80)
  +-&gt; "longest non-matching string" = NUL
Search("example.org")
Search("example") -&gt; match to 0x01
Encode(0x81)
  +-&gt; "longest non-matching string" = NUL
Search("org")
Encode(0x03,'o','r','g')                    0x07 "org"
  +-&gt; "longest non-matching string" = "org"
Encode(0x00)
4) Input "example.com"
Search("example.com") -&gt; match to 0x04
Encode(0x84)
Encode(0x00)
5) Input "bar.example.com.org"
Search("bar.example.com.org")
Search("bar.example.com")
Search("bar.example")
Search("bar") -&gt; match to 0x05
Encode(0x85)
Search("example.com.org")
Search("example.com") -&gt; match to 0x04
Encode(0x84)
Search("org") -&gt; match to 0x07
Encode(0x87)
Encode(0x00)
</pre></div>
<p>As can be seen from the example, due the greedy approach of
          encoding matches, the search algorithm and the dictionary update
          function is not the most optimal one. However, we do not claim the
          algorithm would be the most efficient. It functions efficiently
          enough for most inputs. In this example, the original input realm
          data was 79 octets and the compressed output excluding the end mark
          is 35 octets.
</p>
<a name="MESSAGESANDEXTENSIONS"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
New Mobile IPv4 messages and extensions</h3>

<p>This section describes the construction of all new information
      elements.
</p>
<a name="ROPREFIXAD"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Route optimization prefix advertisement</h3>

<p>This non-skippable extension MAY be sent by a Home Agent to a
        Mobile Router in the registration reply message. The extension is only
        included when explicitly requested by the Mobile Router in the
        registration request message. Implicit prioritization of prefixes is
        caused by the order of extensions.
</p>
<p>Route optimization prefix advertisement
          extension
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Sub-type   |             Length            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  1-n times the following information structure
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |O|D|M| Plen    |  Optional Mobile Router HoA, 4 octets         ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ~               |  Optional Prefix, 1,2,3 or 4 octets           ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ~                 Realm  (1-n characters)                       ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Type</dt>
<dd>TBA, Non-skippable (since it's explicitly
            requested)
</dd>
<dt>D</dt>
<dd>Delta. If D=1, the prefix is a delta from last
            Prefix where D=0. MUST be zero on first information structure, MAY
            be zero or one on subsequent information structures. If D=1, the
            Prefix field is one octet in length. See <a class='info' href='#prefixcomp'>Section&nbsp;4.1<span> (</span><span class='info'>Prefix compression</span><span>)</span></a> for details.
</dd>
<dt>O</dt>
<dd>Outbound connections only. This bit indicates that
            the target Mobile Router can only initiate, not receive,
            connections from it's CoA for this prefix. This is set if Home
            Agent has determined that the Mobile Router is behind NAT, or the
            Mobile Router has explicitly requested it using the UDP Tunnel
            Request extension defined in <a class='info' href='#RFC3519'>RFC
            3519<span> (</span><span class='info'>Levkowetz, H. and S. Vaarala, &ldquo;Mobile IP Traversal of Network Address Translation (NAT) Devices,&rdquo; April&nbsp;2003.</span><span>)</span></a> [RFC3519] with the Force flag set.
</dd>
<dt>M</dt>
<dd>Mobile Router HoA bit. If M=1, the next field is
            Mobile Router HoA, and Prefix is omitted. If M=0, the next field
            is Prefix, and Mobile Router HoA is omitted. For the first
            information structure, M MUST be set to 1. If M=1, the D and O
            bits are set to zero and ignored upon reception.
</dd>
<dt>PLen</dt>
<dd>Length of the prefix advertised. 5 bits, allows
            for values from 0 to 31. If M=1, MUST be set to zero and ignored
            upon reception.
</dd>
<dt>Mobile router HoA</dt>
<dd>Mobile Router's Home address. All
            prefixes in the following information structures where M=0 are
            maintained by this Mobile Router.
</dd>
<dt>Prefix</dt>
<dd>The IPv4 prefix advertised. If D=0, the field
            length is Plen bits, rounded up to nearest full octet.
            Least-significant bits starting off Plen (and are zeroes) are
            omitted. If D=1, field length is one octet.
</dd>
<dt>Realm</dt>
<dd>The Realm that is associated with the
            advertised Mobile Router CoA and prefix. If empty, MUST be set to
            '\0'. For realm encoding and optional compression scheme, refer to
            <a class='info' href='#realmcomp'>Section&nbsp;4.2<span> (</span><span class='info'>Realm compression</span><span>)</span></a>.
</dd>
</dl></blockquote>

<a name="MRROCAP"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Mobile router Route optimization capability</h3>

<p>This skippable extension MAY be sent by a Mobile Router to a Home
        Agent in the registration request message.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |   Sub-Type    |A|R|S| Reserved|
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 ~                 Optional Mobile Router HoA                    ~
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</pre></div>
<p></p>
<blockquote class="text"><dl>
<dt>Type</dt>
<dd>TBA. Skippable; If Home Agent does not support
            route optimization advertisements, it can ignore this request and
            simply not include any information in the reply.
</dd>
<dt>A</dt>
<dd>Advertise my networks. If 'A' bit is set, the Home
            Agent is allowed to advertise the networks managed by this Mobile
            Router to other Mobile Routers.This also indicates that the Mobile
            Router is capable of receiving route optimization binding updates.
            In effect, this allows the Mobile Router to work in Correspondent
            Router role.
</dd>
<dt>R</dt>
<dd>Request mobile network information. If 'R' bit is
            set, the Home Agent MAY respond with information about mobile
            networks in the same domain.
</dd>
<dt>S</dt>
<dd>Solicitating prefixes managed by specific Mobile
            Router. The Mobile Router is specified in the Optional Mobile
            Router HoA field.
</dd>
<dt>Reserved</dt>
<dd>Set to zero, MUST be ignored on
            reception.
</dd>
<dt>Optional Mobile Router HoA</dt>
<dd>Other Mobile Router's
            Home Address.
</dd>
</dl></blockquote>

<a name="HOTI"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Home-Test Init message</h3>

<p>
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |           Reserved            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                       Home Init Cookie                        +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p></p>
<blockquote class="text"><dl>
<dt>Type</dt>
<dd>TBA.
</dd>
<dt>Reserved</dt>
<dd>Set to zero, MUST be ignored on
            reception.
</dd>
<dt>Home Init Cookie</dt>
<dd>64-bit field which contains a
            random value, the Home Init Cookie.
</dd>
</dl></blockquote>

<a name="CoTI"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.4"></a><h3>5.4.&nbsp;
Care-of-Test Init message</h3>

<p>
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |           Reserved            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                    Care-of Init Cookie                        +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p></p>
<blockquote class="text"><dl>
<dt>Type</dt>
<dd>TBA
</dd>
<dt>Reserved</dt>
<dd>Set to zero, MUST be ignored on
            reception.
</dd>
<dt>Care-of Init Cookie</dt>
<dd>64-bit field which contains a
            random value, the Care-of Init Cookie.
</dd>
</dl></blockquote>

<a name="HoT"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.5"></a><h3>5.5.&nbsp;
Home Test message</h3>

<p>
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |       Home Nonce Index        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                       Home Init Cookie                        +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                       Home Keygen Token                       +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p></p>
<blockquote class="text"><dl>
<dt>Type</dt>
<dd>TBA
</dd>
<dt>Home Nonce Index</dt>
<dd>This field will be echoed back by
            the Mobile Router to the Correspondent Router in a subsequent
            registration request.
</dd>
<dt>Home Init Cookie</dt>
<dd>64-bit field which contains a
            random value, the Home Init Cookie.
</dd>
<dt>Home Keygen Token</dt>
<dd>This field contains the 64 bit
            home keygen token used in the Return Routability procedure.
            Generated from cookie + nonce.
</dd>
</dl></blockquote>

<a name="CoT"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.6"></a><h3>5.6.&nbsp;
Care-of test message</h3>

<p>
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |     Care-of Nonce Index       |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                     Care-of Init Cookie                       +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 +                     Care-of Keygen Token                      +
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p></p>
<blockquote class="text"><dl>
<dt>Type</dt>
<dd>TBA
</dd>
<dt>Care-of Nonce Index</dt>
<dd>This field will be echoed back
            by the Mobile Router to the Correspondent Router in a subsequent
            registration request.
</dd>
<dt>Care-of Init Cookie</dt>
<dd>64-bit field which contains a
            random value, the Home Init Cookie.
</dd>
<dt>Care-of Keygen Token</dt>
<dd>This field contains the 64 bit
            home keygen token used in the Return Routability procedure.
</dd>
</dl></blockquote>

<a name="AUTHENTICATIONEXT"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.7"></a><h3>5.7.&nbsp;
Mobile-Correspondent authentication extension</h3>

<p>Nonce indices extension is used in registration requests sent from
        Mobile Router to Correspondent Router
</p>
<p>Mobile-Correspondent authentication extension is included in
        registration requests sent from Mobile Router to Correspondent Router.
        It may also be used with Foreign Agents. The format is similar to the
        other Authentication Extensions defined in <a class='info' href='#RFC3344'>[RFC3344]<span> (</span><span class='info'>Perkins, C., &ldquo;IP Mobility Support for IPv4,&rdquo; August&nbsp;2002.</span><span>)</span></a>, with SPI's replaced by Nonce Indexes.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |      Home Nonce Index         |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Care-of Nonce Index       |       Authenticator...
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>The Home Nonce Index field tells the Correspondent Router which
        nonce value to use when producing the home keygen token. The Care-of
        Nonce Index field is ignored in requests to remove a binding.
        Otherwise, it tells the Correspondent Router which nonce value to use
        when producing the Care-of Keygen Token.
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Type</dt>
<dd>TBA
</dd>
<dt>Home Nonce Index</dt>
<dd>Home Nonce Index in use.
</dd>
<dt>Care-of Nonce Index</dt>
<dd>Care-of Index in use.
</dd>
<dt>Authenticator</dt>
<dd>Authenticator field, constructed by
            issuing HMAC_SHA1 (KRm, Protected Data)
</dd>
</dl></blockquote><p>The protected data, just like on other cases where
        Authenticator is used, consists of
</p>
<p></p>
<blockquote class="text"><dl>
<dt>o</dt>
<dd>the UDP payload (i.e., the Registration Request or
            Registration Reply data),
</dd>
<dt>o</dt>
<dd>all prior Extensions in their entirety, and
</dd>
<dt>o</dt>
<dd>the Type, Length, and Nonce Indexes of this
            Extension.
</dd>
</dl></blockquote>

<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.8"></a><h3>5.8.&nbsp;
Care-of address Extension</h3>

<p>
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  0               1               2               3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |     Type      |    Length     |           Reserved            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        Care-of Address                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>The Care-of Address extension is added to a registration reply sent
        by the Correspondent Router to inform the Mobile Router of the
        upcoming tunnel endpoint.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Special Considerations</h3>

<p>
</p>
<a name="NATCONSIDERATIONS"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
NATs and stateful firewalls </h3>

<p>Mechanisms described in <a class='info' href='#RFC3519'>MIP NAT
        traversal<span> (</span><span class='info'>Levkowetz, H. and S. Vaarala, &ldquo;Mobile IP Traversal of Network Address Translation (NAT) Devices,&rdquo; April&nbsp;2003.</span><span>)</span></a> [RFC3519] allow the Home Agent to be aware of mobile networks
        managed by a Mobile Router behind NAT. This information is passed on
        to the other Mobile Routers with the 'O' flag. In the case of one of
        the routers behing behind NAT or similarly impaired, the tunnel
        establishment procedure takes this into account.
</p>
<p>If Mobile Router and Correspondent Router are behind same NAT from
        HA's point of view, it is possible to establish tunnel between them.
        This may also be the situation in the case of nested NATs. This calls
        for development of some sort of "Route optimization discovery"
        protocol (see <a class='info' href='#EXTENSIBILITY'>Section&nbsp;6.5<span> (</span><span class='info'>Extensibility</span><span>)</span></a>) , or more
        information in the Route Optimization capability advertisements.
</p>
<p>If both the Mobile Router and the Correspondent Router are behind
        two separate NATs, some sort of proxy or hole-punching technique may
        be needed. This is out of scope of this draft.
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Foreign Agents</h3>

<p>Foreign Agents have to specifically support route optimization, ie.
        Return Routability procedure and establishment and maintenance of
        tunnel interfaces. Optionally, Mobile Router and Foreign Agent can
        have a trust relationship to ensure that security is not affected.
</p>
<p>In <a class='info' href='#RFC3344'>RFC 3344<span> (</span><span class='info'>Perkins, C., &ldquo;IP Mobility Support for IPv4,&rdquo; August&nbsp;2002.</span><span>)</span></a> [RFC3344], there are separate type
        codes for Authenticator extensions depending on the message being sent
        between Mobile Node and Home Agent, Mobile Node and Foreign Agent, or
        Foreign Agent and Home Agent. In this draft, all possible combinations
        (Mobile-Correspondent, Mobile-Foreign, Foreign-Correspondent) use same
        authenticator extension type code.
</p>
<a name="MULTIHOMEAGENTS"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Multiple Home Agents</h3>

<p>In fact, Mobile Routers can negotiate and perform route
        optimization without the assistance of Home Agent - if they can
        discover each others existence. This draft only addresses a single
        Home Agent that distributes network prefix information to the Mobile
        Routers. Problems arise from possible trust relationships; In this
        draft the Home Agent serves as a way to provide verification that a
        specific network is managed by a specific router. For host-routes
        (route optimization between single nodes), the requirements may not be
        so strict.
</p>
<p>Several possibilities exist for achieving Route Optimization
        between Mobile Routers attached to separate Home Agents, such as a
        discovery/probing protocol, routing protocol between Home Agents or
        DNS SRV records, or a common AAA architecture. There already is a
        framework for HA to retrieve information from AAA so it can be
        considered as the most viable possibility. See <a class='info' href='#EXTENSIBILITY'>Section&nbsp;6.5<span> (</span><span class='info'>Extensibility</span><span>)</span></a> for information on possibility to
        generalize the method.
</p>
<p>Any discovery/probing protocols are out of scope for this
        draft.
</p>
<a name="MUTUALNESS"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
Mutualness of Route Optimization</h3>

<p>The procedure as specified is asymmetric; That is, if bidirectional
        route optimization is desired while maintaining consistency, the route
        optimization (RR check and registration) has to be performed in both
        directions, but this is not strictly necessary. This is primarily a
        policy decision depending on how often the mobile prefixes are
        reconfigured.
</p>
<p>Consider the case where two networks, A and B, are handled by
        Mobile Routers A and B respectively. If the route optimization is
        triggered by receiving packet from a network in Route Optimization
        Cache, the following occurs if a node in network A starts pinging a
        node in network B.
</p>
<p>MR B sees the incoming message. It sees that the destination is in
        network B, and furthermore, source is in network A.
</p>
<p>MR B completes RR procedure and registration with MR A, which is
        now acting as Correspondent Router. A tunnel is created between the
        routers. MR A updates its routing table so that network B is reachable
        via MR A &lt;-&gt; MR B tunnel.
</p>
<p>The traffic pattern is now that packets from network B to network A
        are sent over the direct tunnel, but the packets from A to B are
        transmitted via the Home Agent and reverse tunnels. MR A now performs
        its own route optimization towards MR B. Upon completion, MR A notices
        that a tunnel to MR B already exists, but updates its routing table so
        that network B is now reachable via the MR A &lt;-&gt; MR B tunnel.
        From this point onward, traffic is bidirectional.
</p>
<p>In this scenario, if MR A does NOT perform a separate route
        optimization (RR check and registration), but instead simply updates
        its routing table to reach network B via the tunnel, problems may
        arise if MR B has started to manage another network B' before the
        information has propagated to MR A. The end result is that MR B starts
        to receive packets for network B' via the Home Agent and for network B
        via direct tunnel. If RPF checking or similar mechanism is in use on
        MR B, packets from network A could be blackholed.
</p>
<a name="EXTENSIBILITY"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.5"></a><h3>6.5.&nbsp;
Extensibility</h3>

<p>The design considerations include several mechanisms which might
        not be strictly necessary if Route Optimization would only be desired
        between individual customer sites in a managed network. The
        registration procedure (with the optional Return Routability part),
        which allows for Correspondent Routers to learn Mobile Router's
        Care-of Addresses is not strictly necessary; The CoA's could have been
        provided by HA directly.
</p>
<p>However, this approach allows the method to be extended to a more
        generic route optimization. The primary driver for having Home Agent
        to work as a centralized information distributer is to provide Mobile
        Routers with the knowledge of not only the other routers, but to
        provide information on which networks are managed by which
        routers.
</p>
<p>The Home Agent provides the information on all feasible nodes with
        which it is possible to establish Route Optimization. If representing
        a whole Mobile Network is not necessary, in effect the typical Mobile
        Node &lt;-&gt; Correspondent Node situation, the mechanisms in this
        draft work just as well - only problem is discovering if the target
        Correspondent Node can provide Route Optimization capability. This can
        be performed by not including any prefixes in the information
        extension, just the HoA address of Mobile Router.
</p>
<p>Correspondent node/router discovery protocols (whether they are
        based on probing or a centralized directory beyond the single Home
        Agent) are outside the scope of this draft.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Scalability</h3>

<p>Home Agent assisted Route Optimization scalability issues stem from
      the general Mobile IPv4 architecture which is based on tunnels.
      Creating, maintaining and destroying tunnel interfaces can cause load on
      the Mobile Routers. However, the MRs can always fall back to normal,
      reverse tunnelled routing if resource constraints are apparent.
</p>
<p>If there is a large number of optimization-capable prefixes,
      maintaining state for all of these may be an issue also, due to limits
      on routing table sizes.
</p>
<p>Registration responses from Home Agent to Mobile Router may provide
      information on large number of network prefixes. If thousands of
      networks are involved, the registration reply messages are bound to grow
      very large. The prefix- and realm compression mechanisms defined in
      <a class='info' href='#compressionsformats'>Section&nbsp;4<span> (</span><span class='info'>Data compression schemes</span><span>)</span></a> mitigates this problem to an
      extent. There will, however, be some practical upper limit after which
      point some other delivery mechanism for the prefix information will be
      needed.
</p>
<a name="examplesignals"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Example signaling scenarios</h3>

<p>
</p>
<a name="regreqexample"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.1"></a><h3>8.1.&nbsp;
Registration request</h3>

<p>The following example signaling assumes that there are three Mobile
        Routers, MR A, B, C, each managing network prefixes A, B, and C. At
        the beginning, no networks are registered to the Home Agent. Any AAA
        processing at the Home Agent is omitted from the diagram.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>+--------+ +--------+ +--------+ +--------------+
| [MR A] | | [MR B] | | [MR C] | | [Home Agent] |
+--------+ +--------+ +--------+ +--------------+
   |          |          |          |
   x-------------------------------&gt;|  Registration request,
   |          |          |          |  includes Mobile Router
   |          |          |          |  route optimization
   |          |          |          |  capability extension
   |          |          |          |
   |&lt;-------------------------------x  Registration response,
   |          |          |          |  no known networks from HA
   |          |          |          |  in response
   |          |          |          |
   |          x--------------------&gt;|  Registration request, similar
   |          |          |          |  to the one sent by MR A
   |          |          |          |
   |          |&lt;--------------------x  Registration reply, includes
   |          |          |          |  network A in route optimization
   |          |          |          |  prefix advertisement extension
   |          |          |          |
   |          |          x---------&gt;|  Registration request, similar
   |          |          |          |  the one sent by MR A
   |          |          |          |
   |          |          |&lt;---------x  Registration reply, includes
   |          |          |          |  networks A and B in route
   |          |          |          |  optimization prefix
   |          |          |          |  advertisement extension.
   |          |          |          |  Network B is sent in
   |          |          |          |  compressed form.
   |          |          |          |

</pre></div>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.2"></a><h3>8.2.&nbsp;
Route optimization with return routability</h3>

<p>The following example signaling has same network setup as in <a class='info' href='#regreqexample'>Section&nbsp;8.1<span> (</span><span class='info'>Registration request</span><span>)</span></a> - Three mobile routers, each
        corresponding to their respective network. Node A is in network A and
        Node C is in network C.
</p>
<p>At the beginning, no mobile routers know KRm's of each other. If
        the KRm's would be pre-shared or provisioned with some other method,
        the Return Routability messages can be omitted. Signaling in <a class='info' href='#regreqexample'>Section&nbsp;8.1<span> (</span><span class='info'>Registration request</span><span>)</span></a> has occured, thus MR A is not aware of
        the other networks, and MR C is aware of networks A and B.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
  ======= Traffic inside Mobile IP tunnel to/from HA
  =-=-=-= Traffic inside Mobile IP tunnel between MRs
  ------- Traffic outside Mobile IP tunnel

+----------+ +--------+ +------+ +--------+ +----------+
| [Node A] | | [MR A] | | [HA] | | [MR C] | | [Node C] |
+----------+ +--------+ +------+ +--------+ +----------+
   |            |          |         |       |
   |&lt;-----------O==========O=========O-------x  Mobile Router A is
   |            |          |         |       |  unaware of network C,
   |            |          |         |       |  thus, nothing happens
   |            |          |         |       |
   x------------O==========O=========O------&gt;|  Mobile Router C
   |            |          |         |       |  notices packet from
   |            |          |         |       |  Net A - inits RO
   |            |          |         |       |
   |            |          |         |       |  Return Routability
   |            |          |         |       |  (If no preshared KRms)
   |            |          |         |       |
   |            |&lt;=========O---------x       |  CoTI
   |            |&lt;=========O=========x       |  HoTI
   |            |          |         |       |
   |            x==========O--------&gt;|       |  CoT
   |            x==========O========&gt;|       |  HoT
   |            |          |         |       |
   |            |          |         |       |  KRm between MR A &lt;-&gt; C
   |            |          |         |       |  established
   |            |          |         |       |
   |            |&lt;=========O---------x       |  Registration request
   |            |          |         |       |
   |            x---------&gt;|         |       |  Registration request
   |            |          |         |       |  to HA due to MR A
   |            |          |         |       |  being unaware of
   |            |          |         |       |  network C.
   |            |          |         |       |  Solicit bit set.
   |            |          |         |       |
   |            |&lt;---------x         |       |  Registration reply,
   |            |          |         |       |  contains info on Net A
   |            |          |         |       |
   |            x==========O--------&gt;|       |  Registration reply,
   |            |          |         |       |  includes MR A's CoA in
   |            |          |         |       |  Care-of-Address
   |            |          |         |       |  extension
   |            |          |         |       |
   |&lt;-----------O=-=-=-==-=-=-=-==-=-O-------x  Packet from Node C -&gt; A
   |            |          |         |       |  routed to direct tunnel
   |            |          |         |       |  at MR C, based on
   |            |          |         |       |  MR C now knowing MR A's
   |            |          |         |       |  CoA and tunnel being up
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=-==-=-O------&gt;|  Packet from Node A -&gt; C
   |            |          |         |       |  routed to direct tunnel
   |            |          |         |       |  at MR A, based on MR A
   |            |          |         |       |  now knowing MR C's CoA
   |            |          |         |       |  and tunnel being up


</pre></div>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.3"></a><h3>8.3.&nbsp;
Handovers</h3>

<p>In these example signalings, MR C changes care-of-address while
        Route Optimization between MR A is operating and data is being
        transferred. Both cases where the handover is graceful ("make before
        break") and ungraceful ("break before make") occur in similar fashion,
        except in the graceful version no packets get lost.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>  ======= Traffic inside Mobile IP tunnel to/from HA
  =-=-=-= Traffic inside Mobile IP tunnel between MRs
  ------- Traffic outside Mobile IP tunnel

+----------+ +--------+ +------+ +--------+ +----------+
| [Node A] | | [MR A] | | [HA] | | [MR C] | | [Node C] |
+----------+ +--------+ +------+ +--------+ +----------+
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=-==-=-O------&gt;| Nodes A and C
   |&lt;-----------O=-=-=-==-=-=-=-==-=-O-------x exchanging traffic
   |            |          |         |       |
   |            |          xxxxxxxxxxx       | Break occurs: MR C
   |            |          |         |       | loses connectivity to
   |            |          |         |       | current attachment point
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=-&gt;    |       | Traffic from A -&gt; C
   |            |          |         |       | lost and
   |            |          |   x&lt;=-=-O-------x vice versa
   |            |          |         |       |
   |            |          |&lt;--------x       | MR C finds a new
   |            |          |         |       | point of attachment,
   |            |          |         |       | registers to HA, clears
   |            |          |         |       | routing tables
   |            |          |         |       |
   |            |          x--------&gt;|       | Registration reply
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=-&gt;    |       | Traffic from A -&gt; C
   |            |          |         |       | lost
   |&lt;-----------O==========O=========O-------| Traffic from C -&gt; A
   |            |          |         |       | sent via HA
   |            |          |         |       |
   |            |&lt;=========O---------x       | Registration request,
   |            |          |         |       | reusing still active KRm
   |            |          |         |       |
   |            x==========O--------&gt;|       | Registration reply
   |            |          |         |       |
   x------------O=-=-=-==-=-=-=-==-=-O------&gt;| Traffic from A -&gt; C
   |            |          |         |       | forwarded again
   |&lt;-----------O=-=-=-==-=-=-=-==-=-O-------x Traffic from C -&gt; A
   |            |          |         |       | switches back to direct
   |            |          |         |       | tunnel
   |            |          |         |       |
</pre></div>
<a name="IANA"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
IANA Considerations</h3>

<p>New Mobile IP header extension and message type values are needed for
      the messages and extensions listed in <a class='info' href='#MESSAGESANDEXTENSIONS'>Section&nbsp;5<span> (</span><span class='info'>New Mobile IPv4 messages and extensions</span><span>)</span></a>.
</p>
<p>Note to RFC Editor: this section may be removed on publication as an
      RFC.
</p>
<a name="Security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Security Considerations</h3>

<p>The Return Routability check has been established in the IPv6
      world.
</p>
<a name="TRUST"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10.1"></a><h3>10.1.&nbsp;
Trust relationships</h3>

<p>The network of trust relationships in Home Agent assisted Route
        Optimization solve the issues where arbitrary Correspondent Router can
        trust an arbitrary Mobile Router that it is indeed the proper route to
        reach an arbitrary mobile network.
</p>
<p>It is assumed that all Mobile Routers have a trust relationship
        with the Home Agent. Thus, they trust information provided by Home
        Agent.
</p>
<p>The Home Agent provides information matching Home Addresses and
        network prefixes. Each Mobile Router trusts this information.
</p>
<p>Mobile Routers may perform Return Routability procedure between
        each other. This creates a trusted association between Mobile Router
        Home Address and Care-of Address. The Mobile Router also claims to
        represent a specific network. This information is not trustworthy as
        such.
</p>
<p>The claim can be verified by checking the Home Address &lt;-&gt;
        network prefix information received, either earlier, or due to
        on-demand request, from the Home Agent. If they match, the Mobile
        Router's claim is authentic. If the network is considered trusted, a
        policy decision can be made to skip this check. Exact definitions on
        situations where such decision can be made are out of scope of this
        draft. The RECOMMENDED general practice is to perform the check.
</p>
<a name="Acknowledgements"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Acknowledgements</h3>

<p>Thanks to Jyrki Soini and Kari Laihonen for initial reviews.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3344">[RFC3344]</a></td>
<td class="author-text">Perkins, C., &ldquo;<a href="http://tools.ietf.org/html/rfc3344">IP Mobility Support for IPv4</a>,&rdquo; RFC&nbsp;3344, August&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3344.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3519">[RFC3519]</a></td>
<td class="author-text">Levkowetz, H. and S. Vaarala, &ldquo;<a href="http://tools.ietf.org/html/rfc3519">Mobile IP Traversal of Network Address Translation (NAT) Devices</a>,&rdquo; RFC&nbsp;3519, April&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3519.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5177">[RFC5177]</a></td>
<td class="author-text">Leung, K., Dommety, G., Narayanan, V., and A. Petrescu, &ldquo;<a href="http://tools.ietf.org/html/rfc5177">Network Mobility (NEMO) Extensions for Mobile IPv4</a>,&rdquo; RFC&nbsp;5177, April&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5177.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-mobileip-optim">[I-D.ietf-mobileip-optim]</a></td>
<td class="author-text">Perkins, C. and D. Johnson, &ldquo;<a href="http://tools.ietf.org/id/draft-ietf-mobileip-optim-11.txt">Route Optimization in Mobile IP</a>,&rdquo; September&nbsp;2001.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1035">[RFC1035]</a></td>
<td class="author-text">Mockapetris, P., &ldquo;<a href="http://tools.ietf.org/html/rfc1035">Domain names - implementation and specification</a>,&rdquo; STD&nbsp;13, RFC&nbsp;1035, November&nbsp;1987 (<a href="http://www.rfc-editor.org/rfc/rfc1035.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3543">[RFC3543]</a></td>
<td class="author-text">Glass, S. and M. Chandra, &ldquo;<a href="http://tools.ietf.org/html/rfc3543">Registration Revocation in Mobile IPv4</a>,&rdquo; RFC&nbsp;3543, August&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3543.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3775">[RFC3775]</a></td>
<td class="author-text">Johnson, D., Perkins, C., and J. Arkko, &ldquo;<a href="http://tools.ietf.org/html/rfc3775">Mobility Support in IPv6</a>,&rdquo; RFC&nbsp;3775, June&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3775.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Antti Makela</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">TeliaSonera
      Corporation.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.O.Box 777</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FIN-33101 Tampere</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FINLAND</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 40 824 4170</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:antti.makela@teliasonera.com">antti.makela@teliasonera.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jouni Korhonen</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">TeliaSonera
      Corporation.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.O.Box 970</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FIN-00051 Sonera</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FINLAND</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 40 534 4455</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jouni.korhonen@teliasonera.com">jouni.korhonen@teliasonera.com</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
