<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>LoWPAN simple fragment Recovery</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="LoWPAN simple fragment Recovery">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">6LoWPAN</td><td class="header">P. Thubert, Ed.</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Cisco</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">J. Hui</td></tr>
<tr><td class="header">Expires: September 29, 2009</td><td class="header">Arch Rock Corporation</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">March 28, 2009</td></tr>
</table></td></tr></table>
<h1><br />LoWPAN simple fragment Recovery<br />draft-thubert-6lowpan-simple-fragment-recovery-04</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on September 29, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>

 	    Considering that 6LoWPAN packets can be as large as 2K bytes and that
	    an 802.15.4 frame with security will carry in the order of 80 bytes of effective payload,
	    a packet might end up fragmented into as many as 25 fragments at the 6LoWPAN shim layer.
	    If a single one of those fragments is lost in transmission, all fragments must be resent,
		further contributing to the congestion that might have
	    caused the initial packet loss. This draft introduces a simple protocol 
		to recover individual fragments that might be lost over multiple hops between 6LoWPAN endpoints.
	  
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#introduction">1.</a>&nbsp;
Introduction<br />
<a href="#anchor1">2.</a>&nbsp;
Terminology<br />
<a href="#rationale">3.</a>&nbsp;
Rationale<br />
<a href="#req">4.</a>&nbsp;
Requirements<br />
<a href="#overview">5.</a>&nbsp;
Overview<br />
<a href="#dispatch">6.</a>&nbsp;
New Dispatch types and headers<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#RF">6.1.</a>&nbsp;
Recoverable Fragment Dispatch type and Header<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#ackfrag">6.2.</a>&nbsp;
Fragment Acknowledgement Dispatch type and Header<br />
<a href="#ffc">7.</a>&nbsp;
Fragments Recovery<br />
<a href="#anchor2">8.</a>&nbsp;
Security Considerations<br />
<a href="#anchor3">9.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor4">10.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">11.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">11.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">11.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="introduction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>
	    In many 6LoWPAN applications, the majority of traffic is
	    spent sending small chunks of data (order few bytes to few
	    tens of bytes) per packet. Given that an 802.15.4 frame
	    can carry on the order of 80 bytes in the worst case,
	    fragmentation is often not needed for most application
	    traffic. However, many applications also require
	    occasional bulk data transfer capabilities to support
	    firmware upgrades of 6LoWPAN devices or extraction of logs
	    from 6LoWPAN devices. In the former case, bulk data is
	    transferred to the 6LoWPAN device, and in the latter, bulk
	    data flows away from the 6LoWPAN device. In both cases,
	    the bulk data size is often on the order of 10K bytes or
	    more and end-to-end reliable transport is required.
	  
</p>
<p>
	    Mechanisms such as TCP or application-layer segmentation
	    will be used to support end-to-end reliable transport. One
	    option to support bulk data transfer over 6LoWPAN links is
	    to set the Maximum Segment Size to fit within the 802.15.4
	    MTU. Doing so, however, can add significant header
	    overhead to each 802.15.4 frame. 

 

This causes the end-to-end transport to be aware of the delivery
properties of 6LoWPAN networks, which is a layer violation.


</p>
<p>
	    An alternative mechanism combines the use of 6LoWPAN
	    fragmentation in addition to transport or
	    application-layer segmentation. Increasing the Maximum
	    Segment Size reduces header overhead by the end-to-end
	    transport protocol. It also encourages the transport
	    protocol to reduce the number of outstanding datagrams,
	    ideally to a single datagram, thus reducing the need to
	    support out-of-order delivery common to 6LoWPAN networks.
	  
</p>
<p>
	    <a class='info' href='#RFC4944'>[RFC4944]<span> (</span><span class='info'>Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler, &ldquo;Transmission of IPv6 Packets over IEEE 802.15.4 Networks,&rdquo; September&nbsp;2007.</span><span>)</span></a> defines a datagram fragmentation
	    mechanism for 6LoWPAN networks. However, because
	    <a class='info' href='#RFC4944'>[RFC4944]<span> (</span><span class='info'>Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler, &ldquo;Transmission of IPv6 Packets over IEEE 802.15.4 Networks,&rdquo; September&nbsp;2007.</span><span>)</span></a> does not define a mechanism for
	    recovering fragments that are lost, datagram forwarding
	    fails if even one fragment is not delivered properly to
	    the next IP hop. End-to-end transport mechanisms will
	    require retransmission of all fragments, wasting resources
	    in an already resource-constrained network.
	  
</p>
<p>
	  	
		Past experience with fragmentation has shown that
		missassociated or lost fragments can lead to poor network behavior and,
		eventually, trouble at application layer. The reader is encouraged to read
		<a class='info' href='#RFC4963'>[RFC4963]<span> (</span><span class='info'>Heffner, J., Mathis, M., and B. Chandler, &ldquo;IPv4 Reassembly Errors at High Data Rates,&rdquo; July&nbsp;2007.</span><span>)</span></a> and follow the references for more information. 
		That experience led to the definition of <a class='info' href='#RFC1191'>the
		Path MTU discovery<span> (</span><span class='info'>Mogul, J. and S. Deering, &ldquo;Path MTU discovery,&rdquo; November&nbsp;1990.</span><span>)</span></a> [RFC1191] protocol that limits fragmentation over the Internet. 
	  
</p>
<p>
	  	 
		For one-hop communications, a number of media propose a local acknowledgement mechanism that is enough to
		protect the fragments. In a multihop environment, an end-to-end fragment recovery mechanism might be a good complement to a 
		hop-by-hop MAC level recovery.
	    This draft introduces a simple protocol to recover individual fragments between 6LoWPAN endpoints.
		 Specifically in the case of UDP, valuable additional information can be found in
		 <a class='info' href='#I-D.ietf-tsvwg-udp-guidelines'>UDP Usage Guidelines for Application Designers<span> (</span><span class='info'>Eggert, L. and G. Fairhurst, &ldquo;Unicast UDP Usage Guidelines for Application Designers,&rdquo; October&nbsp;2008.</span><span>)</span></a> [I&#8209;D.ietf&#8209;tsvwg&#8209;udp&#8209;guidelines].
	  
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL",
            "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY",
            and "OPTIONAL" in this document are to be interpreted as
            described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<p>Readers are expected to be familiar with all the terms and concepts
	    that are discussed in <a class='info' href='#RFC4919'>"IPv6 over Low-Power
	    Wireless Personal Area Networks (6LoWPANs): Overview, Assumptions,
	    Problem Statement, and Goals"<span> (</span><span class='info'>Kushalnagar, N., Montenegro, G., and C. Schumacher, &ldquo;IPv6 over Low-Power Wireless Personal Area Networks (6LoWPANs): Overview, Assumptions, Problem Statement, and Goals,&rdquo; August&nbsp;2007.</span><span>)</span></a> [RFC4919] and <a class='info' href='#RFC4944'>"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"<span> (</span><span class='info'>Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler, &ldquo;Transmission of IPv6 Packets over IEEE 802.15.4 Networks,&rdquo; September&nbsp;2007.</span><span>)</span></a> [RFC4944].
           
</p>
<p>
	   </p>
<blockquote class="text"><dl>
<dt>ERP</dt>
<dd>
</dd>
<dt></dt>
<dd>Error Recovery Procedure.
	    
</dd>
<dt>LoWPAN endpoints</dt>
<dd>
</dd>
<dt></dt>
<dd>The LoWPAN nodes in charge of generating or expanding a 6LoWPAN header from/to a full IPv6 packet.
		The LoWPAN endpoints are the points where fragmentation and reassembly take place.
		
	    
</dd>
</dl></blockquote><p>
		
</p>
<a name="rationale"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Rationale</h3>

<p>

	  There are a number of usages for large packets in Wireless Sensor Networks. Such usages
	  may not be the most typical or represent the largest amount of traffic over the LoWPAN;
	  however, the associated functionality can be critical enough to justify extra care for 
	  ensuring effective transport of large packets across the LoWPAN.
	  
</p>
<p>
	  The list of those usages includes:
          </p>
<blockquote class="text"><dl>
<dt>Towards the LoWPAN node:</dt>
<dd>
		 
          
<blockquote class="text"><dl>
<dt>Packages of Commands:</dt>
<dd>
	       A number of commands or a full configuration can by packaged as a single message
	       to ensure consistency and enable atomic execution or complete roll back. 
		   Until such commands are fully received and interpreted, the intended operation will not take effect.
	     
</dd>
<dt>Firmware update:</dt>
<dd>
	       For example, a new version of the LoWPAN node software is downloaded from a system
		   manager over unicast or multicast services.
		   Such a reflashing operation typically involves updating a large number of similar
		   6LoWPAN nodes over a relatively short period of time.
		 
</dd>
</dl></blockquote>
		
	     
</dd>
<dt>From the LoWPAN node:</dt>
<dd>
        
<blockquote class="text"><dl>
<dt>Waveform captures:</dt>
<dd>
	       A number of consecutive samples are measured at a high rate for a short time and then transferred
		   from a sensor to a gateway or an edge server as a single large report.
	     
</dd>
<dt>Data logs:</dt>
<dd>
	       6LoWPAN nodes may generate large logs of sampled data
	       for later extraction. 6LoWPAN nodes may also generate
	       system logs to assist in diagnosing problems on the
	       node or network.
	     
</dd>
<dt>Large data packets:</dt>
<dd>
	       Rich data types might require more than one fragment.		   
	     
</dd>
</dl></blockquote>
		
	     
</dd>
</dl></blockquote><p>
	  
</p>
<p>
		   Uncontrolled firmware download or waveform upload can easily result in a massive 
		   increase of the traffic and saturate the network. 
		
</p>
<p>
		   When a fragment is lost in transmission, all fragments are resent, further contributing
	       to the congestion that caused the initial loss, and potentially leading to congestion collapse.
		   
	  
</p>
<p>
		   This saturation may lead to excessive radio interference, or random early discard 
		   (leaky bucket) in relaying nodes. Additional queuing and memory congestion may
		   result while waiting for a low power next hop to emerge from its sleeping state.
		   
			   
	  
</p>
<p>
	    To demonstrate the severity of the problem, consider a
	    fairly reliable 802.15.4 frame delivery rate of 99.9% over
	    a single 802.15.4 hop. The expected delivery rate of a
	    5-fragment datagram would be about 99.5% over a single
	    802.15.4 hop. However, the expected delivery rate would
	    drop to 95.1% over 10 hops, a reasonable network diameter
	    for 6LoWPAN applications. The expected delivery rate for a
	    1280-byte datagram is 98.4% over a single hop and 85.2%
	    over 10 hops.
	  
</p>
<p>
 	    Considering that 6LoWPAN packets can be as large as 2K bytes and that
	    a 802.15.4 frame with security will carry in the order of 80 bytes of effective payload,
	    a packet might be fragmented into about 25 fragments at the 6LoWPAN shim layer.
		This level of fragmentation is much higher than that traditionally experienced over the 
		Internet with IPv4 fragments.
	    At the same time, the use of radios increases the probability of transmission loss
        and	Mesh-Under techniques compound that risk over multiple hops. 
		
		
		
	  
</p>
<a name="req"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Requirements</h3>

<p>
	      This paper proposes a method to recover individual fragments between LoWPAN endpoints. The
		  method is designed to fit the following requirements of a LoWPAN (with or without a Mesh-Under 
		  routing protocol):
		  
	   </p>
<blockquote class="text"><dl>
<dt>Number of fragments</dt>
<dd>
</dd>
<dt></dt>
<dd>The recovery mechanism must support highly fragmented packets, with a maximum of 32 fragments per packet.
	   
</dd>
<dt>Minimum acknowledgement overhead</dt>
<dd>
</dd>
<dt></dt>
<dd> Because the radio is half duplex, and because of silent time spent in the 
	   various medium access mechanisms, an acknowledgment consumes roughly as many resources as data fragment.  
	    
</dd>
<dt></dt>
<dd>The recovery mechanism should be able to acknowledge multiple fragments in a single message and
		not require an acknowledgement at all if fragments are already protected at a lower layer.
		
</dd>
<dt>Controlled latency</dt>
<dd>
</dd>
<dt></dt>
<dd>The recovery mechanism must succeed or give up within the time boundary imposed by the recovery process 
	   of the Upper Layer Protocols. 
	   
</dd>
<dt>Support for out-of-order fragment delivery</dt>
<dd>
</dd>
<dt></dt>
<dd> A Mesh-Under load balancing mechanism such as the ISA100 Data Link Layer can introduce out-of-sequence packets.
</dd>
<dt></dt>
<dd>The recovery mechanism must account for packets that appear lost but are actually only delayed over a different path.
	    
</dd>
<dt>Optional congestion control</dt>
<dd>
</dd>
<dt></dt>
<dd> The aggregation of multiple concurrent flows may lead to the saturation of the radio network and congestion collapse.
		
</dd>
<dt></dt>
<dd>The recovery mechanism should provide means for controlling the number of fragments in transit over the LoWPAN.
	    
</dd>
</dl></blockquote><p>
	    
</p>
<a name="overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Overview</h3>

<p>Considering that a multi-hop LoWPAN can be a very sensitive environment
	due to the limited queuing capabilities of a
	large population of its nodes, this draft recommends a simple and
	conservative approach to congestion control, based on TCP congestion avoidance.
	
</p>
<p>	From the standpoint of a source LoWPAN endpoint, an outstanding fragment is a fragment that was
	sent but for which no explicit acknowledgment was received yet. 
	This means that the fragment might be on the way, received but not yet acknowledged, 
	or the acknowledgment might be on the way back. It is also possible that either
	the fragment or the acknowledgment was lost on the way.
	
</p>
<p>Because a meshed LoWPAN might deliver frames out of order, it is virtually
	impossible to differentiate these situations. In other words, from the sender standpoint,
	all outstanding fragments might still be in the network and contribute to its congestion.
	There is an assumption, though, that after a certain amount of time, a frame is either received
    or lost, so it is not causing congestion anymore. This amount of time can be estimated based on the round trip
	delay between the LoWPAN endpoints. The method detailed in <a class='info' href='#RFC2988'>[RFC2988]<span> (</span><span class='info'>Paxson, V. and M. Allman, &ldquo;Computing TCP's Retransmission Timer,&rdquo; November&nbsp;2000.</span><span>)</span></a> is recommended for that computation.
	
</p>
<a name="dispatch"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
New Dispatch types and headers</h3>

<p>This specification extends <a class='info' href='#RFC4944'>"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"<span> (</span><span class='info'>Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler, &ldquo;Transmission of IPv6 Packets over IEEE 802.15.4 Networks,&rdquo; September&nbsp;2007.</span><span>)</span></a> [RFC4944]
	with 4 new dispatch types, for Recoverable Fragments (RFRAG)	
	headers with or without Acknowledgment Request, and for the Acknowledgment 
	back.

</p><br /><hr class="insert" />
<a name="difig"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
           Pattern    Header Type
         +------------+-----------------------------------------------+
         | 11  101000 | RFRAG      - Recoverable Fragment             |
         | 11  101001 | RFRAG-AR   - RFRAG with Ack Request           |
         | 11  10101x | RFRAG-ACK  - RFRAG Acknowledgment             |
         +------------+-----------------------------------------------+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Additional Dispatch Value Bit Patterns&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
	In the following sections, the semantics of "datagram_tag,"
	"datagram_offset" and "datagram_size" and the reassembly process
	are unchanged from 	<a class='info' href='#RFC4944'>[RFC4944]<span> (</span><span class='info'>Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler, &ldquo;Transmission of IPv6 Packets over IEEE 802.15.4 Networks,&rdquo; September&nbsp;2007.</span><span>)</span></a> Section 5.3. 
	"Fragmentation Type and Header."
	
</p>
<p>
	
</p>
<a name="RF"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
Recoverable Fragment Dispatch type and Header</h3>
<br /><hr class="insert" />
<a name="RFfig"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                           1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |1 1 1 0 1 0 0 X|datagram_offset|         datagram_tag          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |Sequence |    datagram_size    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                                                 X set == Ack Requested

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Recoverable Fragment Dispatch type and Header&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
	   </p>
<blockquote class="text"><dl>
<dt>X bit</dt>
<dd>
</dd>
<dt></dt>
<dd>When set, the sender requires an Acknowledgment from the receiver
	    
</dd>
<dt>Sequence</dt>
<dd>
</dd>
<dt></dt>
<dd>The sequence number of the fragment. Fragments are numbered [0..N] where N is in [0..31].
		
	    
</dd>
</dl></blockquote><p>
		
</p>
<a name="ackfrag"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Fragment Acknowledgement Dispatch type and Header</h3>
<br /><hr class="insert" />
<a name="ackfig"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                           1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
                      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      |1 1 1 0 1 0 1 Y|         datagram_tag          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |           Acknowledgment Bitmap                              |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       ^                   ^
       |                   |            Y is reserved
       |                   |
       |                   |        bitmap indicating whether
       |                   +-----Fragment with sequence 10 was received
       +-------------------------Fragment with sequence 00 was received

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Fragment Acknowledgement Dispatch type and Header&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>
	   </p>
<blockquote class="text"><dl>
<dt>Y bit</dt>
<dd>
</dd>
<dt></dt>
<dd>Reserved.
</dd>
<dt>Acknowledgement Bitmap</dt>
<dd>
</dd>
<dt></dt>
<dd>Each bit in the Bitmap refers to a particular fragment:
		bit n set indicates that fragment with sequence n was received, for n in [0..31].
		
</dd>
<dt></dt>
<dd>A NULL bitmap (All zeroes) means that the fragment was dropped . 
	    
</dd>
</dl></blockquote><p>
		
</p>
<a name="ffc"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Fragments Recovery</h3>

<p>	The node that fragments the packets at 6LoWPAN level (the sender) controls the  
	Fragment Acknowledgements. If may do that at any fragment to implement its own
	policy or perform congestion control which is out of scope for this document.
	When the sender of the fragment knows that an underlying mechanism protects the 
	Fragments already it MAY refrain from using the Acknowledgement mechanism, and
	never set the Ack Requested bit. The node that recomposes the packets at 6LoWPAN 
	level (the receiver) MUST acknowledge the fragments it has received when asked
	to, and MAY slightly defer that acknowledgement.

	
</p>
<p> 
	The sender transfers a controlled number of fragments and MAY flag the last
	fragment of a series with an acknowledgment request. The received MUST acknowledge a 
	fragment with the acknowledgment request bit set. If any fragment immediately preceding
	an acknowledgment request is still missing, the receiver MAY intentionally 
	delay its acknowledgment to allow in-transit fragments to arrive. delaying the acknowledgement
	might defeat the round trip delay computation so it should be configurable and not enabled 
	by default.
	
</p>
<p>The receiver interacts with the sender using an Acknowledgment message with a bitmap that 
	indicates which fragments were actually received. 
	The bitmap is a 32bit SWORD, which accommodates up to 32 fragments and is sufficient for the 6LoWPAN MTU.
	For all n in [0..31], bit n is set to 1 in the bitmap to indicate that fragment with sequence n was received, 
	otherwise the bit is set to 0. All zeroes is a NULL bitmap that indicates that the fragmentation
	process was cancelled by the receiver for that datagram.
	
</p>
<p>The receiver MAY issue unsolicited acknowledgments. An unsolicited acknowledgment
	enables the sender endpoint to resume sending if it had reached its maximum number
	of outstanding fragments or indicate that the receiver has cancelled the process of an individual
	datagram. Note that acknowledgments might consume precious resources so the use of unsolicited
	acknowledgments should be configurable and not enabled by default.
	
</p>
<p> 
	The sender arms a retry timer to cover the fragment that carries the Acknowledgment request. 
	Upon time out, the sender assumes that all the fragments on the way are received or lost. 
	The process must completed within an acceptable time that is within the boundaries of 
	upper layer retries. The method detailed in <a class='info' href='#RFC2988'>[RFC2988]<span> (</span><span class='info'>Paxson, V. and M. Allman, &ldquo;Computing TCP's Retransmission Timer,&rdquo; November&nbsp;2000.</span><span>)</span></a> is recommended for the 
	computation of the retry timer. It is expected that the upper layer retries obey the same or 
	friendly rules in which case a single round of fragment recovery should fit within the upper 
	layer recovery timers.
	
</p>
<p>Fragments are sent in a round robin fashion: the sender sends all the fragments for a first time
	before it retries any lost fragment; lost fragments are retried in sequence, oldest first. 
	This mechanism enables the receiver to acknowledge fragments that were delayed in the network
	before they are actually retried.
	
</p>
<p>When the sender decides that a packet should be dropped and the fragmentation process canceled, it sends a 
	pseudo fragment with the datagram_offset, sequence and datagram_size all set to zero, and no data.
	Upon reception of this message, the receiver should clean up all resources for the packet
	associated to the datagram_tag. If an acknowledment is requested, the receiver responds with a NULL bitmap.
	
</p>
<p>The receiver might need to cancel the process of a fragmented packet for internal reasons, for instance if
	it is out of recomposition buffers, or considers that this packet is already fully recomposed and passed
	to the upper layer. In that case, the receiver SHOULD indicate so to the sender with a NULL bitmap.
	Upon an acknowledgement with a NULL bitmap, the sender MUST drop the datagram.
	
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>	The process of recovering fragments does not appear to create any opening for new threat compared to
	<a class='info' href='#RFC4944'>"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"<span> (</span><span class='info'>Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler, &ldquo;Transmission of IPv6 Packets over IEEE 802.15.4 Networks,&rdquo; September&nbsp;2007.</span><span>)</span></a> [RFC4944].
	
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
IANA Considerations</h3>

<p>Need extensions for formats defined in <a class='info' href='#RFC4944'>"Transmission of IPv6 Packets over IEEE 802.15.4 Networks"<span> (</span><span class='info'>Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler, &ldquo;Transmission of IPv6 Packets over IEEE 802.15.4 Networks,&rdquo; September&nbsp;2007.</span><span>)</span></a> [RFC4944].
		
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
Acknowledgments</h3>

<p>The author wishes to thank Jay Werb, Christos Polyzois, Soumitri Kolavennu and Harry Courtice for their contribution and review.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2988">[RFC2988]</a></td>
<td class="author-text">Paxson, V. and M. Allman, &ldquo;<a href="http://tools.ietf.org/html/rfc2988">Computing TCP's Retransmission Timer</a>,&rdquo; RFC&nbsp;2988, November&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2988.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4944">[RFC4944]</a></td>
<td class="author-text">Montenegro, G., Kushalnagar, N., Hui, J., and D. Culler, &ldquo;<a href="http://tools.ietf.org/html/rfc4944">Transmission of IPv6 Packets over IEEE 802.15.4 Networks</a>,&rdquo; RFC&nbsp;4944, September&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4944.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>11.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-tsvwg-udp-guidelines">[I-D.ietf-tsvwg-udp-guidelines]</a></td>
<td class="author-text">Eggert, L. and G. Fairhurst, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tsvwg-udp-guidelines-11.txt">Unicast UDP Usage Guidelines for Application Designers</a>,&rdquo; draft-ietf-tsvwg-udp-guidelines-11 (work in progress), October&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-tsvwg-udp-guidelines-11.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.mathis-frag-harmful">[I-D.mathis-frag-harmful]</a></td>
<td class="author-text">Mathis, M., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-mathis-frag-harmful-00.txt">Fragmentation Considered Very Harmful</a>,&rdquo; draft-mathis-frag-harmful-00 (work in progress), July&nbsp;2004 (<a href="http://www.ietf.org/internet-drafts/draft-mathis-frag-harmful-00.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC1191">[RFC1191]</a></td>
<td class="author-text"><a href="mailto:mogul@decwrl.dec.com">Mogul, J.</a> and <a href="mailto:deering@xerox.com">S. Deering</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc1191">Path MTU discovery</a>,&rdquo; RFC&nbsp;1191, November&nbsp;1990 (<a href="http://www.rfc-editor.org/rfc/rfc1191.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2309">[RFC2309]</a></td>
<td class="author-text"><a href="mailto:Braden@ISI.EDU">Braden, B.</a>, <a href="mailto:DDC@lcs.mit.edu">Clark, D.</a>, <a href="mailto:Jon.Crowcroft@cs.ucl.ac.uk">Crowcroft, J.</a>, <a href="mailto:bdavie@cisco.com">Davie, B.</a>, <a href="mailto:deering@cisco.com">Deering, S.</a>, <a href="mailto:Estrin@usc.edu">Estrin, D.</a>, <a href="mailto:Floyd@ee.lbl.gov">Floyd, S.</a>, <a href="mailto:Van@ee.lbl.gov">Jacobson, V.</a>, <a href="mailto:Minshall@fiberlane.com">Minshall, G.</a>, <a href="mailto:craig@bbn.com">Partridge, C.</a>, <a href="mailto:LLP@cs.arizona.edu">Peterson, L.</a>, <a href="mailto:KKRama@research.att.com">Ramakrishnan, K.</a>, <a href="mailto:Shenker@parc.xerox.com">Shenker, S.</a>, <a href="mailto:JTW@lcs.mit.edu">Wroclawski, J.</a>, and <a href="mailto:Lixia@cs.ucla.edu">L. Zhang</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2309">Recommendations on Queue Management and Congestion Avoidance in the Internet</a>,&rdquo; RFC&nbsp;2309, April&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2309.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2309.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2309.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2581">[RFC2581]</a></td>
<td class="author-text"><a href="mailto:mallman@grc.nasa.gov">Allman, M.</a>, <a href="mailto:vern@aciri.org">Paxson, V.</a>, and <a href="mailto:rstevens@kohala.com">W. Stevens</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2581">TCP Congestion Control</a>,&rdquo; RFC&nbsp;2581, April&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2581.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2914">[RFC2914]</a></td>
<td class="author-text">Floyd, S., &ldquo;<a href="http://tools.ietf.org/html/rfc2914">Congestion Control Principles</a>,&rdquo; BCP&nbsp;41, RFC&nbsp;2914, September&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2914.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3168">[RFC3168]</a></td>
<td class="author-text">Ramakrishnan, K., Floyd, S., and D. Black, &ldquo;<a href="http://tools.ietf.org/html/rfc3168">The Addition of Explicit Congestion Notification (ECN) to IP</a>,&rdquo; RFC&nbsp;3168, September&nbsp;2001 (<a href="http://www.rfc-editor.org/rfc/rfc3168.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4919">[RFC4919]</a></td>
<td class="author-text">Kushalnagar, N., Montenegro, G., and C. Schumacher, &ldquo;<a href="http://tools.ietf.org/html/rfc4919">IPv6 over Low-Power Wireless Personal Area Networks (6LoWPANs): Overview, Assumptions, Problem Statement, and Goals</a>,&rdquo; RFC&nbsp;4919, August&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4919.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4963">[RFC4963]</a></td>
<td class="author-text">Heffner, J., Mathis, M., and B. Chandler, &ldquo;<a href="http://tools.ietf.org/html/rfc4963">IPv4 Reassembly Errors at High Data Rates</a>,&rdquo; RFC&nbsp;4963, July&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4963.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Pascal Thubert (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco Systems</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Village d'Entreprises Green Side</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">400, Avenue de Roumanille</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Batiment T3</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Biot - Sophia Antipolis  06410</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FRANCE</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+33 4 97 23 26 34</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:pthubert@cisco.com">pthubert@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jonathan W. Hui</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Arch Rock Corporation</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">501 2nd St. Ste. 410</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Francisco, California  94107</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+415 692 0828</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jhui@archrock.com">jhui@archrock.com</a></td></tr>
</table>
</body></html>
