<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>The Use of Entropy Labels in MPLS Forwarding</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="The Use of Entropy Labels in MPLS Forwarding">
<meta name="keywords" content="Internet-Draft, entropy hash ecmp load balancing">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">K. Kompella</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">Juniper Networks</td></tr>
<tr><td class="header">Updates: <a href='http://tools.ietf.org/html/rfc3031'>3031</a> (if&nbsp;approved)</td><td class="header">S. Amante</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">Level 3 Communications, LLC</td></tr>
<tr><td class="header">Expires: January 14, 2011</td><td class="header">July 13, 2010</td></tr>
</table></td></tr></table>
<h1><br />The Use of Entropy Labels in MPLS Forwarding<br />draft-kompella-mpls-entropy-label-01</h1>

<h3>Abstract</h3>

<p>
	Load balancing is a powerful tool for engineering traffic
	across a network.  This memo suggests ways of improving load
	balancing across MPLS networks using the notion of "entropy
	labels".  It defines the concept, describes why they are
	needed, suggests how they can be used, and enumerates
	properties of entropy labels that allow optimal benefit.
	
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on January 14, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#intro">1.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor1">1.1.</a>&nbsp;
Motivation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#conv">1.2.</a>&nbsp;
Conventions used<br />
<a href="#anchor2">2.</a>&nbsp;
Approaches<br />
<a href="#anchor3">3.</a>&nbsp;
Entropy Labels<br />
<a href="#anchor4">4.</a>&nbsp;
Forwarding and Load Balancing Behaviors for Entropy Labels<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">4.1.</a>&nbsp;
Ingress LSR<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">4.2.</a>&nbsp;
Transit LSR<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">4.3.</a>&nbsp;
Egress LSRs<br />
<a href="#sig">5.</a>&nbsp;
Signaling for Entropy Labels<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">5.1.</a>&nbsp;
LDP Signaling<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">5.1.1.</a>&nbsp;
Structure of Entropy Label sub-TLV<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">5.2.</a>&nbsp;
RSVP Signaling<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor11">5.3.</a>&nbsp;
BGP Signaling<br />
<a href="#anchor12">6.</a>&nbsp;
MPLS-TP and Entropy Labels<br />
<a href="#sec-con">7.</a>&nbsp;
Security Considerations<br />
<a href="#anchor13">8.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor14">9.</a>&nbsp;
Acknowledgments<br />
<a href="#rfc.references1">10.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">10.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">10.2.</a>&nbsp;
Informative References<br />
<a href="#anchor17">Appendix&nbsp;A.</a>&nbsp;
Applicability of LDP Entropy Label sub-TLV<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="intro"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>
    Load balancing, or multi-pathing, is an attempt to balance traffic
    across a network by allowing the traffic to use several paths, not
    just a single shortest path.  Load balancing has several benefits: 
    it eases capacity planning; it can help absorb traffic surges by
    spreading them across several links; it allow better resilience by
    offering alternate paths should a link or node fail.  
    
</p>
<p>
    As providers scale their networks, they resort to a small number of
    techniques to achieve greater bandwidth between nodes and,
    subsequently, depend on load-balancing of traffic over those paths.
    Two widely used techniques are: Link Aggregation (LAG) and
    Equal-Cost Multi-Path (ECMP). LAG is only used to bond together
    several physical circuits between two adjacent nodes so they appear
    to higher-layer protocols as a single, higher bandwidth "virtual"
    pipe. On the other hand, ECMP is used between two nodes, separated
    by one or more hops, to allow load-sharing over more than just the
    shortest path in the network -- this is typically obtained by
    arranging IGP metrics such that there are several equal cost paths
    between source-destination pairs.  In summary, both of these
    techniques may, and oftentimes do, co-exist in various parts of a
    given providers network, depending on various choices made by the
    provider.
    
</p>
<p>
    A very important consideration when load balancing is that packets
    belonging to a given "flow" MUST be mapped to the same path, i.e.,
    the same exact sequence of links across the network.  This is to
    avoid jitter, latency and re-ordering issues for the flow.
    However, what constitutes a flow varies considerably.  A common
    example of a flow is a TCP session.  Other examples are L2TP
    sessions corresponding to broadband users, or traffic within an
    ATM virtual circuit.  A flow is usually defined, for the purposes
    of forwarding and load balancing, by a hash computed on packet
    headers such that packets belonging to a given flow map to the
    same hash value.  The fields chosen for such a hash depend on the
    packet type; a typical set (for IP packets) is the IP source and
    destination address, the protocol type, and (for TCP and UDP
    traffic) the source and destination port numbers.  A conservative
    choice of fields leads to many flows mapping to the same hash
    value (and consequently poor load balancing); an overly aggressive
    choice may map a flow to multiple values, potentially causing the
    issues mentioned above.
    
</p>
<p>
    For MPLS networks, most of the same principles (and benefits)
    apply.  However, finding useful fields in a packet for the purpose
    of load balancing can be more of a challenge.  In many cases, the
    extra encapsulation may require fairly deep inspection of packets
    to find these fields at every hop.  An idea for removing the need
    for this deep inspection is to extract this information *once*, at
    the ingress of an MPLS Label Switched Path (LSP), and encode,
    within the label stack itself, in addition to the forwarding
    semantics of the label stack, the load balancing information.
    This information can then be used on all MPLS hops across the
    network.  There are three key reasons why this is beneficial:
	</p>
<ol class="text">
<li>
	    at the ingress of the LSP, MPLS encapsulation hasn't yet
	    occurred, so deep inspection is not necessary;
	    
</li>
<li>
	    the ingress of an LSP has more context and information
	    about incoming packets than transit nodes; and
	    
</li>
<li>
	    ingress nodes usually operate at lower bandwidths than
	    transit nodes, allowing them to do more work per packet.
	    
</li>
</ol><p>
    
</p>
<p>
    This memo describes a few approaches to solving this problem, and
    focuses on one method, which uses the notion of entropy labels.
    This memo goes on to define entropy labels, and describes why they
    are needed, and the properties of entropy labels in the forwarding
    plane: how they are generated and received and what is expected of
    transit Label Switching Routers (LSRs).  Finally, it describes in
    general how signaling works and what needs to be signaled, as well
    as specifics for LDP.
    
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
Motivation</h3>

<p>
    MPLS is very successful generic forwarding substrate that may
    transport several dozen types of protocols, most notably: IP, PWE3,
    VPLS and IP VPN's.  Within each type of protocol, there typically
    exist several variants as it relates to load-sharing, e.g.: IP: 
    IPv4, IPv6, IPv6 in IPv4, etc.; PWE3: Ethernet, ATM, Frame-Relay, 
    etc.  There are also several different types of Ethernet over PW 
    encapsulation, ATM over PW encapsulation, etc. as well.  Finally,
    given the popularity of MPLS, it is likely that it will continue 
    to be extended to transport new protocols as the need arises.
    
</p>
<p>
    Currently, each MPLS LSR along a given path needs to individually
    infer the underlying protocol within a MPLS packet in order to then
    extract appropriate keys from the payload.  Those keys are then used
    as input into a hash algorithm to determine the specific output
    interface on a LSR that is used for that given "microflow".
    Unfortunately, if the MPLS LSR is unable to infer the MPLS packet's
    payload (as is often the case), they typically will resort to using
    the topmost MPLS labels in the MPLS stack as keys to the
    load-hashing algorithm.  The result is an extremely inequitable
    distribution of traffic across multiple equal-cost paths exiting
    that node, simply because the topmost MPLS labels are very
    coarse-grained forwarding labels that typically describe a next-hop, 
    or provide some other type of mux/demux forwarding function, and 
    do not describe the granularity of the underlying traffic.
    
</p>
<p>
    On the other hand, ingress MPLS LER's (PE routers) have detailed
    knowledge of an MPLS packet's contents, typically through a priori
    configuration of encapsulation(s) that are expected at a given PE-CE
    interface, (e.g.: IPv4, IPv6, VPLS, etc.).  PE routers need this
    information to: a) discern the packet's CoS forwarding treatment, b)
    apply filters to forward or block traffic to/from the CE; c) to
    forward routing/control traffic to an onboard management processor;
    or, d) load-share the traffic on its uplinks to P routers.  By 
    knowing the expected encapsulation types, an ingress PE router
    could apply a smaller subset of payload parsing routines to extract
    keys appropriate for the given protocol.  Ultimately, this should
    allow for significantly improved accuracy in determining the
    appropriate load-balancing behavior for each protocol.
    
</p>
<p>
    In addition, compared to MPLS LSR's, PE routers typically operate at 
    lower forwarding rates as well as have more flexible forwarding 
    hardware.  As a result, a PE router can typically adapt much more 
    quickly to new/emerging protocols and determine the appropriate keys 
    used for load-sharing traffic that type of traffic through the 
    network.
    
</p>
<p>
    An additional advantage of applying entropy labels only at the edge
    of the network, on PE routers, would be that core/transit MPLS LSR's
    could once again return to being completely oblivious to the
    contents of each MPLS packet, and only use the outer MPLS labels to
    determine forwarding and forwarding treatment of MPLS packets.
    Specifically, there will be no reason to duplicate, from MPLS LER's,
    extremely complex packet/payload parsing functionality within MPLS
    LSR's and attempt to keep to keep this functionality at parity
    across all network elements, e.g.: both MPLS LSR's and LER's.
    Ultimately, this should result in less complexity within core LSR's
    allowing them to more easily scale to higher forwarding rates,
    larger port density, consume less power, etc.  Finally, the approach
    discussed in this memo would allow for more rapid deployment of new
    protocols, since MPLS LSR's will not have to be developed or
    modified to understand how to properly extract keys to achieve 
    good load-sharing of traffic throughout the network.
    
</p>
<p>
    In summary, MPLS LSR's are ill-equipped to infer the protocol within
    a packet's payload and choose appropriate keys within the payload to
    correctly identify a given "microflow", which is required to provide
    the most equitable load-sharing over multiple equal cost paths.
    On the other hand, PE routers have both the knowledge and
    capabilities to more accurately determine the load-sharing
    treatment that should be applied to a given protocol encapsulated
    within MPLS by MPLS LSR's.
    
</p>
<a name="conv"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.2"></a><h3>1.2.&nbsp;
Conventions used</h3>

<p>
	The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
	NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
	"OPTIONAL" in this document are to be interpreted as described
	in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate 		Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
	
</p>
<p>
	Labels stacks are denoted &lt;L1, L2, L3&gt;, which L1 is the
	"outermost" label and L3 the innermost (closest to the payload).
	Packet flows are depicted left to right, and signaling is shown
	right to left (unless otherwise indicated).
	
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Approaches</h3>

<p>
    There are two main approaches to encoding load balancing
    information in the label stack.  The first allocates multiple
    labels for a particular Forwarding Equivalance Class (FEC).  These
    labels are equivalent in terms of forwarding semantics, but having
    several allows flexibility in assigning labels to flows from the
    same FEC.  The other approach encodes the load balancing
    information as a separate label in the label stack.  Here, there
    are two sub-approaches, based on whether this load-balancing label
    is signaled or not.
    
</p>
<p>
    The first approach has the advantage that the label stack stays
    the same depth whether using label-based load balancing or not;
    and so, consequently, do forwarding operations on transit and
    egress LSRs.  However, it has a major drawback in that signaling
    and forwarding state are both increased significantly.  The number
    of independent choices for load balancing packets belonging to a
    FEC limits the effectiveness of load balancing, so one would like
    this number to be large.  However, the larger this number is, the
    greater the signaling and forwarding state in the network.
    
</p>
<p>
    The second approach increases the size of the label stack by one
    label.  This consequently affects operations on ingress, transit
    and egress LSRs.  The sub-approach of signaling the load-balancing
    labels increases signaling and forwarding state, and so suffers
    from some of the problems of the first approach.
    
</p>
<p>
    The approach advocated by this memo, and the only one described in
    detail, is the one where the load-balancing labels are not
    signaled.  With this approach, there is minimal change to
    signaling state for a FEC; also, there is no change in forwarding
    operations in transit LSRs, and no increase of forwarding state in
    any LSR.  The only purpose of these labels is to increase the
    entropy in the label stack, so they are called "entropy labels".
    
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Entropy Labels</h3>

<p>
    An entropy label (as used here) is a label:
	</p>
<ol class="text">
<li>
		that is not used for forwarding;
	    
</li>
<li>
		that is not signaled; and
	    
</li>
<li>
		whose only purpose in the label stack is to provide
		"entropy" to improve load balancing.
	    
</li>
</ol><p>
    
</p>
<p>
    Entropy labels are generated by an ingress LSR, based entirely on
    load balancing information.  However, they MUST NOT have values in
    the reserved label space (0-15).  Entropy labels MUST be at the
    bottom of the label stack, and thus the "end-of-stack" bit in the
    label should be set.  To ensure that they are not used
    inadvertently for forwarding, entropy labels SHOULD have a TTL of
    0.
    
</p>
<p>
    Since entropy labels are generated by the ingress LSR, an egress
    LSR MUST be able to tell unambiguously that a given label is an
    entropy label.  This of course depends on the underlying
    application.  If any ambiguity is possible, the label above the
    entropy label MUST be an "entropy label indicator" (ELI), which
    says that the following label is an entropy label.  The ELI may be
    signaled, or may be a reserved label reserved specifically for
    this purpose.  Fortunately, for many applications, the use of
    entropy labels is unambiguous, and does not need an ELI.
    
</p>
<p>
    Applications for MPLS entropy labels include pseudowires
    (<a class='info' href='#RFC4447'>[RFC4447]<span> (</span><span class='info'>Martini, L., Rosen, E., El-Aawar, N., Smith, T., and G. Heron, &ldquo;Pseudowire Setup and Maintenance Using the Label Distribution Protocol (LDP),&rdquo; April&nbsp;2006.</span><span>)</span></a>,
    <a class='info' href='#I-D.ietf-pwe3-fat-pw'>[I&#8209;D.ietf&#8209;pwe3&#8209;fat&#8209;pw]<span> (</span><span class='info'>Bryant, S., Filsfils, C., Drafz, U., Kompella, V., Regan, J., and S. Amante, &ldquo;Flow Aware Transport of Pseudowires over an MPLS PSN,&rdquo; January&nbsp;2010.</span><span>)</span></a>), Layer 3 VPN's
    (<a class='info' href='#RFC4364'>[RFC4364]<span> (</span><span class='info'>Rosen, E. and Y. Rekhter, &ldquo;BGP/MPLS IP Virtual Private Networks (VPNs),&rdquo; February&nbsp;2006.</span><span>)</span></a>), VPLS (<a class='info' href='#RFC4761'>[RFC4761]<span> (</span><span class='info'>Kompella, K. and Y. Rekhter, &ldquo;Virtual Private LAN Service (VPLS) Using BGP for Auto-Discovery and Signaling,&rdquo; January&nbsp;2007.</span><span>)</span></a>,
    <a class='info' href='#RFC4762'>[RFC4762]<span> (</span><span class='info'>Lasserre, M. and V. Kompella, &ldquo;Virtual Private LAN Service (VPLS) Using Label Distribution Protocol (LDP) Signaling,&rdquo; January&nbsp;2007.</span><span>)</span></a>) and Tunnel LSPs.  This memo specifies
    general properties of entropy labels, and the signaling of entropy
    labels for LDP (<a class='info' href='#RFC5036'>[RFC5036]<span> (</span><span class='info'>Andersson, L., Minei, I., and B. Thomas, &ldquo;LDP Specification,&rdquo; October&nbsp;2007.</span><span>)</span></a>) tunnel LSPs.  Other
    memos will specify the signaling and use of entropy labels for
    specific applications.
    
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Forwarding and Load Balancing Behaviors for Entropy Labels</h3>

<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Ingress LSR</h3>

<p>
	Suppose that for a particular application (or FEC), an ingress
	LSR X has to push label stack &lt;TL, AL&gt;, where TL is the
	"tunnel label" and AL is the application label.  (Note the use
	of the convention for label stacks described in
	<a class='info' href='#conv'>Section&nbsp;1.2<span> (</span><span class='info'>Conventions used</span><span>)</span></a>.  The use of a two-label stack is just
	for illustrative purposes.)  Suppose furthermore that X is to
	use entropy labels for this application.  Thus, the resultant
	label stack will be &lt;TL, AL, EL&gt;, where EL is the
	entropy label.
	
</p>
<p>
	When a packet for this FEC arrives at X, X must first
	determine the fields that it will use for load balancing.
	Typically, X will then generate a hash H over those fields.  X
	will then pick an outgoing label stack &lt;TL, AL&gt; to push
	on the packet.  However, X must also generate an entropy label
	EL (based either directly on the load balancing fields, or on
	the hash H).  EL is a "regular" 32-bit label, encoded in the
	usual way; however, the EOS bit MUST be 1 and the TTL field
	MUST be 0.  X then pushes &lt;TL, AL, EL&gt; on to the packet
	before forwarding it to the next LSR.  If X is told (via
	signaling) that it must use an entropy label indicator ELI,
	then X instead pushes &lt;TL, AL, ELI, EL&gt; on to the packet.
	
</p>
<p>
	Note that ingress LSR X MUST NOT include an entropy label
	unless the egress LSR for this FEC has indicated that it is
	ready to receive entropy labels.  Furthermore, if the egress
	LSR has signaled that an ELI is needed, then X MUST include
	the ELI with the entropy label; otherwise, X MUST NOT use
	entropy labels.
	
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Transit LSR</h3>

<p>
	Transit LSRs have no change in forwarding behavior.  For load
	balancing, transit LSRs SHOULD use the whole label stack
	(e.g., for computing the load balance hash).  Transit LSRs MAY
	choose to look beyond the label stack for further load
	balancing information; however, if entropy labels are being
	used, this may not be very useful.  In a mixed environment (or
	for backward compatibility), this is the simplest approach.
	
</p>
<p>
	Thus, transit LSRs are almost unaffected by the use of entropy
	labels.  If transit LSRs were programmed to use a subset of
	the label stack, they may have to be reconfigured to use the
	full stack.  But otherwise, no changes are needed.
	
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Egress LSRs</h3>

<p>
	An ingress LSR X MUST NOT send entropy labels to an egress LSR
	Y unless Y has signaled its readiness to receive such labels.
	Y must also determine (for a particular application or FEC),
	whether it can distinguish whether the ingress has added an
	entropy label or not; if Y cannot do so, Y MUST request that
	an ELI be used for this FEC.  Alternatively, Y MUST require
	the use of entropy labels.  (See <a class='info' href='#sig'>Section&nbsp;5<span> (</span><span class='info'>Signaling for Entropy Labels</span><span>)</span></a> for more
	details on signaling.)
	
</p>
<p>
	Suppose Y has signaled that it is prepared to receive entropy
	labels for a given FEC.  In this case, Y must be able to
	distinguish whether an ingress LSR has inserted an entropy
	label or not based solely on the 'end-of-stack' (EOS) bit on
	the application label for this FEC.  When Y receives a packet
	with this application label, then Y looks to see if the EOS
	bit is set.  If not, Y assumes that the label below is an
	entropy label and pops it.  Y MAY choose to ensure that the
	entropy label has its EOS bit set and TTL=0.  Y then processes
	the packet as usual.  Implementations may choose the order
	in which they apply these operations, but the net result
	should be as specified.
	
</p>
<a name="sig"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Signaling for Entropy Labels</h3>

<p>
    Signaling for entropy labels exchanges three types of information:
	</p>
<ol class="text">
<li>
	    whether an LSR Y is prepared to receive entropy labels,
	    
</li>
<li>
	    whether receiving LSR Y requires ELIs with entropy labels,
	    and if so, what label to use as the ELI, and
	    
</li>
<li>
	    whether an LSR X is able to send entropy labels.
	    
</li>
</ol><p>
    
</p>
<p>
    The uses of this information can be illustrated as follows.  If an
    LSR Y is prepared to receive entropy labels for an application (or
    FEC), it signals that to the ingress LSR(s).  That means that an
    ingress LSR for this application MAY send an entropy label for
    this application; Y MUST be able to distinguish whether or not an
    entropy label was sent based solely on the EOS bit on the
    application label.
	
</p>
<p>
	In cases where an application label is used, Y does not need to
	signal an ELI for this FEC.  However, Y MUST clear the EOS bit
	on the application label to indicate that the label that follows will
	be an Entropy Label.
	
</p>
<p>
	In cases where no application label exists, Y can signal that an
    ELI MUST be used for this FEC; Y may also signal what ELI to use.
    In this case, an ingress LSR will either not send an entropy label,
    or push the ELI before the entropy label.  This makes the use/non-use
    of an entropy label unambiguous.  However, this also increases the
    size of the label stack.
    
</p>
<p>
    The specific protocols and encoding details for the above will
    depend on the underlying application; see
    <a class='info' href='#I-D.ietf-pwe3-fat-pw'>[I&#8209;D.ietf&#8209;pwe3&#8209;fat&#8209;pw]<span> (</span><span class='info'>Bryant, S., Filsfils, C., Drafz, U., Kompella, V., Regan, J., and S. Amante, &ldquo;Flow Aware Transport of Pseudowires over an MPLS PSN,&rdquo; January&nbsp;2010.</span><span>)</span></a> for an example for
    pseudowires.
    
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
LDP Signaling</h3>

<p>
	When using LDP for signaling tunnel labels (<a class='info' href='#RFC5036'>[RFC5036]<span> (</span><span class='info'>Andersson, L., Minei, I., and B. Thomas, &ldquo;LDP Specification,&rdquo; October&nbsp;2007.</span><span>)</span></a>),
	a Label Mapping Message sub-TLV (Entropy Label sub-TLV) type is used to
	synchronize the entropy label states between the ingress and egress PE's.
	
</p>
<p>
	The presence of the Entropy Label sub-TLV in the Label Mapping Message
	indicates to the ingress PE that the egress PE can correctly process a
	entropy label.  In addition, the Entropy Label sub-TLV contains a label
	value that must be inserted as the ELI by the ingress PE, assuming
	the ingress PE can apply entropy labels to outgoing packets.
	
</p>
<p>
	It should be noted that the egress PE only needs to send a single
	Label value for the ELI, which does not conflict with any other labels
	it has advertised to other PE's for other applications.
	
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1.1"></a><h3>5.1.1.&nbsp;
Structure of Entropy Label sub-TLV</h3>

<p>
	<br /><hr class="insert" />
<a name="el_sub_tlv"></a>

<p>The structure of the Entropy Label sub-TLV is shown in
		Figure 1.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|U|F|           Type            |      Length                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     ELI Label                                                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Entropy Label sub-TLV&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

	

<p>
		Where:
		</p>
<blockquote class="text">
<p>U: Unknown bit.  This bit MUST be set to 1.  If the Entropy
			Label sub-TLV is not understood, then the TLV is not known to
			the receiver and MUST be ignored.
</p>
<p>F: Forward bit.  This bit MUST be set be set to 1.  Since this
			sub-TLV is going to propagated hop-by-hop, the sub-TLV should be
			forwarded even by devices that may not understand it.
</p>
<p>Type: Type field.  'Entropy Label sub-TLV' specified by IANA.
			
</p>
<p>Length: Length field.  This field specifies the total length
			in octets of the Entropy Label sub-TLV.
</p>
<p>ELI Label: Entropy Label Indicator Label.  The Entropy Label 
			Indicator (ELI) label notifies the receiver that the following
			label in the MPLS Label stack is the Entropy Label.  It should be
			noted that the ELI Label is unnecessary for protocols that use
			an application label that precedes the Entropy Label.
			
</p>
</blockquote><p>
	
</p>
<p>Label
</p>
<p>
	<br /><hr class="insert" />
<a name="eli_label"></a>

<p>This is a 20-bit label value represented as a 20-bit number
		in a 4 octet field as follows:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     ELI Label                         |                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: Entropy Label Indicator Label&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

	

<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
RSVP Signaling</h3>

<p>
	TBD.
	
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
BGP Signaling</h3>

<p>
	TBD.
	
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
MPLS-TP and Entropy Labels</h3>

<p>
	Interoperability with MPLS-TP Generic Associated Channel Label (GAL)
	are outside the scope of this document.
	
</p>
<a name="sec-con"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Security Considerations</h3>

<p>
	This document describes advertisement of the capability to support
	receipt of entropy-labels and an Entropy Label Indicator that an
	ingress PE may apply to MPLS packets in order to allow Core LSR's
	to attain better load-balancing across LAG and/or ECMP paths in the
	network.
	
</p>
<p>
	This document does not introduce new security vulnerabilities to LDP.
	Please refer to the Security Considerations section of LDP (<a class='info' href='#RFC5036'>[RFC5036]<span> (</span><span class='info'>Andersson, L., Minei, I., and B. Thomas, &ldquo;LDP Specification,&rdquo; October&nbsp;2007.</span><span>)</span></a>) for security mechanisms applicable to LDP.
	
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
IANA Considerations</h3>

<p>IANA is requested to allocate the next available value from IETF
	Consensus range in the LDP TLV Type Name Space Registry as the
	Entropy Label TLV.
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Acknowledgments</h3>

<p>
	We wish to thank Ulrich Drafz and John Drake for their contributions, as 
	well as the entire "hash label" team for their valuable comments and
	discussion.
    
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:-">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate
		Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997.</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>10.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.ietf-pwe3-fat-pw">[I-D.ietf-pwe3-fat-pw]</a></td>
<td class="author-text">Bryant, S., Filsfils, C., Drafz, U., Kompella, V., Regan, J., and S. Amante, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-pwe3-fat-pw-03.txt">Flow Aware Transport of Pseudowires over an MPLS PSN</a>,&rdquo; draft-ietf-pwe3-fat-pw-03 (work in progress), January&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-pwe3-fat-pw-03.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4364">[RFC4364]</a></td>
<td class="author-text">Rosen, E. and Y. Rekhter, &ldquo;<a href="http://tools.ietf.org/html/rfc4364">BGP/MPLS IP Virtual Private Networks (VPNs)</a>,&rdquo; RFC&nbsp;4364, February&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4364.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4447">[RFC4447]</a></td>
<td class="author-text">Martini, L., Rosen, E., El-Aawar, N., Smith, T., and G. Heron, &ldquo;<a href="http://tools.ietf.org/html/rfc4447">Pseudowire Setup and Maintenance Using the Label Distribution Protocol (LDP)</a>,&rdquo; RFC&nbsp;4447, April&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4447.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4761">[RFC4761]</a></td>
<td class="author-text">Kompella, K. and Y. Rekhter, &ldquo;<a href="http://tools.ietf.org/html/rfc4761">Virtual Private LAN Service (VPLS) Using BGP for Auto-Discovery and Signaling</a>,&rdquo; RFC&nbsp;4761, January&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4761.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4762">[RFC4762]</a></td>
<td class="author-text">Lasserre, M. and V. Kompella, &ldquo;<a href="http://tools.ietf.org/html/rfc4762">Virtual Private LAN Service (VPLS) Using Label Distribution Protocol (LDP) Signaling</a>,&rdquo; RFC&nbsp;4762, January&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc4762.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5036">[RFC5036]</a></td>
<td class="author-text">Andersson, L., Minei, I., and B. Thomas, &ldquo;<a href="http://tools.ietf.org/html/rfc5036">LDP Specification</a>,&rdquo; RFC&nbsp;5036, October&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc5036.txt">TXT</a>).</td></tr>
</table>

<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Applicability of LDP Entropy Label sub-TLV</h3>

<p>
	In the case of unlabeled IPv4 (Internet) traffic, the Best Current
	Practice is for an egress PE to propagate eBGP learned routes within a
	SP's Autonomous System after resetting the BGP next-hop attribute to the
	Loopback IP address of the egress PE.  That Loopback IP address is
	injected into the Service Provider's IGP and, concurrently, a label
	assigned to it via LDP.  Thus, when an ingress PE is performing a
	forwarding lookup for a BGP destination it recursively resolves the
	associated next-hop to a Loopback IP address and associated LDP label
	of the egress PE.
	
</p>
<p>
	Thus, in the context of unlabeled IPv4 traffic, the LDP Entropy Label
	sub-TLV will typically be applied only to the FEC for the Loopback
	IP address of the egress PE.
	
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Kireeti Kompella</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Juniper Networks</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1194 N. Mathilda Ave.</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Sunnyvale, CA  94089</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:kireeti@juniper.net">kireeti@juniper.net</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Shane Amante</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Level 3 Communications, LLC</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1025 Eldorado Blvd</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Broomfield, CO  80021</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:shane@level3.net">shane@level3.net</a></td></tr>
</table>
</body></html>
