<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>TURN Cluster: Scale out TURN cluster by routable transaction id</title>
<meta content="William Zeng" name="author">
<meta content="
       The TURN protocol is designed to solve the connectivity problem of Peer-to-Peer
Communication when NAT devices exist, by allowing each peer to establish a data channel
on TURN servers. Since there are some specific requirements in the use of TURN, such as
RTP/RTCP connection pairs must be sent to the same TURN server,
it is not easy to scale a single TURN server into a TURN cluster.  In addition, a TURN
service cluster also needs to consider how to achieve good load balancing and
how to protect internal information security. Based on these demands, this specification
provides several standard means to implement a functional and secure TURN
cluster, and this specification also provides an overview and rationale of
the cluster architecture. 
    " name="description">
<meta content="xml2rfc 3.10.0" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-zeng-turn-cluster-02" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.10.0
    Python 3.6.12
    appdirs 1.4.4
    ConfigArgParse 1.5.3
    google-i18n-address 2.5.0
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 2.11.3
    kitchen 1.2.6
    lxml 4.6.3
    pycountry 20.7.3
    pyflakes 2.4.0
    PyYAML 5.4.1
    requests 2.26.0
    setuptools 58.2.0
    six 1.16.0
-->
<link href="/tmp/draft-turn-cluster-iii93sfk.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necssary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: 'Noto Sans', Arial, Helvetica, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre, code {
  background-color: #f9f9f9;
  font-family: 'Roboto Mono', monospace;
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    float: none;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: "Noto Sans",Arial,Helvetica,sans-serif;
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {

    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The follwing is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre, code {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
pre.sourcecode,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact informatio look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background sligthtly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottim margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the comact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div:first-child > pre.sourcecode,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<script type="application/javascript">async function addMetadata(){try{const e=document.styleSheets[0].cssRules;for(let t=0;t<e.length;t++)if(/#identifiers/.exec(e[t].selectorText)){const a=e[t].cssText.replace("#identifiers","#external-updates");document.styleSheets[0].insertRule(a,document.styleSheets[0].cssRules.length)}}catch(e){console.log(e)}const e=document.getElementById("external-metadata");if(e)try{var t,a="",o=function(e){const t=document.getElementsByTagName("meta");for(let a=0;a<t.length;a++)if(t[a].getAttribute("name")===e)return t[a].getAttribute("content");return""}("rfc.number");if(o){t="https://www.rfc-editor.org/rfc/rfc"+o+".json";try{const e=await fetch(t);a=await e.json()}catch(e){t=document.URL.indexOf("html")>=0?document.URL.replace(/html$/,"json"):document.URL+".json";const o=await fetch(t);a=await o.json()}}if(!a)return;e.style.display="block";const s="",d="https://datatracker.ietf.org/doc",n="https://datatracker.ietf.org/ipr/search",c="https://www.rfc-editor.org/info",l=a.doc_id.toLowerCase(),i=a.doc_id.slice(0,3).toLowerCase(),f=a.doc_id.slice(3).replace(/^0+/,""),u={status:"Status",obsoletes:"Obsoletes",obsoleted_by:"Obsoleted By",updates:"Updates",updated_by:"Updated By",see_also:"See Also",errata_url:"Errata"};let h="<dl style='overflow:hidden' id='external-updates'>";["status","obsoletes","obsoleted_by","updates","updated_by","see_also","errata_url"].forEach(e=>{if("status"==e){a[e]=a[e].toLowerCase();var t=a[e].split(" "),o=t.length,w="",p=1;for(let e=0;e<o;e++)p<o?w=w+r(t[e])+" ":w+=r(t[e]),p++;a[e]=w}else if("obsoletes"==e||"obsoleted_by"==e||"updates"==e||"updated_by"==e){var g,m="",b=1;g=a[e].length;for(let t=0;t<g;t++)a[e][t]&&(a[e][t]=String(a[e][t]).toLowerCase(),m=b<g?m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>, ":m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>",b++);a[e]=m}else if("see_also"==e){var y,L="",C=1;y=a[e].length;for(let t=0;t<y;t++)if(a[e][t]){a[e][t]=String(a[e][t]);var _=a[e][t].slice(0,3),v=a[e][t].slice(3).replace(/^0+/,"");L=C<y?"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>, ":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>, ":"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>",C++}a[e]=L}else if("errata_url"==e){var R="";R=a[e]?R+"<a href='"+a[e]+"'>Errata exist</a> | <a href='"+d+"/"+l+"'>Datatracker</a>| <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>":"<a href='"+d+"/"+l+"'>Datatracker</a> | <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>",a[e]=R}""!=a[e]?"Errata"==u[e]?h+=`<dt>More info:</dt><dd>${a[e]}</dd>`:h+=`<dt>${u[e]}:</dt><dd>${a[e]}</dd>`:"Errata"==u[e]&&(h+=`<dt>More info:</dt><dd>${a[e]}</dd>`)}),h+="</dl>",e.innerHTML=h}catch(e){console.log(e)}else console.log("Could not locate metadata <div> element");function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}}window.removeEventListener("load",addMetadata),window.addEventListener("load",addMetadata);</script>
</head>
<body>
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">TURN-Cluster</td>
<td class="right">November 2021</td>
</tr></thead>
<tfoot><tr>
<td class="left">Zeng</td>
<td class="center">Expires 17 May 2022</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">tram</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-zeng-turn-cluster-02</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2021-11-13" class="published">13 November 2021</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2022-05-17">17 May 2022</time></dd>
<dt class="label-authors">Author:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">W. Zeng</div>
<div class="org">Ant Group</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">TURN Cluster: Scale out TURN cluster by routable transaction id</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">The TURN protocol is designed to solve the connectivity problem of Peer-to-Peer
Communication when NAT devices exist, by allowing each peer to establish a data channel
on TURN servers. Since there are some specific requirements in the use of TURN, such as
RTP/RTCP connection pairs must be sent to the same TURN server,
it is not easy to scale a single TURN server into a TURN cluster.  In addition, a TURN
service cluster also needs to consider how to achieve good load balancing and
how to protect internal information security. Based on these demands, this specification
provides several standard means to implement a functional and secure TURN
cluster, and this specification also provides an overview and rationale of
the cluster architecture.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 17 May 2022.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2021 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="xref">1.1</a>.  <a href="#name-terminology" class="xref">Terminology</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.2">
                <p id="section-toc.1-1.1.2.2.1" class="keepWithNext"><a href="#section-1.2" class="xref">1.2</a>.  <a href="#name-notation" class="xref">Notation</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="xref">2</a>.  <a href="#name-overview-of-an-turn-ice-pro" class="xref">Overview of an TURN ICE process</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-architectural-and-interacti" class="xref">Architectural and Interactive Process</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-overview-of-the-architectur" class="xref">Overview of the Architectural</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-overview-of-interaction-pro" class="xref">Overview of interaction process</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2.2.1">
                    <p id="section-toc.1-1.3.2.2.2.1.1"><a href="#section-3.2.1" class="xref">3.2.1</a>.  <a href="#name-clienta-behavior" class="xref">ClientA Behavior</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2.2.2">
                    <p id="section-toc.1-1.3.2.2.2.2.1"><a href="#section-3.2.2" class="xref">3.2.2</a>.  <a href="#name-clientb-behavior" class="xref">ClientB Behavior</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2.2.3">
                    <p id="section-toc.1-1.3.2.2.2.3.1"><a href="#section-3.2.3" class="xref">3.2.3</a>.  <a href="#name-turn-cluster-behavior" class="xref">TURN Cluster Behavior</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-routing-mechanism" class="xref">Routing Mechanism</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="xref">4.1</a>.  <a href="#name-server-generate-encrypted-r" class="xref">Server Generate ENCRYPTED-RELAYED-ADDRESS</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.1">
                    <p id="section-toc.1-1.4.2.1.2.1.1"><a href="#section-4.1.1" class="xref">4.1.1</a>.  <a href="#name-preparation-phase" class="xref">Preparation Phase</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.2">
                    <p id="section-toc.1-1.4.2.1.2.2.1"><a href="#section-4.1.2" class="xref">4.1.2</a>.  <a href="#name-obfuscation-phase" class="xref">Obfuscation Phase</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.3">
                    <p id="section-toc.1-1.4.2.1.2.3.1"><a href="#section-4.1.3" class="xref">4.1.3</a>.  <a href="#name-encryption-phase" class="xref">Encryption Phase</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="xref">4.2</a>.  <a href="#name-generation-of-routable-tran" class="xref">Generation of Routable Transaction ID</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2.2.1">
                    <p id="section-toc.1-1.4.2.2.2.1.1"><a href="#section-4.2.1" class="xref">4.2.1</a>.  <a href="#name-arbitrary-mode" class="xref">Arbitrary Mode</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2.2.2">
                    <p id="section-toc.1-1.4.2.2.2.2.1"><a href="#section-4.2.2" class="xref">4.2.2</a>.  <a href="#name-specific-server-mode" class="xref">Specific Server Mode</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2.2.3">
                    <p id="section-toc.1-1.4.2.2.2.3.1"><a href="#section-4.2.3" class="xref">4.2.3</a>.  <a href="#name-specific-address-mode" class="xref">Specific Address Mode</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2.2.4">
                    <p id="section-toc.1-1.4.2.2.2.4.1"><a href="#section-4.2.4" class="xref">4.2.4</a>.  <a href="#name-uniqueness-of-transaction-i" class="xref">Uniqueness of Transaction ID</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="xref">4.3</a>.  <a href="#name-turn-lb-process-transaction" class="xref">TURN LB Process Transaction ID</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a href="#section-4.4" class="xref">4.4</a>.  <a href="#name-encrypted-peer-address" class="xref">ENCRYPTED-PEER-ADDRESS</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5">
                <p id="section-toc.1-1.4.2.5.1"><a href="#section-4.5" class="xref">4.5</a>.  <a href="#name-tls-consideration" class="xref">TLS Consideration</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-security-consideration" class="xref">Security Consideration</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-dos-against-turn-cluster" class="xref">DoS Against TURN Cluster</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-dos-against-a-single-turn-s" class="xref">DoS Against a Single TURN Server</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-iana-consideration" class="xref">IANA Consideration</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-contributors" class="xref">Contributors</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-references" class="xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="xref">8.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="xref">8.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#appendix-A" class="xref"></a><a href="#name-authors-address" class="xref">Author's Address</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="intro">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">Interactive Connectivity Establishment(ICE)(described in <span>[<a href="#RFC8445" class="xref">RFC8445</a>]</span> gives a standard way
for peers exchanging information and establishing a data channel between each others,
in the channel establishing progress, if a peer is located behind a NAT,
then it's impossible for that peer to communicate directly with
other peers, <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span> proposal the TURN protocol to solve this
problem by offering a standard way to establish
relayed channel between peers.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">TURN and ICE are widely used and the most typical scenario is
webrtc(described in <span>[<a href="#RFC7478" class="xref">RFC7478</a>]</span>). Imagine a webrtc scenario with a large number
of users, when most users need to use relay service, a single TURN server
would become the bottleneck of the system. Setting a networking
load-balancing equipment that forwards the requests to a member of the
TURN servers group is the best and most efficient performance tuning approach,
it allows near-linear performance improvement. However,
TURN servers with a simple networking load-balancing equipment are not enough
to build a fully functional cluster, since a TURN cluster still meet these requirements:<a href="#section-1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-3.1">For RTP/RTCP connection pairs and TCP relayed, client requests with different source
addresses must be forwarded to the same server, a TURN cluster SHOULD
achieve this condition.<a href="#section-1-3.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.2">The recommended ICE candidate priority calculation formula is designed for all
clients connected to the same TURN server. When clients are connected to different TURN
servers in the cluster, there may be one more hop between TURN servers of the relayed channel,
then the formula is unreliable. a TURN cluster SHOULD avoid this problem.<a href="#section-1-3.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-3.3">A TURN cluster SHOULD achieve good load balancing for all members of the cluster.<a href="#section-1-3.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-1-4"><span>[<a href="#TURN-Load-balance" class="xref">TURN-Load-balance</a>]</span> give some suggestions to solve these problem:
(1) DNS based load balancing (2) Using ALTERNATE-SERVER(defined in Section 10 of <span>[<a href="#RFC8489" class="xref">RFC8489</a>]</span>)
to redirect requests to right server, while the DNS based load balancing is
unreliable and the ALTERNATE-SERVER mechanism is inefficient.
Moreover, these solutions are expensive and insecure, and are not suitable for large-scale
deployment in Internet Data Center(IDC) environments, because they require that each
TURN server in the cluster MUST have their own public network IP address and expose
a considerable number of ports to the outside network. In general, a TURN cluster
SHOULD meet the following requirements:<a href="#section-1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-5.1">Meet the basic requirements for the use of all TURN protocols, including the specific scenarios
such as RTP/RTCP connection pairs.<a href="#section-1-5.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-5.2">Easy to scale in/out the size of the cluster.<a href="#section-1-5.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-5.3">The cluster SHOULD have a unified access portal, and the internal network information MUST be hidden.<a href="#section-1-5.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-1-5.4">Easy to set up network security policies to defend against potential attacks.<a href="#section-1-5.4" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-1-6">This specification provides an architecture and corresponding interaction
process for easily building a TURN cluster that
meets all above requirements. Since TURN is always used in ICE,
this specification introduces related processes based on ICE for better illustration.
The remainder of this document is organized as follows:
<a href="#ice_process" class="xref">Section 2</a> briefly introduces how the relayed channel is established in the ICE process;
<a href="#arch_design" class="xref">Section 3</a> describes the overview of the architecture and the interaction process between
client and TURN cluster; <a href="#route-mech" class="xref">Section 4</a> introduce the generation and processing of
routing message, including:(1)How does a TURN server transmit routing message in a secure manner;
(2)How does a client generate routable transaction ID with the routing message; (3) How the TURN
cluster handles the transaction ID and corresponding packet.<a href="#section-1-6" class="pilcrow">¶</a></p>
<div id="term">
<section id="section-1.1">
        <h3 id="name-terminology">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
        </h3>
<p id="section-1.1-1">Although this document is not an IETF Standards Track publication it
adopts the conventions for normative language to provide clarity of
instructions to the implementer.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span>
          <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span> when, and only when, they appear in all capitals, as shown
here.<a href="#section-1.1-2" class="pilcrow">¶</a></p>
<p id="section-1.1-3">The following terms are used in this document:<a href="#section-1.1-3" class="pilcrow">¶</a></p>
<p id="section-1.1-4">concat(x0, ..., xN): Concatenation of byte strings.
      "concat(0x01, 0x0203, 0x040506) = 0x010203040506".<a href="#section-1.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="notation">
<section id="section-1.2">
        <h3 id="name-notation">
<a href="#section-1.2" class="section-number selfRef">1.2. </a><a href="#name-notation" class="section-name selfRef">Notation</a>
        </h3>
<p id="section-1.2-1">All wire formats will be depicted using the notation defined in Section 1.3 of
<span>[<a href="#RFC9000" class="xref">RFC9000</a>]</span>. There is one addition: the function len() refers to the
length of a field which can serve as a limit on a different field, so that the
lengths of two fields can be concisely defined as limited to a sum, for example:<a href="#section-1.2-1" class="pilcrow">¶</a></p>
<p id="section-1.2-2">x(A..B)
y(C..B-len(x))<a href="#section-1.2-2" class="pilcrow">¶</a></p>
<p id="section-1.2-3">indicates that x can be of any length between A and B, and y can be of any
length between C and B provided that (len(x) + len(y)) does not exceed B.<a href="#section-1.2-3" class="pilcrow">¶</a></p>
<p id="section-1.2-4">The example below illustrates the basic framework:<a href="#section-1.2-4" class="pilcrow">¶</a></p>
<span id="name-example-format"></span><div id="fig-ex-format">
<figure id="figure-1">
          <div class="alignLeft art-text artwork" id="section-1.2-5.1">
<pre>
Example Structure {
  One-bit Field (1),
  7-bit Field with Fixed Value (7) = 61,
  Field with Variable-Length Integer (i),
  Arbitrary-Length Field (..),
  Variable-Length Field (8..24),
  Field With Minimum Length (16..),
  Field With Maximum Length (..128),
  [Optional Field (64)],
  Repeated Field (8) ...,
}
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-example-format" class="selfRef">Example Format</a>
          </figcaption></figure>
</div>
</section>
</div>
</section>
</div>
<div id="ice_process">
<section id="section-2">
      <h2 id="name-overview-of-an-turn-ice-pro">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-overview-of-an-turn-ice-pro" class="section-name selfRef">Overview of an TURN ICE process</a>
      </h2>
<p id="section-2-1">This section we would use an example to illustrate how clients
set up relayed channel through ICE and TURN, in the example,
clientA and clientB are all behind a symmetric NAT device, their
network topology is shown in figure below:<a href="#section-2-1" class="pilcrow">¶</a></p>
<span id="name-example-network-topology"></span><div id="fig-peer-struct">
<figure id="figure-2">
        <div class="alignLeft art-text artwork" id="section-2-2.1">
<pre>
                       +-------------+
                       | Turn Server |
                       +-------------+
                      10.11.252.43:3478
                          ^       ^
                          |       |
         +----------------+       +-----------------+
         |                                          |
10.243.22.200:23768                        10.243.21.133:12371
 +---------------+                          +---------------+
 | Symmetric NAT |                          | Symmetric NAT |
 +---------------+                          +---------------+
         ^                                          ^
         |                                          |
192.168.1.0:6677                          192.168.110.121:11202
    +---------+                                +---------+
    | clientA |                                | clientB |
    +---------+                                +---------+
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-example-network-topology" class="selfRef">Example network topology</a>
        </figcaption></figure>
</div>
<p id="section-2-3">Although in this example, the P2P data channel built based on STUN protocol cannot be used
because of the existence of symmetric NAT,
this document does not omit the STUN process of ICE, so that readers can
more clearly understand the whole ice process. A simplified TURN ICE
relayed channel establishing processing is depicted
in <a href="#fig-relayed-channel-est" class="xref">Figure 3</a>.<a href="#section-2-3" class="pilcrow">¶</a></p>
<span id="name-example-relayed-channel-est"></span><div id="fig-relayed-channel-est">
<figure id="figure-3">
        <div class="alignLeft art-text artwork" id="section-2-4.1">
<pre>
clientA                 TURN server                clientB
  |                         |                         |
  |------STUN/TURN Req-----&gt;|                         |
  |                         |                         |
  |&lt;-----STUN/TURN Resp-----|                         |
  |                         |                         |
  |--ClientA ICE Candidate Info----------------------&gt;|
  |                         |                         |
  |                         |&lt;-----STUN/TURN Req------|
  |                         |                         |
  |                         |------STUN/TURN Resp----&gt;|
  |                         |                         |
  |&lt;----------------------ClientB ICE Candidate Info--|
  |                         |                         |
  |&lt;--Connectivity Checks--&gt;|&lt;--Connectivity Checks--&gt;|
  |                         |                         |
  |&lt;---------Data----------&gt;|&lt;--------Data-----------&gt;|
  |                         |                         |
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-example-relayed-channel-est" class="selfRef">Example relayed channel establishment</a>
        </figcaption></figure>
</div>
<p id="section-2-5">The related behavior in the Figure 1 are explained as follows:<a href="#section-2-5" class="pilcrow">¶</a></p>
<p id="section-2-6">STUN/TURN Req: The STUN requests send by clientA/clientB, which SHOULD be
Allocate request(defined in Section 7 of <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span>)
or Bind request(defined in Section 2 of <span>[<a href="#RFC8489" class="xref">RFC8489</a>]</span>) to TURN server.<a href="#section-2-6" class="pilcrow">¶</a></p>
<p id="section-2-7">STUN/TURN Resp: The STUN responses return by TURN server, which SHOULD include
these information: (1) XOR-RELAYED-ADDRESS(defined in Section 18.5 of <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span>)
(2) XOR-MAPPED-ADDRESS(defined in Section 14.2 of <span>[<a href="#RFC8489" class="xref">RFC8489</a>]</span>)<a href="#section-2-7" class="pilcrow">¶</a></p>
<p id="section-2-8">ClientA/ClientB ICE Candidate Info: The ICE Candidate Information(defined in Section 5.3 of <span>[<a href="#RFC8445" class="xref">RFC8445</a>]</span>)
gathered by client, and client synchronizes it to peer by signaling server(defined in <span>[<a href="#RFC8445" class="xref">RFC8445</a>]</span>).<a href="#section-2-8" class="pilcrow">¶</a></p>
<p id="section-2-9">Connectivity Checks: The connectivity check processing which is defined in Section 2 of <span>[<a href="#RFC8445" class="xref">RFC8445</a>]</span>.
Take clientA for example, clientA first attempts to connect directly to clientB
through XOR-MAPPED-ADDRESS, because clientA and clientB are all behind a symmetric NAT device,
this process would fail, then clientA would try relayed channel, if clientA and clientB can
successfully bind to XOR-RELAYED-ADDRESS of peer, then there are 3 available channel:<a href="#section-2-9" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-10.1">srflxA2relayB: The channel of server-reflexive address of clientA to relayed address of
clientB, shown below:<a href="#section-2-10.1" class="pilcrow">¶</a>
</li>
      </ul>
<span id="name-established-srflxa2relayb-d"></span><div id="fig-srflxA2relayB">
<figure id="figure-4">
        <div class="alignLeft art-text artwork" id="section-2-11.1">
<pre>
 XOR-RELAYED-ADDRESS   +-------------+
 allocated for clientB | Turn Server |  10.11.252.43:3478
 10.11.252.43:55555    +-------------+
         ^                                     ^
         |                                     |
         v                                     v
 +---------------+                     +---------------+
 | Symmetric NAT |                     | Symmetric NAT |
 +---------------+                     +---------------+
         ^                                     ^
         |                                     |
         v                                     v
    +---------+                           +---------+
    | clientA |                           | clientB |
    +---------+                           +---------+
</pre>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-established-srflxa2relayb-d" class="selfRef">Established srflxA2relayB Data Channel</a>
        </figcaption></figure>
</div>
<ul class="normal">
<li class="normal" id="section-2-12.1">relayA2srflxB: The channel of relayed address of clientA to server-reflexive address of
clientB, shown below:<a href="#section-2-12.1" class="pilcrow">¶</a>
</li>
      </ul>
<span id="name-established-relaya2srflxb-d"></span><div id="fig-relayA2srflxB">
<figure id="figure-5">
        <div class="alignLeft art-text artwork" id="section-2-13.1">
<pre>
                   +-------------+  XOR-RELAYED-ADDRESS
 10.11.252.43:3478 | Turn Server |  allocated for clientA
                   +-------------+  10.11.252.43:55666
        ^                                  ^
        |                                  |
        v                                  v
+---------------+                  +---------------+
| Symmetric NAT |                  | Symmetric NAT |
+---------------+                  +---------------+
        ^                                  ^
        |                                  |
        v                                  v
   +---------+                        +---------+
   | clientA |                        | clientB |
   +---------+                        +---------+
</pre>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-established-relaya2srflxb-d" class="selfRef">Established relayA2srflxB Data Channel</a>
        </figcaption></figure>
</div>
<ul class="normal">
<li class="normal" id="section-2-14.1">relayA2relayB: The channel of relayed address of clientA to relayed address of
clientB, shown below:<a href="#section-2-14.1" class="pilcrow">¶</a>
</li>
      </ul>
<span id="name-established-relaya2relayb-d"></span><div id="fig-relayA2relayB">
<figure id="figure-6">
        <div class="alignLeft art-text artwork" id="section-2-15.1">
<pre>
 XOR-RELAYED-ADDRESS               XOR-RELAYED-ADDRESS
 allocated for clientA &lt;--------&gt;  allocated for clientB
 10.11.252.43:55555                10.11.252.43:55666
 +-------------+                    +-------------+
 | Turn Server |                    | Turn Server |
 +-------------+                    +-------------+
10.11.252.43:3478                  10.11.252.43:3478
        ^                                  ^
        |                                  |
        v                                  v
+---------------+                  +---------------+
| Symmetric NAT |                  | Symmetric NAT |
+---------------+                  +---------------+
        ^                                  ^
        |                                  |
        v                                  v
   +---------+                        +---------+
   | clientA |                        | clientB |
   +---------+                        +---------+
</pre>
</div>
<figcaption><a href="#figure-6" class="selfRef">Figure 6</a>:
<a href="#name-established-relaya2relayb-d" class="selfRef">Established relayA2relayB Data Channel</a>
        </figcaption></figure>
</div>
<p id="section-2-16">ICE would have a priority calculation for the 3 channels, and which channel is finally
selected depends on the calculation results.<a href="#section-2-16" class="pilcrow">¶</a></p>
<p id="section-2-17">For a client, the usage of a TURN cluster SHOULD be like a single
TURN server, which means that the above 3 channels MUST still can be
successfully established through TURN cluster, moreover, all requests
from the peers of one P2P connection SHOULD be forward to the same TURN server
in the cluster, or the calculation formula would be unavailable because of the
potential one more hop between the TURN server.<a href="#section-2-17" class="pilcrow">¶</a></p>
</section>
</div>
<div id="arch_design">
<section id="section-3">
      <h2 id="name-architectural-and-interacti">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-architectural-and-interacti" class="section-name selfRef">Architectural and Interactive Process</a>
      </h2>
<p id="section-3-1">A single TURN server always serves on a default port(e.g., 3478 for UDP/TCP, 5349 for TLS),
and allocates ports for client relay. In order to be compatible with the existing
TURN implementation, a TURN server in cluster SHOULD also work in a similar way.
In addition, the TURN server requires that all
allocated ports can be accessed by the client directly. Since it is hard and insecure for
a cluster to expose a large number of ports for each server in the cluster, the TURN cluster
described in the document chooses to provide all services on the default port, and ensure the correct routing of
packets through the routable transaction id(described in <a href="#tid_gen" class="xref">Section 4.2</a>).
This section will describe the architecture for the TURN cluster,
and introduces the interaction process between client and cluster.<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="arch">
<section id="section-3.1">
        <h3 id="name-overview-of-the-architectur">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-overview-of-the-architectur" class="section-name selfRef">Overview of the Architectural</a>
        </h3>
<p id="section-3.1-1">The structure of the TURN cluster is not complicated,
which just has a front-end load balancer "TURN LB" as the gateway to forward client requests to
corresponding TURN server, and the TURN server is the equipment that really provides
service. As described in Section 1 of <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span>, A client using TURN
must have some way to communicate the relayed information
to its peers, and to learn each peer's relay information, here we use "signaling server"
described in <span>[<a href="#RFC8445" class="xref">RFC8445</a>]</span> to represent this component, the network topology(including the internal
architecture of TURN cluster) is depicted in figure below:<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<span id="name-example-topology-of-client-"></span><div id="fig-turn-cluster-stru">
<figure id="figure-7">
          <div class="alignLeft art-text artwork" id="section-3.1-2.1">
<pre>
                  +------------------+
          +------&gt;| signaling server |&lt;-------+
          |       +------------------+        |
    +----------+                        +----------+
    | client A |                        | client B |
    +----------+                        +----------+
 10.243.22.200:23768                  10.69.127.39:32102
          |                                   |
          +-------------+       +-------------+
                        |       |
+-----------------------|-------|-----------------------+
| TURN cluster          |       |                       |
|                       v       v                       |
|                    10.11.252.43:3478                  |
|                      +---------+                      |
|                      | TURN LB |                      |
|                      +---------+                      |
|                       |       |                       |
|        +--------------+       |                       |
|        |                      |                       |
|        v                 +----+                       |
| 192.168.1.2:3478         |                            |
| +-------------+          v            +-------------+ |
| |TURN server 1| 192.168.1.2:61002  ...|TURN server n| |
| +-------------+                       +-------------+ |
+-------------------------------------------------------+
</pre>
</div>
<figcaption><a href="#figure-7" class="selfRef">Figure 7</a>:
<a href="#name-example-topology-of-client-" class="selfRef">Example Topology of Client and TURN Cluster</a>
          </figcaption></figure>
</div>
<p id="section-3.1-3">The functions of each component are as follows:<a href="#section-3.1-3" class="pilcrow">¶</a></p>
<p id="section-3.1-4">Client A/B: All peers of one P2P relay connection.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
<p id="section-3.1-5">Signaling server: A server for all clients to exchange TURN information with its peers,
this specification does not involve its specific process and implementation, Implementers
can refer to the "signaling server" defined in <span>[<a href="#RFC8445" class="xref">RFC8445</a>]</span> for implementation<a href="#section-3.1-5" class="pilcrow">¶</a></p>
<p id="section-3.1-6">TURN LB: A device that performs two functions:(1)Ensure the load balance of all
servers in the cluster; (2)Ensure that data from all
peers of a P2P connection can be routed to an appropriate TURN server.<a href="#section-3.1-6" class="pilcrow">¶</a></p>
<p id="section-3.1-7">TURN server: The real TURN service provider.<a href="#section-3.1-7" class="pilcrow">¶</a></p>
<p id="section-3.1-8">The core of the architecture design is:
* Provide TURN services through a unified access portal.
* Using TURN LB and mechanism described in <a href="#route-mech" class="xref">Section 4</a> to ensure
all packets can be routed to the appropriate backend TURN server.
* Each TURN server in the cluster just works like a single TURN
server, the difference is that the TURN server MUST
use ENCRYPTED-RELAYED-ADDRESS(defined in <a href="#ERA-gen" class="xref">Section 4.1</a>) to transmit allocation
information instead of XOR-RELAYED-ADDRESS, in order
to avoid the exposing of internal network information. In additional, since
the address information is encrypted in ENCRYPTED-RELAYED-ADDRESS, and the client
cannot extract it directly, client MUST use ENCRYPTED-PEER-ADDRESS(defined
in <a href="#EPA_gen" class="xref">Section 4.4</a>) to specify the address information of the peer instead of XOR-PEER-ADDRESS.<a href="#section-3.1-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="overview-of-interaction-process">
<section id="section-3.2">
        <h3 id="name-overview-of-interaction-pro">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-overview-of-interaction-pro" class="section-name selfRef">Overview of interaction process</a>
        </h3>
<p id="section-3.2-1">Since the TURN server in the cluster MUST transmit allocation information through
ENCRYPTED-RELAYED-ADDRESS to protecting cluster internal network information,
client can not get the allocated address directly, and the
establishing of srflxA2relayB and relayA2srflxB cannot be the same as usual.
As depicted in <a href="#fig-turn-cluster-stru" class="xref">Figure 7</a>, all requests can only be sent
to the unified access portal of cluster, in order to ensure the correct forwarding of requests,
some routing message MUST be carried in a request, when TURN LB receive requests, it
MUST extract and parse the routing message, and forward requests depend on it.
The overall interactive processing is shown in the following figure, related address information comes
from <a href="#fig-turn-cluster-stru" class="xref">Figure 7</a> and ERA in the figure corresponds to
ENCRYPTED-PEER-ADDRESS(defined in <a href="#ERA-gen" class="xref">Section 4.1</a>):<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<span id="name-interaction-process-between"></span><div id="fig-turn-cluster-interac">
<figure id="figure-8">
          <div class="alignLeft art-text artwork" id="section-3.2-2.1">
<pre>
  clientA                     TURN cluster                  clientB
    |                             |                             |
    |----------TURN Req----------&gt;|                             |
    |   (to 10.11.252.43:3478)    |                             |
    |                             |                             |
    |&lt;---------TURN Resp----------|                             |
    |   (carry routing-info-A     |                             |
    |          in ERA)            |                             |
    |                             |                             |
    |--ClientA ICE Candidate Info------------------------------&gt;|
    |                             |                             |
    |                             |           extract routing-info-A
    |                             |            from clientA's ERA
    |                             |                             |
    |                             |&lt;---------TURN Req-----------|
    |                             |   (to 10.11.252.43:3478,    |
    |                             |    with routing-info-A)     |
    |                             |                             |
    |                             |----------TURN Resp---------&gt;|
    |                             |    (carry routing-info-B    |
    |                             |           in ERA)           |
    |                             |                             |
    |&lt;-----------------------------clientB ICE Candidate Info---|
    |                             |                             |
extract routing-info-B            |                             |
 from clientB's ERA               |                             |
    |                             |                             |
    |&lt;----Connectivity Checks----&gt;|&lt;----Connectivity Checks----&gt;|
    |   (to 10.11.252.43:3478,    |   (to 10.11.252.43:3478,    |
    |    with routing-info-B)     |    with routing-info-A)     |
    |                             |                             |
    |&lt;------------Data-----------&gt;|&lt;-----------Data------------&gt;|
    | (from/to 10.11.252.43:3478) | (from/to 10.11.252.43:3478) |
</pre>
</div>
<figcaption><a href="#figure-8" class="selfRef">Figure 8</a>:
<a href="#name-interaction-process-between" class="selfRef">Interaction Process Between Client and TURN Cluster</a>
          </figcaption></figure>
</div>
<div id="clienta-behavior">
<section id="section-3.2.1">
          <h4 id="name-clienta-behavior">
<a href="#section-3.2.1" class="section-number selfRef">3.2.1. </a><a href="#name-clienta-behavior" class="section-name selfRef">ClientA Behavior</a>
          </h4>
<p id="section-3.2.1-1">When the clientA starts an ICE process,
it first sends a STUN/TURN request as usual. Since currently clientA does not have any information
about the server and clientB, clientA MUST use "Arbitrary-mode" defined in <a href="#tid_gen" class="xref">Section 4.2</a> to generate
transaction ID for requests. After receiving the Allocate success response, clientA will extract
ENCRYPTED-RELAYED-ADDRESS from the response and send it to clientB in Candidate Information.<a href="#section-3.2.1-1" class="pilcrow">¶</a></p>
<p id="section-3.2.1-2">Later clientA will receive Candidate Information from clientB, which include
clientB's ENCRYPTED-RELAYED-ADDRESS, clientA MUST extract routing-info-B from
it and start connectivity checks. For establishing "srflxA2relayB" data channel,
the Bind request of clientA SHOULD be sent to the relayed address obtained by
clientB from the server, then clientA MUST use "Specific-address-mode" to generate
transaction ID for the Binding request. For establishing "relayA2srflxB" and "relayA2relayB"
data channel, related requests SHOULD be sent to the TURN server that clientA
had accessed before, then clientA MUST use "Specific-server-mode" to generate
transaction ID for these requests.<a href="#section-3.2.1-2" class="pilcrow">¶</a></p>
<p id="section-3.2.1-3">Above 3 relayed data channels have their own ways to transmit application data,
for "srflxA2relayB", clientA can just send UDP datagram to the unified access portal
of cluster, and the routing records left by the previous Binding request can
ensure that they can be forwarded correctly. For "relayA2srflxB" and "relayA2relayB",
there are 2 mechanism for clientA sending application data to clientB: (1)Send
Indication(defined in Section 11 of <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span>); (2)Bind a Channel and
send ChannelData message(defined in Section 12 of <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span>), where these two mechanism
MUST use "Specific-server-mode" to generate transaction ID for indication(defined in
Section 11 of <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span>), meanwhile, client MUST use
ENCRYPTED-PEER-ADDRESS(description in <a href="#EPA_gen" class="xref">Section 4.4</a>) to specify
the address of peer instead of XOR-PEER-ADDRESS. For Channel mechanism, after success building
a channel by Binding request, the later ChannelData message will be
routed by the routing records left by the Binding request.<a href="#section-3.2.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="clientb-behavior">
<section id="section-3.2.2">
          <h4 id="name-clientb-behavior">
<a href="#section-3.2.2" class="section-number selfRef">3.2.2. </a><a href="#name-clientb-behavior" class="section-name selfRef">ClientB Behavior</a>
          </h4>
<p id="section-3.2.2-1">The behavior of ClientB is just similar to clientA, the difference is that
when clientB sends STUN/TURN requests for the first time,
it have already known which server it should access through the routing-info-A brought by clientA,
so, clientB MUST use "Specific-server-mode" to generate transaction ID for these requests.<a href="#section-3.2.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="turn-cluster-behavior">
<section id="section-3.2.3">
          <h4 id="name-turn-cluster-behavior">
<a href="#section-3.2.3" class="section-number selfRef">3.2.3. </a><a href="#name-turn-cluster-behavior" class="section-name selfRef">TURN Cluster Behavior</a>
          </h4>
<p id="section-3.2.3-1">A TURN Service cluster consists of 2 components, TURN LB and TURN server, the TURN LB is
used to forward all packets to the right TURN server, and TURN server is
the actual TURN service provider.<a href="#section-3.2.3-1" class="pilcrow">¶</a></p>
<div id="turn_lb_behavior">
<section id="section-3.2.3.1">
            <h5 id="name-turn-lb-behavior">
<a href="#section-3.2.3.1" class="section-number selfRef">3.2.3.1. </a><a href="#name-turn-lb-behavior" class="section-name selfRef">TURN LB Behavior</a>
            </h5>
<p id="section-3.2.3.1-1">TURN LB forwards packets through two elements:<a href="#section-3.2.3.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2.3.1-2.1">A self maintained routing-map, whose key is: concat(client source IP address, client source Port),
and value is: concat(upstream TURN server IP address, upstream TURN server port).<a href="#section-3.2.3.1-2.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-3.2.3.1-2.2">Routing information in transaction ID.<a href="#section-3.2.3.1-2.2" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-3.2.3.1-3">When a packet arrives, a TURN LB SHOULD resolve and process packet as below:<a href="#section-3.2.3.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2.3.1-4.1">TURN LB first determines whether this packet is in STUN format, if so, TURN LB
will extract the transaction ID from the packet, and process this packet through the way
described in <a href="#lb_proc_tid" class="xref">Section 4.3</a>.<a href="#section-3.2.3.1-4.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-3.2.3.1-4.2">If this packet is not in STUN format, TURN LB will extract the
source IP address and port of the packet to form the key, and try to get the upstream TURN
server IP address and port through the key and routing-map, if successfully,
TURN LB will forward the packet to the upstream TURN server directly, and refresh
the expiration time of the corresponding routing record.
If failed, drop this packet silently.<a href="#section-3.2.3.1-4.2" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-3.2.3.1-5">Moreover, TURN LB SHOULD NOT modify the source IP address and port of the packet,
for a TURN cluster MAY still provide STUN service.<a href="#section-3.2.3.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="turn-server-behavior">
<section id="section-3.2.3.2">
            <h5 id="name-turn-server-behavior">
<a href="#section-3.2.3.2" class="section-number selfRef">3.2.3.2. </a><a href="#name-turn-server-behavior" class="section-name selfRef">TURN Server Behavior</a>
            </h5>
<p id="section-3.2.3.2-1">For most STUN/TURN messages, the TURN server processes them as defined in <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span>,
while there are some special requirements for XOR-RELAYED-ADDRESS and XOR-PEER-ADDRESS.
Instead of transmitting allocation information by XOR-RELAYED-ADDRESS, the TURN server MUST
use ENCRYPTED-RELAYED-ADDRESS described in <a href="#ERA-gen" class="xref">Section 4.1</a> to protect internal
network information. And when the TURN server receives
an ENCRYPTED-PEER-ADDRESS attribute, it MUST process
it as described in<a href="#EPA_gen" class="xref">Section 4.4</a>. In addition, since a TURN server in the cluster MAY also provide STUN
service, it SHOULD avoid carrying any attributes(e.g., RESPONSE-ORIGIN, RESPONSE-PORT defined in
<span>[<a href="#RFC5780" class="xref">RFC5780</a>]</span>) that expose internal network information in the stun response<a href="#section-3.2.3.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="route-mech">
<section id="section-4">
      <h2 id="name-routing-mechanism">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-routing-mechanism" class="section-name selfRef">Routing Mechanism</a>
      </h2>
<p id="section-4-1">This section defines the conventions for related components in <a href="#fig-turn-cluster-stru" class="xref">Figure 7</a>
securely generate and transmit routing information. It describes:(1) How does the TURN server
generate ENCRYPTED-RELAYED-ADDRESS to securely carry routing information; (2) How does the client
generate routable transaction ID with ENCRYPTED-RELAYED-ADDRESS and specify address of peer
by ENCRYPTED-PEER-ADDRESS; (3) How does the TURN LB process routable
transaction ID and forward packets.<a href="#section-4-1" class="pilcrow">¶</a></p>
<div id="ERA-gen">
<section id="section-4.1">
        <h3 id="name-server-generate-encrypted-r">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-server-generate-encrypted-r" class="section-name selfRef">Server Generate ENCRYPTED-RELAYED-ADDRESS</a>
        </h3>
<p id="section-4.1-1">ENCRYPTED-RELAYED-ADDRESS is a new STUN attribute defined in this
specification, which attribute value is TBD1(IANA is requested to
assign TBD1 a value in the range 0x000e-0x000f).
The generation of ENCRYPTED-RELAYED-ADDRESS is divided into 3 phases:(1) Preparation
phase; (2) Obfuscated phase; (3) Encryption phase.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<div id="preparation-phase">
<section id="section-4.1.1">
          <h4 id="name-preparation-phase">
<a href="#section-4.1.1" class="section-number selfRef">4.1.1. </a><a href="#name-preparation-phase" class="section-name selfRef">Preparation Phase</a>
          </h4>
<p id="section-4.1.1-1">The preparation phase is triggered at the time of preparing for cluster establishment or
updating the members of the cluster. In the preparation phase, the maintainer of the cluster
will generate and synchronize configuration to TURN LB and each TURN server inside the cluster.
The configuration consists of 4 parts: (1) A 2 bits Configuration-ID, which is used to uniquely
identify the configuration when the cluster configuration rotates; (2) An arbitrary nonnegative
integer "divisor", which is used to do obfuscated calculation, "divisor" MUST be larger
than the numbers of TURN server; (3) A set of "modulus", which is
used to uniquely identifies each server in the cluster; (4) A 16 byte "key", which is used
in encryption phase. The maintainer of cluster MUST perform the following operations in the
preparation phase:<a href="#section-4.1.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.1-2.1">Select a configuration ID for the configuration. The maintainer SHOULD ensure
that there are no clients that are still using the configuration corresponding to the selected ID.<a href="#section-4.1.1-2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.1.1-2.2">Generate "divisor", "modulus" set and "key" defined in the configuration as required.<a href="#section-4.1.1-2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.1.1-2.3">If the cluster currently has a configuration in use, set its state to be "wait to be offline".<a href="#section-4.1.1-2.3" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.1.1-2.4">Synchronize new configuration ID, "divisor" and "key" to TURN LB and each TURN
server, then assigned each TURN server its own "modulus", and synchronize the mapping
between the "modulus" and TURN server IP address to TURN LB.<a href="#section-4.1.1-2.4" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-4.1.1-2.5">Set the state of the new configuration to be "active". Note there MUST be only one
configuration at the "active" state. TURN server MUST NOT generate
new ENCRYPTED-RELAYED-ADDRESS using an old configuration after receiving a new one.<a href="#section-4.1.1-2.5" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="obfuscation-phase">
<section id="section-4.1.2">
          <h4 id="name-obfuscation-phase">
<a href="#section-4.1.2" class="section-number selfRef">4.1.2. </a><a href="#name-obfuscation-phase" class="section-name selfRef">Obfuscation Phase</a>
          </h4>
<p id="section-4.1.2-1">When a TURN server begins to generate ENCRYPTED-RELAYED-ADDRESS for Allocate success response,
it starts the Obfuscation phase. In Obfuscation phase, TURN server use divisor and its modulus
from the currently used configuration to generate Obfuscated-address, the struct of Obfuscated-address
is depicted below:<a href="#section-4.1.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.1.2-2">
<pre>
Obfuscated-address {
  Configuration-ID(2),
  Obfuscated-value(30)
}
</pre><a href="#section-4.1.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1.2-3">Obfuscated-value is calculated by adding an arbitrary nonnegative integer
multiple of the "divisor" to its "modulus", without exceeding the maximum integer value 2^30.<a href="#section-4.1.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encryption-phase">
<section id="section-4.1.3">
          <h4 id="name-encryption-phase">
<a href="#section-4.1.3" class="section-number selfRef">4.1.3. </a><a href="#name-encryption-phase" class="section-name selfRef">Encryption Phase</a>
          </h4>
<p id="section-4.1.3-1">After getting Obfuscated-address, the TURN server starts the Encryption phase,
it first server left-padding the magic cookie with zeros to a 16Bytes string, and encrypt
it with the "key" obtained in the preparation phase. Encryption in the algorithms
below uses the AES-128-ECB cipher, and the encryption result is recorded as "mask". Then,
TURN server begin to generate ENCRYPTED-RELAYED-ADDRESS with the "mask",
the struct of ENCRYPTED-RELAYED-ADDRESS is shown below:<a href="#section-4.1.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.1.3-2">
<pre>
ENCRYPTED-RELAYED-ADDRESS {
  Attribute-Type(8),
  Reserve-bit(2),
  Encoded-Check-bit(6),
  Encoded-Port(16),
  Encoded-Obfuscated-Address(32)
}
</pre><a href="#section-4.1.3-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1.3-3">ENCRYPTED-RELAYED-ADDRESS has the following fields:<a href="#section-4.1.3-3" class="pilcrow">¶</a></p>
<p id="section-4.1.3-4">Attribute-Type: IANA is requested to assign a value for it.<a href="#section-4.1.3-4" class="pilcrow">¶</a></p>
<p id="section-4.1.3-5">Reserve-bit: A 2bits value reserved for two special purposes.<a href="#section-4.1.3-5" class="pilcrow">¶</a></p>
<p id="section-4.1.3-6">The Encoded-Check-bit, Encoded-Obfuscated-Address,Encoded-configuration-ID and Encoded-Port
are calculated by the function defined below:<a href="#section-4.1.3-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.1.3-7">
<pre>
Encoded-Check-bit = mask[0:6] ^ plaintext-check-bit
Encoded-Port = mask[6:22] ^ allocate-port
Encoded-Obfuscated-Address = mask[22:54] ^ Obfuscated-Address
</pre><a href="#section-4.1.3-7" class="pilcrow">¶</a>
</div>
<p id="section-4.1.3-8">While plaintext-check-bit is a 6 bits value with all bits of '1', and
allocate-port is the 16 bits port value allocated by the TURN server.<a href="#section-4.1.3-8" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="tid_gen">
<section id="section-4.2">
        <h3 id="name-generation-of-routable-tran">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-generation-of-routable-tran" class="section-name selfRef">Generation of Routable Transaction ID</a>
        </h3>
<p id="section-4.2-1">As described in <span>[<a href="#RFC8489" class="xref">RFC8489</a>]</span>, The transaction ID is a 96-bit identifier generated by
the client, to uniquely identify STUN transactions, it is always a uniformly
and randomly chosen value. Actually, 96 bits is over abundant, we can further
design the transaction ID, so that it can not only implement the uniqueness,
but also securely carry some routing information and check information. The structure of a Routable
Transaction ID is shown below:<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.2-2">
<pre>
Routable Transaction ID {
  Mode-bit (2),
  Routing-info (6..54),
  Random-bit (40..88),
}
</pre><a href="#section-4.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.2-3">While the Mode-bit correspond to 3 route modes, and each mode has its corresponding routing information,
3 modes are depicted below:<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-4.1">Arbitrary mode: Corresponding request can be sent to the default port of any TURN server in
the cluster.<a href="#section-4.2-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.2-4.2">Specific-server-mode: Corresponding request MUST be sent to the default port of
the specific TURN server.<a href="#section-4.2-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.2-4.3">Specific-address-mode: Corresponding request MUST be sent to the specified port of
the specific TURN server<a href="#section-4.2-4.3" class="pilcrow">¶</a>
</li>
        </ul>
<div id="arbitrary-mode">
<section id="section-4.2.1">
          <h4 id="name-arbitrary-mode">
<a href="#section-4.2.1" class="section-number selfRef">4.2.1. </a><a href="#name-arbitrary-mode" class="section-name selfRef">Arbitrary Mode</a>
          </h4>
<p id="section-4.2.1-1">The typical scenario of "Arbitrary-mode" is that when a client send the
first STUN/TURN request to the cluster at the beginning of ICE process, it
does not have any information about TURN server, so client SHOULD set the
Mode-bit to "00", and the routing information of transaction ID is
just the 6bits check-bit with all bits of '1', as depicted below:<a href="#section-4.2.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.2.1-2">
<pre>
Routing-info {
  Check-bit(6)
}
</pre><a href="#section-4.2.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.2.1-3">After that, the client will generate a 88bit random string as the Random-bit.<a href="#section-4.2.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="specific-server-mode">
<section id="section-4.2.2">
          <h4 id="name-specific-server-mode">
<a href="#section-4.2.2" class="section-number selfRef">4.2.2. </a><a href="#name-specific-server-mode" class="section-name selfRef">Specific Server Mode</a>
          </h4>
<p id="section-4.2.2-1">The scenarios suitable for mode B are: The client has received ENCRYPTED-XOR-RELAY-ADDRESS
from TURN server or peer, and it expects to send a request to the TURN server
corresponding to the ENCRYPTED-XOR-RELAY-ADDRESS.
For example: (1) Client has established a RTP relay connection in a TURN server, and wants to
establish a RTP/RTCP connection pair in the same TURN server; (2) Client has received
ENCRYPTED-XOR-RELAY-ADDRESS from peer Candidate Information
and expects to apply for the relay port in the same TURN server.
At this mode, client MUST set Mode-bit to "01", and Routing-info struct
is depicted below:<a href="#section-4.2.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.2.2-2">
<pre>
Routing-info {
  Encoded-Check-bit(6),
  Encoded-Obfuscated-Address(32),
}
</pre><a href="#section-4.2.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.2.2-3">Encoded-Check-bit and Encoded-Address Here are obtained directly from ENCRYPTED-XOR-RELAY-ADDRESS.
The rest 56bit of transaction ID MUST be a cryptographically random value.<a href="#section-4.2.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="specific-address-mode">
<section id="section-4.2.3">
          <h4 id="name-specific-address-mode">
<a href="#section-4.2.3" class="section-number selfRef">4.2.3. </a><a href="#name-specific-address-mode" class="section-name selfRef">Specific Address Mode</a>
          </h4>
<p id="section-4.2.3-1">At Specific Address Mode, client MUST have receive ENCRYPTED-XOR-RELAY-ADDRESS and expect
to send a request to the specific port of the specific TURN server, a typical scenario is
that: Client has received ENCRYPTED-XOR-RELAY-ADDRESS from peer Candidate Information,
and expects to send a Bind request to the address of ENCRYPTED-XOR-RELAY-ADDRESS.
At this mode, client SHOULD set Mode-bit to "10", and Routing-info struct
is depicted below:<a href="#section-4.2.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.2.3-2">
<pre>
Routing-info {
  Encoded-Check-bit(6),
  Encoded-Obfuscated-Address(32),
  Encoded-Port(16),
}
</pre><a href="#section-4.2.3-2" class="pilcrow">¶</a>
</div>
<p id="section-4.2.3-3">Client MUST set Mode-bit to '10', and extract Encoded-Check-bit, Encoded-Port and Encoded-Address
from ENCRYPTED-XOR-RELAY-ADDRESS., and set it to transaction ID. then generate a 40bit random string
to fill the rest of the transaction ID.<a href="#section-4.2.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="uniqueness-of-transaction-id">
<section id="section-4.2.4">
          <h4 id="name-uniqueness-of-transaction-i">
<a href="#section-4.2.4" class="section-number selfRef">4.2.4. </a><a href="#name-uniqueness-of-transaction-i" class="section-name selfRef">Uniqueness of Transaction ID</a>
          </h4>
<p id="section-4.2.4-1">This section will make a simple analysis of the uniqueness of the routable transaction ID,
the routable transaction ID still depends on a large enough value range and
random selection to ensure uniqueness. In fact, the routing part in transaction ID reduces
the value range of transaction ID, in order to avoid the value range being too small,
this specification suggest the obfuscated way to encode address, then the value range
of transaction ID is determined by two factors: the length of random bit and the
number of cluster machines N, and the value range of
routable transaction ID under the three modes is shown in the table below:<a href="#section-4.2.4-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.2.4-2">
<pre>
+-------------------------+------------------+
|           mode          |    value range   |
+-------------------------+------------------+
|     Arbitrary Mode      |     0 - 2^88     |
+-------------------------+------------------+
|   Specific Server Mode  |   0 - (2^88)/N   |
+-------------------------+------------------+
|  Specific Address Mode  |   0 - (2^72)/N   |
+-------------------------+------------------+
</pre><a href="#section-4.2.4-2" class="pilcrow">¶</a>
</div>
<p id="section-4.2.4-3">In production environment, the number of machines in a TURN cluster is not particularly large,
so the value range of arbitrary mode and specific server mode is enough for
most scenarios. As for specific address mode, only related peers will use this mode to access
the same address, so it can work well without a particularly large value range.<a href="#section-4.2.4-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="lb_proc_tid">
<section id="section-4.3">
        <h3 id="name-turn-lb-process-transaction">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-turn-lb-process-transaction" class="section-name selfRef">TURN LB Process Transaction ID</a>
        </h3>
<p id="section-4.3-1">When a TURN LB receives a TURN packet, it first extracts the first 2 bits of transaction ID,
if the first 2 bits are "11", the TURN LB will drop this packet silently.
Later TURN LB will determine the mode of the client by the first 2 bits. For arbitrary mode requests, TURN LB will
check whether the next 6 bits are all '1', if not, TURN LB SHOULD drop this packet
silently. If yes, TURN LB will forward this packet to
a backend TURN server default port depending on each server's load condition.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.3-2">For specific server Mode and specific address Mode requests, TURN LB would first
generate "mask" just as defined in encryption phase of <a href="#ERA-gen" class="xref">Section 4.1</a>, and calculate
plaintext-check-bit and Obfuscated-Address as below:<a href="#section-4.3-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.3-3">
<pre>
plaintext-check-bit = mask[0:6] ^ Encoded-Check-bit
Obfuscated-Address  = mask[22:54] ^ Encoded-Obfuscated-Address
</pre><a href="#section-4.3-3" class="pilcrow">¶</a>
</div>
<p id="section-4.3-4">TURN LB then checks if all bits of plaintext-check-bit are all '1',
if the check fails, TURN LB will drop this packet silently. If success,
TURN LB SHOULD perform the following sequence of steps:<a href="#section-4.3-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.3-5">
<li id="section-4.3-5.1">Extract configuration ID and Obfuscated-value from Obfuscated-Address, and get the configuration
corresponding to the configuration ID.<a href="#section-4.3-5.1" class="pilcrow">¶</a>
</li>
          <li id="section-4.3-5.2">Express Obfuscated-value as an unsigned integer, and divide the result by the "divisor" to
get the modulus of the request.<a href="#section-4.3-5.2" class="pilcrow">¶</a>
</li>
          <li id="section-4.3-5.3">Use modulus to get TURN server IP address from the TURN LB self maintain map.
If "modulus" cannot be mapped to any TURN server, drop this packet silently.<a href="#section-4.3-5.3" class="pilcrow">¶</a>
</li>
          <li id="section-4.3-5.4">If the TURN server selected in step3 is offline because of configuration rotation,
TURN LB SHOULD send an error response to the client, with setting the
ERR_CODE to be TBD3(IANA is request to assign a "4xx" err code for this value, to indicate
request is failed because of the configuration problem).<a href="#section-4.3-5.4" class="pilcrow">¶</a>
</li>
          <li id="section-4.3-5.5">If the TURN server selected in step3 works well, then it will forward the packet by the mode, for
specific server Mode, TURN LB will forward the packet to the default port of the TURN server. For
specific address Mode, TURN LB will forward the packet to the specific-port of the TURN server.<a href="#section-4.3-5.5" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-4.3-6">The specific-port of step5 is calculated as below:<a href="#section-4.3-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.3-7">
<pre>
allocate-port = mask[6:22] ^ Encoded-Port
</pre><a href="#section-4.3-7" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="EPA_gen">
<section id="section-4.4">
        <h3 id="name-encrypted-peer-address">
<a href="#section-4.4" class="section-number selfRef">4.4. </a><a href="#name-encrypted-peer-address" class="section-name selfRef">ENCRYPTED-PEER-ADDRESS</a>
        </h3>
<p id="section-4.4-1">ENCRYPTED-PEER-ADDRESS is a new STUN attribute defined in this
specification, which attribute value is TBD2(IANA is requested to
assign TBD1 a value in the range 0x000e-0x000f).
Similar to XOR-PEER-ADDRESS, the ENCRYPTED-PEER-ADDRESS is also used to
indicate server the address and port of the peer, while the ENCRYPTED-PEER-ADDRESS
is applicable to the scenario where the address and port of the peer is contained
in ENCRYPTED-RELAYED-ADDRESS. ENCRYPTED-PEER-ADDRESS has the same struct
as ENCRYPTED-RELAYED-ADDRESS, and IANA is requested to assign a type value for
ENCRYPTED-PEER-ADDRESS.<a href="#section-4.4-1" class="pilcrow">¶</a></p>
<p id="section-4.4-2">TURN server MUST perform the following steps to process
ENCRYPTED-PEER-ADDRESS attribute.<a href="#section-4.4-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.4-3">
<li id="section-4.4-3.1">Calculate plaintext-check-bit, allocate-port and Obfuscated-Address by the mask
and formula defined in <a href="#ERA-gen" class="xref">Section 4.1</a>.<a href="#section-4.4-3.1" class="pilcrow">¶</a>
</li>
          <li id="section-4.4-3.2">Check if all bits of plaintext-check-bit are all '1', if the check fails, the TURN server SHOULD
drop this packet silently.<a href="#section-4.4-3.2" class="pilcrow">¶</a>
</li>
          <li id="section-4.4-3.3">Extract configuration ID and Obfuscated-value from Obfuscated-Address, and get the "divisor"
and "modulus" of the server by configuration id.<a href="#section-4.4-3.3" class="pilcrow">¶</a>
</li>
          <li id="section-4.4-3.4">Express Obfuscated-value as an unsigned integer, and divide the result by the "divisor" to
get the "modulus" of the request. Check if the "modulus" of the request is equal to the
"modulus" of the server, if not equal, TURN server SHOULD
send an error response to the client, with setting the ERR_CODE to
be TBD4(IANA is request to assign a "4xx" err code for this value, to indicate
request is failed due to access to an inappropriate server). If equal, the TURN
server then sends the packet to the corresponding address.<a href="#section-4.4-3.4" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-4.4-4">The check at step4 is based on this consideration: Since the cluster has
provided the routing mechanisms, all peers of a relayed channel SHOULD be
connected to the same server to avoid extra hops in the network.<a href="#section-4.4-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="tls-consideration">
<section id="section-4.5">
        <h3 id="name-tls-consideration">
<a href="#section-4.5" class="section-number selfRef">4.5. </a><a href="#name-tls-consideration" class="section-name selfRef">TLS Consideration</a>
        </h3>
<p id="section-4.5-1">For most STUN/TURN requests, TURN LB forwards them based on transaction ID, if
these messages are transmitted over DTLS-over-UDP or TLS-over-TCP, TURN LB
cannot see the transaction ID directly. In these cases, TURN LB MUST also play
a role of TLS offload device to obtain the plaintext transaction ID.<a href="#section-4.5-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-consideration">
<section id="section-5">
      <h2 id="name-security-consideration">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-security-consideration" class="section-name selfRef">Security Consideration</a>
      </h2>
<p id="section-5-1">This document describes an architectural framework for building large-scale TURN clusters,
since an attacker cannot obtain network information of a TURN server inside the cluster, attacks
based on source address forgery(e.g., TURN loop attack) can be effectively prevented.
While a TURN cluster still suffers most attacks against a single TURN server,
This section will discuss possible attacks on a TURN cluster.
For the attacks discussed in Section 21 of <span>[<a href="#RFC8656" class="xref">RFC8656</a>]</span>,
if they are not mentioned in this section, it indicates that the
relevant analysis of the attack is still valid for the TURN cluster.<a href="#section-5-1" class="pilcrow">¶</a></p>
<div id="dos-against-turn-cluster">
<section id="section-5.1">
        <h3 id="name-dos-against-turn-cluster">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-dos-against-turn-cluster" class="section-name selfRef">DoS Against TURN Cluster</a>
        </h3>
<p id="section-5.1-1">An attacker might generate a large number of legitimate allocation requests and
flood it, to exhaust the available ports of all TURN servers in the cluster.
Since all requests are legitimate, the attack cannot be prevented directly.
The maintainer of the TURN cluster can set up some custom address-based rules,
which limit the number of allocation requests from the same source address to
mitigate this attack.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="dos-against-a-single-turn-server">
<section id="section-5.2">
        <h3 id="name-dos-against-a-single-turn-s">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-dos-against-a-single-turn-s" class="section-name selfRef">DoS Against a Single TURN Server</a>
        </h3>
<p id="section-5.2-1">Since the routing message in the transaction ID is encrypted and will be checked, it is
hard for an attacker to construct a large number legitimate TURN request to attack
a single TURN server. However, ChannelData messages are routed by the address, an
attacker might obtain a ChannelData and flood the corresponding channel with traffic.
This attack is mitigated by the recommendation that the server limit the amount
of bandwidth it will relay for a given username or just use (D)TLS to avoid
forgery of legal ChannelData messages.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="iana-consideration">
<section id="section-6">
      <h2 id="name-iana-consideration">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-iana-consideration" class="section-name selfRef">IANA Consideration</a>
      </h2>
<p id="section-6-1">IANA is requested to assign the type values for the attribute
ENCRYPTED-RELAYED-ADDRESS(defined in <a href="#ERA-gen" class="xref">Section 4.1</a>) and ENCRYPTED-PEER-ADDRESS(defined
in <a href="#EPA_gen" class="xref">Section 4.4</a>).<a href="#section-6-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6-2">
<pre>
+----------------+---------------------------+-----------------+
| attribute type |        description        |   reference     |
+----------------+---------------------------+-----------------+
|                |         value for         |                 |
|      TBD1      | ENCRYPTED-RELAYED-ADDRESS,|    this RFC     |
|                |    used to carry relayed  |  ({{ERA-gen}})) |
|                |       address safely      |                 |
+----------------+---------------------------+-----------------+
|                |         value for         |                 |
|      TBD2      |  ENCRYPTED-PEER-ADDRESS,  |    this RFC     |
|                | used to carry peer address|  ({{EPA_gen}})  |
|                |          safely           |                 |
+----------------+--------------===----------+-----------------+
</pre><a href="#section-6-2" class="pilcrow">¶</a>
</div>
<p id="section-6-3">IANA is requested to assign the err code for the TBD3(defined in <a href="#lb_proc_tid" class="xref">Section 4.3</a>)
and TBD4(defined in <a href="#EPA_gen" class="xref">Section 4.4</a>) depicted below:<a href="#section-6-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6-4">
<pre>
+----------+------------------------+-----------------+
| err code |       description      |   reference     |
+----------+------------------------+-----------------+
|          | request failed due to  |                 |
|   TBD3   | server configuration   |    this RFC     |
|          | rotation               |                 |
+----------+------------------------+-----------------+
|          | request failed because |                 |
|   TBD4   | the client accessed an |    this RFC     |
|          | inappropriate server   |                 |
+----------+------------------------+-----------------+
</pre><a href="#section-6-4" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="contributors">
<section id="section-7">
      <h2 id="name-contributors">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-contributors" class="section-name selfRef">Contributors</a>
      </h2>
<p id="section-7-1">The authors would like to thank HongQuan.Z(hongquan.zhq@antgroup.com),
jim(jim.pj@alibaba-inc.com), Y.Chen(cy119846@antgroup.com),
Han.X(han.xiao@antgroup.com), Bin.Y(yb261973@antgroup.com),
and XiaoKang.Q(xiaokang.qxk@antgroup.com), LingTao.K(lingtao.klt@antgroup.com)
for their contributions to the this document.<a href="#section-7-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-8">
      <h2 id="name-references">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-8.1">
        <h3 id="name-normative-references">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5780">[RFC5780]</dt>
        <dd>
<span class="refAuthor">MacDonald, D.</span> and <span class="refAuthor">B. Lowekamp</span>, <span class="refTitle">"NAT Behavior Discovery Using Session Traversal Utilities for NAT (STUN)"</span>, <span class="seriesInfo">RFC 5780</span>, <span class="seriesInfo">DOI 10.17487/RFC5780</span>, <time datetime="2010-05" class="refDate">May 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5780">https://www.rfc-editor.org/info/rfc5780</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7478">[RFC7478]</dt>
        <dd>
<span class="refAuthor">Holmberg, C.</span>, <span class="refAuthor">Hakansson, S.</span>, and <span class="refAuthor">G. Eriksson</span>, <span class="refTitle">"Web Real-Time Communication Use Cases and Requirements"</span>, <span class="seriesInfo">RFC 7478</span>, <span class="seriesInfo">DOI 10.17487/RFC7478</span>, <time datetime="2015-03" class="refDate">March 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7478">https://www.rfc-editor.org/info/rfc7478</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8445">[RFC8445]</dt>
        <dd>
<span class="refAuthor">Keranen, A.</span>, <span class="refAuthor">Holmberg, C.</span>, and <span class="refAuthor">J. Rosenberg</span>, <span class="refTitle">"Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal"</span>, <span class="seriesInfo">RFC 8445</span>, <span class="seriesInfo">DOI 10.17487/RFC8445</span>, <time datetime="2018-07" class="refDate">July 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8445">https://www.rfc-editor.org/info/rfc8445</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8489">[RFC8489]</dt>
        <dd>
<span class="refAuthor">Petit-Huguenin, M.</span>, <span class="refAuthor">Salgueiro, G.</span>, <span class="refAuthor">Rosenberg, J.</span>, <span class="refAuthor">Wing, D.</span>, <span class="refAuthor">Mahy, R.</span>, and <span class="refAuthor">P. Matthews</span>, <span class="refTitle">"Session Traversal Utilities for NAT (STUN)"</span>, <span class="seriesInfo">RFC 8489</span>, <span class="seriesInfo">DOI 10.17487/RFC8489</span>, <time datetime="2020-02" class="refDate">February 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8489">https://www.rfc-editor.org/info/rfc8489</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8656">[RFC8656]</dt>
        <dd>
<span class="refAuthor">Reddy, T., Ed.</span>, <span class="refAuthor">Johnston, A., Ed.</span>, <span class="refAuthor">Matthews, P.</span>, and <span class="refAuthor">J. Rosenberg</span>, <span class="refTitle">"Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)"</span>, <span class="seriesInfo">RFC 8656</span>, <span class="seriesInfo">DOI 10.17487/RFC8656</span>, <time datetime="2020-02" class="refDate">February 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8656">https://www.rfc-editor.org/info/rfc8656</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9000">[RFC9000]</dt>
      <dd>
<span class="refAuthor">Iyengar, J., Ed.</span> and <span class="refAuthor">M. Thomson, Ed.</span>, <span class="refTitle">"QUIC: A UDP-Based Multiplexed and Secure Transport"</span>, <span class="seriesInfo">RFC 9000</span>, <span class="seriesInfo">DOI 10.17487/RFC9000</span>, <time datetime="2021-05" class="refDate">May 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9000">https://www.rfc-editor.org/info/rfc9000</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-8.2">
        <h3 id="name-informative-references">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="TURN-Load-balance">[TURN-Load-balance]</dt>
      <dd>
<span class="refTitle">"TURN Performance and Load Balance"</span>, <span>n.d.</span>, <span>&lt;<a href="https://github.com/coturn/coturn/wiki/TURN-Performance-and-Load-Balance">https://github.com/coturn/coturn/wiki/TURN-Performance-and-Load-Balance</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="authors-addresses">
<section id="appendix-A">
      <h2 id="name-authors-address">
<a href="#name-authors-address" class="section-name selfRef">Author's Address</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">William Zeng</span></div>
<div dir="auto" class="left"><span class="org">Ant Group</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:william.zk@antfin.com" class="email">william.zk@antfin.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
