<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>A Method for Sharing Record Protocol Keys with a Middlebox in TLS</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Conventions Used in This Document">
<link href="#rfc.section.2" rel="Chapter" title="2 Protocol Overview">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 The tls_keyshare Extension">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 The KeyShareInfo Record">
<link href="#rfc.section.2.2.1" rel="Chapter" title="2.2.1 The KeyShareInfo Discovery Subtype">
<link href="#rfc.section.2.2.2" rel="Chapter" title="2.2.2 The KeyShareInfo Rejection Subtype">
<link href="#rfc.section.2.2.3" rel="Chapter" title="2.2.3 The KeyShareInfo Keys Subtype">
<link href="#rfc.section.3" rel="Chapter" title="3 Processing">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Client Processing">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Server Processing">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Middlebox Processing">
<link href="#rfc.section.4" rel="Chapter" title="4 Middlebox Discovery">
<link href="#rfc.section.5" rel="Chapter" title="5 Security Considerations">
<link href="#rfc.section.6" rel="Chapter" title="6 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="7 References">
<link href="#rfc.references.1" rel="Chapter" title="7.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="7.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document contains a straw man proposal for a method for sharing symmetric session keys between a TLS client and a middlebox, so that the middlebox can decrypt the TLS-protected traffic." />
  <meta name="description" content="This document contains a straw man proposal for a method for sharing symmetric session keys between a TLS client and a middlebox, so that the middlebox can decrypt the TLS-protected traffic." />
  <meta name="keywords" content="Internet-Draft" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">TLS Working Group</td>
<td class="right">Y. Nir</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Check Point</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">September 25, 2011</td>
</tr>
<tr>
<td class="left">Expires: March 28, 2012</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">A Method for Sharing Record Protocol Keys with a Middlebox in TLS<br />
  <span class="filename">draft-nir-tls-keyshare-01</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document contains a straw man proposal for a method for sharing symmetric session keys between a TLS client and a middlebox, so that the middlebox can decrypt the TLS-protected traffic.</p>
<p>This method is an alternative to the middlebox becoming a proxy.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on March 28, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Conventions Used in This Document</a>
</li>
<li>2.   <a href="#rfc.section.2">Protocol Overview</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">The tls_keyshare Extension</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">The KeyShareInfo Record</a>
</li>
<li>2.2.1.   <a href="#rfc.section.2.2.1">The KeyShareInfo Discovery Subtype</a>
</li>
<li>2.2.2.   <a href="#rfc.section.2.2.2">The KeyShareInfo Rejection Subtype</a>
</li>
<li>2.2.3.   <a href="#rfc.section.2.2.3">The KeyShareInfo Keys Subtype</a>
</li>
<li>3.   <a href="#rfc.section.3">Processing</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Client Processing</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Server Processing</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Middlebox Processing</a>
</li>
<li>4.   <a href="#rfc.section.4">Middlebox Discovery</a>
</li>
<li>5.   <a href="#rfc.section.5">Security Considerations</a>
</li>
<li>6.   <a href="#rfc.section.6">IANA Considerations</a>
</li>
<li>7.   <a href="#rfc.references">References</a>
</li>
<li>7.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>7.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">TLS (<a href="#TLS">[TLS]</a>) is used in a wide variety of protocols. The most common use is for protecting HTTP, as described in <a href="#HTTPS">[HTTPS]</a>. Middleboxes such as firewalls scan protocols for attacks. For HTTP common attacks to scan for are cross-site scripting and transfer of files containing malware.</p>
<p id="rfc.section.1.p.2">TLS provides authentication and privacy against eavesdropping, but it hides the traffic not only from mallicious intercepters. It also hides the traffic from the middlebox, and prevents it from doing its job. Our goal is to allow the middlebox to inspect the traffic, without allowing others to do the same.</p>
<p id="rfc.section.1.p.3">The requirements can be summed up in the following points: </p>

<ul>
<li>The middlebox should be able to decrypt all TLS traffic, and optionally (the client's option) also modify it.</li>
<li>The protocol must not make it easier for other entities to decrypt the traffic.</li>
<li>The client should be able to opt out of TLS decryption, but opting out may mean that the connection is blocked.</li>
<li>The server should be able to opt out of TLS decryption, but opting out may mean that the connection is blocked.</li>
</ul>
<p id="rfc.section.1.p.4">Two proposals have been offered to achieve these goals. One is having the middlebox be a proxy, acting as server to the client, and as a client to the server. This option is implemented in several commercial products. <a href="#proxy_server_ext">[proxy_server_ext]</a> describes an extension to TLS for improving that mechanism, and also contains a good description in the introduction.</p>
<p id="rfc.section.1.p.5">This document describes an alternative mechanism, where the client sends the keys to the middlebox in the TLS record stream. This requires more changes to clients and servers, but has the advantage that it does not break many of TLS guarantees.</p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#mustshouldmay" id="mustshouldmay">Conventions Used in This Document</a>
</h1>
<p id="rfc.section.1.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#protocol" id="protocol">Protocol Overview</a>
</h1>
<p id="rfc.section.2.p.1">A supporting client will send a new extension in the ClientHello message. This new extension is called tls_keyshare. A server that supports this extension will send the extension in the ServerHello if it has received that extension in the ClientHello. Note that sending this extension only acknowledges understanding the protocol, not agreement to decryption. The extension contains a sequence of SHA-256 hashes of middlebox certificates.  The client sends the hashes of the certificates of middleboxes that it knows are on-path to the server. See <a href="#discovery">Section 4</a> for a discussion of middlebox discovery. The server sends a subset of the same hashes, only those for which it agrees to decryption.</p>
<p id="rfc.section.2.p.2">This document defines a new record type called KeyshareInfo. This is a new content type rather than a new handshake message so that it doesn't figure in hash calculation of the hash message. A middlebox inserts a KeyShareInfo record into the server-to-client stream immediately after receiving the ClientHello message, if its hash was not present in the client's tls_keyshare extension. It contains two pieces of information: </p>

<ul>
<li>A certificate of the middlebox. The public key in the certificate MUST be of the RSA type. The certificate should contain enough information for the client to recognize the middlebox.</li>
<li>A signature using the private key associated with the certificate over the concatenation of the ClientHello and ServerHello messages.</li>
</ul>
<p id="rfc.section.2.p.3">The middlebox inserts a KeyShareInfo record with a certificate into the client-to-server stream without an alert, immediately following a ServerHello message that does not contain the middlebox hash. The server will reply with either a fatal UNAUTHORIZED_MIDDLEBOX alert, or a fatal RETRY_MIDDLEBOX alert, depending on policy.</p>
<p id="rfc.section.2.p.4">In cases where the client and server negotiate either a ciphersuite that the middlebox does not support, or an extension that it doesn't support, the middlebox inserts a different kind of KeyShareInfo record into the stream, that identifies the unsupported ciphersuite or extension. Both kinds of KeyShareInfo records are followed by a fatal alert.  The client is expected to add the hashes and remove the unsupported ciphersuites and extensions, before attempting a new TLS connection.</p>
<p id="rfc.section.2.p.5">The client inserts a third type of KeyShareInfo record into the client-to-server stream immediately following the ChangeCipherSpec record (before the Finished handshake record).  This KeyShareInfo record is constructed differently, and contains an RSA encrypted record of the write keys for both client and server. The client may send several records if there is more than one middlebox.</p>
<div id="#rfc.figure.1"></div>
<pre>
  Client                     Middlebox                         Server
  ------                     ---------                         ------
  ClientHello(tls_keyshare=0)
                                 --------&gt;
                            KeyShareInfo(cert,sig)
                            KeyShareInfo(reject cipher:0x0044)
                            alert(MIDDLEBOX_PRESENT)
                                  &lt;-------- 
  ClientHello(tls_keyshare=cert_hash)
                                 --------&gt;
                                               ServerHello(cert_hash)
                                                        (Certificate)
                                                  (ServerKeyExchange)
                                                      ServerHelloDone
                                 &lt;--------    
  (Certificate)
  ClientKeyExchange
  (CertificateVerify)
  ChangeCipherSpec
  KeyShareInfo(keys)
  Finished                       --------&gt;
                                                     ChangeCipherSpec
                                                             Finished
                                 &lt;--------    
         
</pre>
<p id="rfc.section.2.p.6">The diagram below outlines discovery.</p>
<div id="#rfc.figure.2"></div>
<pre>
  Client                     Middlebox                         Server
  ------                     ---------                         ------

  ClientHello(tls_keyshare=cert_hash)
                                 --------&gt;
                                              ServerHello(keyshare=0)
                                                        (Certificate)
                                                  (ServerKeyExchange)
                                                      ServerHelloDone
                                 &lt;--------    
                            KeyShareInfo(cert,sig)
                                 --------&gt;                                 
                                        alert(UNAUTHORIZED_MIDDLEBOX)
                                 &lt;--------    
</pre>
<p id="rfc.section.2.p.7">The diagram below outlines the protocol in a case where the server refuses decryption.</p>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> <a href="#keyshare_ind" id="keyshare_ind">The tls_keyshare Extension</a>
</h1>
<p id="rfc.section.2.1.p.1">The tls_keyshare extension is a ClientHello and ServerHello extension as defined in section 2.3 of <a href="#TLS-EXT">[TLS-EXT]</a>.  The extension_type field is TBA by IANA. The format is to be added.</p>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> <a href="#keyshareinfo" id="keyshareinfo">The KeyShareInfo Record</a>
</h1>
<p id="rfc.section.2.2.p.1">The format of the KeyShareInfo record is to be added. The content type is TBA by IANA.</p>
<h1 id="rfc.section.2.2.1">
<a href="#rfc.section.2.2.1">2.2.1.</a> <a href="#keyshareinfo_discovery" id="keyshareinfo_discovery">The KeyShareInfo Discovery Subtype</a>
</h1>
<p id="rfc.section.2.2.1.p.1">The KeyShareInfo Discovery record gives client or server information about the middlebox. Format is TBA.</p>
<h1 id="rfc.section.2.2.2">
<a href="#rfc.section.2.2.2">2.2.2.</a> <a href="#keyshareinfo_rejection" id="keyshareinfo_rejection">The KeyShareInfo Rejection Subtype</a>
</h1>
<p id="rfc.section.2.2.2.p.1">The KeyShareInfo Rejection record gives client a list of unsupported ciphersuites and extensions. Format is TBA.</p>
<h1 id="rfc.section.2.2.3">
<a href="#rfc.section.2.2.3">2.2.3.</a> <a href="#keyshareinfo_keys" id="keyshareinfo_keys">The KeyShareInfo Keys Subtype</a>
</h1>
<p id="rfc.section.2.2.3.p.1">The KeyShareInfo Keys record is send by the client to the middlebox and includes the session keys. Format is TBA.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#processing" id="processing">Processing</a>
</h1>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#proc_client" id="proc_client">Client Processing</a>
</h1>
<p id="rfc.section.3.1.p.1">If the client policy prohibits decryption, the client SHOULD send the tls_keyshare extension without hashes. Note that the middlebox might still try to proxy the connection, but that is in conflict with this specification, and is outside the scope of this document.</p>
<p id="rfc.section.3.1.p.2">If there are some middleboxes that are by policy acceptable to the client, their certificates are known in advance, and the client believes that they are on-path to the server, then the client MUST send the SHA-256 hashes of their certificates in the tls_keyshare extension.</p>
<p id="rfc.section.3.1.p.3">If a KeyShareInfo Discovery record is received with an unknown certificate, it MAY be ignored, or the user MAY be prompted to authorize the decryption, and optionally change the configuration to allow future decryption by this certificate. There will certainly be controversy about this, but the configuration must happen an some point.</p>
<p id="rfc.section.3.1.p.4">If policy dictates that the particular middlebox referenced in the KeyShareInfo record is not allowed to decrypt, then such a record MUST be ignored. In that case the connection fails. If the middlebox is acceptable, then the client retries the connection, this time adding the SHA-256 hash of the certificate to the tls_keyshare extension. This is the discovery mechanism.</p>
<p id="rfc.section.3.1.p.5">For all the middleboxes that are not ignored, the client MUST send a KeyShareInfo record with the symmetric keys immediately following the ChangeCipherSpec record before any protected record is sent. </p>
<p id="rfc.section.3.1.p.6">If a KeyShareInfo Rejection record is received, the client SHOULD retry the handshake, this time without the flagged ciphersuites and extensions. If it is not acceptable to run the connection without these ciphersuites or extensions, the client should log the event or inform the user.</p>
<p id="rfc.section.3.1.p.7">If the server sends a RETRY_MIDDLEBOX alert, the client should retry the handshake. If it sends an UNAUTHORIZED_MIDDLEBOX alert, then the client should log the event or alert the user.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#proc_server" id="proc_server">Server Processing</a>
</h1>
<p id="rfc.section.3.2.p.1">The server SHOULD send the tls_keyshare extension even if policy dictates that the decryption is prohibited. If policy allows all middleboxex to decrypt, it makes sense to simply copy the client's tls_keyshare extension.</p>
<p id="rfc.section.3.2.p.2">If some of the middlebox hashes included in the client's tls_keyshare extension are recognized as those of acceptable middleboxes, then only those are copied to the server's tls_keyshare extension. When the middlebox sends a KeyShareInfo Discovery record, the server may decide whether that is acceptable or not, and accordingly send the RETRY_MIDDLEBOX or UNAUTHORIZED_MIDDLEBOX alerts. In any case, every time the server does not copy all hashes from the client's tls_keyshare, the connection is probably going to end in an alert.</p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#proc_mb" id="proc_mb">Middlebox Processing</a>
</h1>
<p id="rfc.section.3.3.p.1">The middlebox MUST send a KeyShareInfo Discovery record to the client if the client has indicated support for this extension, and has not included the middlebox hash in the extension. The discovery record is followed by a MIDDLEBOX_PRESENT alert, breaking the connection. Similarly, if the hash is missing from the server's tls_keyshare extension, then the middlebox injects a KeyShareInfo Discovery record into the client-to-server stream. The server will usually then send an Alert record.</p>
<p id="rfc.section.3.3.p.2">If the ServerHello specifies a ciphersuite that the middlebox does not support, or if it includes a TLS extension that might prevent the middlebox from processing, then the middlebox MAY send a KeyShareInfo Reject record with all unacceptable ciphersuites and extension numbers, followed by a MIDDLEBOX_PRESENT alert.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#discovery" id="discovery">Middlebox Discovery</a>
</h1>
<p id="rfc.section.4.p.1">Discovering that the middlebox is present has already been described in <a href="#proc_client">Section 3.1</a>. The client that is not aware of the presence of the middlebox receives a KeyShareInfo Discovery record followed by a MIDDLEBOX_PRESENT alert message.</p>
<p id="rfc.section.4.p.2">Discovering that a middlebox in no longer on the path is trickier, because the superfluous KeyShareInfo Keys records do not lead to any observable effects for the client.  We suggest that the client keep a list of discovered middleboxes, and periodically clear entries from the list, requiring a repeated discovery. System events such as a change to host IP address, a reboot or the computer entering sleep mode MAY be used as triggers for clearing the list.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#security" id="security">Security Considerations</a>
</h1>
<p id="rfc.section.5.p.1">To be added</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#iana" id="iana">IANA Considerations</a>
</h1>
<p id="rfc.section.6.p.1">To be added.</p>
<h1 id="rfc.references">
<a href="#rfc.references">7.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">7.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="1">[1]</b></td>
<td class="top">
<a>Dierks, T.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5246">The Transport Layer Security (TLS) Protocol Version 1.2</a>", RFC 5246, August 2008.</td>
</tr>
<tr>
<td class="reference"><b id="2">[2]</b></td>
<td class="top">
<a>Blake-Wilson, S.</a>, <a>Nystrom, M.</a>, <a>Hopwood, D.</a>, <a>Mikkelsen, J.</a> and <a>T. Wright</a>, "<a href="http://tools.ietf.org/html/rfc4366">Transport Layer Security (TLS) Extensions</a>", RFC 4366, April 2006.</td>
</tr>
<tr>
<td class="reference"><b id="3">[3]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">7.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="1">[1]</b></td>
<td class="top">
<a title="RTFM, Inc.">Rescorla, E</a>, "<a href="http://tools.ietf.org/html/rfc2818">HTTP Over TLS</a>", RFC 2818, May 2000.</td>
</tr>
<tr>
<td class="reference"><b id="2">[2]</b></td>
<td class="top">
<a title="Cisco Systems">McGrew, D</a> and <a title="Cisco Systems">P Gladstone</a>, "<a href="http://tools.ietf.org/html/draft-mcgrew-tls-proxy-server-00">TLS Proxy Server Extension</a>", Internet-Draft draft-mcgrew-tls-proxy-server-00, July 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Yoav Nir</span> 
	  <span class="n hidden">
		<span class="family-name">Nir</span>
	  </span>
	</span>
	<span class="org vcardline">Check Point Software Technologies Ltd.</span>
	<span class="adr">
	  <span>5 Hasolelim st.</span>

	  <span class="vcardline">
		<span class="locality">Tel Aviv</span>,  
		<span class="region"></span>
		<span class="code">67897</span>
	  </span>
	  <span class="country-name vcardline">Israel</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ynir@checkpoint.com">ynir@checkpoint.com</a></span>

  </address>
</div>

</body>
</html>