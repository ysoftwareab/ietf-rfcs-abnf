<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>An ID/Locator Architecture for P2PSIP</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="An ID/Locator Architecture for P2PSIP">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">P2PSIP Working Group</td><td class="header">E. Cooper</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">A. Johnston</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">P. Matthews</td></tr>
<tr><td class="header">Expires: May 15, 2008</td><td class="header">Avaya</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">November 12, 2007</td></tr>
</table></td></tr></table>
<h1><br />An ID/Locator Architecture for P2PSIP<br />draft-matthews-p2psip-id-loc-00</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on May 15, 2008.</p>

<h3>Abstract</h3>

<p>This document describes an architecture where peers in an overlay use
      special IP addresses to identify other peers. Two of the advantages of
      this approach are that (a) most existing applications can run in an
      overlay without needing any changes and (b) peer mobility and NAT
      traversal are handled in a way that is transparent to most
      applications.
</p>
<h3>Terminology</h3>

<p>Descriptions of the basic concepts and terminology used in this
      document can be found in the P2PSIP Concepts and Terminology document
      <a class='info' href='#Concepts'>[Concepts]<span> (</span><span class='info'>Bryan, D., Matthews, P., Shim, E., and D. Willis, &ldquo;Concepts and Terminology for Peer to Peer SIP,&rdquo; March&nbsp;2007.</span><span>)</span></a>.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<br />
<a href="#anchor2">2.</a>&nbsp;
Details<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">2.1.</a>&nbsp;
Identifiers<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">2.2.</a>&nbsp;
Peer Protocol<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">2.3.</a>&nbsp;
Shim Layer<br />
<br />
<a href="#anchor6">3.</a>&nbsp;
Domain Names<br />
<br />
<a href="#anchor7">4.</a>&nbsp;
Example<br />
<br />
<a href="#Relationship-to-HIP">5.</a>&nbsp;
Relationship to HIP<br />
<br />
<a href="#Implementing">6.</a>&nbsp;
Implementing the Shim Layer<br />
<br />
<a href="#anchor8">7.</a>&nbsp;
IANA Considerations<br />
<br />
<a href="#anchor9">8.</a>&nbsp;
Security Considerations<br />
<br />
<a href="#rfc.references1">9.</a>&nbsp;
Informative References<br />
<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>This document describes an architecture where nodes use IP addresses
      drawn from a special range to uniquely identify other peers and clients
      in the overlay. These IP addresses, called "identifiers" in the rest of
      this document, are drawn from a special address range and are thus
      distinct from the actual IP addresses assigned to peers and clients.
      These identifiers are used by the application and the
      application&rsquo;s transport protocol (e.g., TCP or UDP) in place of a
      peer&rsquo;s real address. These identifiers are distinguishable from
      real addresses (because they are drawn from a special range), but most
      applications do not know or care about the difference.
</p>
<p>Using IP addresses as identifiers in this manner brings the following
      advantages:</p>
<ul class="text">
<li>The identifiers are stable and unique.
</li>
<li>The identifiers can be used in the Socket API without
          changes.
</li>
<li>Applications do not need to worry about NAT traversal, mobility,
          or multi-homing.
</li>
<li>Most applications do not need to be aware that they are running
          in an overlay. Only applications that want to take advantage of the
          special properties that the overlay provides need to be aware.
</li>
</ul>

<p>To implement this architecture, the identifiers are intercepted
      (using one of a variety of implementation techniques) just below the
      transport layer and replaced with a real address before the packet is
      sent. The mapping of an identifier to the associated real address is
      handled the Peer Protocol <a class='info' href='#Concepts'>[Concepts]<span> (</span><span class='info'>Bryan, D., Matthews, P., Shim, E., and D. Willis, &ldquo;Concepts and Terminology for Peer to Peer SIP,&rdquo; March&nbsp;2007.</span><span>)</span></a>. For peers and
      clients behind NATs, this application uses the ICE protocol <a class='info' href='#ICE'>[ICE]<span> (</span><span class='info'>Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Methodology           for Network Address Translator (NAT) Traversal for Offer/Answer           Protocols,&rdquo; .</span><span>)</span></a> to establish connections through the NATs. This
      application also handles case where a peer changes its real address for
      mobility or multi-homing reasons.
</p>
<p>Applications learn these identifiers in various ways. Applications
      that use the distributed database function in the overlay receive
      identifiers rather than real addresses as responses to queries.
      Applications that use the gethostbyname() function are returned
      identifiers rather than real addresses when the destination is known to
      be in the overlay. And applications may learn identifiers from other
      applications.
</p>
<p>This approach can be compared with the approach taken by most of the
      other proposals in P2PSIP (e.g., RELOAD, ASP, P2PP, and XPP/PCAN). In
      these proposals, peers are identified with bitstrings that do not look
      like addresses, forcing applications that want to run in an overlay to
      use a new (as yet unspecified) API, rather than the existing Socket API.
      Furthermore, though these proposals handle NAT traversal for the Peer
      protocol, they do not handle NAT traversal for applications, forcing
      each application to invent its own ICE variation. None of these
      proposals currently consider mobility at all. All of this means that any
      application that wants to run in an overlay requires significant
      modification.
</p>
<p>The exceptions to the problems described in the previous paragraph
      are the two P2PSIP proposals based on HIP: HIP-HOP <a class='info' href='#HIP-HOP'>[HIP&#8209;HOP]<span> (</span><span class='info'>Cooper, E., Johnston, A., and P. Matthews, &ldquo;A Distributed Transport Function in P2PSIP using HIP for           Multi-Hop Overlay Routing,&rdquo; June&nbsp;2007.</span><span>)</span></a> and WITH-HIP <a class='info' href='#WITH-HIP'>[WITH&#8209;HIP]<span> (</span><span class='info'>Hautakorpi, J., Camarillo, G., and J. Koskella, &ldquo;Utilizing HIP (Host Identity Protocol) for P2PSIP           (Peer-to-peer Session Initiation Protocol),&rdquo; November&nbsp;2007.</span><span>)</span></a>.
      Both of these proposals include the id/location split concept, and thus
      share the advantages of this concept.
</p>
<p>This proposal takes the features of HIP that the authors feel are
      most beneficial to P2PSIP, while leaving for further investigation the
      possible adoption of other HIP features (as proposed in HIP-HOP and
      WITH-HIP). More details on the relationship of this work to HIP is given
      in <a class='info' href='#Relationship-to-HIP'>Section&nbsp;5<span> (</span><span class='info'>Relationship to HIP</span><span>)</span></a>.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Details</h3>

<p>Figure X shows the conceptual relationship between the parts
      discussed in this section.
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre> _______________ _______________
|               |               |
| Peer Protocol |      SIP      |  Other Apps ...
|_______________|_______________|_________________
|                                                 |
|                 TCP, UDP, etc                   |
|_________________________________________________|
|                                                 |
|                   Shim layer                    |
|_________________________________________________|
|                                                 |
|                  IP (v4 or v6)                  |
|_________________________________________________|
</pre></div>
<p>In this architecture, the Peer Protocol is responsible for creating
      the mapping between identifiers and real addresses, while the Shim layer
      is responsible for doing the translation on a packet-by-packet basis as
      well as adding any necessary encapsulation. More details on these roles
      can be found below.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
Identifiers</h3>

<p>Identifiers are IPv4 or IPv6 addresses selected from a special
        range in the IPv4 or IPv6 space respectively. For IPv4, this is the
        TBD range; for IPv6, this is the TBD range.
</p>
<p>These identifiers can be freely intermixed with ordinary
        (&ldquo;real&rdquo;) addresses. Applications are free to use
        identifiers to talk with application on other nodes in the overlay,
        and real addresses to talk with applications off the overlay.
</p>
<p></p>
<blockquote class="text">
<p>OPEN ISSUE: For IPv6, getting a range of addresses should be
            quite do-able. HIP is currently using the ORCHID space, and this
            may well be a reasonable choice for this architecture.
</p>
<p>But is it realistic to assume that we will be able to get a
            range of IPv4 addresses to use for this purpose? HIP
            implementations currently use the 1/8 range (which is marked as
            "reserved" by IANA) which has 2^24 addresses available in it. If
            IPv4 identifiers just have local scope, then 2^24 is probably more
            than required, and a /14 or /16 is probably quite sufficient.
</p>
</blockquote>

<p></p>
<blockquote class="text">
<p>OPEN ISSUE: What is the scope of this identifier (e.g., local
            node only, overlay-wide, or global)? The IPv4 identifiers probably
            have to be local, since are not enough to be global and maybe not
            enough to be overlay-wide. The IPv6 identifiers could be global
            (and be either identical to, or similar to, HIP&rsquo;s Host
            Identity Tags (HITs)) or they could be just overlay-wide, however,
            either would introduce a difference between the IPv4 and IPv6
            identifiers which might be undesirable.
</p>
</blockquote>
<blockquote class="text">
<p><p>OPEN ISSUE: Is this identifier the same as a peer id <a class='info' href='#Concepts'>[Concepts]<span> (</span><span class='info'>Bryan, D., Matthews, P., Shim, E., and D. Willis, &ldquo;Concepts and Terminology for Peer to Peer SIP,&rdquo; March&nbsp;2007.</span><span>)</span></a>? In the case of IPv4 identifiers, it
            seems pretty clear that the answer is &ldquo;no&rdquo;, because
            the space of IPv4 identifiers simply isn&rsquo;t large enough. For
            IPv6, the space is likely large enough, but there are difficulties
            if the identifier is both globally scoped and is a peer id.
</p>
</blockquote>

<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Peer Protocol</h3>

<p>The job of the Peer Protocol in this architecture is (in addition
        to its other duties of managing the overlay and implementing the
        Distributed Database <a class='info' href='#Concepts'>[Concepts]<span> (</span><span class='info'>Bryan, D., Matthews, P., Shim, E., and D. Willis, &ldquo;Concepts and Terminology for Peer to Peer SIP,&rdquo; March&nbsp;2007.</span><span>)</span></a>) to establish
        connections between peers and to manage the mappings between
        identifiers and real addresses. To do this, the Peer Protocol does an
        ICE exchange with the destination peer to negotiate a set of addresses
        and ports to use for the data traffic.
</p>
<p>The stimulus for doing this ICE exchange is an indication from the
        Shim layer saying that is has no set of real addresses to use for a
        given destination identifier (cf. an ARP cache miss). The Peer
        Protocol then does an ICE exchange with the destination peer, routing
        the Offer/Answer though other peers in the overlay. Once the exchange
        has completed, the Peer Protocol installs the appropriate mapping
        entry into the Shim layer.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
Shim Layer</h3>

<p>The shim layer is a new layer introduced between the IP layer and
        the transport layer. It has two functions: translating identifiers
        to/from real addresses, and adding any necessary encapsulation.
</p>
<p>There are two forms of encapsulation: null encapsulation and
        outer-UDP encapsulation. 
</p><div style='display: table; width: 0; margin-left: auto; margin-right: auto'><pre> _____________________________         ___________________________
|                             |       |                           |
|      Application data       |       |     Application data      |
|_____________________________|       |___________________________|
|                             |       |                           |
| Transport (TCP or UDP only) |       |     Transport header      |
|_____________________________|       |___________________________|
|                             |       |                           |
|        Demux header         |       |    IP header (v4 or v6)   |
|_____________________________|       |___________________________|
|                             |
|         UDP header          |             Null Encapsulation
|_____________________________|
|                             |
|     IP header (v4 or v6)    |
|_____________________________|

    Outer-UDP Encapsulation
</pre></div>
<p>The Demux header looks like:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Protocol     |                Reserved                       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div>
<p>Here the protocol field indicates which transport (or other)
        protocol follows, and uses the same codepoints as used for the
        &lsquo;protocol&rsquo; field in the IPv4/IPv6 header.
</p>
<p>The null encapsulation adds no extra bytes but simply translates
        identifiers to real addresses and modifies port numbers as necessary
        to traverse NATs. The null encapsulation is very similar to existing
        protocol stacks, but requires more work to set up and maintain because
        each connection requires its own set of ICE connectivity checks.
</p>
<p>By contrast, the Outer-UDP encapsulation adds a UDP header plus a
        4-byte demux header between the IP header and the transport header.
        The Outer-UDP encapsulation multiplexes all connections between two
        given nodes inside a single UDP "pipe". Because intervening NATs see
        only the outer UDP header, this encapsulation requires only one ICE
        exchange (to set up the outer pipe), regardless of how many
        connections there are inside the pipe.
</p>
<p> The Outer-UDP encapsulation can be used with all transport
        protocols, while the null encapsulation can only be used with UDP and
        TCP.
</p>
<p>To explain the mapping and encapsulations in more detail, consider
        a transport layer PDU is sent from X:x to Y:y, where X is the
        identifier of the local host, Y is the identifier of the remote host,
        and x and y are the port numbers allocated off of these identifiers.
        For both encapsulations, the Peer Protocol will have used ICE to
        determine a corresponding set of real addresses and ports.
</p>
<p>For the null encapsulation, each transport layer 5-tuple (transport
        protocol,X,x,Y,y) will have a corresponding set of real addresses and
        ports (X&rsquo;,x&rsquo;,Y&rsquo;,y&rsquo;). When sending, the port
        numbers x and y in the transport header are replaced with x&rsquo; and
        y&rsquo;, and an IP header is added containing addresses X&rsquo; and
        Y&rsquo; is added. (TBD: Are the addresses in the transport layer
        pseudo-header also replaced?). The reverse replacement is done when
        receiving a PDU.
</p>
<p>If either X or Y change their real address, then an ICE exchange is
        required to determine a new 5-tuple for each connection. For UDP, this
        new 5-tuple is simply used in place of the old.
</p>
<p></p>
<blockquote class="text">
<p>OPEN ISSUE: For TCP, this doesn&rsquo;t work, since generating
            the new 5-tuple requires a new TCP handshake. This seems to imply
            that the TCP layer has to be aware of the change in address. So
            what do we do? Do we just say &ldquo;don&rsquo;t use null
            encapsulation for TCP if you want mobility to work&rdquo;? Or do
            we figure out how to make this work?
</p>
</blockquote>

<p>For the outer-UDP encapsulation, there is a single 5-tuple
        (UDP,X&rsquo;,x&rsquo;,Y&rsquo;,y&rsquo;) for each (X,Y) pair. When
        sending, the transport header is not modified, instead a demux header
        and a outer UDP header is added. Ports x&rsquo; and y&rsquo; are
        inserted in the outer UDP header, and an IP header containing
        addresses X&rsquo; and Y&rsquo; is added.
</p>
<p>Mobility is simpler with the Outer-UDP encapsulation. In this case,
        only a single ICE exchange is required, and the new 5-tuple is simply
        used in place of the old. There are no TCP concerns in this case,
        since the TCP header is never modified.
</p>
<p>See <a class='info' href='#Implementing'>Section&nbsp;6<span> (</span><span class='info'>Implementing the Shim Layer</span><span>)</span></a> for a discussion of how to
        implement the mapping layer.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Domain Names</h3>

<p>In this section, we briefly describe how the identifier concept might
      be extended to tie in with domain names in an attractive way. This idea
      is not core to this draft, but helps simplify the example that
      follows.
</p>
<p>Briefly, the idea is to define a new top-level domain, called
      &ldquo;.p2p&rdquo;. This domain is reserved for use in peer-to-peer
      overlays. An overlay is then given a name underneath this top-level
      domain:</p>
<blockquote class="text">
<p>&lt;overlay-name&gt;.p2p
</p>
</blockquote><p>and individual peers are allocated names underneath the overlay
      name:</p>
<blockquote class="text">
<p>&lt;peer-name&gt;.&lt;overlay-name&gt;.p2p
</p>
</blockquote><p>For example, a peer named &ldquo;mars&rdquo; in an overlay
      called &ldquo;solar-system&rdquo; would have the name:</p>
<blockquote class="text">
<p>mars.solar-system.p2p
</p>
</blockquote><p>By storing the mapping between peer names and peer ids in the
      Distributed Database, this scheme allows users to use human-friendly
      names for peers in place of peer ids or identifiers.
</p>
<p>To make this scheme even more powerful, gethostbyname() is modified
      to look for domain names ending in &ldquo;.p2p&rdquo; and look them up
      in the Distributed Database rather than in the DNS. When the resource
      record is returned, an identifier is allocated to the peer and that
      identifier is returned from gethostbyname(). In that way, the user can
      type, for example, &ldquo;http://mars.solar-system.p2p&rdquo; into her
      web browser to contact a web server running on &ldquo;mars&rdquo;.
</p>
<p>More details on how this works can be found in the example of the
      next section.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Example</h3>

<p>In this section, we show a SIP call between two UAs in an
      overlay.
</p>
<p>This example illustrates how this architecture allows applications to
      work in an overlay without being aware of that fact. The two SIP UAs in
      this example use standard client-server SIP to communicate, without
      needing any SIP extensions.
</p>
<p>IMPORTANT NOTE: Without extensions to SIP, there is no way to do an
      AOR to contact URI lookup using the Distributed Database. So in this
      example, Wilma calls Fred by specifying Fred&rsquo;s machine name, using
      the domain name scheme described in the previous section. With this
      caveat, everything works with SIP as it is today.
</p>
<p>Figure X shows the call flow for this example.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>Wilma                                                              Fred
Venus                                  Earth                       Mars
 |                                       |                           |
 |- DD query for mars.solar-system.p2p -&gt;|                           |
 |&lt;--------------- DD response ----------|                           |
 |                                       |                           |
 |----------- Msg w/ICE Offer ----------&gt;|                           |
 |                                       |----- Msg w/ICE Offer ----&gt;|
 |                                       |&lt;---- Msg w/ICE Ans -------|
 |&lt;---------- Msg w/ ICE Ans ------------|                           |
 |                                                                   |
 |&lt;=================== ICE Connectivity Checks =====================&gt;|
 |                                                                   |
 |&lt;-------------------- TCP and TLS handshake ----------------------&gt;|
 |                                                                   |
 |&lt;------------- SIP transaction over TLS connection ---------------&gt;|
 |                                                                   |

</pre></div>
<p>This example shows three machines, named &ldquo;Venus&rdquo;,
      &ldquo;Earth&rdquo;, and &ldquo;Mars&rdquo; which are part of a larger
      overlay named &ldquo;solar-system.p2p&rdquo;. Wilma is on Venus, and
      Fred is on Mars.
</p>
<p>Wilma initiates the call by typing in sips:fred@mars.solar-system.p2p
      into her UA. Wilma&rsquo;s UA does a gethostbyname() call to resolve
      &ldquo;mars.solar-system.p2p&rdquo; and this is resolved by doing a
      Distributed Database lookup. In this example, it turns out that the
      corresponding resource record is stored on the machine "Earth". As a
      result, an identifier for the peer Mars is returned from the
      gethostbyname() call to Wilma&rsquo;s UA.
</p>
<p></p>
<blockquote class="text">
<p>NOTE: If identifiers are the same as peer ids, then the peer id
          from the resource record is just returned as the identifier.
          Otherwise, (which is more likely if Wilma's UA is using IPv4
          identifiers) the Peer Protocol allocates an identifier and remembers
          that it maps to the machine named "mars.solar-system.p2p" which has
          the peer id learned from the response.
</p>
</blockquote>

<p>Wilma&rsquo;s UA then issues a connect() to this identifier. This
      causes TCP to send a SYN to this identifier. Since there is currently no
      direct connection between Venus and Mars, the Shim layer finds no
      mapping for this identifier and thus generates an indication to the Peer
      Protocol.
</p>
<p>The Peer Protocol layer on Venus now does an ICE offer/answer
      exchange with the Peer Protocol layer on Mars. The Offer is sent on the
      existing connection to Earth, which forwards it to Mars, and the Answer
      is returned in the same way. ICE connectivity checks are then done, and
      the result is a tuple of real addresses and ports for the
      connection.
</p>
<p>If null encapsulation is used, then the TCP connection was
      established as part of the ICE connectivity checks. This new connection
      is used only for SIP signaling, and subsequent connections require a new
      offer/answer exchange.
</p>
<p>But if Outer-UDP encapsulation is used, then all the ICE connectivity
      checks do is establish a UDP "pipe" between the two peers, and the TCP
      and TLS handshakes must still be done inside that pipe (as shown above).
      However, this UDP pipe can be used for all traffic between Venus and
      Mars, including subsequent RTP packets) without the need of subsequent
      offer/answer exchanges.
</p>
<a name="Relationship-to-HIP"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Relationship to HIP</h3>

<p>The fundamental concept in this document, that of an identifier for a
      node which is distinct from the node&rsquo;s real addresses, has been
      adopted from HIP. In HIP, this identifier (known as a HIT <a class='info' href='#HIP-Base'>[HIP&#8209;Base]<span> (</span><span class='info'>Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; June&nbsp;2007.</span><span>)</span></a>)is always an IPv6 identifier, and has global
      scope and cryptographic properties, making it computationally hard for
      an second node to steal a node&rsquo;s identity. (Current HIP
      implementations also implement an IPv4 identifier as a local identifier,
      but the properties of this IPv4 identifier are not currently specified
      anywhere).
</p>
<p>HIP also introduces a number of other concepts, whose applicability
      to p2p overlays is less obvious.
</p>
<p>The first is the use of ESP. In HIP, all data packets flowing between
      two nodes use ESP to encrypt and integrity protect the traffic <a class='info' href='#HIP-ESP'>[HIP&#8209;ESP]<span> (</span><span class='info'>Jokela, P., Moskowitz, R., and P. Nikander, &ldquo;Using ESP transport format with HIP,&rdquo; June&nbsp;2007.</span><span>)</span></a>. At present, this is done for all traffic, even
      if the traffic is already protected at a higher layer (e.g., using TLS
      or application-level encryption). Does we want to encrypt and
      integrity-protect *all* traffic, or should this decision be made on a
      per-application basis? Do we want some way to avoid double encryption:
      if so, how is this done?
</p>
<p>The second is the use of computational puzzles to prevent denial of
      service attacks. Since all traffic is encrypted, when setting up a HIP
      connection the two endpoints do a Diffie-Hellman exchange to agree on a
      shared encryption key. Since this is computationally expensive, the node
      initiating the connection must first solve a computational puzzle
      generated by the destination, in order to make it more difficult for a
      hostile initiator to cause the destination to do a lot of work. However,
      it is not immediately clear how to extend this concept to a peer-to-peer
      overlay where there are many more connections involved and the different
      ways of launching denial-of-service attacks seem larger.
</p>
<p>Finally, HIP has its own signaling protocol (also called HIP), and
      the proper relationship of that protocol to the Peer Protocol is not
      immediately clear. Should the functionality of HIP simply be added to
      the Peer Protocol? Should HIP signaling be kept as a distinct protocol
      and carried inside Peer Protocol messages (as proposed in <a class='info' href='#WITH-HIP'>[WITH&#8209;HIP]<span> (</span><span class='info'>Hautakorpi, J., Camarillo, G., and J. Koskella, &ldquo;Utilizing HIP (Host Identity Protocol) for P2PSIP           (Peer-to-peer Session Initiation Protocol),&rdquo; November&nbsp;2007.</span><span>)</span></a>)? Or should HIP signaling be used to create
      connections in the overlay instead of the Peer Protocol (as proposed in
      <a class='info' href='#HIP-HOP'>[HIP&#8209;HOP]<span> (</span><span class='info'>Cooper, E., Johnston, A., and P. Matthews, &ldquo;A Distributed Transport Function in P2PSIP using HIP for           Multi-Hop Overlay Routing,&rdquo; June&nbsp;2007.</span><span>)</span></a>)? 
</p>
<a name="Implementing"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Implementing the Shim Layer</h3>

<p>A frequent reaction to people hearing about this architecture for the
      first time is: But how do I implement it? This section provides some
      guidance, drawing on the experience of the HIP community in implementing
      HIP.
</p>
<p>There are three kinds of implementations: kernel, user-space, and
      library.
</p>
<p>In a kernel implementation, the shim layer is implemented in the
      kernel.
</p>
<p>In a user-space implementation, the packet is intercepted at the link
      layer and sent up to a user-space process which modifies the packet as
      required and then the packet is returned to the kernel for further
      processing.
</p>
<p>In a library implementation, the transport and shim layers are
      implemented in a library (e.g., libc) which is either statically or
      dynamically linked with the application.
</p>
<p>Currently, HIP implementations of the kernel kind exist for Linux and
      FreeBSD, and of the user-space kind for Linux, OS X, and Windows. Note
      that the user-space implementations run on operating systems where
      kernel modifications are not possible. The authors are not currently
      aware of any libary implementations, but these would be easy to produce.
      
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA Considerations</h3>

<p>TBD.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Security Considerations</h3>

<p>TBD.
</p>
<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="Concepts">[Concepts]</a></td>
<td class="author-text">Bryan, D., Matthews, P., Shim, E., and D. Willis, &ldquo;Concepts and Terminology for Peer to Peer SIP,&rdquo; Internet Draft&nbsp;draft-willis-p2psip-concepts-04, March&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="HIP-Base">[HIP-Base]</a></td>
<td class="author-text">Moskowitz, R., Nikander, P., Jokela, P., and T. Henderson, &ldquo;Host Identity Protocol,&rdquo; Internet Draft&nbsp;draft-ietf-hip-base-08, June&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="HIP-ESP">[HIP-ESP]</a></td>
<td class="author-text">Jokela, P., Moskowitz, R., and P. Nikander, &ldquo;Using ESP transport format with HIP,&rdquo; Internet Draft&nbsp;draft-ietf-hip-esp-06, June&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="HIP-HOP">[HIP-HOP]</a></td>
<td class="author-text">Cooper, E., <a href="mailto:">Johnston, A.</a>, and <a href="mailto:">P. Matthews</a>, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-matthews-p2psip-hip-hop-00.txt">A Distributed Transport Function in P2PSIP using HIP for
          Multi-Hop Overlay Routing</a>,&rdquo; draft-matthews-p2psip-hip-hop-00 (work in progress), June&nbsp;2007.</td></tr>
<tr><td class="author-text" valign="top"><a name="ICE">[ICE]</a></td>
<td class="author-text">Rosenberg, J., &ldquo;Interactive Connectivity Establishment (ICE): A Methodology
          for Network Address Translator (NAT) Traversal for Offer/Answer
          Protocols,&rdquo; Internet Draft&nbsp;draft-ietf-mmusic-ice.</td></tr>
<tr><td class="author-text" valign="top"><a name="WITH-HIP">[WITH-HIP]</a></td>
<td class="author-text">Hautakorpi, J., <a href="mailto:">Camarillo, G.</a>, and <a href="mailto:">J. Koskella</a>, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-hautakorpi-p2psip-with-hip-01 (to appear).txt">Utilizing HIP (Host Identity Protocol) for P2PSIP
          (Peer-to-peer Session Initiation Protocol)</a>,&rdquo; draft-hautakorpi-p2psip-with-hip-01 (to appear) (work in progress), November&nbsp;2007.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Eric Cooper</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Avaya</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">1135 Innovation Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ottawa, Ontario  K2K 3G7</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 613 592 4343 x228</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:ecooper@avaya.com">ecooper@avaya.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Alan Johnston</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Avaya</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">St. Louis, MO  63124</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:alan@sipstation.com">alan@sipstation.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Philip Matthews</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Avaya</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">100 Innovation Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ottawa, Ontario  K2K 3G7</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 613 592 4343 x224</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:philip_matthews@magma.ca">philip_matthews@magma.ca</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2007).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
