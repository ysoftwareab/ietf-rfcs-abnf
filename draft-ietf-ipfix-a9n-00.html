<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Flow Aggregation for the IP Flow Information Export (IPFIX) Protocol </title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 IPFIX Protocol Overview">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 IPFIX Documents Overview">
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology">
<link href="#rfc.section.3" rel="Chapter" title="3 Use Cases for IPFIX Aggregation">
<link href="#rfc.section.4" rel="Chapter" title="4 Architecture for Flow Aggregation">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Aggregation within the IPFIX Architecture">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Intermediate Aggregation Process Architecture">
<link href="#rfc.section.5" rel="Chapter" title="5 IP Flow Aggregation Operations">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Temporal Aggregation through Interval Distribution">
<link href="#rfc.section.5.1.1" rel="Chapter" title="5.1.1 Distributing Values Across Intervals">
<link href="#rfc.section.5.1.2" rel="Chapter" title="5.1.2 Time Composition">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Spatial Aggregation of Flow Keys">
<link href="#rfc.section.5.2.1" rel="Chapter" title="5.2.1 Counting Original Flows">
<link href="#rfc.section.5.2.2" rel="Chapter" title="5.2.2 Counting Distinct Key Values">
<link href="#rfc.section.5.3" rel="Chapter" title="5.3 Spatial Aggregation of Non-Key Fields">
<link href="#rfc.section.5.3.1" rel="Chapter" title="5.3.1 Counter Statistics">
<link href="#rfc.section.5.3.2" rel="Chapter" title="5.3.2 Derivation of New Values from Flow Keys and non-Key fields">
<link href="#rfc.section.5.4" rel="Chapter" title="5.4 Aggregation Combination">
<link href="#rfc.section.6" rel="Chapter" title="6 Additional Considerations and Special Cases in Flow Aggregation">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Exact versus Approximate Counting during Aggregation">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Considerations for Aggregation of Sampled Flows">
<link href="#rfc.section.6.3" rel="Chapter" title="6.3 Considerations for Aggregation of Heterogeneous Flows">
<link href="#rfc.section.7" rel="Chapter" title="7 Export of Aggregated IP Flows using IPFIX">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Time Interval Export">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Flow Count Export">
<link href="#rfc.section.7.2.1" rel="Chapter" title="7.2.1 originalFlowsPresent">
<link href="#rfc.section.7.2.2" rel="Chapter" title="7.2.2 originalFlowsInitiated">
<link href="#rfc.section.7.2.3" rel="Chapter" title="7.2.3 originalFlowsCompleted">
<link href="#rfc.section.7.2.4" rel="Chapter" title="7.2.4 deltaFlowCount">
<link href="#rfc.section.7.3" rel="Chapter" title="7.3 Distinct Host Export">
<link href="#rfc.section.7.3.1" rel="Chapter" title="7.3.1 distinctCountOfSourceIPAddress">
<link href="#rfc.section.7.3.2" rel="Chapter" title="7.3.2 distinctCountOfDestinationIPAddress">
<link href="#rfc.section.7.3.3" rel="Chapter" title="7.3.3 distinctCountOfSourceIPv4Address">
<link href="#rfc.section.7.3.4" rel="Chapter" title="7.3.4 distinctCountOfDestinationIPv4Address">
<link href="#rfc.section.7.3.5" rel="Chapter" title="7.3.5 distinctCountOfSourceIPv6Address">
<link href="#rfc.section.7.3.6" rel="Chapter" title="7.3.6 distinctCountOfDestinationIPv6Address">
<link href="#rfc.section.7.4" rel="Chapter" title="7.4 Aggregate Counter Distribution Export">
<link href="#rfc.section.7.4.1" rel="Chapter" title="7.4.1 Aggregate Counter Distribution Options Template">
<link href="#rfc.section.7.4.2" rel="Chapter" title="7.4.2 valueDistributionMethod Information Element">
<link href="#rfc.section.8" rel="Chapter" title="8 Examples">
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 Traffic Time-Series per Source">
<link href="#rfc.section.8.2" rel="Chapter" title="8.2 Core Traffic Matrix">
<link href="#rfc.section.8.3" rel="Chapter" title="8.3 Distinct Source Count per Destination Endpoint">
<link href="#rfc.section.8.4" rel="Chapter" title="8.4 Traffic Time-Series per Source with Counter Distribution">
<link href="#rfc.section.9" rel="Chapter" title="9 Security Considerations">
<link href="#rfc.section.10" rel="Chapter" title="10 IANA Considerations">
<link href="#rfc.section.11" rel="Chapter" title="11 Acknowledgments">
<link href="#rfc.references" rel="Chapter" title="12 References">
<link href="#rfc.references.1" rel="Chapter" title="12.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="12.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document describes the export of aggregated Flow information using IPFIX. An Aggregated Flow is essentially an IPFIX Flow representing packets from multiple Original Flows sharing some set of common properties. The document describes Aggregated Flow export within the framework of IPFIX Mediators and defines an interoperable, implementation-independent method for Aggregated Flow export." />
  <meta name="description" content="This document describes the export of aggregated Flow information using IPFIX. An Aggregated Flow is essentially an IPFIX Flow representing packets from multiple Original Flows sharing some set of common properties. The document describes Aggregated Flow export within the framework of IPFIX Mediators and defines an interoperable, implementation-independent method for Aggregated Flow export." />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">IPFIX Working Group</td>
<td class="right">B. Trammell</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">ETH Zurich</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">A. Wagner</td>
</tr>
<tr>
<td class="left">Expires: May 24, 2012</td>
<td class="right">Consecom AG</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">B. Claise</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Cisco Systems, Inc.</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">November 21, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Flow Aggregation for the IP Flow Information Export (IPFIX) Protocol <br />
  <span class="filename">draft-ietf-ipfix-a9n-00.txt</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document describes the export of aggregated Flow information using IPFIX. An Aggregated Flow is essentially an IPFIX Flow representing packets from multiple Original Flows sharing some set of common properties. The document describes Aggregated Flow export within the framework of IPFIX Mediators and defines an interoperable, implementation-independent method for Aggregated Flow export.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on May 24, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">IPFIX Protocol Overview</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">IPFIX Documents Overview</a>
</li>
<li>2.   <a href="#rfc.section.2">Terminology</a>
</li>
<li>3.   <a href="#rfc.section.3">Use Cases for IPFIX Aggregation</a>
</li>
<li>4.   <a href="#rfc.section.4">Architecture for Flow Aggregation</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Aggregation within the IPFIX Architecture</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Intermediate Aggregation Process Architecture</a>
</li>
<li>5.   <a href="#rfc.section.5">IP Flow Aggregation Operations</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Temporal Aggregation through Interval Distribution</a>
</li>
<li>5.1.1.   <a href="#rfc.section.5.1.1">Distributing Values Across Intervals</a>
</li>
<li>5.1.2.   <a href="#rfc.section.5.1.2">Time Composition</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Spatial Aggregation of Flow Keys</a>
</li>
<li>5.2.1.   <a href="#rfc.section.5.2.1">Counting Original Flows</a>
</li>
<li>5.2.2.   <a href="#rfc.section.5.2.2">Counting Distinct Key Values</a>
</li>
<li>5.3.   <a href="#rfc.section.5.3">Spatial Aggregation of Non-Key Fields</a>
</li>
<li>5.3.1.   <a href="#rfc.section.5.3.1">Counter Statistics</a>
</li>
<li>5.3.2.   <a href="#rfc.section.5.3.2">Derivation of New Values from Flow Keys and non-Key fields</a>
</li>
<li>5.4.   <a href="#rfc.section.5.4">Aggregation Combination</a>
</li>
<li>6.   <a href="#rfc.section.6">Additional Considerations and Special Cases in Flow Aggregation</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">Exact versus Approximate Counting during Aggregation</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">Considerations for Aggregation of Sampled Flows</a>
</li>
<li>6.3.   <a href="#rfc.section.6.3">Considerations for Aggregation of Heterogeneous Flows</a>
</li>
<li>7.   <a href="#rfc.section.7">Export of Aggregated IP Flows using IPFIX</a>
</li>
<li>7.1.   <a href="#rfc.section.7.1">Time Interval Export</a>
</li>
<li>7.2.   <a href="#rfc.section.7.2">Flow Count Export</a>
</li>
<li>7.2.1.   <a href="#rfc.section.7.2.1">originalFlowsPresent</a>
</li>
<li>7.2.2.   <a href="#rfc.section.7.2.2">originalFlowsInitiated</a>
</li>
<li>7.2.3.   <a href="#rfc.section.7.2.3">originalFlowsCompleted</a>
</li>
<li>7.2.4.   <a href="#rfc.section.7.2.4">deltaFlowCount</a>
</li>
<li>7.3.   <a href="#rfc.section.7.3">Distinct Host Export</a>
</li>
<li>7.3.1.   <a href="#rfc.section.7.3.1">distinctCountOfSourceIPAddress</a>
</li>
<li>7.3.2.   <a href="#rfc.section.7.3.2">distinctCountOfDestinationIPAddress</a>
</li>
<li>7.3.3.   <a href="#rfc.section.7.3.3">distinctCountOfSourceIPv4Address</a>
</li>
<li>7.3.4.   <a href="#rfc.section.7.3.4">distinctCountOfDestinationIPv4Address</a>
</li>
<li>7.3.5.   <a href="#rfc.section.7.3.5">distinctCountOfSourceIPv6Address</a>
</li>
<li>7.3.6.   <a href="#rfc.section.7.3.6">distinctCountOfDestinationIPv6Address</a>
</li>
<li>7.4.   <a href="#rfc.section.7.4">Aggregate Counter Distribution Export</a>
</li>
<li>7.4.1.   <a href="#rfc.section.7.4.1">Aggregate Counter Distribution Options Template</a>
</li>
<li>7.4.2.   <a href="#rfc.section.7.4.2">valueDistributionMethod Information Element</a>
</li>
<li>8.   <a href="#rfc.section.8">Examples</a>
</li>
<li>8.1.   <a href="#rfc.section.8.1">Traffic Time-Series per Source</a>
</li>
<li>8.2.   <a href="#rfc.section.8.2">Core Traffic Matrix</a>
</li>
<li>8.3.   <a href="#rfc.section.8.3">Distinct Source Count per Destination Endpoint</a>
</li>
<li>8.4.   <a href="#rfc.section.8.4">Traffic Time-Series per Source with Counter Distribution</a>
</li>
<li>9.   <a href="#rfc.section.9">Security Considerations</a>
</li>
<li>10.   <a href="#rfc.section.10">IANA Considerations</a>
</li>
<li>11.   <a href="#rfc.section.11">Acknowledgments</a>
</li>
<li>12.   <a href="#rfc.references">References</a>
</li>
<li>12.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>12.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">The assembly of packet data into Flows serves a variety of different purposes, as noted in the <a href="#RFC3917">requirements</a> <cite title="NONE">[RFC3917]</cite> and <a href="#RFC5472">applicability statement</a> <cite title="NONE">[RFC5472]</cite> for the IP Flow Information Export (IPFIX) <a href="#RFC5101">protocol</a> <cite title="NONE">[RFC5101]</cite>.  Aggregation beyond the flow level, into records representing multiple Flows, is a common analysis and data reduction technique as well, with applicability to large-scale network data analysis, archiving, and inter-organization exchange. This applicability in large-scale situations, in particular, led to the inclusion of aggregation as part of the <a href="#RFC5982">IPFIX Mediators Problem Statement</a> <cite title="NONE">[RFC5982]</cite>, and the definition of an Intermediate Aggregation Process in the <a href="#RFC6183">Mediator framework</a> <cite title="NONE">[RFC6183]</cite>.</p>
<p id="rfc.section.1.p.2">Aggregation is part of a wide variety of applications, including traffic matrix calculation, generation of time series data for visualizations or anomaly detection, or measurement data reduction.  Depending on the keys used for aggregation, it may additionally have an anonymizing affect on the data: for example, aggregation operations which eliminate IP addresses make it impossible to later identify nodes using those addresses.</p>
<p id="rfc.section.1.p.3">Aggregation as defined and described in this document covers the applications defined in <a href="#RFC5982">[RFC5982]</a>, including 5.1 "Adjusting Flow Granularity", 5.4 "Time Composition", and 5.5 "Spatial Composition". However, this document specifies a more flexible architecture for an Intermediate Aggregation Process than that envisioned by the original Mediator work, in <a href="#sec-iap-arch">Section 4.2</a>. Instead of a focus on these specific limited use cases, the Intermediate Aggregation Process is specified to cover any activity commonly described as "flow aggregation".</p>
<p id="rfc.section.1.p.4">An Intermediate Aggregation Process may be applied to data collected from multiple Observation Points, as aggregation is natural to apply for data reduction when concentrating measurement data. This document specifically does not address the protocol issues that arise when combining IPFIX data from multiple Observation Points and exporting from a single Mediator, as these issues are general to IPFIX Mediation; they are therefore treated in detail in the <a href="#I-D.claise-ipfix-mediation-protocol">Mediator Protocol</a> <cite title="NONE">[I-D.claise-ipfix-mediation-protocol]</cite> document.</p>
<p id="rfc.section.1.p.5">Since Aggregated Flows as defined in the following section are essentially Flows, the IPFIX protocol <a href="#RFC5101">[RFC5101]</a> can be used to export, and the IPFIX File Format <a href="#RFC5655">[RFC5655]</a> can be used to store, aggregated data "as-is"; there are no changes necessary to the protocol. This document provides a common basis for the application of IPFIX to the handling of aggregated data, through a detailed terminology, Intermediate Aggregation Process architecture, and methods for Original Flow counting and counter distribution across intervals.</p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> IPFIX Protocol Overview</h1>
<p id="rfc.section.1.1.p.1">In the IPFIX protocol, { type, length, value } tuples are expressed in templates containing { type, length } pairs, specifying which { value } fields are present in data records conforming to the Template, giving great flexibility as to what data is transmitted. Since Templates are sent very infrequently compared with Data Records, this results in significant bandwidth savings. Various different data formats may be transmitted simply by sending new Templates specifying the { type, length } pairs for the new data format. See <a href="#RFC5101">[RFC5101]</a> for more information.</p>
<p id="rfc.section.1.1.p.2">The <a href="#RFC5102">IPFIX information model</a> <cite title="NONE">[RFC5102]</cite> defines a large number of standard Information Elements which provide the necessary { type } information for Templates. The use of standard elements enables interoperability among different vendors' implementations. Additionally, non-standard enterprise-specific elements may be defined for private use.</p>
<h1 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> <a href="#intro-docs" id="intro-docs">IPFIX Documents Overview</a>
</h1>
<p><a href="#RFC5101">"Specification of the IPFIX Protocol for the Exchange of IP Traffic Flow Information"</a> <cite title="NONE">[RFC5101]</cite> and its associated documents define the IPFIX Protocol, which provides network engineers and administrators with access to IP traffic flow information.</p>
<p><a href="#RFC5470">"Architecture for IP Flow Information Export"</a> <cite title="NONE">[RFC5470]</cite> defines the architecture for the export of measured IP flow information out of an IPFIX Exporting Process to an IPFIX Collecting Process, and the basic terminology used to describe the elements of this architecture, per the requirements defined in <a href="#RFC3917">"Requirements for IP Flow Information Export"</a> <cite title="NONE">[RFC3917]</cite>.  The IPFIX Protocol document <a href="#RFC5101">[RFC5101]</a> then covers the details of the method for transporting IPFIX Data Records and Templates via a congestion-aware transport protocol from an IPFIX Exporting Process to an IPFIX Collecting Process.</p>
<p id="rfc.section.1.2.p.3">This document specifies an Intermediate Process which may be applied at an IPFIX Mediator. <a href="#RFC5982">"IP Flow Information Export (IPFIX) Mediation: Problem Statement"</a> <cite title="NONE">[RFC5982]</cite> introduces the concept of IPFIX Mediators, and defines the use cases for which they were designed; <a href="#RFC6183">"IP Flow Information Export (IPFIX) Mediation: Framework"</a> <cite title="NONE">[RFC6183]</cite> then provides an architectural framework for Mediators. Protocol-level issues (e.g., template and observation domain handling across Mediators) are covered by <a href="#I-D.claise-ipfix-mediation-protocol">"Specification of the Protocol for IPFIX Mediation"</a> <cite title="NONE">[I-D.claise-ipfix-mediation-protocol]</cite>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#sec-terminology" id="sec-terminology">Terminology</a>
</h1>
<p id="rfc.section.2.p.1">Terms used in this document that are defined in the Terminology section of the <a href="#RFC5101">IPFIX Protocol</a> <cite title="NONE">[RFC5101]</cite> document are to be interpreted as defined there.</p>
<p id="rfc.section.2.p.2">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<p id="rfc.section.2.p.3">In addition, this document defines the following terms</p>
<p id="rfc.section.2.p.4">The terminology presented herein improves the precision of, but does not supersede or contradict the terms related to mediation and aggregation defined in the <a href="#RFC5982">problem statement</a> <cite title="NONE">[RFC5982]</cite> and the <a href="#RFC6183">framework</a> <cite title="NONE">[RFC6183]</cite> documents. Within this document, the terminology defined in this section is to be considered normative.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#sec-usecase" id="sec-usecase">Use Cases for IPFIX Aggregation</a>
</h1>
<p id="rfc.section.3.p.1">Aggregation, as a common data reduction method used in traffic data analysis, has many applications. When used with a regular Aggregation Interval, it generates time series data from a collection of Flows with discrete intervals. This time series data is itself useful for a wide variety of analysis tasks, such as generating input for network anomaly detection systems, or driving visualizations of volume per time for traffic with specific characteristics. As a second example, traffic matrix calculation from flow data is inherently an aggregation action, by aggregating the Flow Key down to input or output interface, address prefix, or autonomous system.</p>
<p id="rfc.section.3.p.2">Irregular or data-dependent Aggregation Intervals and key aggregation operations can also be used to provide adaptive aggregation of network flow data. Here, full Flow Records can be kept for Flows of interest, while Flows deemed "less interesting" to a given application can be aggregated. For example, in an IPFIX Mediator equipped with traffic classification capabilities for security purposes, potentially malicious Flows could be exported directly, while known-good or probably-good Flows (e.g. normal web browsing) could be exported simply as time series volumes per web server.</p>
<p id="rfc.section.3.p.3">Note that an Intermediate Aggregation Process which removes potentially sensitive information as identified in <a href="#RFC6235">[RFC6235]</a> may tend to have an anonymising effect on the Aggregated Flows, as well; however, any application of aggregation as part of a data protection scheme should ensure that all the issues raised in <a href="#RFC6235">[RFC6235]</a> are addressed, specifically Section 4 "Anonymization of IP Flow Data", Section 7.2 "IPFIX-Specific Anonymization Guidelines", and Section 9 "Security Considerations".</p>
<p id="rfc.section.3.p.4">While much of the discussion in this document, and all of the examples, apply to the common case that the Original Flows to be aggregated are all of the same underlying type (i.e., are represented with identical or compatible Templates), and that each packet observed by the Metering Process on the far side of the Original Exporter is represented, this is not a necessary assumption. Aggregation can also be applied as part of a technique applying both aggregation and correlation to pull together multiple views of the same traffic from different Observation Points using different Templates. For example, consider a set of applications running at different Observation Points for different purposes -- one generating flows with round-trip-times for passive performance measurement, and one generating billing records. Once correlated, these flows could be run through an Intermediate Aggregation Process to produce Aggregated Flows containing both volume and performance information together. (Note, however, that the details of correlation are not in scope for this document.)</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> Architecture for Flow Aggregation</h1>
<p id="rfc.section.4.p.1">This section specifies how an Intermediate Aggregation Process fits into the IPFIX Architecture, and the architecture of the Intermediate Aggregation Process itself.</p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#sec-arch" id="sec-arch">Aggregation within the IPFIX Architecture</a>
</h1>
<p id="rfc.section.4.1.p.1">An Intermediate Aggregation Process could be deployed at any of three places within the IPFIX Architecture. While aggregation is most commonly done within a Mediator which collects Original Flows from an Original Exporter and exports Aggregated Flows, aggregation can also occur before initial export, or after final collection, as shown in <a href="#loc-fig">Figure 1</a>. The presence of an IAP at any of these points is of course optional.</p>
<div id="#rfc.figure.1"></div>
<div id="#loc-fig"></div>
<pre>
+===========================================+
|  IPFIX Exporter        +----------------+ |
|                        | Metering Proc. | |
| +-----------------+    +----------------+ |
| | Metering Proc.  | or |      IAP       | |
| +-----------------+----+----------------+ |
| |           Exporting Process           | |
| +-|----------------------------------|--+ |
+===|==================================|====+
    |                                  |
    |         (Aggregated Flow Export) |
    |                                  |
+===|===========================+      |
|   |  Mediator                 |      |
+ +-V-------------------+       |      |
| | Collecting Process  |       |      |
+ +---------------------+       |      |
| |         IAP         |       |      |
+ +---------------------+       |      |
| |  Exporting Process  |       |      |
+ +-|-------------------+       |      |
+===|===========================+      |
    |                                  |
    | (Aggregating Mediator)           |
    |                                  |
+===|==================================|=====+
|   | Collector                        |     |
| +-V----------------------------------V-+   |
| |         Collecting Process           |   |
| +------------------+-------------------+   |
|                    |        IAP        |   |
|                    +-------------------+   |
|                    |   File Writer     |   |
|                    +-----------|-------+   |
+================================|===========+
                                 |
       (Aggregation for Storage) |
                                 V
                          +------------------+
                          |    IPFIX File    |
                          +------------------+
</pre>
<p id="rfc.section.4.1.p.2">The Mediator use case is further shown in Figures A and B in <a href="#RFC6183">[RFC6183]</a>.</p>
<p id="rfc.section.4.1.p.3">Aggregation can be applied for either intermediate or final analytic purposes. In certain circumstances, it may make sense to export Aggregated Flows directly from an original Exporting Process, for example, if the Exporting Process is applied to drive a time-series visualization, or when flow data export bandwidth is restricted and flow or packet sampling is not an option. Note that this case, where the Aggregation Process is essentially integrated into the Metering Process, is essentially covered by the <a href="#RFC5470">IPFIX architecture</a> <cite title="NONE">[RFC5470]</cite>: the Flow Keys used are simply a subset of those that would normally be used, and time intervals may be chosen other than those available from the cache policies customarily offered by the Metering Process. A Metering Process in this arrangement MAY choose to simulate the generation of larger Flows in order to generate Original Flow counts, if the application calls for compatibility with an Aggregation Process deployed in a separate location.</p>
<p id="rfc.section.4.1.p.4">In the specific case that an Aggregation Process is employed for data reduction for storage purposes, it can take Original Flows from a Collecting Process or File Reader and pass Aggregated Flows to a File Writer for storage.</p>
<p id="rfc.section.4.1.p.5">Deployment of an Intermediate Aggregation Process within a <a href="#RFC5982">Mediator</a> <cite title="NONE">[RFC5982]</cite> is a much more flexible arrangement.  Here, the Mediator consumes Original Flows and produces Contributing Flows; this arrangement is suited to any of the use cases detailed in <a href="#sec-usecase">Section 3</a>. In a Mediator, aggregation can be applied as well to aggregating Original Flows from multiple sources into a single stream of Aggregated Flows; the architectural specifics of this arrangement are not addressed in this document, which is concerned only with the aggregation operation itself; see <a href="#I-D.claise-ipfix-mediation-protocol">[I-D.claise-ipfix-mediation-protocol]</a> for details.</p>
<p id="rfc.section.4.1.p.6">The data paths into and out of an Intermediate Aggregation Process are shown in <a href="#iap-dataflows">Figure 2</a>.</p>
<div id="#rfc.figure.2"></div>
<div id="#iap-dataflows"></div>
<pre>
  packets --+                     +- IPFIX Messages -+
            |                     |                  |
            V                     V                  V
  +==================+ +====================+ +=============+
  | Metering Process | | Collecting Process | | File Reader |
  |                  | +====================+ +=============+
  | (original Flows  |            |  Original Flows  |
  |  or direct aggr.)|            V                  V
  + - - - - - - - - -+======================================+
  |           Intermediate Aggregation Process (IAP)        |
  +=========================================================+
            | Aggregated                  Aggregated |
            | Flows                            Flows |
            V                                        V
  +===================+                       +=============+
  | Exporting Process |                       | File Writer |
  +===================+                       +=============+
            |                                        |
            +------------&gt; IPFIX Messages &lt;----------+
          </pre>
<p id="rfc.section.4.1.p.7">In the special case that aggregation is used together with correlation to aggregate the output from multiple Metering Processes, the arrangement would appear as in <a href="#iap-correl-dataflows">Figure 3</a>; the details of correlation are, as noted above, out of scope for this document.</p>
<div id="#rfc.figure.3"></div>
<div id="#iap-correl-dataflows"></div>
<pre>
  packets --+---------------------+------------------+
            |                     |                  |
            V                     V                  V
  +====================+ +====================+ +====================+
  | Metering Process 1 | | Metering Process 2 | | Metering Process n |
  +====================+ +====================+ +====================+
            |                     |  Original Flows  |
            V                     V                  V
  +==================================================================+
  |                       Correlation process                        |
  +------------------------------------------------------------------+  
  |                 Intermediate Aggregation Process (IAP)           |
  +==================================================================+
            | Aggregated                  Aggregated |
            | Flows                            Flows |
            V                                        V
  +===================+                       +=============+
  | Exporting Process |                       | File Writer |
  +===================+                       +=============+
            |                                        |
            +------------&gt; IPFIX Messages &lt;----------+
          </pre>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#sec-iap-arch" id="sec-iap-arch">Intermediate Aggregation Process Architecture</a>
</h1>
<p id="rfc.section.4.2.p.1">Within this document, an Intermediate Aggregation Process can be seen as hosting a function composed of four types of operations on Partially Aggregated Flows, as illustrated in <a href="#iap-arch-diagram">Figure 4</a>. "Partially Contributing Flows" as defined in <a href="#sec-terminology">Section 2</a> are essentially the intermediate results of aggregation, internal to the Intermediate Aggregation Process.</p>
<div id="#rfc.figure.4"></div>
<div id="#iap-arch-diagram"></div>
<pre>

         Original Flows
 +=============|=====================================================+
 |             |  Intermediate Aggregation Process (IAP)             |
 |             V                                                     |
 |  +--------------------------------------------------------------+ |
 |  |                interval distribution (temporal)              | |
 |  +--------------------------------------------------------------+ |
 |           | ^                         | ^                |        |
 |           | |  Partially Aggregated   | |    Flows       |        |
 |           V |                         V |                |        |
 |  +-------------------+       +--------------------+      |        |
 |  |  key aggregation  |&lt;------|  value aggregation |      |        |
 |  |     (spatial)     |------&gt;|      (spatial)     |      |        |
 |  +-------------------+       +--------------------+      |        |
 |            |                          |                  |        |
 |            |   Partially Aggregated   |      Flows       |        |
 |            V                          V                  V        |
 |  +--------------------------------------------------------------+ |
 |  |                     aggregate combination                    | |
 |  +--------------------------------------------------------------+ |
 |                                       |                           |
 +=======================================|===========================+
                                         V
                                 Aggregated Flows
</pre>
<p id="rfc.section.4.2.p.2">The first three of these operations may be carried out any number of times in any order, either on Original Flows or on the results of one of the Operations (called Partially Aggregated Flows), with one caveat: since Flows carry their own interval data, any spatial aggregation operation implies a temporal aggregation operation, so at least one interval distribution step, even if implicit, is required by this architecture. This is shown as the first step for the sake of simplicity in the diagram above. Once all aggregation operations are complete, aggregate combination ensures that for a given Aggregation Interval, set of Flow Key values, and Observation Domain, only one Flow is produced by the Intermediate Aggregation Process.</p>
<p id="rfc.section.4.2.p.3">This model describes the operations within a single Intermediate Aggregation Process, and it is anticipated that most aggregation will be applied within a single process. However, as the steps in the model may be applied in any order and aggregate combination is idempotent, any number of Intermediate Aggregation Processes operating in series can be modeled as a single process. This allows aggregation operations to be flexibly distributed across any number of processes, should application or deployment considerations so dictate.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> IP Flow Aggregation Operations</h1>
<p id="rfc.section.5.p.1">As stated in <a href="#sec-terminology">Section 2</a>, an Aggregated Flow is simply an IPFIX Flow generated from Original Flows by an Intermediate Aggregation Process. Here, we detail the operations by which this is achieved within an Intermediate Aggregation Process.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#sec-iap-interval" id="sec-iap-interval">Temporal Aggregation through Interval Distribution</a>
</h1>
<p id="rfc.section.5.1.p.1">Interval distribution imposes a time interval on the resulting Aggregated Flows. The selection of an interval is specific to the given aggregation application. Intervals may be derived from the Original Flows themselves (e.g., an interval may be selected to cover the entire interval containing the set of all Flows sharing a given Key, as in Time Composition describe in <a href="#sec-timecomp">Section 5.1.2</a>) or externally imposed; in the latter case the externally imposed interval may be regular (e.g., every five minutes) or irregular (e.g., to allow for different time resolutions at different times of day, under different network conditions, or indeed for different sets of Original Flows).</p>
<p id="rfc.section.5.1.p.2">The length of the imposed interval itself has tradeoffs.  Shorter intervals allow higher resolution aggregated data and, in streaming applications, faster reaction time. Longer intervals lead to greater data reduction and simplified counter distribution. Specifically, counter distribution is greatly simplified by the choice of an interval longer than the duration of longest Original Flow, itself generally determined by the Original Flow's Metering Process active timeout; in this case an Original Flow can contribute to at most two Aggregated Flows, and the more complex value distribution methods become inapplicable.</p>
<div id="#rfc.figure.5"></div>
<div id="#intdist-fig"></div>
<pre>
|                |                |                |
| |&lt;--Flow A--&gt;| |                |                |
|        |&lt;--Flow B--&gt;|           |                |
|          |&lt;-------------Flow C--------------&gt;|   |
|                |                |                |
|   interval 0   |   interval 1   |   interval 2   |
                </pre>
<p id="rfc.section.5.1.p.3">In <a href="#intdist-fig">Figure 5</a>, we illustrate three common possibilities for interval distribution as applies with regular intervals to a set of three Original Flows. For Flow A, the start and end times lie within the boundaries of a single interval 0; therefore, Flow A contributes to only one Aggregated Flow. Flow B, by contrast, has the same duration but crosses the boundary between intervals 0 and 1; therefore, it will contribute to two Aggregated Flows, and its counters must be distributed among these Flows, though in the two-interval case this can be simplified somewhat simply by picking one of the two intervals, or proportionally distributing between them. Only Flows like Flow A and Flow B will be produced when the interval is chosen to be longer than the duration of longest Original Flow, as above. More complicated is the case of Flow C, which contributes to more than two Aggregated Flows, and must have its counters distributed according to some policy as in <a href="#sec-distro">Section 5.1.1</a>.</p>
<h1 id="rfc.section.5.1.1">
<a href="#rfc.section.5.1.1">5.1.1.</a> <a href="#sec-distro" id="sec-distro">Distributing Values Across Intervals</a>
</h1>
<p id="rfc.section.5.1.1.p.1">In general, counters in Aggregated Flows are treated the same as in any Flow. Each counter is independently calculated as if it were derived from the set of packets in the Original Flow.  For the most part, when aggregating Original Flows into Aggregated Flows, this is simply done by summation.</p>
<p id="rfc.section.5.1.1.p.2">When the Aggregation Interval is guaranteed to be longer than the longest Original Flow, a Flow can cross at most one Interval boundary, and will therefore contribute to at most two Aggregated Flows. Most common in this case is to arbitrarily but consistently choose to account the Original Flow's counters either to the first or the last Contributing Flow to which it could contribute.</p>
<p id="rfc.section.5.1.1.p.3">However, this becomes more complicated when the Aggregation Interval is shorter than the longest Original Flow in the source data. In such cases, each Original Flow can incompletely cover one or more time intervals, and apply to one or more Aggregated Flows. In this case, the Aggregation Process must distribute the counters in the Original Flows across the multiple Aggregated Flows. There are several methods for doing this, listed here in roughly increasing order of complexity and accuracy; most of these are necessary only in specialized cases.</p>
<p id="rfc.section.5.1.1.p.4">A method for exporting the distribution of counters across multiple Aggregated Flows is detailed in <a href="#sec-ex-distro">Section 7.4</a>. In any case, counters MUST be distributed across the multiple Aggregated Flows in such a way that the total count is preserved, within the limits of accuracy of the implementation (e.g., inaccuracy introduced by the use of floating-point numbers is tolerable). This property allows data to be aggregated and re-aggregated without any loss of original count information. To avoid confusion in interpretation of the aggregated data, all the counters for a set of given Original Flows SHOULD be distributed via the same method.</p>
<p id="rfc.section.5.1.1.p.5">More complex counter distribution methods generally require that the interval distribution process track multiple "current" time intervals at once. This may introduce some delay into the aggregation operation, as an interval should only expire and be available for export when no additional Original Flows applying to the interval are expected to arrive at the Intermediate Aggregation Process.</p>
<p id="rfc.section.5.1.1.p.6">Note, however, that since there is no guarantee that Flows from the Original Exporter will arrive in any given order, whether for transport-specific reasons (i.e. UDP reordering) or Metering Process implementation-specific reasons, even simpler distribution methods may need to deal with flows arriving in other than start time or end time order. Therefore, the use of larger intervals does not obviate the need to buffer Partially Aggregated Flows within "current" time intervals, to ensure it can accept flow time intervals in any arrival order. More generally, the interval distribution process SHOULD accept flow start and end times in the Original Flows in any reasonable order. The expiration of intervals in interval distribution operations is dependent on implementation and deployment requirements, and SHOULD be made configurable in contexts in which "reasonable order" is not obvious at implementation time.</p>
<h1 id="rfc.section.5.1.2">
<a href="#rfc.section.5.1.2">5.1.2.</a> <a href="#sec-timecomp" id="sec-timecomp">Time Composition</a>
</h1>
<p id="rfc.section.5.1.2.p.1">Time Composition as in Section 5.4 of <a href="#RFC5982">[RFC5982]</a> (or interval combination) is a special case of aggregation, where interval distribution imposes longer intervals on Flows with matching keys and "chained" start and end times, without any key reduction, in order to join long-lived Flows which may have been split (e.g., due to an active timeout shorter than the actual duration of the Flow.) Here, no Key aggregation is applied, and the Aggregation Interval is chosen on a per-Flow basis to cover the interval spanned by the set of aggregated Flows. This may be applied alone in order to normalize split Flows, or in combination with other aggregation functions in order to obtain more accurate Original Flow counts.</p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#sec-iap-key" id="sec-iap-key">Spatial Aggregation of Flow Keys</a>
</h1>
<p id="rfc.section.5.2.p.1">Key aggregation generates a new set of Flow Key values for the Aggregated Flows from the Original Flow Keys, non-Key fields in the Original Flows, or from correlation of the Original Flow information with some external source. There are two basic operations here. First, Aggregated Flow Keys may be derived directly from Original Flow Keys through reduction, or the dropping of fields or precision in the Original Flow Keys. Second, Aggregated Flow Keys may be derived through replacement, e.g. by removing one or more fields from the Original Flow and replacing them with fields derived from the removed fields. Replacement may refer to external information (e.g., IP to AS number mappings).  Replacement may apply to Flow Keys as well as non-key fields. For example, consider an application which aggregates Original Flows by packet count (i.e., generating an Aggregated Flow for all one-packet Flows, one for all two-packet Flows, and so on). This application would promote the packet count to a Flow Key.</p>
<p id="rfc.section.5.2.p.2">Key aggregation may also result in the addition of new non-Key fields to the Aggregated Flows, namely Original Flow counters and unique reduced key counters; these are treated in more detail in <a href="#sec-flowcount">Section 5.2.1</a> and <a href="#sec-distinct">Section 5.2.2</a>, respectively.</p>
<p id="rfc.section.5.2.p.3">In any key aggregation operation, reduction and/or replacement may be applied any number of times in any order. Which of these operations are supported by a given implementation is implementation- and application-dependent. Key aggregation may aggregate Original Flows with different sets of Flow Keys; only the Flow Keys of the resulting Aggregated Flows of any given Key aggregation operation need to contain the same set of fields.</p>
<div id="#rfc.figure.6"></div>
<div id="#keyagg-simple-fig"></div>
<pre>
Original Flow Keys
+---------+---------+----------+----------+-------+-----+
| src ip4 | dst ip4 | src port | dst port | proto | tos |
+---------+---------+----------+----------+-------+-----+
     |         |         |          |         |      |
  retain   mask /24      X          X         X      X
     V         V
+---------+-------------+
| src ip4 | dst ip4 /24 |
+---------+-------------+
Aggregated Flow Keys (by source address and destination class-C)
                </pre>
<p><a href="#keyagg-simple-fig">Figure 6</a> illustrates an example reduction operation, aggregation by source address and destination class C network. Here, the port, protocol, and type-of-service information is removed from the Flow Key, the source address is retained, and the destination address is masked by dropping the low 8 bits.</p>
<div id="#rfc.figure.7"></div>
<div id="#keyagg-replace-fig"></div>
<pre>
Original Flow Keys
+---------+---------+----------+----------+-------+-----+
| src ip4 | dst ip4 | src port | dst port | proto | tos |
+---------+---------+----------+----------+-------+-----+
     |         |         |          |         |      |
+-------------------+    X          X         X      X
| ASN lookup table  |
+-------------------+
     V         V
+---------+---------+
| src asn | dst asn |
+---------+---------+
Aggregated Flow Keys (by source and dest ASN)
                </pre>
<p><a href="#keyagg-replace-fig">Figure 7</a> illustrates an example reduction and replacement operation, aggregation by source and destination Border Gateway Protocol (BGP) Autonomous System Number (ASN) without ASN information available in the Original Flow.  Here, the port, protocol, and type-of-service information is removed from the Flow Keys, while the source and destination addresses are run though an IP address to ASN lookup table, and the Aggregated Flow Keys are made up of the resulting source and destination ASNs.</p>
<h1 id="rfc.section.5.2.1">
<a href="#rfc.section.5.2.1">5.2.1.</a> <a href="#sec-flowcount" id="sec-flowcount">Counting Original Flows</a>
</h1>
<p id="rfc.section.5.2.1.p.1">When aggregating multiple Original Flows into an Aggregated Flow, it is often useful to know how many Original Flows are present in the Aggregated Flow. This document introduces four new information elements in <a href="#sec-ex-flowcount">Section 7.2</a> to export these counters.</p>
<p id="rfc.section.5.2.1.p.2">There are two possible ways to count Original Flows, which we call here conservative and non-conservative. Conservative flow counting has the property that each Original Flow contributes exactly one to the total flow count within a set of Contributing Flows. In other words, conservative flow counters are distributed just as any other counter during interval distribution, except each Original Flow is assumed to have a flow count of one. When a count for an Original Flow must be distributed across a set of Aggregated Flows, and a distribution method is used which does not account for that Original Flow completely within a single Aggregated Flow, conservative flow counting requires a fractional representation.</p>
<p id="rfc.section.5.2.1.p.3">By contrast, non-conservative flow counting is used to count how many Contributing Flows are represented in an Aggregated Flow. Flow counters are not distributed in this case. An Original Flow which is present within N Aggregated Flows would add N to the sum of non-conservative flow counts, one to each Aggregated Flow. In other words, the sum of conservative flow counts over a set of Aggregated Flows is always equal to the number of Original Flows, while the sum of non-conservative flow counts is strictly greater than or equal to the number of Original Flows.</p>
<p id="rfc.section.5.2.1.p.4">For example, consider Flows A, B, and C as illustrated in <a href="#intdist-fig">Figure 5</a>. Assume that the key aggregation step aggregates the keys of these three Flows to the same aggregated Flow Key, and that start interval counter distribution is in effect. The conservative flow count for interval 0 is 3 (since Flows A, B, and C all begin in this interval), and for the other two intervals is 0. The non-conservative flow count for interval 0 is also 3 (due to the presence of Flows A, B, and C), for interval 1 is 2 (Flows B and C), and for interval 2 is 1 (Flow C). The sum of the conservative counts 3 + 0 + 0 = 3, the number of Original Flows; while the sum of the non-conservative counts 3 + 2 + 1 = 6.</p>
<p id="rfc.section.5.2.1.p.5">Note that the active and inactive timeouts used to generate Original Flows, as well as the cache policy used to generate those Flows, have an effect on how meaningful either the conservative or non-conservative flow count will be during aggregation. In general, all the Original Exporters producing Original Flows to be aggregated SHOULD be aggregated using caches configured identically or similarly. Original Exporters using the IPFIX Configuration Model SHOULD be configured to export Flows with equal or similar activeTimeout and inactiveTimeout configuration values, and the same cacheMode, as defined in section 4.3 of <a href="#I-D.ietf-ipfix-configuration-model">[I-D.ietf-ipfix-configuration-model]</a>.</p>
<h1 id="rfc.section.5.2.2">
<a href="#rfc.section.5.2.2">5.2.2.</a> <a href="#sec-distinct" id="sec-distinct">Counting Distinct Key Values</a>
</h1>
<p id="rfc.section.5.2.2.p.1">One common case in aggregation is counting distinct key values that were reduced away during key aggregation. The most common use case for this is counting distinct hosts per Flow Key; for example, in host characterization or anomaly detection, distinct sources per destination or distinct destinations per source are common metrics. These new non-Key fields are added during key aggregation.</p>
<p id="rfc.section.5.2.2.p.2">For such applications, Information Elements for distinct counts of IPv4 and IPv6 addresses are defined in <a href="#sec-ex-distinct">Section 7.3</a>. These are named distinctCountOf(KeyName). Additional such Information Elements SHOULD be registered with IANA on an as-needed basis.</p>
<h1 id="rfc.section.5.3">
<a href="#rfc.section.5.3">5.3.</a> <a href="#sec-iap-value" id="sec-iap-value">Spatial Aggregation of Non-Key Fields</a>
</h1>
<p id="rfc.section.5.3.p.1">Aggregation operations may also lead to the addition of value fields demoted from key fields, or derived from other value fields in the Original Flows. Specific cases of this are treated in the subsections below. </p>
<h1 id="rfc.section.5.3.1">
<a href="#rfc.section.5.3.1">5.3.1.</a> <a href="#sec-countstats" id="sec-countstats">Counter Statistics</a>
</h1>
<p id="rfc.section.5.3.1.p.1">Some applications of aggregation may benefit from computing different statistics than those native to each non-key field (i.e., union for flags, sum for counters). For example, minimum and maximum packet counts per Flow, mean bytes per packet per Contributing Flow, and so on. Certain Information Elements for these applications are already provided in the IANA IPFIX Information Elements registry (http://www.iana.org/assignments/ipfix/ipfix.html (e.g.  minimumIpTotalLength).</p>
<p id="rfc.section.5.3.1.p.2">A complete specification of additional aggregate counter statistics is outside the scope of this document, and should be added in the future to the IANA IPFIX Information Elements registry on a per-application, as-needed basis.</p>
<h1 id="rfc.section.5.3.2">
<a href="#rfc.section.5.3.2">5.3.2.</a> <a href="#sec-derived" id="sec-derived">Derivation of New Values from Flow Keys and non-Key fields</a>
</h1>
<p id="rfc.section.5.3.2.p.1">More complex operations may lead to other derived fields being generated from the set of values or Flow Keys reduced away during aggregation. A prime example of this is sample entropy calculation. This counts distinct values and frequency, so is similar to distinct key counting as in <a href="#sec-distinct">Section 5.2.2</a>, but may be applied to the distribution of values for any flow field.</p>
<p id="rfc.section.5.3.2.p.2">Sample entropy calculation provides a one-number normalized representation of the value spread and is useful for annomaly detection. The behaviour of entropy statistics is such that a small number of keys showing up very often drives the entropy value down towards zero, while a large number of keys, each showing up with lower frequency drives the entropy value up.</p>
<p id="rfc.section.5.3.2.p.3">Entropy statistics are generally useful for address-like keys, like IP addresses, port numbers, AS numbers, etc. They can also be done on flow length, flow duration fields and the like, even if this generally yields less distinct value shifts when the traffic mix changes.</p>
<p id="rfc.section.5.3.2.p.4">As a practical example, one host scanning a lot of other hosts will drive source IP entropy down and target IP entropy up. A similar effect can be observed for ports. This pattern can also be caused by the scan-traffic of a fast Internet worm. A second example would be a DDoS flooding attack against a single target (or small number of targets) which drives source IP entropy up and target IP entropy down.</p>
<p id="rfc.section.5.3.2.p.5">A complete specification of additional derived values or entropy information elements is outside the scope of this document. Any such Information Elements should be added in the future to the IANA IPFIX Information Elements registry on a per-application, as-needed basis. However, in the special case of entropy calculations, to support comparability of entropies of fields with different bit sizes, entropy SHOULD be represented as a float32 or float64 value normalized to the range [0..1].</p>
<h1 id="rfc.section.5.4">
<a href="#rfc.section.5.4">5.4.</a> <a href="#sec-iap-combo" id="sec-iap-combo">Aggregation Combination</a>
</h1>
<p id="rfc.section.5.4.p.1">Interval distribution and key aggregation together may generate multiple Partially Aggregated Flows covering the same time interval with the same set of Flow Key values. The process of combining these Partially Aggregated Flows into a single Aggregated Flow is called aggregation combination. In general, non-Key values from multiple Contributing Flows are combined using the same operation by which values are combined from packets to form Flows for each Information Element. Counters are summed, averages are averaged, flags are unioned, and so on.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> Additional Considerations and Special Cases in Flow Aggregation</h1>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> <a href="#sec-lowfi" id="sec-lowfi">Exact versus Approximate Counting during Aggregation</a>
</h1>
<p id="rfc.section.6.1.p.1">In certain circumstances, particularly involving aggregation by devices with limited resources, and in situations where exact aggregated counts are less important than relative magnitudes (e.g. driving graphical displays), counter distribution during key aggregation may be performed by approximate counting means (e.g.  Bloom filters). The choice to use approximate counting is implementation- and application-dependent.</p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> Considerations for Aggregation of Sampled Flows</h1>
<p id="rfc.section.6.2.p.1">The accuracy of Aggregated Flows may also be affected by sampling of the Original Flows, or sampling of packets making up the Original Flows. The effect of sampling on flow aggregation is still an open research question. However, to maximize the comparability of Aggregated Flows, aggregation of sampled Flows SHOULD only use Original Flows sampled using the same sampling rate and sampling algorithm, or Flows created from packets sampled using the same sampling rate and sampling algorithm. For more on packet sampling within IPFIX, see <a href="#RFC5476">[RFC5476]</a>. For more on Flow sampling within the IPFIX Mediator Framework, see <a href="#I-D.ietf-ipfix-flow-selection-tech">[I-D.ietf-ipfix-flow-selection-tech]</a>.</p>
<h1 id="rfc.section.6.3">
<a href="#rfc.section.6.3">6.3.</a> Considerations for Aggregation of Heterogeneous Flows</h1>
<p id="rfc.section.6.3.p.1">Aggregation may be applied to Original Flows from different sources and of different types (i.e., represented using different, perhaps wildly-different Templates). When the goal is to separate the heterogeneous Original Flows and aggregate them into heterogeneous Aggregated Flows, each aggregation should be done at its own Intermediate Aggregation Process. The Observation Domain ID on the Messages containing the output Aggregated Flows can be used to identify the different Processes, and to segregate the output.</p>
<p id="rfc.section.6.3.p.2">However, when the goal is to aggregate these Flows into a single stream of Aggregated Flows representing one type of data, and if the Original Flows may represent the same original packet at two different Observation Points, the Original Flows should be correlated to ensure that each packet is only represented in a single Aggregated Flow or set of Aggregated Flows differing only by aggregation interval.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#sec-export" id="sec-export">Export of Aggregated IP Flows using IPFIX</a>
</h1>
<p id="rfc.section.7.p.1">In general, Aggregated Flows are exported in IPFIX as any normal Flow. However, certain aspects of Aggregated Flow export benefit from  additional guidelines, or new Information Elements to represent aggregation metadata or information generated during aggregation. These are detailed in the following subsections.</p>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> Time Interval Export</h1>
<p id="rfc.section.7.1.p.1">Since an Aggregated Flow is simply a Flow, the existing timestamp Information Elements in the IPFIX Information Model (e.g., flowStartMilliseconds, flowEndNanoseconds) are sufficient to specify the time interval for aggregation. Therefore, this document specifies no new aggregation-specific Information Elements for exporting time interval information.</p>
<p id="rfc.section.7.1.p.2">Each Aggregated Flow SHOULD contain both an interval start and interval end timestamp. If an exporter of Aggregated Flows omits the interval end timestamp from each Aggregated Flow, the time interval for Aggregated Flows within an Observation Domain and Transport Session MUST be regular and constant.  However, note that this approach might lead to interoperability problems when exporting Aggregated Flows to non-aggregation-aware Collecting Processes and downstream analysis tasks; therefore, an Exporting Process capable of exporting only interval start timestamps MUST provide a configuration option to export interval end timestamps as well.</p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> <a href="#sec-ex-flowcount" id="sec-ex-flowcount">Flow Count Export</a>
</h1>
<p id="rfc.section.7.2.p.1">The following four Information Elements are defined to count Original Flows as discussed in <a href="#sec-flowcount">Section 5.2.1</a>.</p>
<h1 id="rfc.section.7.2.1">
<a href="#rfc.section.7.2.1">7.2.1.</a> <a href="#ie-noncon-flowcount" id="ie-noncon-flowcount">originalFlowsPresent</a>
</h1>
<h1 id="rfc.section.7.2.2">
<a href="#rfc.section.7.2.2">7.2.2.</a> <a href="#ie-con-flowstartcount" id="ie-con-flowstartcount">originalFlowsInitiated</a>
</h1>
<h1 id="rfc.section.7.2.3">
<a href="#rfc.section.7.2.3">7.2.3.</a> <a href="#ie-con-flowendcount" id="ie-con-flowendcount">originalFlowsCompleted</a>
</h1>
<h1 id="rfc.section.7.2.4">
<a href="#rfc.section.7.2.4">7.2.4.</a> <a href="#ie-con-flowcount" id="ie-con-flowcount">deltaFlowCount</a>
</h1>
<h1 id="rfc.section.7.3">
<a href="#rfc.section.7.3">7.3.</a> <a href="#sec-ex-distinct" id="sec-ex-distinct">Distinct Host Export</a>
</h1>
<p id="rfc.section.7.3.p.1">The following four Information Elements represent the distinct counts of source and destination network-layer addresses, used to export distinct host counts reduced away during key aggregation.</p>
<h1 id="rfc.section.7.3.1">
<a href="#rfc.section.7.3.1">7.3.1.</a> <a href="#ie-dsip" id="ie-dsip">distinctCountOfSourceIPAddress</a>
</h1>
<h1 id="rfc.section.7.3.2">
<a href="#rfc.section.7.3.2">7.3.2.</a> <a href="#ie-ddip" id="ie-ddip">distinctCountOfDestinationIPAddress</a>
</h1>
<h1 id="rfc.section.7.3.3">
<a href="#rfc.section.7.3.3">7.3.3.</a> <a href="#ie-dsip4" id="ie-dsip4">distinctCountOfSourceIPv4Address</a>
</h1>
<h1 id="rfc.section.7.3.4">
<a href="#rfc.section.7.3.4">7.3.4.</a> <a href="#ie-ddip4" id="ie-ddip4">distinctCountOfDestinationIPv4Address</a>
</h1>
<h1 id="rfc.section.7.3.5">
<a href="#rfc.section.7.3.5">7.3.5.</a> <a href="#ie-dsip6" id="ie-dsip6">distinctCountOfSourceIPv6Address</a>
</h1>
<h1 id="rfc.section.7.3.6">
<a href="#rfc.section.7.3.6">7.3.6.</a> <a href="#ie-ddip6" id="ie-ddip6">distinctCountOfDestinationIPv6Address</a>
</h1>
<h1 id="rfc.section.7.4">
<a href="#rfc.section.7.4">7.4.</a> <a href="#sec-ex-distro" id="sec-ex-distro">Aggregate Counter Distribution Export</a>
</h1>
<p id="rfc.section.7.4.p.1">When exporting counters distributed among Aggregated Flows, as described in <a href="#sec-distro">Section 5.1.1</a>, the Exporting Process MAY export an Aggregate Counter Distribution Record for each Template describing Aggregated Flow records; this Options Template is described below. It uses the valueDistributionMethod Information Element, also defined below. Since in many cases distribution is simple, accounting the counters from Contributing Flows to the first Interval to which they contribute, this is default situation, for which no Aggregate Counter Distribution Record is necessary; Aggregate Counter Distribution Records are only applicable in more exotic situations, such as using an Aggregation Interval smaller than the durations of Original Flows.</p>
<h1 id="rfc.section.7.4.1">
<a href="#rfc.section.7.4.1">7.4.1.</a> Aggregate Counter Distribution Options Template</h1>
<div id="#rfc.table.1"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="left">IE</th>
<th class="left">Description</th>
</tr></thead>
<tbody>
<tr>
<td class="left">templateId [scope]</td>
<td class="left">The Template ID of the Template defining the Aggregated Flows to which this distribution option applies. This Information Element MUST be defined as a Scope Field.  </td>
</tr>
<tr>
<td class="left">valueDistributionMethod</td>
<td class="left">The method used to distribute the counters for the Aggregated Flows defined by the associated Template.  </td>
</tr>
</tbody>
</table>
<p id="rfc.section.7.4.1.p.1">This Options Template defines the Aggregate Counter Distribution Record, which allows the binding of a value distribution method to a Template ID. Note that this Options Template causes the valueDistributionMethod to be implicitly scoped to the Observation Domain ID of the IPFIX Message containing the Aggregate Counter Distribution Record. This is used to signal to the Collecting Process how the counters were distributed. The fields are as below: </p>
<h1 id="rfc.section.7.4.2">
<a href="#rfc.section.7.4.2">7.4.2.</a> <a href="#ie-errmag" id="ie-errmag">valueDistributionMethod Information Element</a>
</h1>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> Examples</h1>
<p id="rfc.section.8.p.1">In these examples, the same data, described by the same template, will be aggregated multiple different ways; this illustrates the various different functions which could be implemented by Intermediate Aggregation Processes. Templates are shown in iespec format as introduced in <a href="#I-D.trammell-ipfix-ie-doctors">[I-D.trammell-ipfix-ie-doctors]</a>. The source data format is a simplified flow: timestamps, traditional 5-tuple, and octet count. The template is shown in <a href="#ex-tmpl-in">Figure 8</a>.</p>
<div id="#rfc.figure.8"></div>
<div id="#ex-tmpl-in"></div>
<pre>
flowStartMilliseconds(152)[8]
flowEndMilliseconds(153)[8]
sourceIPv4Address(8)[4]
destinationIPv4Address(12)[4]
sourceTransportPort(7)[2]
destinationTransportPort(11)[2]
protocolIdentifier(4)[1]
octetDeltaCount(1)[8]
      </pre>
<p id="rfc.section.8.p.2">The data records given as input to the examples in this section are shown below, in the format "flowStartMilliseconds-flowEndMilliseconds  sourceIPv4Address:sourceTransportPort -&gt; destinationIPv4Address:destinationTransportPort (protocolIdentifier) octetDeltaCount"; timestamps are given in H:MM:SS.sss format.</p>
<div id="#rfc.figure.9"></div>
<div id="#ex-data-in"></div>
<pre>
9:00:00.138-9:00:00.138 192.0.2.2:47113   -&gt; 192.0.2.131:53   (17)   119
9:00:03.246-9:00:03.246 192.0.2.2:22153   -&gt; 192.0.2.131:53   (17)    83
9:00:00.478-9:00:03.486 192.0.2.2:52420   -&gt; 198.51.100.2:443  (6)  1637
9:00:07.172-9:00:07.172 192.0.2.3:56047   -&gt; 192.0.2.131:53   (17)   111
9:00:07.309-9:00:14.861 192.0.2.3:41183   -&gt; 198.51.100.67:80  (6) 16838
9:00:03.556-9:00:19.876 192.0.2.2:17606   -&gt; 198.51.100.68:80  (6) 11538
9:00:25.210-9:00:25.210 192.0.2.3:47113   -&gt; 192.0.2.131:53   (17)   119
9:00:26.358-9:00:30.198 192.0.2.3:48458   -&gt; 198.51.100.133:80 (6)  2973
9:00:29.213-9:01:00.061 192.0.2.4:61295   -&gt; 198.51.100.2:443  (6)  8350
9:04:00.207-9:04:04.431 203.0.113.3:41256 -&gt; 198.51.100.133:80 (6)   778
9:03:59.624-9:04:06.984 203.0.113.3:51662 -&gt; 198.51.100.3:80   (6)   883
9:00:30.532-9:06:15.402 192.0.2.2:37581   -&gt; 198.51.100.2:80   (6) 15420
9:06:56.813-9:06:59.821 203.0.113.3:52572 -&gt; 198.51.100.2:443  (6)  1637
9:06:30.565-9:07:00.261 203.0.113.3:49914 -&gt; 197.51.100.133:80 (6)   561
9:06:55.160-9:07:05.208 192.0.2.2:50824   -&gt; 198.51.100.2:443  (6)  1899
9:06:49.322-9:07:05.322 192.0.2.3:34597   -&gt; 198.51.100.3:80   (6)  1284
9:07:05.849-9:07:09.625 203.0.113.3:58907 -&gt; 198.51.100.4:80   (6)  2670
9:10:45.161-9:10:45.161 192.0.2.4:22478   -&gt; 192.0.2.131:53   (17)    75
9:10:45.209-9:11:01.465 192.0.2.4:49513   -&gt; 198.51.100.68:80  (6)  3374
9:10:57.094-9:11:00.614 192.0.2.4:64832   -&gt; 198.51.100.67:80  (6)   138
9:10:59.770-9:11:02.842 192.0.2.3:60833   -&gt; 198.51.100.69:443 (6)  2325
9:02:18.390-9:13:46.598 203.0.113.3:39586 -&gt; 198.51.100.17:80  (6) 11200
9:13:53.933-9:14:06.605 192.0.2.2:19638   -&gt; 198.51.100.3:80   (6)  2869
9:13:02.864-9:14:08.720 192.0.2.3:40429   -&gt; 198.51.100.4:80   (6) 18289
      </pre>
<h1 id="rfc.section.8.1">
<a href="#rfc.section.8.1">8.1.</a> <a href="#ex-srcip" id="ex-srcip">Traffic Time-Series per Source</a>
</h1>
<p id="rfc.section.8.1.p.1">Aggregating flows by source IP address in time series (i.e., with a regular interval) can be used in subsequent heavy-hitter analysis and as a source parameter for statistical anomaly detection techniques. Here, the Intermediate Aggregation Process imposes an interval, aggregates the key to remove all key fields other than the source IP address, then combines the result into a stream of Aggregated Flows. The imposed interval of 5 minutes is longer than the majority of flows; for those flows crossing interval boundaries, the entire flow is accounted to the interval containing the start time of the flow.</p>
<p id="rfc.section.8.1.p.2">In this example the Partially Aggregated Flows after each conceptual operation in the Intermediate Aggregation Process are shown. These are meant to be illustrative of the conceptual operations only, and not to suggest an implementation (indeed, the example shown here would not necessarily be the most efficient method for performing these operations). Subsequent examples will omit the Partially Aggregated Flows for brevity.</p>
<p id="rfc.section.8.1.p.3">The input to this process could be any Flow Record containing a source IP address and octet counter; consider for this example the template and data from the introduction. The Intermediate Aggregation Process would then output records containing just timestamps, source IP, and octetDeltaCount, as in <a href="#ex-srcip-tmpl-out">Figure 10</a>.</p>
<div id="#rfc.figure.10"></div>
<div id="#ex-srcip-tmpl-out"></div>
<pre>
flowStartMilliseconds(152)[8]
flowEndMilliseconds(153)[8]
sourceIPv4Address(8)[4]
octetDeltaCount(1)[8]
      </pre>
<p id="rfc.section.8.1.p.4">Assume the goal is to get 5-minute time series of octet counts per source IP address. The aggregation operations would then be arranged as in <a href="#ex-srcip-iap">Figure 11</a>.</p>
<div id="#rfc.figure.11"></div>
<div id="#ex-srcip-iap"></div>
<pre>
                 Original Flows
                       |
                       V
           +-----------------------+
           | interval distribution |
           |  * impose uniform     |
           |    300s time interval |
           +-----------------------+ 
               |      
               | Partially Aggregated Flows
               V      
+------------------------+ 
|  key aggregation       | 
|   * reduce key to only | 
|     sourceIPv4Address  |
+------------------------+ 
               |      
               | Partially Aggregated Flows   
               V      
          +-------------------------+
          |  aggregate combination  |
          |   * sum octetDeltaCount |
          +-------------------------+
                       |
                       V
               Aggregated Flows
</pre>
<p id="rfc.section.8.1.p.5">After the interval distribution step, only the time intervals have changed; the Partially Aggregated flows are shown in <a href="#ex-srcip-pa-int">Figure 12</a>. Note that interval distribution follows the default Start Interval policy; that is, the entire flow is accounted to the interval containing the flow's start time.</p>
<div id="#rfc.figure.12"></div>
<div id="#ex-srcip-pa-int"></div>
<pre>
9:00:00.000-9:05:00.000 192.0.2.2:47113   -&gt; 192.0.2.131:53   (17)   119
9:00:00.000-9:05:00.000 192.0.2.2:22153   -&gt; 192.0.2.131:53   (17)    83
9:00:00.000-9:05:00.000 192.0.2.2:52420   -&gt; 198.51.100.2:443  (6)  1637
9:00:00.000-9:05:00.000 192.0.2.3:56047   -&gt; 192.0.2.131:53   (17)   111
9:00:00.000-9:05:00.000 192.0.2.3:41183   -&gt; 198.51.100.67:80  (6) 16838
9:00:00.000-9:05:00.000 192.0.2.2:17606   -&gt; 198.51.100.68:80  (6) 11538
9:00:00.000-9:05:00.000 192.0.2.3:47113   -&gt; 192.0.2.131:53   (17)   119
9:00:00.000-9:05:00.000 192.0.2.3:48458   -&gt; 198.51.100.133:80 (6)  2973
9:00:00.000-9:05:00.000 192.0.2.4:61295   -&gt; 198.51.100.2:443  (6)  8350
9:00:00.000-9:05:00.000 203.0.113.3:41256 -&gt; 198.51.100.133:80 (6)   778
9:00:00.000-9:05:00.000 203.0.113.3:51662 -&gt; 198.51.100.3:80   (6)   883
9:00:00.000-9:05:00.000 192.0.2.2:37581   -&gt; 198.51.100.2:80   (6) 15420
9:00:00.000-9:05:00.000 203.0.113.3:39586 -&gt; 198.51.100.17:80  (6) 11200
9:05:00.000-9:10:00.000 203.0.113.3:52572 -&gt; 198.51.100.2:443  (6)  1637
9:05:00.000-9:10:00.000 203.0.113.3:49914 -&gt; 197.51.100.133:80 (6)   561
9:05:00.000-9:10:00.000 192.0.2.2:50824   -&gt; 198.51.100.2:443  (6)  1899
9:05:00.000-9:10:00.000 192.0.2.3:34597   -&gt; 198.51.100.3:80   (6)  1284
9:05:00.000-9:10:00.000 203.0.113.3:58907 -&gt; 198.51.100.4:80   (6)  2670
9:10:00.000-9:15:00.000 192.0.2.4:22478   -&gt; 192.0.2.131:53   (17)    75
9:10:00.000-9:15:00.000 192.0.2.4:49513   -&gt; 198.51.100.68:80  (6)  3374
9:10:00.000-9:15:00.000 192.0.2.4:64832   -&gt; 198.51.100.67:80  (6)   138
9:10:00.000-9:15:00.000 192.0.2.3:60833   -&gt; 198.51.100.69:443 (6)  2325
9:10:00.000-9:15:00.000 192.0.2.2:19638   -&gt; 198.51.100.3:80   (6)  2869
9:10:00.000-9:15:00.000 192.0.2.3:40429   -&gt; 198.51.100.4:80   (6) 18289
      </pre>
<p id="rfc.section.8.1.p.6">After the key aggregation step, all Flow Keys except the source IP address have been discarded, as shown in <a href="#ex-srcip-pa-key">Figure 13</a>. This leaves duplicate Partially Aggregated flows to be combined in the final operation.</p>
<div id="#rfc.figure.13"></div>
<div id="#ex-srcip-pa-key"></div>
<pre>
9:00:00.000-9:05:00.000 192.0.2.2      119
9:00:00.000-9:05:00.000 192.0.2.2       83
9:00:00.000-9:05:00.000 192.0.2.2     1637
9:00:00.000-9:05:00.000 192.0.2.3      111
9:00:00.000-9:05:00.000 192.0.2.3    16838
9:00:00.000-9:05:00.000 192.0.2.2    11538
9:00:00.000-9:05:00.000 192.0.2.3      119
9:00:00.000-9:05:00.000 192.0.2.3     2973
9:00:00.000-9:05:00.000 192.0.2.4     8350
9:00:00.000-9:05:00.000 203.0.113.3    778
9:00:00.000-9:05:00.000 203.0.113.3    883
9:05:00.000-9:10:00.000 203.0.113.3   1637
9:05:00.000-9:10:00.000 203.0.113.3    561
9:05:00.000-9:10:00.000 192.0.2.2     1899
9:05:00.000-9:10:00.000 192.0.2.3     1284
9:05:00.000-9:10:00.000 203.0.113.3   2670
9:10:00.000-9:15:00.000 192.0.2.4       75
9:10:00.000-9:15:00.000 192.0.2.4     3374
9:10:00.000-9:15:00.000 192.0.2.4      138
9:10:00.000-9:15:00.000 192.0.2.3     2325
9:10:00.000-9:15:00.000 192.0.2.2     2869
9:10:00.000-9:15:00.000 192.0.2.3    18289
      </pre>
<p id="rfc.section.8.1.p.7">Aggregate combination sums the counters per key and interval; the summations of the first two keys and intervals are shown in detail in <a href="#ex-srcip-sum">Figure 14</a>.</p>
<div id="#rfc.figure.14"></div>
<div id="#ex-srcip-sum"></div>
<pre>
  9:00:00.000-9:05:00.000 192.0.2.2      119
  9:00:00.000-9:05:00.000 192.0.2.2       83
  9:00:00.000-9:05:00.000 192.0.2.2     1637
  9:00:00.000-9:05:00.000 192.0.2.2    11538
+ 9:00:00.000-9:05:00.000 192.0.2.2    15420
                                       -----
= 9:00:00.000-9:05:00.000 192.0.2.2    28797

  9:00:00.000-9:05:00.000 192.0.2.3      111
  9:00:00.000-9:05:00.000 192.0.2.3    16838
  9:00:00.000-9:05:00.000 192.0.2.3      119
+ 9:00:00.000-9:05:00.000 192.0.2.3     2973
                                       -----
= 9:00:00.000-9:05:00.000 192.0.2.3    20041		
      </pre>
<p id="rfc.section.8.1.p.8">Applying this to each set of Partially Aggregated Flows to produce the final Aggregated Flows shown in <a href="#ex-srcip-agg">Figure 15</a> to be exported by the template in <a href="#ex-srcip-tmpl-out">Figure 10</a>.</p>
<div id="#rfc.figure.15"></div>
<div id="#ex-srcip-agg"></div>
<pre>
9:00:00.000-9:05:00.000 192.0.2.2    28797
9:00:00.000-9:05:00.000 192.0.2.3    20041
9:00:00.000-9:05:00.000 192.0.2.4     8350
9:00:00.000-9:05:00.000 203.0.113.3  12861
9:05:00.000-9:10:00.000 192.0.2.2     1899
9:05:00.000-9:10:00.000 192.0.2.3     1284
9:05:00.000-9:10:00.000 203.0.113.3   4868
9:10:00.000-9:15:00.000 192.0.2.2     2869
9:10:00.000-9:15:00.000 192.0.2.3    20594
9:10:00.000-9:15:00.000 192.0.2.4     3587
      </pre>
<h1 id="rfc.section.8.2">
<a href="#rfc.section.8.2">8.2.</a> Core Traffic Matrix</h1>
<p id="rfc.section.8.2.p.1">Aggregating flows by source and destination autonomous system number in time series is used to generate core traffic matrices. The core traffic matrix provides a view of the state of the routes within a network, and can be used for long-term planning of changes to network design based on traffic demand. Here, imposed time intervals are generally much longer than active flow timeouts. The traffic matrix is reported in terms of octets, packets, and flows, as each of these values may have a subtly different effect on capacity planning.</p>
<p id="rfc.section.8.2.p.2">This example demonstrates key aggregation using derived keys and original flow counting. While some Original Flows may be generated by Exporting Processes on forwarding devices, and therefore contain the bgpSourceAsNumber and bgpDestinationAsNumber Information Elements, Original Flows from Exporting Processes on dedicated measurement devices will contain only a destinationIPv[46]Address. For these flows, the Mediator must look up a next hop AS from a IP to AS table, replacing source and destination addresses with AS numbers. The table used in this example is shown in <a href="#ex-asn-map">Figure 16</a>. (Note that due to limited example address space, in this example we ignore the common practice of routing only blocks of /24 or larger).</p>
<div id="#rfc.figure.16"></div>
<div id="#ex-asn-map"></div>
<pre>
prefix            ASN
192.0.2.0/25      64496
192.0.2.128/25    64497
198.51.100/24     64498
203.0.113.0/24    64499
      </pre>
<p id="rfc.section.8.2.p.3">The template for Aggregated Flows produced by this example is shown in <a href="#ex-asn-tmpl-out">Figure 17</a>.</p>
<div id="#rfc.figure.17"></div>
<div id="#ex-asn-tmpl-out"></div>
<pre>
flowStartMilliseconds(152)[8]
flowEndMilliseconds(153)[8]
bgpSourceAsNumber(16)[4]
bgpDestinationAsNumber(17)[4]
octetDeltaCount(1)[8]
      </pre>
<p id="rfc.section.8.2.p.4">Assume the goal is to get 60-minute time series of octet counts per source/destination ASN pair. The aggregation operations would then be arranged as in <a href="#ex-asn-iap">Figure 18</a>.</p>
<div id="#rfc.figure.18"></div>
<div id="#ex-asn-iap"></div>
<pre>
                 Original Flows
                       |
                       V
           +-----------------------+
           | interval distribution |
           |  * impose uniform     |
           |   3600s time interval |
           +-----------------------+ 
               |      
               | Partially Aggregated Flows
               V      
+------------------------+ 
|  key aggregation       | 
|  * reduce key to only  | 
|    sourceIPv4Address + |
|    destIPv4Address     |
+------------------------+
               |
               V
+------------------------+ 
|  key aggregation       | 
|  * replace addresses   |
|    with ASN from map   |
+------------------------+
               |      
               | Partially Aggregated Flows   
               V      
          +-------------------------+
          |  aggregate combination  |
          |   * sum octetDeltaCount |
          +-------------------------+
                       |
                       V
               Aggregated Flows
</pre>
<p id="rfc.section.8.2.p.5">After the interval distribution step, only the time intervals have changed; the Partially Aggregated flows are shown in <a href="#ex-asn-pa-int">Figure 19</a>. Note that the flows are identical to those in interval distribution step in the previous example, except the chosen interval (1 hour, 3600 seconds) is different; therefore, all the flows fit into a single interval.</p>
<div id="#rfc.figure.19"></div>
<div id="#ex-asn-pa-int"></div>
<pre>
9:00:00.000-10:00:00.000 192.0.2.2:47113   -&gt; 192.0.2.131:53   (17)   119
9:00:00.000-10:00:00.000 192.0.2.2:22153   -&gt; 192.0.2.131:53   (17)    83
9:00:00.000-10:00:00.000 192.0.2.2:52420   -&gt; 198.51.100.2:443  (6)  1637
9:00:00.000-10:00:00.000 192.0.2.3:56047   -&gt; 192.0.2.131:53   (17)   111
9:00:00.000-10:00:00.000 192.0.2.3:41183   -&gt; 198.51.100.67:80  (6) 16838
9:00:00.000-10:00:00.000 192.0.2.2:17606   -&gt; 198.51.100.68:80  (6) 11538
9:00:00.000-10:00:00.000 192.0.2.3:47113   -&gt; 192.0.2.131:53   (17)   119
9:00:00.000-10:00:00.000 192.0.2.3:48458   -&gt; 198.51.100.133:80 (6)  2973
9:00:00.000-10:00:00.000 192.0.2.4:61295   -&gt; 198.51.100.2:443  (6)  8350
9:00:00.000-10:00:00.000 203.0.113.3:41256 -&gt; 198.51.100.133:80 (6)   778
9:00:00.000-10:00:00.000 203.0.113.3:51662 -&gt; 198.51.100.3:80   (6)   883
9:00:00.000-10:00:00.000 192.0.2.2:37581   -&gt; 198.51.100.2:80   (6) 15420
9:00:00.000-10:00:00.000 203.0.113.3:52572 -&gt; 198.51.100.2:443  (6)  1637
9:00:00.000-10:00:00.000 203.0.113.3:49914 -&gt; 197.51.100.133:80 (6)   561
9:00:00.000-10:00:00.000 192.0.2.2:50824   -&gt; 198.51.100.2:443  (6)  1899
9:00:00.000-10:00:00.000 192.0.2.3:34597   -&gt; 198.51.100.3:80   (6)  1284
9:00:00.000-10:00:00.000 203.0.113.3:58907 -&gt; 198.51.100.4:80   (6)  2670
9:00:00.000-10:00:00.000 192.0.2.4:22478   -&gt; 192.0.2.131:53   (17)    75
9:00:00.000-10:00:00.000 192.0.2.4:49513   -&gt; 198.51.100.68:80  (6)  3374
9:00:00.000-10:00:00.000 192.0.2.4:64832   -&gt; 198.51.100.67:80  (6)   138
9:00:00.000-10:00:00.000 192.0.2.3:60833   -&gt; 198.51.100.69:443 (6)  2325
9:00:00.000-10:00:00.000 203.0.113.3:39586 -&gt; 198.51.100.17:80  (6) 11200
9:00:00.000-10:00:00.000 192.0.2.2:19638   -&gt; 198.51.100.3:80   (6)  2869
9:00:00.000-10:00:00.000 192.0.2.3:40429   -&gt; 198.51.100.4:80   (6) 18289
      </pre>
<p id="rfc.section.8.2.p.6">The next step is to discard irrelevant key fields, and replace the source and destination addresses with source and destination AS numbers in the map; the results of these key aggregation steps are shown in <a href="#ex-asn-pa-key">Figure 20</a>.</p>
<div id="#rfc.figure.20"></div>
<div id="#ex-asn-pa-key"></div>
<pre>
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64497    119
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64497     83
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498   1637
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64497    111
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498  16838
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498  11538
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64497    119
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498   2973
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498   8350
9:00:00.000-10:00:00.000 AS64499 -&gt; AS64498    778
9:00:00.000-10:00:00.000 AS64499 -&gt; AS64498    883
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498  15420
9:00:00.000-10:00:00.000 AS64499 -&gt; AS64498   1637
9:00:00.000-10:00:00.000 AS64499 -&gt; AS64498    561
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498   1899
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498   1284
9:00:00.000-10:00:00.000 AS64499 -&gt; AS64498   2670
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64497     75
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498   3374
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498    138
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498   2325
9:00:00.000-10:00:00.000 AS64499 -&gt; AS64498  11200
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498   2869
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498  18289
      </pre>
<p id="rfc.section.8.2.p.7">Finally, aggregate combination sums the counters per key and interval. The resulting Aggregated Flows containing the traffic matrix, shown in <a href="#ex-asn-agg">Figure 21</a>, are then exported using the template in <a href="#ex-asn-tmpl-out">Figure 17</a>. Note that these aggregated flows represent a sparse matrix: AS pairs for which no traffic was received have no corresponding record in the output.</p>
<div id="#rfc.figure.21"></div>
<div id="#ex-asn-agg"></div>
<pre>
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64497    507
9:00:00.000-10:00:00.000 AS64496 -&gt; AS64498  86934
9:00:00.000-10:00:00.000 AS64499 -&gt; AS64498  17729
      </pre>
<p id="rfc.section.8.2.p.8">The output of this operation is suitable for re-aggregation: that is, traffic matrices from single links or observarion points can be aggregated through the same interval imposition and aggregate combination steps in order to build a traffic matrix for an entire network.</p>
<h1 id="rfc.section.8.3">
<a href="#rfc.section.8.3">8.3.</a> Distinct Source Count per Destination Endpoint</h1>
<p id="rfc.section.8.3.p.1">Aggregating flows by destination address and port, and counting distinct sources aggregated away, can be used as part of passive service inventory and host characterization approaches. This example shows aggregation as an analysis technique, performed on source data stored in an IPFIX File. As the Transport Session in this File is bounded, removal of all timestamp information allows summarization of the entire time interval contained within the interval. Removal of timing information during interval imposition is equivalent to an infinitely long imposed time interval. This demonstrates both how infinite intervals work, and how unique counters work. The aggregation operations are summarized in <a href="#ex-ds-iap">Figure 22</a>.</p>
<div id="#rfc.figure.22"></div>
<div id="#ex-ds-iap"></div>
<pre>
                 Original Flows
                       |
                       V
           +-----------------------+
           | interval distribution |
           |  * discard timestamps |
           +-----------------------+ 
               |      
               | Partially Aggregated Flows
               V      
+----------------------------+ 
|  value aggregation         | 
|  * discard octetDeltaCount | 
+----------------------------+ 
               |      
               | Partially Aggregated Flows   
               V      
+----------------------------+ 
|  key aggregation           | 
|   * reduce key to only     | 
|     destIPv4Address +      |
|     destTransportPort,     |
|   * count distinct sources |
+----------------------------+ 
               |      
               | Partially Aggregated Flows   
               V      
    +----------------------------------------------+
    |  aggregate combination                       |
    |   * no-op (distinct sources already counted) |
    +----------------------------------------------+
                       |
                       V
               Aggregated Flows
</pre>
<p id="rfc.section.8.3.p.2">The template for Aggregated Flows produced by this example is shown in <a href="#ex-ds-tmpl-out">Figure 23</a>.</p>
<div id="#rfc.figure.23"></div>
<div id="#ex-ds-tmpl-out"></div>
<pre>
destinationIPv4Address(12)[4]
destinationTransportPort(11)[2]
distinctCountOfSourceIPAddress(TBD4)[8]
      </pre>
<p id="rfc.section.8.3.p.3">Interval distribution, in this case, merely discards the timestamp information from the Original Flows, and as such is not shown. Likewise, the value aggregation step simply discards the octetDeltaCount value field. The key aggregation step reduces the key to the destinationIPv4Address and destinationTransportPort, counting the distinct source addresses. Since this is essentially the output of this aggregation function, the aggregate combination operation is a no-op; the resulting Aggregated Flows are shown in <a href="#ex-ds-agg">Figure 24</a>.</p>
<div id="#rfc.figure.24"></div>
<div id="#ex-ds-agg"></div>
<pre>
destination 192.0.2.131:53      3 sources
destination 198.51.100.2:80     1 source
destination 198.51.100.2:443    3 sources
destination 198.51.100.67:80    2 sources
destination 198.51.100.68:80    2 sources
destination 198.51.100.133:80   2 sources
destination 198.51.100.3:80     3 sources
destination 198.51.100.4:80     2 sources
destination 198.51.100.17:80    1 source
destination 198.51.100.69:443   1 source
      </pre>
<h1 id="rfc.section.8.4">
<a href="#rfc.section.8.4">8.4.</a> <a href="#ex-distro" id="ex-distro">Traffic Time-Series per Source with Counter Distribution</a>
</h1>
<p id="rfc.section.8.4.p.1">Returning to the example in <a href="#ex-srcip">Section 8.1</a>, note that our source data contains some flows with durations longer than the imposed interval of five minutes. The default method for dealing with such flows is to account them to the interval containing the flow's start time.</p>
<p id="rfc.section.8.4.p.2">In this example, the same data is aggregated using the same arrangement of operations and the same output template as the as in <a href="#ex-srcip">Section 8.1</a>, but using a different counter distribution policy, Simple Uniform Distribution, as described in <a href="#sec-distro">Section 5.1.1</a>. In order to do this, the Exporting Process first exports the Aggregate Counter Distribution Options Template, as in <a href="#ex-acd-tmpl">Figure 25</a>.</p>
<div id="#rfc.figure.25"></div>
<div id="#ex-acd-tmpl"></div>
<pre>
templateId(12)[2]{scope}
valueDistribtutionMethod(TBD10)[1]
      </pre>
<p id="rfc.section.8.4.p.3">This is followed by an Aggregate Counter Distribution Record described by this Template; assuming the output template in <a href="#ex-srcip-tmpl-out">Figure 10</a> has ID 257, this would appear as in <a href="#ex-acd-rec">Figure 26</a>.</p>
<div id="#rfc.figure.26"></div>
<div id="#ex-acd-rec"></div>
<pre>
templateId 257: valueDistributionMethod 4 (Simple Uniform)
      </pre>
<p id="rfc.section.8.4.p.4">[EDITOR'S NOTE: redo these in boxdiagrams?]</p>
<p id="rfc.section.8.4.p.5">Following metadata export, the aggregation steps follow as before.  However, two long flows are distributed across multiple invervals in the interval imposition step, as indicated with "*" in <a href="#ex-acd-pa-int">Figure 27</a>. Note the uneven distribution of the three-interval, 11200-octet flow into three Partially Aggregated Flows of 3733, 3733, and 3734 octets; this ensures no cumulative error is injected by the interval distribution step.</p>
<div id="#rfc.figure.27"></div>
<div id="#ex-acd-pa-int"></div>
<pre>
  9:00:00.000-9:05:00.000 192.0.2.2:47113   -&gt; 192.0.2.131:53   (17)   119
  9:00:00.000-9:05:00.000 192.0.2.2:22153   -&gt; 192.0.2.131:53   (17)    83
  9:00:00.000-9:05:00.000 192.0.2.2:52420   -&gt; 198.51.100.2:443  (6)  1637
  9:00:00.000-9:05:00.000 192.0.2.3:56047   -&gt; 192.0.2.131:53   (17)   111
  9:00:00.000-9:05:00.000 192.0.2.3:41183   -&gt; 198.51.100.67:80  (6) 16838
  9:00:00.000-9:05:00.000 192.0.2.2:17606   -&gt; 198.51.100.68:80  (6) 11538
  9:00:00.000-9:05:00.000 192.0.2.3:47113   -&gt; 192.0.2.131:53   (17)   119
  9:00:00.000-9:05:00.000 192.0.2.3:48458   -&gt; 198.51.100.133:80 (6)  2973
  9:00:00.000-9:05:00.000 192.0.2.4:61295   -&gt; 198.51.100.2:443  (6)  8350
  9:00:00.000-9:05:00.000 203.0.113.3:41256 -&gt; 198.51.100.133:80 (6)   778
  9:00:00.000-9:05:00.000 203.0.113.3:51662 -&gt; 198.51.100.3:80   (6)   883
* 9:00:00.000-9:05:00.000 192.0.2.2:37581   -&gt; 198.51.100.2:80   (6)  7710
* 9:00:00.000-9:05:00.000 203.0.113.3:39586 -&gt; 198.51.100.17:80  (6)  3733 
  9:05:00.000-9:10:00.000 203.0.113.3:52572 -&gt; 198.51.100.2:443  (6)  1637
  9:05:00.000-9:10:00.000 203.0.113.3:49914 -&gt; 197.51.100.133:80 (6)   561
  9:05:00.000-9:10:00.000 192.0.2.2:50824   -&gt; 198.51.100.2:443  (6)  1899
  9:05:00.000-9:10:00.000 192.0.2.3:34597   -&gt; 198.51.100.3:80   (6)  1284
  9:05:00.000-9:10:00.000 203.0.113.3:58907 -&gt; 198.51.100.4:80   (6)  2670
* 9:05:00.000-9:10:00.000 192.0.2.2:37581   -&gt; 198.51.100.2:80   (6)  7710 
* 9:05:00.000-9:10:00.000 203.0.113.3:39586 -&gt; 198.51.100.17:80  (6)  3733
  9:10:00.000-9:15:00.000 192.0.2.4:22478   -&gt; 192.0.2.131:53   (17)    75
  9:10:00.000-9:15:00.000 192.0.2.4:49513   -&gt; 198.51.100.68:80  (6)  3374
  9:10:00.000-9:15:00.000 192.0.2.4:64832   -&gt; 198.51.100.67:80  (6)   138
  9:10:00.000-9:15:00.000 192.0.2.3:60833   -&gt; 198.51.100.69:443 (6)  2325
* 9:10:00.000-9:15:00.000 203.0.113.3:39586 -&gt; 198.51.100.17:80  (6)  3734
  9:10:00.000-9:15:00.000 192.0.2.2:19638   -&gt; 198.51.100.3:80   (6)  2869
  9:10:00.000-9:15:00.000 192.0.2.3:40429   -&gt; 198.51.100.4:80   (6) 18289
      </pre>
<p id="rfc.section.8.4.p.6">Subsequent steps are as in <a href="#ex-srcip">Section 8.1</a>; the results, to be exported using <a href="#ex-srcip-tmpl-out">Figure 10</a>, are shown in <a href="#ex-acd-agg">Figure 28</a>, with Aggregated Flows differing from the previous example indicated by "*".</p>
<div id="#rfc.figure.28"></div>
<div id="#ex-acd-agg"></div>
<pre>
* 9:00:00.000-9:05:00.000 192.0.2.2    21087
  9:00:00.000-9:05:00.000 192.0.2.3    20041
  9:00:00.000-9:05:00.000 192.0.2.4     8350
* 9:00:00.000-9:05:00.000 203.0.113.3   9394
* 9:05:00.000-9:10:00.000 192.0.2.2     9609
  9:05:00.000-9:10:00.000 192.0.2.3     1284
* 9:05:00.000-9:10:00.000 203.0.113.3   8601
  9:10:00.000-9:15:00.000 192.0.2.2     2869
  9:10:00.000-9:15:00.000 192.0.2.3    20594
  9:10:00.000-9:15:00.000 192.0.2.4     3587
* 9:10:00.000-9:15:00.000 203.0.113.3   3734
      </pre>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> Security Considerations</h1>
<p id="rfc.section.9.p.1">This document specifies the operation of an Intermediate Aggregation Process with the IPFIX Protocol; the Security Considerations for the protocol itself in Section 11 of <a href="#RFC5101">[RFC5101]</a> therefore apply. In the common case that aggregation is performed on a Mediator, the Security Considerations for Mediators in Section 9 of <a href="#RFC6183">[RFC6183]</a> apply as well.</p>
<p id="rfc.section.9.p.2">As mentioned in <a href="#sec-usecase">Section 3</a>, certain aggregation operations may tend to have an anyonymizing effect on flow data by obliterating sensitive identifiers. Aggregation may also be combined with anonymization within a Mediator, or as part of a chain of Mediators, to further leverage this effect. In any case in which an Intermediate Aggregation Process is applied as part of a data anonymization or protection scheme, or is used together with anonymization as described in <a href="#RFC6235">[RFC6235]</a>, the Security Considerations in Section 9 of <a href="#RFC6235">[RFC6235]</a> apply.</p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> IANA Considerations</h1>
<p id="rfc.section.10.p.1">This document specifies the creation of new IPFIX Information Elements in the IPFIX Information Element registry located at http://www.iana.org/assignments/ipfix, as defined in <a href="#sec-export">Section 7</a> above. IANA has assigned Information Element numbers to these Information Elements, and entered them into the registry.</p>
<p id="rfc.section.10.p.2">[NOTE for IANA: The text TBDn should be replaced with the respective assigned Information Element numbers where they appear in this document. Note that the deltaFlowCount Information Element has been assigned the number 3, as it is compatible with the corresponding existing (reserved) NetFlow v9 Information Element. Other Information Element numbers should be assigned outside the NetFlow V9 compatibility range, as these Information Elements are not supported by NetFlow V9.]</p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> Acknowledgments</h1>
<p id="rfc.section.11.p.1">Special thanks to Elisa Boschi for early work on the concepts laid out in this document. Thanks to Lothar Braun and Christian Henke for their reviews. This work is materially supported by the European Union Seventh Framework Programme under grant agreement 257315 (DEMONS).</p>
<h1 id="rfc.references">
<a href="#rfc.references">12.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">12.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC5101">[RFC5101]</b></td>
<td class="top">
<a>Claise, B.</a>, "<a href="http://tools.ietf.org/html/rfc5101">Specification of the IP Flow Information Export (IPFIX) Protocol for the Exchange of IP Traffic Flow Information</a>", RFC 5101, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5102">[RFC5102]</b></td>
<td class="top">
<a>Quittek, J.</a>, <a>Bryant, S.</a>, <a>Claise, B.</a>, <a>Aitken, P.</a> and <a>J. Meyer</a>, "<a href="http://tools.ietf.org/html/rfc5102">Information Model for IP Flow Information Export</a>", RFC 5102, January 2008.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">12.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3917">[RFC3917]</b></td>
<td class="top">
<a>Quittek, J.</a>, <a>Zseby, T.</a>, <a>Claise, B.</a> and <a>S. Zander</a>, "<a href="http://tools.ietf.org/html/rfc3917">Requirements for IP Flow Information Export (IPFIX)</a>", RFC 3917, October 2004.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5103">[RFC5103]</b></td>
<td class="top">
<a>Trammell, B.</a> and <a>E. Boschi</a>, "<a href="http://tools.ietf.org/html/rfc5103">Bidirectional Flow Export Using IP Flow Information Export (IPFIX)</a>", RFC 5103, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5153">[RFC5153]</b></td>
<td class="top">
<a>Boschi, E.</a>, <a>Mark, L.</a>, <a>Quittek, J.</a>, <a>Stiemerling, M.</a> and <a>P. Aitken</a>, "<a href="http://tools.ietf.org/html/rfc5153">IP Flow Information Export (IPFIX) Implementation Guidelines</a>", RFC 5153, April 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5470">[RFC5470]</b></td>
<td class="top">
<a>Sadasivan, G.</a>, <a>Brownlee, N.</a>, <a>Claise, B.</a> and <a>J. Quittek</a>, "<a href="http://tools.ietf.org/html/rfc5470">Architecture for IP Flow Information Export</a>", RFC 5470, March 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5472">[RFC5472]</b></td>
<td class="top">
<a>Zseby, T.</a>, <a>Boschi, E.</a>, <a>Brownlee, N.</a> and <a>B. Claise</a>, "<a href="http://tools.ietf.org/html/rfc5472">IP Flow Information Export (IPFIX) Applicability</a>", RFC 5472, March 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5476">[RFC5476]</b></td>
<td class="top">
<a>Claise, B.</a>, <a>Johnson, A.</a> and <a>J. Quittek</a>, "<a href="http://tools.ietf.org/html/rfc5476">Packet Sampling (PSAMP) Protocol Specifications</a>", RFC 5476, March 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5610">[RFC5610]</b></td>
<td class="top">
<a>Boschi, E.</a>, <a>Trammell, B.</a>, <a>Mark, L.</a> and <a>T. Zseby</a>, "<a href="http://tools.ietf.org/html/rfc5610">Exporting Type Information for IP Flow Information Export (IPFIX) Information Elements</a>", RFC 5610, July 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5655">[RFC5655]</b></td>
<td class="top">
<a>Trammell, B.</a>, <a>Boschi, E.</a>, <a>Mark, L.</a>, <a>Zseby, T.</a> and <a>A. Wagner</a>, "<a href="http://tools.ietf.org/html/rfc5655">Specification of the IP Flow Information Export (IPFIX) File Format</a>", RFC 5655, October 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5835">[RFC5835]</b></td>
<td class="top">
<a>Morton, A.</a> and <a>S. Van den Berghe</a>, "<a href="http://tools.ietf.org/html/rfc5835">Framework for Metric Composition</a>", RFC 5835, April 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5982">[RFC5982]</b></td>
<td class="top">
<a>Kobayashi, A.</a> and <a>B. Claise</a>, "<a href="http://tools.ietf.org/html/rfc5982">IP Flow Information Export (IPFIX) Mediation: Problem Statement</a>", RFC 5982, August 2010.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6183">[RFC6183]</b></td>
<td class="top">
<a>Kobayashi, A.</a>, <a>Claise, B.</a>, <a>Muenz, G.</a> and <a>K. Ishibashi</a>, "<a href="http://tools.ietf.org/html/rfc6183">IP Flow Information Export (IPFIX) Mediation: Framework</a>", RFC 6183, April 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6235">[RFC6235]</b></td>
<td class="top">
<a>Boschi, E.</a> and <a>B. Trammell</a>, "<a href="http://tools.ietf.org/html/rfc6235">IP Flow Anonymization Support</a>", RFC 6235, May 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.claise-ipfix-mediation-protocol">[I-D.claise-ipfix-mediation-protocol]</b></td>
<td class="top">
<a>Claise, B</a>, <a>Kobayashi, A</a> and <a>B Trammell</a>, "<a href="http://tools.ietf.org/html/draft-claise-ipfix-mediation-protocol-04">Specification of the Protocol for IPFIX Mediations</a>", Internet-Draft draft-claise-ipfix-mediation-protocol-04, July 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.trammell-ipfix-ie-doctors">[I-D.trammell-ipfix-ie-doctors]</b></td>
<td class="top">
<a>Trammell, B</a> and <a>B Claise</a>, "<a href="http://tools.ietf.org/html/draft-trammell-ipfix-ie-doctors-03">Guidelines for Authors and Reviewers of IPFIX Information Elements</a>", Internet-Draft draft-trammell-ipfix-ie-doctors-03, October 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-ipfix-configuration-model">[I-D.ietf-ipfix-configuration-model]</b></td>
<td class="top">
<a>Muenz, G</a>, <a>Claise, B</a> and <a>P Aitken</a>, "<a href="http://tools.ietf.org/html/draft-ietf-ipfix-configuration-model-10">Configuration Data Model for IPFIX and PSAMP</a>", Internet-Draft draft-ietf-ipfix-configuration-model-10, July 2011.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-ipfix-flow-selection-tech">[I-D.ietf-ipfix-flow-selection-tech]</b></td>
<td class="top">
<a>D'Antonio, S</a>, <a>Zseby, T</a>, <a>Henke, C</a> and <a>L Peluso</a>, "<a href="http://tools.ietf.org/html/draft-ietf-ipfix-flow-selection-tech-09">Flow Selection Techniques</a>", Internet-Draft draft-ietf-ipfix-flow-selection-tech-09, November 2011.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Brian Trammell</span> 
	  <span class="n hidden">
		<span class="family-name">Trammell</span>
	  </span>
	</span>
	<span class="org vcardline">Swiss Federal Institute of Technology Zurich </span>
	<span class="adr">
	  <span>Gloriastrasse 35</span>

	  <span class="vcardline">
		<span class="locality">8092 Zurich</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Switzerland</span>
	</span>
	<span class="vcardline">Phone: +41 44 632 70 13</span>

<span class="vcardline">EMail: <a href="mailto:trammell@tik.ee.ethz.ch">trammell@tik.ee.ethz.ch</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Arno Wagner</span> 
	  <span class="n hidden">
		<span class="family-name">Wagner</span>
	  </span>
	</span>
	<span class="org vcardline">Consecom AG </span>
	<span class="adr">
	  <span>Bleicherweg 64a</span>

	  <span class="vcardline">
		<span class="locality">8002 Zurich</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Switzerland</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:arno@wagner.name">arno@wagner.name</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Benoit Claise</span> 
	  <span class="n hidden">
		<span class="family-name">Claise</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.  </span>
	<span class="adr">
	  <span>De Kleetlaan 6a b1</span>

	  <span class="vcardline">
		<span class="locality">1831 Diagem</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Belgium</span>
	</span>
	<span class="vcardline">Phone: +32 2 704 5622</span>

<span class="vcardline">EMail: <a href="mailto:bclaise@cisco.com">bclaise@cisco.com</a></span>

  </address>
</div>

</body>
</html>