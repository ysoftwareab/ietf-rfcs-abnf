<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Extensible XDR Discriminated Union Primitive Type</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Use Case">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Abbreviations">
<link href="#rfc.section.2" rel="Chapter" title="2 Conventions">
<link href="#rfc.section.3" rel="Chapter" title="3 Extensible Discriminated Union">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Extensible Union Type">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 RPC-L Changes">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Encoding">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Decoding">
<link href="#rfc.section.3.4.1" rel="Chapter" title="3.4.1 Error Handling">
<link href="#rfc.section.4" rel="Chapter" title="4 Acknowledgements">
<link href="#rfc.section.5" rel="Chapter" title="5 IANA Considerations">
<link href="#rfc.section.6" rel="Chapter" title="6 AFS Assign Numbers Registrar Considerations">
<link href="#rfc.section.7" rel="Chapter" title="7 Security Considerations">
<link href="#rfc.references" rel="Chapter" title="8 References">
<link href="#rfc.references.1" rel="Chapter" title="8.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="8.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="AFS-3 relies upon XDR to carry Rx RPC call payloads.  XDR discriminated unions are ill-suited to cases where the protocol needs to evolve without inventing new RPCs, i.e., unknown discriminant values cause the entire XDR payload to fail the decoding step.  While this can be circumvented through the use of opaque payloads (and recursive XDR invocations), such solutions are inelegant and difficult to implement.  This memo defines a new XDR primitive type, "ext-union", which is derived from the XDR discriminated union primitive type, but with two key variations: 1) each leg contains a length field, and 2) no default leg is supported.  " />
  <meta name="description" content="AFS-3 relies upon XDR to carry Rx RPC call payloads.  XDR discriminated unions are ill-suited to cases where the protocol needs to evolve without inventing new RPCs, i.e., unknown discriminant values cause the entire XDR payload to fail the decoding step.  While this can be circumvented through the use of opaque payloads (and recursive XDR invocations), such solutions are inelegant and difficult to implement.  This memo defines a new XDR primitive type, "ext-union", which is derived from the XDR discriminated union primitive type, but with two key variations: 1) each leg contains a length field, and 2) no default leg is supported.  " />
  <meta name="keywords" content="xdr, afs, afs3, afs-3" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">T.E. Keiser</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Sine Nomine</td>
</tr>
<tr>
<td class="left">Intended status: Informational</td>
<td class="right">June 02, 2011</td>
</tr>
<tr>
<td class="left">Expires: December 04, 2011</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Extensible XDR Discriminated Union Primitive Type<br />
  <span class="filename">draft-keiser-afs3-xdr-union-02</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>AFS-3 relies upon XDR to carry Rx RPC call payloads.  XDR discriminated unions are ill-suited to cases where the protocol needs to evolve without inventing new RPCs, i.e., unknown discriminant values cause the entire XDR payload to fail the decoding step.  While this can be circumvented through the use of opaque payloads (and recursive XDR invocations), such solutions are inelegant and difficult to implement.  This memo defines a new XDR primitive type, "ext-union", which is derived from the XDR discriminated union primitive type, but with two key variations: 1) each leg contains a length field, and 2) no default leg is supported.  </p>
<h1><a>Internet Draft Comments</a></h1>
<p>Comments regarding this draft are solicited.  Please include the AFS-3 protocol standardization mailing list (afs3-standardization@openafs.org) as a recipient of any comments.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on December 04, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Use Case</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">Abbreviations</a>
</li>
<li>2.   <a href="#rfc.section.2">Conventions</a>
</li>
<li>3.   <a href="#rfc.section.3">Extensible Discriminated Union</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Extensible Union Type</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">RPC-L Changes</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Encoding</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Decoding</a>
</li>
<li>3.4.1.   <a href="#rfc.section.3.4.1">Error Handling</a>
</li>
<li>4.   <a href="#rfc.section.4">Acknowledgements</a>
</li>
<li>5.   <a href="#rfc.section.5">IANA Considerations</a>
</li>
<li>6.   <a href="#rfc.section.6">AFS Assign Numbers Registrar Considerations</a>
</li>
<li>7.   <a href="#rfc.section.7">Security Considerations</a>
</li>
<li>8.   <a href="#rfc.references">References</a>
</li>
<li>8.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>8.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">AFS-3 <a href="#AFS1">[AFS1]</a> <a href="#AFS2">[AFS2]</a> is a distributed file system that has its origins in the VICE project <a href="#CMU-ITC-84-020">[CMU-ITC-84-020]</a> <a href="#VICE1">[VICE1]</a> at the Carnegie Mellon University Information Technology Center <a href="#CMU-ITC-83-025">[CMU-ITC-83-025]</a>, a joint venture between CMU and IBM.  VICE later became AFS when CMU moved development to a new commercial venture called Transarc Corporation, which later became IBM Pittsburgh Labs.  AFS-3 is a suite of un-standardized network protocols based on a remote procedure call (RPC) suite known as Rx <a href="#AFS3-RX">[AFS3-RX]</a>.  While de jure standards for AFS-3 fail to exist, the various AFS-3 implementations have agreed upon certain de facto standards, largely helped by the existence of an open source fork called OpenAFS that has served the role of reference implementation.  In addition to using OpenAFS as a reference, IBM wrote and donated developer documentation that contains somewhat outdated specifications for the Rx protocol and all AFS-3 remote procedure calls, as well as a detailed description of the AFS-3 system architecture.  </p>
<p id="rfc.section.1.p.2">The Rx RPC protocol utilizes XDR <a href="#RFC4506">[RFC4506]</a> as its means of encoding RPC call and response payloads.  XDR provides a discriminated union type.  However, the semantics of the discriminated union base type do not lend themselves to evolution of the discriminant namespace: introduction of new discriminants--when there is no default leg--cause the remainder of the XDR octet stream to be un-parseable (due to the lack of a length field in the encoding) by older peers.  This memo introduces a new XDR primitive type that is identical to the XDR discriminated union, except that: 1) each leg contains a length field, and 2) the default leg is disallowed.  </p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> Use Case</h1>
<p id="rfc.section.1.1.p.1">Given that this design doubles the overhead from 4 to 8 octets (relative to the XDR discriminated union primitive type), it is ill-suited for use with small implied legs.  Within the AFS-3 protocol suite, the primary use case for the extensible union type is to wrap large data structures, rather than small primitive types.  </p>
<h1 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> Abbreviations</h1>
<p></p>

<dl>
<dt>AFS    -</dt>
<dd style="margin-left: 8">Historically, AFS stood for the Andrew File System; AFS no longer stands for anything</dd>
<dt>RPC    -</dt>
<dd style="margin-left: 8">Remote Procedure Call</dd>
<dt>Rx     -</dt>
<dd style="margin-left: 8">The Remote Procedure Call mechanism utilized by AFS-3</dd>
<dt>XDR    -</dt>
<dd style="margin-left: 8">eXternal Data Representation</dd>
</dl>

<p> </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Conventions</h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">RFC 2119</a> <cite title="NONE">[RFC2119]</cite>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> Extensible Discriminated Union</h1>
<p id="rfc.section.3.p.1">The extensible discriminated union will contain a length field in every leg so that decoding peers can compute the offset of the next object in the XDR octet stream, regardless of whether the discriminant is recognized.  For small legs, this will result in significant encoding inefficiency, but it is necessary to permit the union to evolve over time (without peers failing to decode the entire XDR octet stream).  </p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#ext-union" id="ext-union">Extensible Union Type</a>
</h1>
<p id="rfc.section.3.1.p.1">The definition of the extensible discriminated union is derived from the XDR union defined in section 4.15 of the XDR specification <a href="#RFC4506">[RFC4506]</a>.  Unlike XDR discriminated unions, the XDR types mapped to each arm of the union need not be defined a priori.  Instead, the length of the arm is always included in the wire encoding along with the discriminant value, thus permitting the decoder to continue decoding past an unknown discriminant in an XDR octet stream.  </p>
<p id="rfc.section.3.1.p.2">How undefined discriminants are handled by the decoder is deliberately left unspecified by this document.  Rather, this memo merely specifies which error conditions must be flagged to the caller (see <a href="#sec-dec-err">Section 3.4.1</a>).  The error handling semantics--for both length mismatches and unknown discriminants--are left up to the definition of any type built upon the ext-union primitive type.  While this lends significant flexibility to the design, it also permits XDR decoding to continue when the expected implied arm length doesn't match the length on the wire.  It is RECOMMENDED that implementations fail to decode the entire XDR stream when such a length mismatch is encountered, as such a length mismatch is indicative of either: 1) a significant divergence in RPC-L definitions across the peers, or 2) an undetected bit error in the XDR octet stream.  </p>
<p id="rfc.section.3.1.p.3">Extensible discriminated unions are defined in RPC-L as follows: </p>
<div id="#rfc.figure.1"></div>
<div id="#ext-union-rpc-l"></div>
<pre>
    ext-union switch (discriminant-definition) {
    case discriminant-value-A:
       arm-declaration-A;
    case discriminant-value-B:
       arm-declaration-B;
    ...
    } identifier;
          </pre>
<p id="rfc.section.3.1.p.4">Because the discriminant namespace of an extensible union must be capable of evolving over time, it is not possible to support a default leg.  </p>
<p id="rfc.section.3.1.p.5">The extensible discriminated union is encoded on the wire as: a 4-octet discriminant, followed by a 4-octet arm length, and finally the variable-length implied arm.  The arm length field SHALL count the length of the implied arm in octets, and only the implied arm.  In other words, the 8 octets occupied by the discriminant and arm length fields SHALL NOT be counted as part of the arm length value.  </p>
<div id="#rfc.figure.2"></div>
<div id="#ext-union-octets"></div>
<pre>
  0   1   2   3
+---+---+---+---+---+---+---+---+---+---+---+---+
|  discriminant |   arm length  |  implied arm  |
+---+---+---+---+---+---+---+---+---+---+---+---+
|&lt;---4 octets--&gt;|&lt;---4 octets--&gt;|
          </pre>
<p id="rfc.section.3.1.p.6">Thus, in terms of existing XDR primitives, we can describe an extensible discriminated union as follows: </p>
<div id="#rfc.figure.3"></div>
<div id="#ext-union-xdr"></div>
<pre>
    struct ext_union {
        unsigned int discriminant;
        opaque implied_leg&lt;&gt;;
    };
          </pre>
<p id="rfc.section.3.1.p.7">It should be noted that this design makes it convenient to implement extensible discriminated unions on top of existing XDR primitive types.  </p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> RPC-L Changes</h1>
<p id="rfc.section.3.2.p.1">In order to implement the above, the XDR grammar, as specified in Section 6.3 of <a href="#RFC4506">[RFC4506]</a>, will need to be modified in the following ways: </p>
<p></p>

<ul>
<li>"type-specifier" will require a new production rule mapping to "ext-union-type-spec", and </li>
<li>an "ext-union-type-spec" production rule will need to be defined.  </li>
</ul>

<p> </p>
<p id="rfc.section.3.2.p.3">The "type-specifier" grammar will now include a new production rule for "ext-union-type-spec": </p>
<div id="#rfc.figure.4"></div>
<div id="#type-specifier-production-rule"></div>
<pre>
    type-specifier:
         [ "unsigned" ] "int"
       | [ "unsigned" ] "hyper"
       | "float"
       | "double"
       | "quadruple"
       | "bool"
       | enum-type-spec
       | struct-type-spec
       | union-type-spec
       | identifier
       | ext-union-type-spec
          </pre>
<p id="rfc.section.3.2.p.4">The new "ext-union-type-spec" production rule, and the production rule for its nonterminal symbol dependency "ext-union-body", are defined as follows: </p>
<div id="#rfc.figure.5"></div>
<div id="#ext-union-production-rule"></div>
<pre>
    ext-union-type-spec:
       "ext-union" ext-union-body

    ext-union-body:
       "switch" "(" declaration ")" "{"
          case-spec
          case-spec *
       "}"
          </pre>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> Encoding</h1>
<p id="rfc.section.3.3.p.1">It is RECOMMENDED that encoding of an AFS-3 extensible union proceed using the following algorithm: </p>
<p></p>

<ol>
<li>encode an XDR unsigned 32-bit integer (see Section 4.2 of <a href="#RFC4506">[RFC4506]</a>) containing the discrimant, </li>
<li>XDR encode into temporary storage the implied leg (according to the type definition of the type specified for this discriminant value in the ext-union definition), and </li>
<li>encode the implied leg using the XDR variable-length opaque specification (see Section 4.10 of <a href="#RFC4506">[RFC4506]</a>).  </li>
</ol>

<p> </p>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> Decoding</h1>
<p id="rfc.section.3.4.p.1">It is RECOMMENDED that decoding of an AFS-3 extensible union proceed using the following algorithm: </p>
<p></p>

<ol>
<li>XDR decode the 32-bit unsigned integer containing the discriminant; </li>
<li>XDR decode the variable-length opaque blob into temporary storage; </li>
<li>If this is a known discriminant: <ol>
<li>Lookup the discriminant, and compare the expected length with the length of the previously-decoded XDR variable-length opaque; </li>
<li>If the expected and actual lengths match: <ol><li>The implied leg's payload should be XDR decoded (according to the type definition of the type specified for this discriminant value in the ext-union definition); </li></ol>
<p> </p>
</li>
<li>If the expected and actual lengths do not match: <ol><li>Mark the union as failed to decode due to a length mismatch; </li></ol>
<p> </p>
</li>
</ol>
<p> </p>
</li>
<li>However, if this is an unknown discriminant: <ol><li>Mark the union as failed to decode due to an unknown discriminant; </li></ol>
<p> </p>
</li>
<li>XDR decoding continues at the current offset plus the length of the previously-decoded XDR variable-length opaque.  </li>
</ol>

<p> </p>
<h1 id="rfc.section.3.4.1">
<a href="#rfc.section.3.4.1">3.4.1.</a> <a href="#sec-dec-err" id="sec-dec-err">Error Handling</a>
</h1>
<p id="rfc.section.3.4.1.p.1">While the specific decoding algorithm used is left up to the implementor, error handling MUST be implemented as described in this section.  </p>

<dl>
<dt>Unknown Discriminant:</dt>
<dd style="margin-left: 4">
<br><br> When a decoder encounters an unknown discriminant, it MUST mark the discriminant as unknown, and SHOULD proceed to decoding the next element in the XDR stream by seeking past the length and implied leg fields.  </dd>
<dt>Unexpected Length for Discriminant:</dt>
<dd style="margin-left: 4">
<br><br> When a decoder encounters a length field that doesn't agree with the length expected for this discriminant, it MUST mark the discriminant as failed to decode due to a length mismatch, and SHOULD fail to decode the rest of the XDR octet stream.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#Acknowledgements" id="Acknowledgements">Acknowledgements</a>
</h1>
<p id="rfc.section.4.p.1">The author would like to thank Jeffrey Hutzelman for proposing standardization of a new XDR primitive type; and Andrew Deason, Simon Wilkinson, Derrick Brashear, and Matt Benjamin for helping to refine the design of this extensible union type.  Finally, the author would like to thank the attendees of the 2011 Pittsburgh AFS Hackathon for their review and comments regarding the -01 draft.  </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> IANA Considerations</h1>
<p id="rfc.section.5.p.1">This memo includes no request to IANA.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> AFS Assign Numbers Registrar Considerations</h1>
<p id="rfc.section.6.p.1">This memo includes no request to the AFS Assigned Numbers Registrar.  </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#Security" id="Security">Security Considerations</a>
</h1>
<p id="rfc.section.7.p.1">Users of this extensible type should understand that any Rx XDR payload is only as secure as the security class bound to the Rx connection in question.  This document merely standardizes a primitive type; it is up to the authors of standards defining new types (upon the "ext-union" primitive type) to ensure that the contents of their types are only marshalled over sufficiently-secure security classes.  </p>
<p id="rfc.section.7.p.2">Decoders should take special care when encountering unexpected implied arm lengths.  This could be indicative of serious errors, such as octet stream bit errors that were undetected by lower-layer checksums.  At the very least, this error condition implies that the peers do not agree upon their ext-union type-to-discriminant mappings.  It is RECOMMENDED that decoders treat this as a hard error and fail to decode the remainder of the XDR octet stream.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">8.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">8.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4506">[RFC4506]</b></td>
<td class="top">
<a>Eisler, M.</a>, "<a href="http://tools.ietf.org/html/rfc4506">XDR: External Data Representation Standard</a>", STD 67, RFC 4506, May 2006.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">8.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="CMU-ITC-84-020">[CMU-ITC-84-020]</b></td>
<td class="top">
<a title="Carnegie Mellon University Information Technology Center">West, M.J.</a>, "<a>VICE File System Services</a>", CMU ITC Tech. Rep. CMU-ITC-84-020, August 1984.</td>
</tr>
<tr>
<td class="reference"><b id="CMU-ITC-83-025">[CMU-ITC-83-025]</b></td>
<td class="top">
<a title="Carnegie Mellon University">Morris, J.H.</a>, <a title="Carnegie Mellon University">Van Houweling, D.</a> and <a title="International Business Machines Corporation">K. Slack</a>, "<a>The Information Technology Center</a>", CMU ITC Tech. Rep. CMU-ITC-83-025, 1983.</td>
</tr>
<tr>
<td class="reference"><b id="AFS3-RX">[AFS3-RX]</b></td>
<td class="top">
<a title="Transarc Corporation">Zayas, E.R.</a>, "<a>AFS-3 Programmer's Reference: Specification for the Rx Remote Procedure Call Facility</a>", Transarc Corp. Tech. Rep. FS-00-D164, August 1991.</td>
</tr>
<tr>
<td class="reference"><b id="VICE1">[VICE1]</b></td>
<td class="top">
<a title="Carnegie Mellon University Information Technology Center">Satyanarayanan, M.</a>, <a title="Carnegie Mellon University Information Technology Center">Howard, J.H.</a>, <a title="Carnegie Mellon University Information Technology Center">Nichols, D.A.</a>, <a title="Carnegie Mellon University Information Technology Center">Sidebotham, R.N.</a>, <a title="Carnegie Mellon University Information Technology Center">Spector, A.Z.</a> and <a title="Carnegie Mellon University Information Technology Center">M.J. West</a>, "<a>The ITC Distributed File System: Principles and Design</a>", Proc. 10th ACM Symp. Operating Sys. Princ. Vol. 19, No. 5, December 1985.</td>
</tr>
<tr>
<td class="reference"><b id="AFS1">[AFS1]</b></td>
<td class="top">
<a title="Carnegie Mellon University Information Technology Center">Howard, J.H.</a>, "<a>An Overview of the Andrew File System"</a>", Proc. 1988 USENIX Winter Tech. Conf. pp. 23-26, February 1988.</td>
</tr>
<tr>
<td class="reference"><b id="AFS2">[AFS2]</b></td>
<td class="top">
<a title="Carnegie Mellon University">Howard, J.H.</a>, <a title="Carnegie Mellon University">Kazar, M.L.</a>, <a title="Carnegie Mellon University">Menees, S.G.</a>, <a title="Carnegie Mellon University">Nichols, D.A.</a>, <a title="Carnegie Mellon University">Satyanarayanan, M.</a>, <a title="Carnegie Mellon University">Sidebotham, R.N.</a> and <a title="Carnegie Mellon University">M.J. West</a>, "<a>Scale and Performance in a Distributed File System</a>", ACM Trans. Comp. Sys. Vol. 6, No. 1, pp. 51-81, February 1988.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Thomas Keiser</span> 
	  <span class="n hidden">
		<span class="family-name">Keiser</span>
	  </span>
	</span>
	<span class="org vcardline">Sine Nomine Associates</span>
	<span class="adr">
	  <span>43596 Blacksmith Square</span>

	  <span class="vcardline">
		<span class="locality">Ashburn</span>,  
		<span class="region">VA</span> 
		<span class="code">20147</span>
	  </span>
	  <span class="country-name vcardline">USA</span>
	</span>
	<span class="vcardline">Phone: +1 703 723 6673</span>

<span class="vcardline">EMail: <a href="mailto:tkeiser@sinenomine.net">tkeiser@sinenomine.net</a></span>

  </address>
</div>

</body>
</html>