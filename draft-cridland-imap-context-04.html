<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Contexts for IMAP4</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Contexts for IMAP4">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Network Working Group</td><td class="header">D. Cridland</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">C. King</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">Isode Limited</td></tr>
<tr><td class="header">Expires: October 13, 2008</td><td class="header">April 11, 2008</td></tr>
</table></td></tr></table>
<h1><br />Contexts for IMAP4<br />draft-cridland-imap-context-04</h1>

<h3>Status of this Memo</h3>
<p>
By submitting this Internet-Draft,
each author represents that any applicable patent or other IPR claims of which
he or she is aware have been or will be disclosed,
and any of which he or she becomes aware will be disclosed,
in accordance with Section&nbsp;6 of BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on October 13, 2008.</p>

<h3>Abstract</h3>

<p>The IMAP4rev1 protocol has powerful search facilities as part of the core protocol, but lacks the ability to create live, updated results which can be easily handled. This memo provides such an extension, and shows how it can be used to provide a facility similar to virtual mailboxes.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Conventions used in this document<br />
<a href="#anchor2">2.</a>&nbsp;
Introduction<br />
<a href="#esort">3.</a>&nbsp;
Extended Sort Syntax<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#esort-ext">3.1.</a>&nbsp;
ESORT extension<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#esort-ranges">3.2.</a>&nbsp;
Ranges in Extended Sort results<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">3.3.</a>&nbsp;
Extended SORT example<br />
<a href="#proto">4.</a>&nbsp;
Contexts<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">4.1.</a>&nbsp;
Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#proto-context">4.2.</a>&nbsp;
Context Hint<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#proto-notify">4.3.</a>&nbsp;
Notifications of changes<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#refuse-update">4.3.1.</a>&nbsp;
Refusing to update contexts<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#update-common">4.3.2.</a>&nbsp;
Common Features of ADDTO and REMOVEFROM<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">4.3.3.</a>&nbsp;
ADDTO Return Data Item<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">4.3.4.</a>&nbsp;
REMOVEFROM Return Data Item<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#cancelupdate">4.3.5.</a>&nbsp;
The CANCELUPDATE command<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#proto-partial">4.4.</a>&nbsp;
Partial results<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor7">4.5.</a>&nbsp;
Caching results<br />
<a href="#anchor8">5.</a>&nbsp;
Formal Syntax<br />
<a href="#anchor9">6.</a>&nbsp;
Security Considerations<br />
<a href="#anchor10">7.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor11">8.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">9.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">9.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">9.2.</a>&nbsp;
Informative References<br />
<a href="#anchor14">Appendix&nbsp;A.</a>&nbsp;
Cookbook<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">A.1.</a>&nbsp;
Virtual Mailboxes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">A.2.</a>&nbsp;
Trash Mailboxes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">A.3.</a>&nbsp;
Immediate EXPUNGE notifications<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">A.4.</a>&nbsp;
Monitoring counts<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">A.5.</a>&nbsp;
Resynchronizing Contexts<br />
<a href="#implementation">Appendix&nbsp;B.</a>&nbsp;
Server Implementation Notes<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
<a href="#rfc.copyright">&#167;</a>&nbsp;
Intellectual Property and Copyright Statements<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Conventions used in this document</h3>

<p>In examples, "C:" and "S:" indicate lines sent by the client
   messaging user agent and IMAP4rev1 (<a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a>) server
   respectively. "//" indicates inline comments not part of the protocol
   exchange. Line breaks are liberally inserted for clarity. Examples are
   intended to be read in order, such that the state remains from one example
   to the next.
</p>
<p>Although the examples show a server which supports <a class='info' href='#ESEARCH'>[ESEARCH]<span> (</span><span class='info'>Melnikov, A. and D. Cridland, &ldquo;IMAP4 Extension to SEARCH Command for Controlling What Kind of Information Is Returned,&rdquo; November&nbsp;2006.</span><span>)</span></a>, this is not a strict requirement of this specification.
</p>
<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <a class='info' href='#KEYWORDS'>[KEYWORDS]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
</p>
<p>Other capitalised words are typically names of IMAP extensions or commands - these are uppercased for clarity only, and are case-insensitive.
</p>
<p>[[ Editorial comments are like this. XML2RFC working source is held at http://svn.dave.cridland.net/svn/ietf-drafts/draft-cridland-imap-context.xml ]]
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Introduction</h3>

<p>Although the basic SEARCH command defined in <a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a>, and as enhanced by <a class='info' href='#ESEARCH'>[ESEARCH]<span> (</span><span class='info'>Melnikov, A. and D. Cridland, &ldquo;IMAP4 Extension to SEARCH Command for Controlling What Kind of Information Is Returned,&rdquo; November&nbsp;2006.</span><span>)</span></a>, is relatively compact in its representation, this reduction saves only a certain amount of data, and huge mailboxes might overwhelm the storage available for results on even relatively high-end desktop machines.
</p>
<p>The SORT command, defined in <a class='info' href='#SORT'>[SORT]<span> (</span><span class='info'>Crispin, M. and K. Murchison, &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - SORT AND THREAD EXTENSIONS,&rdquo; March&nbsp;2008.</span><span>)</span></a> provides useful features, but is hard to use effectively on changing mailboxes over low-bandwidth connections.
</p>
<p>This memo borrows concepts from <a class='info' href='#ACAP'>[ACAP]<span> (</span><span class='info'>Newman, C. and J. Myers, &ldquo;ACAP -- Application Configuration Access Protocol,&rdquo; November&nbsp;1997.</span><span>)</span></a>, providing a windowed view onto search or sort results, as well as bandwidth and round-trip efficient updates, by providing two extensions, known as "ESORT" and "CONTEXT".
    
</p>
<a name="esort"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Extended Sort Syntax</h3>

<p>Servers implementing the extended SORT provide a suite of extensions to the SORT and UID SORT commands defined in <a class='info' href='#SORT'>[SORT]<span> (</span><span class='info'>Crispin, M. and K. Murchison, &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - SORT AND THREAD EXTENSIONS,&rdquo; March&nbsp;2008.</span><span>)</span></a>. This allows for return options, as used with SEARCH and specified in <a class='info' href='#IMAP-ABNF'>[IMAP&#8209;ABNF]<span> (</span><span class='info'>Melnikov, A. and C. Daboo, &ldquo;Collected Extensions to IMAP4 ABNF,&rdquo; April&nbsp;2006.</span><span>)</span></a>, to be used with SORT in a similar manner.
</p>
<p>The SORT and UID SORT commands are extended by the addition of an optional list of return options which follow a RETURN atom immediately after the command. If this is missing, the server will return results as specified in <a class='info' href='#SORT'>[SORT]<span> (</span><span class='info'>Crispin, M. and K. Murchison, &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - SORT AND THREAD EXTENSIONS,&rdquo; March&nbsp;2008.</span><span>)</span></a>.
</p>
<p>The extended SORT command always returns results in the requested sort order, but is otherwise identical in its behaviour to the extended SEARCH command defined in <a class='info' href='#IMAP-ABNF'>[IMAP&#8209;ABNF]<span> (</span><span class='info'>Melnikov, A. and C. Daboo, &ldquo;Collected Extensions to IMAP4 ABNF,&rdquo; April&nbsp;2006.</span><span>)</span></a>, as extended by <a class='info' href='#ESEARCH'>[ESEARCH]<span> (</span><span class='info'>Melnikov, A. and D. Cridland, &ldquo;IMAP4 Extension to SEARCH Command for Controlling What Kind of Information Is Returned,&rdquo; November&nbsp;2006.</span><span>)</span></a>. In particular, the extended SORT command returns results in an ESEARCH response.
</p>
<a name="esort-ext"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
ESORT extension</h3>

<p>Servers advertising the capability "ESORT" support the return options specified in <a class='info' href='#ESEARCH'>[ESEARCH]<span> (</span><span class='info'>Melnikov, A. and D. Cridland, &ldquo;IMAP4 Extension to SEARCH Command for Controlling What Kind of Information Is Returned,&rdquo; November&nbsp;2006.</span><span>)</span></a>, adapted as follows:
    </p>
<blockquote class="text"><dl>
<dt>MIN</dt>
<dd>
       Return the message number/UID of the lowest sorted message satisfying the search criteria.<br />
<br />

</dd>
<dt>MAX</dt>
<dd>
       Return the message number/UID of the highest sorted message satisfying the search criteria.<br />
<br />

</dd>
<dt>ALL</dt>
<dd>
       Return all message numbers/UIDs which match the search criteria, in the requested sort order, using a sequence-set. Note the use of ranges described below in <a class='info' href='#esort-ranges'>Section&nbsp;3.2<span> (</span><span class='info'>Ranges in Extended Sort results</span><span>)</span></a>.<br />
<br />

</dd>
<dt>COUNT</dt>
<dd>
       As <a class='info' href='#ESEARCH'>[ESEARCH]<span> (</span><span class='info'>Melnikov, A. and D. Cridland, &ldquo;IMAP4 Extension to SEARCH Command for Controlling What Kind of Information Is Returned,&rdquo; November&nbsp;2006.</span><span>)</span></a>.<br />
<br />

</dd>
</dl></blockquote>

<a name="esort-ranges"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Ranges in Extended Sort results</h3>

<p>Any ranges given by the server, including those given as part of the sequence-set, in an ESEARCH response resulting from an extended SORT or UID SORT command MUST be ordered in increasing numerical order after expansion, as per usual <a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a> rules.
</p>
<p>In particular this means that 10:12 is equivalent to 12:10, and 10,11,12. To avoid confusion, servers SHOULD present ranges only when the first seq-number is lower than the second; that is, either of the forms 10:12 or 10,11,12 is acceptable, but 12:10 SHOULD be avoided.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Extended SORT example</h3>

<p>
<p>If the list of return options is present but empty, then the server provides the ALL return data item in an ESEARCH response. This is functionally equivalent to an unextended UID SORT command, but can use a smaller representation:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      C: E01 UID SORT RETURN () (REVERSE DATE) UTF-8 UNDELETED
         UNKEYWORD $Junk
      S: * ESEARCH (TAG "E01") UID ALL 23765,23764,23763,23761,[...]
      S: E01 OK Sort completed
</pre></div>
<p>Note that the initial three results are not represented as the range 23765:23763 as mandated in <a class='info' href='#esort-ranges'>Section&nbsp;3.2<span> (</span><span class='info'>Ranges in Extended Sort results</span><span>)</span></a>.
</p>

<a name="proto"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Contexts</h3>

<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Overview</h3>

<p>The Contexts extension is present in any IMAP4rev1 server which includes the string "CONTEXT=SEARCH", and/or "CONTEXT=SORT", within its advertised capabilities.
</p>
<p>In the case of CONTEXT=SEARCH, the server supports the extended SEARCH command syntax described in <a class='info' href='#IMAP-ABNF'>[IMAP&#8209;ABNF]<span> (</span><span class='info'>Melnikov, A. and C. Daboo, &ldquo;Collected Extensions to IMAP4 ABNF,&rdquo; April&nbsp;2006.</span><span>)</span></a>, and accepts three new return options.
</p>
<p>Servers advertising CONTEXT=SORT also advertise the SORT capability, as described in <a class='info' href='#SORT'>[SORT]<span> (</span><span class='info'>Crispin, M. and K. Murchison, &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - SORT AND THREAD EXTENSIONS,&rdquo; March&nbsp;2008.</span><span>)</span></a>, support the extended SORT command syntax described in <a class='info' href='#esort'>Section&nbsp;3<span> (</span><span class='info'>Extended Sort Syntax</span><span>)</span></a>, and accept in addition three new return options for this extended SORT.
</p>
<p>These allow for notifications of changes to the results of SEARCH or SORT commands, and also allow for access to partial results.
</p>
<p>A server advertising the CONTEXT=SEARCH extension will order all SEARCH results, whether from a UID SEARCH or SEARCH command, in mailbox order - that is, by message number and UID. Therefore, the UID SEARCH, SEARCH, UID SORT, or SORT command used - collectively known as the searching command - will always have an order, the requested order, which will be the mailbox order for UID SEARCH and SEARCH commands.
</p>
<p>All of the return specifiers have no interaction with either each other or any return specifiers defined in <a class='info' href='#ESEARCH'>[ESEARCH]<span> (</span><span class='info'>Melnikov, A. and D. Cridland, &ldquo;IMAP4 Extension to SEARCH Command for Controlling What Kind of Information Is Returned,&rdquo; November&nbsp;2006.</span><span>)</span></a> or <a class='info' href='#esort-ext'>Section&nbsp;3.1<span> (</span><span class='info'>ESORT extension</span><span>)</span></a>, however it is believed that implementations supporting CONTEXT will also support ESEARCH and ESORT.
</p>
<a name="proto-context"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Context Hint</h3>

<p>The return option CONTEXT SHOULD be used by a client to indicate that subsequent use of the search criteria are likely. Servers MAY ignore this return option, or use it as a hint to maintain a full result cache, or index.
</p>
<p>
<p>A client might choose to obtain a count of matching messages prior to obtaining actual results. Here, the client signals its intention to fetch the results themselves:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    C: A01 SEARCH RETURN (CONTEXT COUNT) UNDELETED
       UNKEYWORD $Junk
    S: * ESEARCH (TAG "A01") COUNT 23765
    S: A01 OK Search completed.
</pre></div>
    

<a name="proto-notify"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Notifications of changes</h3>

<p>The search return option UPDATE, if used by a client, causes the server to issue unsolicited notifications containing updates to the results which would be returned by an unmodified searching command. These update sets are carried in ADDTO and REMOVEFROM data items in ESEARCH/ESORT responses.
</p>
<p>These ESEARCH responses carry a search correlator of the searching command, hence clients MUST NOT reuse tags, as already specified in Section 2.2.1 of <a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a>. An attempt to use UPDATE where a tag is already in use with a previous searching command which itself used UPDATE SHALL result in the server rejecting the searching command with a BAD response.
</p>
<p>Both ADDTO and REMOVEFROM data items SHOULD be delivered to clients in a timely manner, as and when results change, whether by new messages arriving in the mailbox, metadata such as flags being changed, or messages being expunged.
</p>
<p>Typically, this would occur at the same time as the FETCH, EXISTS or EXPUNGE responses carrying the source of the change.
</p>
<p>Updates will cease only when the mailbox is no longer selected, or when the CANCELUPDATE command, defined in <a class='info' href='#cancelupdate'>Section&nbsp;4.3.5<span> (</span><span class='info'>The CANCELUPDATE command</span><span>)</span></a>, is issued by the client, whichever is sooner.
</p>
<p>Unlike <a class='info' href='#ACAP'>[ACAP]<span> (</span><span class='info'>Newman, C. and J. Myers, &ldquo;ACAP -- Application Configuration Access Protocol,&rdquo; November&nbsp;1997.</span><span>)</span></a>, there is no requirement that a context need be created with CONTEXT to use UPDATE, and in addition, the lack of UPDATE with a CONTEXT does not affect the results caused by later searching commands - there is no snapshot facility.
</p>
<p>There is no interaction between UPDATE and any other return options; therefore use of RETURN (UPDATE MIN), for example, does not notify about the minimum UID or sequence number, but notifies instead about all changes to the set of matching messages. In particular, this means that a client using UPDATE and PARTIAL on the same search program could receive notifications about messages which do not currently interest it.
</p>
<p>
<p>This time, the client will require notifications of updates, and chooses to obtain a count:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    C: B01 UID SEARCH RETURN (UPDATE COUNT) DELETED
       KEYWORD $Junk
    S: * ESEARCH (TAG "B01") COUNT 74
    S: B01 OK Search completed, will notify.
    // Note that the following is rejected, and has no effect:
    C: B01 SORT RETURN (UPDATE) FLAGGED
    S: B01 BAD Tag reuse
</pre></div>
    

<a name="refuse-update"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3.1"></a><h3>4.3.1.&nbsp;
Refusing to update contexts</h3>

<p>In some cases, the server MAY refuse to provide updates, such as if an internal limit on the number of update contexts is reached. In such a case, an untagged NO is generated during processing of the command with a response-code of NOUPDATE. The response-code contains, as argument, the tag of the search command for which the server is refusing to honour the UPDATE request.
</p>
<p>Other return options specified SHALL still be honoured.
</p>
<p>Servers MUST provide at least one updating context per client, and SHOULD provide more - see <a class='info' href='#implementation'>Appendix&nbsp;B<span> (</span><span class='info'>Server Implementation Notes</span><span>)</span></a> for strategies on reducing the impact of additional updating contexts. Since sorted contexts require a higher implementation cost than unsorted contexts, refusal to provide updates for a SORT command does not imply that SEARCH contexts will also be refused.
</p>
<p>
<p>This time, the client will require notifications of updates, and chooses to obtain a count:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    C: B02 UID SORT RETURN (UPDATE COUNT) UTF-8
       KEYWORD $Junk
    S: * ESEARCH (TAG "B02") COUNT 74
    S: * NO [NOUPDATE "B02"] Too many contexts
    S: B02 OK Search completed, will not notify.
</pre></div>
<p>Client handling might be to retry with a UID SEARCH command, or else cancel an existing context; see <a class='info' href='#cancelupdate'>Section&nbsp;4.3.5<span> (</span><span class='info'>The CANCELUPDATE command</span><span>)</span></a>.
</p>
    

<a name="update-common"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3.2"></a><h3>4.3.2.&nbsp;
Common Features of ADDTO and REMOVEFROM</h3>

<p>The result update set included in the return data item is specified as UIDs or message numbers, depending on how the UPDATE was specified. If the UPDATE was present in a SEARCH or SORT command, the results will be message numbers; in a UID SEARCH or UID SORT command, they will be UIDs.
</p>
<p>The client MUST process ADDTO and REMOVEFROM return data items in the order they appear, including those within a single ESEARCH response. Correspondingly, servers MUST generate ADDTO and REMOVEFROM responses such that the results are maintained in the requested order.
</p>
<p>As with any response aside from EXPUNGE, ESEARCH responses carrying ADDTO and/or REMOVEFROM return data items MAY be sent at any time. In particular, servers MAY send such responses when no command is in progress, during the processing of any command, or when the client is using the IDLE facility described in <a class='info' href='#IDLE'>[IDLE]<span> (</span><span class='info'>Leiba, B., &ldquo;IMAP4 IDLE command,&rdquo; June&nbsp;1997.</span><span>)</span></a>. Implementors are recommended to read <a class='info' href='#NOTIFY'>[NOTIFY]<span> (</span><span class='info'>King, C., &ldquo;The IMAP NOTIFY Extension,&rdquo; July&nbsp;2007.</span><span>)</span></a> as a mechanism for clients to signal servers that they are willing to process responses at any time, and are also recommended to pay close attention to Section 5.3 of <a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a>.
</p>
<p>It is anticipated that typical server implementations will emit ADDTO when they normally emit the causal FETCH or EXISTS, and similarly emit REMOVEFROM when they normally emit the causal FETCH or EXPUNGE.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3.3"></a><h3>4.3.3.&nbsp;
ADDTO Return Data Item</h3>

<p>The ADDTO return data item contains, as payload, a list containing pairs of a context position and a set of result updates in the requested order to be inserted at the context position. Where the searching command is a SEARCH or UID SEARCH command, the context position MAY be zero. Each pair is processed in the order that it appears.
</p>
<p>If the context position is non-zero, the result update is inserted at the given context position, meaning that the first result in the set will occupy the new context position after insertion, and any prior existing result at that context position will be shifted to a later context position.
</p>
<p>Where the context position is zero, the client MAY insert the message numbers or UIDs in the result list such that the result list is maintained in mailbox order. In this case, servers are RECOMMENDED to order the result update into mailbox order to produce the shortest representation in set-syntax.
</p>
<p></p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    [...]
    S: * 23762 FETCH (FLAGS (\Deleted \Seen))
    S: * 23763 FETCH (FLAGS ($Junk \Seen))
    S: * ESEARCH (TAG "B01") UID ADDTO (0 32768:32769)
</pre></div><p>

<p>Note that this example assumes messages 23762 and 23763 with UIDs 32768 and 32769 respectively previously had neither \Deleted nor $Junk set. Also note that only the ADDTO is included, and not the (now changed) COUNT.
</p>

<p>
<p>If the searching command "C01" initially generated a result list of 4:5, then the following three responses are equivalent, and yield a result list of 1:5:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    [...]
    S: * ESEARCH (TAG "C01") UID ADDTO (1 3 1 2 1 1)
    S: * ESEARCH (TAG "C01") UID ADDTO (1 3) ADDTO (1 1:2)
    S: * ESEARCH (TAG "C01") UID ADDTO (1 1:3)
</pre></div>
<p>The last is the preferred representation.
</p>

<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3.4"></a><h3>4.3.4.&nbsp;
REMOVEFROM Return Data Item</h3>

<p>The REMOVEFROM return data item contains, as payload, a list containing pairs of a context position and a set of result updates in the requested order to be removed starting from the context position. Where the searching command is a SEARCH or UID SEARCH command, the context position MAY be zero. Each pair is processed in the order that it appears.
</p>
<p>If the context position is non-zero, the results are removed at the given context position, meaning that the first result in the set will occupy the given context position before removal, and any prior existing result at that context position will be shifted to an earlier context position.
</p>
<p>Where the context position is zero, the client removes the message numbers or UIDs in the result list wherever they occur, and servers are RECOMMENDED to order the result list in mailbox order to obtain the best benefit from the set-syntax.
</p>
<p>Note that a REMOVEFROM containing message sequence numbers removed as a result of those messages being expunged MUST be sent prior to the expunge notification itself, in order that those sequence numbers remain valid.
</p>
<p>
<p>Here, a message in the result list is expunged. The REMOVEFROM here is shown to happen without any command in progress, see <a class='info' href='#update-common'>Section&nbsp;4.3.2<span> (</span><span class='info'>Common Features of ADDTO and REMOVEFROM</span><span>)</span></a>. Note that EXPUNGE responses do not have this property.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    [...]
    S: * ESEARCH (TAG "B01") UID REMOVEFROM (0 32768)
    C: B03 NOOP
    S: * 23762 EXPUNGE
    S: B03 OK Nothing done.
</pre></div>
    

<a name="cancelupdate"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3.5"></a><h3>4.3.5.&nbsp;
The CANCELUPDATE command</h3>

<p>When a client no longer wishes to receive updates, it may issue the CANCELUPDATE command, which will prevent all updates to the contexts named in the arguments from being transmitted by the server. The command takes, as arguments, one or more tags of the commands used to request updates.
</p>
<p>The server MAY free any resource associated with a context so disabled - however the client is free to issue further searching commands with the same criteria and requested order, including PARTIAL requests.
</p>
<p></p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    C: B04 CANCELUPDATE "B01"
    S: B04 OK No further updates.
</pre></div><p>

    
</p>
<a name="proto-partial"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Partial results</h3>

<p>The PARTIAL search return option causes the server to provide in an ESEARCH response a subset of the results denoted by the sequence range given as the mandatory argument. The first result is 1, thus the first 500 results would be obtained by a return option of "PARTIAL 1:500", and the second 500 by "PARTIAL 501:1000". This intentionally mirrors message sequence numbers.
</p>
<p>A single command MUST NOT contain more than one PARTIAL or ALL search return option - that is, either one PARTIAL, one ALL, or neither of PARTIAL or ALL is allowed.
</p>
<p>For SEARCH results, the entire result list MUST be ordered in mailbox order, that is, in UID or message sequence number order.
</p>
<p>Where a PARTIAL search return option references results which do not exist, by using a range which starts or ends higher than the current number of results, then the server returns those results which are in the set. This yields a PARTIAL return data item which has, as payload, the original range and a potentially missing set of results which may be shorter than the extent of the range.
</p>
<p>Clients need not request PARTIAL results in any particular order. Because mailboxes may change, clients will often wish to use PARTIAL in combination with UPDATE, especially if the intent is to walk a large set of results; however these return options do not interact - the UPDATE will provide notifications for all matching results.
</p>
<p></p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
    // Recall from A01 that there are 23764 results.
    C: A02 UID SEARCH RETURN (PARTIAL 23500:24000) UNDELETED
       UNKEYWORD $Junk
    C: A03 UID SEARCH RETURN (PARTIAL 1:500) UNDELETED
       UNKEYWORD $Junk
    C: A04 UID SEARCH RETURN (PARTIAL 24000:24500) UNDELETED
       UNKEYWORD $Junk
    S: * ESEARCH (TAG "A02") UID PARTIAL (23500:24000 ...)
    // 264 results in set syntax elided,
    // this spans the end of the results.
    S: A02 OK Completed.
    S: * ESEARCH (TAG "A03") UID PARTIAL (1:500 ...)
    // 500 results in set syntax elided.
    S: A03 OK Completed.
    S: * ESEARCH (TAG "A04") UID PARTIAL (24000:24500 NIL)
    // No results are present, this is beyond the end of the results.
    S: A04 OK Completed.
</pre></div><p>

</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Caching results</h3>

<p>Server implementations MAY cache results from a search or sort, whether or not hinted to by CONTEXT, in order to make subsequent searches more efficient, perhaps by recommencing a subsequent PARTIAL search where a previous search left off. However servers MUST behave identically whether or not internal caching is taking place, therefore any such cache is required to be updated as changes to the mailbox occur. An alternate strategy would be to discard results when any change occurs to the mailbox.
    
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Formal Syntax</h3>

<p>The collected formal syntax. This uses ABNF as defined in <a class='info' href='#ABNF'>[ABNF]<span> (</span><span class='info'>Crocker, D., Ed. and P. Overell, &ldquo;Augmented BNF for Syntax Specifications: ABNF,&rdquo; October&nbsp;2005.</span><span>)</span></a>. It includes definitions from
    <a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a>, <a class='info' href='#IMAP-ABNF'>[IMAP&#8209;ABNF]<span> (</span><span class='info'>Melnikov, A. and C. Daboo, &ldquo;Collected Extensions to IMAP4 ABNF,&rdquo; April&nbsp;2006.</span><span>)</span></a>, and <a class='info' href='#SORT'>[SORT]<span> (</span><span class='info'>Crispin, M. and K. Murchison, &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - SORT AND THREAD EXTENSIONS,&rdquo; March&nbsp;2008.</span><span>)</span></a>.
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
<dfn>capability</dfn>          =/ "<span class='str'>CONTEXT=SEARCH</span>" / "<span class='str'>CONTEXT=SORT</span>" / "<span class='str'>ESORT</span>"
    <em>;; &lt;capability&gt; from [IMAP]</em>

<dfn>command-select</dfn>      =/ "<span class='str'>CANCELUPDATE</span>" <span class='rep'>1*</span>(<cite class='key'>SP</cite> <cite class='id'>quoted</cite>)
    <em>;; &lt;command-select&gt; from [IMAP]</em>

<dfn>context-position</dfn>      = <cite class='id'>context-position</cite>
    <em>;; Context position may be 0 for SEARCH result additions.</em>
    <em>;; &lt;number&gt; from [IMAP]</em>

<dfn>modifier-context</dfn>    = "<span class='str'>CONTEXT</span>"

<dfn>modifier-partial</dfn>    = "<span class='str'>PARTIAL</span>" <cite class='key'>SP</cite> <cite class='id'>seq-range</cite>
    <em>;; &lt;seq-range&gt; from [IMAP]</em>

<dfn>modifier-update</dfn>     = "<span class='str'>UPDATE</span>"

<dfn>search-return-opt</dfn>   =/ <cite class='id'>modifier-context</cite> / <cite class='id'>modifier-partial</cite> /
                       <cite class='id'>modifier-update</cite>
    <em>;; All conform to &lt;search-return-opt&gt;, from [IMAP-ABNF]</em>

<dfn>resp-text-code</dfn>      =/ "<span class='str'>NOUPDATE</span>" <cite class='key'>SP</cite> <cite class='id'>quoted</cite>
    <em>;; &lt;resp-text-code&gt; from [IMAP]</em>

<dfn>ret-data-addto</dfn>      = "<span class='str'>ADDTO</span>"
                       <cite class='key'>SP</cite> "<span class='str'>(</span>" <cite class='id'>context-position</cite> <cite class='key'>SP</cite> <cite class='id'>sequence-set</cite>
                       <span class='rep'>*</span>(<cite class='key'>SP</cite> <cite class='id'>context-position</cite> <cite class='key'>SP</cite> <cite class='id'>sequence-set</cite>)
                       "<span class='str'>)</span>"
    <em>;; &lt;sequence-set&gt; from [IMAP]</em>

<dfn>ret-data-partial</dfn>    = "<span class='str'>PARTIAL</span>"
                      <cite class='key'>SP</cite> "<span class='str'>(</span>" <cite class='id'>seq-range</cite> <cite class='key'>SP</cite> <cite class='id'>partial-results</cite> "<span class='str'>)</span>"
    <em>;; &lt;seq-range&gt; is the requested range.</em>
    <em>;; &lt;seq-range&gt; from [IMAP]</em>

<dfn>partial-results</dfn>     = <cite class='id'>sequence-set</cite> / "<span class='str'>NIL</span>"
    <em>;; &lt;sequence-set&gt; from [IMAP]</em>
    <em>;; NIL indicates no results correspond to the requested range.</em>

<dfn>ret-data-removefrom</dfn> = "<span class='str'>REMOVEFROM</span>"
                       <cite class='key'>SP</cite> "<span class='str'>(</span>" <cite class='id'>context-position</cite> <cite class='key'>SP</cite> <cite class='id'>sequence-set</cite>
                       <span class='rep'>*</span>(<cite class='key'>SP</cite> <cite class='id'>context-position</cite> <cite class='key'>SP</cite> <cite class='id'>sequence-set</cite>)
                       "<span class='str'>)</span>"
    <em>;; &lt;sequence-set&gt; from [IMAP]</em>

<dfn>search-return-data</dfn>  =/ <cite class='id'>ret-data-partial</cite> / <cite class='id'>ret-data-addto</cite> /
                       <cite class='id'>ret-data-removefrom</cite>
    <em>;; All conform to &lt;search-return-data&gt;, from [IMAP-ABNF]</em>

<dfn>sort</dfn>                =/ <cite class='id'>extended-sort</cite>
    <em>;; &lt;sort&gt; from [SORT]</em>

<dfn>extended-sort</dfn>       = ["<span class='str'>UID</span>" <cite class='key'>SP</cite>] "<span class='str'>SORT</span>" <cite class='id'>search-return-opts</cite>
                      <cite class='key'>SP</cite> <cite class='id'>sort-criteria</cite> <cite class='key'>SP</cite> <cite class='id'>search-criteria</cite>
    <em>;; &lt;search-return-opts&gt; from [IMAP-ABNF]</em>
    <em>;; &lt;sort-criteria&gt; and &lt;search-criteria&gt; from [SORT]</em>
</pre></div>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>This document defines additional IMAP4 capabilities. As such, it does not change the underlying security considerations of <a class='info' href='#IMAP'>[IMAP]<span> (</span><span class='info'>Crispin, M., &ldquo;INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1,&rdquo; March&nbsp;2003.</span><span>)</span></a>. The authors and reviewers believe that no new security issues are introduced with these additional IMAP4 capabilities.
</p>
<p>Creation of a large number of contexts may provide an avenue for denial of service attacks by authorized users. Implementors may reduce this by limiting the numbers of contexts possible to create, via the protocol features described in <a class='info' href='#refuse-update'>Section&nbsp;4.3.1<span> (</span><span class='info'>Refusing to update contexts</span><span>)</span></a>; by reducing the impact of contexts by the implementation strategies described in <a class='info' href='#implementation'>Appendix&nbsp;B<span> (</span><span class='info'>Server Implementation Notes</span><span>)</span></a>; and by logging context creation and usage so that administrative remedies may be applied.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
IANA Considerations</h3>

<p>IMAP4 capabilities are registered by publishing a standards track or
   IESG approved experimental RFC.  The registry is currently located
   at:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      http://www.iana.org/assignments/imap4-capabilities
</pre></div>
<p>This document defines the ESORT, CONTEXT=SEARCH, and CONTEXT=SORT IMAP capabilities.  IANA is requested to add
   them to the registry accordingly.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Acknowledgements</h3>

<p>Much of the design of this extension can be found in ACAP. Valuable comments, both in agreement and in dissent, were received from Alexey Melnikov, Arnt Gulbrandsen, Cyrus Daboo, Filip Navara, Mark Crispin, Peter Coates, Philip Van Hoof, Randall Gellens, Timo Sirainen, Zoltan Ordogh and others, and many of these comments have had significant influence on the design or the text. The authors are grateful to all those involved, including those not mentioned here.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="ABNF">[ABNF]</a></td>
<td class="author-text"><a href="mailto:dcrocker@bbiw.net">Crocker, D., Ed.</a> and <a href="mailto:paul.overell@thus.net">P. Overell</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc4234">Augmented BNF for Syntax Specifications: ABNF</a>,&rdquo; RFC&nbsp;4234, October&nbsp;2005 (<a href="ftp://ftp.isi.edu/in-notes/rfc4234.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc4234.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc4234.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="ESEARCH">[ESEARCH]</a></td>
<td class="author-text">Melnikov, A. and D. Cridland, &ldquo;<a href="http://tools.ietf.org/html/rfc4731">IMAP4 Extension to SEARCH Command for Controlling What Kind of Information Is Returned</a>,&rdquo; RFC&nbsp;4731, November&nbsp;2006 (<a href="ftp://ftp.isi.edu/in-notes/rfc4731.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="IMAP">[IMAP]</a></td>
<td class="author-text">Crispin, M., &ldquo;<a href="http://tools.ietf.org/html/rfc3501">INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1</a>,&rdquo; RFC&nbsp;3501, March&nbsp;2003 (<a href="ftp://ftp.isi.edu/in-notes/rfc3501.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="IMAP-ABNF">[IMAP-ABNF]</a></td>
<td class="author-text">Melnikov, A. and C. Daboo, &ldquo;<a href="http://tools.ietf.org/html/rfc4466">Collected Extensions to IMAP4 ABNF</a>,&rdquo; RFC&nbsp;4466, April&nbsp;2006 (<a href="ftp://ftp.isi.edu/in-notes/rfc4466.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="KEYWORDS">[KEYWORDS]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SORT">[SORT]</a></td>
<td class="author-text">Crispin, M. and K. Murchison, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-imapext-sort-20.txt">INTERNET MESSAGE ACCESS PROTOCOL - SORT AND THREAD EXTENSIONS</a>,&rdquo; draft-ietf-imapext-sort-20 (work in progress), March&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-imapext-sort-20.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>9.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="ACAP">[ACAP]</a></td>
<td class="author-text"><a href="mailto:chris.newman@innosoft.com">Newman, C.</a> and <a href="mailto:jgmyers@netscape.com">J. Myers</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2244">ACAP -- Application Configuration Access Protocol</a>,&rdquo; RFC&nbsp;2244, November&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2244.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="IDLE">[IDLE]</a></td>
<td class="author-text"><a href="mailto:leiba@watson.ibm.com">Leiba, B.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2177">IMAP4 IDLE command</a>,&rdquo; RFC&nbsp;2177, June&nbsp;1997 (<a href="ftp://ftp.isi.edu/in-notes/rfc2177.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2177.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2177.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="NOTIFY">[NOTIFY]</a></td>
<td class="author-text">King, C., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-gulbrandsen-imap-notify-07.txt">The IMAP NOTIFY Extension</a>,&rdquo; draft-gulbrandsen-imap-notify-07 (work in progress), July&nbsp;2007 (<a href="http://www.ietf.org/internet-drafts/draft-gulbrandsen-imap-notify-07.txt">TXT</a>).</td></tr>
</table>

<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Cookbook</h3>

<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
Virtual Mailboxes</h3>

<p>It is possible to use the facilities described within this memo to create a facility largely similar to a virtual mailbox, but handled on the client side.
</p>
<p>Initially, the client SELECTs the real "backing" mailbox. Next, it can switch to a filtered view at any time by issuing a RETURN (COUNT UPDATE CONTEXT), and using RETURN (PARTIAL x:y) as the user scrolls, feeding the results into a FETCH as required to populate summary views.
</p>
<p>A typically useful view is UID SORT (DATE) RETURN (...) UTF-8 UNSEEN UNDELETED, which can be used to show the mailbox sorted into INTERNALDATE order, filtered to only show messages which are unread and not yet deleted.
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.2"></a><h3>A.2.&nbsp;
Trash Mailboxes</h3>

<p>Certain contexts are particularly useful for client developers wishing to present something similar to the common trash mailbox metaphor in limited bandwidth. The simple criteria of UNDELETED only matches undeleted messages, and the corresponding DELETED search key can be used to display a per-mailbox trash-like virtual mailbox.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.3"></a><h3>A.3.&nbsp;
Immediate EXPUNGE notifications</h3>

<p>The command "SEARCH RETURN (UPDATE) ALL" can be used to create a context which notifies immediately about expunged messages, yet will not affect message sequence numbers until the normal EXPUNGE message can be sent. This may be useful for clients wishing to show this behaviour without losing the benefit of sequence numbering.
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.4"></a><h3>A.4.&nbsp;
Monitoring counts</h3>

<p>A client need not maintain any result cache at all, but instead maintain a simple count of messages matching the search criteria. Typically, this would use the SEARCH command, as opposed to UID SEARCH, due to its smaller representation. Such usage might prove useful in monitoring the number of flagged, but unanswered, messages, for example, with "SEARCH RETURN (UPDATE COUNT) FLAGGED UNANSWERED".
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.5"></a><h3>A.5.&nbsp;
Resynchronizing Contexts</h3>

<p>The creation of a context, and immediate access to it, can all be accomplished in a single round-trip. Therefore, whilst it is possible to elide resynchronization if no changes have occurred, it is simpler in most cases to resynchronize by simply recreating the context.
</p>
<a name="implementation"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.B"></a><h3>Appendix B.&nbsp;
Server Implementation Notes</h3>

<p>Although a server may cache the results, this is not mandated nor required, especially when the client uses SEARCH or UID SEARCH commands. UPDATE processing, for example, can be achieved efficiently by comparison of the old flag state (if any) and the new, and PARTIAL can be achieved by re-running the search until the suitable window is required. This is a result of there being no snapshot facility.
</p>
<p>For example, on a new message, the server can simply test for matches against all current UPDATE context search programs, and for any that match, send the ADDTO return data.
</p>
<p>Similarly, for a flag change on an existing message, the server can check whether the message matched with its old flags, whether it matches with new flags, and provide ADDTO or REMOVEFROM return data accordingly if these results differ.
</p>
<p>For PARTIAL requests, the server can perform a full search, discarding results until the lower bound is hit, and stopping the search when sufficient results have been obtained.
</p>
<p>With some additional state, it is possible to restart PARTIAL searches, thus avoiding performing the initial discard phase.
</p>
<p>For the best performance, however, caching the full search results is needed, which can allow for faster responses at the expense of memory. One reasonable strategy would be to balance this trade-off at run-time, discarding search results after a suitable timeout, and regenerating them as required.
</p>
<p>This yields state requirements of storing the search program for any UPDATE contexts, and optionally storing both search program and (updated) results for further contexts as required.
</p>
<p>Note that in the absence of a server-side results cache, it may be impossible to know if an expunged message previously matched unless the original message is still available. Therefore some implementations may be forced into using a results cache in many circumstances.
</p>
<p>UPDATE contexts created with SORT or UID SORT will almost certainly require some form of results caching, however.
</p>
<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dave Cridland</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Isode Limited</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5 Castle Business Village</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">36, Station Road</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hampton, Middlesex  TW12 2BX</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">GB</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:dave.cridland@isode.com">dave.cridland@isode.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Curtis King</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Isode Limited</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">5 Castle Business Village</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">36, Station Road</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Hampton, Middlesex  TW12 2BX</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">GB</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:cking@mumbo.ca">cking@mumbo.ca</a></td></tr>
</table>
<a name="rfc.copyright"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Full Copyright Statement</h3>
<p class='copyright'>
Copyright &copy; The IETF Trust (2008).</p>
<p class='copyright'>
This document is subject to the rights,
licenses and restrictions contained in BCP&nbsp;78,
and except as set forth therein,
the authors retain all their rights.</p>
<p class='copyright'>
This document and the information contained herein are provided
on an &ldquo;AS IS&rdquo; basis and THE CONTRIBUTOR,
THE ORGANIZATION HE/SHE REPRESENTS
OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST
AND THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT
THE USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY
IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR
PURPOSE.</p>
<h3>Intellectual Property</h3>
<p class='copyright'>
The IETF takes no position regarding the validity or scope of any
Intellectual Property Rights or other rights that might be claimed
to pertain to the implementation or use of the technology
described in this document or the extent to which any license
under such rights might or might not be available; nor does it
represent that it has made any independent effort to identify any
such rights.
Information on the procedures with respect to
rights in RFC documents can be found in BCP&nbsp;78 and BCP&nbsp;79.</p>
<p class='copyright'>
Copies of IPR disclosures made to the IETF Secretariat and any
assurances of licenses to be made available,
or the result of an attempt made to obtain a general license or
permission for the use of such proprietary rights by implementers or
users of this specification can be obtained from the IETF on-line IPR
repository at <a href='http://www.ietf.org/ipr'>http://www.ietf.org/ipr</a>.</p>
<p class='copyright'>
The IETF invites any interested party to bring to its attention
any copyrights,
patents or patent applications,
or other
proprietary rights that may cover technology that may be required
to implement this standard.
Please address the information to the IETF at <a href='mailto:ietf-ipr@ietf.org'>ietf-ipr@ietf.org</a>.</p>
</body></html>
