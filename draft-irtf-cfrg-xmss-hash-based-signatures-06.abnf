total = X[in];
KEY = PRF(SEED, ADRS);
BM = PRF(SEED, ADRS);

tmp = F(KEY, tmp XOR BM);
csum = 0;

msg = base_w(M, w, len_1);

csum = csum + w - 1 - msg[i];
csum = csum << ( 8 - ( ( len_2 * lg(w) ) % 8 ));
len_2_bytes = ceil( ( len_2 * lg(w) ) / 8 );
msg = msg || base_w(toByte(csum, len_2_bytes), w, len_2);
csum = 0;

msg = base_w(M, w, len_1);

csum = csum + w - 1 - msg[i];
csum = csum << ( 8 - ( ( len_2 * lg(w) ) % 8 ));
len_2_bytes = ceil( ( len_2 * lg(w) ) / 8 );
msg = msg || base_w(toByte(csum, len_2_bytes), w, len_2);
KEY = PRF(SEED, ADRS);
BM_0 = PRF(SEED, ADRS);
BM_1 = PRF(SEED, ADRS);

SEED = getSEED(SK);
pk = WOTS_genPK (getWOTS_SK(SK, s + i), SEED, ADRS);
node = ltree(pk, SEED, ADRS);
node = RAND_HASH(Stack.pop(), node, SEED, ADRS);
idx = 0;
ADRS = toByte(0, 32);
root = treeHash(SK, 0, h, ADRS);

SK = idx || wots_sk || SK_PRF || root || SEED;
PK = root || SEED;
k = floor(i / (2^j)) XOR 1;
idx_sig = getIdx(SK);
auth = buildAuth(SK, idx_sig, ADRS);
sig_ots = WOTS_sign(getWOTS_SK(SK, idx_sig),
                         M', getSEED(SK), ADRS);
Sig = (sig_ots || auth);
idx_sig = getIdx(SK);
ADRS = toByte(0, 32);
Sig = (idx_sig || r || treeSig(M', SK, ADRS));
pk_ots = WOTS_pkFromSig(sig_ots, M', SEED, ADRS);
ADRS = toByte(0, 32);
idx_MT = 0;
ADRS = toByte(0, 32);
SK = getXMSS_SK(SK_MT, 0, d - 1);
root = treeHash(SK, 0, h / d, ADRS);
PK_MT = (root || SEED);
ADRS = toByte(0, 32);
SEED = getSEED(SK_MT);
SK_PRF = getSK_PRF(SK_MT);
idx_sig = getIdx(SK_MT);

Sig_MT = idx_sig;
SK = idx_leaf || getXMSS_SK(SK_MT, idx_tree, 0) || SK_PRF
           || toByte(0, n) || SEED;
Sig_tmp = treeSig(M', SK, ADRS);
Sig_MT = Sig_MT || r || Sig_tmp;
root = treeHash(SK, 0, h / d, ADRS);
idx_leaf = (h / d) least significant bits of idx_tree;
idx_tree = (h - j * (h / d)) most significant bits of idx_tree;
SK = idx_leaf || getXMSS_SK(SK_MT, idx_tree, j) || SK_PRF
               || toByte(0, n) || SEED;
Sig_tmp = treeSig(root, SK, ADRS);
Sig_MT = Sig_MT || Sig_tmp;
idx_sig = getIdx(Sig_MT);
SEED = getSEED(PK_MT);
ADRS = toByte(0, 32);

idx_leaf = (h / d) least significant bits of idx_tree;
idx_tree = (h - j * h / d) most significant bits of idx_tree;
node = XMSS_rootFromSig(idx_leaf, getSig_ots(Sig'),
                              getAuth(Sig'), node, SEED, ADRS);
wotsp_reserved     = 0x00000000,
wotsp_sha2-256_w16 = 0x01000001,
wotsp_sha2-512_w16 = 0x02000002,
wotsp_shake128_w16 = 0x03000003,
wotsp_shake256_w16 = 0x04000004,
xmss_reserved         = 0x00000000,

xmss_sha2-256_w16_h10 = 0x01000001,
xmss_sha2-256_w16_h16 = 0x02000002,
xmss_sha2-256_w16_h20 = 0x03000003,

xmss_sha2-512_w16_h10 = 0x04000004,
xmss_sha2-512_w16_h16 = 0x05000005,
xmss_sha2-512_w16_h20 = 0x06000006,

xmss_shake128_w16_h10 = 0x07000007,
xmss_shake128_w16_h16 = 0x08000008,
xmss_shake128_w16_h20 = 0x09000009,

xmss_shake256_w16_h10 = 0x0a00000a,
xmss_shake256_w16_h16 = 0x0b00000b,
xmss_shake256_w16_h20 = 0x0c00000c,
xmssmt_reserved             = 0x00000000,

xmssmt_sha2-256_w16_h20_d2  = 0x01000001,
xmssmt_sha2-256_w16_h20_d4  = 0x02000002,
xmssmt_sha2-256_w16_h40_d2  = 0x03000003,
xmssmt_sha2-256_w16_h40_d4  = 0x04000004,
xmssmt_sha2-256_w16_h40_d8  = 0x05000005,
xmssmt_sha2-256_w16_h60_d3  = 0x06000006,
xmssmt_sha2-256_w16_h60_d6  = 0x07000007,
xmssmt_sha2-256_w16_h60_d12 = 0x08000008,

xmssmt_sha2-512_w16_h20_d2  = 0x09000009,
xmssmt_sha2-512_w16_h20_d4  = 0x0a00000a,
xmssmt_sha2-512_w16_h40_d2  = 0x0b00000b,
xmssmt_sha2-512_w16_h40_d4  = 0x0c00000c,
xmssmt_sha2-512_w16_h40_d8  = 0x0d00000d,
xmssmt_sha2-512_w16_h60_d3  = 0x0e00000e,
xmssmt_sha2-512_w16_h60_d6  = 0x0f00000f,
xmssmt_sha2-512_w16_h60_d12 = 0x01010101,

xmssmt_shake128_w16_h20_d2  = 0x02010102,
xmssmt_shake128_w16_h20_d4  = 0x03010103,
xmssmt_shake128_w16_h40_d2  = 0x04010104,
xmssmt_shake128_w16_h40_d4  = 0x05010105,
xmssmt_shake128_w16_h40_d8  = 0x06010106,
xmssmt_shake128_w16_h60_d3  = 0x07010107,
xmssmt_shake128_w16_h60_d6  = 0x08010108,
xmssmt_shake128_w16_h60_d12 = 0x09010109,
xmssmt_shake256_w16_h20_d2  = 0x0a01010a,
xmssmt_shake256_w16_h20_d4  = 0x0b01010b,
xmssmt_shake256_w16_h40_d2  = 0x0c01010c,
xmssmt_shake256_w16_h40_d4  = 0x0d01010d,
xmssmt_shake256_w16_h40_d8  = 0x0e01010e,
xmssmt_shake256_w16_h60_d3  = 0x0f01010f,
xmssmt_shake256_w16_h60_d6  = 0x01020201,
xmssmt_shake256_w16_h60_d12 = 0x02020202,
