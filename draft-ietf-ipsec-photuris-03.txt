

Network Working Group                                          Phil Karn
Internet Draft                                                  Qualcomm
                                                             W A Simpson
                                                              DayDreamer
expires in six months                                     September 1995


              The Photuris Session Key Management Protocol
                    draft-ietf-ipsec-photuris-03.txt



Status of this Memo

   This document is a submission to the IP Security Working Group of the
   Internet Engineering Task Force (IETF).  Comments should be submitted
   to the ipsec@ans.net mailing list.

   Distribution of this memo is unlimited.

   This document is an Internet-Draft.  Internet Drafts are working
   documents of the Internet Engineering Task Force (IETF), its Areas,
   and its Working Groups.  Note that other groups may also distribute
   working documents as Internet Drafts.

   Internet Drafts are draft documents valid for a maximum of six
   months, and may be updated, replaced, or obsoleted by other documents
   at any time.  It is not appropriate to use Internet Drafts as
   reference material, or to cite them other than as a ``working draft''
   or ``work in progress.''

   To learn the current status of any Internet-Draft, please check the
   ``1id-abstracts.txt'' listing contained in the internet-drafts Shadow
   Directories on:

      ftp.is.co.za (Africa)
      nic.nordu.net (Europe)
      ds.internic.net (US East Coast)
      ftp.isi.edu (US West Coast)
      munnari.oz.au (Pacific Rim)



Abstract

   Photuris [Firefly] is an experimental session-key management protocol
   intended for use with the IP Security Protocols (AH and ESP).




Karn & Simpson           expires in six months                  [Page i]
DRAFT                           Photuris                  September 1995


1.  Introduction

   The ultimate goal of Internet Security is to facilitate direct IP
   connectivity between sensitive hosts and users across the Internet.
   Users must have confidence in every Internet Security component,
   including key management.

   Users will rely on Internet Security to protect the confidentiality
   of the traffic they send across the Internet and depend on it to
   block unauthorized external access to their internal hosts and
   networks.  Without this confidence, users may erect barriers that
   impede legitimate use of the Internet, or forego the Internet
   entirely.

   Internet Security does not place any significance on easily forged IP
   Source addresses.  It relies instead on proof of possession of secret
   knowledge: that is, a cryptographic key.

   However, secure manual distribution and maintainance of these keys is
   often cumbersome and problematic.  Moreover, user distribution often
   leads to long-lived keys, with concommitant opportunity for
   compromise of the keys.  Photuris is designed for automatic and
   frequent exchange of new individual session-keys, with a minimum of
   configuration and effort.

   In addition, it has been shown in [DOW92] that key exchange must be
   coupled to authentication.  Photuris supports the use of a variety of
   digital signature methods, and facilitates the exchange of many
   chosen certificate types.  The DSS and RSA are examples of digital
   signatures which will provide strong authentication.  Details of DSS,
   RSA, and other signature algorithms may be found in [Schneier94].

   Protecting sensitive data on the Internet against compromise --
   either by interception or by unauthorized access -- is necessary, but
   not sufficient.  The computing resources themselves must also be
   protected against malicious attack or sabotage.  Photuris is also
   designed to thwart certain types of denial of service attacks on host
   resources.



1.1.  Terminology


   exchange-value   The publically distributable value used to calculate
                    a shared-secret.  As used in this document, refers
                    to a Diffie-Hellman exchange, as opposed to a
                    public-key.



Karn & Simpson           expires in six months                  [Page 1]
DRAFT                           Photuris                  September 1995


   private-key      A key that is kept secret, and is part of a
                    public/private key-pair.  As used in this document,
                    refers to RSA key pairs.

   public-key       A publically distributable value that is part of a
                    public/private key-pair.  As used in this document,
                    refers to RSA key pairs.

   secret-key       A key which is not publically distributable, and not
                    part of a public/private key-pair.  An example is a
                    user password.

   Security Association
                    A collection of parameters describing the security
                    relationship between two nodes.  These parameters
                    include the transform (including algorithm and
                    algorithm mode), the key(s) (such as a session-key,
                    secret-key, or appropriate public/private key-pair),
                    and possibly other information such as sensitivity
                    labelling.  For further details, see [RFC-1825].

   session-key      A key which is independently derived from a shared-
                    secret by the parties, and used for keying one
                    direction of traffic.  This key is changed
                    frequently.

   shared-secret    As used in this document, the calculated result of
                    the Photuris exchange.



1.2.  Clogging Defense

   To grant access to authorized users regardless of location, it must
   be possible to cheaply detect and discard bogus datagrams.
   Otherwise, an attacker intent on sabotage might rapidly send
   datagrams to exhaust the host's CPU or memory resources.

   Using Internet Security authentication facilities, when a datagram
   does not pass an authentication check, it can be discarded without
   further processing.  This is easily done with manual (null) key
   management between trusted hosts at relatively little cost, given the
   speed of cryptographic hash functions compared to public-key
   algorithms.

   Unfortunately, such a trusted host will have only a fixed number of
   keys available.  The keys will tend to have long lifetimes.  This
   carries significant security risks.



Karn & Simpson           expires in six months                  [Page 2]
DRAFT                           Photuris                  September 1995


   Automatic key management is necessary to generate keys between
   parties without prior arrangement.  But, there is a potential
   Achilles heel in the key management protocol.

   Because of their use of CPU-intensive operations such as modular
   exponentiation, key management schemes based on public-key
   cryptography are vulnerable to resource clogging attacks.  Although a
   complete defense against such attacks is impossible, Photuris
   features make them much more difficult.


   Cookie Exchange

      Photuris exchanges a "cookie" before initiating public-key
      operations, thwarting the saboteur from using random IP Source
      addresses.  The simple validation of this cookie uses the same
      level of resources as other Internet Security authentication
      mechanisms.

      This forces the attacker to:

      1) use its own valid IP address, or

      2) gain access to a physical transmission link and appropriate
         those addresses, or

      3) subvert Internet routing for the same purpose.

      The first option allows the target to detect and filter out such
      attacks, and significantly increases the likelihood of identifying
      the attacker.  The latter two options are much more difficult than
      merely sending large numbers of datagrams with randomly chosen IP
      Source addresses from an arbitrary point on the Internet.

      The cookie does not protect against an observer which can copy a
      valid cookie, or an interceptor which can modify or substitute
      another cookie.  However, these attacks are mitigated somewhat
      with time-variant cookies.


   State

      During the initial cookie exchange, Photuris does not maintain any
      state for the exchange.  This prevents memory resource exhaustion
      from a simple flooding attack.

      However, later exchange stages require saving of state to perform
      the key establishment calculations and exchange verification.  An



Karn & Simpson           expires in six months                  [Page 3]
DRAFT                           Photuris                  September 1995


      attacker which is willing to expose itself to a larger window of
      detection can waste resources repeating all the steps of the
      Photuris process.


   Precomputation

      Once state has been established between parties, repetitive
      exchanges can use many of the same previously computed values.
      This prevents an attacker with more CPU power from easily
      exhausting the target.


   Expiration

      All retained state is subject to periodic expiration, usually
      related to the speed of the link (typically 30 to 300 seconds),
      and is purged sometime later (typically 10 minutes).  These
      LifeTimes are implementation dependent.

      When an attacker has succeeded in overwhelming a target, the
      target will eventually recover as the expired state is purged.

      The periodic expiration and purge of retained state also reduces
      the risk of compromise of keys and secrets, and is an important
      consideration in attaining perfect forward secrecy.



1.3.  Security Parameters

   Photuris key management is used to determine a number of parameters
   for each Security Association between the communicating parties.
   This includes the particular authentication and/or encryption
   transforms, and the key(s) used to authenticate, encrypt or decrypt
   the payload.

   The key management implementation usually maintains a table
   containing the several parameters for each concurrent Security
   Association.  The implementation needs to access that security
   parameter table to determine how to process each datagram.

   The Security Parameters Index (SPI) is assigned by the entity
   controlling the IP Destination address.  A session between two
   parties will normally have two SPI values (one in each direction).
   The parties use the combination of SPI and IP Destination to
   distinguish the correct association.




Karn & Simpson           expires in six months                  [Page 4]
DRAFT                           Photuris                  September 1995


   The selection mechanism used for the SPI is implementation dependent.
   However, selection of a random value can help prevent attacks which
   depend on a predicatable sequence of values.

   To provide protection against an interceptor which can modify or
   substitute another SPI, the SPI is used in creating a separate
   session-key in each direction.  While alteration of the SPI will
   interrupt communication, the attacker will gain no additional
   information.



1.4.  Multicast Support

   Key management is more difficult in a multicast environment.

   Senders to a multicast group may share common a Security Parameters
   Index, if all communications are using the same security
   configuration parameters.  In this case, the receiver only knows that
   the message came from a node knowing the SPI for the group, and
   cannot authenticate which member of the group sent the datagram.

   Multicast groups may also use a separate SPI value for each Source.
   If each sender is keyed separately and asymmetric algorithms are
   used, data origin authentication is also provided.

      A given Destination is not necessarily in control of the selection
      process.  In the case of multicast groups, a single node or
      cooperating subset of the multicast group may work on behalf of
      the entire group to set up a Security Association.

   It is anticipated that Photuris would be used first to establish a
   distribution SPI and session-key, and that another orthogonal key
   distribution mechanism will use that SPI to send the group keys.
   Such a mechanism is outside the scope of this document.
















Karn & Simpson           expires in six months                  [Page 5]
DRAFT                           Photuris                  September 1995


2.  Protocol Description

   The Photuris protocol consists of several simple phases:

      Initiator                            Responder
      =========                            =========
      Cookie_Request                  ->
                                      <-   Cookie_Response
                                              offer schemes
      Key_Request                     ->
         pick scheme
         offer attributes
                                      <-   Key_Response
                                              pick anonymity method
                                              offer attributes

                             generate shared-key

      Signature_Message               ->
         make SPI
         pick key generation
         pick SPI attributes
         sign
                                      <-   Signature_Message
                                              make SPI
                                              pick key generation
                                              pick SPI attributes
                                              sign

                                  (optional)

      Change_Message(s)               ->
                                      <-   Change_Message(s)


   1.    The "Cookie" Exchange guards against simple flooding attacks
         with bogus IP Source addresses.

   2.    The Key Value Exchange establishes a shared-key between the
         parties.  The Responder remains stateless until a shared-key
         has been created.

   3.    The Signature Exchange of digital signatures over values sent
         in phases 1 and 2 verifies their integrity and the identities
         of the two parties.

         The shared-secret provides a basis to generate SPI session-
         keys, which are in turn used for conventional authentication or



Karn & Simpson           expires in six months                  [Page 6]
DRAFT                           Photuris                  September 1995


         encryption.  Additional security parameters are also exchanged
         as needed.

         This exchange may be encrypted, using the shared-secret itself,
         to protect the identities of the parties and the security
         parameter values of the Security Association.

   4.    Additional messages may be exchanged to periodically change the
         session-keys, and to establish new or revised security
         parameters.

         These exchanges may also be encrypted in the same fashion as
         above.

   Either party may initiate an exchange at any time.  For example, the
   Initiator need not be a "caller" in a telephony link.

   The Initiator is responsible for recovering from all message losses
   by retransmission.

   When both parties initiate Photuris key establishment concurrently,
   or one party initiates more than one Photuris exchange, the Initiator
   Cookies (and UDP Ports) keep the sessions separate.  This results in
   more than one initial SPI for each Destination.

   There is no requirement that all such outstanding SPIs be used.  The
   SPI User (sender) chooses the appropriate SPI for each transmission.


   Implementation Notes:

      To provide user-oriented keying, or create multiple Security
      Associations with different parameters, the sender can either
      initiate multiple Photuris exchanges, or send a Change_Message.

      The Destination MUST be capable of maintaining multiple Security
      Associations (SPI values) for each Source.

      It is the responsibility of the Source to internally segregate the
      different session-keys provided by the Destination.



2.1.  UDP

   All Photuris messages use the User Datagram Protocol header [RFC-
   768].  The Initiator sends to UDP Destination Port 468.  The
   Responder reverses the IP Source and Destination, and the UDP Source



Karn & Simpson           expires in six months                  [Page 7]
DRAFT                           Photuris                  September 1995


   and Destination Ports.

   The UDP checksum MUST be correctly calculated when sent.  When a
   message is received with an incorrect UDP checksum, it is silently
   discarded.



2.2.  Header Format

   All of the messages have a format similar to the following, as
   transmitted left to right in network order (most significant to least
   significant):

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Initiator-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Responder-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |
   +-+-+-+-+-+-+-+-+


   Initiator-Cookie  16 octets.

   Responder-Cookie  16 octets.

   Type             Each message type has a unique value.

   Further details and differences are elaborated in the individual
   messages.



2.3.  Exchange Schemes

   Selection among several different schemes is needed to enable
   experimental and proprietary extensions without affecting the basic
   protocol.  The Initiator of the exchange specifies a list of the
   schemes supported, and the Responder chooses one which it also
   supports.

   The scheme list includes alternative algorithms and distinguishing
   parameters (such as moduli).  These are mixed in the same list for



Karn & Simpson           expires in six months                  [Page 8]
DRAFT                           Photuris                  September 1995


   simplicity.  The implementation can easily distinguish between the
   separate uses of each supported scheme, as indicated in the "Exchange
   Scheme List" Appendix.



2.4.  Attributes

   Selection among several different attributes is needed to enable
   future implementation changes without affecting the basic protocol.
   Each party (the sender) offers a list of the attributes supported and
   its peer (the receiver) selects from that list when making its
   incoming Security Associations.

   The attribute list includes authentication, compression, encryption,
   labelling, operational, and signature types.  These are mixed in the
   same list for simplicity.  The implementation can easily distinguish
   between the separate uses of each supported attribute, as indicated
   in the "Attribute List" Appendix.

   Each party may select one or more encryption methods.  Encryption
   policy is in the SPI User (sender) direction.

   Only the sender knows whether each datagram needs privacy protection,
   and it uses an encryption SPI created by the receiver, in addition to
   an authentication SPI (as needed).  In the case that the sender needs
   privacy protection for a datagram, and the potential receiver has not
   yet created an encryption SPI, an Error_Message listing encryption
   attributes is sent and the original datagram is discarded.

   Each party may select one or more authentication methods.
   Authentication policy is in the SPI Owner (receiver) direction.

   Only the receiver can determine that arriving traffic is authentic.
   Its need for authentication is indicated by choosing authentication
   attributes, and/or authenticated encryption attributes, when creating
   each SPI.  It enforces the authentication through the simple
   expedient of dropping all datagrams with missing or invalid
   authentication.


   Implementation Notes:

      Support for some attributes is required (MD5 and DES-CBC), and
      MUST be present in every Offered-Attributes list.  It is not
      required that a Security Association be created including every
      such attribute.




Karn & Simpson           expires in six months                  [Page 9]
DRAFT                           Photuris                  September 1995


      Typically, an encryption method is chosen for the primary
      attribute of the SPI, and an authentication method is later added
      for the same SPI, or as an additional separate SPI.

      The authentication, compression, encryption and signature
      mechanisms, as well as the encapsulation mode (if any), need not
      be the same in both directions.



2.5.  Variable Precision Numbers

   Many of the message fields require a value which may vary in the
   number of bits.  These bits may not make up an integral number of
   octets.  Each variable precision number is composed of two parts.

   Size             2 octets.  Number of bits used in the value.  Always
                    transmitted most significant octet first.

   Value            variable.  The bits used are right justified and
                    zero filled on octet boundaries; that is, any unused
                    bits are in the most significant octet.  Always
                    transmitted most significant octet first.




























Karn & Simpson           expires in six months                 [Page 10]
DRAFT                           Photuris                  September 1995


3.  Cookie Exchange

3.1.  Cookie_Request

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Initiator-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Responder-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |
   +-+-+-+-+-+-+-+-+


   Initiator-Cookie  16 octets.  A randomized value which identifies the
                    exchange.

   Responder-Cookie  16 octets.  Unused.  Zero filled.

   Type             0

   The Initiator initializes local state, and sends a Cookie_Request to
   the Responder.

   The Initiator also starts a retransmission timer.  If no
   Cookie_Response is obtained within the time limit, the Cookie_Request
   is retransmitted.  The Initiator-Cookie value in each such
   retransmission to the same IP Destination and UDP Port SHOULD be the
   same.



















Karn & Simpson           expires in six months                 [Page 11]
DRAFT                           Photuris                  September 1995


3.2.  Cookie_Response

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Initiator-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Responder-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |    Reserved     |  Offered-Schemes ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


   Initiator-Cookie  16 octets.  Copied from the Cookie_Request.

   Responder-Cookie  16 octets.  A randomized value which identifies the
                    exchange.

   Type             1

   Reserved         1 octet.  Unused.  Zero filled.

   Offered-Schemes  variable.  A list of one or more exchange schemes
                    supported by the Responder, in increasing order of
                    preference.

                    Each value is two octets (see "Exchange Scheme
                    Table" Appendix).  The end of the list is indicated
                    by the Length of the UDP datagram.

   On receipt of a Cookie_Request, the Responder determines if there are
   sufficient resources to begin another Photuris exchange.  When too
   many SPI values are already in use for this particular peer, or some
   other resource limit is reached, an Error_Message is sent.

   Otherwise, the Responder generates a cookie, and returns it in a
   Cookie_Response.  The Responder-Cookie value in each successive
   response MAY be different.

   Note that the Responder creates no additional state at this time.



3.3.  Cookie Generation

   The exact technique by which a Photuris party generates a cookie is



Karn & Simpson           expires in six months                 [Page 12]
DRAFT                           Photuris                  September 1995


   implementation dependent.  The function chosen must satisfy some
   basic requirements:

   1.    The cookie must depend on the specific parties.  This prevents
         an attacker from obtaining a cookie using a real IP address and
         UDP port, and then using it to swamp the victim with requests
         from randomly chosen IP addresses or ports.

   2.    It must not be possible for anyone other than the issuing
         entity to generate cookies which will be accepted by that
         entity.  This implies that the issuing entity must use local
         secret information in the generation and subsequent
         verification of a cookie.  It must not be possible to deduce
         this secret information from any particular cookie.

   3.    The cookie generation and verification functions must be fast
         to thwart attacks intended to sabotage CPU resources.

   A recommended technique is to calculate a cryptographic one-way hash
   function (such as MD5) over the IP Source and Destination addresses,
   the UDP Source and Destination ports, and a locally generated secret
   random value.  An incoming cookie can be verified at any time by
   regenerating it locally from values contained in the incoming IP
   datagram and the local secret random value.


   Initiator

      The Initiator secret random value which affects the cookie SHOULD
      change for each new Photuris exchange, and is thereafter
      internally cached on a per Responder basis.  This provides
      improved synchronization and protection against replay attacks.

      An alternative is to cache the cookie instead of the secret value.
      Incoming cookies can be compared directly without the
      computational cost of regeneration.


   Responder

      The Responder secret random value MAY remain the same for many
      different Initiators, and is not cached per Initiator to avoid
      saving state during the initial exchange.  Instead, the secret
      SHOULD be changed at the same frequency as its Exchange-Value.

      During the initial Cookie Exchange, the Responder needs to
      regenerate its cookie.  Once the Key_Request is received, both
      Initiator and Responder cookies are cached to identify the
      exchange.


Karn & Simpson           expires in six months                 [Page 13]
DRAFT                           Photuris                  September 1995


4.  Value Exchange

4.1.  Key_Request

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Initiator-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Responder-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |    Reserved     |       Scheme-Choice         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                   Initiator-Exchange-Value                    ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Initiator-Offered-Attributes ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-


   Initiator-Cookie  16 octets.  Copied from the Cookie_Response.

   Responder-Cookie  16 octets.  Copied from the Cookie_Response.

   Type             2

   Reserved         1 octet.  Unused.  Zero filled.

   Scheme-Choice    2 octets.  A value selected by the Initiator from
                    the list of Offered-Schemes in the Cookie_Response.

   Initiator-Exchange-Value
                    variable precision number.  Provided by the
                    Initiator for calculating a shared-secret between
                    the parties.

                    The format is indicated by the Scheme-Choice.
                    Although the field is depicted as 32-bit aligned for
                    convenience, the size may be shorter or longer, as
                    indicated by its integral Size field.

   Initiator-Offered-Attributes
                    variable.  A list of three or more Security
                    Parameter attributes supported by the Initiator, in
                    increasing order of preference.



Karn & Simpson           expires in six months                 [Page 14]
DRAFT                           Photuris                  September 1995


                    The formats are specified in the "Attribute List"
                    Appendix.  The end of the list is indicated by the
                    Length of the UDP datagram.

   On receipt of a Cookie_Response, the Initiator validates the
   Initiator-Cookie.  Invalid messages are silently discarded.

   When a valid Cookie_Response is received, a Key_Request is sent.
   Later Cookie_Responses between the same parties are silently
   discarded, until a new Cookie_Request is sent.

   The Initiator also starts a retransmission timer.  If no valid
   Key_Response is obtained within the time limit, the same Key_Request
   is retransmitted.





































Karn & Simpson           expires in six months                 [Page 15]
DRAFT                           Photuris                  September 1995


4.2.  Key_Response

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Initiator-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Responder-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |    Reserved     |      Anonymity-Choice       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                   Responder-Exchange-Value                    ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Responder-Offered-Attributes ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-


   Initiator-Cookie  16 octets.  Copied from the Key_Request.

   Responder-Cookie  16 octets.  Copied from the Key_Request.

   Type             3

   Reserved         1 octet.  Unused.  Zero filled.

   Anonymity-Choice  variable.  An optional encryption method selected
                    by the Responder from the list of Initiator-
                    Offered-Attributes in the Key_Request.

                    This encryption method is used to protect the
                    Signature_Messages and Change_Messages.  It is
                    separate from any encryption specified in later
                    Security Associations.

                    When no anonymity protection is in use, the value is
                    two octets of zero.

                    Although the field is depicted as 16-bits for
                    convenience, the size may be longer, as indicated by
                    its Length field.

   Responder-Exchange-Value
                    variable precision number.  Provided by the
                    Responder for calculating a shared-secret between



Karn & Simpson           expires in six months                 [Page 16]
DRAFT                           Photuris                  September 1995


                    the parties.

                    The format is indicated by the Scheme-Choice.
                    Although the field is depicted as 32-bit aligned for
                    convenience, the size may be shorter or longer, as
                    indicated by its integral Size field.

   Responder-Offered-Attributes
                    variable.  A list of three or more Security
                    Parameter attributes supported by the Responder, in
                    increasing order of preference.

                    The formats are specified in the "Attribute List"
                    Appendix.  The end of the list is indicated by the
                    Length of the UDP datagram.

   On receipt of a Key_Request, the Responder validates the Responder-
   Cookie.  Whenever an old (or invalid) cookie is detected by the
   Responder, an Error_Message is sent.

   When a valid Key_Request has been received, a Key_Response is sent.

   The Responder keeps a copy of the incoming Key_Request values, and
   its Key_Response.  If a duplicate Key_Request is received, it merely
   resends its previous Key_Response, and takes no further action.


   Implementation Notes:

      At this time, the Responder begins calculation of the shared-
      secret.  This may take a substantial amount of time.  The
      implementor should ensure that retransmission is not blocked by
      this calculation.  This is not usually a problem, as
      retransmission timeouts typically exceed calculation time.

















Karn & Simpson           expires in six months                 [Page 17]
DRAFT                           Photuris                  September 1995


5.  Signature Exchange

5.1.  Signature_Message

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Initiator-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Responder-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |                    LifeTime                   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                   Security-Parameter-Index                    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |        Signature-Choice       |                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
   |                                                               |
   ~                           Signature                           ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                          Certificate                          ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Key-Generator-Choice      |  Attribute-Choices ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                             ... Padding           |  Pad Length   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


   Initiator-Cookie  16 octets.  Copied from the Key_Request.

   Responder-Cookie  16 octets.  Copied from the Key_Request.

   Type             4

   LifeTime         3 octets.  The number of seconds remaining before
                    the indicated SPI expires.  Must be greater than
                    zero.

   Security-Parameter-Index
                    4 octets.  The SPI to be used for incoming
                    communications.

   Signature-Choice variable.  An authentication method or certificate



Karn & Simpson           expires in six months                 [Page 18]
DRAFT                           Photuris                  September 1995


                    attribute is selected from the list of Offered-
                    Attributes sent by the peer, and is used to
                    calculate the Signature.

                    This method is not necessarily the same as any SPI
                    Attribute-Choices in use.

                    Although the field is depicted as 16-bits for
                    convenience, the size may be longer, as indicated by
                    its Length field.

   Signature        variable precision number.  The result of the
                    Signature-Choice.

                    The content is outside the scope of this
                    specification.  Although the field is depicted as
                    32-bit aligned for convenience, the size may be
                    shorter or longer, as indicated by its integral Size
                    field.

   Certificate      variable precision number.  When the Signature-
                    Choice indicates a certification method, such as
                    X.509, PGP or DNS-SIG, the certificate is included.

                    The content is outside the scope of this
                    specification.  Although the field is depicted as
                    32-bit aligned for convenience, the size may be
                    shorter or longer, as indicated by its integral Size
                    field.

   Key-Generator-Choice
                    variable.  A cryptographic hash function is selected
                    from the peer's list of supported Attributes, and is
                    used to calculate the session-key.

                    This method is not necessarily the same as any SPI
                    Attribute-Choices in use.

                    Although the field is depicted as 16-bits for
                    convenience, the size may be longer, as indicated by
                    its Length field.

   Attribute-Choices
                    variable.  A list of one or more attributes for the
                    Security Association.

                    The formats are specified in the "Attribute List"
                    Appendix.  The end of the list is indicated by the



Karn & Simpson           expires in six months                 [Page 19]
DRAFT                           Photuris                  September 1995


                    Length of the UDP datagram minus the Pad Length and
                    Padding.

   Padding

      variable.  Prior to encryption, it is filled with unspecified
      implementation dependent (preferably random) values, to align the
      Pad Length field at a boundary appropriate to the Anonymity-
      Choice.

      After decryption, it MUST be ignored.

   Pad Length

      1 octet.  This field indicates the size of the Padding field.  It
      does not include the Pad Length fields.  The value typically ranges
      from 0 to 7, but may be up to 255 to permit hiding of the actual data
      length.

      This field is opaque.  That is, the value is set prior to encryption,
      and is examined only after decryption.

   On receipt of a valid Key_Response, the Initiator begins its parallel
   computation of the shared-secret.  When the Initiator completes
   computation, it sends a Signature_Message to the Responder.

   The Initiator also starts a retransmission timer.  If no
   Signature_Message response is obtained within the time limit, the same
   Signature_Message request is retransmitted.

   When the Responder completes its parallel computation of the shared-
   secret, and upon receipt of a valid Signature_Message, it sends a
   Signature_Message to the Initiator.

   The Responder keeps a copy of the incoming Signature_Message values, and
   its Signature_Message.  If a duplicate Signature_Message is received, it
   merely resends its previous Signature_Message, and takes no further
   action.


   Implementation Notes:

      Calculation of the shared-secret by the Initiator and Responder is
      executed in parallel to minimize delay.

      The scheme, exchange-values, and resulting shared-secret SHOULD be
      cached.  When multiple Photuris exchanges occur between the same
      parties, and the exchange-values are discovered to be unchanged, the



Karn & Simpson           expires in six months                 [Page 20]
DRAFT                           Photuris                  September 1995


      cached shared-secret can be used to rapidly generate new session-
      keys.



5.2.  Anonymity

   This message is required to be encrypted using the Anonymity-Choice
   indicated in the Key_Response.  The chosen algorithm does not need to
   provide integrity, as sufficient integrity is provided by the
   signature verification.

   A special anonymity session-key is generated from the Anonymity-
   Choice specified cryptographic hash calculated over the following
   concatenated values:

   +  the computed shared-secret,

   +  the SPI Owner (receiver) Exchange-Value,

   +  the SPI User (sender) Exchange-Value,

   +  the SPI Owner (receiver) Cookie,

   +  the SPI User (sender) Cookie.

   Since the order of the Exchange-Values and Cookies is different in
   each direction, the resulting anonymity session-key will usually be
   different in each direction.



5.3.  Verification

   The two parties now verify the signatures received.  The indicated
   Signature-Choice is calculated over the following concatenated
   values:

   +  the computed shared-secret,

   +  the Offered-Schemes,

   +  the SPI Owner (receiver) Exchange-Value,

   +  the SPI User (sender) Exchange-Value,

   +  the SPI Owner (receiver) Offered-Attributes,




Karn & Simpson           expires in six months                 [Page 21]
DRAFT                           Photuris                  September 1995


   +  the SPI User (sender) Offered-Attributes,

   +  the Type, LifeTime and SPI,

   +  the Certificate (which may be specially handled),

   +  the contents of the remainder of the message following the
      Certificate.

   Note that the order of the Exchange-Values and Offered-Attributes is
   different in each direction.

   If the verification fails, the users are notified, an Error_Message
   is sent, and the Security Association is destroyed.  On success,
   normal operation begins with the authentication and/or encryption of
   user datagrams.


   Implementation Notes:

      Any authenticated and/or encrypted user datagrams received before
      the completion of signature verification can be placed on a queue
      pending completion of this step.  If the verification succeeds,
      the queue is processed as though the datagrams had arrived
      subsequent to the verification.  If the verification fails, the
      queue is discarded.

      Early implementations may wish to keep their own trusted key
      databases, such as the Pretty Good Privacy web of trust, and
      accept only those users found there.

      Each party implements local policy that determines what access, if
      any, is granted to the holder of a particular certification.



5.4.  Session-Key Computation

   Each SPI session-key is generated from the Key-Generator-Choice
   cryptographic hash calculated over the following concatenated values:

   +  the computed shared-secret,

   +  the SPI Owner (receiver) Signature,

   +  the SPI User (sender) Signature,

   +  the SPI Owner (receiver) Cookie,



Karn & Simpson           expires in six months                 [Page 22]
DRAFT                           Photuris                  September 1995


   +  the SPI User (sender) Cookie,

   +  the SPI.

   Since the SPI is likely to be different in each direction, and the
   order of the Signatures and Cookies is different in each direction,
   the resulting session-key will usually be different in each
   direction.











































Karn & Simpson           expires in six months                 [Page 23]
DRAFT                           Photuris                  September 1995


6.  Other Message Types

6.1.  Change_Message

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Initiator-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Responder-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |                    LifeTime                   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                   Security-Parameter-Index                    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |        Validity-Choice        |                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
   |                                                               |
   ~                         Verification                          ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Key-Generator-Choice      |  Attribute-Choices ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                             ... Padding           |  Pad Length   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


   Initiator-Cookie  16 octets.  Copied from the Key_Request.

   Responder-Cookie  16 octets.  Copied from the Key_Request.

   Type             5

   LifeTime         3 octets.  The number of seconds remaining before
                    the indicated SPI expires.  The value zero indicates
                    deletion of the indicated SPI.

   Security-Parameter-Index
                    4 octets.  The SPI to be used for incoming
                    communications.  This may be a new SPI value (for
                    creation), or an existing SPI value (for deletion).
                    The value zero indicates all old SPIs for this IP
                    Destination (typically used for deletion).

   Validity-Choice  variable.  A cryptographic hash function is selected
                    from the peer's list of supported Attributes, and



Karn & Simpson           expires in six months                 [Page 24]
DRAFT                           Photuris                  September 1995


                    used to provide message integrity.

                    This method is not necessarily the same as any SPI
                    Attribute-Choice in use.

                    Although the field is depicted as 16-bits for
                    convenience, the size may be longer, as indicated by
                    its Length field.

   Verification     variable precision number.  The result of the
                    Validity-Choice.

                    The calculation of the value is described in the
                    Verification section.  Although the field is
                    depicted as 32-bit aligned for convenience, the size
                    may be shorter or longer, as indicated by its
                    integral Size field.

   Key-Generator-Choice
                    variable.  A cryptographic hash function is selected
                    from the peer's list of supported Attributes, and is
                    used to calculate the session-key.

                    This method is not necessarily the same as any SPI
                    Attribute-Choices in use.

                    Although the field is depicted as 16-bits for
                    convenience, the size may be longer, as indicated by
                    its Length field.

   Attribute-Choices
                    variable.  A list of one or more attributes for the
                    Security Association, selected from the list of
                    Attributes sent by the peer.

                    The formats are specified in the "Attribute List"
                    Appendix.  The end of the list is indicated by the
                    Length of the UDP datagram minus the Pad Length and
                    Padding.

   Padding

      variable.  Prior to encryption, it is filled with unspecified
      implementation dependent (preferably random) values, to align the
      Pad Length field at a boundary appropriate to the Anonymity-
      Choice.

      After decryption, it MUST be ignored.



Karn & Simpson           expires in six months                 [Page 25]
DRAFT                           Photuris                  September 1995


   Pad Length

      This field indicates the size of the Padding field.  It does not
      include the Pad Length fields.  The value typically ranges from 0 to
      7, but may be up to 255 to permit hiding of the actual data length.

      This field is opaque.  That is, the value is set prior to encryption,
      and is examined only after decryption.

   At any time after the validation of signatures, either party can send a
   Change_Message.  The message has effect in only one direction, from the
   SPI Owner to the SPI User.

   This message is required to be encrypted in the same fashion described
   for the Signature_Message.



6.2.  Creation
   This message can be used to create a new Security Association.
   Frequently, this message is used to create a separate authentication
   SPI when the primary SPI is used for encryption.

   In addition, this message allows more rapid SPI creation for high
   bandwidth applications.  The messages flow in the opposite direction
   from the primary traffic flow.

   A new session-key is calculated using the Key-Generator-Choice in the
   same fashion as the Signature_Message.  The cached shared-secret
   remains the same; thus, no new exponentiation or signature
   verification is needed.  Since the SPI value is different, the
   resulting session-key will necessarily be different from all others
   used in the same direction.

   When the peer's cookie or public-value has expired, it will send an
   Error_Message response.  The party begins a new Photuris exchange
   again from the Cookie_Request.

   When the peer finds that too many SPI values are already in use for
   this party, or some other resource limit is reached, it will send an
   Error_Message response.

   No retransmission timer is necessary.  Success is indicated by the
   peer use of the new SPI.

   Should all creation attempts fail, eventually the peer will find that
   all existing SPIs have expired, and begin the Photuris exchange again
   from the Cookie_Request.



Karn & Simpson           expires in six months                 [Page 26]
DRAFT                           Photuris                  September 1995


6.3.  Deletion
   This message can be used to delete existing Security Associations.
   This is especially useful when all associations need deletion, such
   as when the application which needed them terminates.

   No retransmission timer is necessary.

   Should all deletion attempts fail, eventually the peer will expire
   all existing SPIs through the normal LifeTime, and begin the Photuris
   exchange again from the Cookie_Request.



6.4.  Verification

   This message requires independent verification of integrity, to
   prevent malicious forgery of Security Attributes after the more
   computationally intensive Signature Exchange.

   The indicated Validity-Choice is calculated over the following
   concatenated values:

   +  the computed shared-secret,

   +  the SPI Owner (receiver) Signature,

   +  the SPI User (sender) Signature,

   +  the SPI Owner (receiver) Cookie,

   +  the SPI User (sender) Cookie,

   +  the contents of the message beginning with the UDP Header.

   Note that the order of the Signatures and Cookies is different in
   each direction.

   If the verification fails, the users are notified, an Error_Message
   is sent, and the Security Association is destroyed.  On success,
   normal operation begins with the authentication and/or encryption of
   user datagrams.


   Implementation Notes:

      The Verification value is calculated prior to anonymity
      encryption, and verified after decryption.




Karn & Simpson           expires in six months                 [Page 27]
DRAFT                           Photuris                  September 1995


      The Verification field is treated as zero during the calculation
      of the Validity-Choice.

      This validation value is different from the anonymity session-key
      which is used to protect the message.  However, the initial octets
      of the concatenated values are the same, and the implementor may
      save some calculation effort when the generating functions are the
      same.











































Karn & Simpson           expires in six months                 [Page 28]
DRAFT                           Photuris                  September 1995


6.5.  Error_Message

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Initiator-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   ~                       Responder-Cookie                        ~
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |     Code      |  Attributes-Needed ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-


   Initiator-Cookie  16 octets.  Copied from the offending message.

   Responder-Cookie  16 octets.  Copied from the offending message.

   Type             7

   Code             Indicates the problem:

                      0   reserved
                      1   invalid/expired
                      2   resource limit
                      3   verification failure
                      4   need attributes


   Attributes-Needed
                    variable.  A list of zero or more attributes (for
                    Code 4).

                    The formats are specified in the "Attribute List"
                    Appendix.  The end of the list is indicated by the
                    Length of the UDP datagram.

   Issued in response to Photuris state loss or other problems.  The
   message has effect in only one direction.  No retransmission timer is
   necessary.

   This message is not encrypted in the fashion described for the
   Signature_Message.







Karn & Simpson           expires in six months                 [Page 29]
DRAFT                           Photuris                  September 1995


6.6.  Invalid/Expired
   This Error_Message Code is sent when certain Photuris messages are
   received (as indicated in the accompanying description), and the
   receiver's cookie is invalid or the associated public-value has
   expired.

   When this Code is received, the shared-secret and other state between
   the parties is purged, and a new Cookie_Request is sent instead.

   However, existing SPIs are not deleted.  They expire normally, and
   are purged sometime later.



6.7.  Resource Limit
   This Error_Message Code is sent when a Cookie_Request or
   Change_Message is received, and too many SPI values are already in
   use for that peer, or some other Photuris resource is unavailable.

   When this Code is received, the party SHOULD NOT instantiate another
   SPI until it has deleted an existing SPI, or waited for a cached SPI
   entry to expire.



6.8.  Verification Failure
   This Error_Message Code is sent when a Signature_Message or
   Change_Message is received, and verification fails.

   When this Code is received, the implementation SHOULD log the
   occurance, and notify an operator as appropriate.



6.9.  Need Attributes
   This Error_Message Code is sent when a party needs particular
   attributes for a datagram (such as encryption), and the peer has not
   yet created a Security Association (SPI) which has those attributes.
   The missing attributes are included in the Error_Message.

   When this Code is received, the party SHOULD send a Change_Message
   which includes the necessary attributes.









Karn & Simpson           expires in six months                 [Page 30]
DRAFT                           Photuris                  September 1995


7.  Public Key Exchanges
   Photuris is based on public-key cryptography, specifically Diffie-
   Hellman key exchange.  Exchange of D-H exchange-values based on
   private/secret values results in a mutual shared-secret between the
   parties.  This shared-secret can be used on its own, or to generate a
   series of session-keys for authentication and encryption of
   subsequent traffic.

   Widespread deployment and use of an Internet Security protocol is
   possible without public-key cryptography.  For example, Kerberos
   [Kerberos] can generate host-pair keys for use in Internet Security,
   much as it now generates session-keys for use by encrypted telnet and
   other "kerberized" applications.

   The Kerberos model has some widely recognized drawbacks.  Foremost is
   the requirement for a highly available on-line Key Distribution
   Center (KDC), with a database containing every principal's secret-
   key.  This carries significant security risks.

   Public-key cryptography enables decentralization.  Entities generate
   session-keys without real-time communication with any other party.

   This draft assumes familiarity with the Diffie-Hellman public-key
   algorithm.  A good description can be found in [Schneier94].



7.1.  Perfect Forward Secrecy

   Many security breaches in cryptographic systems have been facilitated
   by designs which generate traffic-encrypting keys (or their
   equivalents) well before they are needed, and then keep them around
   longer than necessary.  This creates many opportunities for
   compromise, especially by insiders.  A carefully designed public-key
   system can avoid this problem.

   The rule is to avoid using any long-lived keys (such as an RSA key-
   pair) to encrypt session-keys or actual traffic.  Such keys should be
   used solely for authentication purposes.

   All keys for traffic encryption should be randomly generated
   immediately before use, and then destroyed immediately after use, so
   that they cannot be recovered.  The keys should not be based on the
   values of any previous keys, or any other long-lived stored
   information.

   The Photuris exchange messages can provide perfect forward secrecy,
   as defined by Diffie [Diffie90], using a combination of Diffie-



Karn & Simpson           expires in six months                 [Page 31]
DRAFT                           Photuris                  September 1995


   Hellman (for key exchange) and digital signature authentication, as
   follows:

   1.    Agree on a shared-secret using the Diffie-Hellman algorithm.

   2.    Authenticate the Diffie-Hellman exchanges with a digital
         signature algorithm, such as RSA or DSS.  This authenticates
         the parties to each other, thwarting the "man in the middle"
         active attack against Diffie-Hellman.

   When the shared-secret generated in step 1 is eventually destroyed,
   it is unrecoverable.

   Theft of the private/secret key used to sign the exchanges in step 2
   would allow the thief to impersonate the party in future
   conversations, but it would not decode any past traffic that might
   have been recorded.



7.2.  Traffic Anonymity

   As noted above, a fundamental role of a key management protocol is to
   verify the identities of the communicating parties to each other.
   One would often like to deny this information to an eavesdropper,
   especially when this would reveal the location of a user.  Although
   each datagram carries a cleartext IP Destination address, the
   ultimate destination could be hidden by "laundering" it through an
   encrypted tunnel.

   A user's IP Source address could be hidden in the same manner.  If
   the address has been dynamically allocated, it provides no useful
   information to an eavesdropper.

   This leaves the identifying authentication information that the user
   sends during key exchange.  The identification can be easily
   protected in the Photuris protocol by encrypting the digital
   signature exchanges with the shared-secret just established with
   Diffie-Hellman.  This keeps a passive eavesdropper from learning the
   identities of the parties by intercepting possible exchanges of
   public keys and certificates, or by checking the signatures against a
   known database of public keys.

   The scheme is not foolproof.  By posing as the Responder, an active
   attacker could trick the Initiator into revealing its identity.
   However, this active attack is considerably more difficult than
   passive vacuum-cleaner monitoring.  Unless the attacker can steal the
   private/secret key belonging to the Responder, the Initiator will



Karn & Simpson           expires in six months                 [Page 32]
DRAFT                           Photuris                  September 1995


   discover the deception when checking the digital signature of the key
   exchange.



7.3.  Modular Exponentiation Groups

   The original Diffie-Hellman technique specified modular
   exponentiation.  A exchange-value is generated using a generator (g),
   raised to a private/secret exponent (x), modulo a prime (p).

      (g**x) mod p

   When two of these exchange-values are exchanged between parties, the
   parties can calculate a shared-secret value between themselves.

   Each modular exponentiation prime (p) must have the property that
   both p and (p-1)/2 are prime.  A small set of such recommended strong
   primes for use as Photuris moduli are specified.

   Use of a very limited number of moduli (preferably one) has one minor
   and two very significant advantages:


   Overhead

      Avoiding the overhead of sending the full modulus.


   Prime and Generator Pair Selection

      Discovery of strong primes is extremely computationally intensive,
      and practically impossible for commercially available processors
      to find in a reasonable interactive time.  Thus, the primes used
      will be well-known, and embedded in the implementations.

      The generator (g) should be chosen such that the secret exponents
      will generate all possible public exponential values, evenly
      distributed throughout the range, without cycling through a
      smaller subset.  Such a generator is called a "primitive root"
      (which is trivial to find when p is strong) [!!! reference].

      When the strong prime and generator pair are well chosen, the
      difficulty of a discrete log attack is maximized.  By choosing the
      pairs in advance, thorough analysis of the pair characteristics is
      possible.  This analysis can promote confidence in the security of
      the implementations.




Karn & Simpson           expires in six months                 [Page 33]
DRAFT                           Photuris                  September 1995


   Precomputation

      Each party can precompute the D-H exchange-value.

      A background process can periodically destroy the old values,
      generate a new random secret exponent, and recalculate the
      exchange-value.  This limits the exposure of both the secret
      exponent and shared-secret, as past secrets are not kept for
      possible discovery by a future intrusion, protecting earlier
      communications.  Also, the secret exponent currently in use is
      less likely to be anticipated, as the element of random timing is
      introduced.

      Since these operations involve several time-consuming modular
      exponentiations, moving them to the "background" substantially
      speeds up the apparent execution speed of the Photuris protocol.
      It also reduces CPU loading sufficiently to allow a single
      public/private key-pair to be used in several closely spaced
      Photuris executions, when setting up Security Associations with
      several different hosts over a short period of time.

      Other precomputation suggestions are described in [BGMW93].

   There is surprisingly little guidance in the literature about how
   large the randomly chosen secret exponent in Diffie-Hellman should
   be.  The size of this exponent dramatically affects the speed of both
   modular exponentiations involved in Diffie-Hellman.

   The exponent 0 will generate the public value 1, and exponent 1 will
   generate the public value g mod p.  These exponents do not qualify as
   secret.  In general, small secret exponent values should not be used.

   Therefore, it is desirable to use the smallest random exponent that
   is consistent with good security.  The most conservative advice
   received to date [Hellman95] is to make the random exponent twice as
   long as the intended session-key.  This ensures that any space/time
   "meet in the middle" attack on the discrete logarithm problem will be
   at least as complex as a brute-force search on the resulting
   session-key space.


   Implementation Notes:

      A single modular exponentiation on a 486-66DX2 processor using
      RSAREF and Borland C under MS-DOS took 20 seconds with a 1024-bit
      prime modulus and a 1024-bit random exponent.  This dropped to
      about 1 to 1.5 seconds when the random exponent was shortened to
      128 bits, with the same 1024-bit modulus.



Karn & Simpson           expires in six months                 [Page 34]
DRAFT                           Photuris                  September 1995


      The size of the exponent is entirely implementation dependent, is
      unknown to the other party, and can be easily changed.



7.4.  Elliptic Curve Groups

   The points on an elliptic curve form a group under addition.  This
   group can be used as the basis for the efficient implementation of
   the Diffie-Hellman operations.  To uniquely specify the computation,
   the implementor must know the finite field for representation of the
   point coordinates, the elliptic curve, and the generator.

   The elliptic curve addition formulas are more complicated than
   straight-forward component-wise addition, and the use of finite
   fields further complicates the description of the algorithms.  A good
   reference for a succinct description of elliptic curves with finite
   fields is [P1363]; a more general treatment can be found in
   [Menezes].

      Note that while the literature uses the term "addition" for the
      group operation, it is directly analogous to "multiplication" in
      modular exponentiation groups.  Thus, the analogous term for
      "g**r" is "r*g" (that is, the scalar multiple r of g).

   The generator is specified as the (x,y) coordinates of an elliptic
   curve point, and the representation of x and y is given with respect
   to a finite field.  Multiples of the generator are (x,y) pairs.
   Thus, the Initiator and Responder D-H exchange-values are to be
   interpreted as two concatenated bit values in the order (x,y).  The
   lengths of the numbers are implicit in the specification of the
   field.

   The field representation is uniquely determined by the irreducible
   polynomial specified in the group description.  See the "Exchange
   Scheme Table" Appendix.

   Use of a very limited number of fields has similar advantages to
   those cited for modular exponentiation: reduced overhead, generator
   selection, and precomputation of the exchange-values.











Karn & Simpson           expires in six months                 [Page 35]
DRAFT                           Photuris                  September 1995


A.  Exchange Scheme Table

   The Exchange Scheme takes the form of a small index into a well-known
   table.  Since only the first few indices will be published, the
   remaining values may be used by cooperating parties to indicate
   private schemes.

   (1)   Implementation Optional.  Elliptic curve:

         curve: y^2 + xy = x^3 + 0x7338F
         generator: (0x7B, 0x1C8)
         irreducible polynomial: u^155 + u^62 + 1

         Provides 155 bits of keying material.

         Supplied by Hilarie Orman <ho@cs.arizona.edu>.

   (2)   Implementation Required.  A 1024-bit strong prime (p),
         expressed in hex:

         97f6 4261 cab5 05dd 2828 e13f 1d68 b6d3
         dbd0 f313 047f 40e8 56da 58cb 13b8 a1bf
         2b78 3a4c 6d59 d5f9 2afc 6cff 3d69 3f78
         b23d 4f31 60a9 502e 3efa f7ab 5e1a d5a6
         5e55 4313 828d a83b 9ff2 d941 dee9 5689
         fada ea09 36ad df19 71fe 635b 20af 4703
         6460 3c2d e059 f54b 650a d8fa 0cf7 0121
         c747 99d7 5871 32be 9b99 9bb9 b787 e8ab

         The recommended generator (g) for this prime is 2.

         Provides up to 1024 bits of keying material, depending on the
         length of the exponent used.

         This prime was randomly generated by a freely available program
         written by the author.

   (3)   Reserved.

   (4)   Reserved.

   (5)   Implementation Optional.  A 1024-bit strong prime (p),
         expressed in hex:








Karn & Simpson           expires in six months                 [Page 36]
DRAFT                           Photuris                  September 1995



         a478 8e21 84b8 d68b fe02 690e 4dbe 485b
         17a8 0bc5 f21d 680f 1a84 1313 9734 f7f2
         b0db 4e25 3750 018a ad9e 86d4 9b60 04bb
         bcf0 51f5 2fcb 66d0 c5fc a63f bfe6 3417
         3485 bbbf 7642 e9df 9c74 b85b 6855 e942
         13b8 c2d8 9162 abef f434 2435 0e96 be41
         edd4 2de9 9a69 6163 8c1d ac59 8bc9 0da0
         69b5 0c41 4d8e b865 2adc ff4a 270d 567f

         The recommended generator (g) for this prime is 5.

         Provides up to 1024 bits of keying material, depending on the
         length of the exponent used.

         This prime was randomly generated by a freely available program
         written by the author.

   (256) Moduli-indices of 256 to 65535 are available for private use.
































Karn & Simpson           expires in six months                 [Page 37]
DRAFT                           Photuris                  September 1995


B.  Attribute List

   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |    Length     |  Value ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


   Type             A unique value indicating the authentication,
                    compression, encryption, and signature types
                    available for exchange between the parties.

   Length           The length of the Value field in octets.

                    When the Type is zero, no Length field is present.

   Value            An optional value.  The size of the value is
                    indicated by the Length field.

                    When the Length is zero, no Value field is present.

   Up-to-date values for the Attribute Type are specified in the most
   recent "Assigned Numbers" [RFC-1700].  Initial values are assigned as
   follows:

      A  K I/R S  V    Type
                          0  padding
               +          1  RSA
         +  +  +  +       2  MD2
                          3  unassigned
         +  +  +  +       4  MD4
         *  *  *  *       5  MD5
         +  +  +  +       6  MD6 (reserved)
                          7  unassigned
               +          8  PGP certificate
               +          9  X.509 certificate chain
               +         10  DNS-SIG certificate
                         11  unassigned
      +     +            12  RC2
                         13  unassigned
      +     +            14  RC4
      +     +            15  RC5 (reserved)
            +            16  DES-CBC, 0-bit IV
            *            17  DES-CBC, 32-bit IV
      *     *            18  DES-CBC, 64-bit IV
                         19  unassigned
            +            20  Triple DES-CBC, 0-bit IV
            +            21  Triple DES-CBC, 32-bit IV
      +     +            22  Triple DES-CBC, 64-bit IV



Karn & Simpson           expires in six months                 [Page 38]
DRAFT                           Photuris                  September 1995


                         23  unassigned
         +  +  +  +      24  SHA
               +         25  DSS
      +     +            26  IDEA
                      27-32  unassigned
            +            33  VJ Header Compression
            +            34  LZ77
            +            35  Stac LZS
            +            36  AH-Sequence
                     37-254  unassigned
      x  x  x  x  x     255  Administratively Configured

      A              Anonymity Choice
         K           Key Choice
           I/R       Initiator/Responder Attribute Choice
               S     Signature Choice
                  V  Validity Choice
            *        algorithm must be supported
            +        feature must be supported
                     when algorithm optionally supported
            x        feature may be supported
                     when algorithm optionally supported

   Attributes which are required to be supported are included in this
   document.  Other attributes are specified elsewhere.

   Each attribute may have value fields which are multiple octets.  To
   facilitate processing efficiency, these fields are aligned on
   integral (modulo 8) octet boundaries.

   Padding is accomplished by insertion of 1 to 7 padding octets (Type
   0) before the attribute which needs alignment.

   No padding is used after the final attribute in a list.



B.1.  MD5

   There are no parameters.  The Length is 0, and there is no Value
   field.


   Key Choice

      When selected as a Key-Generator-Choice, generates 128-bits of
      keying material.




Karn & Simpson           expires in six months                 [Page 39]
DRAFT                           Photuris                  September 1995


   Attribute Choice

      When selected as an Initiator or Responder Attribute-Choice,
      pursuant to [RFC-1828], its SPI session-key uses the entire Key-
      Generator-Choice generated keying material.


   Signature Choice

      When selected as a Signature-Choice, the Certificate field
      contains a value which identifies the party.  Typically, the
      Certificate is an email address.

      The MD5 hash is calculated as described in "Signature
      Verification", but in addition includes a trailing secret-key,
      which is selected based on the contents of the Certificate field.

      The Certificate and secret-key are preconfigured.

      The resulting Signature field is 128-bits (18 octets including
      Size).


   Validity Choice

      When selected as a Validity-Choice, the hash is calculated as
      described in "Change Verification", using the entire leading
      shared-secret generated keying material.

      The resulting Verification field is 128-bits (18 octets including
      Size).



B.2.  DES-CBC

   There are no parameters.  The Length is 0, and there is no Value
   field.


   Anonymity Choice

      When selected as an Anonymity-Choice, its anonymity session-key
      uses the most significant 64-bits of MD5 generated material.  The
      least significant bit of each octet is ignored (parity).

      The 64-bit Initialization Vector (IV) is set to the Type,
      LifeTime, and Security-Parameter-Index fields.  Encryption begins



Karn & Simpson           expires in six months                 [Page 40]
DRAFT                           Photuris                  September 1995


      with the next field, and continues to the end of the data
      indicated by the IP Length.  The trailing padding is then removed.


   Attribute Choice

      When selected as an Initiator or Responder Attribute-Choice,
      pursuant to [RFC-1829], its SPI session-key uses the most
      significant 64-bits of Key-Generator-Choice generated material.
      The least significant bit of each octet is ignored (parity).









































Karn & Simpson           expires in six months                 [Page 41]
DRAFT                           Photuris                  September 1995


Security Considerations

   Security issues are the primary topic of this memo.

   The security of Photuris and Diffie-Hellman critically depends on the
   quality of the secret random numbers generated by each party.  A poor
   random number generator at either party will compromise the shared-
   secret produced by the algorithm.

   Generating cryptographic quality random numbers on a general purpose
   computer without hardware assistance is a very tricky problem.  In
   general, this requires using a cryptographic hash function to
   "distill" the entropy from a large number of semi-random external
   events, such as the timing of key strokes.  An excellent discussion
   can be found in [RFC-1750].

   The use of the calculated shared-secret for multiple Security
   Associations by hashing with a new SPI substantially depends on the
   quality of the chosen cryptographic hashing function.  Discovery of
   the underlying shared-secret would compromise all of the anonymity
   and SPI session-keys generated from it.

   This is mitigated by carefully organized differences in calculation
   of the anonymity and SPI session keys in each direction, the
   opportunity for varying hashing algorithms for each SPI, and the
   optional concealment of the hashing algorithms used for each SPI.

   The modular exponentiation, elliptic curve, and key generator
   algorithms provide a number of bits of keying material.  Use of an
   algorithm which produces a fewer number of keying bits than required
   for a selected transform results in less robust security than would
   otherwise be expected.

   It is the responsibility of the implementor to choose a useful set of
   attributes for each Security Association, which provide the best
   tradeoff of security and performance for a given application.  In
   general, when more than one attribute providing the same function is
   offered, the strongest algorithm should be offered first.



Acknowledgements

   Phil Karn is principally responsible for the design of the protocol
   phases, particularly the clogging defense, and initial internet
   security protocol implementation experience spanning more than 4
   years.




Karn & Simpson           expires in six months                 [Page 42]
DRAFT                           Photuris                  September 1995


   William Simpson was responsible for adding attributes, other message
   types, editing and formatting.  All such mistakes are his
   responsibity.

   This protocol was later discovered to have many elements in common
   with the Station-To-Station authentication protocol, described in
   [DOW92].

   Hilarie Orman provided text regarding elliptic curves, and extensive
   review of the protocol details.

   Paul C van Oorschot suggested signing both the public exponents and
   the session-key, to provide an authentication-only version of
   signature verification.

   Randall Atkinson, Cheryl Madson, James Hughes, Angelos Keromytis, and
   Perry Metzger provided useful critiques of earlier versions of this
   document.



References

   [BGMW93]  E. Brickell, D. Gordon, K. McCurley, and D. Wilson, "Fast
            Exponentiation with Precomputation (Extended Abstract)",
            Advances in Cryptology -- EUROCRYPT '92, Lecture Notes in
            Computer Science, 658 (1993), Springer-Verlag, 200-207.

   [Diffie90]
            Whitfield Diffie, "Authenticated Key Exchange and Secure
            Interactive Communication", Northern Telecom, Securicom '90,
            Paris France, 16 March 1990.

   [DOW92]  Whitfield Diffie, Paul C van Oorshot, Michael J Wiener,
            "Authentication and Authenticated Key Exchanges", Designs,
            Codes and Cryptography, v 2 pp 107-125, Kluwer Academic
            Publishers, 1992.

   [Firefly]
            "Photuris" is the latin name for the firefly.  "Firefly" is
            in turn the name for the USA National Security
            Administration's (classified) key exchange protocol for the
            STU-III secure telephone.  Informed speculation has it that
            Firefly is based on very similar design principles.

   [Hellman95]
            Martin Hellman, personal communication.




Karn & Simpson           expires in six months                 [Page 43]
DRAFT                           Photuris                  September 1995


   [Kerberos]
            Kerberos?

   [Menezes]
            Alfred J. Menezes, "Elliptic Curve Public Key
            Cryptosystems", Kluwer Academic Publishers, 1993.

   [P1363]  Alfred J. Menezes, Minghua Qu, and Scott A. Vanstone,
            "Standard for RSA, Diffie-Hellman and Related Public Key
            Cryptography", Working Draft of IEEE P1363 Standard, Oct.
            30, 1994.  http://www.rsa.com/pub/p1363/draft/

   [RFC-768]

   [RFC-1700]
            Reynolds, J., and Postel, J., "Assigned Numbers", STD 2,
            RFC-1700, USC/Information Sciences Institute, October 1994.

   [RFC-1750]
            Eastlake, Crocker & Schiller, "Randomness Recommendations
            for Security", December 1994.

   [RFC-1825]
            Atkinson, R., "Security Architecture for the Internet
            Protocol", RFC-1825, Naval Research Laboratory, July 1995.

   [RFC-1828]

   [RFC-1829]

   [Schneier94]
            Schneier, B., "Applied Cryptography", John Wiley & Sons, New
            York, NY, 1994.  ISBN 0-471-59756-2.



Author's Address

   Questions about this memo can also be directed to:

      Phil Karn
      Qualcomm, Inc.
      6455 Lusk Blvd.
      San Diego, California  92121-2779

      karn@qualcomm.com
      karn@unix.ka9q.ampr.org




Karn & Simpson           expires in six months                 [Page 44]
DRAFT                           Photuris                  September 1995


      William Allen Simpson
      Daydreamer
      Computer Systems Consulting Services
      1384 Fontaine
      Madison Heights, Michigan  48071

      Bill.Simpson@um.cc.umich.edu
          bsimpson@MorningStar.com











































Karn & Simpson           expires in six months                 [Page 45]
DRAFT                           Photuris                  September 1995


                           Table of Contents


     1.     Introduction ..........................................    1
        1.1       Terminology .....................................    1
        1.2       Clogging Defense ................................    2
        1.3       Security Parameters .............................    4
        1.4       Multicast Support ...............................    5

     2.     Protocol Description ..................................    6
        2.1       UDP .............................................    7
        2.2       Header Format ...................................    8
        2.3       Exchange Schemes ................................    8
        2.4       Attributes ......................................    9
        2.5       Variable Precision Numbers ......................   10

     3.     Cookie Exchange .......................................   11
        3.1       Cookie_Request ..................................   11
        3.2       Cookie_Response .................................   12
        3.3       Cookie Generation ...............................   12

     4.     Value Exchange ........................................   14
        4.1       Key_Request .....................................   14
        4.2       Key_Response ....................................   16

     5.     Signature Exchange ....................................   18
        5.1       Signature_Message ...............................   18
        5.2       Anonymity .......................................   21
        5.3       Verification ....................................   21
        5.4       Session-Key Computation .........................   22

     6.     Other Message Types ...................................   24
        6.1       Change_Message ..................................   24
        6.2       Creation ........................................   26
        6.3       Deletion ........................................   27
        6.4       Verification ....................................   27
        6.5       Error_Message ...................................   29
        6.6       Invalid/Expired .................................   30
        6.7       Resource Limit ..................................   30
        6.8       Verification Failure ............................   30
        6.9       Need Attributes .................................   30

     7.     Public Key Exchanges ..................................   31
        7.1       Perfect Forward Secrecy .........................   31
        7.2       Traffic Anonymity ...............................   32
        7.3       Modular Exponentiation Groups ...................   33
        7.4       Elliptic Curve Groups ...........................   35




Karn & Simpson           expires in six months                 [Page ii]
DRAFT                           Photuris                  September 1995


     APPENDICES ...................................................   36

     A.     Exchange Scheme Table .................................   36

     B.     Attribute List ........................................   38
        B.1       MD5 .............................................   39
        B.2       DES-CBC .........................................   40

     SECURITY CONSIDERATIONS ......................................   42

     ACKNOWLEDGEMENTS .............................................   42

     REFERENCES ...................................................   43

     AUTHOR'S ADDRESS .............................................   44





































