<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Diameter User-Name
    and Realm Based Request Routing Clarifications</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Diameter User-Name
    and Realm Based Request Routing Clarifications">
<meta name="keywords" content="Internet-Draft, Diameter, NAI Docoration, Routing">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Diameter Maintenance and</td><td class="header">J. Korhonen, Ed.</td></tr>
<tr><td class="header">Extensions (DIME)</td><td class="header">Nokia Siemens Networks</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">M. Jones</td></tr>
<tr><td class="header">Updates: <a href='http://tools.ietf.org/html/rfc3588'>3588</a>, <a href='http://tools.ietf.org/html/rfc3588bis'>3588bis</a></td><td class="header">Bridgewater Systems</td></tr>
<tr><td class="header">(if&nbsp;approved)</td><td class="header">L. Morand</td></tr>
<tr><td class="header">Intended status: Standards Track</td><td class="header">Orange Labs</td></tr>
<tr><td class="header">Expires: November 11, 2009</td><td class="header">T. Tsou</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Huawei</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">May 10, 2009</td></tr>
</table></td></tr></table>
<h1><br />Diameter User-Name
    and Realm Based Request Routing Clarifications<br />draft-ietf-dime-nai-routing-02.txt</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on November 11, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>This specification defines the behavior required of Diameter agents to
         route requests when the User-Name Attribute Value Pair contains a
         Network Access Identifier formatted with multiple realms. These
         multi-realm or "Decorated" Network Access Identifiers
         are used in order to force the routing of request messages through a 
         predefined list of mediating realms.
      
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#introduction">1.</a>&nbsp;
Introduction<br />
<a href="#terms">2.</a>&nbsp;
Terminology and Abbreviations<br />
<a href="#anchor1">3.</a>&nbsp;
Problem Overview<br />
<a href="#anchor2">4.</a>&nbsp;
Solution Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">4.1.</a>&nbsp;
Interpretation of Decorated NAIs<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">4.2.</a>&nbsp;
Ensuring Backwards Compatibility<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#enhanced">4.3.</a>&nbsp;
Enhanced Request Routing Solution<br />
<a href="#anchor5">5.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor6">6.</a>&nbsp;
Security Considerations<br />
<a href="#anchor7">7.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">8.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">8.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">8.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="introduction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>This specification defines the behavior required of Diameter agents to
         route requests when the User-Name Attribute Value Pair (AVP) contains
         a Network Access 
         Identifier (NAI) formatted with multiple realms (hereafter referred to
         as Decorated NAI).
         Decorated NAIs are used in order to force the routing of request
         messages through a predefined list of mediating realms. This
         specification does not define a new Diameter application but instead
         defines behaviour that would be common across all Diameter applications
         which require request routing based on Decorated NAI.
      
</p>
<p>At the time of publication of the Diameter Base
         Protocol <a class='info' href='#RFC3588'>[RFC3588]<span> (</span><span class='info'>Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;Diameter Base Protocol,&rdquo; September&nbsp;2003.</span><span>)</span></a>, the NAI definition was based on
         <a class='info' href='#RFC2486'>[RFC2486]<span> (</span><span class='info'>Aboba, B. and M. Beadles, &ldquo;The Network Access Identifier,&rdquo; January&nbsp;1999.</span><span>)</span></a> in which a NAI could only contain a 
         single realm. The NAI definition has since been updated in
         <a class='info' href='#RFC4282'>[RFC4282]<span> (</span><span class='info'>Aboba, B., Beadles, M., Arkko, J., and P. Eronen, &ldquo;The Network Access Identifier,&rdquo; December&nbsp;2005.</span><span>)</span></a> to define Decorated NAIs that contain
         multiple realms. However, RFC 4282 does not define how the Decorated
         NAIs should be handled by Diameter agents so this 
         specification was written to capture those requirements.
      
</p>
<a name="terms"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Terminology and Abbreviations</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
         NOT",  "SHOULD",  "SHOULD  NOT",  "RECOMMENDED",  "MAY",  and
         "OPTIONAL"  in  this  document   are  to  be  interpreted  as
         described in <a class='info' href='#RFC2119'>[RFC2119]<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a>.
      
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Network Access Identifier (NAI):</dt>
<dd>
           <br />
The Network Access Identifier (NAI)
           is the user identity submitted by
           the client during access authentication.  In roaming, the
           purpose of the NAI is to identify the user as well as
           to assist in the routing of the authentication request.
           <br />
<br />

        
</dd>
<dt>Decorated NAI:</dt>
<dd>
           <br />
A NAI containing multiple realms used to
           specify a source route and formatted according to Section 2.7 in
           RFC 4282.
           <br />
<br />

        
</dd>
<dt>Network Access Provider (NAP):</dt>
<dd>
           <br />
A business entity that provides
           network access infrastructure to one or more realms. A NAP
           infrastructure constitutes of one or more NASes. 
           <br />
<br />

        
</dd>
<dt>Network Access Server (NAS):</dt>
<dd>
           <br />
The device that peers connect to in order to obtain access to the
           network.
        <br />
<br />

        
</dd>
</dl></blockquote>

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Problem Overview</h3>

<p>The Diameter Base Protocol RFC 3588 Section 6.1
         defines the request routing in detail. This specification
         concerns only those cases where a Destination-Realm AVP is
         included in a request message.  A Diameter peer originating
         a request message MAY retrieve the realm information from the
         User-Name AVP and use that realm to populate the Destination-Realm
         AVP. In that case, the User-Name AVP is in form of a NAI including
         the realm part.
      
</p>
<p>Decorated NAIs are used to force routing of messages
         through a predefined list  of realms and in that way e.g., force
         certain inter-realm roaming arrangements, see Section 2.7. of
         RFC 4282. For example, a terminal
         (e.g. a mobile host) may learn based on some application or
         implementation  specific manner that its network access
         authentication signaling must traverse through certain realms
         in order to reach the home realm. In this case the terminal
         would decorate its NAI during the network access
         authentication with the list of intermediating realms 
         and the home realm. As a result, the network access server
         (NAS) and intermediating Diameter agents would make sure that
         all subsequent request messages traverse through the desired
         realms as long as the request messages contain the User-Name
         AVP with a Decorated NAI.
      
</p>
<p>NAI decoration has previously been used in RADIUS <a class='info' href='#RFC2865'>[RFC2865]<span> (</span><span class='info'>Rigney, C., Willens, S., Rubens, A., and W. Simpson, &ldquo;Remote Authentication Dial In User Service (RADIUS),&rdquo; June&nbsp;2000.</span><span>)</span></a>
         based roaming networks using RFC 2486 NAIs in a proprietary
         manner. There is a 
         need to replicate the same NAI based routing enforcement
         functionality also in Diameter based roaming networks.
         There are also publicly available specifications (e.g., see
         <a class='info' href='#3GPP.23.234'>[3GPP.23.234]<span> (</span><span class='info'>3GPP, &ldquo;3GPP system to Wireless Local Area Network (WLAN) interworking; System description,&rdquo; October&nbsp;2006.</span><span>)</span></a>, <a class='info' href='#3GPP.24.234'>[3GPP.24.234]<span> (</span><span class='info'>3GPP, &ldquo;3GPP system to Wireless Local Area Network (WLAN) interworking; WLAN User Equipment (WLAN UE) to network protocols; Stage 3,&rdquo; October&nbsp;2006.</span><span>)</span></a>,
         <a class='info' href='#3GPP.23.003'>[3GPP.23.003]<span> (</span><span class='info'>3GPP, &ldquo;Numbering, addressing and identification,&rdquo; October&nbsp;2006.</span><span>)</span></a>, <a class='info' href='#3GPP.29.273'>[3GPP.29.273]<span> (</span><span class='info'>3GPP, &ldquo;Evolved Packet System (EPS); 3GPP EPS AAA interfaces,&rdquo; April&nbsp;2010.</span><span>)</span></a> and
         <a class='info' href='#WiMAX'>[WiMAX]<span> (</span><span class='info'>WiMAX Forum, &ldquo;WiMAX Forum Network Architecture (Stage 2:                  Architecture Tenets, Reference Model and Reference Points),&rdquo; January&nbsp;2008.</span><span>)</span></a>) that assume NAI decoration
         based request routing enforcement is fully supported by RFC
         3588. The same assumption is carried over to NASREQ <a class='info' href='#RFC4005'>[RFC4005]<span> (</span><span class='info'>Calhoun, P., Zorn, G., Spence, D., and D. Mitton, &ldquo;Diameter Network Access Server Application,&rdquo; August&nbsp;2005.</span><span>)</span></a> and EAP <a class='info' href='#RFC4072'>[RFC4072]<span> (</span><span class='info'>Eronen, P., Hiller, T., and G. Zorn, &ldquo;Diameter Extensible Authentication Protocol (EAP) Application,&rdquo; August&nbsp;2005.</span><span>)</span></a> Diameter
         applications. 
      
</p>
<p><a class='info' href='#realms'>Figure&nbsp;1<span> (</span><span class='info'>Example roaming scenario with        intermediating realms. The mobile host authenticates to        the home realm through one or more visited realms.</span><span>)</span></a> illustrates an example deployment scenario
         where Decorated NAIs would be used to force a certain route through
         desired realms. A roaming terminal (e.g. a mobile host) discovers a
         number of Network Access Providers (NAP): NAP A and NAP B.
         None of the NAPs are able to provide direct connectivity to roaming
         terminals home realm (i.e. Realm-H). However, the roaming terminal
         learns, somehow, that NAP B is able to provide connectivity to the
         Realm-H through the Realm-X (i.e. the visited realm from the roaming
         terminal point of view). During the network access authentication, the
         roaming terminal would decorate its NAI as 
         Realm-H!username@Realm-X. The roaming terminal has also an alternative
         route to its home realm through NAP A, Realm-Z and Realm-X. If the
         roaming terminal were to choose to use NAP A, then it would decorate
         its NAI as Realm-X!Realm-H!username@Realm-Z. Diameter agents should now
         be able to route the request message through desired realms using
         the Decorated NAI originally found in the User-Name AVP.
      
</p>
<p>
      <br /><hr class="insert" />
<a name="realms"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
      .--.                 .--.                   .--.
    _(.   `)             _(.   `)               _(.   `)
  _(Visited`)_         _(Visited`)_           _(  Home `)_
 (   Realm-Z  `)&lt;----&gt;(   Realm-X  `)&lt;------&gt;(   Realm-H  `)
( `  .       )  )    ( `  .       )  )      ( `  .       )  )
 `--(_______)--'      `--(_______)--'        `--(_______)--'
       |                 __ /
       |               /
      .--.          .--.
    _(    `.      _(    `.
   (  NAP A )    (  NAP B )
  ( `  .  )  )  ( `  .  )  )
   `--(___.-'    `--(___.-'
                  )
         (  (   )
           (  |
              +-+
              |M|
              +-+
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: Example roaming scenario with
       intermediating realms. The mobile host authenticates to
       the home realm through one or more visited realms.&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

      
</p>
<p>NAI decoration is not limited to the network access
         authentication and authorization procedures. It can be used
         with any Diameter application whose commands are proxiable
         and include the User-Name AVP with a NAI. Generally, the NAI decoration
         can be used to force a certain route for all request messages at
         a realm granularity. 
      
</p>
<p>As a problem summary we have two main issues:
      
</p>
<p>
         </p>
<ul class="text">
<li>Updating both Destination-Realm and User-Name AVPs based on the Decorated
            NAI extracted from the User-Name AVP. The update would be
            done by intermediating Diameter agents that participate to
            realm based request routing. Specifically, this would
            concern Diameter proxies. 
            <br />
<br />

         
</li>
<li>How Diameter agents could implement the handling of the NAI
            decoration based routing enforcement in a way that is
            still backwards compatible with RFC 3588.
         
</li>
</ul><p>
      
</p>
<p><a class='info' href='#RFC5113'>[RFC5113]<span> (</span><span class='info'>Arkko, J., Aboba, B., Korhonen, J., and F. Bari, &ldquo;Network Discovery and Selection Problem,&rdquo; January&nbsp;2008.</span><span>)</span></a> Section 2.3. also discusses
         NAI decoration related issues with EAP <a class='info' href='#RFC3748'>[RFC3748]<span> (</span><span class='info'>Aboba, B., Blunk, L., Vollbrecht, J., Carlson, J., and H. Levkowetz, &ldquo;Extensible Authentication Protocol (EAP),&rdquo; June&nbsp;2004.</span><span>)</span></a>
         in general.
      
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Solution Overview</h3>

<p>This specification defines a solution for Diameter realm
         based request routing with routing enforcement using the
         User-Name AVP NAI decoration. Diameter proxy agent
         implementations can claim compliance using the solution
         described in this specification. 
      
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Interpretation of Decorated NAIs</h3>

<p>Implementations compliant to this specification MUST have an
           uniform way of interpreting decorated NAIs. That is, in the
           case of decoration, the character '!' is used to separate
           realms in the list of decorated realms in the NAI (as shown
           in examples in <a class='info' href='#RFC4282'>[RFC4282]<span> (</span><span class='info'>Aboba, B., Beadles, M., Arkko, J., and P. Eronen, &ldquo;The Network Access Identifier,&rdquo; December&nbsp;2005.</span><span>)</span></a>).
        
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Ensuring Backwards Compatibility</h3>

<p>Implementations compliant to this specification MUST define a new
         Diameter application. This requirement is set to guarantee backwards
         compatibility with existing Diameter implementations, applications
         and deployments. Diameter agents not compliant with this
         specification will not advertise support for these new applications
         that implement the enhanced routing solution based on Decorated NAIs
         and will therefore be bypassed.
      
</p>
<a name="enhanced"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Enhanced Request Routing Solution</h3>

<p>When a Diameter client originates a request message, the
         Destination-Realm AVP is populated with the realm part of the
         NAI available in the User-Name AVP (realm given after the '@'
         character of the NAI). The NAI in the User-Name AVP may or may
         not be decorated.
      
</p>
<p>When a
         Diameter agent receives a request message containing the
         Destination-Realm AVP with a realm that the agent is configured to
         process locally (and in the case of proxies the Diameter
         application is locally supported), it MUST do the following
         further processing before handling the message locally: 
      
</p>
<p></p>
<ul class="text">
<li>If the User-Name AVP is available in the request message,
            then the Diameter agent MUST inspect whether the User-Name
            AVP contains a Decorated NAI. If the NAI is not decorated
            then the Diameter agent proceeds with a normal RFC 3588
            message processing.
            <br />
<br />

         
</li>
<li>If the User-Name AVP contains a Decorated NAI, then the
            Diameter agent MUST process the NAI as defined in RFC 4282
            and update the value of the User-Name AVP
            accordingly. Furthermore, the Diameter agent MUST update
            the Destination-Realm AVP to match the new realm in the
            User-Name AVP. 
            <br />
<br />

         
</li>
<li>The request message is then sent to the next hop
            using the normal request routing rules as defined in RFC
            3588. 
         
</li>
</ul>

<p><a class='info' href='#example'>Figure&nbsp;2<span> (</span><span class='info'>The roaming terminal decides         that the Diameter messages must be routed via Realm-Z,         Realm- X and Realm-H.</span><span>)</span></a> illustrates an example of a roaming terminal originated
         signaling with the home realm (Realm-H) through a NAP and two
         intermediating realms (Realm-Z, Realm-X) before reaching
         the home realm (Realm-H). The example shows how the User-Name
         AVP and the Destination-Realm AVP change at each realm before
         reaching the final destination. If the signaling were
         originated from the NAS/NAP only, then the step 1) can be omitted.
      
</p><br /><hr class="insert" />
<a name="example"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
1) Roaming Terminal -&gt; NAS/NAP
       Identity/NAI = realm-X!realm-H!username@realm-Z

2) NAS/NAP -&gt; Realm-Z
       User-Name = realm-X!realm-H!username@realm-Z
       Destination-Realm = realm-Z

3) Realm-Z -&gt; realm-X
       User-Name = realm-H!username@realm-X
       Destination-Realm = realm-X

4) Realm-X -&gt; Realm-H
       User-Name = username@realm-H
       Destination-Realm = realm-H
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: The roaming terminal decides
        that the Diameter messages must be routed via Realm-Z,
        Realm- X and Realm-H.&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
IANA Considerations</h3>

<p>This specification has no actions to IANA.
        
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Security Considerations</h3>

<p>A malicious node initiating (or indirectly causing
         initiation of) a Diameter
         request may purposely create malformed list of realms in the
         NAI. This may cause the routing of requests through realms
         that would normally have nothing to do with the initiated
         Diameter message exchange. Furthermore, a malformed list of
         realms may contain non-existing realms causing the routing of
         Diameter messages that cannot ultimately be routed
         anywhere. However, the request message might get routed
         several hops before such non-existent realms are discovered
         and thus creating unnecessary overhead to the routing system
         in general.
      
</p>
<p>The NAI decoration is used in AAA infrastructures where the
         Diameter messages are transported between the NAS and the
         Diameter server via one or more AAA brokers or Diameter
         proxies.  In this case the NAS to the Diameter server AAA
         communication rely on the security properties of the
         intermediate AAA brokers and Diameter proxies.
      
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Acknowledgements</h3>

<p>The authors would like to thank Victor Fajardo, Stefan
         Winter and Avi Lior for their detailed comments on this document.
      
</p>
<p>Jouni Korhonen would like to thank TEKES WISEciti project for
         providing funding to work on this document while he was at
         TeliaSonera's employ.
      
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; BCP&nbsp;14, RFC&nbsp;2119, March&nbsp;1997 (<a href="http://www.rfc-editor.org/rfc/rfc2119.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2119.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2119.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3588">[RFC3588]</a></td>
<td class="author-text">Calhoun, P., Loughney, J., Guttman, E., Zorn, G., and J. Arkko, &ldquo;<a href="http://tools.ietf.org/html/rfc3588">Diameter Base Protocol</a>,&rdquo; RFC&nbsp;3588, September&nbsp;2003 (<a href="http://www.rfc-editor.org/rfc/rfc3588.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4282">[RFC4282]</a></td>
<td class="author-text">Aboba, B., Beadles, M., Arkko, J., and P. Eronen, &ldquo;<a href="http://tools.ietf.org/html/rfc4282">The Network Access Identifier</a>,&rdquo; RFC&nbsp;4282, December&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4282.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>8.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="3GPP.23.003">[3GPP.23.003]</a></td>
<td class="author-text">3GPP, &ldquo;<a href="http://www.3gpp.org/ftp/Specs/html-info/23003.htm">Numbering, addressing and identification</a>,&rdquo; 3GPP TS&nbsp;23.003 3.15.0, October&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="3GPP.23.234">[3GPP.23.234]</a></td>
<td class="author-text">3GPP, &ldquo;<a href="http://www.3gpp.org/ftp/Specs/html-info/23234.htm">3GPP system to Wireless Local Area Network (WLAN) interworking; System description</a>,&rdquo; 3GPP TS&nbsp;23.234 6.10.0, October&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="3GPP.24.234">[3GPP.24.234]</a></td>
<td class="author-text">3GPP, &ldquo;<a href="http://www.3gpp.org/ftp/Specs/html-info/24234.htm">3GPP system to Wireless Local Area Network (WLAN) interworking; WLAN User Equipment (WLAN UE) to network protocols; Stage 3</a>,&rdquo; 3GPP TS&nbsp;24.234 6.7.0, October&nbsp;2006.</td></tr>
<tr><td class="author-text" valign="top"><a name="3GPP.29.273">[3GPP.29.273]</a></td>
<td class="author-text">3GPP, &ldquo;<a href="http://www.3gpp.org/ftp/Specs/html-info/29273.htm">Evolved Packet System (EPS); 3GPP EPS AAA interfaces</a>,&rdquo; 3GPP TS&nbsp;29.273 8.5.0, April&nbsp;2010.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2486">[RFC2486]</a></td>
<td class="author-text"><a href="mailto:bernarda@microsoft.com">Aboba, B.</a> and <a href="mailto:mbeadles@wcom.net">M. Beadles</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2486">The Network Access Identifier</a>,&rdquo; RFC&nbsp;2486, January&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2486.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2486.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2486.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2865">[RFC2865]</a></td>
<td class="author-text">Rigney, C., Willens, S., Rubens, A., and W. Simpson, &ldquo;<a href="http://tools.ietf.org/html/rfc2865">Remote Authentication Dial In User Service (RADIUS)</a>,&rdquo; RFC&nbsp;2865, June&nbsp;2000 (<a href="http://www.rfc-editor.org/rfc/rfc2865.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3748">[RFC3748]</a></td>
<td class="author-text">Aboba, B., Blunk, L., Vollbrecht, J., Carlson, J., and H. Levkowetz, &ldquo;<a href="http://tools.ietf.org/html/rfc3748">Extensible Authentication Protocol (EAP)</a>,&rdquo; RFC&nbsp;3748, June&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3748.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4005">[RFC4005]</a></td>
<td class="author-text">Calhoun, P., Zorn, G., Spence, D., and D. Mitton, &ldquo;<a href="http://tools.ietf.org/html/rfc4005">Diameter Network Access Server Application</a>,&rdquo; RFC&nbsp;4005, August&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4005.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4072">[RFC4072]</a></td>
<td class="author-text">Eronen, P., Hiller, T., and G. Zorn, &ldquo;<a href="http://tools.ietf.org/html/rfc4072">Diameter Extensible Authentication Protocol (EAP) Application</a>,&rdquo; RFC&nbsp;4072, August&nbsp;2005 (<a href="http://www.rfc-editor.org/rfc/rfc4072.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5113">[RFC5113]</a></td>
<td class="author-text">Arkko, J., Aboba, B., Korhonen, J., and F. Bari, &ldquo;<a href="http://tools.ietf.org/html/rfc5113">Network Discovery and Selection Problem</a>,&rdquo; RFC&nbsp;5113, January&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5113.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="WiMAX">[WiMAX]</a></td>
<td class="author-text">WiMAX Forum, &ldquo;<a href="http://www.wimaxforum.org/documents/documents/WiMAX_Forum_Network_Architecture_Stage_2-3_Rel_1v1.2.zip">WiMAX Forum Network Architecture (Stage 2:
                 Architecture Tenets, Reference Model and Reference Points)</a>,&rdquo; Release 1&nbsp;Version 1.2, January&nbsp;2008.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jouni Korhonen (editor)</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Nokia Siemens Networks</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Linnoitustie 6</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Espoo  FIN-02600</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Finland</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jouni.nospam@gmail.com">jouni.nospam@gmail.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Mark Jones</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bridgewater Systems</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">303 Terry Fox Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Ottawa,  Ontario  K2K 3J1</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Canada</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Mark.Jones@bridgewatersystems.com">Mark.Jones@bridgewatersystems.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Lionel Morand</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Orange Labs</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">38-40 rue du general Leclerc</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Issy-moulineaux Cedex 9,  92794</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">France</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:Lionel.morand@orange-ftgroup.com">Lionel.morand@orange-ftgroup.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tina Tsou</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Huawei</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">R&D Center, Huawei Technologies Co., Ltd</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Bantian,  Shenzhen</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">P.R. China</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:tena@huawei.com">tena@huawei.com</a></td></tr>
</table>
</body></html>
