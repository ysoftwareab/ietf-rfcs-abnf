<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>FIB Suppression with Virtual Aggregation</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Scope of this Document">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Requirements notation">
<link href="#rfc.section.1.3" rel="Chapter" title="1.3 Terminology">
<link href="#rfc.section.2" rel="Chapter" title="2 Overview of Virtual Aggregation (VA)">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Mix of Legacy and VA Routers">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 Summary of Tunnels and Paths">
<link href="#rfc.section.3" rel="Chapter" title="3 Specification of VA">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Legacy Routers">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Advertising and Handling Virtual Prefixes (VP)">
<link href="#rfc.section.3.2.1" rel="Chapter" title="3.2.1 Distinguishing VPs from Sub-prefixes">
<link href="#rfc.section.3.2.2" rel="Chapter" title="3.2.2 Limitations on Virtual Prefixes">
<link href="#rfc.section.3.2.3" rel="Chapter" title="3.2.3 Aggregation Point Routers (APR)">
<link href="#rfc.section.3.2.3.1" rel="Chapter" title="3.2.3.1 Selecting APRs">
<link href="#rfc.section.3.2.4" rel="Chapter" title="3.2.4 Non-APR Routers">
<link href="#rfc.section.3.2.5" rel="Chapter" title="3.2.5 Adding and deleting VPs">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Border VA Routers">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Advertising and Handling Sub-Prefixes">
<link href="#rfc.section.3.5" rel="Chapter" title="3.5 Suppressing FIB Sub-prefix Routes">
<link href="#rfc.section.3.5.1" rel="Chapter" title="3.5.1 Selecting Popular Prefixes">
<link href="#rfc.section.3.6" rel="Chapter" title="3.6 New Configuration">
<link href="#rfc.section.3.7" rel="Chapter" title="3.7 Interaction with Traffic Engineering">
<link href="#rfc.section.4" rel="Chapter" title="4 Usage of MPLS Tunnels">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Usage of Inner Label">
<link href="#rfc.section.5" rel="Chapter" title="5 IANA Considerations">
<link href="#rfc.section.6" rel="Chapter" title="6 Security Considerations">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Properly Configured VA">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Mis-configured VA">
<link href="#rfc.section.7" rel="Chapter" title="7 Acknowledgements">
<link href="#rfc.references" rel="Chapter" title="8 References">
<link href="#rfc.references.1" rel="Chapter" title="8.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="8.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="The continued growth in the Default Free Routing Table (DFRT) stresses the global routing system in a number of ways.  One of the most costly stresses is FIB size:  ISPs often must upgrade router hardware simply because the FIB has run out of space, and router vendors must design routers that have adequate FIB.  FIB suppression is an approach to relieving stress on the FIB by not loading selected RIB entries into the FIB.  Virtual Aggregation (VA) allows ISPs to shrink the FIBs of any and all routers, easily by an order of magnitude with negligible increase in path length and load.  FIB suppression can be deployed autonomously by an ISP without requiring cooperation between adjacent ISPs, and can co-exist with legacy routers in the ISP.  " />
  <meta name="description" content="The continued growth in the Default Free Routing Table (DFRT) stresses the global routing system in a number of ways.  One of the most costly stresses is FIB size:  ISPs often must upgrade router hardware simply because the FIB has run out of space, and router vendors must design routers that have adequate FIB.  FIB suppression is an approach to relieving stress on the FIB by not loading selected RIB entries into the FIB.  Virtual Aggregation (VA) allows ISPs to shrink the FIBs of any and all routers, easily by an order of magnitude with negligible increase in path length and load.  FIB suppression can be deployed autonomously by an ISP without requiring cooperation between adjacent ISPs, and can co-exist with legacy routers in the ISP.  " />
  <meta name="keywords" content="" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">P. Francis</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">MPI-SWS</td>
</tr>
<tr>
<td class="left">Intended status: Informational</td>
<td class="right">X. Xu</td>
</tr>
<tr>
<td class="left">Expires: January 02, 2012</td>
<td class="right">Huawei</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">H. Ballani</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Cornell U.</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">D. Jen</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">UCLA</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">R. Raszuk</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Cisco</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">L. Zhang</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">UCLA</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">July 01, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">FIB Suppression with Virtual Aggregation<br />
  <span class="filename">draft-ietf-grow-va-05.txt</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>The continued growth in the Default Free Routing Table (DFRT) stresses the global routing system in a number of ways.  One of the most costly stresses is FIB size:  ISPs often must upgrade router hardware simply because the FIB has run out of space, and router vendors must design routers that have adequate FIB.  FIB suppression is an approach to relieving stress on the FIB by not loading selected RIB entries into the FIB.  Virtual Aggregation (VA) allows ISPs to shrink the FIBs of any and all routers, easily by an order of magnitude with negligible increase in path length and load.  FIB suppression can be deployed autonomously by an ISP without requiring cooperation between adjacent ISPs, and can co-exist with legacy routers in the ISP.  </p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted to IETF in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on January 02, 2012.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<li>1.1.   <a href="#rfc.section.1.1">Scope of this Document</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">Requirements notation</a>
</li>
<li>1.3.   <a href="#rfc.section.1.3">Terminology</a>
</li>
<li>2.   <a href="#rfc.section.2">Overview of Virtual Aggregation (VA)</a>
</li>
<li>2.1.   <a href="#rfc.section.2.1">Mix of Legacy and VA Routers</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">Summary of Tunnels and Paths</a>
</li>
<li>3.   <a href="#rfc.section.3">Specification of VA</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Legacy Routers</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Advertising and Handling Virtual Prefixes (VP)</a>
</li>
<li>3.2.1.   <a href="#rfc.section.3.2.1">Distinguishing VPs from Sub-prefixes</a>
</li>
<li>3.2.2.   <a href="#rfc.section.3.2.2">Limitations on Virtual Prefixes</a>
</li>
<li>3.2.3.   <a href="#rfc.section.3.2.3">Aggregation Point Routers (APR)</a>
</li>
<li>3.2.3.1.   <a href="#rfc.section.3.2.3.1">Selecting APRs</a>
</li>
<li>3.2.4.   <a href="#rfc.section.3.2.4">Non-APR Routers</a>
</li>
<li>3.2.5.   <a href="#rfc.section.3.2.5">Adding and deleting VPs</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Border VA Routers</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Advertising and Handling Sub-Prefixes</a>
</li>
<li>3.5.   <a href="#rfc.section.3.5">Suppressing FIB Sub-prefix Routes</a>
</li>
<li>3.5.1.   <a href="#rfc.section.3.5.1">Selecting Popular Prefixes</a>
</li>
<li>3.6.   <a href="#rfc.section.3.6">New Configuration</a>
</li>
<li>3.7.   <a href="#rfc.section.3.7">Interaction with Traffic Engineering</a>
</li>
<li>4.   <a href="#rfc.section.4">Usage of MPLS Tunnels</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Usage of Inner Label</a>
</li>
<li>5.   <a href="#rfc.section.5">IANA Considerations</a>
</li>
<li>6.   <a href="#rfc.section.6">Security Considerations</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">Properly Configured VA</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">Mis-configured VA</a>
</li>
<li>7.   <a href="#rfc.section.7">Acknowledgements</a>
</li>
<li>8.   <a href="#rfc.references">References</a>
</li>
<li>8.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>8.2.   <a href="#rfc.references.2">Informative References</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">ISPs today manage constant DFRT growth in a number of ways.  One way, of course, is for ISPs to upgrade their router hardware before DFRT growth outstrips the size of the FIB.  This may be too expensive for many ISPs.  They would prefer to extend the lifetime of routers whose FIBs can no longer hold the full DFRT.  </p>
<p id="rfc.section.1.p.2">A common approach taken by lower-tier ISPs is to default route to their transit providers.  Routes to customers and peer ISPs are maintained, but everything else defaults to the provider.  This approach has several disadvantages.  First, packets to Internet destinations may take longer-than-necessary Autonomous System (AS) paths.  This problem can be mitigated through careful configuration of partial defaults, but this can require substantial configuration overhead.  A second problem with defaulting to providers is that the ISP is no longer able to provide the full DFRT to its customers.  Finally, provider defaults prevents the ISP from being able to detect martian packets.  As a result, the ISP transmits packets that could otherwise have been dropped over its expensive provider links.  </p>
<p id="rfc.section.1.p.3">An alternative is for the ISP to maintain full routes in its core routers, but to filter routes from edge routers that do not require a full DFRT.  These edge routers can then default route to the core routers.  This is often possible with edge routers that interface to customer networks.  The problem with this approach is that it cannot be used for all edge routers.  For instance, it cannot be used for routers that connect to transits.  It of course also does not help in cases where core routers themselves have inadequate FIB capacity.  </p>
<p id="rfc.section.1.p.4">FIB Suppression is an approach to shrinking FIB size that requires no changes to BGP, no changes to packet forwarding mechanisms in routers, and relatively minor changes to control mechanisms in routers and configuration of those mechanisms.  The core idea behind FIB suppression is to run BGP as normal, and in particular to not shrink the RIB, but rather to not load certain RIB entries into the FIB.  This approach minimizes changes to routers, and in particular is simpler than more general routing architectures that try to shrink both RIB and FIB.  With FIB suppression, there are no changes to BGP per se.  The BGP decision process does not change, the selected AS-PATH does not change, and except on rare occasion the exit router does not change.  ISPs can deploy FIB suppression autonomously and with no coordination with neighboring ASes.  </p>
<p id="rfc.section.1.p.5">This document describes an approach to FIB suppression called "Virtual Aggregation" (VA).  VA operates by organizing the IP (v4 or v6) address space into Virtual Prefixes (VP), and using tunnels to aggregate the (regular) sub-prefixes within each VP.  The decrease in FIB size can be dramatic, easily 5x or 10x with only a slight path length and router load increase <a href="#nsdi09">[nsdi09]</a>.  </p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#sec-scope" id="sec-scope">Scope of this Document</a>
</h1>
<p id="rfc.section.1.1.p.1">The scope of this document is limited to intra-domain VA operation.  Individual ASs autonomously operate VA internally without any coordination with neighboring ASs.  For the remainder of this document, the terms ISP, AS, and domain are used interchangeably.  </p>
<p id="rfc.section.1.1.p.2">This document applies equally to IPv4 and IPv6.  </p>
<p id="rfc.section.1.1.p.3">This document is limited to the following tunnel types: MPLS Label Switched Paths (LSP), and of MPLS inner labels tunneled over either LSPs or IP headers.  </p>
<p id="rfc.section.1.1.p.4">VA may operate with a mix of upgraded routers and legacy routers.  There are no topological restrictions placed on the mix of routers.  In order to avoid loops between upgraded and legacy routers, packets are always tunneled by the VA routers to the BGP NEXT_HOPs of the matched BGP routes. If a given local ASBR (Autonomous System Border Router) is a legacy router, it must be able to terminate tunnels.  </p>
<h1 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> Requirements notation</h1>
<p id="rfc.section.1.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" when capitalized in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.  </p>
<h1 id="rfc.section.1.3">
<a href="#rfc.section.1.3">1.3.</a> Terminology</h1>
<p></p>

<dl>
<dt>Aggregation Point Router (APR):</dt>
<dd style="margin-left: 8">An Aggregation Point Router (APR) is a router that aggregates a Virtual Prefix (VP) by installing routes (into the FIB) for all of the sub-prefixes within the VP.  APRs advertise the VP to other routers with BGP.  For each sub-prefix within the VP, APRs have a tunnel from themselves to the remote ASBR (Autonomous System Border Router) where packets for that prefix should be delivered.  </dd>
<dt>Install and Suppress:</dt>
<dd style="margin-left: 8">The terms "install" and "suppress" are used to describe whether a RIB entry has been loaded or not loaded into the FIB.  In particular, "install a route" means "install a route into the FIB", and "suppress a route" means "do not install a route into the FIB".  </dd>
<dt>Legacy Router:</dt>
<dd style="margin-left: 8">A router that does not run VA, and has no knowledge of VA.  Legacy routers, however, must be able to terminate tunnels when they are local ASBRs.  </dd>
<dt>Non-APR Router:</dt>
<dd style="margin-left: 8">In discussing VPs, it is often necessary to distinguish between routers that are APRs for that VP, and routers that are not APRs for that VP (but of course may be APRs for other VPs not under discussion).  In these cases, the term "APR" is taken to mean "a VA router that is an APR for the given VP", and the term "non-APR" is taken to mean "a VA router that is not an APR for the given VP".  The term non-APR router is not used to refer to legacy routers.  </dd>
<dt>Popular Prefix:</dt>
<dd style="margin-left: 8">A Popular Prefix is a sub-prefix that is installed in a router in addition to the sub-prefixes it holds by virtue of being a Aggregation Point Router.  The Popular Prefix allows packets to follow the shortest path.  Note that different routers do not need to have the same set of Popular Prefixes.  </dd>
<dt>Routing Information Base (RIB):</dt>
<dd style="margin-left: 8">The term RIB is used rather sloppily in this document to refer either to the loc-RIB (as used in <a href="#RFC4271">[RFC4271]</a>), or to the combined Adj-RIBs-In, the Loc-RIB, and the Adj-RIBs-Out.  </dd>
<dt>Sub-Prefix:</dt>
<dd style="margin-left: 8">A regular (physically aggregatable) prefix.  These are equivalent to the prefixes that would normally comprise the DFRT in the absence of VA.  A VA router will contain a sub-prefix entry either because the sub-prefix falls within a Virtual Prefix for which the router is an APR, or because the sub-prefix is installed as a Popular Prefix.  Legacy routers hold the same sub-prefixes that they hold today.  </dd>
<dt>Tunnel:</dt>
<dd style="margin-left: 8">This document specifies the use of MPLS Label Switched Paths (LSP), and of MPLS inner labels tunneled over either LSPs or IP headers.  While in principle other types of tunnels may be used, they are not specified here.  This document uses the term tunnel to refer to the above MPLS encapsulations.  </dd>
<dt>VA router:</dt>
<dd style="margin-left: 8">A router that operates Virtual Aggregation according to this document.  </dd>
<dt>Virtual Prefix (VP):</dt>
<dd style="margin-left: 8">A Virtual Prefix (VP) is a prefix used to aggregate its contained regular prefixes (sub-prefixes).  The set of sub-prefixes in a VP are not physically aggregatable, and so they are aggregated at APRs through the use of tunnels.  </dd>
<dt>VP-List:</dt>
<dd style="margin-left: 8">A list of defined VPs.  All routers must agree on the contents of this list.  </dd>
</dl>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#basic-operation" id="basic-operation">Overview of Virtual Aggregation (VA)</a>
</h1>
<p id="rfc.section.2.p.1">For descriptive simplicity, this section starts by describing VA assuming that there are no legacy routers in the domain.  <a href="#router-mix">Section 2.1</a> overviews the additional functions required by VA routers to accommodate legacy routers.  </p>
<p id="rfc.section.2.p.2">A key concept behind VA is to operate BGP as normal, and in particular to populate the RIB with the full DFRT, but to suppress many or most prefixes from being loaded into the FIB.   By populating the RIB as normal, we avoid any changes to BGP, and changes to router operation are relatively minor.  The basic idea behind VA is as follows: The address space is partitioned into large prefixes --- larger than any aggregatable prefix in use today.  These prefixes are called Virtual Prefixes (VP).  Different VPs do not need to be the same size.  They may be a mix of /6, /7, /8 (for IPv4), and so on.  Indeed, an ISP can define a single /0 VP, and use it for a core/edge type of configuration.  That is, the core routers would maintain full FIBs, and edge routers could maintain default routes to the core routers, and suppress as much of the FIB as they wish.  Each ISP can independently select the size of its VPs.  </p>
<p id="rfc.section.2.p.3">VPs are not themselves topologically aggregatable.  VA makes the VPs aggregatable through the use of tunnels, as follows.  Associated with each VP are one or more "Aggregation Point Routers" (APR).  An APR (for a given VP) is a router that installs routes for all sub-prefixes (i.e. real physically aggregatable prefixes) within the VP.  By "install routes" here, we mean: </p>
<p id="rfc.section.2.p.4">The APR originates a BGP route to the VP.  This route is distributed within the domain, but not outside the domain.  With this structure in place, a packet transiting the ISP goes from the ingress router to the APR (usually via a tunnel), and then from the APR to the BGP NEXT_HOP router via a tunnel.  VA can operate with MPLS LSPs, or with MPLS inner labels over LSPs or IP headers.  <a href="#sec-tunnels">Section 4</a> specifies the usage of MPLS tunnels.  Other tunnel types (i.e., GRE) may be used, but are not specified in this document.  </p>
<p id="rfc.section.2.p.5">The BGP NEXT_HOP can be either the local ASBR or the remote ASBR.  In the former case, an inner label is used to tunnel packets (<a href="#sec-inner">Section 4.1</a>).  In either case, all tunnel headers are stripped by the local ASBR before the packet is delivered to the remote ASBR.  In other words, the remote ASBR sees a normal IP packet, and is completely unaware of the existence of VA in the neighboring ISP.  </p>
<p id="rfc.section.2.p.6">Note that the AS-PATH is not effected at all by VA.  This means among other things that AS-level policies are not effected by VA.  The packet may not, however, follow the shortest path within the ISP (where shortest path is defined here as the path that would have been taken if VA were not operating), because the APR may not be on the shortest path between the ingress and egress routers.  When this happens, the packet experiences additional latency and creates extra load (by virtue of taking more hops than it otherwise would have).  Note also that, with VA, a packet may occasionally take a different exit point than it otherwise would have.  This can occur for instance when the exit point nearest to the selected APR is different than the exit point nearest to the router initiating the tunnel to the APR.  </p>
<p id="rfc.section.2.p.7">VA can avoid traversing the APR for selected routes by installing these routes in non-APR routers.  In other words, even if an ingress router is not an APR for a given sub-prefix, it MAY install that sub-prefix into its FIB.  Packets in this case are tunneled directly from the ingress to the BGP NEXT_HOP.  These extra routes are called "Popular Prefixes", and are typically installed for policy reasons (e.g. customer routes are always installed), or for sub-prefixes that carry a high volume of traffic (<a href="#spec-pop-pre">Section 3.5.1</a>).  Different routers may have different Popular Prefixes.  As such, an ISP may assign Popular Prefixes per router, per POP, or uniformly across the ISP.  A given router may have zero Popular Prefixes, or the majority of its FIB may consist of Popular Prefixes.  The effectiveness of Popular Prefixes to reduce traffic load relies on the fact that traffic volumes follow something like a power-law distribution: i.e. that 90% of traffic is destined to 10% of the destinations.  Internet traffic measurement studies over the years have consistently shown that traffic patterns follow this distribution <a href="#nsdi09">[nsdi09]</a>, though there is no guarantee that they always will.  </p>
<p id="rfc.section.2.p.8">Note that for routing to work properly, every packet must sooner or later reach a router that has installed a sub-prefix route that matches the packet.  This would obviously be the case for a given sub-prefix if every router has installed a route for that sub-prefix.  If this is not the case, then there MUST be at least one Aggregation Point Router (APR) for the sub-prefix's Virtual Prefix (VP).  Ideally, every POP contains at least two APRs for every Virtual Prefix.  By having APRs in every POP, the latency imposed by routing to the APR is minimal (the extra hop is within the POP).  By having more than one APR, there is a redundant APR should one fail.  In practice it is often not possible to have an APR for every VP in every POP.  This is because some POPs may have only one or a few routers, and therefore there may not have enough cumulative FIB space in the POP to hold every sub-prefix.  Note that any router ("edge", "core", etc.) MAY be an APR.  </p>
<p id="rfc.section.2.p.9">It is important that both the contents of BGP RIBs, as well as the contents of the Routing Table (as defined in Section 3.2 of <a href="#RFC4271">[RFC4271]</a>) not be modified by VA (other than the introduction of routes to VPs).  This is because PIM-SM <a href="#RFC4601">[RFC4601]</a> relies on the contents of the Routing Table to build its own trees and forwarding table.  Therefore, FIB suppression MUST take place between the Routing Table and the actual FIB(s).  </p>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> <a href="#router-mix" id="router-mix">Mix of Legacy and VA Routers</a>
</h1>
<p id="rfc.section.2.1.p.1">It is important that an ISP be able to operate with a mix of "VA routers" and "legacy routers".  This allows ISPs to deploy VA in an incremental fashion and to continue to use routers that for whatever reason cannot be upgraded.  This document allows such a mix, and indeed places no topological restrictions on that mix.  It does, however, require that legacy routers are able to forward tunneled packets, are able to serve as tunnel endpoints, and are able to participate in distribution of tunnel information required to establish themselves as tunnel endpoints.  Depending on the tunnel type, legacy routers MAY also be able to initiate tunneled packets, though this is an OPTIONAL requirement.  Legacy routers MUST use their own address as the BGP NEXT_HOP.  </p>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> <a href="#tunnel-sum" id="tunnel-sum">Summary of Tunnels and Paths</a>
</h1>
<p id="rfc.section.2.2.p.1">To summarize, the following tunnels are created: </p>
<div id="#rfc.figure.1"></div>
<pre>
                                          Egress
                                          Router
        Ingress    Some       APR         (Local     Remote
        Router     Router     Router      ASBR)      ASBR
        -------    ------     ------      ------     --------
    1.    VA===================&gt;VA=========&gt;VA(pop)::::&gt;Peer ASBR
    
    2.    VA===================&gt;VA=========&gt;LR---------&gt;Peer ASBR
    
    3.    VA===============================&gt;VA(pop)::::&gt;Peer ASBR
    
    4.    VA===============================&gt;LR---------&gt;Peer ASBR

    (The following two exist in the case where legacy routers
     can initiate tunneled packets.)
    
    5.    LR===============================&gt;VA(pop)::::&gt;Peer ASBR
    
    6.    LR===============================&gt;LR---------&gt;Peer ASBR
    
    (The following two exist in the case where legacy routers
     cannot initiate tunneled packets.)
    
    7.    LR-------&gt;VA (remaining paths as in 1 to 4 above)
    
    8.    LR-------&gt;LR---------------------&gt;LR---------&gt;Peer ASBR
    
 </pre>
<p id="rfc.section.2.2.p.2">The first and second paths represent the case where the ingress router does not have a Popular Prefix for the destination, and MUST tunnel the packet to an APR.  The third and fourth paths represent the case where the ingress router does have a Popular Prefix for the destination, and so tunnels the packet directly to the egress.  The fifth and sixth paths are similar to the third and fourth paths respectively, but where the ingress is a legacy router that can initiate tunneled packets, and effectively has the Popular Prefix by virtue of holding the entire DFRT.  (Note that some ISPs have only partial RIBs in their customer-facing edge routers, and default route to a router that holds the full DFRT.  This case is not shown here, but works perfectly well.) Finally, paths 7 and 8 represent the case where legacy routers cannot initiate a tunneled packet.  </p>
<p id="rfc.section.2.2.p.3">VA prevents the routing loops that might otherwise occur when VA routers and legacy routers are mixed.  In particular, VA avoids the case where a legacy router is forwarding packets towards the BGP NEXT_HOP, while a VA router is forwarding packets towards the APR, with each router thinking that the other is on the shortest path to their respective targets.  </p>
<p id="rfc.section.2.2.p.4">In the first four types of path, the loop is avoided because tunnels are used all the way to the egress.  As a result, there is never an opportunity for a legacy router to try to route based on the destination address unless the legacy router is the egress, in which case it forwards the packet to the remote ASBR.  </p>
<p id="rfc.section.2.2.p.5">In the 5th and 6th cases, the ingress is a legacy router, but this router can initiate tunnels and has the full FIB, and so simply tunnels the packet to the egress router.  </p>
<p id="rfc.section.2.2.p.6">In the 7th and 8th cases, the legacy ingress cannot initiate tunnels, and so forwards the packet hop-by-hop towards the BGP NEXT_HOP.  The packet will work its way towards the egress router, and will either progress through a series of legacy routers (in which case the IGP prevents loops), or it will eventually reach a VA router, after which it will take tunnels as in the 1st and 2nd cases.  </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#router-changes" id="router-changes">Specification of VA</a>
</h1>
<p id="rfc.section.3.p.1">This section describes in detail how to operate VA.  </p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#spec-legacy" id="spec-legacy">Legacy Routers</a>
</h1>
<p id="rfc.section.3.1.p.1">VA can operate with a mix of VA and legacy routers.  To prevent the types of loops described in <a href="#tunnel-sum">Section 2.2</a>, however, legacy routers MUST satisfy the following requirements: </p>
<p id="rfc.section.3.1.p.2">As long as legacy routers participating in tunneling as described above there are no topological restrictions on the legacy routers.  They may be freely mixed with VA routers without the possibility of forming sustained loops (<a href="#tunnel-sum">Section 2.2</a>).  </p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#spec-VPs" id="spec-VPs">Advertising and Handling Virtual Prefixes (VP)</a>
</h1>
<h1 id="rfc.section.3.2.1">
<a href="#rfc.section.3.2.1">3.2.1.</a> <a href="#sec-know-vp" id="sec-know-vp">Distinguishing VPs from Sub-prefixes</a>
</h1>
<p id="rfc.section.3.2.1.p.1">VA routers MUST be able to distinguish VPs from sub-prefixes.  This is primarily in order to know which routes to install.  In particular, non-APR routers SHOULD know which prefixes are VPs before they receive routes for those VPs, for instance when they first boot up.  This is in order to avoid the situation where they unnecessarily start filling their FIBs with routes that they ultimately don't need to install (<a href="#spec-suppress">Section 3.5</a>).  This leads to the following requirement: </p>
<p id="rfc.section.3.2.1.p.2">It MUST be possible to configure the complete list of VPs into all VA routers.  This list is known as the VP-List.  </p>
<h1 id="rfc.section.3.2.2">
<a href="#rfc.section.3.2.2">3.2.2.</a> <a href="#limit-vp" id="limit-vp">Limitations on Virtual Prefixes</a>
</h1>
<p id="rfc.section.3.2.2.p.1">From the point of view of best-match routing semantics, VPs are treated identically to any other prefix.  In other words, if the longest matching prefix is a VP, then the packet is routed towards the VP.  If a packet matching a VP reaches an APR for that VP, and the APR does not have a better matching route, then the packet is discarded by the APR (just as a router that originates any prefix will discard a packet that does not have a better match).  </p>
<p id="rfc.section.3.2.2.p.2">The overall semantics of VPs, however, are slightly different from those of real prefixes.  Without VA, when a router originates a route for a (real) prefix, the expectation is that the addresses within the prefix are within the originating AS (or a customer of the AS).  For VPs, this is not the case.   APRs originate VPs whose sub-prefixes exist in different ASes.  Because of this, VPs MUST not be advertised across AS boundaries.  This is done with NO_EXPORT Communities Attribute (<a href="#spec-apr">Section 3.2.3</a>).  </p>
<p id="rfc.section.3.2.2.p.3">It is up to individual domains to define their own VPs.  VPs MUST be "larger" (span a larger address space) than any real sub-prefix.  If a VP is smaller than a real prefix, then packets that match the real prefix will nevertheless be routed to an APR owning the VP, at which point the packet will be dropped if it does not match a sub-prefix within the VP (<a href="#sec-consider">Section 6</a>).  </p>
<p id="rfc.section.3.2.2.p.4">(Note that, in principle there are cases where a VP could be smaller than a real prefix.  This is where the egress router to the real prefix is a VA router.  In this case, the APR could theoretically tunnel the packet to the appropriate remote ASBR, which would then forward the packet correctly.  On the other hand, if the egress router is a legacy router, then the APR could not tunnel matching packets to the egress.  This is because the egress would view the VP as a better match, and would loop the packet back to the APR.  For this reason we require that VPs be larger than any real prefixes, and that APRs never install prefixes larger than a VP in their FIBs.) </p>
<p id="rfc.section.3.2.2.p.5">It is valid for a VP to be a subset of another VP.  For example, 20/7 and 20/8 can both be VPs.  In fact, this capability is necessary for "splitting" a VP without temporarily increasing the FIB size in any router.  (<a href="#spec-VP-manage">Section 3.2.5</a>).  </p>
<h1 id="rfc.section.3.2.3">
<a href="#rfc.section.3.2.3">3.2.3.</a> <a href="#spec-apr" id="spec-apr">Aggregation Point Routers (APR)</a>
</h1>
<p id="rfc.section.3.2.3.p.1">For each VP for which a router is an APR, the router does the following: </p>
<h1 id="rfc.section.3.2.3.1">
<a href="#rfc.section.3.2.3.1">3.2.3.1.</a> <a href="#spec-apr-select" id="spec-apr-select">Selecting APRs</a>
</h1>
<p id="rfc.section.3.2.3.1.p.1">An ISP is free to select APRs however it chooses.  The details of this are outside the scope of this document.  Nevertheless, a few comments are made here.  In general, APRs should be selected such that the distance to the nearest APR for any VP is small---ideally within the same POP.  Depending on the number of routers in a POP, and the sizes of the FIBs in the routers relative to the DFRT size, it may not be possible for all VPs to be represented in a given POP.  In addition, there should be multiple APRs for each VP, again ideally in each POP, so that the failure of one does not unduly disrupt traffic.  </p>
<h1 id="rfc.section.3.2.4">
<a href="#rfc.section.3.2.4">3.2.4.</a> <a href="#spec-other-routers" id="spec-other-routers">Non-APR Routers</a>
</h1>
<p id="rfc.section.3.2.4.p.1">A non-APR router MUST install at least the following routes: </p>
<p id="rfc.section.3.2.4.p.2">If the non-APR has a tunnel to the BGP NEXT_HOP of any such route, it MUST use the tunnel to forward packets to the BGP NEXT_HOP.  </p>
<p id="rfc.section.3.2.4.p.3">When an APR fails, routers must select another APR to send packets to (if there is one).  This happens, however, through normal internal BGP convergence mechanisms.  </p>
<h1 id="rfc.section.3.2.5">
<a href="#rfc.section.3.2.5">3.2.5.</a> <a href="#spec-VP-manage" id="spec-VP-manage">Adding and deleting VPs</a>
</h1>
<p id="rfc.section.3.2.5.p.1">An ISP may from time to time wish to reconfigure its VP-List.  There are a number of reasons for this.  For instance, early in its deployment an ISP may configure one or a small number of VPs in order to test VA.  As the ISP gets more confident with VA, it may increase the number of VPs.  Or, an ISP may start with a small number of large VPs (i.e.  /4's or even one /0), and over time move to more smaller VPs in order to save even more FIB.  In this case, the ISP will need to "split" a VP.  Finally, since the address space is not uniformly populated with prefixes, the ISP may want to change the size of VPs in order to balance FIB size across routers.  This can involve both splitting and merging VPs.  Of course, an ISP must be able to modify its VP-List without 1) interrupting service to any destinations, or 2) temporarily increasing the size of any FIB (i.e. where the FIB size during the change is no bigger than its largest size either before or after the change).  </p>
<p id="rfc.section.3.2.5.p.2">The first step for adding a VP is to configure the APRs for the VP.  This causes the APRs to originate routes for the VP.  Non-APR routers will install this route according to the rules in <a href="#spec-other-routers">Section 3.2.4</a> even though they do not yet recognize that the prefix is a VP.  Subsequently the VP is added to the VP-List of non-APR routers.  The Non-APR routers can then start suppressing the sub-prefixes with no loss of service.  </p>
<p id="rfc.section.3.2.5.p.3">To delete a VP, the process is reversed.  First, the VP is removed from the VP-Lists of non-APRs.  This causes the non-APRs to install the sub-prefixes.  After all sub-prefixes have been installed, the VP may be removed from the APRs.  </p>
<p id="rfc.section.3.2.5.p.4">In many cases, it is desirable to split a VP.  For instance, consider the case where two routers, Ra and Rb, are APRs for the same prefix.  It would be possible to shrink the FIB in both routers by splitting the VP into two VPs (i.e. split one /6 into two /7's), and assigning each router to one of the VPs.  While this could in theory be done by first deleting the larger VP, and then adding the smaller VPs, doing so would temporarily increase the FIB size in non-APRs, which may not have adequate space for such an increase.  For this reason, we allow overlapping VPs.  </p>
<p id="rfc.section.3.2.5.p.5">To split a VP, first the two smaller VPs are added to the VP-Lists of all non-APR routers (in addition to the larger superset VP).  Next, the smaller VPs are added to the selected APRs (which may or may not be APRs for the larger VP).  Because the smaller VPs are a better match than the larger VP, this will cause the non-APR routers to forward packets to the APRs for the smaller VPs.  Next, the larger VP can be removed from the VP-Lists of all non-APR routers.  Finally, the larger VP can be removed from its APRs.  </p>
<p id="rfc.section.3.2.5.p.6">To merge two VPs, the new larger VP is configured in all non-APRs.  This has no effect on FIB size or APR selection, since the smaller VPs are better matches.  Next the larger VP is configured in its selected APRs.  Next the smaller VPs are deleted from all non-APRs.  Finally, the smaller VPs are deleted from their corresponding APRs.  </p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#spec-br" id="spec-br">Border VA Routers</a>
</h1>
<p id="rfc.section.3.3.p.1">A VA router that is an ASBR MUST do the following: </p>
<p></p>

<ol>
<li>When forwarding externally-received routes over iBGP, if a tunnel with an inner label is used, the ASBR MUST set the BGP NEXT_HOP attribute to itself.  Otherwise, the BGP NEXT_HOP attribute is left unchanged.  </li>
<li>They MUST establish tunnels as described in <a href="#sec-tunnels">Section 4</a>.  </li>
<li>The ASBR MUST detunnel the packet before forwarding the packet to the remote ASBR.  </li>
<li>The ASBR MUST be able to forward the packet without a FIB lookup.  In other words, the tunnel information itself contains all the information needed by the border router to know which remote ASBR should receive the packet.  </li>
</ol>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> <a href="#spec-sub-prefix" id="spec-sub-prefix">Advertising and Handling Sub-Prefixes</a>
</h1>
<p id="rfc.section.3.4.p.1">Sub-prefixes are advertised and handled by BGP as normal.  VA does not effect this behavior.  The only difference in the handling of sub-prefixes is that they might not be installed in the FIB, as described in <a href="#spec-suppress">Section 3.5</a>.  </p>
<p id="rfc.section.3.4.p.2">In those cases where the route is installed, packets forwarded to prefixes external to the AS MUST be transmitted via the tunnel established as described in <a href="#spec-br">Section 3.3</a>.  </p>
<h1 id="rfc.section.3.5">
<a href="#rfc.section.3.5">3.5.</a> <a href="#spec-suppress" id="spec-suppress">Suppressing FIB Sub-prefix Routes</a>
</h1>
<p id="rfc.section.3.5.p.1">Any route not for a known VP (i.e. not in the VP-List) is taken to be a sub-prefix.  The following rules are used to determine if a sub-prefix route can be suppressed.  </p>
<h1 id="rfc.section.3.5.1">
<a href="#rfc.section.3.5.1">3.5.1.</a> <a href="#spec-pop-pre" id="spec-pop-pre">Selecting Popular Prefixes</a>
</h1>
<p id="rfc.section.3.5.1.p.1">Individual routers MAY independently choose which sub-prefixes are Popular Prefixes.  There is no need for different routers to install the same sub-prefixes.  There is therefore significant leeway as to how routers select Popular Prefixes.  As a general rule, routers should fill the FIB as much as possible, because the cost of doing so is relatively small, and more FIB entries leads to fewer packets taking a longer path.  Broadly speaking, an ISP may choose to fill the FIB by making routers APRs for as many VPs as possible, or by assigning relatively few APRs and rather filling the FIB with Popular Prefixes.  Several basic approaches to selecting Popular Prefixes are outlined here.  Router vendors are free to implement whatever approaches they want.  </p>
<p></p>

<ol>
<li>Policy-based:  The simplest approach for network administrators is to have broad policies that routers use to determine which sub-prefixes are designated as popular.  An obvious policy would be a "customer routes" policy, whereby all customer routes are installed (as identified for instance by appropriate community attribute tags).  Another policy would be for a router to install prefixes originated by specific ASes.  For instance, two ISPs could mutually agree to install each other's originated prefixes.  A third policy might be to install prefixes with the shortest AS-PATH.  </li>
<li>Static list:  Another approach would be to configure static lists of specific prefixes to install.  For instance, prefixes associated with an SLA might be configured.  Or, a list of prefixes for the most popular websites might be installed.  </li>
<li>High-volume prefixes: By installing high-volume prefixes as Popular Prefixes, the latency and load associated with the longer path required by VA is minimized.  One approach would be for an ISP to measure its traffic volume over time (days or a few weeks), and statically configure high-volume prefixes as Popular Prefixes.  There is strong evidence that prefixes that are high-volume tend to remain high-volume over multi-day or multi-week timeframes (though not necessarily at short timeframes like minutes or seconds).  High-volume prefixes MAY also be installed automatically.  For this, a router measures its own traffic volumes, and installs and removes Popular Prefixes in response to changes in traffic load.  The downside of this approach is that it complicates debugging network problems.  If packets are being dropped somewhere in the network, it is more difficult to find out where if the selected path can change dynamically.  </li>
</ol>
<h1 id="rfc.section.3.6">
<a href="#rfc.section.3.6">3.6.</a> <a href="#sec-new-config" id="sec-new-config">New Configuration</a>
</h1>
<p id="rfc.section.3.6.p.1">VA places new configuration requirements on ISP administrators.  Namely, the administrator does the following.  </p>
<h1 id="rfc.section.3.7">
<a href="#rfc.section.3.7">3.7.</a> <a href="#sec-traf-eng" id="sec-traf-eng">Interaction with Traffic Engineering</a>
</h1>
<p id="rfc.section.3.7.p.1">In VA, some traffic traverses an APR as an intermediate "hop", and some does not.  For that traffic that does not, there is no difference between how that traffic is handled and how it is handled in a non-VA network with edge-to-edge tunnels.  As a result, there should be no difference in how traffic engineering operates on that traffic.  </p>
<p id="rfc.section.3.7.p.2">For traffic that does traverse APR "hop", the following holds: Any traffic engineering decisions that affect the BGP NEXT_HOP must be made at the APR.  Traffic engineering decisions that effects the router path through the AS may be handled in one of two ways.  First, the path decision may simply be made twice independently, once for the ingress-to-APR tunnel, and once for the APR-to-egress tunnel.  This approach requires no changes to the traffic engineering mechanisms per se, but it may not make optimal path selection decisions.  Second, the traffic engineering decision may take into account both tunnels, even to the point of choosing among multiple transit APRs.  This approach may be more optimal, but is more complex and requires changes to existing mechanisms.  </p>
<p id="rfc.section.3.7.p.3">Overall, if the majority of traffic does not involve an APR "hop", for instance through the use of popular prefixes, then VA in any event has a minimal impact on traffic engineering, and so the impact of VA may potentially be ignored.  </p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#sec-tunnels" id="sec-tunnels">Usage of MPLS Tunnels</a>
</h1>
<p id="rfc.section.4.p.1">VA utilizes a straight-forward application of MPLS.  The tunnels are MPLS Label Switched Paths (LSP), and are signaled using either the Label Distribution Protocol (LDP) <a href="#RFC5036">[RFC5036]</a> or RSVP-TE <a href="#RFC3209">[RFC3209]</a>.  Both VA and legacy routers MUST participate in this signaling.  </p>
<p id="rfc.section.4.p.2">APRs and ASBRs initiate tunnels.  In both cases, Downstream Unsolicited tunnels are initiated to all IGP neighbors with the full BGP NEXT_HOP address as the Forwarding Equivalence Class (FEC).  In the case of APRs, the BGP NEXT_HOP is the APR's own address.  In the case of legacy ASBRs, the BGP NEXT_HOP is the ASBR's own address.  In the case of VA ASBRs, the BGP NEXT_HOP is that of the remote ASBR.  </p>
<p id="rfc.section.4.p.3">Existing Penultimate Hop Popping (PHP) mechanisms in the data plane can be used for forwarding packets to remote ASBRs.  </p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#sec-inner" id="sec-inner">Usage of Inner Label</a>
</h1>
<p id="rfc.section.4.1.p.1">Besides using a separate LSP to identify the remote ASBR as described above, it is also possible to use an inner label to identify the remote ASBR.  Either an outer label or an IP tunnel identifies the local ASBR.  </p>
<p id="rfc.section.4.1.p.2">When a local ASBR advertises a route into iBGP, it sets the NEXT_HOP to itself, and assigns a label to the route.  This label is used as the inner label, and identifies the remote ASBR from which the route was received <a href="#RFC3107">[RFC3107]</a>.  </p>
<p id="rfc.section.4.1.p.3">The presence of the inner label in the iBGP update acts as the signal to the receiving router that an inner label MUST be used in packets tunneled to the NEXT_HOP address.  If there is an LSP established targeted to the NEXT_HOP address, then it is used to tunnel the packet to the NEXT_HOP address.  Otherwise, an IP header address to the NEXT_HOP address is used.  </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#sec-iana" id="sec-iana">IANA Considerations</a>
</h1>
<p id="rfc.section.5.p.1">There are no IANA considerations.  </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#sec-consider" id="sec-consider">Security Considerations</a>
</h1>
<p id="rfc.section.6.p.1">We consider the security implications of VA under two scenarios, one where VA is assumed to be configured and operated correctly, and one where it is mis-configured.  A cornerstone of VA operation is that the basic behavior of BGP doesn't change, especially inter-domain.  Among other things, this makes it easier to reason about security.  </p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> <a href="#sec-good-con" id="sec-good-con">Properly Configured VA</a>
</h1>
<p id="rfc.section.6.1.p.1">If VA is configured and operated properly, then the external behavior of an AS does not change.  The same upstream ASes are selected, and the same prefixes and AS-PATHs are advertised.  Therefore, a properly configured VA domain has no security impact on other domains.  </p>
<p id="rfc.section.6.1.p.2">If another ISP starts advertising a prefix that is larger than a given VP, this prefix will be ignored by APRs that have a VP that falls within the larger prefix (<a href="#spec-apr">Section 3.2.3</a>).  As a result, packets that might otherwise have been routed to the new larger prefix will be dropped at the APRs.  Note that the trend in the Internet is towards large prefixes being broken up into smaller ones, not the reverse.  Therefore, such a larger prefix is likely to be invalid.  If it is determined without a doubt that the larger prefix is valid, then the ISP will have to reconfigure its VPs.  </p>
<p id="rfc.section.6.1.p.3">VA does not change an ISP's ability to do ingress filtering using strict uRPF (<a href="#spec-suppress">Section 3.5</a>).  </p>
<p id="rfc.section.6.1.p.4">Regarding DoS attacks, there are two issues that need to be considered.  First, does VA result in new types of DoS attacks?  Second, does VA make it more difficult to deploy DoS defense systems.  Regarding the first issue, one possibility is that an attacker targets a given router by flooding the network with traffic to prefixes that are not popular, and for which that router is an APR.  This would cause a disproportionate amount of traffic to be forwarded to the APR(s).  While it is up to individual ISPs to decide if this attack is a concern, it does not strike the authors that this attack is likely to significantly worsen the DoS problem.  </p>
<p id="rfc.section.6.1.p.5">Many DoS defense systems use dynamically established Routing Table entries to divert victims' traffic into LSPs that carry the traffic to scrubbers.  This mechanism works with VA---it simply over-rides whatever route is in place.  This mechanism works equally well with APRs and non-APRs.  </p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> <a href="#sec-miscon" id="sec-miscon">Mis-configured VA</a>
</h1>
<p id="rfc.section.6.2.p.1">VA introduces the possibility that a VP is advertised outside of an AS.  This in fact should be a low probability event since routers filter these, but it is considered here none-the-less.  </p>
<p id="rfc.section.6.2.p.2">If an AS leaks a large VP (i.e. larger than any real prefixes), then the impact is minimal.  Smaller prefixes will be preferred because of best-match semantics, and so the only impact is that packets that otherwise have no matching routes will be sent to the misbehaving AS and dropped there.  If an AS leaks a small VP (i.e. smaller than a real prefix), then packets to that AS will be hijacked by the misbehaving AS and dropped.  (This can happen with or without VA, and so doesn't represent a new security problem per se.) </p>
<p id="rfc.section.6.2.p.3">Although VPs MUST be larger than real prefixes, there is intentionally no mechanism designed to automatically insure that this is the case.  Such a mechanisms would be dangerous.  For instance, if an ISP somewhere advertised a very large prefix (a /4, say), then this would cause APRs to throw out all VPs that are smaller than this.  For this reason, VPs must be set through configuration only.  </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#sec-ack" id="sec-ack">Acknowledgements</a>
</h1>
<p id="rfc.section.7.p.1">The authors would like to acknowledge the efforts of Xinyang Zhang and Jia Wang, who worked on CRIO (Core Router Integrated Overlay), an early inter-domain variant of FIB suppression, and the efforts of Hitesh Ballani and Tuan Cao, who worked on the configuration-only variant of VA that works with legacy routers.  We would also like to thank Scott Brim, Daniel Ginsburg, and Rajiv Asati for their helpful comments.  In particular, Daniel's comments significantly simplified the spec (eliminating the need for a new Extended Communities Attribute).  Finally, we would like to thank Wes George, Med Boucadair, and Bruno Decraene for their reviews and suggestions.  </p>
<h1 id="rfc.references">
<a href="#rfc.references">8.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">8.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3107">[RFC3107]</b></td>
<td class="top">
<a>Rekhter, Y.</a> and <a>E. Rosen</a>, "<a href="http://tools.ietf.org/html/rfc3107">Carrying Label Information in BGP-4</a>", RFC 3107, May 2001.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4271">[RFC4271]</b></td>
<td class="top">
<a>Rekhter, Y.</a>, <a>Li, T.</a> and <a>S. Hares</a>, "<a href="http://tools.ietf.org/html/rfc4271">A Border Gateway Protocol 4 (BGP-4)</a>", RFC 4271, January 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5036">[RFC5036]</b></td>
<td class="top">
<a>Andersson, L.</a>, <a>Minei, I.</a> and <a>B. Thomas</a>, "<a href="http://tools.ietf.org/html/rfc5036">LDP Specification</a>", RFC 5036, October 2007.</td>
</tr>
<tr>
<td class="reference"><b id="RFC1997">[RFC1997]</b></td>
<td class="top">
<a href="mailto:rchandra@cisco.com" title="cisco Systems, Inc.">Chandrasekeran, R.</a>, <a href="mailto:pst@cisco.com" title="cisco Systems, Inc.">Traina, P.</a> and <a href="mailto:tli@skat.usc.edu">T. Li</a>, "<a href="http://tools.ietf.org/html/rfc1997">BGP Communities Attribute</a>", RFC 1997, August 1996.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2827">[RFC2827]</b></td>
<td class="top">
<a>Ferguson, P.</a> and <a>D. Senie</a>, "<a href="http://tools.ietf.org/html/rfc2827">Network Ingress Filtering: Defeating Denial of Service Attacks which employ IP Source Address Spoofing</a>", BCP 38, RFC 2827, May 2000.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3209">[RFC3209]</b></td>
<td class="top">
<a>Awduche, D.</a>, <a>Berger, L.</a>, <a>Gan, D.</a>, <a>Li, T.</a>, <a>Srinivasan, V.</a> and <a>G. Swallow</a>, "<a href="http://tools.ietf.org/html/rfc3209">RSVP-TE: Extensions to RSVP for LSP Tunnels</a>", RFC 3209, December 2001.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4601">[RFC4601]</b></td>
<td class="top">
<a>Fenner, B.</a>, <a>Handley, M.</a>, <a>Holbrook, H.</a> and <a>I. Kouvelas</a>, "<a href="http://tools.ietf.org/html/rfc4601">Protocol Independent Multicast - Sparse Mode (PIM-SM): Protocol Specification (Revised)</a>", RFC 4601, August 2006.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">8.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="nsdi09">[nsdi09]</b></td>
<td class="top">
<a>Ballani, H</a>, <a>Francis, P</a>, <a>Cao, T</a> and <a>J Wang</a>, "<a>Making Routers Last Longer with ViAggre</a>", ACM Usenix NSDI 2009 http://www.usenix.org/events/nsdi09/tech/full_papers/ballani/ballani.pdf, April 2009.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-grow-va-gre">[I-D.ietf-grow-va-gre]</b></td>
<td class="top">
<a>Francis, P</a>, <a>Raszuk, R</a> and <a>X Xu</a>, "<a href="http://tools.ietf.org/html/draft-ietf-grow-va-gre-00">GRE and IP-in-IP Tunnels for Virtual Aggregation</a>", Internet-Draft draft-ietf-grow-va-gre-00, July 2009.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-grow-va-mpls">[I-D.ietf-grow-va-mpls]</b></td>
<td class="top">
<a>Francis, P</a> and <a>X Xu</a>, "<a href="http://tools.ietf.org/html/draft-ietf-grow-va-mpls-00">MPLS Tunnels for Virtual Aggregation</a>", Internet-Draft draft-ietf-grow-va-mpls-00, May 2009.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-grow-va-mpls-innerlabel">[I-D.ietf-grow-va-mpls-innerlabel]</b></td>
<td class="top">
<a>Xu, X</a> and <a>P Francis</a>, "<a href="http://tools.ietf.org/html/draft-ietf-grow-va-mpls-innerlabel-00">Proposal to use an inner MPLS label to identify the remote ASBR VA</a>", Internet-Draft draft-ietf-grow-va-mpls-innerlabel-00, September 2009.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-grow-simple-va">[I-D.ietf-grow-simple-va]</b></td>
<td class="top">
<a>Francis, P</a>, <a>Xu, X</a>, <a>Ballani, H</a>, <a>Raszuk, R</a> and <a>L Zhang</a>, "<a href="http://tools.ietf.org/html/draft-ietf-grow-simple-va-00">Simple Virtual Aggregation (S-VA)</a>", Internet-Draft draft-ietf-grow-simple-va-00, March 2010.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Paul Francis</span> 
	  <span class="n hidden">
		<span class="family-name">Francis</span>
	  </span>
	</span>
	<span class="org vcardline">Max Planck Institute for Software Systems</span>
	<span class="adr">
	  <span>Gottlieb-Daimler-Strasse</span>

	  <span class="vcardline">
		<span class="locality">Kaiserslautern</span>,  
		<span class="region"></span>
		<span class="code">67633</span>
	  </span>
	  <span class="country-name vcardline">Germany</span>
	</span>
	<span class="vcardline">Phone: +49 631 930 39600</span>

<span class="vcardline">EMail: <a href="mailto:francis@mpi-sws.org">francis@mpi-sws.org</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Xiaohu Xu</span> 
	  <span class="n hidden">
		<span class="family-name">Xu</span>
	  </span>
	</span>
	<span class="org vcardline">Huawei Technologies</span>
	<span class="adr">
	  <span>No.3 Xinxi Rd., Shang-Di Information Industry Base, Hai-Dian District </span>

	  <span class="vcardline">
		<span class="locality">Beijing</span>,  
		<span class="region">Beijing</span> 
		<span class="code">100085</span>
	  </span>
	  <span class="country-name vcardline">P.R.China</span>
	</span>
	<span class="vcardline">Phone: +86 10 82836073</span>

<span class="vcardline">EMail: <a href="mailto:xuxh@huawei.com">xuxh@huawei.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Hitesh Ballani</span> 
	  <span class="n hidden">
		<span class="family-name">Ballani</span>
	  </span>
	</span>
	<span class="org vcardline">Cornell University</span>
	<span class="adr">
	  <span>4130 Upson Hall</span>

	  <span class="vcardline">
		<span class="locality">Ithaca</span>,  
		<span class="region">NY</span> 
		<span class="code">14853</span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">Phone: +1 607 279 6780</span>

<span class="vcardline">EMail: <a href="mailto:hitesh@cs.cornell.edu">hitesh@cs.cornell.edu</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Dan Jen</span> 
	  <span class="n hidden">
		<span class="family-name">Jen</span>
	  </span>
	</span>
	<span class="org vcardline">UCLA</span>
	<span class="adr">
	  <span>4805 Boelter Hall </span>

	  <span class="vcardline">
		<span class="locality">Los Angeles</span>,  
		<span class="region">CA</span> 
		<span class="code">90095 </span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:jenster@cs.ucla.edu">jenster@cs.ucla.edu</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Robert Raszuk</span> 
	  <span class="n hidden">
		<span class="family-name">Raszuk</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span>170 West Tasman Drive</span>

	  <span class="vcardline">
		<span class="locality">San Jose</span>,  
		<span class="region">CA </span> 
		<span class="code">95134 </span>
	  </span>
	  <span class="country-name vcardline">USA </span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:raszuk@cisco.com">raszuk@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Lixia Zhang</span> 
	  <span class="n hidden">
		<span class="family-name">Zhang</span>
	  </span>
	</span>
	<span class="org vcardline">UCLA</span>
	<span class="adr">
	  <span>3713 Boelter Hall </span>

	  <span class="vcardline">
		<span class="locality">Los Angeles</span>,  
		<span class="region">CA</span> 
		<span class="code">90095 </span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:lixia@cs.ucla.edu">lixia@cs.ucla.edu</a></span>

  </address>
</div>

</body>
</html>