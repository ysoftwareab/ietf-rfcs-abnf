<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard%20http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Loop-free convergence using oFIB</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";3
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Conventions used in the document">
<link href="#rfc.section.2" rel="Chapter" title="2 Introduction">
<link href="#rfc.section.3" rel="Chapter" title="3 The required FIB update order">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Single Link Events">
<link href="#rfc.section.3.1.1" rel="Chapter" title="3.1.1 Link Down / Metric Increase">
<link href="#rfc.section.3.1.2" rel="Chapter" title="3.1.2 Link Up / Metric Decrease">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Multi-link events">
<link href="#rfc.section.3.2.1" rel="Chapter" title="3.2.1 Router Down events">
<link href="#rfc.section.3.2.2" rel="Chapter" title="3.2.2 Router Up events">
<link href="#rfc.section.3.2.3" rel="Chapter" title="3.2.3 Linecard Failure/Restoration Events">
<link href="#rfc.section.4" rel="Chapter" title="4 Applying ordered FIB updates">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Deducing the topology change">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Deciding if ordered FIB updates applies">
<link href="#rfc.section.5" rel="Chapter" title="5 Computation of the ordering">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Link or Router Down or Metric Increase">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Link or Router Up or Metric Decrease">
<link href="#rfc.section.6" rel="Chapter" title="6 Acceleration of Ordered Convergence">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Construction of the waiting list and notification list">
<link href="#rfc.section.6.1.1" rel="Chapter" title="6.1.1 Down events">
<link href="#rfc.section.6.1.2" rel="Chapter" title="6.1.2 Up Events">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Format of Completion Messages">
<link href="#rfc.section.7" rel="Chapter" title="7 Fall back to Conventional Convergence">
<link href="#rfc.section.8" rel="Chapter" title="8 oFIB state machine">
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 OFIB_STABLE">
<link href="#rfc.section.8.2" rel="Chapter" title="8.2 OFIB_HOLDING_DOWN">
<link href="#rfc.section.8.3" rel="Chapter" title="8.3 OFIB_HOLDING_UP">
<link href="#rfc.section.8.4" rel="Chapter" title="8.4 OFIB_ONGOING">
<link href="#rfc.section.8.5" rel="Chapter" title="8.5 OFIB_ABANDONED">
<link href="#rfc.section.9" rel="Chapter" title="9 IANA considerations">
<link href="#rfc.section.10" rel="Chapter" title="10 Security considerations">
<link href="#rfc.section.11" rel="Chapter" title="11 Acknowledgments">
<link href="#rfc.references" rel="Chapter" title="12 References">
<link href="#rfc.appendix.Appendix%20A" rel="Chapter" title="Appendix A Mechanisms for Safely Abandoning Loop-Free Convergence (AAH)  ">
<link href="#rfc.appendix.Appendix%20A.1" rel="Chapter" title="Appendix A.1 Possible Solutions   ">
<link href="#rfc.appendix.Appendix%20A.2" rel="Chapter" title="Appendix A.2 Hold-down timer only  ">
<link href="#rfc.appendix.Appendix%20A.3" rel="Chapter" title="Appendix A.3 AAH messages">
<link href="#rfc.appendix.Appendix%20A.3.1" rel="Chapter" title="Appendix A.3.1 Per Router State Machine  ">
<link href="#rfc.appendix.Appendix%20A.3.2" rel="Chapter" title="Appendix A.3.2 Per Neighbor State Machine   ">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content=
  "http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.539, 2011-01-02 17:13:00, XSLT vendor: SAXON 6.5.5 from Michael Kay http://saxon.sf.net/" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />
  <meta name="dct.creator" content="Doe, J." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-sample-input-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2010-12" />
  
  <meta name="dct.abstract" content="This document describes a mechanism for use in conjunction with link state routing protocols which prevents the transient loops which would otherwise occur during topology changes. It does this by correctly sequencing the FIB updates on the routers." />
  <meta name="description" content="This document describes a mechanism for use in conjunction with link state routing protocols which prevents the transient loops which would otherwise occur during topology changes. It does this by correctly sequencing the FIB updates on the routers." />
  <meta name="keywords" content="I-D, Internet-Draft" />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">Network Working Group</td>
<td class="right">Pierre Francois</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Olivier Bonaventure</td>
</tr>
<tr>
<td class="left">Intended status: Experimental Protocol</td>
<td class="right">Universite catholique de Louvain</td>
</tr>
<tr>
<td class="left">Expires: October 22, 2011</td>
<td class="right">Mike Shand</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Stewart Bryant</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Stefano Previdi</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Clarence Filsfils</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Cisco Systems</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">April 20, 2011</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Loop-free convergence using oFIB<br />
  <span class="filename">draft-ietf-rtgwg-ordered-fib-05</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document describes a mechanism for use in conjunction with link state routing protocols which prevents the transient loops which would otherwise occur during topology changes. It does this by correctly sequencing the FIB updates on the routers.</p>
<p>This mechanism can be used in the case of non-urgent link or node shutdowns and restarts or link metric changes. It can also be used in conjunction with a fast re-route mechanism which converts a sudden link or node failure into a non-urgent topology change. This is possible where a complete repair path is provided for all affected destinations.</p>
<p>After a non-urgent topology change, each router computes a rank that defines the time at which it can safely update its FIB. A method for accelerating this loop-free convergence process by the use of completion messages is also described.</p>
<p>The technology described in this document has been subject to extensive simulation using real network topologies and costs, and pathological convergence behaviour. A variant of the technology described here has been experimentally deployed in a production network.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of this Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet- Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on October 22, 2011.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2011 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Conventions used in the document</a>
</li>
<li>2.   <a href="#rfc.section.2">Introduction</a>
</li>
<li>3.   <a href="#rfc.section.3">The required FIB update order</a>
</li>
<li>3.1.   <a href="#rfc.section.3.1">Single Link Events</a>
</li>
<li>3.1.1.   <a href="#rfc.section.3.1.1">Link Down / Metric Increase</a>
</li>
<li>3.1.2.   <a href="#rfc.section.3.1.2">Link Up / Metric Decrease</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Multi-link events</a>
</li>
<li>3.2.1.   <a href="#rfc.section.3.2.1">Router Down events</a>
</li>
<li>3.2.2.   <a href="#rfc.section.3.2.2">Router Up events</a>
</li>
<li>3.2.3.   <a href="#rfc.section.3.2.3">Linecard Failure/Restoration Events</a>
</li>
<li>4.   <a href="#rfc.section.4">Applying ordered FIB updates</a>
</li>
<li>4.1.   <a href="#rfc.section.4.1">Deducing the topology change</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Deciding if ordered FIB updates applies</a>
</li>
<li>5.   <a href="#rfc.section.5">Computation of the ordering</a>
</li>
<li>5.1.   <a href="#rfc.section.5.1">Link or Router Down or Metric Increase</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">Link or Router Up or Metric Decrease</a>
</li>
<li>6.   <a href="#rfc.section.6">Acceleration of Ordered Convergence</a>
</li>
<li>6.1.   <a href="#rfc.section.6.1">Construction of the waiting list and notification list</a>
</li>
<li>6.1.1.   <a href="#rfc.section.6.1.1">Down events</a>
</li>
<li>6.1.2.   <a href="#rfc.section.6.1.2">Up Events</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">Format of Completion Messages</a>
</li>
<li>7.   <a href="#rfc.section.7">Fall back to Conventional Convergence</a>
</li>
<li>8.   <a href="#rfc.section.8">oFIB state machine</a>
</li>
<li>8.1.   <a href="#rfc.section.8.1">OFIB_STABLE</a>
</li>
<li>8.2.   <a href="#rfc.section.8.2">OFIB_HOLDING_DOWN</a>
</li>
<li>8.3.   <a href="#rfc.section.8.3">OFIB_HOLDING_UP</a>
</li>
<li>8.4.   <a href="#rfc.section.8.4">OFIB_ONGOING</a>
</li>
<li>8.5.   <a href="#rfc.section.8.5">OFIB_ABANDONED</a>
</li>
<li>9.   <a href="#rfc.section.9">IANA considerations</a>
</li>
<li>10.   <a href="#rfc.section.10">Security considerations</a>
</li>
<li>11.   <a href="#rfc.section.11">Acknowledgments</a>
</li>
<li>12.   <a href="#rfc.references">References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.Appendix%20A">Mechanisms for Safely Abandoning Loop-Free Convergence (AAH)  </a>
</li>
<li>Appendix A.1.   <a href="#rfc.appendix.Appendix%20A.1">Possible Solutions   </a>
</li>
<li>Appendix A.2.   <a href="#rfc.appendix.Appendix%20A.2">Hold-down timer only  </a>
</li>
<li>Appendix A.3.   <a href="#rfc.appendix.Appendix%20A.3">AAH messages</a>
</li>
<li>Appendix A.3.1.   <a href="#rfc.appendix.Appendix%20A.3.1">Per Router State Machine  </a>
</li>
<li>Appendix A.3.2.   <a href="#rfc.appendix.Appendix%20A.3.2">Per Neighbor State Machine   </a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> Conventions used in the document</h1>
<p id="rfc.section.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC2119 <a href="#RFC2119">[RFC2119]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> Introduction</h1>
<p id="rfc.section.2.p.1">With link-state protocols, such as IS-IS <a href="#ISO10589">[ISO10589]</a> and OSPF <a href="#RFC2328">[RFC2328]</a>, each time the network topology changes, some routers need to modify their Forwarding Information Base (FIB) to take into account the new topology.  Each topology change causes a convergence phase. During this phase, routers may transiently have inconsistent FIBs, which may lead to packet loops and losses, even if the reachability of the destinations is not compromised after the topology change. Packet losses and transient loops can also occur in the case of a link down event implied by a maintenance operation, even if this operation is predictable and not urgent. When the link state change is a metric update and when a new link is brought up in the network, there is no direct loss of connectivity, but transient packet loops and loss can still occur.</p>
<p id="rfc.section.2.p.2">For example, in <a href="#fig.example">Figure 1</a>, if the link between X and Y is shut down by an operator, packets destined to X can loop between R and Y when Y has updated its FIB while R has not yet updated its FIB, and packets destined to Y can loop between X and S if X updates its FIB before S. According to the current behaviour of ISIS and OSPF, this scenario will happen most of the time because X and Y are the first routers to be aware of the failure, so that they will update their FIBs first.</p>
<div id="#rfc.figure.1"></div>
<div id="#fig.example"></div>
<p></p>
<pre>
                                  1               				  
                    X-------------/-------------Y   
                    |                           |   
                    |                           |   
                    |                           |   
                    |                           |   
                  1 |                           | 1 
                    |                           |   
                    |                           |   
                    |                           |   
                    |                           |   
                    S---------------------------R   
                                  2
</pre>
<p id="rfc.section.2.p.3">It should be noted that the loops can occur remotely from the failure, not just adjacent to it.</p>
<p id="rfc.section.2.p.4">The goal of this document is to define a mechanism which sequences the router FIB updates to maintain consistency throughout the network.  By correctly setting the FIB change order no looping or packet loss can occur. This mechanism may be applied to the case of managed link-state changes, i.e. link metric change, manual link down/up, manual router down/up, and managed state changes of a set of links attached to one router. It may also be applied to the case where one or more network elements are protected by a fast re-route mechanism <a href="#RFC5714">[RFC5714]</a> <a href="#RFC4090">[RFC4090]</a>. The mechanisms that are used in the failure case are exactly the same as those used for managed changes. For simplicity this document makes no further distinction between managed and unplanned changes.</p>
<p id="rfc.section.2.p.5">The technology described in this document has been subject to extensive simulation using real network topologies and costs and pathological convergence behaviour. A variant of the technology described here has been experimentally deployed in a production network.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#sec.ordering" id="sec.ordering">The required FIB update order</a>
</h1>
<p id="rfc.section.3.p.1">This section provides an overview of the required ordering of the FIB updates. A more detailed analysis of the rerouting dynamics and correctness proofs of the mechanism can be found in <a href="#refs.PFOB07">[refs.PFOB07]</a>.</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#sec.ordering.single" id="sec.ordering.single">Single Link Events</a>
</h1>
<p id="rfc.section.3.1.p.1">For simplicity the correct ordering for single link changes are described first. The document then builds on this to demonstrate that the same principles can be applied to more complex scenarios such as line card or node changes.</p>
<h1 id="rfc.section.3.1.1">
<a href="#rfc.section.3.1.1">3.1.1.</a> <a href="#sec.ordering.single.down" id="sec.ordering.single.down">Link Down / Metric Increase</a>
</h1>
<p id="rfc.section.3.1.1.p.1">First consider the non-urgent failure of a link or the increase of a link metric. In this case, a router R MUST NOT update its FIB until all other routers that send traffic via R and the affected link have first updated their FIBs.</p>
<p id="rfc.section.3.1.1.p.2">The following argument shows that this rule ensures the correct order of FIB change when the link X-&gt;Y is shut down or its metric is increased.</p>
<p id="rfc.section.3.1.1.p.3">An "outdated" FIB entry for a destination is defined as being a FIB entry that still reflects the shortest path(s) in use before the topology change. Once a packet reaches a router R that has an outdated FIB entry for the packet destination, then, provided the oFIB ordering is respected, the packet will continue to X only traversing routers that also have an outdated FIB entry for the destination. The packet thus reaches X without looping and will be forwarded to Y via X-&gt;Y (or in the case of FRR, the X-&gt;Y repair path) and hence reach its destination.</p>
<p id="rfc.section.3.1.1.p.4">Since it can be assumed that the original topology was loop-free, Y will never use the link Y-&gt;X to reach the destination and hence the path(s) between Y and the destination are guaranteed to be unaffected by the topology change. It therefore follows that the packet arriving at Y will reach its destination without looping.</p>
<p id="rfc.section.3.1.1.p.5">Since it can also be assumed that the new topology is loop-free, by definition a packet cannot loop while being forwarded exclusively by routers with an updated FIB entry.</p>
<p id="rfc.section.3.1.1.p.6">In other words, when the oFIB ordering is respected, if a packet reaches an outdated router, it can never subsequently reach an updated router, and cannot loop because from this point on it will only be forwarded on the consistent path that was used before the event. If it does not reach an outdated router, it will only be forwarded on the loop free path that will be used after the convergence.</p>
<p id="rfc.section.3.1.1.p.7">According to the proposed ordering, X will be the last router to update its FIB. Once it has updated its FIB, the link X-&gt;Y can actually be shut down (or the repair removed).</p>
<p id="rfc.section.3.1.1.p.8">If the link X-Y is bidirectional a similar process must be run to order the FIB update for destinations using the link in the direction Y-&gt;X. As has already been shown, no packet ever traverses the X-Y link in both directions, and hence the operation of the two ordering processes is orthogonal.</p>
<h1 id="rfc.section.3.1.2">
<a href="#rfc.section.3.1.2">3.1.2.</a> <a href="#sec.ordering.single.up" id="sec.ordering.single.up">Link Up / Metric Decrease</a>
</h1>
<p id="rfc.section.3.1.2.p.1">In the case of link up events or metric decreases, a router R MUST update its FIB BEFORE all other routers that WILL use R to reach the affected link.</p>
<p id="rfc.section.3.1.2.p.2">The following argument shows that this rule ensures the correct order of FIB change when the link X-&gt;Y is brought into service or its metric is decreased.</p>
<p id="rfc.section.3.1.2.p.3">Firstly, when a packet reaches a router R that has already updated its FIB, all the routers on the path from R to X will also have updated their FIB, so that the packet will reach X and be forwarded along X-&gt;Y, ultimately reaching its destination.</p>
<p id="rfc.section.3.1.2.p.4">Secondly, a packet cannot loop between routers that have not yet updated their FIB. This proves that no packet can loop.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#sec.ordering.multilink" id="sec.ordering.multilink">Multi-link events</a>
</h1>
<p id="rfc.section.3.2.p.1">The following sections describe the required ordering for single events which may be manifest as multiple link events. For example, the failure of a router may be notified to the rest of the network as the individual failure of all its attached links. The means of identifying the event type from the collection of received link events is described in <a href="#sec.deducing">Section 4.1</a>.</p>
<h1 id="rfc.section.3.2.1">
<a href="#rfc.section.3.2.1">3.2.1.</a> <a href="#sec.ordering.linecard.router.down" id="sec.ordering.linecard.router.down">Router Down events</a>
</h1>
<p id="rfc.section.3.2.1.p.1">In the case of the non-urgent shut-down of a router, a router R MUST NOT update its FIB until all other routers that send traffic via R and the affected router have first updated their FIBs.</p>
<p id="rfc.section.3.2.1.p.2">Using a proof similar to that for link failure, it can be shown that no loops will occur if this ordering is respected <a href="#refs.PFOB07">[refs.PFOB07]</a>.</p>
<h1 id="rfc.section.3.2.2">
<a href="#rfc.section.3.2.2">3.2.2.</a> <a href="#sec.ordering.linecard.router.up" id="sec.ordering.linecard.router.up">Router Up events</a>
</h1>
<p id="rfc.section.3.2.2.p.1">In the case of a router being brought into service, a router R MUST update its FIB BEFORE all other routers that WILL use R to reach the affected router.</p>
<p id="rfc.section.3.2.2.p.2">A proof similar to that for link up, shows that no loops will occur if this ordering is respected <a href="#refs.PFOB07">[refs.PFOB07]</a>.</p>
<h1 id="rfc.section.3.2.3">
<a href="#rfc.section.3.2.3">3.2.3.</a> <a href="#sec.ordering.multilink.linecards" id="sec.ordering.multilink.linecards">Linecard Failure/Restoration Events</a>
</h1>
<p id="rfc.section.3.2.3.p.1">The failure of a line card involves the failure of a set of links all of which have a single node in common, i.e. the parent router.  The ordering to be applied is the same as if it were the failure of the parent router.</p>
<p id="rfc.section.3.2.3.p.2">In a similar way, the restoration of an entire linecard to service as a single event can be treated as if the parent router were returning to service.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#sec.applying" id="sec.applying">Applying ordered FIB updates</a>
</h1>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#sec.deducing" id="sec.deducing">Deducing the topology change</a>
</h1>
<p id="rfc.section.4.1.p.1">As has been described, a single event such as the failure or restoration of a single link, single router or a linecard may be notified to the rest of the network as a set of individual link change events. It is necessary to deduce from this collection of link state notifications the type of event that has occurred in the network and hence the required ordering.</p>
<p id="rfc.section.4.1.p.2">When a link change event is received which impacts the receiving router's FIB, the routers at the near and far end of the link are noted.</p>
<p id="rfc.section.4.1.p.3">If all events received within some hold-down period have a single router (R) in common, then it is assumed that the change reflects an event (line-card or router change) concerning the common router (R).</p>
<p id="rfc.section.4.1.p.4">In the case of a link change event, the router at the far end of the link is deemed to be the common router (R).</p>
<p id="rfc.section.4.1.p.5">All ordering computations are based on treating the common router R as the root for both link and node events.</p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#sec.deciding" id="sec.deciding">Deciding if ordered FIB updates applies</a>
</h1>
<p id="rfc.section.4.2.p.1">There are some events (for example a subsequent failure with conflicting repair requirements occurring before the ordered FIB process has completed) that cannot be correctly processed by this mechanism. In these cases it is necessary to ensure that convergence falls back to the conventional mode of operation (see <a href="#sec.fallback">Section 7</a>).</p>
<p id="rfc.section.4.2.p.2">In all cases it is necessary to wait some hold-down period after receiving the first notification to ensure that all routers have received the complete set of link state notifications associated with the single event.</p>
<p id="rfc.section.4.2.p.3">At any time, if a link change notification is received which would have no effect on the receiving router's FIB, then it may be ignored.</p>
<p id="rfc.section.4.2.p.4">If no other event is received during the hold-down time, the event is treated as a link event. Note that the reverse connectivity check means that only the first failure event, or second up event have an effect on the FIB.</p>
<p id="rfc.section.4.2.p.5">If an event is received within the hold down period which does NOT reference the common router (R) then in this version of the specification normal convergence is invoked immediately (see <a href="#sec.fallback">Section 7</a>).</p>
<p id="rfc.section.4.2.p.6">The sudden failure of a link or a set of links that are not protected using a FRR mechanism must be processed using the conventional mode of operation.</p>
<p id="rfc.section.4.2.p.7">In summary an ordered FIB process is applicable if the set of link state notifications received between the first event and the hold down period reference a common router R, and one of the following assertions is verified : </p>

<ul class="empty">
<li>. The set of notifications refer to link down events concerning protected links and metric increase events</li>
<li>. The set of notifications refer to link up events and metric decrease events.</li>
</ul>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#sec.calculation" id="sec.calculation">Computation of the ordering</a>
</h1>
<p id="rfc.section.5.p.1">This section describes how the required ordering is computed.</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#sec.implementation.down" id="sec.implementation.down">Link or Router Down or Metric Increase</a>
</h1>
<p id="rfc.section.5.1.p.1">To respect the proposed ordering, routers compute a rank that will be used to determine the time at which they are permitted to perform their FIB update. In the case of a failure event rooted at router Y or an increase of the metric of link X-&gt;Y, router R computes the reverse Shortest Path Tree (rSPT) in the topology before the failure (rSPT_OLD) rooted at Y. This rSPT gives the shortest paths to reach Y before the failure. The branch of the reverse SPT that is below R corresponds to the set of shortest paths to R that are used by the routers that reach Y via R.</p>
<p id="rfc.section.5.1.p.2">The rank of router R is defined as the depth (in number of hops) of this branch. In the case of ECMP, the maximum depth of the ECMP path set is used.</p>
<p id="rfc.section.5.1.p.3">Router R is required to update its FIB at time</p>
<p id="rfc.section.5.1.p.4">T0 + H + rank * MAX_FIB</p>
<p id="rfc.section.5.1.p.5">where T0 is the arrival time of the link-state packet containing the topology change, H is the hold-down time and MAX_FIB is a network-wide constant that reflects the maximum time required to update a FIB irrespective of the change required. The value of MAX_FIB is network specific and its determination is out of the scope of this document. This value must be agreed by all the routers in the network.  This agreement can be performed by using a capability TLV as defined in <a href="#I-D.atlas-bryant-shand-lf-timers">[I-D.atlas-bryant-shand-lf-timers]</a>.</p>
<p id="rfc.section.5.1.p.6">All the routers that use R to reach Y will compute a lower rank than R, and hence the correct order will be respected. It should be noted that only the routers that used Y before the event need to compute their rank.</p>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#sec.implementation.up" id="sec.implementation.up">Link or Router Up or Metric Decrease</a>
</h1>
<p id="rfc.section.5.2.p.1">In the case of a link or router up event rooted at Y or a link metric decrease affecting link Y-&gt;W, a router R must have a rank that is higher than the rank of the routers that it will use to reach Y, according to the rule described in <a href="#sec.ordering">Section 3</a>. The rank of R is thus the number of hops between R and Y in its renewed Shortest Path Tree. When R has multiple equal cost paths to Y, the rank is the length in hops of the longest ECMP path to Y.</p>
<p id="rfc.section.5.2.p.2">Router R is required to update its FIB at time</p>
<p id="rfc.section.5.2.p.3">T0 + H + rank * MAX_FIB</p>
<p id="rfc.section.5.2.p.4">It should be noted that only the routers that use Y after the event have to compute a rank, i.e. only the routers that have Y in their SPT after the link-state change.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#sec.completion" id="sec.completion">Acceleration of Ordered Convergence</a>
</h1>
<p id="rfc.section.6.p.1">The mechanism described above is conservative, and hence may be relatively slow. The purpose of this section is to describe a method of accelerating the controlled convergence in such a way that ordered loop-free convergence is still guaranteed.</p>
<p id="rfc.section.6.p.2">In many cases a router will complete its required FIB changes in a time much shorter than MAX_FIB and in many other cases, a router will not have to perform any FIB change at all.</p>
<p id="rfc.section.6.p.3">This section describes the use of completion messages to speed up the convergence by providing a means for a router to inform those routers waiting for it, that it has completed any required FIB changes. When a router has been advised of completion by all the routers for which it is waiting, it can safely update its own FIB without further delay. In most cases this can result in a sub-second re-convergence time comparable with that of normal convergence.</p>
<p id="rfc.section.6.p.4">Routers maintain a waiting list of the neighbours from which a completion message must be received. Upon reception of a completion message from a neighbour, a router removes this neighbour from its waiting list. Once its waiting list becomes empty, the router is allowed to update its FIB immediately even if its ranking timer has not yet expired. Once this is done, the router sends a completion message to the neighbours that are waiting for it to complete. Those routers are listed in a list called the Notification List. Completion messages contain an identification of the event to which they refer.</p>
<p id="rfc.section.6.p.5">Note that, since this is only an optimization, any loss of completion messages will result in the routers waiting their defined ranking time and hence the loop-free properties will be preserved.</p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> <a href="#sec.completion.construction" id="sec.completion.construction">Construction of the waiting list and notification list</a>
</h1>
<h1 id="rfc.section.6.1.1">
<a href="#rfc.section.6.1.1">6.1.1.</a> <a href="#sec.completion.construction.down" id="sec.completion.construction.down">Down events</a>
</h1>
<p id="rfc.section.6.1.1.p.1">Consider a link or node down event rooted at router Y or the cost increase of the link X-&gt;Y. A router R will compute rSPT_OLD(Y) to determine its rank. When doing this, R also computes the set of neighbors that R uses to reach the failing node or link, and the set of neighbors that are using R to reach the failing node or link. The Notification list of R is equal to the former set and the Waiting list of R is equal to the latter.</p>
<p id="rfc.section.6.1.1.p.2">Note that R could include all its neighbors except those in the Waiting list in the Notification list, this has no impact on the correctness of the protocol, but would be unnecessarily inefficient.</p>
<h1 id="rfc.section.6.1.2">
<a href="#rfc.section.6.1.2">6.1.2.</a> <a href="#sec.completion.construction.up" id="sec.completion.construction.up">Up Events</a>
</h1>
<p id="rfc.section.6.1.2.p.1">Consider a link or node up event rooted at router Y or the cost decrease of the link Y-&gt;X. A router R will compute its new SPT (SPT_new(R)). The Waiting list is the set of next hop routers that R uses to reach Y in SPT_new(R).</p>
<p id="rfc.section.6.1.2.p.2">In a simple implementation the notification list of R is all the neighbours of R excluding those in the Waiting list. This may be further optimized by computing rSPT_new(Y) to determine those routers that are waiting for R to complete.</p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> <a href="#sec.completion.format" id="sec.completion.format">Format of Completion Messages</a>
</h1>
<p id="rfc.section.6.2.p.1">The format of completion messages and means of their delivery is routing protocol dependent and is outside the scope of this document.  An encoding of completion message for IS-IS is proposed in <a href="#I-D.bonaventure-isis-ordered">[I-D.bonaventure-isis-ordered]</a>.</p>
<p id="rfc.section.6.2.p.2">The following information is required:</p>
<p></p>

<ul class="empty">
<li>. Identity of the sender.</li>
<li>. A list of routing notifications being considered in the associated FIB change. Each notification is defined as :</li>
</ul>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#sec.fallback" id="sec.fallback">Fall back to Conventional Convergence</a>
</h1>
<p id="rfc.section.7.p.1">In circumstances where a router detects that it is dealing with incomplete or inconsistent link state information, or when a further topology event is received before completion of the current ordered FIB update process, it may be expedient to abandon the controlled convergence process. A number of possible fall back mechanisms are described in <a href="#AAHapp">Appendix Appendix A</a>. The state machine defined in the body of this document does not make any assumption about which fall back mechanism will be used.</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> oFIB state machine</h1>
<p id="rfc.section.8.p.1">An oFIB capable router maintains an oFIB state value which can be one of : OFIB_STABLE, OFIB_HOLDING_DOWN, OFIB_HOLDING_UP, OFIB_ABANDONED, OFIB_ONGOING.</p>
<p id="rfc.section.8.p.2">An oFIB capable router maintains a timer, Hold_down_timer. An oFIB capable router is configured with a value referred to as HOLD_DOWN_DURATION. This configuration can be performed manually or using <a href="#I-D.atlas-bryant-shand-lf-timers">[I-D.atlas-bryant-shand-lf-timers]</a>.</p>
<p id="rfc.section.8.p.3">An oFIB capable router maintains a timer, rank_timer.</p>
<h1 id="rfc.section.8.1">
<a href="#rfc.section.8.1">8.1.</a> OFIB_STABLE</h1>
<p id="rfc.section.8.1.p.1">OFIB_STABLE is the state of a router which is not currently involved in any convergence process. This router is ready to process an event by applying oFIB.</p>
<p id="rfc.section.8.1.p.2">EVENT : Reception of a link-state packet describing an event of the type link X--Y down or metric increase to be processed using oFIB.</p>
<p id="rfc.section.8.1.p.3">ACTION : Set state to OFIB_HOLDING_DOWN. Start Hold_down_timer.  ofib_current_common_set = {X,Y}. Compute rank with respect to the event, as defined in <a href="#sec.calculation">Section 5</a>. Store Waiting List and Notification List for X--Y obtained from the rank computation.</p>
<p id="rfc.section.8.1.p.4">EVENT : Reception of a link-state packet describing an event of the type link X--Y up or metric decrease which to be processed using oFIB.</p>
<p id="rfc.section.8.1.p.5">ACTION :</p>
<p></p>

<ul class="empty">
<li>Set state to OFIB_HOLDING_UP.</li>
<li>Start Hold_down_timer.</li>
<li>ofib_current_common_set = {X,Y}</li>
<li>Compute rank with respect to the event, as defined in section <a href="#sec.calculation">Section 5</a> .</li>
<li>Store Waiting List and Notification List for X--Y obtained from the rank computation.</li>
</ul>
<h1 id="rfc.section.8.2">
<a href="#rfc.section.8.2">8.2.</a> OFIB_HOLDING_DOWN</h1>
<p id="rfc.section.8.2.p.1">OFIB_HOLDING_DOWN is the state of a router that is collecting a set of link down or metric increase link-state packets to be processed together using controlled convergence.</p>
<p id="rfc.section.8.2.p.2">EVENT : Reception of a link-state packet describing an event of the type link up or metric decrease which in itself can be processed using oFIB.</p>
<p id="rfc.section.8.2.p.3">ACTION :</p>
<p></p>

<ul class="empty">
<li>Set state to OFIB_ABANDONED.</li>
<li>Reset Hold_down_timer.</li>
<li>Trigger AAH mechanism</li>
</ul>
<p id="rfc.section.8.2.p.5">EVENT : Reception of a link-state packet describing an event of the type link A--B down or metric increase which in itself can be processed using oFIB.</p>
<p id="rfc.section.8.2.p.6">ACTION :</p>
<p></p>

<ul class="empty">
<li>ofib_current_common_set = intersection(ofib_current_common_set,{A,B}).</li>
<li>If ofib_current_common_set is empty, then there is no longer a node in common in all the pending link-state changes.</li>
<li>If ofib_current_common set is not empty, update waiting list and notification list as defined in <a href="#sec.calculation">Section 5</a>. Note that in the case of a single link event, the link-state packet received when the router is in this state describes the state change of the other direction of the link, hence no changes will be made to the waiting and notification lists.</li>
</ul>
<p id="rfc.section.8.2.p.8">EVENT : Hold_down_timer expires.</p>
<p id="rfc.section.8.2.p.9">ACTION :</p>
<p></p>

<ul class="empty">
<li>Set state to OFIB_ONGOING.</li>
<li>Start rank_timer with computed rank.</li>
</ul>
<p id="rfc.section.8.2.p.11">EVENT : Reception of a completion message</p>
<p id="rfc.section.8.2.p.12">ACTION : Remove the sender from waiting list associated with the event identified in the completion message.</p>
<h1 id="rfc.section.8.3">
<a href="#rfc.section.8.3">8.3.</a> OFIB_HOLDING_UP</h1>
<p id="rfc.section.8.3.p.1">OFIB_HOLDING_UP is the state of a router that is collecting a set of link up or metric decrease link-state packets to be processed together using controlled convergence.</p>
<p id="rfc.section.8.3.p.2">EVENT : Reception of a link-state packet describing an event of the type link down or metric increase to be processed using oFIB.</p>
<p id="rfc.section.8.3.p.3">ACTION :</p>
<p></p>

<ul class="empty">
<li>Set state to OFIB_ABANDONED.</li>
<li>Reset Hold_down_timer.</li>
<li>Trigger AAH mechanism.</li>
</ul>
<p id="rfc.section.8.3.p.5">EVENT : Reception of a link-state packet describing an event of the type link A--B up or metric decrease to be processed using oFIB.</p>
<p id="rfc.section.8.3.p.6">ACTION :</p>
<p></p>

<ul class="empty">
<li>ofib_current_common_set = intersection(ofib_current_common_set,{A,B}).</li>
<li>If ofib_current_common_set is empty, then there is no longer a common node in the set of pending link-state changes.</li>
<li>If ofib_current_common set is not empty, update waiting list and notification list as defined in <a href="#sec.calculation">Section 5</a>. Note that in the case of a single link event, the link-state packet received when the router is in this state describes the state change of the other direction of the link, hence no changes will be made to the waiting and notification lists.</li>
</ul>
<p id="rfc.section.8.3.p.8">EVENT : Reception of a completion message</p>
<p id="rfc.section.8.3.p.9">ACTION : Remove the sender from the waiting list associated with the event identified in the completion message.</p>
<p id="rfc.section.8.3.p.10">EVENT : Hold_down_timer expires.</p>
<p id="rfc.section.8.3.p.11">ACTION :</p>
<p></p>

<ul class="empty">
<li>Set state to OFIB_ONGOING.</li>
<li>Start rank_timer with computed rank.</li>
</ul>
<h1 id="rfc.section.8.4">
<a href="#rfc.section.8.4">8.4.</a> OFIB_ONGOING</h1>
<p id="rfc.section.8.4.p.1">OFIB_ONGOING is the state of a router that is applying the ordering mechanism w.r.t. the set of LSP collected when in OFIB_HOLDING_DOWN or OFIB_HOLDING_UP state.</p>
<p id="rfc.section.8.4.p.2">EVENT : rank_timer expires or waiting list becomes empty.</p>
<p id="rfc.section.8.4.p.3">ACTION :</p>
<p></p>

<ul class="empty">
<li>Perform FIB updates according to the change.</li>
<li>Send completion message to each member of the notification list.</li>
<li>Set State to OFIB_STABLE.</li>
</ul>
<p id="rfc.section.8.4.p.5">EVENT : Reception of a completion message</p>
<p id="rfc.section.8.4.p.6">ACTION : Remove the sender from the waiting list.</p>
<p id="rfc.section.8.4.p.7">EVENT : Reception of a link-state packet describing a link state change event.</p>
<p id="rfc.section.8.4.p.8">ACTION :</p>
<p></p>

<ul class="empty">
<li>Set state to OFIB_ABANDONED.</li>
<li>Trigger AAH.</li>
<li>Start Hold_down_timer.</li>
</ul>
<h1 id="rfc.section.8.5">
<a href="#rfc.section.8.5">8.5.</a> OFIB_ABANDONED</h1>
<p id="rfc.section.8.5.p.1">OFIB_ABANDONED is the state of a router that has fallen back to fast convergence due to the reception of link-state packets that cannot be dealt together using oFIB.</p>
<p id="rfc.section.8.5.p.2">EVENT : Reception of a link-state packet describing a link-state change event.</p>
<p id="rfc.section.8.5.p.3">ACTION : Trigger AAH, reset Hold_down_timer.</p>
<p id="rfc.section.8.5.p.4">EVENT : Hold_down_timer expires.</p>
<p id="rfc.section.8.5.p.5">ACTION : Set state to OFIB_STABLE</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> IANA considerations</h1>
<p id="rfc.section.9.p.1">There are no IANA considerations which arise from this document. Any such considerations will be called out in protocol specific documents such as <a href="#I-D.atlas-bryant-shand-lf-timers">[I-D.atlas-bryant-shand-lf-timers]</a><a href="#I-D.bonaventure-isis-ordered">and</a> <cite title="NONE">[I-D.bonaventure-isis-ordered]</cite></p>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> Security considerations</h1>
<p id="rfc.section.10.p.1">This document requires only minor modifications to existing routing protocols and therefore does not add significant additional security risks. However a full security analysis would need to be provided within the protocol specific specifications proposed for deployment.</p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> <a href="#sec.ack" id="sec.ack">Acknowledgments</a>
</h1>
<p id="rfc.section.11.p.1">We would like to thank Jean-Philippe Vasseur and Les Ginsberg for their useful suggestions and comments.</p>
<h1 id="rfc.references">
<a href="#rfc.references">12.</a> References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="1">[1]</b></td>
<td class="top">
<a>International Organization for Standardization</a>, "<a>Intermediate system to Intermediate system intra-domain routeing information exchange protocol for use in conjunction with the protocol for providing the connectionless-mode Network Service (ISO 8473)</a>", ISO/IEC 10589:2002, Second Edition, Nov 2002.</td>
</tr>
<tr>
<td class="reference"><b id="2">[2]</b></td>
<td class="top">
<a>Bonaventure, O</a>, "<a href="http://tools.ietf.org/html/draft-bonaventure-isis-ordered-00">ISIS extensions for ordered FIB updates</a>", Internet-Draft draft-bonaventure-isis-ordered-00, February 2006.</td>
</tr>
<tr>
<td class="reference"><b id="3">[3]</b></td>
<td class="top">
<a>P. Francois, </a> and <a>O. Bonaventure</a>, "<a>Avoiding transient loops during IGP convergence in IP Networks</a>", in IEEE/ACM Transactions on Networking, http://inl.info.ucl.ac.be/publications, December 2007.</td>
</tr>
<tr>
<td class="reference"><b id="4">[4]</b></td>
<td class="top">
<a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="5">[5]</b></td>
<td class="top">
<a href="mailto:jmoy@casc.com" title="Ascend Communications, Inc.">Moy, J.</a>, "<a href="http://tools.ietf.org/html/rfc2328">OSPF Version 2</a>", STD 54, RFC 2328, April 1998.</td>
</tr>
<tr>
<td class="reference"><b id="6">[6]</b></td>
<td class="top">
<a>Pan, P.</a>, <a>Swallow, G.</a> and <a>A. Atlas</a>, "<a href="http://tools.ietf.org/html/rfc4090">Fast Reroute Extensions to RSVP-TE for LSP Tunnels</a>", RFC 4090, May 2005.</td>
</tr>
<tr>
<td class="reference"><b id="7">[7]</b></td>
<td class="top">
<a>Shand, M.</a> and <a>S. Bryant</a>, "<a href="http://tools.ietf.org/html/rfc5714">IP Fast Reroute Framework</a>", RFC 5714, January 2010.</td>
</tr>
<tr>
<td class="reference"><b id="8">[8]</b></td>
<td class="top">
<a>Shand, M.</a> and <a>S. Bryant</a>, "<a href="http://tools.ietf.org/html/rfc5715">A Framework for Loop-Free Convergence</a>", RFC 5715, January 2010.</td>
</tr>
<tr>
<td class="reference"><b id="9">[9]</b></td>
<td class="top">
<a>K, A</a> and <a>S Bryant</a>, "<a href="http://tools.ietf.org/html/draft-atlas-bryant-shand-lf-timers-04">Synchronisation of Loop Free Timer Values</a>", Internet-Draft draft-atlas-bryant-shand-lf-timers-04, February 2008.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.Appendix A">
<a href="#rfc.appendix.Appendix%20A">Appendix A.</a> <a href="#AAHapp" id="AAHapp">Mechanisms for Safely Abandoning Loop-Free Convergence (AAH)  </a>
</h1>
<p id="rfc.section.Appendix A.p.1">IPFRR<a href="#RFC5714">[RFC5714]</a> and loop-free convergence techniques <a href="#RFC5715">[RFC5715]</a> can deal with single topology change events, multiple correlated change events, and in some cases even certain uncorrelated events. However, in all cases there are events which cannot be dealt with and the mechanism needs to quickly revert to normal convergence. This is known as "Abandoning All Hope" (AAH).</p>
<p id="rfc.section.Appendix A.p.2">This appendix describes the outcome of a design study into the AAH problem, and is included here to trigger discussion on the trade-offs between complexity and robustness in the AAH solution-space.</p>
<h1 id="rfc.appendix.Appendix A.1">
<a href="#rfc.appendix.Appendix%20A.1">Appendix A.1.</a> Possible Solutions   </h1>
<p id="rfc.section.Appendix A.1.p.1">Two approaches to this problem have been proposed:</p>
<p id="rfc.section.Appendix A.1.p.2">1. Hold-down timer only. </p>
<p id="rfc.section.Appendix A.1.p.3">2. Synchronization of AAH state using AAH messages.</p>
<p id="rfc.section.Appendix A.1.p.4">These are described below. </p>
<p></p>
<h1 id="rfc.appendix.Appendix A.2">
<a href="#rfc.appendix.Appendix%20A.2">Appendix A.2.</a> Hold-down timer only  </h1>
<p id="rfc.section.Appendix A.2.p.1">This method uses a hold-down to acquire a set of LSPs which should be processed together. On expiry of the local hold-down timer, the router begins processing the batch of LSPs according to the loop free prevention algorithm.</p>
<p id="rfc.section.Appendix A.2.p.2">There are a number of problems with this simple approach. In some cases the timer value will be too short to ensure that all the related events have arrived at all routers (perhaps because there was some unexpected propagation delay, or one or more of the events are slow in being detected). In other cases, a completely unrelated event may occur after the timer has expired, but before the processing is complete. In addition, since the timer is started at each router on reception of the first LSP announcing a topology change, the actual starting time is dependant upon the propagation time of the first LSP.  So, for a subsequent event occurring around the time of the timer expiry, because of variations in propagation delay it may reach some routers before the timer expires and others after it has expired. In the former case this LSP will be included in the set of changes to be considered, while in the latter it will be excluded leasing to serious routing inconsistency. In such cases continuing to operate the loop-free convergence protocol may exacerbate the situation.</p>
<p id="rfc.section.Appendix A.2.p.3">The simple approach to this would be to revert to normal convergence (AAH) whenever an LSP is received after the timer has expired. However this also has problems for the reasons above and therefore AAH must be a synchronous operation, i.e. it is necessary to arrange that an AAH invoked anywhere in the network causes ALL routers to AAH.</p>
<p id="rfc.section.Appendix A.2.p.4">It is also necessary to consider the means of exiting the AAH state. Again the simplest method is to use a timer. However while in AAH state any topology changes previously received, or which are subsequently received, should be processed immediately using the traditional convergence algorithms i.e. without invoking controlled convergence. If the exit from the AAH state is not correctly synchronized, a new event may be processed by some routers immediately (as AAH), while those which have already left AAH state will treat it as the first of a new batch of changes and attempt controlled convergence. Thus both entry and exit from the AAH state needs to be synchronised. A method of achieving this is described in <a href="#AAHmsg">Appendix Appendix A.3</a>.</p>
<h1 id="rfc.appendix.Appendix A.3">
<a href="#rfc.appendix.Appendix%20A.3">Appendix A.3.</a> <a href="#AAHmsg" id="AAHmsg">AAH messages</a>
</h1>
<p id="rfc.section.Appendix A.3.p.1">Like the simple timer AAH method, this method uses a hold-down to acquire a set of LSPs which should be processed together. On expiry of the local hold-down timer, the router begins processing the batch of LSPs according to the loop free prevention algorithm. This is the same behaviour as the hold-down timer only method. However, if any router, having started the loop-free convergence process receives an LSP which would trigger a topology change, it locally abandons the controlled convergence process, and sends an AAH message to all its neighbors.  This eventually triggers all routers to abandon the controlled convergence. The routers remain in AAH state (i.e. processing topology changes using normal "fast" convergence), until a period of quiescence has elapsed. The exit from AAH state is synchronized by using a two step process. To achieve the required synchronization, two additional messages are required, AAH and AAH ACK. The AAH message is reliably exchanged between neighbours using the AAH ACK message. These could be implemented as a new message within the routing protocol or carried in existing routing hello messages. Two types of state machines are needed. A per-router AAH state machine and a per neighbour AAH state machine(PNSM). These are described below.</p>
<h1 id="rfc.appendix.Appendix A.3.1">
<a href="#rfc.appendix.Appendix%20A.3.1">Appendix A.3.1.</a> Per Router State Machine  </h1>
<p id="rfc.section.Appendix A.3.1.p.1">Per Router State Table</p>
<div id="#rfc.figure.2"></div>
<pre>+-------------+-----------+---------+--------+------------+----------+
| EVENT       |     Q     |   Hold  |   CC   |     AAH    | AAH-hold |
+=============+===========+=========+========+============+==========+
| RX LSP      |   Start   |    -    | TX-AAH |  Re-start  |  TX-AAH  |
| triggering  | hold-down |         | Start  | AAH timer. |   Start  |
| change      |   timer   |         |  AAH   |    [AAH]   |    AAH   |
|             |   [Hold]  |         | timer. |            |   timer. |
|             |           |         | [AAH]  |            |   [AAH]  |
+-------------+-----------+---------+--------+------------+----------+
| RX AAH      |   TX-AAH  |  TX-AAH | TX-AAH |    [AAH]   |  TX-AAH  |
| (Neighbor's | Start AAH |  Start  | Start  |            |   Start  |
|  PNSM       |   timer.  |   AAH   |  AAH   |            |    AAH   |
|  processes  |   [AAH]   |  timer  | timer. |            |   timer. |
|  RX AAH.)   |           |  [AAH]  | [AAH]  |            |   [AAH]  |
+-------------+-----------+---------+--------+------------+----------+
| Timer       |     -     | Trigger |    -   |    Start   |    [Q]   |
| expiry      |           |   CC.   |        |  AAH-hold  |          |
|             |           |  [CC]   |        |   timer.   |          |
|             |           |         |        | [AAH-hold] |          |
+-------------+-----------+---------+--------+------------+----------+
| Controlled  |     -     |    -    |   [Q]  |      -     |     -    |
| convergence |           |         |        |            |          |
| completed   |           |         |        |            |          |
+-------------+-----------+---------+--------+------------+----------+
 TX-AAH = Send "goto TX-AAH" to all other PNSMs.

</pre>
<p></p>
<p id="rfc.section.Appendix A.3.1.p.3">Operation of the per-router state machine is as follows:</p>
<p id="rfc.section.Appendix A.3.1.p.4">Operation of this state machine under normal topology change involves only states: Quiescent (Q), Hold-down (Hold) and Controlled Convergence (CC). The remaining states are associated with an AAH event.</p>
<p id="rfc.section.Appendix A.3.1.p.5">The resting state is Quiescent. When the router in the Quiescent state receives an LSP indicating a topology change, which would normally trigger an SPF, it starts the Hold-down timer and changes state to Hold-down. It normally remains in this state, collecting additional LSPs until the Hold-down timer expires. Note that all routers MUST use a common value for the Hold-down timer. When the Hold-down timer expires the router then enters Controlled Convergence (CC) state and executes the CC mechanism to re-converge the topology. When the CC process has completed on the router, the router re-enters the Quiescent state.</p>
<p id="rfc.section.Appendix A.3.1.p.6">If this router receives a topology changing LSP whilst it is in the CC state, it enters AAH state, and sends a "goto TX-AAH" command to all per neighbour state machines which causes each per-neighbour state machine to signal this state change to its neighbour.  Alternatively, if this router receives an AAH message from any of its neighbors whilst in any state except AAH, it starts the AAH timer and enters the AAH state. The per neighbor state machine corresponding to the neighbor from which the AAH was received executes the RX AAH action (which causes it to send an AAH ACK), while the remainder are sent the "goto TX-AAH" command. The result is that the AAH is acknowledged to the neighbor from which it was received and propagated to all other neighbors. On entering AAH state, all CC timers are expired and normal convergence takes place.</p>
<p id="rfc.section.Appendix A.3.1.p.7">Whilst in the AAH state, LSPs are processed in the traditional manner. Each time an LSP is received, the AAH timer is restarted. In an unstable network ALL routers will remain in this state for some time and the network will behave in the traditional uncontrolled convergence manner.</p>
<p id="rfc.section.Appendix A.3.1.p.8">When the AAH timer expires, the router enters AAH-hold state and starts the AAH hold timer. The purpose of the AAH-hold state is to synchronize the transition of the network from AAH to Quiescent. The additional state ensures that the network cannot contain a mixture of routers in both AAH and Quiescent states. If, whilst in AAH-Hold state the router receives a topology changing LSP, it re-enters AAH state and commands all per neighbour state machines to "goto TX-AAH". If, whilst in AAH-Hold state the router receives an AAH message from one of its neighbours, it re-enters the AAH state and commands all other per neighbour state machines to "goto TX-AAH".  Note that the per-neighbor state machine receiving the AAH message will autonomously acknowledge receipt of the AAH message. Commanding the per-neighbour state machine to "goto TX-AAH" is necessary, because routers may be in a mixture of Quiescent, Hold-down and AAH-hold state, and it is necessary to rendezvous the entire network back to AAH state.</p>
<p id="rfc.section.Appendix A.3.1.p.9">When the AAH Hold timer expires the router changes to state Quiescent and is ready for loop free convergence.</p>
<h1 id="rfc.appendix.Appendix A.3.2">
<a href="#rfc.appendix.Appendix%20A.3.2">Appendix A.3.2.</a> Per Neighbor State Machine   </h1>
<p id="rfc.section.Appendix A.3.2.p.1">Per Neighbor State Table</p>
<div id="#rfc.figure.3"></div>
<pre>+----------------------------+--------------+------------------------+
| EVENT                      | Idle         | TX-AAH                 |
+============================+==============+========================+
| RX AAH                     | Send ACK.    | Send ACK.              |
|                            |              | Cancel timer.          |
|                            | [IDLE]       | [IDLE]                 |
+----------------------------+--------------+------------------------+
| RX ACK                     | ignore       | Cancel timer.          |
|                            |              | [IDLE]                 |
+----------------------------+--------------+------------------------+
| RX "goto TX-AAH" from      | Send AAH     | ignore                 |
| Router State Machine       | [TX-AAH]     |                        |
+----------------------------+--------------+------------------------+
| Timer expires              | impossible   | Send AAH               |
|                            |              | Restart timer.         |
|                            |              | [TX-AAH]               |
+----------------------------+--------------+------------------------+
</pre>
<p></p>
<p id="rfc.section.Appendix A.3.2.p.3">There is one instance of the per-neighbour (PN) state machine for each neighbour within the convergence control domain.</p>
<p id="rfc.section.Appendix A.3.2.p.4">The normal state is IDLE.</p>
<p id="rfc.section.Appendix A.3.2.p.5">On command ("goto TX-AAH") from the router state machine, the state machine enters TX-AAH state, transmits an AAH message to its neighbour and starts a timer.</p>
<p id="rfc.section.Appendix A.3.2.p.6">On receipt of an AAH ACK in state TX-AAH the state machine cancels the timer and enters IDLE state.</p>
<p id="rfc.section.Appendix A.3.2.p.7">In states IDLE, any AAH ACK message received is ignored.</p>
<p id="rfc.section.Appendix A.3.2.p.8">On expiry of the timer in state TX-AAH the state machine transmits an AAH message to the neighbour and restarts the timer.  (The timer cannot expire in any other state.)</p>
<p id="rfc.section.Appendix A.3.2.p.9">In any state, receipt of an AAH causes the state machine to transmit an AAH ACK and enter the IDLE state.</p>
<p id="rfc.section.Appendix A.3.2.p.10">Note that for correct operation the state machine MUST remain in state TX-AAH, until an AAH ACK or an AAH is received, or the state machine is deleted. Deletion of the per neighbor state machine occurs when routing determines that the neighbour has gone away, or when the interface goes away.</p>
<p id="rfc.section.Appendix A.3.2.p.11">When routing detects a new neighbour it creates a new instance of the per-neighbour state machine in state Idle. The consequent generation of the router's own LSP will then cause the router state machine to execute the LSP receipt actions, which will if necessary result in the new per-neighbour state machine receiving a "goto TX-AAH" command and transitioning to TX-AAH state.</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Pierre Francois</span> 
	  <span class="n hidden">
		<span class="family-name">Pierre Francois</span>
	  </span>
	</span>
	<span class="org vcardline">Universite catholique de Louvain</span>
	<span class="adr">
	  <span>Place Ste Barbe, 2</span>

	  <span class="vcardline">
		<span class="locality">Louvain-la-Neuve</span>,  
		<span class="region"></span>
		<span class="code">1348</span>
	  </span>
	  <span class="country-name vcardline">BE</span>
	</span>
	<span class="vcardline">URI: <a href="http://inl.info.ucl.ac.be/">http://inl.info.ucl.ac.be/</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Olivier Bonaventure</span> 
	  <span class="n hidden">
		<span class="family-name">Olivier Bonaventure</span>
	  </span>
	</span>
	<span class="org vcardline">Universite catholique de Louvain</span>
	<span class="adr">
	  <span>Place Ste Barbe, 2</span>

	  <span class="vcardline">
		<span class="locality">Louvain-la-Neuve</span>,  
		<span class="region"></span>
		<span class="code">1348</span>
	  </span>
	  <span class="country-name vcardline">BE</span>
	</span>
	<span class="vcardline">URI: <a href="http://inl.info.ucl.ac.be/">http://inl.info.ucl.ac.be/</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mike Shand</span> 
	  <span class="n hidden">
		<span class="family-name">Mike Shand</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  <span>Green Park, 250, Longwater Avenue,</span>

	  <span class="vcardline">
		<span class="locality">Reading</span>,  
		<span class="region"></span>
		<span class="code">RG2 6GB</span>
	  </span>
	  <span class="country-name vcardline">UK</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mshand@cisco.com">mshand@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Stewart Bryant</span> 
	  <span class="n hidden">
		<span class="family-name">Stewart Bryant</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  <span>Green Park, 250, Longwater Avenue,</span>

	  <span class="vcardline">
		<span class="locality">Reading</span>,  
		<span class="region"></span>
		<span class="code">RG2 6GB</span>
	  </span>
	  <span class="country-name vcardline">UK</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:stbryant@cisco.com">stbryant@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Stefano Previdi</span> 
	  <span class="n hidden">
		<span class="family-name">Stefano Previdi</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  <span>Via Del Serafico 200</span>

	  <span class="vcardline">
		<span class="locality">00142 Roma</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Italy</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:sprevidi@cisco.com">sprevidi@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Clarence Filsfils</span> 
	  <span class="n hidden">
		<span class="family-name">Clarence Filsfils</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality">Brussels</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">Belgium</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:cfilsfil@cisco.com">cfilsfil@cisco.com</a></span>

  </address>
</div>

</body>
</html>