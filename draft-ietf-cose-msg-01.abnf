start = COSE_MSG

label = int / tstr

COSE_MSG = COSE_Sign /
       COSE_encrypt /
       COSE_mac

COSE_Tagged_MSG = #6.999(COSE_MSG)   ; Replace 999 with TBD1

reserved=0
msg_type_signed=1
msg_type_encrypted=2
msg_type_mac=3


msg_type=1
protected=2
unprotected=3
payload=4
signatures=5
signature=6
ciphertext=4
recipients=9
tag=10


header_map = {+ label => any }

Headers = (
       ? protected => bstr,
       ? unprotected => header_map
COSE_Sign = {
msg_type => msg_type_signed,
signatures => [+ COSE_signature]
COSE_signature =  {
       Headers,
signature => bstr
Sig_structure = [
       body_protected: bstr,
       sign_protected: bstr,
       payload: bstr
COSE_encrypt = {
msg_type=>msg_type_encrypted,
COSE_encrypt_fields = (
       Headers,
       ? ciphertext => bstr,
       ? recipients => [+{COSE_encrypt_fields}]
Enc_structure = [
       protected: bstr,
       external_aad: bstr
COSE_mac = {
msg_type=>msg_type_mac,
tag => bstr,
recipients => [+{COSE_encrypt_fields}]
MAC_structure = [
        protected: bstr,
        external_aad: bstr,
        payload: bstr
COSE_Key = {
kty => tstr / int,
COSE_KeySet = [+COSE_Key]

key_kty=1
key_kid=2
key_alg=3
key_ops=4

key_ops_sign=1
key_ops_verify=2
key_ops_encrypt=3
key_ops_decrypt=4
key_ops_wrap=5
key_ops_unwrap=6
key_ops_agree=7

