<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Verification Involving PSTN Reachability:
    Requirements and Architecture Overview</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Verification Involving PSTN Reachability:
    Requirements and Architecture Overview">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 60em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 60em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 60em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">dispatch</td><td class="header">J. Rosenberg</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">jdrosen.net</td></tr>
<tr><td class="header">Intended status:  Standards Track</td><td class="header">C. Jennings</td></tr>
<tr><td class="header">Expires:  April 28, 2011</td><td class="header">Cisco</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">M. Petit-Huguenin</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Stonyfish</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">October 25, 2010</td></tr>
</table></td></tr></table>
<h1><br />Verification Involving PSTN Reachability:
    Requirements and Architecture Overview<br />draft-rosenberg-dispatch-vipr-overview-04</h1>

<h3>Abstract</h3>

<p>The Session Initiation Protocol (SIP) has seen widespread deployment
      within individual domains, typically supporting voice and video
      communications. Though it was designed from the outset to support
      inter-domain federation over the public Internet, such federation has
      not materialized. The primary reasons for this are the complexities of
      inter-domain phone number routing and concerns over security. This
      document reviews this problem space, outlines requirements, and then
      describes a new model and technique for inter-domain federation with
      SIP, called Verification Involving PSTN Reachability (ViPR). ViPR
      addresses the problems that have prevented inter-domain federation over
      the Internet. It provides fully distributed inter-domain routing for
      phone numbers, authorized mappings from phone numbers to domains, a new
      technique for automated VoIP anti-spam, and privacy of number ownership,
      all while preserving the trapezoidal model of SIP.
</p>
<h3>Legal</h3>

<p>This documents and the information contained therein are provided on
      an "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS
      OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST AND
      THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS OR
      IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE
      INFORMATION THEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
      WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
</p>
<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted  in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF).  Note that other groups may also distribute
working documents as Internet-Drafts.  The list of current
Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
This Internet-Draft will expire on April 28, 2011.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2010 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents
(http://trustee.ietf.org/license-info) in effect on the date of
publication of this document.  Please review these documents
carefully, as they describe your rights and restrictions with respect
to this document. Code Components extracted from this document must
include Simplified BSD License text as described in Section 4.e of
the Trust Legal Provisions and are provided without warranty as
described in the Simplified BSD License.</p>
<a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#anchor2">2.</a>&nbsp;
Problem Statement<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor3">2.1.</a>&nbsp;
The Phone Number Routing Problem<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor4">2.2.</a>&nbsp;
The Open Pinhole Problem<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor5">2.3.</a>&nbsp;
Quality of Service Problem<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor6">2.4.</a>&nbsp;
Troubleshooting Problem<br />
<a href="#anchor7">3.</a>&nbsp;
Summary of Existing Solutions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor8">3.1.</a>&nbsp;
Domain Routing<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor9">3.2.</a>&nbsp;
Public ENUM<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor10">3.3.</a>&nbsp;
Private Federations<br />
<a href="#anchor11">4.</a>&nbsp;
Key Requirements<br />
<a href="#anchor12">5.</a>&nbsp;
Executive Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor13">5.1.</a>&nbsp;
Key Properties<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor14">5.2.</a>&nbsp;
Challenging Past Assumptions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor15">5.3.</a>&nbsp;
Technical Overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor16">5.3.1.</a>&nbsp;
Storage of Phone Numbers<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor17">5.3.2.</a>&nbsp;
PSTN First Call<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor18">5.3.3.</a>&nbsp;
Validation and Caching<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor19">5.3.4.</a>&nbsp;
SIP Call<br />
<a href="#anchor20">6.</a>&nbsp;
Architecture Components and Functions<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor21">6.1.</a>&nbsp;
ViPR Server<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor22">6.2.</a>&nbsp;
Call Agent<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor23">6.3.</a>&nbsp;
Border Element<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor24">6.4.</a>&nbsp;
Enrollment Server<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor25">6.5.</a>&nbsp;
P2P Network<br />
<a href="#anchor26">7.</a>&nbsp;
Protocols<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor27">7.1.</a>&nbsp;
P2P: RELOAD<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor28">7.1.1.</a>&nbsp;
ViPR Usage<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor29">7.1.2.</a>&nbsp;
Certificate Usage<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor30">7.2.</a>&nbsp;
ViPR Access Protocol (VAP)<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor31">7.3.</a>&nbsp;
Validation Protocol<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor32">7.4.</a>&nbsp;
SIP Extensions<br />
<a href="#anchor33">8.</a>&nbsp;
Example Call Flows<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor34">8.1.</a>&nbsp;
PSTN Call and VCR Upload<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor35">8.2.</a>&nbsp;
DHT Query and Validation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor36">8.3.</a>&nbsp;
DHT Query and No Match<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor37">8.4.</a>&nbsp;
SIP Call<br />
<a href="#anchor38">9.</a>&nbsp;
Security Considerations<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor39">9.1.</a>&nbsp;
Attacks on the DHT<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor40">9.2.</a>&nbsp;
Theft of Phone Numbers<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor41">9.3.</a>&nbsp;
Spam<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor42">9.4.</a>&nbsp;
Eavesdropping<br />
<a href="#anchor43">10.</a>&nbsp;
IANA Considerations<br />
<a href="#anchor44">11.</a>&nbsp;
Acknowledgements<br />
<a href="#rfc.references1">12.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">12.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">12.2.</a>&nbsp;
Informative References<br />
<a href="#anchor47">Appendix&nbsp;A.</a>&nbsp;
Release notes<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor48">A.1.</a>&nbsp;
Modifications between rosenberg-04 and rosenberg-03<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>The Session Initiation Protocol (SIP) was originally published as
      <a class='info' href='#RFC2543'>RFC 2543<span> (</span><span class='info'>Handley, M., Schulzrinne, H., Schooler, E., and J. Rosenberg, &ldquo;SIP: Session Initiation Protocol,&rdquo; March&nbsp;1999.</span><span>)</span></a> [RFC2543] in May of 1999. This was followed
      by subsequent publication of <a class='info' href='#RFC3261'>RFC 3261<span> (</span><span class='info'>Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;SIP: Session Initiation Protocol,&rdquo; June&nbsp;2002.</span><span>)</span></a> [RFC3261],
      which brought the protocol to sufficient maturity to enable large scale
      market adoption.
</p>
<p>And indeed, it has seen large scale market adoption. SIP has seen
      hundreds of implementations, spanning consumer products, enterprise
      servers, and large scale carrier equipment. It carries billions and
      billions of minutes of calls, and has become the lingua franca of
      interconnection between products from different vendors. If one measures
      success in deployment, then clearly SIP is a success.
</p>
<p>However, in other ways, it has failed. SIP was designed from the
      ground up to enable communications between users in different domains,
      all over the public Internet. The intention was that real-time
      communications should be no different than email or the web, with the
      same any-to-any connectivity that has fueled the successes of those
      technologies. Though SIP is used between domains, it is typically
      through private federation agreements. The any-to-any Internet
      federation model envisioned by SIP has not materialized at scale.
</p>
<p>This document introduces a new technology, called Verification
      Involving PSTN Reachability (ViPR), that enables us to break down the
      barriers that have prevented inter-domain VoIP. By stepping back and
      changing some of the most fundamental assumptions about federation, ViPR
      is able to address the key problems preventing its deployment. ViPR
      focuses on incremental deployability over the unrealizable nirvana. At
      the same time, ViPR ensures that SIP's trapezoidal model - direct
      federation between domains without any intermediate processing beyond IP
      transport - is realized. That model is required in order to allow
      innovative new services to be deployed.
</p>
<a name="anchor2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Problem Statement</h3>

<p>The first question that must be asked is this - why haven't we seen
      widespread adoption of inter-domain SIP federation?
</p>
<p>There are many reasons for it. They are - in order of importance -
      the phone number routing problem, the open pinhole problem, the quality
      of service problem, and the troubleshooting problem. The two former ones
      are the most significant.
</p>
<a name="anchor3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
The Phone Number Routing Problem</h3>

<p>Inter-domain federation requires that the sending domain determine
        the address of the receiving domain, in the form of a DNS name
        (example.com) or one or more IP addresses that can be used to reach
        the domain. In email and in the web, this is easy. The identifiers
        used by those services - the email address and web URL respectively -
        embed the address of the receiving domain. A simple DNS lookup is all
        that is required to route the connection. SIP was designed to use the
        same email-style identifiers.
</p>
<p>However, most SIP deployments utilize phone numbers, and not
        email-style SIP URI. This is due to the huge installed base of users
        that continue to exist solely on the public switched telephone network
        (PSTN). In order to be reached by users on the PSTN, and in order to
        reach them, users in SIP deployments need to be assigned a regular
        PSTN number. Users in SIP deployments need to place that PSTN number
        on business cards, use it in their email signatures, and in general,
        give it out to their friends and colleagues, in order to be reached.
        While those users could additionally have an email style SIP URI, the
        PSTN number serves as a single, global identifier that works for
        receiving calls from users on the PSTN as well as users within the
        same SIP domain. Why have two identifiers when one will suffice? The
        universality of PSTN numbers is the reason why most SIP deployments
        continue to use them - often exclusively.
</p>
<p>Another reason is that many SIP deployments utilize hardphones or
        telephony adaptors, and the user interfaces on these devices -
        patterned after existing phones - only allow phone-number based
        dialing. Consequently, these users are only allocated PSTN numbers,
        and not email-style SIP URI.
</p>
<p>Finally, a large number of SIP deployments are in domains where the
        endpoints are not IP. Rather, they are circuit based devices,
        connected to a SIP network through a gateway. SIP is used within the
        core of the network, providing lower cost transit, or providing add-on
        services. Clearly, in these deployments, only phone numbers are
        used.
</p>
<p>Consequently, to make inter-domain federation incrementally
        deployable and widely applicable, it needs to work with PSTN numbers
        rather than email-style SIP URI. Telephone numbers, unlike email
        addresses, do not provide any indication of the address of the domain
        which "owns" the phone number. Indeed, the notion of phone number
        ownership is somewhat cloudy. Numbers can be ported between carriers.
        They can be assigned to a user or enterprise, and then later
        re-assigned to someone else. Numbers are granted to users and
        enterprises through a complex delegation process involving the ITU,
        governments, and telecommunications carriers, often involving local
        regulations that vary from country to country.
</p>
<p>Therefore, in order to deploy inter-domain federation, domains are
        required to utilize some kind of mechanism to map phone numbers to the
        address of the domain to which calls should be routed. Though several
        techniques have been developed to address this issue, none have
        achieved large-scale Internet deployments.
</p>
<a name="anchor4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
The Open Pinhole Problem</h3>

<p>The inter-domain federation mechanism built into SIP borrows
        heavily from email. Each domain runs a SIP server on an open port.
        When one domain wishes to contact another, it looks up the domain name
        in the DNS, and connects to the that server on the open port. Here,
        "open" means that the server is reachable from anywhere on the public
        Internet, and is not blocked by firewalls.
</p>
<p>This simple design worked well in the early days of email. However,
        the email system has now become plagued with spam, to the point of
        becoming useless. Administrators of SIP domains fear - rightfully so -
        that if they make a SIP server available for anyone on the Internet to
        contact, it will open the floodgates for VoIP spam, which is far more
        disruptive than email-based spam <a class='info' href='#RFC5039'>[RFC5039]<span> (</span><span class='info'>Rosenberg, J. and C. Jennings, &ldquo;The Session Initiation Protocol (SIP) and Spam,&rdquo; January&nbsp;2008.</span><span>)</span></a>.
        Administrators also worry - rightfully so - that an open server will
        create a back-door for denial-of-service and other attacks that can
        potentially disrupt their voice service. Administrators are simply not
        willing to take that risk; rightly or wrongly, voice deployments
        demand higher uptimes and better levels of reliability than email,
        especially for enterprises.
</p>
<p>Fears around spam and denial-of-service attacks, when put together,
        form the "open pinhole problem" - that domains are not willing to
        enable SIP on an open port facing the Internet.
</p>
<p>To fix this, a new model for federation is needed - a model where
        these problems are addressed as part of the fundamental design, and
        not as an after-thought.
</p>
<a name="anchor5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
Quality of Service Problem</h3>

<p>The Internet does not provide any QoS guarantees. All traffic is
        best effort. This is not an issue for data transaction services, like
        web and email. It is, however, a concern when using real-time
        services, such as voice and video.
</p>
<p>That said, there are a large number of existing VoIP deployments
        that run over the Internet. Though the lack of QoS is a concern, it
        has not proven a barrier to deployment. We believe that, if the more
        fundamental issues - the phone number routing and open pinhole
        problems - can be addressed, the QoS problem will sort itself out. As
        such, we do not discuss this issue further here.
</p>
<a name="anchor6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.4"></a><h3>2.4.&nbsp;
Troubleshooting Problem</h3>

<p>The final problem that is stopping large scale inter-domain
        federation is the troubleshooting problem. When connecting calls
        between domains, problems will happen. Calls will get blocked. Calls
        will get misdelivered. Features won't work. There will be one-way
        media or no media at all. The video won't start. Call quality will be
        poor.
</p>
<p>These problems are common in VoIP deployments, and they are tough
        to troubleshoot even within a single administrative domain. When
        real-time services extend inter-domain, the problem becomes worse. A
        new angle is introduced: the first step is identifying who is at
        fault.
</p>
<p>Fortunately, work is underway to improve the ability for network
        administrators to diagnose VoIP problems. Common log formats <a class='info' href='#CLF-SYNTAX'>[CLF&#8209;SYNTAX]<span> (</span><span class='info'>Roach, A., &ldquo;Binary Syntax for SIP Common Log Format,&rdquo; May&nbsp;2009.</span><span>)</span></a> and consistent session IDs <a class='info' href='#SESSION-ID'>[SESSION&#8209;ID]<span> (</span><span class='info'>Kaplan, H., &ldquo;A Session Identifier for the Session Initiation Protocol           (SIP),&rdquo; March&nbsp;2009.</span><span>)</span></a>, for example, can help troubleshoot
        interdomain calls.
</p>
<p>In addition to these, any new technology that facilitates
        inter-domain federation needs to have troubleshooting built-in, so
        that it is not a barrier to deployment.
</p>
<a name="anchor7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Summary of Existing Solutions</h3>

<p>Given the value that inter-domain SIP federation brings, it is no
      surprise that many attempts have been made at solving it. Indeed, these
      have all been deployed to varying degrees. However, all of them have
      fundamental limitations that have inhibited widespread deployment.
</p>
<a name="anchor8"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
Domain Routing</h3>

<p>The first solution that has been proposed for SIP inter-domain
        federation is built into SIP itself - domain routing. In this
        technique, users utilize email-style SIP URI as identifiers. By
        utilizing the DNS lookup mechanism defined in <a class='info' href='#RFC3263'>[RFC3263]<span> (</span><span class='info'>Rosenberg, J. and H. Schulzrinne, &ldquo;Session Initiation Protocol (SIP): Locating SIP           Servers,&rdquo; June&nbsp;2002.</span><span>)</span></a>, SIP enables calls to be routed between
        domains in much the same way email is routed between domains.
</p>
<p>This technique works well in theory, but it has two limitations
        which have limited its deployment:
</p>
<p></p>
<ol class="text">
<li>The majority of SIP deployments utilize phone numbers, often
            exclusively. In such a case, domain routing cannot be used.
</li>
<li>Domain federation brings with it the possibility (and strong
            likelihood) of the same levels of spam and DoS attacks that have
            plagued the email system.
</li>
</ol>

<p>These issues have already been discussed above.
</p>
<a name="anchor9"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
Public ENUM</h3>

<p>Public ENUM, defined in <a class='info' href='#RFC3761'>[RFC3761]<span> (</span><span class='info'>Faltstrom, P. and M. Mealling, &ldquo;The E.164 to Uniform Resource Identifiers (URI) Dynamic           Delegation Discovery System (DDDS) Application (ENUM),&rdquo; April&nbsp;2004.</span><span>)</span></a>, tries to
        address the phone number routing problem by cleverly placing phone
        numbers into the public DNS. Clients can then perform a simple DNS
        lookup on a phone number, and retrieve a SIP URI which can be used to
        route to that phone number.
</p>
<p>Unfortunately, public ENUM requires that the entries placed into
        the DNS be populated following a chain of responsibility that mirrors
        the ownership of the numbers themselves. This means that, in order for
        a number to be placed into the DNS, authorization to do so must start
        with the ITU, and from there, move to the country, telecom regulator,
        and ultimately the end user. The number of layers of bureaucracy
        required to accomplish this is non-trivial. In addition, the telecom
        operators - which would be partly responsible for populating the
        numbers into the DNS - have little incentive to do so. As a
        consequence, public ENUM is largely empty, and is likely to remain so
        for the foreseeable future.
</p>
<p>Instead, ENUM has morphed into a technique for federation amongst
        closed peering partners, called private ENUM or infrastructure ENUM
        <a class='info' href='#RFC5067'>[RFC5067]<span> (</span><span class='info'>Lind, S. and P. Pfautz, &ldquo;Infrastructure ENUM Requirements,&rdquo; November&nbsp;2007.</span><span>)</span></a>. While there is value in this
        technology, it does not enable the open federation that public ENUM
        was designed to solve.
</p>
<p>It is clear from the legacy of ENUM deployments, that any kind of
        phone number routing solution should not rely on government or telecom
        processes for population of the databases.
</p>
<a name="anchor10"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
Private Federations</h3>

<p>Private federations are a cooperative formed amongst a small number
        of participating domains. The cooperative agrees to use a common
        technique for federation, and through it, is able to connect to each
        other. There are many such federations in use today.
</p>
<p>Some of these federations rely on a central database, typically run
        by the federation provider, that can be queried by participating
        domains. The database contains mappings from phone numbers to domains,
        and is populated by each of the participating domains, often manually.
        Each domain implements an agreed-upon query interface that can be used
        to access the database when a number is called. Sometimes ENUM is used
        for this interface (called private ENUM), other times, a SIP
        redirection is used. Some federations also utilize private IP networks
        in order to address QoS problems. "SIP trunking" - a service being
        offered by many telecom operators as a SIP-based PRI replacement - is
        a form of private federation.
</p>
<p>Private federations work, but they have one major limitation:
        scale. As the number of participating domains grows, several problems
        arise. Firstly, the size of the databases become unruly. Secondly, the
        correctness of the database becomes an issue, since the odds of
        misconfigured numbers (either intentionally or accidentally)
        increases. As the membership grows further, the odds increase that
        "bad" domains will be let in, introducing a source of spam and further
        problems. The owner of the federation can - and often does - assume
        responsibility for this, and can attempt to identify and shut down
        misbehaving participants. Indeed, as the size of the federations grow,
        the owner of the federation needs to spend increasing levels of
        capital on maintaining it. This, in turn, requires them to charge
        money for membership, and this can be a barrier to entry.
</p>
<a name="anchor11"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Key Requirements</h3>

<p>From the discussion on the problems of inter-domain federation and
      the solutions that have been attempted so far, several key requirements
      emerge:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>REQ-1:</dt>
<dd>The solution should allow for federation
          between any number of domains.
</dd>
<dt>REQ-2:</dt>
<dd>The solution must enable users in one domain to
          identify users in another domain through the use of their existing
          E.164 based phone numbers.
</dd>
<dt>REQ-3:</dt>
<dd>The solution must work with deployments that
          utilize any kind of endpoint, including non-IP phones connected
          through gateways, IP softphones and hardphones.
</dd>
<dt>REQ-4:</dt>
<dd>The solution should not require any change in
          user behavior. The devices and techniques that users have been using
          previously to make inter-domain calls should continue to work, but
          now result in inter-domain IP federation.
</dd>
<dt>REQ-5:</dt>
<dd>The solution should work worldwide, for any
          domain anywhere.
</dd>
<dt>REQ-6:</dt>
<dd>The solution should not require any new
          services from any kind of centralized provider. A domain should be
          able, of its own free-will and accord, to deploy equipment and
          connect to the federation.
</dd>
<dt>REQ-7:</dt>
<dd>The solution should not require any prior
          arrangement between domains in order to facilitate federation
          between those domains. Federation must occur opportunistically -
          connections established when they can be.
</dd>
<dt>REQ-8:</dt>
<dd>The solution must work for domains of any size
          - starting at a single phone to the largest telecom operator with
          tens of millions of numbers.
</dd>
<dt>REQ-9:</dt>
<dd>The solution must have built-in mechanisms for
          preventing spam and DoS attacks. This mechanism must be fully
          automated.
</dd>
<dt>REQ-10:</dt>
<dd>The solution must not require any processing
          whatsoever by SIP or RTP intermediaries. It must be possible for a
          direct SIP connection to be established between participating
          domains.
</dd>
</dl></blockquote>

<p>These requirements, when put together, appear to be mutually
      unsolvable. And indeed, they have been - until now.
</p>
<a name="anchor12"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Executive Overview</h3>

<p>Verification Involving PSTN Reachability (ViPR) is a new technology
      that is aimed at solving the problems that have prevented large-scale
      Internet-based SIP federation of voice and video. ViPR solves these
      problems by creating a hybrid of three technologies - the PSTN itself, a
      Peer to Peer (P2P) network, and SIP. By combining all three, ViPR
      enables an incrementally deployable solution to federation.
</p>
<a name="anchor13"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.1"></a><h3>5.1.&nbsp;
Key Properties</h3>

<p>ViPR has several important properties that enable it to solve the
        federation problem:
</p>
<p></p>
<blockquote class="text"><dl>
<dt>Works With Numbers:</dt>
<dd>ViPR enables federation for
            existing PSTN numbers. It does not require users or administrators
            to know or configure email-style identifiers. It does not require
            the allocation of new numbers. It does not require a change in
            user behaviors. Whatever way users were dialing numbers yesterday,
            works with ViPR tomorrow.
</dd>
<dt>Works with Existing Endpoints:</dt>
<dd>ViPR does not require
            any changes to endpoints. Consequently, it works with existing SIP
            endpoints, or with non-IP endpoints connected through
            gateways.
</dd>
<dt>Fully Distributed:</dt>
<dd>ViPR does not require any kind of
            central authority or provider. A domain wishing to utilize ViPR
            just deploys it on their own. ViPR utilizes the existing PSTN and
            existing Internet connectivity the domain already has, and by
            combining them, achieves inter-domain federation. Domains do not
            need to wait for their service providers to roll out any kind of
            new features, databases, or functionality.
</dd>
<dt>Verified Mappings:</dt>
<dd>The biggest issue in mapping from
            a phone number to a domain or IP address, is determining whether
            the mapping is correct. Does that domain really own the given
            phone number? While solutions like ENUM have solved this problem
            by relying on centralized delegations of authorization, ViPR
            provides a secure mapping in a fully distributed way. ViPR
            guarantees that phone calls cannot be misrouted or numbers
            stolen.
</dd>
<dt>Worldwide:</dt>
<dd>ViPR works worldwide. Any domain that is
            connected to both the PSTN and the Internet can participate. It
            doesn't matter whether the domain is in Africa, the Americas, or
            Australia. Since ViPR does not depend on availability of any
            regional services beyond IP and PSTN access - both of which are
            already available globally - ViPR itself is globally
            available.
</dd>
<dt>Unlimited Scale:</dt>
<dd>ViPR has nearly infinite scale. Any
            number of domains can participate.
</dd>
<dt>Self-Scale:</dt>
<dd>ViPR self-scales. This means that the
            amount of computation, memory, and bandwidth that a domain must
            deploy scales in direct proportion to the size of their own user
            base.
</dd>
<dt>Self-Learning:</dt>
<dd>ViPR is completely automated. A
            domain never, ever has to configure any information about another
            domain. It never has to provision IP addresses, domain names,
            certificates, phone number prefixes or routing rules. Without any
            prior coordination, ViPR enables one domain to connect to a
            different domain.
</dd>
<dt>Automated Anti-Spam</dt>
<dd>ViPR comes with a built-in
            mechanism for preventing VoIP spam. This mechanism is new, and
            specific to VoIP. In this way, it is fundamentally different from
            existing VoIP anti-spam techniques which borrow from email <a class='info' href='#RFC5039'>[RFC5039]<span> (</span><span class='info'>Rosenberg, J. and C. Jennings, &ldquo;The Session Initiation Protocol (SIP) and Spam,&rdquo; January&nbsp;2008.</span><span>)</span></a>. This new technique is fully automated,
            and requires no configuration by administrators and no
            participation from end users. Though it is not a 100% solution to
            the problem, it brings substantial economic and legal ammunition
            to the table to act as a good deterrent for a long while.
</dd>
<dt>Feature Velocity:</dt>
<dd>ViPR enables direct SIP
            connections between two domains seeking to federate. There are no
            SIP intermediaries of any sort between the two. This means that
            domains have no dependencies on intermediaries for deployment of
            new features.
</dd>
<dt>Designed for the Modern Internet:</dt>
<dd>ViPR is built to
            run on the modern Internet. It assumes the worst from everyone. It
            assumes limited connectivity. It assumes network failures. It
            assumes there are attackers seeking to eavesdrop calls. Security
            is built-in and cannot be disabled.
</dd>
<dt>Reliable:</dt>
<dd>ViPR is reliable. Through its
            hybridization of the PSTN and the Internet, it makes sure that
            calls always go through. Indeed, to route a call between domains A
            and B, ViPR never depends on a server or service anywhere outside
            of domains A and B (besides vanilla PSTN and IP access) being
            operational.
</dd>
</dl></blockquote>

<p>At first glance, these properties seem impossible to realize. And
        indeed, given the assumptions that have traditionally been made about
        how federation has to work, these properties are impossible to
        realize. It is only by stepping back, and rethinking these fundamental
        assumptions, that a solution can be found.
</p>
<a name="anchor14"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.2"></a><h3>5.2.&nbsp;
Challenging Past Assumptions</h3>

<p>Two unstated assumptions of SIP federation are challenged by
        ViPR.
</p>
<p>The first assumption that federation solutions have made is this:
        </p>
<blockquote class="text">
<p>The purpose of SIP federation is to eliminate the PSTN, and
            consequently, we cannot assume the PSTN itself as part of the
            solution.
</p>
</blockquote><p> Though unstated, this assumption has clearly been part of
        the design of existing solutions. SIP federation based on email-style
        URIs, as defined in RFC 3261, doesn't utilize or make mention of the
        PSTN. Solutions like ENUM, or private registries, do not utilize or
        make mention of the PSTN. In one sense, it's obvious that they
        shouldn't - after all, the purpose is to replace the PSTN. However,
        such an approach ignores an incremental solution - a solution which
        utilizes the PSTN itself to solve the hard problems in SIP
        federation.
</p>
<p>After all, the PSTN has accomplished a great deal. It reaches
        worldwide. It provides a global numbering translation service that
        maps phone numbers to circuits. It is highly reliable, and provides
        QoS. It has been built up over decades to achieve these goals. This
        begs the question - can we build upon the capabilities already
        provided by the PSTN, and use them to solve the problems that plague
        SIP federation?
</p>
<p>Indeed, the answer is yes once another assumption is challenged.
        This second assumption is: </p>
<blockquote class="text">
<p>A federation solution must be the same as the final target
            federation architecture, and not just a step towards it.
</p>
</blockquote><p> Though unstated, this assumption has also been true. SIP's
        email-style federation was a pure 'target architecture' - the place we
        want to get to. ENUM was the same - a worldwide global DNS database
        with everyone's phone numbers - an unrealizable nirvana of open
        connectivity.
</p>
<p>Historically, technologies are more successful when they are
        incrementally deployable. Indeed, in many cases, the target
        architecture is unrealizable because there is no obvious way to get
        there. As such, the focus needs to be on the next incremental step
        that we can take, and that step in turn creates the technological and
        market pressures that will drive the next step. In the end, the target
        may not be the perfect nirvana we all imagined, but we've at least
        arrived.
</p>
<p>As such, ViPR is very much focused on incremental deployability. It
        is not the end of the federation story, it is the beginning. It
        discards the nirvana of perfect IP federation for a solution that
        federates most, but not all calls, by relying on the PSTN to fill in
        the gaps. ViPR's philosophy is not to let the perfect be the enemy of
        the good.
</p>
<a name="anchor15"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3"></a><h3>5.3.&nbsp;
Technical Overview</h3>

<p>A high level view of the architecture is shown in <a class='info' href='#fig-high-arch'>Figure&nbsp;1<span> (</span><span class='info'>High Level Architecture </span><span>)</span></a>. The figure shows four different
        domains, a.com, b.com, c.com and d.com, federating using ViPR
        technology. Each domain is connected to both the public Internet and
        to the traditional PSTN.
</p><br /><hr class="insert" />
<a name="fig-high-arch"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                               //\\
                                \/
                                 |
                                 |
                                 |
                            +-------+
                            |  Call |
                            | Agent |
                            |       |
                            |       | d.com
                            +-------+
                                |

                           //-------\\
                        |//           \\|
                       |    Internet     |
          +-------+     |\\           //|    +-------+
          |  Call |        \\-------//       |  Call |
  //\\    | Agent |--                      --| Agent |    //\\
   \/  ---|       |        //-------\\       |       |---- \/
          |       |     |//           \\|    |       |
          +-------+    |      PSTN       |   +-------+
                        |\\           //|
            a.com          \\-------//         b.com

                                |
                            +-------+
                            |  Call |
                            | Agent |
                            |       |
                            |       |
                            +-------+
                                |     c.com
                                |
                               //\\
                                \/
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1: High Level Architecture &nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>For purposes of explanation, it is easiest to think of each domain
        as having a single call agent which participates in the federation
        solution. In actuality, the functionality is decomposed into several
        sub-components, and this is discussed in more detail below. The call
        agent is connected to one or more phones in the domain, and is
        responsible for routing calls, handling features, and processing call
        state. The call agent is stateful, and is aware of when calls start
        and stop.
</p>
<p>Assume that all four domains have a 'fresh' installation of ViPR,
        and that domain b.com 'owns' +1 408 555 5..., a block of 1000 numbers
        allocated by its PSTN provider.
</p>
<p>The ViPR mechanism can be broken into four basic steps: storage of
        phone numbers, PSTN first call, validation and caching, and SIP
        call.
</p>
<a name="anchor16"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.1"></a><h3>5.3.1.&nbsp;
Storage of Phone Numbers</h3>

<p>The first step is that the call agents form a single, worldwide
          P2P network, using RELOAD <a class='info' href='#P2PSIP-BASE'>[P2PSIP&#8209;BASE]<span> (</span><span class='info'>Jennings, C., Lowekamp, B., Rescorla, E., Baset, S., and H. Schulzrinne, &ldquo;REsource LOcation And Discovery (RELOAD) Base           Protocol,&rdquo; October&nbsp;2010.</span><span>)</span></a> with
          the Chord algorithm. This P2P network forms a distributed hash table
          (DHT) running amongst all participating domains. A distributed hash
          table is like a simple database, allowing storage of key-value
          pairs, and lookup of objects by key. Unlike a normal hash table,
          which resides in the memory of a single computer, a distributed hash
          table is spread across all of the servers which make up the P2P
          network. In this case, it is spread across all of the domains
          participating in the ViPR federation.
</p>
<p>The neat trick solved by Chord (and by other DHT algorithms), is
          an answer to the following: given that the desired operation is to
          read or write an object with key K, which node in the DHT is the box
          that currently stores the object with that key? Chord provides a
          clever algorithm which routes read and write operations through
          nodes in the DHT until they eventually arrive at the right place.
          With Chord, this will take no more than log2N hops, where N is the
          number of nodes in the DHT. Consequently, for a DHT with 1024 nodes,
          10 hops are required in the worst case. For 2048, 11 hops. And so
          on. The logarithmic factor allows DHTs to achieve incredible scale
          and to provide enormous storage summed across all of the nodes that
          make up the DHT.
</p>
<p>This logarithmic hopping behavior also means that each node in
          the DHT does not need to establish a TCP/TLS connection to every
          other node. Rather, connections are established to a smaller subset
          - just log(N) of the nodes.
</p>
<p>In DHTs, each participating entity is identified by a Node-ID.
          The Node-ID is a 128 bit number, assigned randomly to each entity.
          They have no inherent semantic meaning; they are not like domain
          names or IP addresses.
</p>
<p>In the case of ViPR, each call agent is identified by one or more
          Node-IDs. For purposes of discussion, consider the case where the
          call agent has just one. Each participating domain, including b.com
          in our example, uses the DHT to store a mapping from each phone
          number that it owns, to its own Node-ID. In the case of b.com, it
          would store 1000 entries into the DHT, each one being a mapping from
          one of its phone numbers, to its own Node-ID. Furthermore, when the
          mappings are stored, the mapping is actually from the SHA-1 hash of
          the phone number, to the Node-ID of the call agent which claims
          ownership of that number.
</p>
<p>Pretending that the Node-ID of the call agent in domain b.com is
          0x1234 (a shorter 16 bit value to simplify discussion), the entries
          stored into the DHT by b.com would be:
</p><br /><hr class="insert" />
<a name="fig-high-arch2"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

   Key             |    Value
----------------------------------
SHA1(+14085555000)  |   0x1234
SHA1(+14085555001)  |   0x1234
SHA1(+14085555002)  |   0x1234
.....
SHA1(+14085555999)  |   0x1234
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2: DHT Contents&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>It is important to note that the DHT does not contain phone
          numbers (it contains hashes of them), nor does it contain IP
          addresses or domain names. Instead, it is a mapping from the hash of
          a phone number (in E.164 format) to a Node-ID.
</p>
<p>b.com will store this mapping when it starts up, or when a new
          number is provisioned. The information is refreshed periodically by
          b.com. The actual server on which these mappings are stored depends
          on the Chord algorithm. Typically, the entries will be uniformly
          distributed amongst all of the call agents participating in the
          network.
</p>
<a name="anchor17"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.2"></a><h3>5.3.2.&nbsp;
PSTN First Call</h3>

<p>At some point, a user (Alice) in a.com makes a call to +1 408 555
          5432, which is her colleague Bob. Even though both sides have ViPR,
          the call takes place over the plain old PSTN. Alice talks to Bob for
          a bit, and they hang up.
</p>
<p>At a random point of time after the call has completed, the call
          agent in a.com "wakes up" and says to itself, "that's interesting,
          someone in my domain called +1 408 555 5432, and it went over the
          PSTN. I wonder if that number is reachable over IP instead?". To
          make this determination, it hashes the called phone number, and
          looks it up in the DHT. It is important to note that this lookup is
          not at the time of an actual phone call - this lookup process
          happens outside of any phone call, and is a background process.
</p>
<p>The query for +1 408 555 5432 will traverse the DHT, and
          eventually arrive at the node that is responsible for storing the
          mapping for that number. Typically, that node will not be b.com, but
          rather one of the other nodes in the network (for example. c.com).
          In many cases, the called number will not find a matching mapping in
          the DHT. This happens when the number that was dialed is not owned
          by a domain participating in ViPR. When that happens, a.com takes no
          further action. Next time there is another call to the same number,
          it will repeat the process and check once more whether the dialed
          number is in the DHT.
</p>
<p>In this case, there is a match in the DHT, and a.com learns the
          Node-ID of b.com. It then proceeds to the validation step. It is
          also possible that there are multiple matches in the DHT. This can
          happen if another domain - d.com for example - also claims ownership
          of that number. When there are multiple matching results, a.com
          learns all of them, and performs the validation step with each.
</p>
<a name="anchor18"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.3"></a><h3>5.3.3.&nbsp;
Validation and Caching</h3>

<p>Why not just store the domain in the DHT, instead of the Node-ID?
          In that case, once a.com performed the lookup, it would immediately
          learn that the number maps to b.com, and could then make a direct
          SIP call next time.
</p>
<p>The main reason this doesn't work is security. The information in
          the DHT is completely untrusted. There is nothing so far that
          enables a.com to know that b.com does, in fact, own the phone number
          in question. Indeed, if multiple domains make a claim on the number,
          it has no way to know which one (if any) actually owns it.
</p>
<p>To address this critical problem, ViPR utilizes a technique
          called phone number validation. Phone number validation is the key
          concept in ViPR. The essential idea is that a.com will connect to
          the b.com server, by asking the DHT to form a connection to b.com's
          Node-ID. Once connected, a.com demands proof of ownership of the
          phone number. This proof comes in the form of demonstrated knowledge
          of the previous PSTN call. When a call was placed from a.com to +1
          408 555 5432, the details of that call - including its caller ID,
          start time, and stop time, create a form of shared secret -
          information that is only known to entities that participated in the
          call. Thus, to obtain proof that b.com really owns the number in
          question, a.com will demand a knowledge proof - that b.com is aware
          of the details of the call. The only way that b.com could know these
          details is if it had received the call, and the only way it could
          have received the call is if it owned the phone number.
</p>
<p>There are a great many details required for this validation
          protocol to be secured. It needs to handle the fact that call start
          and stop times won't exactly match on both sides. It needs to deal
          with the fact that many calls start on the top of the hour. It needs
          to deal with the fact that caller ID is not often delivered, and
          when it is delivered, is not reliable. It needs to deal with the
          fact that a.com may in fact be the attacker, trying to use the
          validation protocol to extract the shared secret from b.com. All of
          this is, in fact, handled by the protocol. The protocol is based on
          the Secure Remote Password for TLS Authentication (SRP-TLS) <a class='info' href='#RFC5054'>[RFC5054]<span> (</span><span class='info'>Taylor, D., Wu, T., Mavrogiannopoulos, N., and T. Perrin, &ldquo;Using the Secure Remote Password (SRP) Protocol for TLS           Authentication,&rdquo; November&nbsp;2007.</span><span>)</span></a>, and is described more fully in <a class='info' href='#VIPR-PVP'>[VIPR&#8209;PVP]<span> (</span><span class='info'>Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;The Public Switched Telephone Network (PSTN) Validation           Protocol (PVP),&rdquo; October&nbsp;2010.</span><span>)</span></a>.
</p>
<p>At the end of the validation process, both a.com and b.com have
          been able to ascertain that the other side did in fact participate
          in the previous PSTN call. At that point, a.com sends its domain
          name to b.com (this is described in more detail below), and b.com
          sends to a.com - all over a secured channel - a SIP URL to use for
          routing calls to this number, and a ticket. The ticket is a
          cryptographic object, opaque to a.com, but used by b.com to allow
          incoming SIP calls. It is similar in concept to kerberos tickets -
          it is a grant of access. In this case, it is a grant of access for
          a.com to call +1 408 555 5432, and only +1 408 555 5432.
</p>
<p>The a.com call agent receives the SIP URI and ticket, and stores
          both of them in an internal cache. This cache builds up slowly over
          time, containing the phone number, SIP URI, and ticket, for those
          numbers which are called by a.com and validated using ViPR. Because
          the cache entries are only built for numbers which have actually
          been called by users in the enterprise, the size of the cache
          self-scales. A call agent supporting only ten users will build up a
          cache proportional to the volume of numbers called by ten people,
          whereas a call agent supporting ten thousand users will build up a
          cache which is typically a thousand times larger.
</p>
<a name="anchor19"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5.3.4"></a><h3>5.3.4.&nbsp;
SIP Call</h3>

<p>At some point in the future, another call is made to +1 408 555
          5432. The caller could be Alice, or it could be any other user
          attached to the same call agent. This time, the call agent notes
          that it has a cached route for the number in question, along with a
          SIP URI that can be used to reach that route. It also has a
          ticket.
</p>
<p>The a.com call agent attempts to contact the SIP URI by
          establishing a TCP/TLS connection to the SIP URI it learned. If this
          connection cannot be made, it proceeds with the call over the PSTN.
          This ensures that, in the event of an Internet failure or server
          failure, the call can still proceed. Assuming the connection is
          established, the a.com call agent sends a traditional SIP INVITE to
          the terminating call agent, over this newly formed secure
          connection. The SIP call setup request also contains the ticket,
          placed into a new SIP header in the message.
</p>
<p>When this call setup request arrives at the b.com call agent, it
          extracts the ticket from the new SIP header. This ticket is an
          object, opaque to a.com, that was previously generated by the b.com
          call agent. <a class='info' href='#fig-ticket-step1'>Figure&nbsp;3<span> (</span><span class='info'>Ticket Validation Step 1</span><span>)</span></a> illustrates how
          this ticket is generated and used.
</p><br /><hr class="insert" />
<a name="fig-ticket-step1"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

                              //\\
                               \/
+----------------------+         |
|                      |         |
| Hi, I am a.com.      |         |
| How do I reach you?  |    +-------+
|                      |    |  Call |
+--------------\-------+    | Agent |
                \           |       |
                 \          |       | d.com
                 \          +-------+
                  \             |
                   \
                    \      //-------\\
             +===================================+
             ^         |    Internet     |       V
          +-------+     |\\           //|    +-------+
          |  Call |        \\-------//       |  Call |
  //\\    | Agent |--                      --| Agent |    //\\
   \/  ---|       |        //-------\\       |       |---- \/
          |       |     |//           \\|    |       |
          +-------+    |      PSTN       |   +-------+
                        |\\           //|
            a.com          \\-------//         b.com

                                |
                            +-------+
                            |  Call |
                            | Agent |
                            |       |
                            |       |
                            +-------+
                                |     c.com
                                |
                               //\\
                                \/
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3: Ticket Validation Step 1&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Towards the end of the validation process, domains a.com and
          b.com had determined that each was, in fact in possession of the
          shared secret information about the prior PSTN call. However,
          neither side has any information about the domain names of the other
          side. The originating domain - a.com - tells b.com that its domain
          name is a.com. It offers no proof of this assertion at this
          time.
</p>
<p>Next, the b.com domain generates the ticket. The ticket has three
          fundamental parts to it:
</p>
<p></p>
<ol class="text">
<li>The phone number that was just validated - in this case, +1
              408 555 5432.
</li>
<li>The domain name that the originating side claims it has -
              a.com in this case.
</li>
<li>A signature generated by b.com, using a key known to itself
              only, over the other two pieces of information.
</li>
</ol>

<p>This ticket is then sent back to a.com at the end of the
          validation process, as shown in <a class='info' href='#fig-ticket-step2'>Figure&nbsp;4<span> (</span><span class='info'>Ticket Validation Step 2</span><span>)</span></a>.
</p><br /><hr class="insert" />
<a name="fig-ticket-step2"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                              //\\
                               \/
                                |
                                |
                                |             +--------------------+
                           +-------+          | Here is your ticket|
                           |  Call |          |and a SIP URI to    |
                           | Agent |          | reach this number. |
                           |       |          |                    |
                           |       | d.com    +--------------------+
                           +-------+            /
                               |               /
                                              /
                          //-------\\        /
            +===================================+
            V         |    Internet     |       ^
         +-------+     |\\           //|    +-------+
         |  Call |        \\-------//       |  Call |
 //\\    | Agent |--                      --| Agent |    //\\
  \/  ---|       |        //-------\\       |       |---- \/
         |       |     |//           \\|    |       |
         +-------+    |      PSTN       |   +-------+
                       |\\           //|
           a.com          \\-------//         b.com

                               |
                           +-------+
                           |  Call |
                           | Agent |
                           |       |
                           |       |
                           +-------+
                               |     c.com
                               |
                              //\\
                               \/

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4: Ticket Validation Step 2&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>When a.com generates a SIP INVITE, it will contain this ticket.
          The INVITE arrives at the b.com call agent over the mutually
          authenticated TLS connection established between the domains.
</p>
<p>The b.com call agent looks for the SIP header field in the INVITE
          that contains the ticket. First, it verifies the signature over the
          ticket. Remember that the b.com agent is the one that generated the
          ticket in the first place; as such, it is in possession of the key
          required to validate the signature. Once validated, it performs two
          checks:
</p>
<p></p>
<ol class="text">
<li>It compares the phone number in the call setup request (the
              Request URI) against the phone number stored in the ticket.
</li>
<li>It compares the domain name of the calling domain, learned
              from the certificates in the mutual TLS exchange, against the
              domain name stored in the ticket.
</li>
</ol>

<p>If both match, the b.com call agent knows that the calling party
          is in fact the domain they claimed previously, and that they had in
          fact gone through the validation process successfully for the number
          in question. A consequence of this is that the following property is
          maintained:
</p>
<p></p>
<blockquote class="text">
<p>A domain can only call a specific number over SIP, if it had
              previously called that exact same number over the PSTN.
</p>
</blockquote>

<p>This property is key in fighting spam and denial-of-service
          attacks. Because calling numbers on the PSTN costs money -
          especially international calls - ViPR creates a financial
          disincentive for spammers. For a spammer to ring every phone in a
          domain with a SIP call, it must have previously called every number
          in the domain with a PSTN call, and had a successfully completed
          call to each and every one of them. Of course, once that PSTN call
          had been placed, the spammer would have already achieved their
          goals, and at cost. The additional VoIP call is not so exciting.
</p>
<p>This property also means that, in order for an attacker to spam
          call numbers on VoIP, it must have already spam-called those same
          numbers on the PSTN. This means that the attacker would clearly be
          subject to regulations and laws governing usage of the PSTN for
          calling. As an example, a spammer in the United States would have
          already violated U.S. do-not-call rules by initiating the spam calls
          to the PSTN numbers.
</p>
<p>It is important to note that ViPR does not completely address the
          spam problem. A large spamming clearing house organization could
          actually incur the costs of launching the PSTN calls to numbers, and
          then, in turn, act as a conduit allowing other spammers to launch
          their calls to those numbers for a fee. The clearinghouse would
          actually need to transit the signaling traffic (or, divulge the
          private keys to their domain name), which would incur some cost. As
          such, while this is not an impossible situation, the barrier is set
          reasonably high to start with - high enough that it is likely to
          deter spammers until it becomes a highly attractive target, at which
          point other mechanisms can be brought to bear. This is, again, an
          example of the incremental deployability philosophy that ViPR takes
          - let not the perfect be the enemy of the good.
</p>
<a name="anchor20"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6"></a><h3>6.&nbsp;
Architecture Components and Functions</h3>

<p>The architecture in <a class='info' href='#fig-high-arch'>Figure&nbsp;1<span> (</span><span class='info'>High Level Architecture </span><span>)</span></a> is overly
      simplistic. ViPR allows the functionality embedded within the call agent
      can be split up into three components, as shown in <a class='info' href='#fig-arch'>Figure&nbsp;5<span> (</span><span class='info'>Architecture </span><span>)</span></a>:
</p><br /><hr class="insert" />
<a name="fig-arch"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
                     +-+            +-+
                     | |            | |   +------+
                     | |      +-----| |---|Enroll|
                     | |      |     | |   +------+
                     |I|      |     |I|
                     |n|   +-----+  |n|
              VAP    |t|   | ViPR|  |t|
          +----------|r|---|Srvr |--|e|-----------------
          |          |a|   |     |  |r|   P2P-Validation
          |          |n|   +-----+  |n|
          |          |e|            |e|
          |          |t|            |t|
       +-----+  SIP  | |   +-----+  | |
       | CA  |-------|F|---|     |--|F| ---------------
       +-----+       |i|   |     |  |i|  SIP/TLS
          .          |r|   |  .  |  |r|
   SIP/   .          |e|   |     |  |e|
   MGCP/  .          |w|   | BE  |  |w|
   TDM    .          |a|   |     |  |a|
          .          |l|   |     |  |l|
       +-----+       |l|   |     |  |l|
       | UA  |-------| |---|     |--| |-----------------
       +-----+       | |   +-----+  | |   SRTP
                     | |            | |
                     +-+            +-+
  |                                      |
  +--------------------+-----------------+
                       |
          Single administrative domain
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5: Architecture &nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>Within each domain, there are three components that are ViPR-aware.
      These are the ViPR server, the call agent (CA), and the border element
      (BE). Outside of the domain, there is a P2P network and an enrollment
      server. A domain will typically have firewalls - an Internet firewall
      and an intranet firewall.
</p>
<p>The sections which follow describe the roles and responsibilities of
      each component in more detail.
</p>
<a name="anchor21"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.1"></a><h3>6.1.&nbsp;
ViPR Server</h3>

<p>The ViPR server is the heart of the system. It performs several key
        functions:
</p>
<p></p>
<ol class="text">
<li>It implements the P2P protocol, acting as one or more nodes in
            the DHT. By placing this function separate from the call agent, it
            allows the call agent to be isolated from the traffic and security
            concerns that are often associated with a P2P network.
</li>
<li>It implements the validation mechanism. It is informed of call
            events by the call agent, and sometime after the call, looks up
            the number in the DHT, and if found, attempts to connect to the
            node claiming ownership of the number, and then validates it.
</li>
<li>It pushes newly learned routes to the call agent once
            validation has occurred. The ViPR server does not hold the call
            routes; this eliminates the need for an off-box query to perform
            call routing logic.
</li>
<li>It stores numbers into the DHT. The call agent informs the ViPR
            servers of numbers to be published, and the ViPR server places
            them into the P2P network. Refreshing the stored numbers (by
            asking the ViPR server to restore them) is the responsibility of
            the call agent.
</li>
<li>It implements a distributed quota enforcement algorithm,
            ensuring that malicious ViPR servers cannot store excessive data
            into the network.
</li>
<li>It implements a policing function, pacing its store and fetch
            requests into the DHT to ensure that the network is not
            overwhelmed.
</li>
</ol>

<p>In order to join the P2P network and be able to receive incoming
        validation requests, the ViPR server must have open access to the
        public Internet. For this reason, it is typically placed into the DMZ.
        The Internet firewall will require two pinholes to be opened towards
        the ViPR server: one for the P2P protocol, and one for the validation
        protocol.
</p>
<p>It is important to understand that the ViPR server does not perform
        any call processing. It does not process SIP or RTP traffic. It is a
        non-real-time server that performs validation processing in the
        background, outside of actual call attempts.
</p>
<p>The ViPR server needs to connect with the call agent. This is done
        through the ViPR Access Protocol (VAP). VAP is described in more
        detail below.
</p>
<a name="anchor22"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.2"></a><h3>6.2.&nbsp;
Call Agent</h3>

<p>The call agent is a box within the domain which performs call
        processing on behalf of one or more phones within the domain. ViPR can
        work with a wide variety of call agents, as long as they meet some
        specific criteria:
</p>
<p></p>
<ul class="text">
<li>The call agent must be know of the start time, stop time,
            caller ID, and called numbers of calls placed from phones towards
            the PSTN.
</li>
<li>The call agent must be capable of making routing decisions for
            outbound calls from phones that would otherwise go to the PSTN,
            directing them towards the PSTN or towards other domains (based on
            ViPR routing rules).
</li>
</ul>

<p>Based on this definition, many different types of products
        typically found within a domain could act as the call agent. An IP PBX
        or TDM PBX with a SIP interface can be the call agent. A Session
        Border Controller (SBC) that connects calls from a PBX to the PSTN,
        can act as the call agent. An IMS application server can act as the
        call agent. A PSTN gateway, used for all calls egressing a domain from
        a set of phones, can act as a call agent.
</p>
<p>A SIP proxy can act as a call agent; as long as it is capable of
        stashing the relevant call information into Record-Route headers for
        usage at the end of the call, it can even operate without retaining
        call state.
</p>
<p>A single phone can also act as the call agent, representing itself
        and its own phone number.
</p>
<p>In ViPR, the call agent performs several key functions specific to
        ViPR:
</p>
<p></p>
<ul class="text">
<li>It informs the ViPR server of the phone numbers to be stored in
            the DHT for its domain.
</li>
<li>It refreshes those numbers in the DHT, redoing the storage
            operation periodically.
</li>
<li>At the end of a call, the call agent sends a ViPR Call Record
            (VCR) to the ViPR server, containing the start time, stop time,
            caller ID and called party number.
</li>
<li>It learns validated routes from the ViPR server. These routes
            consist of a phone number, a SIP URI to utilize when contacting
            that phone number, and a corresponding ticket. The call agent is
            responsible for storing those routes.
</li>
<li>When a call is to be made towards a PSTN number, the call agent
            is responsible for checking whether there is a route for that
            number, learned via a prior notification from the ViPR server. If
            so, it is responsible for sending the INVITE towards the learned
            SIP URI, and for including the ticket the X-Cisco-ViPR-Ticket
            header field.
</li>
</ul>

<p>Those functions which require communications with the ViPR server
        are done by implementing VAP. VAP is a client-server protocol, with
        the call agent acting as the client, and the ViPR server acting as the
        server. For this reason, the call agent is sometimes called the VAP
        client or ViPR client.
</p>
<a name="anchor23"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.3"></a><h3>6.3.&nbsp;
Border Element</h3>

<p>The border element is responsible for the SIP layer perimeter
        security functions. In particular:
</p>
<p></p>
<ul class="text">
<li>The border element ensures that all egress SIP traffic is
            carried over TLS. Border elements must reject any incoming SIP
            requests which are not over TLS. SIP over TLS is mandatory-to-use
            in ViPR, and it must be performed using mutual TLS.
</li>
<li>The border element ensures that all egress RTP traffic is
            actually carried using SRTP. If the traffic originated by the UA
            in the domain is inherently SRTP, the criteria is met. However,
            many domains do not utilize SRTP internally, and if it is not used
            internally, the border element must convert to SRTP. Similarly,
            the border element is responsible for rejecting any incoming SIP
            calls that are not set up with SRTP. SRTP is mandatory in
            ViPR.
</li>
<li>The border element ensures that ingress and egress SIP traffic
            is 'fixed up' so that it can pass through the Internet firewall
            successfully. Typically, this is done using a traditional SBC/ALG
            function.
</li>
<li>The border element inspects all incoming SIP INVITEs, and
            performs ticket verification. In this process, it looks for the
            X-Cisco-ViPR-Ticket header field in the INVITE. If not present, it
            discards the request. If present, it verifies the signature, and
            then compares the called number and remote TLS domain against the
            contents of the ticket. If they do not match, the border element
            discards the INVITE.
</li>
</ul>

<p>The border element can perform other, non-ViPR tasks, as is common
        for border elements. These include header inspection and validation,
        anti-virus checks on embedded content, SIP state machine conformance,
        policy checks on various services, and so on.
</p>
<p>The role of the border element can be fulfilled by any number of
        products typically found within domains. These include Session Border
        Controllers and firewalls. Indeed, the border element function can be
        embedded directly in the Internet firewall.
</p>
<p>The border element is connected to the call agent via SIP, and to
        the user agent (UA) via RTP. The border element has no direct
        connection to the ViPR server. However, in order for ticket processing
        to work in this model, the ViPR server and border element must share a
        secret that is used to create the tickets. This is discussed in more
        detail below.
</p>
<a name="anchor24"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.4"></a><h3>6.4.&nbsp;
Enrollment Server</h3>

<p>P2P protocols - including RELOAD - require the usage of an
        enrollment server in order to obtain the certificates that are used to
        secure the network. ViPR uses, and indeed requires, that all RELOAD
        traffic be over TCP/TLS with mutual authentication. The certificates
        used are obtained through an enrollment process. The details on how
        P2P enrollment are done are beyond the scope of this document.
</p>
<a name="anchor25"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.6.5"></a><h3>6.5.&nbsp;
P2P Network</h3>

<p>The collection of ViPR servers form a single, worldwide, P2P
        network utilizing RELOAD and the Chord algorithm.
</p>
<p>It is very important to understand that the DHT is never accessed
        in real-time. It is not queried at call setup time. This is because
        the DHT is slow, involving many hops. Queries could take seconds.
        Furthermore, we don't want to rely on proper operation of the DHT to
        actually make calls.
</p>
<a name="anchor26"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7"></a><h3>7.&nbsp;
Protocols</h3>

<p>The overall ViPR solution utilizes several protocols, each performing
      a different function.
</p>
<a name="anchor27"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1"></a><h3>7.1.&nbsp;
P2P: RELOAD</h3>

<p>ViPR utilizes the RELOAD protocol <a class='info' href='#P2PSIP-BASE'>[P2PSIP&#8209;BASE]<span> (</span><span class='info'>Jennings, C., Lowekamp, B., Rescorla, E., Baset, S., and H. Schulzrinne, &ldquo;REsource LOcation And Discovery (RELOAD) Base           Protocol,&rdquo; October&nbsp;2010.</span><span>)</span></a> to run amongst each of the ViPR servers.
        Each ViPR server acts as one or more nodes in the DHT. The number of
        nodes that the ViPR server implements directly determines the quota
        allocated to that ViPR server, and in turn, the amount of work it must
        perform storing data.
</p>
<p>ViPR, however, does not implement the SIP usage that has been
        defined for RELOAD <a class='info' href='#P2PSIP-SIP'>[P2PSIP&#8209;SIP]<span> (</span><span class='info'>Jennings, C., Lowekamp, B., Rescorla, E., Baset, S., and H. Schulzrinne, &ldquo;A SIP Usage for RELOAD,&rdquo; July&nbsp;2010.</span><span>)</span></a>. That is because
        the DHT is not used as a traditional distributed registrar. Instead,
        it implements a new usage - the ViPR usage - which stores phone
        numbers. It also utilizes the DHT for storage of certificates, using a
        certificate usage.
</p>
<a name="anchor28"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.1"></a><h3>7.1.1.&nbsp;
ViPR Usage</h3>

<p>The ViPR usage is described in detail in <a class='info' href='#VIPR-RELOAD-USAGE'>[VIPR&#8209;RELOAD&#8209;USAGE]<span> (</span><span class='info'>Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;A Usage of Resource Location and Discovery (RELOAD) for           Public Switched Telephone Network (PSTN) Verification,&rdquo; October&nbsp;2010.</span><span>)</span></a>. This section provides a brief
          overview.
</p>
<p>The ViPR usage makes use of the dictionary type. Each resource-ID
          is a key, computed by taking the SHA1 hash of an E.164 formatted
          phone number. The value stored at this resource-ID is a dictionary.
          The dictionary entries are the set of virtual ViPR servers which
          claim ownership of those numbers.
</p>
<p>Since a ViPR server might support a multiplicity of call agents
          from different domains, it is necessary to logically segment a ViPR
          server so that - from a security perspective - it operates logically
          like different virtual ViPR servers, one for each call agent. Each
          virtual instance of a ViPR server is called a VService. Thus, the
          entries in the dictionary are key value pairs whose key is the
          concatenation of the Node-ID and an identifier for the VService
          within that node. The value at each key is the Node-ID to contact
          for validation.
</p>
<p>When a node in the DHT receives a Store request, and it is the
          responsible node for the resource-ID, it will verify that the
          Node-ID in both the key and value of the dictionary entry match the
          Node-ID in the certificate it presents. This ensures that one ViPR
          server can never overwrite data from another ViPR server.
</p>
<p>The ViPR usage also specifies a quota mechanism. Unlike the SIP
          usage, where there are very specific rules about what resource-IDs a
          node may store into the DHT, with ViPR, there is no way to restrict
          what resource-IDs may be stored by a ViPR server. This is because,
          in ViPR, the resource-IDs are derived from phone numbers, and at the
          time of storage, there is no way to know whether the node performing
          the store actually owns this phone number. Consequently, a
          responsible node will accept stores from any node for any
          resource-ID. However, to limit malicious users from consuming all of
          the resources of the DHT, the ViPR usage imposes a quota on storage.
          Each node performing a store is allocated a fixed quota on the
          number of records it can place into the DHT. A probabilistic
          enforcement model is utilized at each responsible node based on the
          fraction of the hashspace owned by that responsible node. Roughly
          speaking, if the system quota is 10,000 phone numbers per Node-ID,
          if a responsible node owns 10% of the DHT, it will accept an average
          of 1000 phone numbers from any one single Node-ID.
</p>
<a name="anchor29"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.1.2"></a><h3>7.1.2.&nbsp;
Certificate Usage</h3>

<p>Further details pending.
</p>
<a name="anchor30"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.2"></a><h3>7.2.&nbsp;
ViPR Access Protocol (VAP)</h3>

<p>The ViPR Access Protocol (VAP) is documented in <a class='info' href='#VIPR-VAP'>[VIPR&#8209;VAP]<span> (</span><span class='info'>Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;Verification Involving PSTN Reachability: The ViPR Access           Protocol (VAP),&rdquo; October&nbsp;2010.</span><span>)</span></a>.
</p>
<p>VAP is a client-server protocol that runs between the call agent
        and the ViPR server. VAP is a simple, binary based, request/response
        protocol. It utilizes the same syntactic structure and transaction
        state machinery as STUN <a class='info' href='#RFC5389'>[RFC5389]<span> (</span><span class='info'>Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;Session Traversal Utilities for NAT (STUN),&rdquo; October&nbsp;2008.</span><span>)</span></a>, but otherwise
        is totally distinct from it. VAP clients initiate TCP/TLS connections
        towards the ViPR server. The ViPR server never opens connections
        towards the call agent. This allows the ViPR servers to run on the
        public side of NATs and firewalls.
</p>
<p>Once the connections are established, the call agent sends a
        Register message to the ViPR server. This register message primarily
        provides authentication and connects the client to the ViPR server.
        VAP provides several messages for different purposes: </p>
<ul class="text">
<li>Publish: The Publish message informs the ViPR server of service
            information. There are two types of Publishes supported in ViPR.
            The first is the ViPR Service (VService). This informs the ViPR
            server of the SIP URIs on the call agent and black and white lists
            used by the ViPR server to block validations. The ViPR server
            stores that information locally and uses it during the validation
            process, as described above. The second Publish is the ViPR number
            service. The ViPR server, upon receiving this message, performs a
            Store operation into the DHT.
</li>
<li>UploadVCR: This message comes in two flavors - an originating
            and terminating message. An originating UploadVCR comes from a
            call agent upon completion of a non-ViPR call to the PSTN. A
            terminating UploadVCR comes from an agent upon completion of a
            call received FROM the PSTN. The ViPR server behavior for both
            messages is very different. For Originating UploadVCR, the ViPR
            server will store these, and at a random time later, query the DHT
            for the called number and attempt validation against the ViPR
            servers that are found. For a terminating UploadVCR, the ViPR
            server will store these, awaiting receipt of a validation against
            them.
</li>
<li>Subscribe: Call agents can subscribe for information from the
            ViPR server. There is one service that the call agent can
            subscribe for: number Service. When a new number is validated, the
            ViPR server will send a Notify to the call agent, containing the
            validated number, the ticket, and a set of SIP trunk URIs.
</li>
<li>Notify: The ViPR server sends this message to the call agent
            when it has an event to report for a particular subscription.
</li>
</ul>

<p>The VAP protocol provides authentication by including an integrity
        object in each message. This integrity message is the hash of the
        contents of the message and a shared secret between the ViPR server
        and the client. VAP can also be run over TLS, which enhances security
        further.
</p>
<p>The P2P network introduces rate limits for the purposes of
        performance management and limiting denial of service attacks. Each
        node in the DHT comes with it a limit on the amount of stores per
        second, reads per second, and total amount of data it can store in the
        DHT. The ViPR server rigorously follows those limits.
</p>
<p>As a consequence, when numbers are stored into the DHT, they are
        written in slowly based on the rate limits. The call agent will send a
        Publish operation for each individual number. The ViPR server will
        perform the store in a rate-limited fashion. When the store is
        complete, the ViPR server responds to the Publish, and the call agent
        can move to the next DID to publish. Thus, it may take hours or even
        days to fully store the set of numbers into the DHT. The process then
        repeats several days later in order to refresh the data in the
        DHT.
</p>
<a name="anchor31"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.3"></a><h3>7.3.&nbsp;
Validation Protocol</h3>

<p>The core of ViPR is the validation protocol. The validation
        protocol is used by one ViPR server to connect to another, demand
        proof-of-knowledge of a previous PSTN call, and once proven, securely
        learn a SIP URI and ticket for usage in future SIP calls between
        domains.
</p>
<p>The validation protocol is documented in <a class='info' href='#VIPR-PVP'>[VIPR&#8209;PVP]<span> (</span><span class='info'>Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;The Public Switched Telephone Network (PSTN) Validation           Protocol (PVP),&rdquo; October&nbsp;2010.</span><span>)</span></a>.
</p>
<p>The validation protocol is built using TLS-SRP <a class='info' href='#RFC5054'>[RFC5054]<span> (</span><span class='info'>Taylor, D., Wu, T., Mavrogiannopoulos, N., and T. Perrin, &ldquo;Using the Secure Remote Password (SRP) Protocol for TLS           Authentication,&rdquo; November&nbsp;2007.</span><span>)</span></a>. TLS-SRP creates a secure TLS connection, but
        instead of using certificates, utilizes a password. TLS-SRP was
        designed for cases where the passwords are relatively weak. In the
        case of the validation protocol, the passwords are formed from
        parameters of a previous PSTN call. Once a secure TLS connection is
        formed, a simple request/response protocol is run over it. The request
        contains the domain name of the originating ViPR server, and the
        response contains the SIP URI and ticket for that number.
</p>
<p>The validation protocol properly handles time offsets between the
        two domains for the start and stop times of the calls, the relatively
        weak entropy of a single phone call, the grand chessmaster attack, and
        non-delivery or inaccurate delivery of caller-ID, amongst other
        issues. The validation protocol can be tuned by administrators to
        allow for arbitrary levels of security, measured in terms of
        equivalent entropy. The equivalent entropy is the number of bits of
        entropy that must be demonstrated, as if the domains were
        authenticating each other using a password with that amount of
        entropy. This gives domains a 'nerd knob' they can turn to trade off
        security for performance.
</p>
<p>Because the validation protocol utilizes TLS-SRP, it does not run
        directly through the DHT. This is why a ViPR server requires a
        separate pinhole to be opened for the validation protocol.
</p>
<a name="anchor32"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.7.4"></a><h3>7.4.&nbsp;
SIP Extensions</h3>

<p>The connection between the call agents in different domains is SIP.
        ViPR requires that the inter-domain connections run over TLS, and
        furthermore, utilize SRTP keyed with Sdescriptions.
</p>
<p>ViPR extends SIP with its anti-spam mechanism. This takes the form
        of a ticket, present in a SIP header field. <a class='info' href='#VIPR-SIP-ANTISPAM'>[VIPR&#8209;SIP&#8209;ANTISPAM]<span> (</span><span class='info'>Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;Session Initiation Protocol (SIP) Extensions for Blocking           VoIP Spam Using PSTN Validation,&rdquo; October&nbsp;2010.</span><span>)</span></a> defines this header field and the
        format of the ticket it contains.
</p>
<a name="anchor33"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8"></a><h3>8.&nbsp;
Example Call Flows</h3>

<p>This section provides call flows for the key use cases.
</p>
<a name="anchor34"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.1"></a><h3>8.1.&nbsp;
PSTN Call and VCR Upload</h3>

<p>A call flow for the initial PSTN call and VCR upload is shown in
        <a class='info' href='#fig-pstncall-flow'>Figure&nbsp;6<span> (</span><span class='info'>PSTN Call and Upload</span><span>)</span></a>.
</p><br /><hr class="insert" />
<a name="fig-pstncall-flow"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Alice    CA+O     GW+O    VIPR+O    GW+T     CA+T    VIPR+T     Bob
  |(1) Call NumX    |        |        |        |        |        |
  |-------&gt;|        |        |        |        |        |        |
  |        |(2) INVITE NumX  |        |        |        |        |
  |        |-------&gt;|        |        |        |        |        |
  |        |        |(3) setup NumX   |        |        |        |
  |        |        |----------------&gt;|        |        |        |
  |        |        |        |        |(4) INVITE NumX  |        |
  |        |        |        |        |-------&gt;|        |        |
  |        |        |        |        |        |(5) Call NumX    |
  |        |        |        |        |        |----------------&gt;|
  |        |        |        |        |        |        |     Answers
  |        |        |        |        |        |(6) answer       |
  |        |        |        |        |        |&lt;----------------|
  |        |        |        |        |(7) 200 OK       |        |
  |        |        |        |        |&lt;-------|        |        |
  |        |        |        |        |(8) ACK |        |        |
  |        |        |        |        |-------&gt;|        |        |
  |        |        |(9) answer       |        |        |        |
  |        |        |&lt;----------------|        |        |        |
  |        |(10) 200 OK      |        |        |        |        |
  |        |&lt;-------|        |        |        |        |        |
  |        |(11) ACK|        |        |        |        |        |
  |        |-------&gt;|        |        |        |        |        |
  |(12) accept      |        |        |        |        |        |
  |&lt;-------|        |        |        |        |        |        |
  |hangs up|        |        |        |        |        |        |
  |(13) hangup      |        |        |        |        |        |
  |-------&gt;|        |        |        |        |        |        |
  |        |(14) BYE|        |        |        |        |        |
  |        |-------&gt;|        |        |        |        |        |
  |        |(15) 200 OK      |        |        |        |        |
  |        |&lt;-------|        |        |        |        |        |
  |        |        |(16) hangup      |        |        |        |
  |        |        |----------------&gt;|        |        |        |
  |        |        |        |        |(17) BYE|        |        |
  |        |        |        |        |-------&gt;|        |        |
  |        |        |        |        |(18) 200 OK      |        |
  |        |        |        |        |&lt;-------|        |        |
  |        |        |        |        |        |(19) hangup      |
  |        |        |        |        |        |----------------&gt;|
  |        |(20) Orig UploadVCR       |        |        |        |
  |        |----------------&gt;|        |        |        |        |
  |        |(21) Success     |        |        |        |        |
  |        |&lt;----------------|        |        |        |        |
  |        |        |        |Set timer        |        |        |
  |        |        |        |        |        |(22) Term UploadVCR
  |        |        |        |        |        |-------&gt;|        |
  |        |        |        |        |        |(23) Success     |
  |        |        |        |        |        |&lt;-------|        |

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6: PSTN Call and Upload&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>In message 1, Alice calls the number of her colleague, Bob. This is
        NumX. This call is routed over the PSTN, through the terminating call
        agent, and rings Bob's phone (messages 1-5). Bob answers the phone,
        and this is propagated back to Alice (messages 6-12). Bob and Alice
        talk for a while, and then Alice hangs up. This hangup is propagated
        to Bob, and the call is terminated (messages 13-19).
</p>
<p>The originating call agent notes that this call went to the PSTN,
        and might be a candidate for a future SIP call. It sends an UploadVCR
        message to its ViPR server (message 20), containing the start time,
        stop time, callerID and called party number. The ViPR server
        acknowledges this (message 21), and then sets a timer for a random
        time into the future, at which point it will attempt validation. The
        terminating side is similar; it sends an UploadVCR to its ViPR server
        (message 22), which is acknowledged (message 23). The terminating side
        does not set a timer; it waits for a possible validation attempt which
        may or may not arrive in the future.
</p>
<a name="anchor35"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.2"></a><h3>8.2.&nbsp;
DHT Query and Validation</h3>

<p>This section provides the call flow for what happens on the
        originating ViPR server when the timer fires, in <a class='info' href='#fig-valid'>Figure&nbsp;7<span> (</span><span class='info'>Validation Flow</span><span>)</span></a>.
</p><br /><hr class="insert" />
<a name="fig-valid"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
CA+O                VIPR+O                  DHT                 VIPR+T
  |                    |timer fires          |                     |
  |                    |(1) Query NumX       |                     |
  |                    |--------------------&gt;|                     |
  |                    |(2) Node-ID T        |                     |
  |                    |&lt;--------------------|                     |
  |                    |(3) Connect Node-ID T|                     |
  |                    |--------------------&gt;|                     |
  |                    |                     |(4) Connect Node-ID T|
  |                    |                     |--------------------&gt;|
  |                    |                     |(5) Connect resp.    |
  |                    |                     |&lt;--------------------|
  |                    |(6) Connect resp.    |                     |
  |                    |&lt;--------------------|                     |
  |                    |(7) TCP Connect      |                     |
  |                    |------------------------------------------&gt;|
  |                    |(8) TLS-SRP          |                     |
  |                    |------------------------------------------&gt;|
  |                    |(9) ValExchange(a.com)                     |
  |                    |------------------------------------------&gt;|
  |                    |(10) ValResponse(URI, ticket)              |
  |                    |&lt;------------------------------------------|
  |(11) Notify(NumX,URI,ticket)              |                     |
  |&lt;-------------------|                     |                     |
  |Store route         |                     |                     |

</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;7: Validation Flow&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>First, the timer that was set by the originating ViPR server in
        <a class='info' href='#fig-pstncall-flow'>Figure&nbsp;6<span> (</span><span class='info'>PSTN Call and Upload</span><span>)</span></a> fires. When it fires, the
        ViPR server examines the called party number from the VCR. It performs
        a query into the DHT, to see if this number has been stored by any
        domain (message 1). In this case, it has, and the DHT returns with a
        successful query response (message 2). This response indicates that
        the terminating ViPR server, with node-ID T, claims ownership of the
        number.
</p>
<p>The originating ViPR server asks the DHT to form a connection
        between itself and the terminating ViPR server. This message exchanges
        IP addresses and ports through which a TCP connection can be
        attempted; details are omitted (messages 3-6). Now, the originating
        ViPR server can establish a TCP connection to the terminating ViPR
        server (message 7). Next, the originating ViPR server begins
        negotiation of a TLS-SRP connection. The TLS-SRP uses the caller ID
        and called number as a "username" for this exchange, and the start
        time and stop time of the call as a password. As both sides share the
        same values for this secret, the secure connection is established.
        This is now a TLS connection between the two ViPR servers.
</p>
<p>Over this secure connection, the originating ViPR server sends a
        ValExchange request. This request contains the domain name that is
        claimed by the originating ViPR server (this claim is not verified at
        this time) (message 9). This is received by the terminating ViPR
        server, which then creates a ticket for that domain and NumX, and
        passes the ticket and the SIP URI back to the originating ViPR server
        (message 10). The originating ViPR server sends this information to
        its call agent (message 11), which then stores it for usage in a
        future call.
</p>
<a name="anchor36"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.3"></a><h3>8.3.&nbsp;
DHT Query and No Match</h3>

<p>In this case, after the PSTN call of <a class='info' href='#fig-pstncall-flow'>Figure&nbsp;6<span> (</span><span class='info'>PSTN Call and Upload</span><span>)</span></a>, the timer fires, but the
        originating ViPR server finds no match in the DHT. This is an
        alternative case to the flow in <a class='info' href='#fig-valid'>Figure&nbsp;7<span> (</span><span class='info'>Validation Flow</span><span>)</span></a>.
</p><br /><hr class="insert" />
<a name="fig-nomatch"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
CA+O                VIPR+O                 DHT                VIPR+T
  |                    |timer fires         |                    |
  |                    |(1) Query NumX      |                    |
  |                    |-------------------&gt;|                    |
  |                    |(2) noMatch         |                    |
  |                    |&lt;-------------------|                    |
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;8: DHT No-Match&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<a name="anchor37"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.8.4"></a><h3>8.4.&nbsp;
SIP Call</h3>

<p>In this case, shown in <a class='info' href='#fig-sipcall'>Figure&nbsp;9<span> (</span><span class='info'>SIP Call</span><span>)</span></a>, a user
        makes a call to a number which has been learned via ViPR.
</p><br /><hr class="insert" />
<a name="fig-sipcall"></a>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
Alfred      CA+O          BE+O          BE+T          CA+T        Bob
|(1) Call X   |             |             |             |           |
|------------&gt;|             |             |             |           |
|             |(2) INVITE X |             |             |           |
|             |Ticket       |             |             |           |
|             |------------&gt;|             |             |           |
|             |             |(3) TCP and TLS            |           |
|             |             |w domain certs             |           |
|             |             |------------&gt;|             |           |
|             |             |(4) INVITE X |             |           |
|             |             |Ticket       |             |           |
|             |             |------------&gt;|             |           |
|             |             |             |Validate Ticket          |
|             |             |             |(5) INVITE X |           |
|             |             |             |Ticket       |           |
|             |             |             |------------&gt;|           |
|             |             |             |             |(6)INVITE X|
|             |             |             |             |----------&gt;|
</pre></div><table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;9: SIP Call&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

<p>First, a user in the originating domain - Alfred - calls Bob's
        number (message 1). The originating call agent notes that it has a
        cached route for that number. It extracts the SIP URI, using it as the
        topmost Route header field, and then attaches the ticket to the
        X-Cisco-ViPR-Ticket header field. This INVITE is sent to a default
        next hop border element (message 2). The border element establishes a
        TCP/TLS connection with the domain in the Route header. It uses a
        traditional domain certification for this TLS connection (message 3).
        Once established, it sends the INVITE over the connection (message
        4).
</p>
<p>This arrives at the terminating call agent, which extracts the
        ticket and verifies it. To verify it, it checks the signature using
        the key that was used to create the ticket. Then, it compares the
        domain name in the ticket with the domain name from the TLS connection
        handshake. Finally, it compares the called party number in the
        Request-URI with the value from the ticket. Assuming they all match,
        the call is forwarded to the terminating call agent (message 5), where
        it is finally delivered to Bob (message 6).
</p>
<a name="anchor38"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9"></a><h3>9.&nbsp;
Security Considerations</h3>

<p>Security is incredibly important for ViPR. This section provides an
      overview of some of the key threats and how they are handled.
</p>
<a name="anchor39"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.1"></a><h3>9.1.&nbsp;
Attacks on the DHT</h3>

<p>Attackers could attempt to disrupt service through a variety of
        attacks on the DHT.
</p>
<p>Firstly, it must be noted that the DHT is never used at call setup
        time. It is accessed as a background task, solely to learn NEW numbers
        and routes that are not already known. If, by some tragedy, an
        attacker destroyed the P2P network completely, it would not cause a
        single call to fail. Furthermore, it would not cause calls to revert
        to the PSTN - calls to routes learned previously would still go over
        the IP network. The only impact to such a devastating attack, is that
        a domain could not learn *new* routes to new numbers, until the DHT is
        restored to service. This service failure is hard for users and
        administrators to even notice.
</p>
<p>That said, ViPR prevents many of these attacks. The DHT itself is
        secured using TLS - its usage is mandatory. Quota mechanisms are put
        into place that prevent an attacker from storing large amounts of data
        in the DHT. Other attacks are prevented by mechanisms defined by
        RELOAD itself, and are not ViPR specific.
</p>
<a name="anchor40"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.2"></a><h3>9.2.&nbsp;
Theft of Phone Numbers</h3>

<p>The key security threat that ViPR is trying to address is the theft
        of phone numbers. In particular, a malicious domain could store, into
        the DHT, phone numbers that it does not own, in an attempt to steal
        calls targeted to those numbers. This attack is prevented by the core
        validation mechanism, which performs a proof of knowledge check to
        verify ownership of numbers.
</p>
<p>An attacker could try to claim numbers it doesn't own, which are
        claimed legitimately by other domains in the ViPR network. This attack
        is prevented as well. Each domain storing information into the DHT can
        never overwrite information stored by another domain. As a
        consequence, if two domains claim the same number, two records are
        stored in the DHT. An originating domain will validate against both,
        and only one will validate - the real owner.
</p>
<p>An attacker could actually own a phone number, use it for a while,
        validate with it, and build up a cache of routes at other domains.
        Then, it gives back the phone number to the PSTN provider, who
        allocates it to someone else. However, the attacker still claims
        ownership of the number, even though they no longer have it. This
        attack is prevented by expiring the learned routes after a while.
        Typically, operators do not re-assign a number for a few months, to
        allow out-of-service messages to be played to people that still have
        the old number. Thus, the TTL for cached routes is set to match the
        duration that carriers typically hold numbers.
</p>
<p>An attacker could advertise a lot of numbers, most of which are
        correct, some of which are not. ViPR prevents this by requiring each
        number to be validated individually.
</p>
<p>An attacker could make a call so they know the call details of the
        call they made and use this to forge a validation for that call. They
        could then try to convince other users, which would have to be in the
        same domain as the attacker, to trust this validation. This is
        mitigated by not sharing validations inside of domains where the users
        that can originate call from that domain are not trusted by the
        domain.
</p>
<a name="anchor41"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.3"></a><h3>9.3.&nbsp;
Spam</h3>

<p>Another serious concern is that attackers may try to launch VoIP
        spam (also known as SPIT) calls into a domain. ViPR prevents this by
        requiring that a domain make a PSTN call to a number before it will
        allow a SIP call to be accepted to that same number. This provides a
        financial disincentive to spammers. The current relatively high cost
        of international calling, and the presence of national do-not-call
        regulations, have prevented spam on the PSTN to a large degree. ViPR
        applies those same protections to SIP connections.
</p>
<p>As noted above, ViPR still lowers the cost of communications, but
        it does so by amortizing that savings over a large number of calls.
        The costs of communications remain high for infrequent calls to many
        numbers, and become low for frequent calls to a smaller set of
        numbers. Since the former is more interesting to spammers, ViPR gears
        its cost incentives away from the spammers, and towards domains which
        collaborate frequently.
</p>
<p>Of course, ViPR's built-in mechanism is not a guarantee. A SPIT
        clearinghouse could shoulder the costs of the PSTN calls, and then
        re-sell its access for a fee. However, this still causes the
        clearinghouse to utilize non-trivial resources in its attack. Though
        these costs are less than the PSTN, they are more than zero, and
        should act as a deterrent for a long while.
</p>
<a name="anchor42"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.9.4"></a><h3>9.4.&nbsp;
Eavesdropping</h3>

<p>Another class of attacks involves outsiders attempting to listen in
        on the calls that run over the Internet, or obtain information about
        the call through observation of signaling.
</p>
<p>All of these attacks are prevented by requiring the usage of SIP
        over TLS and SRTP. These are mandatory to use.
</p>
<a name="anchor43"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.10"></a><h3>10.&nbsp;
IANA Considerations</h3>

<p>This specification does not require any actions from IANA.
</p>
<a name="anchor44"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.11"></a><h3>11.&nbsp;
Acknowledgements</h3>

<p>Thanks to Theo Zourzouvillys for pointing out the fifth thief of
      phone numbers attack.
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.12"></a><h3>12.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="P2PSIP-BASE">[P2PSIP-BASE]</a></td>
<td class="author-text">Jennings, C., Lowekamp, B., Rescorla, E., Baset, S., and H. Schulzrinne, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-p2psip-base-11.txt">REsource LOcation And Discovery (RELOAD) Base
          Protocol</a>,&rdquo; draft-ietf-p2psip-base-11 (work in progress), October&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-p2psip-base-11.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="P2PSIP-SIP">[P2PSIP-SIP]</a></td>
<td class="author-text">Jennings, C., Lowekamp, B., Rescorla, E., Baset, S., and H. Schulzrinne, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-ietf-p2psip-sip-05.txt">A SIP Usage for RELOAD</a>,&rdquo; draft-ietf-p2psip-sip-05 (work in progress), July&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-ietf-p2psip-sip-05.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="VIPR-RELOAD-USAGE">[VIPR-RELOAD-USAGE]</a></td>
<td class="author-text">Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-dispatch-vipr-reload-usage-03.txt">A Usage of Resource Location and Discovery (RELOAD) for
          Public Switched Telephone Network (PSTN) Verification</a>,&rdquo; draft-rosenberg-dispatch-vipr-reload-usage-03 (work in progress), October&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-dispatch-vipr-reload-usage-03.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="VIPR-SIP-ANTISPAM">[VIPR-SIP-ANTISPAM]</a></td>
<td class="author-text">Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-dispatch-vipr-sip-antispam-03.txt">Session Initiation Protocol (SIP) Extensions for Blocking
          VoIP Spam Using PSTN Validation</a>,&rdquo; draft-rosenberg-dispatch-vipr-sip-antispam-03 (work in progress), October&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-dispatch-vipr-sip-antispam-03.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="VIPR-VAP">[VIPR-VAP]</a></td>
<td class="author-text">Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-dispatch-vipr-vap-03.txt">Verification Involving PSTN Reachability: The ViPR Access
          Protocol (VAP)</a>,&rdquo; draft-rosenberg-dispatch-vipr-vap-03 (work in progress), October&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-dispatch-vipr-vap-03.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="VIPR-PVP">[VIPR-PVP]</a></td>
<td class="author-text">Rosenberg, J., Jennings, C., and M. Petit-Huguenin, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-dispatch-vipr-pvp-03.txt">The Public Switched Telephone Network (PSTN) Validation
          Protocol (PVP)</a>,&rdquo; draft-rosenberg-dispatch-vipr-pvp-03 (work in progress), October&nbsp;2010 (<a href="http://www.ietf.org/internet-drafts/draft-rosenberg-dispatch-vipr-pvp-03.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>12.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC2543">[RFC2543]</a></td>
<td class="author-text"><a href="mailto:mjh@aciri.org">Handley, M.</a>, <a href="mailto:schulzrinne@cs.columbia.edu">Schulzrinne, H.</a>, <a href="mailto:schooler@cs.caltech.edu">Schooler, E.</a>, and <a href="mailto:jdrosen@bell-labs.com">J. Rosenberg</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2543">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;2543, March&nbsp;1999 (<a href="http://www.rfc-editor.org/rfc/rfc2543.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3261">[RFC3261]</a></td>
<td class="author-text">Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A., Peterson, J., Sparks, R., Handley, M., and E. Schooler, &ldquo;<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>,&rdquo; RFC&nbsp;3261, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3261.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3263">[RFC3263]</a></td>
<td class="author-text">Rosenberg, J. and H. Schulzrinne, &ldquo;<a href="http://tools.ietf.org/html/rfc3263">Session Initiation Protocol (SIP): Locating SIP
          Servers</a>,&rdquo; RFC&nbsp;3263, June&nbsp;2002 (<a href="http://www.rfc-editor.org/rfc/rfc3263.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5039">[RFC5039]</a></td>
<td class="author-text">Rosenberg, J. and C. Jennings, &ldquo;<a href="http://tools.ietf.org/html/rfc5039">The Session Initiation Protocol (SIP) and Spam</a>,&rdquo; RFC&nbsp;5039, January&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5039.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3761">[RFC3761]</a></td>
<td class="author-text">Faltstrom, P. and M. Mealling, &ldquo;<a href="http://tools.ietf.org/html/rfc3761">The E.164 to Uniform Resource Identifiers (URI) Dynamic
          Delegation Discovery System (DDDS) Application (ENUM)</a>,&rdquo; RFC&nbsp;3761, April&nbsp;2004 (<a href="http://www.rfc-editor.org/rfc/rfc3761.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5389">[RFC5389]</a></td>
<td class="author-text">Rosenberg, J., Mahy, R., Matthews, P., and D. Wing, &ldquo;<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>,&rdquo; RFC&nbsp;5389, October&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5389.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5067">[RFC5067]</a></td>
<td class="author-text">Lind, S. and P. Pfautz, &ldquo;<a href="http://tools.ietf.org/html/rfc5067">Infrastructure ENUM Requirements</a>,&rdquo; RFC&nbsp;5067, November&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc5067.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5054">[RFC5054]</a></td>
<td class="author-text">Taylor, D., Wu, T., Mavrogiannopoulos, N., and T. Perrin, &ldquo;<a href="http://tools.ietf.org/html/rfc5054">Using the Secure Remote Password (SRP) Protocol for TLS
          Authentication</a>,&rdquo; RFC&nbsp;5054, November&nbsp;2007 (<a href="http://www.rfc-editor.org/rfc/rfc5054.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="CLF-SYNTAX">[CLF-SYNTAX]</a></td>
<td class="author-text">Roach, A., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-roach-sipping-clf-syntax-01.txt">Binary Syntax for SIP Common Log Format</a>,&rdquo; draft-roach-sipping-clf-syntax-01 (work in progress), May&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-roach-sipping-clf-syntax-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="SESSION-ID">[SESSION-ID]</a></td>
<td class="author-text">Kaplan, H., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-kaplan-sip-session-id-02.txt">A Session Identifier for the Session Initiation Protocol
          (SIP)</a>,&rdquo; draft-kaplan-sip-session-id-02 (work in progress), March&nbsp;2009 (<a href="http://www.ietf.org/internet-drafts/draft-kaplan-sip-session-id-02.txt">TXT</a>).</td></tr>
</table>

<a name="anchor47"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A"></a><h3>Appendix A.&nbsp;
Release notes</h3>

<p>This section must be removed before publication as an RFC.
</p>
<a name="anchor48"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.A.1"></a><h3>A.1.&nbsp;
Modifications between rosenberg-04 and rosenberg-03</h3>

<p></p>
<ul class="text">
<li>Nits.
</li>
<li>Shorter I-Ds references.
</li>
<li>Changed phone numbers to follow E.123 presentation.
</li>
<li>Expanded P2P initialisms.
</li>
<li>Uses +1 408 555 prefix for phone numbers in examples.
</li>
</ul>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jonathan Rosenberg</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">jdrosen.net</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Monmouth, NJ</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">US</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:jdrosen@jdrosen.net">jdrosen@jdrosen.net</a></td></tr>
<tr><td class="author" align="right">URI:&nbsp;</td>
<td class="author-text"><a href="http://www.jdrosen.net">http://www.jdrosen.net</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cullen Jennings</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Cisco</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">170 West Tasman Drive</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">MS: SJC-21/2</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">San Jose, CA  95134</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">USA</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+1 408 421-9990</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:fluffy@cisco.com">fluffy@cisco.com</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Marc Petit-Huguenin</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Stonyfish</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:marc@stonyfish.com">marc@stonyfish.com</a></td></tr>
</table>
</body></html>
