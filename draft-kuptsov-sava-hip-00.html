<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>SAVAH: Source address validation architecture with Host Identity Protocol</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="SAVAH: Source address validation architecture with Host Identity Protocol">
<meta name="keywords" content="">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<meta name="viewport" content="width=600;" />
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: 85%;
		max-width: 40em; 
		color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: 85%;
		max-width: 40em; 
		font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: 85%;
		max-width: 40em; 
		text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Internet Engineering Task Force</td><td class="header">D. Kuptsov</td></tr>
<tr><td class="header">Internet-Draft</td><td class="header">A. Gurtov</td></tr>
<tr><td class="header">Intended status: Informational</td><td class="header">HIIT</td></tr>
<tr><td class="header">Expires: September 3, 2009</td><td class="header">J. Bi</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">Tsinghua Univeristy</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">March 02, 2009</td></tr>
</table></td></tr></table>
<h1><br />SAVAH: Source address validation architecture with Host Identity Protocol<br />draft-kuptsov-sava-hip-00</h1>

<h3>Status of this Memo</h3>
<p>
This Internet-Draft is submitted to IETF in full
conformance with the provisions of BCP&nbsp;78 and BCP&nbsp;79.</p>
<p>
Internet-Drafts are working documents of the Internet Engineering
Task Force (IETF), its areas, and its working groups.
Note that other groups may also distribute working documents as
Internet-Drafts.</p>
<p>
Internet-Drafts are draft documents valid for a maximum of six months
and may be updated, replaced, or obsoleted by other documents at any time.
It is inappropriate to use Internet-Drafts as reference material or to cite
them other than as &ldquo;work in progress.&rdquo;</p>
<p>
The list of current Internet-Drafts can be accessed at
<a href='http://www.ietf.org/ietf/1id-abstracts.txt'>http://www.ietf.org/ietf/1id-abstracts.txt</a>.</p>
<p>
The list of Internet-Draft Shadow Directories can be accessed at
<a href='http://www.ietf.org/shadow.html'>http://www.ietf.org/shadow.html</a>.</p>
<p>
This Internet-Draft will expire on September 3, 2009.</p>

<h3>Copyright Notice</h3>
<p>
Copyright (c) 2009 IETF Trust and the persons identified as the
document authors.  All rights reserved.</p>
<p>
This document is subject to BCP 78 and the IETF Trust's Legal
Provisions Relating to IETF Documents in effect on the date of
publication of this document (http://trustee.ietf.org/license-info).
Please review these documents carefully, as they describe your
rights and restrictions with respect to this document.</p>

<h3>Abstract</h3>

<p>
	This document describes an architecture for the source address 
	validation with help of Host Identity Protocol (HIP), SAVAH. The architecture 
	utilizes the properties of cryptographically strong protocol to 
	authenticate an originator of a network communication. In addition
	this architecture offers network access control, data 
	protection, host mobilty and multihoming features and 
	is suitable for the wireless networks. The proposed, architecture 
	is the first-hop router solution, meaning that it should be deployed on the 
	router placed on the edge of a local network topology. 
      
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#anchor1">1.</a>&nbsp;
Introduction<br />
<a href="#Overview">2.</a>&nbsp;
SAVAH protocol overview<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#discovery">2.1.</a>&nbsp;
SAVAH router discovery and registration<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#validation">2.2.</a>&nbsp;
Source address validation<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#tunneling">2.3.</a>&nbsp;
SAVAH tunneling mode<br />
<a href="#pkt_format">3.</a>&nbsp;
Packet format<br />
<a href="#Security">4.</a>&nbsp;
Security Considerations<br />
<a href="#Credits">5.</a>&nbsp;
Credits<br />
<a href="#rfc.references1">6.</a>&nbsp;
Normative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Authors' Addresses<br />
</p>
<br clear="all" />

<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p> 
	This document specifies an extension to Host Identity Protocol (HIP)
	<a class='info' href='#RFC4423'>RFC 4423<span> (</span><span class='info'>Moskowitz, R. and P. Nikander, &ldquo;Host Identity Protocol (HIP) Architecture,&rdquo; May&nbsp;2006.</span><span>)</span></a> [RFC4423] and its component (i.e. 
	HIP firewall) to perform per packet source address validation and 
	authentication. The extension provides means to authenticate the 
	traffic using properties of cryptographic algorithms. It is assumed 
	that this approach is to be implemented on the edge, or first-hop, 
	router of the local network. 
	The approach in this document should be easily integrated with 
	Source Address Validation Architecture (SAVA) specified 
	in <a class='info' href='#RFC5210'>RFC5210<span> (</span><span class='info'>Wu, J., Bi, J., Li, X., Ren, G., Xu, K., and M. Williams, &ldquo;A Source Address Validation Architecture (SAVA) Testbed and Deployment Experience,&rdquo; June&nbsp;2008.</span><span>)</span></a> [RFC5210] and provide 
	an alternative for a <a class='info' href='#I-D.bi-savi-csa'>CGA based Source Address Authorization and Authentication (CSA)
	Mechanism<span> (</span><span class='info'>Bi, J., Wu, J., and G. Yao, &ldquo;A CGA based Source Address Authorization and Authentication (CSA) Mechanism  for First IPv6 Layer-3 Hop,&rdquo; July&nbsp;2008.</span><span>)</span></a> [I&#8209;D.bi&#8209;savi&#8209;csa].
      
</p>
<p>
	This document assumes that the  solution is tailored to validate the source addresses 
	only of the nodes that belong to the same network. Traffic generated 
	from the hosts from outside network is not checked, validated or 
	authenticated, meaning that some other solutions  are needed to be used
	to achieve this goal.
      
</p>
<p>
	To authenticate the traffic using HIP the following approaches can be used:
	</p>
<ul class="text">
<li>
	    First propose, when both communicating peers are HIP enabled. Then HIP 
	    firewall (which is in fact should be deployed on the edge of the local 
	    subnetwork) tracks base exchange signaling packets from of all hosts that 
	    try to communicate with hosts outside the local subnetwork and only lets 
	    through packets with valid HITs and IP addresses. Later data packets are 
	    sent in ESP encapsulated packets so that the firewall can check SPI values 
	    of the packets and drop those that does not match previously seen base 
	    exchange. The shortcoming of this approach is requirement of universal
	    deployment of HIP.
	  
</li>
<li>
	    Secondly, hosts that are inside the local subnetwork, including first-hop
	    router, assumed to support HIP with SAVAH extension. This document focuses 
	    on a description of SAVAH extension. 
	  
</li>
<li>
	    Finally, HIP tunneling approach can be used. It is thought to be less efficient in 
	    terms of performance, but can provide better security and mobility support to the wireless 
	    clients.  The client creates a tunnel between himself and the SAVAH router using HIP base 
	    exchange and SAVAH extension. Later all traffic is forwarded through this tunnel to the 
	    Internet.
	  
</li>
</ul><p>
      
</p>
<a name="Overview"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
SAVAH protocol overview</h3>

<p>
	This section describes the SAVAH extension. It illustrates 
	and explains the signaling and data packets, as well as it 
	discusses the source address validation mechanism.
	<br /><hr class="insert" />
<a name="msq_squence"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   Client               DHCP    Router                          Peer
      |  Request network  |        |                              |
      |   configuration   |        |                              |
      |------------------&gt;|        |                              |
      |  Offer netwoork   |        |                              |
      |   configuration   |        |                              |
      |&lt;------------------|        |                              |
+-----|                   |        |                              |
|Get  |                   |        |                              |
|gate |                   |        |                              |
|way  |                   |        |--------+                     |
+----&gt;|            I1     |        | Check  |                     |
      |---------------------------&gt;|  HIT   |                     |
      |                   |        | in ACL |                     |
      |                   |        |&lt;-------+                     |
      |       R1 (REG_INFO)        |                              |
      |&lt;---------------------------|                              |
      |                   |        |                              |
      |                   |        |--------+                     |
      |     I2 (REG_REQUEST)       | Check  |                     |
      |---------------------------&gt;|  HIT   |                     |
      |                   |        | in ACL |                     |
      |                   |        |&lt;-------+                     |
      |     R2 (REG_RESPONSE)      |                              |
      |&lt;---------------------------|                              |
      |                   |        |                              |
      |                   |        |--------+                     |
      |     Plain IP(SAVAH opt)    | Check  |                     |
      |---------------------------&gt;| source |                     |
      |                   |        |   IP   |                     |
      |                   |        |&lt;-------+                     |
      |                   |        |    Plain IP (no SAVAH opt)   |
      |                   |        |-----------------------------&gt;|
      |                   |        |                              |
      |                   |        |                              |
      |                   |        |    Plain IP (no SAVAH opt)   |
      |&lt;----------------------------------------------------------|
      |                   |        |                              |
      |                   |        |                              |
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;1&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

        SAVAH is targeted to solve the source address validation problem in the 
	edge router of the local network, serving as a default gateway. Because of 
	that, SAVAH architecture is composed of two main components:
	</p>
<ul class="text">
<li>
	    SAVAH enabled client, which is a combination of a HIP daemon and a
	    firewall in a client mode supporting SAVAH extension
	  
</li>
<li>
	    SAVAH enabled router running the HIP daemon and the firewall 
	    but in server mode
	  
</li>
</ul><p>
	DHCP server can be considered a third component in our architecture. 
	Its main role in the network is to offer particular configuration for 
	SAVAH aware hosts. For instance, DHCP can provide the default gateway IP address 
	as well as HIT of the SAVAH router. Availability and proper configuration of 
	DHCP server can help to solve the problem of opportunistic mode that is 
	being discussed later in this section. However, we consider DHCP as an 
	optional component in the network topology. SAVAH aware clients can be configured 
	manually, meaning that the IP address and the HIT of the SAVAH router can be setup by 
	a system administrator prior to any communication. However, manual configuration 
	can be a tedious task in a large scale network. As a third option, if non of the 
	advised is accessible in the local network, the SAVAH enabled client can try to 
	discover the SAVAH router using the opportunistic mode.

	The message sequence diagram for SAVAH registration and further authentication 
	process is shown in Figure 1. As discussed previously it can involve three 
	entities in the local network to perform the source address validation: the 
	SAVAH client, the SAVAH router and the DHCP server (optionally). The receiver 
	on Figure 1 is playing the role of a legacy peer, i.e., it may or may not support 
	HIP. Of course, if both communicating peers support HIP protocol the whole scenario 
	requires only normal HIP-enabled firewall to filter the traffic based on HITs.
	

      
</p>
<a name="discovery"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.1"></a><h3>2.1.&nbsp;
SAVAH router discovery and registration</h3>

<p>
	  
	  Successful passing of the address validation procedure on the first-hop 
	  router requires a client to register. This is  completed through HIP 
	  registration extension <a class='info' href='#RFC5203'>RFC5203<span> (</span><span class='info'>Laganier, J., Koponen, T., and L. Eggert, &ldquo;Host Identity Protocol (HIP) Registration Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a> [RFC5203].


	  Since SAVAH router is the first-hop router, it should be placed 
	  on the edge of the local network and serve as a default gateway. If the 
	  default gateway and the SAVAH router are not placed physically on the same 
	  node it becomes meaningless, because all network traffic flowing through 
	  the SAVAH-unaware router would not contain SAVAH option and would be discarded. 
	  If DHCP server does not offer a HIT of the SAVAH router during the address
	  assignment phase, then the SAVAH client is obliged to discover the presence 
	  of the SAVAH service automatically. Otherwise, the client is aware of the HIT and 
	  the IP address of the SAVAH router and can register to the service directly. 
	  It is also possible to preconfigure the client and specify the IP address and HIT 
	  of the default gateway.
	  
	  Optionally, the presence of a SAVAH-unaware DHCP means that the client will obtain only 
	  the IP address of the default gateway. No prior knowledge of 
	  the SAVAH router's HIT forces the client to discover the service using the HIP 
	  opportunistic mode <a class='info' href='#I-D.lindqvist-hip-opportunistic'>I-D.lindqvist-hip-opportunistic<span> (</span><span class='info'>Lindqvist, J., &ldquo;Establishing Host Identity Protocol Opportunistic Mode with TCP Option,&rdquo; March&nbsp;2006.</span><span>)</span></a> [I&#8209;D.lindqvist&#8209;hip&#8209;opportunistic] and a set of standardized procedures 
	  for HIP service registration as described in <a class='info' href='#RFC5203'>RFC5203<span> (</span><span class='info'>Laganier, J., Koponen, T., and L. Eggert, &ldquo;Host Identity Protocol (HIP) Registration Extension,&rdquo; April&nbsp;2008.</span><span>)</span></a> [RFC5203].The drawback of 
	  such broadcasting is that in the opportunistic mode the client is unaware of 
	  the HIT of SAVAH router and any node can thus pretend to be a valid router. This 
	  reminds a similar problem with SSH, when connecting to an unknown hosts. 
	  Hence, the opportunistic mode should be used only in a trusted environment.
	  
	  To trigger a registration in opportunistic mode, the SAVAH client requests from the 
	  system the default gateway IP address and sends an I1 packet with the destination HIT as a 
	  hashed source IP address. On the other side, the default gateway running SAVAH in a server 
	  mode responds with an R1 packet containing an offer for available services in REG_INFO 
	  parameter. Upon receiving the R1 packet the client chooses the supported services and 
	  responds with an I2 packet containing a REG_REQUEST parameter to SAVAH server. 
	  If REG INFO parameter does not contain the SAVAH service offer, the client completes 
	  base exchange normally and afterward falls to a normal communication, i.e. SAVAH mode 
	  is not supported in this network. Finally, depending on the setup of 
	  the SAVAH router, it either grants or denies the service to client in a R2 packet in a 
	  REG_RESPONSE or REG_FAILED parameter correspondingly. Receiving REG_FAILED parameter 
	  in an R2 message during the base exchange or experiencing a timeout in a I1 state 
	  means that either the default gateway does not support SAVAH extension or 
	  that HIP daemon with SAVAH extension is not running at all. This situation should  
	  indicate to the SAVAH client to fallback to a normal communication, i.e., the 
	  packets that would be forwarded through the default gateway will not 
	  contain any authentic information. As an opposite result, if the SAVAH router 
	  grants the service to the registering client, both parties will posses a 
	  shared secret key.
	
</p>
<a name="validation"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.2"></a><h3>2.2.&nbsp;
Source address validation</h3>

<p>

	  For performance issues, the keys that are used 
	  for authentication (i.e., HMAC keys) in IPSec 
	  were selected to authenticate the source 
	  addresses. Depending on a setup, symmetric 
	  cryptography can be selected as well.
	  
	  Filtering based on HITs can be done to ensure 
	  that the peer trying to register to the SAVAH 
	  service is legitimate. This filtering can 
	  enforce to either grant or deny the SAVAH 
	  service to the registrars. The grounds for such 
	  a decision can be rules specified in the 
	  HIP-enabled firewall. By default, all packets 
	  with unknown identifier are dropped. 
	  
	  After completion of the HIP base exchange, 
	  the SAVAH router adds the source IP address of 
	  the host to a database. This works 
	  if no record with such IP address 
	  already present in the database. If a record 
	  with such IP address already exists, it is 
	  likely
	  that the host is trying to spoof someone else 
	  address and the packet should be dropped nor 
	  state is added.  Moreover this incident can be 
	  logged and reported for further analysis.
	  
	  If the host experiences an address change, then 
	  the record is replaced with a new IP address. To 
	  ensure the validity of the host, HIP UPDATE 
	  packet has to be received and handled properly. 
	  This will guarantee that the host indeed who it 
	  is claiming to be. The record should be removed 
	  from the database upon a timeout or when the 
	  host removes a security association (e.g., HIP 
	  CLOSE packet is received from the corresponding 
	  host). To ensure that the client is alive, SAVAH 
	  router can also send heartbeats to the client, 
	  without waiting for the timeout.
	  
	  After the secret keys were established by means 
	  of the HIP base exchange, the SAVAH client may 
	  communicate with the nodes outside of the local 
	  network by including an authenticated source IP 
	  address in each packet. Current implementation 
	  has two options to deliver the authenticated 
	  hash value to the router. First approach is to 
	  replace the original source IP address of each 
	  packet with truncated result obtained from 
	  HMAC(key | {P}) operation, where {P} is 
	  the packet to be transmitted. We have chosen the 
	  packet value as a feed to HMAC function to 
	  introduce simple protect mechanism from replay 
	  attacks. 
	  
	  This approach has some drawbacks. First 
	  of all, for IPv4 networks the size of 
	  authentication value will be only 32 bits. 
	  Secondly, that would decrease the performance 
	  since additional address translation would be 
	  required on the router. Finally, that method 
	  will require additional changes to the router to 
	  recognize locally routed traffic.
	  
	  A different way to carry the authenticated 
	  source IP address to SAVAH router is to store it 
	  in an IP option. Since the SAVAH router is the 
	  first-hop router and all SAVAH related options 
	  are striped out on the forward direction, this 
	  ensures that no modifications are required for 
	  other routers on the path. Placing the 
	  authentication value in the IP option can have 
	  certain advantages. First of all, this approach 
	  slightly optimizes the performance of the 
	  architecture. Secondly, stronger security 
	  can be achieved by increasing the length of the 
	  authentication value. We suggest to keep this 
	  length within wise bounds, since it affects the 
	  size of the actual payload.
	  
	  To authenticate the packet source address, the 
	  following algorithm is used. On the router side, 
	  each packet in forward direction is searched 
	  for the SAVAH IP option. If found, the router 
	  compares the value of the option against 
	  truncated 128-bit result from HMAC(key | 
	  {P}) operation, where {P} is the packet 
	  to be forwarded. If matches, the SAVAH option is 
	  striped out and the packet is re-injected to the 
	  network. If not, the pinhole is searched for a 
	  given source and destination IP addresses. If 
	  the pinhole is found, the packet is said to be 
	  an 
	  inbound packet for previously authenticated 
	  outbound communication. Finally, if both are 
	  failed the packet is dropped.
	  
	  If the tunneling approach is used, then the 
	  authentication succeeds if the SAVAH router can 
	  successfully decrypt the ESP packet and resend 
	  encapsulated in ESP original packet to its final 
	  destination. Unlike the lightweight approach for 
	  inbound traffic, the SAVAH router in a tunnel 
	  mode should properly encrypt and tunnel the 
	  packet to the corresponding mobile node.
	  
</p>
<a name="tunneling"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2.3"></a><h3>2.3.&nbsp;
SAVAH tunneling mode</h3>

<p>
	  
	  This section describes how SAVAH operates in tunneling mode. The major 
	  difference from the lightweight SAVHA mode (<a class='info' href='#Overview'>SAVAH protocol overview section<span> (</span><span class='info'>SAVAH protocol overview</span><span>)</span></a>) is that all traffic leaving the 
	  local host is encapsulated in ESP packets and forwarded to SAVAH router.
	  
	  <br /><hr class="insert" />
<a name="msq_squence_tunnel"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
   Client               DHCP    Router                          Peer
      |  Request network  |          |                              |
      |   configuration   |          |                              |
      |------------------&gt;|          |                              |
      |  Offer netwoork   |          |                              |
      |   configuration   |          |                              |
      |&lt;------------------|          |                              |
+-----|                   |          |                              |
|Get  |                   |          |                              |
|gate |                   |          |                              |
|way  |                   |          |---------+                    |
+----&gt;|            I1     |          |  Check  |                    |
      |-----------------------------&gt;|  HIT    |                    |
      |                   |          | in ACL  |                    |
      |                   |          |&lt;--------+                    |
      |       R1 (REG_INFO)          |                              |
      |&lt;-----------------------------|                              |
      |                   |          |                              |
      |                   |          |--------+                     |
      |     I2 (REG_REQUEST)         | Check  |                     |
      |-----------------------------&gt;|  HIT   |                     |
      |                   |          | in ACL |                     |
      |                   |          |&lt;-------+                     |
      |     R2 (REG_RESPONSE)        |                              |
      |&lt;-----------------------------|                              |
      |                   |          |                              |
      |                   |          |--------+                     |
      | ESP tunneld IP traffic       | Check  |                     |
      |-----------------------------&gt;| source |                     |
      |                   |          |   IP   |                     |
      |                   |          | Decrypt|                     |
      |                   |          |   ESP  |                     |
      |                   |          |&lt;-------+                     |
      |                   |          |                              |
      |                   |          |                              |
      |                   |          |    Plain IP (non encypted)   |
      |                   |          |-----------------------------&gt;|
      |                   |          |                              |
      |                   |          |                              |
      |                   |          |    Plain IP (non encrypted)  |
      |                   |          |&lt;-----------------------------|
      |                   |          |                              |
      |                   | +--------+                              |
      |                   | |Check   |                              |
      |                   | |pinhole |                              |
      |                   | |Encrypt |                              |
      |                   | |traffic |                              |
      |                   | +-------&gt;|                              |
      |                   |          |                              |
      |    ESP tunneled IP traffic   |                              |
      |&lt;-----------------------------|                              |
      |                   |          |                              |
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;2&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

	  The registration and source address validation mechanisms are the same
	  as in lightweight SAVAH mode. 
	
</p>
<p>
	  Once the encrypted packet arrives on the SAVAH router it decrypts 
	  the packet validates the source IP address and forwards the encapsulated 
	  original packet to the destination host.
	
</p>
<p>
	  Upon the arrival of the packet from the Internet on the SAVAH router, its 
	  task to check if the pinhole exists. If there was previous communication
	  the SAVAH router encrypts the packet (in similar way it is done on the 
	  SAVAH client) and forwards ESP encapsulated packet to the corresponding SAVAH 
	  client.
	
</p>
<a name="pkt_format"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Packet format</h3>

<p>
	This section describes the format of the IP options that are 
	used to carry authentication data.
      
</p>
<p>
	For IPv4 protocol the format of SAVAH option is as follows:
	<br /><hr class="insert" />
<a name="ipv4_pkt"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Option type |  Option Len   |                                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                 +
|                                                               |
+                                                               +
|                   Encrypted source IP address                 |
+                                                               +
|                                                               |
+                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               |          Padding              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;3&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

		</p>
<ul class="text">
<li>
	    Option Type (value 158) is the field that describes SAVAH option,
	    and concatenation of the following bit values:
	    
<ul class="text">
<li>
		First highest bit is 1 indicating to copy this option
		to every packet
	      
</li>
<li>
		Next 2 bits (Option Class) is 00 meaning that this is 
		control option
	      
</li>
<li>
		The last 5 bits are 11110 which signal the experimental purpose of the option 
		as assigned in <a class='info' href='#RFC4727'>RFC 4727<span> (</span><span class='info'>Fenner, B., &ldquo;Experimental Values In IPv4, IPv6, ICMPv4, ICMPv6, UDP, and TCP Headers,&rdquo; November&nbsp;2006.</span><span>)</span></a> [RFC4727]
	      
</li>
</ul>
	  
</li>
<li>
	    Encrypted source IP address is the truncated 128 bit length result 
	    from operation HMAC(key|IP address), where key is the pre-shared 
	    secret key, and IP address is the source address of the packet 
	  
</li>
<li>
	    Padding is zero fill up to the multiplicative of 32  <a class='info' href='#RFC0791'>RFC 0791<span> (</span><span class='info'>Postel, J., &ldquo;Internet Protocol,&rdquo; September&nbsp;1981.</span><span>)</span></a> [RFC0791]
	  
</li>
</ul><p>
      
</p>
<p>
	For IPv6 protocol the format of SAVAH option is as follows:
	<br /><hr class="insert" />
<a name="ipv6_pkt"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Next Header  |  Hdr Ext Len  |  Option type  |  Option Len   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                   Encrypted source IP address                 |
+                                                               +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Padding Type | Padding Len   |          Padding              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;4&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

	</p>
<ul class="text">
<li>
	    Next Header field is selected to be Destination Option
	    as described in <a class='info' href='#RFC2460'>RFC 2460<span> (</span><span class='info'>Deering, S. and R. Hinden, &ldquo;Internet Protocol, Version 6 (IPv6) Specification,&rdquo; December&nbsp;1998.</span><span>)</span></a> [RFC2460]
	  
</li>
<li>
	    Hdr Ext Len is the length of option 8-octet units, not
            including the first 8 octets. For SAVAH this is equal to
	    2
	  
</li>
<li>
	    Option Type is the field that describes the actual data
	    in the option, for Destination Option there can be multiple 
	    such TVL encoded fields. Here the Option type is encoded as 
	    follows: 
	    
<ul class="text">
<li>
		Highest 2 bits are 00 indicating to skip the option if
		it is not recognized by the router
	      
</li>
<li>
		Next bit is 0 meaning Option Data does not change en-route
	      
</li>
<li>
		The last 5 bits are 11110 as assigned in <a class='info' href='#RFC4727'>RFC 4727<span> (</span><span class='info'>Fenner, B., &ldquo;Experimental Values In IPv4, IPv6, ICMPv4, ICMPv6, UDP, and TCP Headers,&rdquo; November&nbsp;2006.</span><span>)</span></a> [RFC4727] for experiments
	      
</li>
</ul>
	  
</li>
<li>
	    Encrypted source IP address is the truncated 128 bit length result 
	    from operation HMAC(key|IP address), where key is the pre-shared 
	    secret key, and IP address is the source address of the packet 
	  
</li>
<li>
	    Padding is of type PadN as described in <a class='info' href='#RFC2460'>RFC 2460<span> (</span><span class='info'>Deering, S. and R. Hinden, &ldquo;Internet Protocol, Version 6 (IPv6) Specification,&rdquo; December&nbsp;1998.</span><span>)</span></a> [RFC2460]
	  
</li>
<li>
	    Padding Len is the length of actual padding excluding first 2 octets, 
	    and in SAVAH case equal to 2
	  
</li>
<li>
	    Padding is the 2 zero filled octets
	  
</li>
</ul><p>
      
</p>
<p>
	IPv4/IPv6 packet structure for SAVAH in tunnel mode:
	<br /><hr class="insert" />
<a name="befor_esp"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>

         BEFORE APPLYING ESP
-----------------------------
| Outer IP hdr |  Payload   |
|              |            |
-----------------------------
</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;5&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

	</p>
<ul class="text">
<li>
	    Outer IP hdr is the IPv4 or IPv6 header containing the source IP address 
            of the local host and the destination of the host in the Internet, or host 
            in the local sub-network. 
	  
</li>
<li>
	    Payload is the data containing the upper layer protocol PDU (such as TCP, UDP, 
	    SCTP, etc.) and the user payload.
	  
</li>
</ul><p>
	<br /><hr class="insert" />
<a name="after_esp"></a>
</p>
<div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
        AFTER APPLYING ESP
------------------------------------------------------------------
| SAVAH IP hdr    |     |              |         |  ESP    | ESP |
| (any options)   | ESP | Outer IP Hdr | Payload | Trailer | ICV |
------------------------------------------------------------------
                        |&lt;----- encryption -----&gt;|
                  |&lt;--------- integrity --------&gt;|

</pre></div><p>
<table border="0" cellpadding="0" cellspacing="2" align="center"><tr><td align="center"><font face="monaco, MS Sans Serif" size="1"><b>&nbsp;Figure&nbsp;6&nbsp;</b></font><br /></td></tr></table><hr class="insert" />

	</p>
<ul class="text">
<li>
	    Gateway IP hdr is the IPv4 or IPv6 header containing the source IP address of 
            the local host and the destination IP address of the SAVAH router in given local
            sub-network.
	  
</li>
<li>
	    ESP is the Encapsulated Security Payload in BEET mode.
	  
</li>
<li>
	    Outer IP header is the IPv4 or IPv6 header containing the source address of the 
            localhost and the destination address of the host in the Internet, or of the host 
            in the local sub-network. It is different from ESP BEET mode Outer address, and more 
	    reflects the meaning of the Outer IP address of the ESP tunnel mode.
	  
</li>
</ul><p>
      
</p>
<a name="Security"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Security Considerations</h3>

<p>
	Using opportunistic mode in HIP should be considered as a security risk
	in untrusted environment, due to the fact that the router's HIT is not 
	known before the registration.  This gives a possibility to an attacker 
	to hijack the HIP I1 packet and pretend to be a SAVAH router by sending
	the R1 packet to the client.
      
</p>
<p>
	Using tunneling approach a single SAVAH router may become a single 
	point of failure as well as a bottleneck in the network communication. 
	For that reason it is recommended to use load balancing between multiple 
	SAVAH router and forward the traffic from the client to the Internet through
	several (depending on the network size) SAVAH routers.
      
</p>
<a name="Credits"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
Credits</h3>

<p>
	The following people (in alphabetical order) have provided thoughtful
	and helpful discussions and/or suggestions that have helped to improve 
	this document:
	</p>
<ul class="text">
<li>Miika Komu
</li>
</ul><p>
      
</p>
<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>6.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="I-D.bi-savi-csa">[I-D.bi-savi-csa]</a></td>
<td class="author-text">Bi, J., Wu, J., and G. Yao, &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-bi-savi-csa-00.txt">A CGA based Source Address Authorization and Authentication (CSA) Mechanism  for First IPv6 Layer-3 Hop</a>,&rdquo; draft-bi-savi-csa-00 (work in progress), July&nbsp;2008 (<a href="http://www.ietf.org/internet-drafts/draft-bi-savi-csa-00.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="I-D.lindqvist-hip-opportunistic">[I-D.lindqvist-hip-opportunistic]</a></td>
<td class="author-text">Lindqvist, J., &ldquo;<a href="http://www.ietf.org/internet-drafts/draft-lindqvist-hip-opportunistic-01.txt">Establishing Host Identity Protocol Opportunistic Mode with TCP Option</a>,&rdquo; draft-lindqvist-hip-opportunistic-01 (work in progress), March&nbsp;2006 (<a href="http://www.ietf.org/internet-drafts/draft-lindqvist-hip-opportunistic-01.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC0791">[RFC0791]</a></td>
<td class="author-text">Postel, J., &ldquo;<a href="http://tools.ietf.org/html/rfc791">Internet Protocol</a>,&rdquo; STD&nbsp;5, RFC&nbsp;791, September&nbsp;1981 (<a href="http://www.rfc-editor.org/rfc/rfc791.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2460">[RFC2460]</a></td>
<td class="author-text"><a href="mailto:deering@cisco.com">Deering, S.</a> and <a href="mailto:hinden@iprg.nokia.com">R. Hinden</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2460">Internet Protocol, Version 6 (IPv6) Specification</a>,&rdquo; RFC&nbsp;2460, December&nbsp;1998 (<a href="http://www.rfc-editor.org/rfc/rfc2460.txt">TXT</a>, <a href="http://xml.resource.org/public/rfc/html/rfc2460.html">HTML</a>, <a href="http://xml.resource.org/public/rfc/xml/rfc2460.xml">XML</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4423">[RFC4423]</a></td>
<td class="author-text">Moskowitz, R. and P. Nikander, &ldquo;<a href="http://tools.ietf.org/html/rfc4423">Host Identity Protocol (HIP) Architecture</a>,&rdquo; RFC&nbsp;4423, May&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4423.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4727">[RFC4727]</a></td>
<td class="author-text">Fenner, B., &ldquo;<a href="http://tools.ietf.org/html/rfc4727">Experimental Values In IPv4, IPv6, ICMPv4, ICMPv6, UDP, and TCP Headers</a>,&rdquo; RFC&nbsp;4727, November&nbsp;2006 (<a href="http://www.rfc-editor.org/rfc/rfc4727.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5203">[RFC5203]</a></td>
<td class="author-text">Laganier, J., Koponen, T., and L. Eggert, &ldquo;<a href="http://tools.ietf.org/html/rfc5203">Host Identity Protocol (HIP) Registration Extension</a>,&rdquo; RFC&nbsp;5203, April&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5203.txt">TXT</a>).</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC5210">[RFC5210]</a></td>
<td class="author-text">Wu, J., Bi, J., Li, X., Ren, G., Xu, K., and M. Williams, &ldquo;<a href="http://tools.ietf.org/html/rfc5210">A Source Address Validation Architecture (SAVA) Testbed and Deployment Experience</a>,&rdquo; RFC&nbsp;5210, June&nbsp;2008 (<a href="http://www.rfc-editor.org/rfc/rfc5210.txt">TXT</a>).</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Authors' Addresses</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Dmitriy Kuptsov</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">HIIT</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Metsanneidonkuja 10</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Espoo,   02130</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FIN</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text">+358 50 301 2613</td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:dmitriy.kuptsov@hiit.fi">dmitriy.kuptsov@hiit.fi</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Andrei Gurtov</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">HIIT</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Metsanneidonkuja 10</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Espoo, Espoo  02130</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">FIN</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text"></td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:gurtov@hiit.fi">gurtov@hiit.fi</a></td></tr>
<tr cellpadding="3"><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Jun Bi</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Tsinghua Univeristy</td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Beijing,   </td></tr>
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">China</td></tr>
<tr><td class="author" align="right">Phone:&nbsp;</td>
<td class="author-text"></td></tr>
<tr><td class="author" align="right">Email:&nbsp;</td>
<td class="author-text"><a href="mailto:"></a></td></tr>
</table>
</body></html>
